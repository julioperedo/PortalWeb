import U from"../../Core/Utilities.js";import Globals from"../Globals.js";import EditGlobals from"../EditMode/EditGlobals.js";import GUIElement from"../Layout/GUIElement.js";import ContextDetection from"./ContextDetection.js";const{addEvent,merge,css,fireEvent,createElement}=U;class DragDrop{constructor(e,t){this.editMode=e,this.options=merge(DragDrop.defaultOptions,t),this.mockElement=createElement("div",{className:EditGlobals.classNames.dragMock},{},e.board.container),this.dropPointer={isVisible:!1,align:"",element:createElement("div",{className:EditGlobals.classNames.dropPointer},{},e.board.container)},this.isActive=!1,this.initEvents()}showDropPointer(e,t,o,i){this.dropPointer.isVisible=!0,css(this.dropPointer.element,{display:"block",left:e+"px",top:t+"px",height:i+"px",width:o+"px"})}hideDropPointer(){this.dropPointer.isVisible&&(this.dropPointer.isVisible=!1,this.dropPointer.align="",this.dropPointer.element.style.display="none")}setMockElementPosition(e){var t=this.editMode.board.container.getBoundingClientRect(),o=this.mockElement.clientWidth/2,i=e.clientX-t.left-o,e=e.clientY-t.top-o;css(this.mockElement,{left:i+"px",top:e+"px"})}initEvents(){var e=this;addEvent(document,"mousemove",e.onDrag.bind(e)),addEvent(document,"mouseup",e.onDragEnd.bind(e))}onDragStart(e,t,o){this.isActive=!0,this.editMode.hideToolbars(["cell","row"]),this.editMode.resizer&&this.editMode.resizer.disableResizer(),this.setMockElementPosition(e),t?((this.context=t).hide(),t.getType()===Globals.guiElementType.cell&&(e=t,fireEvent(this.editMode.board,"cellResize",{cell:t}),fireEvent(e.row,"cellChange",{cell:t,row:e.row}))):o&&(this.dragEndCallback=o),css(this.mockElement,{cursor:"grabbing",display:"block"})}onDrag(e){var t=this;t.isActive&&(e.preventDefault(),t.setMockElementPosition(e),t.context?t.context.getType()===Globals.guiElementType.cell?t.onCellDrag(e):t.context.getType()===Globals.guiElementType.row&&t.onRowDrag(e):t.dragEndCallback&&t.onCellDrag(e))}onDragEnd(){var e=this;e.isActive&&(e.isActive=!1,css(e.mockElement,{cursor:"grab",display:"none"}),e.context?(e.context.getType()===Globals.guiElementType.cell?e.onCellDragEnd():e.context.getType()===Globals.guiElementType.row&&e.onRowDragEnd(),e.context=void 0,e.editMode.editCellContext&&(e.editMode.showToolbars(["row","cell"],e.editMode.editCellContext),e.editMode.resizer&&e.editMode.resizer.setSnapPositions(e.editMode.editCellContext))):e.dragEndCallback&&(e.dragEndCallback(e.dropContext),e.dragEndCallback=void 0,e.hideDropPointer()))}onRowDrag(e,t){var o=this,i=o.mouseCellContext,l=o.options.dropPointerSize,n=o.options.rowDropOffset;let r=!1;i&&(i=(t=t||ContextDetection.getContext(i,e,n)).side,o.dropPointer.align===i&&o.dropContext===t.cell.row||(r=!0,o.dropPointer.align=i,o.dropContext=t.cell.row),i?(e=GUIElement.getOffsets(o.dropContext,o.editMode.board.container),{width:n,height:t}=GUIElement.getDimFromOffsets(e),o.dropPointer.isVisible&&!r||o.showDropPointer(e.left,e.top+("bottom"===o.dropPointer.align?t:0)-l/2,n,l)):(o.dropContext=void 0,o.hideDropPointer()))}onRowDragEnd(){const e=this,t=e.context,o=e.dropContext;e.dropPointer.align&&(t.layout.unmountRow(t),0===t.layout.rows.length&&t.layout.destroy(),o.layout.mountRow(t,(o.layout.getRowIndex(o)||0)+("bottom"===e.dropPointer.align?1:0)),t.cells[0]&&(fireEvent(e.editMode.board,"cellResize",{cell:t.cells[0]}),fireEvent(t,"cellChange",{cell:t.cells[0],row:t}))),e.hideDropPointer(),t.show()}onCellDrag(e,t){var o=this,i=o.mouseCellContext,l=o.options.cellDropOffset;i||t?o.onCellDragCellCtx(e,t||ContextDetection.getContext(i,e,l)):o.mouseRowContext&&o.onCellDragRowCtx(e,o.mouseRowContext)}onCellDragCellCtx(e,t){var o,i,l,n,r=this,s=r.options.dropPointerSize,d=t.side;let a=!1;r.dropPointer.align===d&&r.dropContext===t.cell||(a=!0,r.dropPointer.align=d,r.dropContext=t.cell),"right"===d||"left"===d?(o=GUIElement.getOffsets(r.dropContext,r.editMode.board.container),{width:n,height:l}=GUIElement.getDimFromOffsets(o),r.dropPointer.isVisible&&!a||(i=(i=r.dropContext.row.getRowLevelInfo(e.clientY))?i.rowLevel.bottom-i.rowLevel.top:l,r.showDropPointer(o.left+("right"===d?n:0)-s/2,o.top,s,i))):"top"===d||"bottom"===d?(l=GUIElement.getOffsets(r.dropContext),(n=r.dropContext.row.getRowLevelInfo(l.top))&&(0===n.index&&"top"===d||n.index===n.rowLevels.length-1&&"bottom"===d)&&r.onRowDrag(e,t)):(r.dropContext=void 0,r.hideDropPointer())}onCellDragRowCtx(o,e){var i=this,l=i.options.dropPointerSize,n=GUIElement.getOffsets(e),r=e.getRowLevelInfo(o.clientY);if(r)for(let e=0,t=r.rowLevel.cells.length;e<t;++e){var s,d=r.rowLevel.cells[e],a=GUIElement.getOffsets(d),{width:p,height:c}=GUIElement.getDimFromOffsets(a),g=i.editMode.board.container.getBoundingClientRect(),m=r.rowLevel.bottom-r.rowLevel.top;d.isVisible?c<.8*m&&a.left<=o.clientX&&a.right>=o.clientX?(a.top>o.clientY||a.bottom<o.clientY&&(i.showDropPointer(a.left-g.left,a.top-g.top+c,p,m-c),i.dropPointer.align="nestedBottom",i.dropContext=d),e=t):(0===e&&a.left>o.clientX||e===t-1&&a.right<o.clientX)&&(a.left>o.clientX||a.right<o.clientX&&(s=n.right-a.right,i.showDropPointer(a.left+(0===e&&a.left>o.clientX?0:p)-l/2-g.left,a.top-g.top,l<s?s:l,m||c),i.dropPointer.align="right",i.dropContext=d),e=t):d.isVisible||d!==i.context||(i.dropContext=void 0,i.hideDropPointer())}}onCellDragEnd(e){const t=this,o=e||t.context;let i=t.dropContext;if(t.dropPointer.align&&i&&o)if(o.row.unmountCell(o),0===o.row.cells.length&&o.row.destroy(),"top"!==t.dropPointer.align&&"bottom"!==t.dropPointer.align||i.getType()!==Globals.guiElementType.row)if("nestedBottom"===t.dropPointer.align&&i.getType()===Globals.guiElementType.cell){e=i;const n=e.row;var l=n.getCellIndex(e);n.unmountCell(e);const r=n.addCell({id:GUIElement.createElementId("col-nested-"),layout:{rows:[{},{}]}},void 0,l);r.nestedLayout&&(r.nestedLayout.rows[0].mountCell(e),r.nestedLayout.rows[1].mountCell(o))}else i.getType()===Globals.guiElementType.cell&&(i=i).row.mountCell(o,(i.row.getCellIndex(i)||0)+("right"===t.dropPointer.align?1:0));else{const s=(i=i).layout.addRow({},void 0,(i.layout.getRowIndex(i)||0)+("bottom"===t.dropPointer.align?1:0));s.mountCell(o,0)}fireEvent(t.editMode.board,"cellResize",{cell:o}),fireEvent(o.row,"cellChange",{cell:o,row:o.row}),t.hideDropPointer(),o.show()}}DragDrop.defaultOptions={enabled:!0,rowDropOffset:30,cellDropOffset:30,dropPointerSize:16};export default DragDrop;