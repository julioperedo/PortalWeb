"use strict";import CallbackRegistry from"../CallbackRegistry.js";import EditableOptions from"./EditableOptions.js";import Globals from"../Globals.js";const classNamePrefix=Globals["classNamePrefix"];import U from"../../Core/Utilities.js";const{createElement,isArray,merge,fireEvent,addEvent,objectEach,isFunction,getStyle,relativeLength,diffObjects}=U;import CU from"./ComponentUtilities.js";const{getMargins,getPaddings}=CU;import ComponentGroup from"./ComponentGroup.js";import DU from"../Utilities.js";const uniqueKey=DU["uniqueKey"];import Sync from"./Sync/Sync.js";class Component{static createTextElement(t,e,i){var n,s,o;return"object"==typeof i?({className:n,text:s,style:o}=i,createElement(t,{className:n||classNamePrefix+"component-"+e,textContent:s},o)):"string"==typeof i?createElement(t,{className:classNamePrefix+"component-"+e,textContent:i},{}):void 0}constructor(t,e){this.callbackRegistry=new CallbackRegistry,this.tableEvents=[],this.cellListeners=[],this.activeGroup=void 0,this.resizeTimeouts=[],this.innerResizeTimeouts=[],this.board=t.row.layout.board,this.parentElement=t.container,this.cell=t,this.options=merge(Component.defaultOptions,e),this.id=this.options.id&&this.options.id.length?this.options.id:uniqueKey(),this.editableOptions=new EditableOptions(this,e.editableOptionsBindings),this.presentationModifier=this.options.presentationModifier,this.dimensions={width:null,height:null},this.element=createElement("div",{className:this.options.className},{},this.parentElement),this.contentElement=createElement("div",{className:this.options.className+"-content"},{height:"100%"},this.element,!0),this.filterAndAssignSyncOptions(),this.setupEventListeners(),this.attachCellListeneres(),this.on("tableChanged",()=>{this.onTableChanged()}),this.on("update",()=>{this.cell.setLoadingState()}),this.on("afterRender",()=>{this.cell.setLoadingState(!1)})}async initConnector(){var t;return this.options.connector?.id&&this.connectorId!==this.options.connector.id&&(this.cell.setLoadingState(),t=await this.board.dataPool.getConnector(this.options.connector.id),this.setConnector(t)),this}filterAndAssignSyncOptions(n=this.constructor.syncHandlers){const s=this.options.sync||{};var t=Object.keys(s).reduce((t,e)=>{var i;return e&&((i=s[e])&&"object"==typeof i&&(t[e]=i),i&&"boolean"==typeof i&&(t[e]=n[e])),t},{});this.sync&&(this.sync.syncConfig=t),this.syncHandlers=t}attachCellListeneres(){for(;this.cellListeners.length;){const e=this.cellListeners.pop();e&&e()}var t;this.cell&&Object.keys(this.cell).length&&(t=this.cell.row.layout.board,this.cellListeners.push(addEvent(t,"cellResize",()=>{this.resizeTo(this.parentElement)}),addEvent(this.cell.row,"cellChange",t=>{const e=t["row"];e&&this.cell&&void 0===e.getCellIndex(this.cell)&&this.cell&&this.setCell(this.cell)})))}setCell(t,e=!1){(this.cell=t).container&&(this.parentElement=t.container),this.attachCellListeneres(),e&&this.resizeTo(this.parentElement)}setupTableListeners(e){const t=this.connector;t&&(e&&["afterDeleteColumns","afterDeleteRows","afterSetCell","afterSetConnector","afterSetColumns","afterSetRows"].forEach(t=>{this.tableEvents.push(e.on(t,t=>{clearInterval(this.tableEventTimeout),this.tableEventTimeout=Globals.win.setTimeout(()=>{this.emit({...t,type:"tableChanged"}),this.tableEventTimeout=void 0},0)}))}),this.tableEvents.push(t.on("afterLoad",()=>{this.emit({target:this,type:"tableChanged"})})))}clearTableListeners(){const t=this.connector,e=this.tableEvents;e.length&&e.forEach(t=>t()),t&&e.push(t.table.on("afterSetModifier",t=>{"afterSetModifier"===t.type&&this.emit({...t,type:"tableChanged"})}))}setConnector(t){for(fireEvent(this,"setConnector",{connector:t});this.tableEvents.length;){const i=this.tableEvents.pop();"function"==typeof i&&i()}if(this.connector=t){this.clearTableListeners(),this.setupTableListeners(t.table),t.table.on("setModifier",()=>this.clearTableListeners()),t.table.on("afterSetModifier",t=>{"afterSetModifier"===t.type&&t.modified&&this.setupTableListeners(t.modified)});var e=t.table.id;ComponentGroup.getComponentGroup(e)||ComponentGroup.addComponentGroup(new ComponentGroup(e));const n=ComponentGroup.getComponentGroup(e);n&&(n.addComponents([this.id]),this.activeGroup=n)}return fireEvent(this,"afterSetConnector",{connector:t}),this}setActiveGroup(t){(t="string"==typeof t?ComponentGroup.getComponentGroup(t)||null:t)instanceof ComponentGroup&&(this.activeGroup=t),null===t&&(this.activeGroup=void 0),this.activeGroup&&this.activeGroup.addComponents([this.id])}getContentHeight(){return(this.dimensions.height||Number(getStyle(this.element,"height")))-(this.titleElement?this.titleElement.clientHeight+getMargins(this.titleElement).y:0)-(this.captionElement?this.captionElement.clientHeight+getMargins(this.captionElement).y:0)}resize(t,e){var i;e&&(i=getPaddings(this.element).y+getMargins(this.element).y,this.dimensions.height=relativeLength(e,Number(getStyle(this.parentElement,"height")))-i,this.element.style.height=this.dimensions.height+"px",this.contentElement.style.height=this.getContentHeight()+"px"),t&&(i=getPaddings(this.element).x+getMargins(this.element).x,this.dimensions.width=relativeLength(t,Number(getStyle(this.parentElement,"width")))-i,this.element.style.width=this.dimensions.width+"px"),null===e&&(this.dimensions.height=null,this.element.style.removeProperty("height")),null===t&&(this.dimensions.width=null,this.element.style.removeProperty("width")),fireEvent(this,"resize",{width:t,height:e})}resizeTo(s){for(;this.resizeTimeouts.length;){var t=this.resizeTimeouts.pop();t&&cancelAnimationFrame(t)}var e=requestAnimationFrame(()=>{var{width:t,height:e}=s.getBoundingClientRect(),i=getPaddings(s),n=getMargins(s);this.resize(t-i.x-n.x,e-i.y-n.y)});this.resizeTimeouts.push(e)}async update(t,e=!0){var i,n={options:t,shouldForceRerender:!1};fireEvent(this,"update",n),this.options=merge(this.options,t),this.options.connector?.id&&this.connectorId!==this.options.connector.id&&(i=await this.board.dataPool.getConnector(this.options.connector.id),this.setConnector(i)),this.options=merge(this.options,t),(e||n.shouldForceRerender)&&this.render()}setupEventListeners(){const i=this.options.events;i&&(Object.keys(i).forEach(t=>{var e=i[t];e&&this.callbackRegistry.addCallback(t,{type:"component",func:e})}),objectEach(i,(t,e)=>{isFunction(t)&&this.on(e,t)})),window.addEventListener("resize",()=>this.resizeTo(this.parentElement))}setTitle(t){const e=this.titleElement,i=t&&("string"==typeof t||t.text);i?(t=Component.createTextElement("h2","title",t))&&(e?e.replaceWith(t):this.element.insertBefore(t,this.element.firstChild),this.titleElement=t):e&&(e.remove(),delete this.titleElement)}setCaption(t){const e=this.captionElement,i=t&&("string"==typeof t||t.text);i?(t=Component.createTextElement("div","caption",t))&&(e?e.replaceWith(t):this.element.appendChild(t),this.titleElement=t):e&&(e.remove(),delete this.captionElement)}async load(){return await this.initConnector(),this.render(),this}render(){return this.emit({type:"render"}),this.resizeTo(this.parentElement),this.setTitle(this.options.title),this.setCaption(this.options.caption),this}destroy(){for(;this.element.firstChild;)this.element.firstChild.remove();this.tableEvents.forEach(t=>t()),this.element.remove()}on(t,e){return addEvent(this,t,e)}emit(t){t.target||(t.target=this),fireEvent(this,t.type,t)}toJSON(){const i={width:0,height:0};return objectEach(this.dimensions,function(t,e){null!==t&&(i[e]=t)}),{$class:this.options.type,options:{cell:this.options.cell,parentElement:this.parentElement.id,dimensions:i,id:this.id,type:this.type}}}getOptions(){return diffObjects(this.options,Component.defaultOptions)}getEditableOptions(){return merge(this.options)}getEditableOptionValue(n){if(n){let i=this.getEditableOptions();for(let t=0,e=n.length;t<e;t++){if(!i)return;i=(i=isArray(i)?i[0]:i)[n[t]]}return i}}}Component.Sync=Sync,Component.defaultOptions={className:classNamePrefix+"component",id:"",title:!1,caption:!1,sync:Sync.defaultHandlers,editableOptions:[{name:"connectorName",propertyPath:["connector","id"],type:"select"},{name:"title",propertyPath:["title"],type:"input"},{name:"caption",propertyPath:["caption"],type:"input"}]},Component.syncHandlers={};export default Component;