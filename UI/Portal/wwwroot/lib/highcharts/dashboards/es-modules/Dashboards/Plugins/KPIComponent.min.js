"use strict";import AST from"../../Core/Renderer/HTML/AST.js";import Component from"../Components/Component.js";import Templating from"../../Core/Templating.js";import KPISyncHandlers from"./KPISyncHandlers.js";const format=Templating["format"];import U from"../../Core/Utilities.js";const{createElement,css,defined,getStyle,isArray,isNumber,merge,diffObjects}=U;class KPIComponent extends Component{static fromJSON(t,e){var t=t.options,s=t.chartOptions&&JSON.parse(t.chartOptions),i=JSON.parse(t.subtitle||"{}"),n=t.title&&JSON.parse(t.title);return new KPIComponent(e,merge(t,{chartOptions:s,title:n,subtitle:i}))}constructor(t,e){super(t,e=merge(KPIComponent.defaultOptions,e)),this.options=e,this.type="KPI",this.sync=new KPIComponent.Sync(this,this.syncHandlers),this.value=createElement("span",{className:e.className+"-value"},{},this.contentElement),this.subtitle=createElement("span",{className:this.getSubtitleClassName()},{},this.contentElement),this.options.chartOptions&&(this.chartContainer=createElement("div",{className:e.className+"-chart-container"},{},this.contentElement))}async load(){return await super.load(),this.contentElement.style.display="flex",this.contentElement.style.flexDirection="column",this}resize(t,e){return super.resize(t,e),this.chart&&this.chart.reflow(),this}render(){super.render(),this.updateElements();const t=KPIComponent.charter;return t&&this.options.chartOptions&&!this.chart&&this.chartContainer?this.chart=t.chart(this.chartContainer,merge(KPIComponent.defaultChartOptions,this.options.chartOptions)):this.chart&&!this.options.chartOptions&&"chartOptions"in this.options&&(this.chart.destroy(),this.chart=void 0),this.sync.start(),this.emit({type:"afterRender"}),this}setOptions(){this.filterAndAssignSyncOptions(KPISyncHandlers)}async update(t,e=!0){await super.update(t),this.setOptions(),t.chartOptions&&this.chart&&this.chart.update(t.chartOptions),e&&this.render()}onTableChanged(){this.setValue()}getValue(){if(this.options.value)return this.options.value;if(this.connector&&this.options.columnName){const t=this.connector?.table.modified,e=t.getColumn(this.options.columnName),s=e?.length||0;return t.getCellAsString(this.options.columnName,s-1)}}setValue(e=this.getValue()){const{valueFormat:s,valueFormatter:i}=this.options;if(defined(e)){let t;isNumber(e)&&(t=e),i?e=i.call(this,e):s?e=format(s,{value:e}):isNumber(e)&&(e=e.toLocaleString()),AST.setElementHTML(this.value,""+e),this.prevValue=t}}updateElements(){var{style:t,subtitle:e}=this.options;this.setValue(),AST.setElementHTML(this.subtitle,this.getSubtitle()),t&&css(this.element,t),"object"==typeof e&&(e.style&&css(this.subtitle,e.style),this.subtitle.className=this.getSubtitleClassName()),this.chartContainer&&(this.chartContainer.style.flex=this.options.chartOptions?"1":"0"),this.chart&&this.chart.reflow(),this.value.style.color=this.getValueColor()}getSubtitle(){var{subtitle:e,value:s}=this.options;if("string"==typeof e)return e;if(e){if(isNumber(this.prevValue)&&isNumber(s)){const i=s-this.prevValue;let t="";if(0<i)t='<span style="color:green">&#9650;</span> +';else{if(!(i<0))return this.subtitle.innerHTML;t='<span style="color:red">&#9660;</span> '}if("diff"===e.type)return t+i.toLocaleString();if("diffpercent"===e.type)return t+format("{v:,.2f}%",{v:i/this.prevValue*100})}return e.text||""}return""}getSubtitleClassName(){var t=this.options["subtitle"];return Component.defaultOptions.className+"-subtitle"+("object"==typeof t&&t.className||"")}getValueColor(){var{threshold:e,thresholdColors:s,value:i}=this.options;if(s&&e&&isNumber(i)){if(isArray(e)){for(let t=e.length-1;0<=t;t--)if(i>=e[t])return t+1<s.length?s[t+1]:s[s.length-1]}else if(e<=i)return s[1];return s[0]}return""}toJSON(){var t=super.toJSON(),e={...t,type:"KPI",options:{...t.options,type:"KPI",value:this.options.value,subtitle:JSON.stringify(this.options.subtitle),title:JSON.stringify(this.options.title),threshold:this.options.threshold,thresholdColors:this.options.thresholdColors,chartOptions:JSON.stringify(this.options.chartOptions),valueFormat:this.options.valueFormat}};return this.emit({type:"toJSON",json:t}),e}getOptions(){return{...diffObjects(this.options,KPIComponent.defaultOptions),type:"KPI"}}}KPIComponent.syncHandlers=KPISyncHandlers,KPIComponent.defaultOptions=merge(Component.defaultOptions,{type:"KPI",className:[Component.defaultOptions.className,Component.defaultOptions.className+"-kpi"].join(" "),minFontSize:20,syncHandlers:KPISyncHandlers,thresholdColors:["#f45b5b","#90ed7d"],editableOptions:(Component.defaultOptions.editableOptions||[]).concat([{name:"Value",type:"input",propertyPath:["value"]},{name:"Column name",type:"input",propertyPath:["columnName"]},{name:"Value format",type:"input",propertyPath:["valueFormat"]}])}),KPIComponent.defaultChartOptions={chart:{type:"spline",styledMode:!0,zooming:{mouseWheel:{enabled:!1}}},title:{text:void 0},xAxis:{visible:!1},yAxis:{visible:!1,title:{text:null}},legend:{enabled:!1},credits:{enabled:!1},tooltip:{outside:!0},plotOptions:{series:{marker:{enabled:!1}}}};export default KPIComponent;