import U from"../../Core/Utilities.js";import EditGlobals from"./EditGlobals.js";import EditRenderer from"./EditRenderer.js";import CellEditToolbar from"./Toolbar/CellEditToolbar.js";import RowEditToolbar from"./Toolbar/RowEditToolbar.js";import SidebarPopup from"./SidebarPopup.js";import EditContextMenu from"./EditContextMenu.js";import DragDrop from"../Actions/DragDrop.js";import Resizer from"../Actions/Resizer.js";import ConfirmationPopup from"./ConfirmationPopup.js";import ContextDetection from"../Actions/ContextDetection.js";import GUIElement from"../Layout/GUIElement.js";const{addEvent,createElement,css,merge}=U;class EditMode{constructor(t,e){this.active=!1,this.iconsURLPrefix="/code/dashboards/gfx/dashboards-icons/",this.iconsURLPrefix=e&&e.iconsURLPrefix||this.iconsURLPrefix,this.options=merge({dragDrop:{enabled:!0},resize:{enabled:!0},settings:{enabled:!0},enabled:!0,contextMenu:{icon:this.iconsURLPrefix+"menu.svg"},tools:{addComponentBtn:{enabled:!0,icon:this.iconsURLPrefix+"add.svg"},rwdButtons:{enabled:!0,icons:{small:this.iconsURLPrefix+"smartphone.svg",medium:this.iconsURLPrefix+"tablet.svg",large:this.iconsURLPrefix+"computer.svg"}}},confirmationPopup:{close:{icon:this.iconsURLPrefix+"close.svg"}},toolbars:{cell:{enabled:!0},row:{enabled:!0}}},e||{}),this.board=t,this.lang=merge({},EditGlobals.lang,this.options.lang),this.contextPointer={isVisible:!1,element:createElement("div",{className:EditGlobals.classNames.contextDetectionPointer},{},this.board.container)},this.isInitialized=!1,this.isContextDetectionActive=!1,this.tools={},this.rwdMenu=[],this.rwdMode=this.board.getLayoutContainerSize(),this.createTools(),this.confirmationPopup=new ConfirmationPopup(t.container,this.iconsURLPrefix,this,this.options.confirmationPopup),this.editOverlay=createElement("div",{className:EditGlobals.classNames.editOverlay},{},t.container),this.isEditOverlayActive=!1}onContextBtnClick(){var t=this;t.tools.contextMenu||(t.tools.contextMenu=new EditContextMenu(t.board.container,t.options.contextMenu||{},t)),t.tools.contextMenu&&(t.tools.contextMenu.isVisible||t.tools.contextMenu.updatePosition(t.tools.contextButtonElement),t.tools.contextMenu.setVisible(!t.tools.contextMenu.isVisible))}onEditModeToggle(){var t=this;t.active?t.deactivate():t.activate()}init(){var t=this;this.options.resize?.enabled&&(t.resizer=new Resizer(t,t.options.resize)),t.dragDrop=new DragDrop(t,t.options.dragDrop),t.options.toolbars?.row?.enabled&&!t.rowToolbar&&(t.rowToolbar=new RowEditToolbar(t)),t.options.toolbars?.cell?.enabled&&!t.cellToolbar&&(t.cellToolbar=new CellEditToolbar(t)),t.sidebar||(t.sidebar=new SidebarPopup(this.board.container,this.iconsURLPrefix,t)),t.isInitialized=!0}initEvents(){const o=this,i=o.board;for(let t=0,e=i.layouts.length;t<e;++t)o.setLayoutEvents(i.layouts[t]);o.cellToolbar&&(addEvent(o.cellToolbar.container,"mouseenter",function(){o.stopContextDetection()}),addEvent(o.cellToolbar.container,"mouseleave",function(){o.isContextDetectionActive=!0})),o.rowToolbar&&(addEvent(o.rowToolbar.container,"mouseenter",function(){o.stopContextDetection()}),addEvent(o.rowToolbar.container,"mouseleave",function(){o.isContextDetectionActive=!0})),addEvent(i.layoutsWrapper,"mousemove",o.onDetectContext.bind(o)),addEvent(i.layoutsWrapper,"click",o.onContextConfirm.bind(o)),addEvent(i.layoutsWrapper,"mouseleave",()=>{o.hideContextPointer()})}setLayoutEvents(o){for(let t=0,e=o.rows.length;t<e;++t){var i=o.rows[t];this.setRowEvents(i);for(let t=0,e=i.cells.length;t<e;++t)this.setCellEvents(i.cells[t])}}setRowEvents(e){const o=this;if(o.dragDrop){const i=o.dragDrop;addEvent(e.container,"mouseenter",function(){o.isContextDetectionActive&&(o.mouseRowContext=e)}),addEvent(e.container,"mousemove",function(t){i.isActive&&t.target===e.container&&(i.mouseRowContext=e)}),addEvent(e.container,"mouseleave",function(t){i.isActive&&i.mouseRowContext===e&&(i.mouseRowContext=void 0),o.isContextDetectionActive&&(o.mouseRowContext=void 0)})}}setCellEvents(e){const o=this;if(e.nestedLayout)o.setLayoutEvents(e.nestedLayout);else if(o.cellToolbar&&e.container&&(o.dragDrop||o.resizer)){const i=o.dragDrop;addEvent(e.container,"mouseenter",function(t){o.isContextDetectionActive&&(o.mouseCellContext=e)}),addEvent(e.container,"mousemove",function(t){i&&i.isActive&&t.target===e.container&&(i.mouseCellContext=e,i.mouseRowContext=void 0)}),addEvent(e.container,"mouseleave",function(){i&&i.isActive&&i.mouseCellContext===e&&(i.mouseCellContext=void 0),o.isContextDetectionActive&&(o.mouseCellContext=void 0)})}}activate(){var t=this;t.isInitialized||(t.init(),t.initEvents()),t.board.container.classList.add(EditGlobals.classNames.editModeEnabled),this.addComponentBtn&&(this.addComponentBtn.style.display="block"),t.rwdMode=t.board.getLayoutContainerSize(),this.showRwdButtons(),t.active=!0,t.isContextDetectionActive=!0}deactivate(){const t=this,e=t.board.container;e.classList.remove(EditGlobals.classNames.editModeEnabled),t.hideToolbars(),this.editCellContext&&this.editCellContext.row.setHighlight(!0),this.addComponentBtn&&(this.addComponentBtn.style.display="none"),t.resizer&&t.resizer.disableResizer(),this.hideRwdButtons(),this.board.layoutsWrapper.style.width="100%",this.board.reflow(),t.active=!1,t.stopContextDetection(),this.editCellContext=void 0,this.potentialCellContext=void 0}isActive(){return this.active}hideToolbars(t){var o=this,i=t||["cell","row","sidebar"];for(let t=0,e=i.length;t<e;++t)switch(i[t]){case"cell":o.cellToolbar&&o.cellToolbar.isVisible&&o.cellToolbar.hide();break;case"row":o.rowToolbar&&o.rowToolbar.isVisible&&o.rowToolbar.hide();break;case"sidebar":o.sidebar&&o.sidebar.isVisible&&o.sidebar.hide()}}showToolbars(t,o){var i=this,s=t||["cell","row","sidebar"];for(let t=0,e=s.length;t<e;++t)switch(s[t]){case"cell":o&&i.cellToolbar&&(i.cellToolbar.isVisible=!0,i.cellToolbar.showToolbar(o));break;case"row":o&&o.row&&i.rowToolbar&&(i.rowToolbar.isVisible=!0,i.rowToolbar.showToolbar(o.row));break;case"sidebar":i.sidebar&&!i.sidebar.isVisible&&i.sidebar.show()}}createTools(){const t=this;var e=this.options;this.tools.container=document.createElement("div"),this.tools.container.classList.add(EditGlobals.classNames.editTools),this.board.layoutsWrapper.parentNode.insertBefore(this.tools.container,this.board.layoutsWrapper),e.contextMenu?.enabled&&(this.tools.contextButtonElement=EditRenderer.renderContextButton(this.tools.container,t)),e.tools?.rwdButtons?.enabled&&this.createRwdMenu(),e.tools?.addComponentBtn?.enabled&&e.toolbars?.cell?.enabled&&(e=e.tools.addComponentBtn.icon,this.addComponentBtn=EditRenderer.renderButton(this.tools.container,{className:EditGlobals.classNames.editToolsBtn,icon:e,text:this.lang.addComponent,callback:()=>{t.sidebar&&(t.sidebar.show(),t.setEditOverlay())},style:{display:"none"}}))}createRwdMenu(){const i=this.board.options.responsiveBreakpoints;var t,e=this.tools.container,o=this.options?.tools?.rwdButtons?.icons||{};for(const s in i)!e||(t=EditRenderer.renderButton(e,{className:EditGlobals.classNames.editToolsBtn,icon:o[s]||"",text:this.lang[s],callback:t=>{const e=t.target,o=e.classList.contains("selected");o?(e.classList.remove("selected"),this.board.layoutsWrapper.style.width="",this.rwdMode=""):(this.rwdMenu.forEach(t=>{t.classList.remove("selected")}),e.classList.add("selected"),this.board.layoutsWrapper.style.width=i[s]+"px",this.rwdMode=s),this.board.reflow()},style:{display:"none"}}))&&this.rwdMenu.push(t)}showRwdButtons(){for(let t=0,e=this.rwdMenu.length;t<e;++t)this.rwdMenu[t].style.display="block"}hideRwdButtons(){for(let t=0,e=this.rwdMenu.length;t<e;++t)this.rwdMenu[t].style.display="none"}onDetectContext(o){var i,s,n=this;if(n.isActive()&&n.isContextDetectionActive&&(n.mouseCellContext||n.mouseRowContext)&&!(n.dragDrop||{}).isActive){let t,e;n.mouseCellContext?t=ContextDetection.getContext(n.mouseCellContext,o,50).cell:n.mouseRowContext&&(e=n.mouseRowContext,t=e.layout.parentCell),(this.potentialCellContext=t)&&(o=GUIElement.getOffsets(t,n.board.container),{width:i,height:s}=GUIElement.getDimFromOffsets(o),n.showContextPointer(o.left,o.top,i,s))}}stopContextDetection(){this.isContextDetectionActive=!1,this.dragDrop&&(this.dragDrop.mouseCellContext=void 0),this.mouseCellContext=void 0,this.hideContextPointer()}onContextConfirm(){this.isContextDetectionActive&&this.potentialCellContext&&this.editCellContext!==this.potentialCellContext&&this.setEditCellContext(this.potentialCellContext,this.editCellContext)}setEditCellContext(t,e){const o=e&&e.row;this.editCellContext=t,this.showToolbars(["row","cell"],t),o&&o===t.row||(o&&o.setHighlight(!0),t.row.setHighlight()),this.resizer&&this.resizer.setSnapPositions(t)}showContextPointer(t,e,o,i){this.contextPointer.isVisible=!0,css(this.contextPointer.element,{display:"block",left:t+"px",top:e+"px",height:i+"px",width:o+"px"})}hideContextPointer(){this.contextPointer.isVisible&&(this.contextPointer.isVisible=!1,this.contextPointer.element.style.display="none")}setEditOverlay(t){const e=this.editOverlay,o=e.classList.contains(EditGlobals.classNames.editOverlayActive);t||o?t&&o&&(e.classList.remove(EditGlobals.classNames.editOverlayActive),this.isEditOverlayActive=!1):(e.classList.add(EditGlobals.classNames.editOverlayActive),this.isEditOverlayActive=!0)}}export default EditMode;