import EditGlobals from"../EditMode/EditGlobals.js";import GUIElement from"../Layout/GUIElement.js";import U from"../../Core/Utilities.js";const{merge,addEvent,createElement,fireEvent,removeEvent,pick}=U;class Resizer{static fromJSON(e,t){return new Resizer(e,t.options)}constructor(e,t){this.editMode=e,this.options=merge({},Resizer.defaultOptions,e.options.resize,t),this.currentCell=void 0,this.isX=-1<this.options.type.indexOf("x"),this.isY=-1<this.options.type.indexOf("y"),this.isActive=!1,this.startX=0,this.tempSiblingsWidth=[],this.addSnaps()}addSnaps(){var e=this.editMode.iconsURLPrefix,t=this.options.snap.width||0,i=this.options.snap.height||0,s=this.editMode.board.container;this.snapRight=createElement("img",{className:EditGlobals.classNames.resizeSnap+" "+EditGlobals.classNames.resizeSnapX,src:e+"resize-handle.svg"},{width:t+"px",height:i+"px",left:"-9999px"},s),this.snapBottom=createElement("img",{className:EditGlobals.classNames.resizeSnap+" "+EditGlobals.classNames.resizeSnapY,src:e+"resize-handle.svg"},{width:t+"px",height:i+"px",top:"-9999px",left:"0px"},s),this.addResizeEvents()}disableResizer(){this.isActive=!1,this.currentDimension=void 0,this.currentCell=void 0,this.snapRight&&(this.snapRight.style.left="-9999px"),this.snapBottom&&(this.snapBottom.style.left="-9999px")}setSnapPositions(e){this.currentCell=e;var e=GUIElement.getOffsets(e,this.editMode.board.container),t=e.left||0,i=e.top||0,{width:e,height:s}=GUIElement.getDimFromOffsets(e),o=this.options.snap.width||0,n=this.options.snap.height||0;this.snapRight&&(this.snapRight.style.left=t+e-o+"px",this.snapRight.style.top=i+s/2-n/2+"px"),this.snapBottom&&(this.snapBottom.style.top=i+s-n+"px",this.snapBottom.style.left=t+e/2-o/2+"px")}setTempWidthSiblings(){const n=this.currentCell;if(n){var r=this.editMode.rwdMode,e=GUIElement.getOffsets(n),e=n.row.getRowLevelInfo(e.top),l=e&&e.rowLevel.cells||[];let i,s,o;for(let e=0,t=l.length;e<t&&(s=l[e],i=s.container,o=pick(((s.options.responsive||{})[r]||{}).width,s.options.width),s!==n);++e)!i||o&&"auto"!==o||(i.style.flex="0 0 "+i.offsetWidth+"px",this.tempSiblingsWidth.push(s))}}revertSiblingsAutoWidth(){var i=this.tempSiblingsWidth;let s,o;for(let e=0,t=i.length;e<t;++e)(s=i[e].container)&&(s.style.flex="1 1 0%",o=i[e]);this.tempSiblingsWidth=[],o&&(fireEvent(this.editMode.board,"cellResize",{cell:o}),fireEvent(o.row,"cellChange",{cell:o,row:o.row}))}addResizeEvents(){const t=this;t.mouseDownSnapX=o=function(e){t.isActive=!0,t.currentDimension="x",t.editMode.hideToolbars(["row","cell"]),t.setTempWidthSiblings(),t.startX=e.clientX},t.mouseDownSnapY=s=function(e){t.isActive=!0,t.currentDimension="y",t.editMode.hideToolbars(["row","cell"])},t.mouseMoveSnap=e=function(e){t.isActive&&t.onMouseMove(e)},t.mouseUpSnap=i=function(e){t.isActive&&(t.isActive=!1,t.currentDimension=void 0,t.revertSiblingsAutoWidth(),t.editMode.showToolbars(["row","cell"],t.currentCell),t.currentCell&&t.setSnapPositions(t.currentCell))},addEvent(this.snapRight,"mousedown",o),addEvent(this.snapBottom,"mousedown",s),addEvent(document,"mousemove",e),addEvent(document,"mouseup",i);var e,i,s,o=()=>{t.currentCell&&t.setSnapPositions(t.currentCell)};"function"==typeof ResizeObserver?(this.resizeObserver=new ResizeObserver(o),this.resizeObserver.observe(t.editMode.board.container)):(s=addEvent(window,"resize",o),addEvent(this,"destroy",s))}onMouseMove(e){const t=this.currentCell;var i,s=t&&t.container,o=this.currentDimension,n=this.editMode.sidebar,n=n&&n.editMode.rwdMode;t&&s&&!((t.row.layout.board.editMode||{}).dragDrop||{}).isActive&&(s=GUIElement.getOffsets(t),i=GUIElement.getDimFromOffsets(GUIElement.getOffsets(t.row))["width"],"x"===o&&(i=Math.min(e.clientX-s.left,i)/i*100+"%",t.setSize(i),t.updateSize(i,n),this.startX=e.clientX),"y"===o&&t.setSize(void 0,e.clientY-s.top),fireEvent(this.editMode.board,"cellResize",{cell:t}),fireEvent(t.row,"cellChange",{cell:t,row:t.row}),this.setSnapPositions(t))}destroy(){var i=["snapRight","snapBottom"];let s;removeEvent(document,"mousemove"),removeEvent(document,"mouseup"),this.resizeObserver?.unobserve(this.editMode.board.container);for(let e=0,t=i.length;e<t;++e)s=this[i[e]],removeEvent(s,"mousedown"),s.remove()}toJSON(){var e=this.options;return{$class:"Dashboards.Action.Resizer",options:{enabled:e.enabled,styles:{minWidth:e.styles.minWidth,minHeight:e.styles.minHeight},type:e.type,snap:{width:e.snap.width,height:e.snap.height}}}}}Resizer.defaultOptions={enabled:!0,styles:{minWidth:20,minHeight:50},type:"xy",snap:{width:9,height:17}};export default Resizer;