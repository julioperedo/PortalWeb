"use strict";import Bindings from"../Actions/Bindings.js";const componentFromJSON=Bindings["componentFromJSON"];import EditGlobals from"../EditMode/EditGlobals.js";import Globals from"../Globals.js";import GUIElement from"./GUIElement.js";import U from"../../Core/Utilities.js";const{merge,fireEvent}=U;class Cell extends GUIElement{static fromJSON(e,o){if(o){e=e.options;let t=e.containerId;return o.layout.copyId&&(t=t+"_"+o.layout.copyId),new Cell(o,{id:t,parentContainerId:o.container&&o.container.id||e.parentContainerId,mountedComponentJSON:e.mountedComponentJSON,style:e.style,layoutJSON:e.layoutJSON,width:e.width,height:e.height})}}constructor(t,e,o){super(),this.type=Globals.guiElementType.cell,this.id=e.id,this.options=e,this.row=t,this.isVisible=!0;var i=document.getElementById(e.parentContainerId||"")||t.container,s=t.layout.options||{},n=t.options||{},l=s.cellClassName||"";let a;if(e.height&&(a="number"==typeof e.height?e.height+"px":e.height),this.container=this.getElementContainer({render:t.layout.board.guiEnabled,parentContainer:i,attribs:{id:e.id,className:Globals.classNames.cell+" "+l},element:o,elementId:e.id,style:merge(s.style,n.style,e.style,{height:a})}),this.reflow(),this.options.mountedComponentJSON&&this.mountComponentFromJSON(this.options.mountedComponentJSON,this.container),this.options.layout&&this.setNestedLayout(),this.options.layoutJSON){const r=this.row.layout,d=r.board,h=r.constructor.fromJSON;this.nestedLayout=h(merge(this.options.layoutJSON,{parentContainerId:this.options.id}),d,this)}}setNestedLayout(){const t=this.row.layout.board,e=this.row.layout.constructor;var o=t.options.gui;this.nestedLayout=new e(t,merge({},o&&o.layoutOptions,this.options.layout,{parentContainerId:this.options.id}),this)}mountComponentFromJSON(t,e){var o=this,t=(o.id!==t.options.parentElement&&(t.options.parentElement=o.id),componentFromJSON(t,e));return!!t&&(o.mountedComponent=t,!0)}destroy(){var t=this;const e=t["row"];t.mountedComponent&&t.mountedComponent.destroy(),e.unmountCell(t);t=0===e.cells.length;super.destroy(),t&&e.destroy()}toJSON(){var t=this,e=(t.row.container||{}).id||"";return{$class:"Dashboards.Layout.Cell",options:{containerId:t.container.id,parentContainerId:e,width:t.options.width,height:t.options.height,mountedComponentJSON:t.mountedComponent&&t.mountedComponent.toJSON(),style:t.options.style,layoutJSON:t.nestedLayout&&t.nestedLayout.toJSON()}}}getOptions(){return this.options}changeVisibility(t=!0){super.changeVisibility(t);const e=this,o=e.row;e.row.getVisibleCells().length?e.isVisible&&!o.isVisible&&e.row.show():e.row.hide(),setTimeout(()=>{fireEvent(o,"cellChange",{row:o,cell:e})},0)}getParentCell(t){var e=this;let o;if(t<=e.row.layout.level)return e.row.layout.level===t?e:0<=e.row.layout.level-1&&(o=e.row.layout.parentCell)?o.getParentCell(t):void 0}getOverlappingLevels(t,e,o){const i=this,s=i.row.layout.parentCell;let n=[i.row.layout.level];var l;return s&&(o=o||GUIElement.getOffsets(i)[t],l=GUIElement.getOffsets(s)[t],Math.abs(o-l)<e&&(n=[...n,...s.getOverlappingLevels(t,e,l)])),n}reflow(e){var o=this,e=e||o.row.layout.board.getLayoutContainerSize(),i=o.options.responsive,s=o.options.width;if(o.container){let t="";i&&i[e]&&i[e].width?t=o.convertWidthToValue(i[e].width):s&&(t=o.convertWidthToValue(s)),o.setSize(t||"auto")}}setSize(t,e){const o=this,i=o.row.layout.board.editMode;o.container&&(t&&("auto"===t&&"1 1 0%"!==o.container.style.flex?o.container.style.flex="1 1 0%":((t=o.convertWidthToValue(t))&&o.container.style.flex!=="0 0 "+t&&(o.container.style.flex="0 0 "+t),o.options.width=t)),e&&(o.options.height=o.container.style.height=e+"px"),i&&(i.hideContextPointer(),i.cellToolbar&&i.cellToolbar.isVisible&&(i.cellToolbar.cell===o?i.cellToolbar.showToolbar(o):i.cellToolbar.hide())),fireEvent(o.row.layout.board,"cellResize",{cell:o}),fireEvent(o.row,"cellChange",{cell:o,row:o.row}))}updateSize(t,e){e=e||this.row.layout.board.getLayoutContainerSize();this.options.responsive||(this.options.responsive={}),this.options.responsive[e]={width:t}}setHighlight(t){var e=this,o=e.row.layout.board.editMode;if(e.container&&o){const i=e.container,s=i.classList.contains(EditGlobals.classNames.cellEditHighlight);t||s?t&&s&&(i.classList.remove(EditGlobals.classNames.cellEditHighlight),e.row.layout.board.container.classList.remove(EditGlobals.classNames.dashboardCellEditHighlightActive),e.isHighlighted=!1):(i.classList.add(EditGlobals.classNames.cellEditHighlight),e.row.layout.board.container.classList.add(EditGlobals.classNames.dashboardCellEditHighlightActive),e.isHighlighted=!0)}}setActiveState(){this.row.layout.board.mountedComponents.forEach(t=>{t.cell.container&&t.cell.container.classList.remove(Globals.classNames.cellActive)}),this.container&&this.container.classList.add(Globals.classNames.cellActive)}setLoadingState(t=!0){this.container?.classList?.toggle(Globals.classNames.cellLoading,t)}convertWidthToValue(t){return"number"==typeof t?t+"px":/px/.test(t)?t:GUIElement.getPercentageWidth(t)||""}}export default Cell;