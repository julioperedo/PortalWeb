"use strict";import DataTable from"../Data/DataTable.js";import DataGridUtils from"./DataGridUtils.js";const{dataTableCellToString,emptyHTMLElement,makeDiv}=DataGridUtils;import Globals from"./Globals.js";import Templating from"../Core/Templating.js";import DataGridDefaults from"./DataGridDefaults.js";import H from"../Core/Globals.js";const doc=H["doc"];import U from"../Core/Utilities.js";const{addEvent,clamp,defined,fireEvent,isNumber,merge,pick}=U;class DataGrid{constructor(e,t){var i;this.columnNames=[],this.prevTop=-1,this.scrollEndRowCount=0,this.scrollEndTop=0,this.bottom=!1,this.overflowHeaderWidths=[],"string"==typeof e?(i=doc.getElementById(e),this.container=i||makeDiv(Globals.classNames.gridContainer,e)):this.container=e,this.gridContainer=makeDiv(Globals.classNames.gridContainer),this.outerContainer=makeDiv(Globals.classNames.outerContainer),this.scrollContainer=makeDiv(Globals.classNames.scrollContainer),this.innerContainer=makeDiv(Globals.classNames.innerContainer),this.outerContainer.appendChild(this.scrollContainer),this.gridContainer.appendChild(this.outerContainer),this.container.appendChild(this.gridContainer),this.options=merge(DataGrid.defaultOptions,t),this.gridContainer.style.height=this.getDataGridSize()+"px",this.gridContainer.role="figure",this.dataTable=this.initDataTable(),this.rowElements=[],this.draggedResizeHandle=null,this.draggedColumnRightIx=null,this.render(),(this.containerResizeObserver=new ResizeObserver(()=>{this.updateGridElements()})).observe(this.container)}update(e){this.options=merge(this.options,e),this.options.dataTable!==this.dataTable&&(this.dataTable=this.initDataTable()),this.scrollContainer.removeChild(this.innerContainer),this.render()}resizeColumn(e,t){const i=this.columnHeadersContainer;var s="string"==typeof t?this.columnNames.indexOf(t):t,n=""+e;if(isNumber(s)){if(-1!==s){if(i){const l=i.children[s];l&&(l.style.flex=n)}for(let e=0;e<this.rowElements.length;e++){const o=this.rowElements[e].children[s];o&&(o.style.flex=n)}}}else{if(i)for(let e=0;e<i.children.length;e++)i.children[e].style.flex=n;for(let e=0;e<this.rowElements.length;e++){const a=this.rowElements[e];for(let e=0;e<a.children.length;e++)a.children[e].style.flex=n}}this.renderColumnDragHandles(),this.emit({type:"afterResizeColumn",width:e,index:s,name:isNumber(s)?this.columnNames[s]:void 0})}emit(e){fireEvent(this,e.type,e)}toggleRowHighlight(e){this.hoveredRow&&this.hoveredRow.classList.contains("hovered")&&this.hoveredRow.classList.remove("hovered"),e&&(e.classList.contains("hovered")?e.classList.remove("hovered"):e.classList.add("hovered"))}on(e,t){return addEvent(this,e,t)}scrollToRow(e){this.outerContainer.scrollTop=e*this.options.cellHeight}getColumnsToDisplay(){const t=this.options.columns,i=this.dataTable.modified.getColumnNames(),s=[];for(let e=0;e<i.length;e++){var n=i[e],l=t[n];(!l||!defined(l.show)||t[n].show)&&s.push(n)}return s}isColumnEditable(e){e=this.options.columns[e]||{};return pick(e.editable,this.options.editable)}initDataTable(){return this.options.dataTable||new DataTable}render(){var e=this["options"];this.prevTop=-1,this.bottom=!1,emptyHTMLElement(this.innerContainer),e.columnHeaders.enabled?(this.columnNames=this.getColumnsToDisplay(),this.renderColumnHeaders()):this.outerContainer.style.top="0",this.renderInitialRows(),this.addEvents(),this.updateScrollingLength(),this.updateVisibleCells(),e.columnHeaders.enabled&&e.resizableColumns&&this.renderColumnDragHandles(),this.updateGridElements(),this.gridContainer.ariaLabel=`Grid with ${this.dataTable.getColumnNames().length} columns and ${this.dataTable.getRowCount()} rows.`}addEvents(){this.outerContainer.addEventListener("scroll",e=>{this.onScroll(e)}),document.addEventListener("click",e=>{this.onDocumentClick(e)}),this.container.addEventListener("mouseover",e=>{this.handleMouseOver(e)})}updateVisibleCells(e=!1){let t=this.outerContainer.scrollTop,i=(H.isSafari&&(t=clamp(t,0,this.outerContainer.scrollHeight-this.outerContainer.clientHeight)),Math.floor(t/this.options.cellHeight));if(i!==this.prevTop||e){this.prevTop=i;var s=this.columnNames,n=this.dataTable.modified.getRowCount();for(let e=0;e<this.rowElements.length&&i<n;e++,i++){const o=this.rowElements[e];o.dataset.rowIndex=String(i);var l=o.childNodes;for(let e=0,t=s.length;e<t;e++){const a=l[e],r=s[e],h=this.dataTable.modified.getCell(s[e],i);a.textContent=this.formatCell(h,r),a.dataset.originalData=""+h,a.dataset.columnName=s[e],a.dataset.dataType=typeof h,0===e&&(o.dataset.rowXIndex=String(isNumber(h)?h:i))}}this.prevTop+this.scrollEndRowCount===n?!this.bottom&&this.scrollEndTop&&(this.bottom=!0,this.innerContainer.scrollTop=this.scrollEndTop):this.bottom&&(this.bottom=!1,this.innerContainer.scrollTop=0)}}onScroll(e){e.preventDefault(),window.requestAnimationFrame(this.updateVisibleCells.bind(this,!1))}onCellClick(t,i){if(this.isColumnEditable(i)){let e=t.querySelector("input");var s,i=t.getAttribute("data-original-data");e||(this.removeCellInputElement(),s=t.clientHeight,t.textContent="",(e=this.cellInputEl=document.createElement("input")).style.height=s+"px",e.className=Globals.classNames.cellInput,t.appendChild(e),e.focus(),e.value=i||""),this.emit({type:"cellClick",input:e})}}onDocumentClick(e){if(this.cellInputEl&&e.target){const t=this.cellInputEl.parentNode;t&&t.contains(e.target)||this.removeCellInputElement()}}handleMouseOver(e){const t=e.target;t&&t.classList.contains(Globals.classNames.cell)?(e=t.parentElement,this.toggleRowHighlight(e),this.hoveredRow=e,fireEvent(this.container,"dataGridHover",{row:e})):this.hoveredRow&&(this.toggleRowHighlight(),this.hoveredRow=void 0)}removeCellInputElement(){const t=this.cellInputEl;if(t){const n=t.parentNode;if(n){var i=n.getAttribute("data-data-type"),s=n.getAttribute("data-column-name");let e=t.value;"number"===i&&(e=parseFloat(e)),n.textContent=this.formatCell(e,s||"")}t.remove(),delete this.cellInputEl}}updateScrollingLength(){var i=this.columnNames;let s=this.dataTable.modified.getRowCount()-1,t=0;var n=s-this.getNumRowsToDraw(),l=this.outerContainer.clientHeight;this.innerContainer.style.height=l+"px";for(let t=0;t<this.rowElements.length;t++){const o=this.rowElements[t].childNodes;for(let e=0;e<i.length;e++)o[e].textContent=dataTableCellToString(this.dataTable.modified.getCell(i[e],s-t))}this.scrollContainer.appendChild(this.innerContainer);for(let e=0;s>n;s--,e++)if((t+=this.rowElements[e].offsetHeight)>l){s--;break}var e=s-n,e=(this.scrollEndRowCount=this.rowElements.length-e,this.scrollEndTop=t-l,(this.dataTable.modified.getRowCount()+e)*this.options.cellHeight);this.scrollContainer.style.height=e+"px"}getNumRowsToDraw(){return Math.min(this.dataTable.modified.getRowCount(),Math.ceil(this.outerContainer.offsetHeight/this.options.cellHeight))}getDataGridSize(){var e=this.options,t=this.container.getBoundingClientRect()["height"];return 2<t?t:e.defaultHeight}renderCell(e,t){let i=Globals.classNames.cell;this.isColumnEditable(t)||(i+=` ${i}-readonly`);const s=makeDiv(i);s.style.minHeight=this.options.cellHeight+"px",s.addEventListener("click",()=>this.onCellClick(s,t)),e.appendChild(s)}renderRow(){var t=makeDiv(Globals.classNames.row);for(let e=0;e<this.columnNames.length;e++)this.renderCell(t,this.columnNames[e]);this.innerContainer.appendChild(t),this.rowElements.push(t)}formatHeaderCell(e){var t=this.options.columns[e],t=t&&t.headerFormat;return t?Templating.format(t,{text:e}):e}formatCell(e,t){const i=this.options,s=i.columns[t],n=s&&s.cellFormat,l=s&&s.cellFormatter;let o=defined(e)?e:"";return n&&("number"==typeof e&&-1<n.indexOf("value")?o=Templating.format(n,{value:e}):"string"==typeof e&&-1<n.indexOf("text")&&(o=Templating.format(n,{text:e}))),l?l.call({value:e}):o.toString()}renderColumnHeader(e,t){let i=Globals.classNames.columnHeader;this.isColumnEditable(t)||(i+=` ${i}-readonly`);const s=makeDiv(i);s.style.minHeight=this.options.cellHeight+"px",s.style.maxHeight=2*this.options.cellHeight+"px",s.textContent=this.formatHeaderCell(t),e.appendChild(s)}renderColumnHeaders(){const e=this.columnNames,t=this.columnHeadersContainer=this.columnHeadersContainer||makeDiv(Globals.classNamePrefix+"column-headers");emptyHTMLElement(t),e.forEach(this.renderColumnHeader.bind(this,t)),this.headerContainer||(this.headerContainer=makeDiv(Globals.classNamePrefix+"header-container"),this.headerContainer.appendChild(t)),this.gridContainer.insertBefore(this.headerContainer,this.outerContainer),this.updateColumnHeaders()}updateGridElements(){this.updateColumnHeaders(),this.redrawRowElements(),this.updateDragHandlesPosition()}updateColumnHeaders(){const t=this.columnHeadersContainer;if(t){for(let e=0;e<this.columnNames.length;e++){const i=this.columnNames[e],s=t.children[e],n=this.overflowHeaderWidths[e];s.scrollWidth>s.clientWidth?(this.overflowHeaderWidths[e]=s.scrollWidth,s.textContent=this.formatHeaderCell(i).split(" ").map(e=>e.length<4?e:e.slice(0,2)+"...").join(" ")):isNumber(n)&&n<=s.clientWidth&&(this.overflowHeaderWidths[e]=null,s.textContent=this.formatHeaderCell(i))}this.outerContainer.style.top=t.clientHeight+"px",t.lastChild&&(t.lastChild.style.marginRight=this.outerContainer.offsetWidth-this.outerContainer.clientWidth+"px")}}redrawRowElements(){if(this.rowElements.length){const t=[],i=this.rowElements[0].children;for(let e=0;e<i.length;e++)t.push(i[e].style.flex);emptyHTMLElement(this.innerContainer),this.renderInitialRows(),this.updateScrollingLength(),this.updateVisibleCells(!0);for(let e=0;e<this.rowElements.length;e++){const s=this.rowElements[e];for(let e=0;e<s.childElementCount;e++)s.children[e].style.flex=t[e]}}}updateDragHandlesPosition(){var t=this.columnHeadersContainer,i=this.columnDragHandlesContainer;if(i&&t)for(let e=0;e<i.childElementCount-1;e++){const s=i.children[e],n=t.children[e+1];s.style.height=t.clientHeight+"px",s.style.left=n.offsetLeft-2+"px"}}renderInitialRows(){this.rowElements=[];var t=this.getNumRowsToDraw();for(let e=0;e<t;e++)this.renderRow()}renderColumnDragHandles(){if(this.columnHeadersContainer){const n=this.columnDragHandlesContainer=this.columnDragHandlesContainer||makeDiv(Globals.classNamePrefix+"col-resize-container");var t=this.columnHeadersContainer.children,i=this.options.cellHeight;emptyHTMLElement(n);for(let e=1;e<t.length;++e){var s=t[e];const l=makeDiv(Globals.classNamePrefix+"col-resize-handle");l.style.height=i+"px",l.style.left=s.offsetLeft-2+"px",l.addEventListener("mouseover",()=>{this.draggedResizeHandle||(l.style.opacity="1")}),l.addEventListener("mouseleave",()=>{this.draggedResizeHandle||(l.style.opacity="0")}),l.addEventListener("mousedown",this.onHandleMouseDown.bind(this,l,e)),n.appendChild(l)}this.renderColumnResizeCrosshair(n),document.addEventListener("mouseup",e=>{this.draggedResizeHandle&&this.stopColumnResize(this.draggedResizeHandle,e)}),document.addEventListener("mousemove",e=>{this.draggedResizeHandle&&this.updateColumnResizeDrag(e)}),this.headerContainer&&this.headerContainer.appendChild(n)}}renderColumnResizeCrosshair(e){const t=this.columnResizeCrosshair=this.columnResizeCrosshair||makeDiv(Globals.classNamePrefix+"col-resize-crosshair");var i=this.options.cellHeight;t.style.top=i+"px",t.style.height=this.innerContainer.offsetHeight+"px",e.appendChild(t)}onHandleMouseDown(e,t,i){if(!this.draggedResizeHandle){i.preventDefault(),this.draggedResizeHandle=e,this.draggedColumnRightIx=t,this.dragResizeStart=i.pageX;const s=this.columnResizeCrosshair;s&&(s.style.left=e.offsetLeft+e.offsetWidth/2-s.offsetWidth/2+"px",s.style.opacity="1")}}updateColumnResizeDrag(e){const t=this.draggedResizeHandle,i=this.columnResizeCrosshair;var s=this.draggedColumnRightIx,n=this.columnHeadersContainer;t&&i&&null!==s&&n&&this.dragResizeStart&&(n=n.children[s],s=e.pageX-this.dragResizeStart,e=n.offsetLeft+s,t.style.left=e-t.offsetWidth/2+"px",i.style.left=e-i.offsetWidth/2+"px")}stopColumnResize(e,t){const i=this.columnResizeCrosshair;var s,n=this.draggedColumnRightIx,l=this.columnHeadersContainer;i&&l&&this.dragResizeStart&&null!==n&&(e.style.opacity="0",i.style.opacity="0",e=l.children[n-1],l=l.children[n],t=t.pageX-this.dragResizeStart,s=e.offsetWidth+t,t=l.offsetWidth-t,s=s/e.offsetWidth,t=t/l.offsetWidth,e=(e.style.flex?parseFloat(e.style.flex):1)*s,s=(l.style.flex?parseFloat(l.style.flex):1)*t,this.resizeColumn(e,n-1),this.resizeColumn(s,n),this.draggedResizeHandle=null,this.draggedColumnRightIx=null,this.updateGridElements())}setSize(e,t){e&&(this.innerContainer.style.width=e+"px"),t&&(this.gridContainer.style.height=this.getDataGridSize()+"px",this.outerContainer.style.height=t-(this.options.cellHeight+this.getMarginHeight(t))+"px"),this.render()}getMarginHeight(e){return e-this.gridContainer.getBoundingClientRect().height}}DataGrid.defaultOptions=DataGridDefaults;export default DataGrid;