"use strict";import H from"./Globals.js";const win=H["win"];import U from"./Utilities.js";const{defined,error,extend,isObject,merge,objectEach,pad,pick,splat,timeUnits}=U,hasNewSafariBug=H.isSafari&&win.Intl&&win.Intl.DateTimeFormat.prototype.formatRange,hasOldSafariBug=H.isSafari&&win.Intl&&!win.Intl.DateTimeFormat.prototype.formatRange;class Time{constructor(e){this.options={},this.useUTC=!1,this.variableTimezone=!1,this.Date=win.Date,this.getTimezoneOffset=this.timezoneOffsetFunction(),this.update(e)}get(e,t){var i,s;return this.variableTimezone||this.timezoneOffset?(s=(i=t.getTime())-this.getTimezoneOffset(t),t.setTime(s),s=t["getUTC"+e](),t.setTime(i),s):this.useUTC?t["getUTC"+e]():t["get"+e]()}set(e,t,i){if(this.variableTimezone||this.timezoneOffset){if("Milliseconds"===e||"Seconds"===e||"Minutes"===e&&this.getTimezoneOffset(t)%36e5==0)return t["setUTC"+e](i);var s=this.getTimezoneOffset(t),s=t.getTime()-s,n=(t.setTime(s),t["setUTC"+e](i),this.getTimezoneOffset(t)),s=t.getTime()+n;return t.setTime(s)}return this.useUTC||hasNewSafariBug&&"FullYear"===e?t["setUTC"+e](i):t["set"+e](i)}update(e={}){var t=pick(e.useUTC,!0);this.options=e=merge(!0,this.options,e),this.Date=e.Date||win.Date||Date,this.useUTC=t,this.timezoneOffset=t&&e.timezoneOffset||void 0,this.getTimezoneOffset=this.timezoneOffsetFunction(),this.variableTimezone=t&&!(!e.getTimezoneOffset&&!e.timezone)}makeTime(e,t,i,s,n,o){let a,r,m;return this.useUTC?(a=this.Date.UTC.apply(0,arguments),r=this.getTimezoneOffset(a),a+=r,r!==(m=this.getTimezoneOffset(a))?a+=m-r:r-36e5!==this.getTimezoneOffset(a-36e5)||hasOldSafariBug||(a-=36e5)):a=new this.Date(e,t,pick(i,1),pick(s,0),pick(n,0),pick(o,0)).getTime(),a}timezoneOffsetFunction(){const e=this,t=this.options,i=t.getTimezoneOffset,s=t.moment||win.moment;if(!this.useUTC)return function(e){return 6e4*new Date(e.toString()).getTimezoneOffset()};if(t.timezone){if(s)return function(e){return 6e4*-s.tz(e,t.timezone).utcOffset()};error(25)}return this.useUTC&&i?function(e){return 6e4*i(e.valueOf())}:function(){return 6e4*(e.timezoneOffset||0)}}dateFormat(i,s,e){if(!defined(s)||isNaN(s))return H.defaultOptions.lang&&H.defaultOptions.lang.invalidDate||"";i=pick(i,"%Y-%m-%d %H:%M:%S");const n=this,t=new this.Date(s),o=this.get("Hours",t),a=this.get("Day",t),r=this.get("Date",t),m=this.get("Month",t),f=this.get("FullYear",t),h=H.defaultOptions.lang,u=h&&h.weekdays,l=h&&h.shortWeekdays,g=extend({a:l?l[a]:u[a].substr(0,3),A:u[a],d:pad(r),e:pad(r,2," "),w:a,b:h.shortMonths[m],B:h.months[m],m:pad(m+1),o:m+1,y:f.toString().substr(2,2),Y:f,H:pad(o),k:o,I:pad(o%12||12),l:o%12||12,M:pad(this.get("Minutes",t)),p:o<12?"AM":"PM",P:o<12?"am":"pm",S:pad(this.get("Seconds",t)),L:pad(Math.floor(s%1e3),3)},H.dateFormats);return objectEach(g,function(e,t){for(;-1!==i.indexOf("%"+t);)i=i.replace("%"+t,"function"==typeof e?e.call(n,s):e)}),e?i.substr(0,1).toUpperCase()+i.substr(1):i}resolveDTLFormat(e){return isObject(e,!0)?e:{main:(e=splat(e))[0],from:e[1],to:e[2]}}getTimeTicks(e,t,i,s){const n=this,o=n.Date,a=[],r={},m=new o(t),f=e.unitRange,h=e.count||1;let u,l,g,d;if(s=pick(s,1),defined(t)){n.set("Milliseconds",m,f>=timeUnits.second?0:h*Math.floor(n.get("Milliseconds",m)/h)),f>=timeUnits.second&&n.set("Seconds",m,f>=timeUnits.minute?0:h*Math.floor(n.get("Seconds",m)/h)),f>=timeUnits.minute&&n.set("Minutes",m,f>=timeUnits.hour?0:h*Math.floor(n.get("Minutes",m)/h)),f>=timeUnits.hour&&n.set("Hours",m,f>=timeUnits.day?0:h*Math.floor(n.get("Hours",m)/h)),f>=timeUnits.day&&n.set("Date",m,f>=timeUnits.month?1:Math.max(1,h*Math.floor(n.get("Date",m)/h))),f>=timeUnits.month&&(n.set("Month",m,f>=timeUnits.year?0:h*Math.floor(n.get("Month",m)/h)),l=n.get("FullYear",m)),f>=timeUnits.year&&(l-=l%h,n.set("FullYear",m,l)),f===timeUnits.week&&(d=n.get("Day",m),n.set("Date",m,n.get("Date",m)-d+s+(d<s?-7:0))),l=n.get("FullYear",m);var T=n.get("Month",m),c=n.get("Date",m),p=n.get("Hours",m);t=m.getTime(),!n.variableTimezone&&n.useUTC||!defined(i)||(g=i-t>4*timeUnits.month||n.getTimezoneOffset(t)!==n.getTimezoneOffset(i));let e=m.getTime();for(u=1;e<i;)a.push(e),f===timeUnits.year?e=n.makeTime(l+u*h,0):f===timeUnits.month?e=n.makeTime(l,T+u*h):!g||f!==timeUnits.day&&f!==timeUnits.week?g&&f===timeUnits.hour&&1<h?e=n.makeTime(l,T,c,p+u*h):e+=f*h:e=n.makeTime(l,T,c+u*h*(f===timeUnits.day?1:7)),u++;a.push(e),f<=timeUnits.hour&&a.length<1e4&&a.forEach(function(e){e%18e5==0&&"000000000"===n.dateFormat("%H%M%S%L",e)&&(r[e]="day")})}return a.info=extend(e,{higherRanks:r,totalRange:f*h}),a}getDateFormat(e,t,i,s){const n=this.dateFormat("%m-%d %H:%M:%S.%L",t),o="01-01 00:00:00.000",a={millisecond:15,second:12,minute:9,hour:6,day:3};let r="millisecond",m=r;for(r in timeUnits){if(e===timeUnits.week&&+this.dateFormat("%w",t)===i&&n.substr(6)===o.substr(6)){r="week";break}if(timeUnits[r]>e){r=m;break}if(a[r]&&n.substr(a[r])!==o.substr(a[r]))break;"week"!==r&&(m=r)}return this.resolveDTLFormat(s[r]).main}}export default Time;