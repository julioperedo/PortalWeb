"use strict";import DataConverter from"./DataConverter.js";import U from"../../Core/Utilities.js";const merge=U["merge"];function isRowEqual(e,t){let r=e.length;if(t.length!==r)return!1;for(;--r;)if(e[r]!==t[r])return!1;return!0}class HTMLTableConverter extends DataConverter{constructor(e){e=merge(HTMLTableConverter.defaultOptions,e);super(e),this.columns=[],this.headers=[],(this.options=e).tableElement&&(this.tableElement=e.tableElement,this.tableElementID=e.tableElement.id)}export(e,t=this.options){var r=!1!==t.firstRowAsNames,l=t.useMultiLevelHeaders;const a=e.getSortedColumns(t.usePresentationOrder),s=Object.keys(a),o=[],n=s.length,i=[];let h="";if(r){const g=[];if(l){for(const f of s){var u=(a[f].shift()||"").toString();g.push(u)}h=this.getTableHeaderHTML(s,g,t)}else h=this.getTableHeaderHTML(void 0,s,t)}for(let r=0;r<n;r++){var m=s[r],d=a[m],c=d.length;for(let t=0;t<c;t++){let e=d[t];i[t]||(i[t]=[]),"string"!=typeof e&&"number"!=typeof e&&void 0!==e&&(e=(e||"").toString()),i[t][r]=this.getCellHTMLFromValue(r?"td":"th",null,r?"":'scope="row"',e),r===n-1&&o.push("<tr>"+i[t].join("")+"</tr>")}}let p="";return"<table>"+(p=t.tableCaption?'<caption class="highcharts-table-caption">'+t.tableCaption+"</caption>":p)+h+"<tbody>"+o.join("")+"</tbody></table>"}getCellHTMLFromValue(e,t,r,l,a){let s=l,o="text"+(t?" "+t:"");return"number"==typeof s?(s=s.toString(),","===a&&(s=s.replace(".",a)),o="number"):l||(s="",o="empty"),"<"+e+(r?" "+r:"")+' class="'+o+'">'+s+"</"+e+">"}getTableHeaderHTML(e=[],t=[],r=this.options){var{useMultiLevelHeaders:l,useRowspanHeaders:a}=r;r.useLocalDecimalPoint&&1.1.toLocaleString()[1];let s="<thead>",o=0,n=t&&t.length,i,h=0,u;if(l&&e&&t&&!isRowEqual(e,t)){for(s+="<tr>";o<n;++o)(i=e[o])===e[o+1]?++h:h?(s+=this.getCellHTMLFromValue("th","highcharts-table-topheading",'scope="col" colspan="'+(h+1)+'"',i),h=0):(i===t[o]?a?(u=2,delete t[o]):(u=1,t[o]=""):u=1,s+=this.getCellHTMLFromValue("th","highcharts-table-topheading",'scope="col"'+(1<u?' valign="top" rowspan="'+u+'"':""),i));s+="</tr>"}if(t){for(s+="<tr>",o=0,n=t.length;o<n;++o)void 0!==t[o]&&(s+=this.getCellHTMLFromValue("th",null,'scope="col"',t[o]));s+="</tr>"}return s+="</thead>"}parse(e,t){const s=this,o=[],n=[],i=merge(s.options,e),{endRow:h,startColumn:u,endColumn:m,firstRowAsNames:d}=i,c=i.tableElement||this.tableElement;if(c instanceof HTMLElement){s.tableElement=c,s.tableElementID=c.id,this.emit({type:"parse",columns:s.columns,detail:t,headers:s.headers});var p=c.getElementsByTagName("tr"),g=p.length;let r=0,l,a=i["startRow"];if(d&&g){var f=p[0].children,T=f.length;for(let e=u;e<T&&!(e>m);e++)"TD"!==(l=f[e]).tagName&&"TH"!==l.tagName||n.push(l.innerHTML);a++}for(;r<g;){if(r>=a&&r<=h){var b=p[r].children,H=b.length;let e=0;for(;e<H;){const v=e-u,C=o[v];if(("TD"===(l=b[e]).tagName||"TH"===l.tagName)&&e>=u&&e<=m){o[v]||(o[v]=[]);let e=s.asGuessedType(l.innerHTML),t=(e instanceof Date&&(e=e.getTime()),o[v][r-a]=e,1);for(;r-a>=t&&void 0===C[r-a-t];)C[r-a-t]=null,t++}e++}}r++}this.columns=o,this.headers=n,this.emit({type:"afterParse",columns:o,detail:t,headers:n})}else s.emit({type:"parseError",columns:o,detail:t,headers:n,error:"Not a valid HTML Table"})}getTable(){return DataConverter.getTableFromColumns(this.columns,this.headers)}}HTMLTableConverter.defaultOptions={...DataConverter.defaultOptions,useRowspanHeaders:!0,useMultiLevelHeaders:!0};export default HTMLTableConverter;