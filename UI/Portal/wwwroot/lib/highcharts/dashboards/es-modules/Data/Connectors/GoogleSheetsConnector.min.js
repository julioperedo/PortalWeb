"use strict";import DataConnector from"./DataConnector.js";import GoogleSheetsConverter from"../Converters/GoogleSheetsConverter.js";import U from"../../Core/Utilities.js";const{merge,pick}=U;function isGoogleError(e){return"object"==typeof e&&e&&"object"==typeof e.error&&e.error&&"number"==typeof e.error.code&&"string"==typeof e.error.message&&"string"==typeof e.error.status}class GoogleSheetsConnector extends DataConnector{constructor(e){e=merge(GoogleSheetsConnector.defaultOptions,e);super(e),this.converter=new GoogleSheetsConverter(e),this.options=e}load(o){const t=this,r=t.converter,n=t.table,{dataModifier:s,dataRefreshRate:e,enablePolling:a,firstRowAsNames:l,googleAPIKey:i,googleSpreadsheetKey:g}=t.options,c=GoogleSheetsConnector.buildFetchURL(i,g,t.options);return t.emit({type:"load",detail:o,table:n,url:c}),n.deleteColumns(),fetch(c).then(e=>e.json()).then(e=>{if(isGoogleError(e))throw new Error(e.error.message);return r.parse({firstRowAsNames:l,json:e}),n.setColumns(r.getTable().getColumns()),t.setModifierOptions(s)}).then(()=>(t.emit({type:"afterLoad",detail:o,table:n,url:c}),a&&setTimeout(()=>t.load(),1e3*Math.max(e||0,1)),t)).catch(e=>{throw t.emit({type:"loadError",detail:o,error:e,table:n}),e})}}GoogleSheetsConnector.defaultOptions={googleAPIKey:"",googleSpreadsheetKey:"",worksheet:1,enablePolling:!1,dataRefreshRate:2,firstRowAsNames:!0},function(e){const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function r(e={}){var{endColumn:e,endRow:o,googleSpreadsheetRange:t,startColumn:r,startRow:n}=e;return t||(s[r||0]||"A")+(Math.max(n||0,0)+1)+":"+(s[pick(e,25)]||"Z")+(o?Math.max(o,0):"Z")}e.buildFetchURL=function(e,o,t={}){return`https://sheets.googleapis.com/v4/spreadsheets/${o}/values/`+(t.onlyColumnNames?"A1:Z1":r(t))+"?alt=json"+(t.onlyColumnNames?"":"&dateTimeRenderOption=FORMATTED_STRING&majorDimension=COLUMNS&valueRenderOption=UNFORMATTED_VALUE")+"&prettyPrint=false&key="+e},e.buildQueryRange=r}(GoogleSheetsConnector=GoogleSheetsConnector||{}),DataConnector.registerType("GoogleSheets",GoogleSheetsConnector);export default GoogleSheetsConnector;