"use strict";import controllableMixin from"./controllableMixin.js";import H from"./../../parts/Globals.js";import MockPoint from"./../MockPoint.js";import Tooltip from"../../parts/Tooltip.js";import U from"./../../parts/Utilities.js";var extend=U.extend,format=U.format,isNumber=U.isNumber,merge=U.merge,pick=U.pick;import"../../parts/SVGRenderer.js";var ControllableLabel=function(t,i,o){this.init(t,i,o),this.collection="labels"};ControllableLabel.shapesWithoutBackground=["connector"],ControllableLabel.alignedPosition=function(t,i){var o,n,e=t.align,l=t.verticalAlign,a=(i.x||0)+(t.x||0),r=(i.y||0)+(t.y||0);return"right"===e?o=1:"center"===e&&(o=2),o&&(a+=(i.width-(t.width||0))/o),"bottom"===l?n=1:"middle"===l&&(n=2),n&&(r+=(i.height-(t.height||0))/n),{x:Math.round(a),y:Math.round(r)}},ControllableLabel.justifiedOptions=function(t,i,o,n){var e,l=o.align,a=o.verticalAlign,r=i.box?0:i.padding||0,s=i.getBBox(),h={align:l,verticalAlign:a,x:o.x,y:o.y,width:i.width,height:i.height},c=n.x-t.plotLeft,p=n.y-t.plotTop;return(e=c+r)<0&&("right"===l?h.align="left":h.x=-e),(e=c+s.width-r)>t.plotWidth&&("left"===l?h.align="right":h.x=t.plotWidth-e),(e=p+r)<0&&("bottom"===a?h.verticalAlign="top":h.y=-e),(e=p+s.height-r)>t.plotHeight&&("top"===a?h.verticalAlign="bottom":h.y=t.plotHeight-e),h},ControllableLabel.attrsMap={backgroundColor:"fill",borderColor:"stroke",borderWidth:"stroke-width",zIndex:"zIndex",borderRadius:"r",padding:"padding"},merge(!0,ControllableLabel.prototype,controllableMixin,{translatePoint:function(t,i){controllableMixin.translatePoint.call(this,t,i,0)},translate:function(t,i){var o,n=this.annotation.chart,e=this.annotation.userOptions,l=n.annotations.indexOf(this.annotation),a=n.options.annotations[l];n.inverted&&(o=t,t=i,i=o),this.options.x+=t,this.options.y+=i,a[this.collection][this.index].x=this.options.x,a[this.collection][this.index].y=this.options.y,e[this.collection][this.index].x=this.options.x,e[this.collection][this.index].y=this.options.y},render:function(t){var i=this.options,o=this.attrsFromOptions(i),n=i.style;this.graphic=this.annotation.chart.renderer.label("",0,-9999,i.shape,null,null,i.useHTML,null,"annotation-label").attr(o).add(t),this.annotation.chart.styledMode||("contrast"===n.color&&(n.color=this.annotation.chart.renderer.getContrast(ControllableLabel.shapesWithoutBackground.indexOf(i.shape)>-1?"#FFFFFF":i.backgroundColor)),this.graphic.css(i.style).shadow(i.shadow)),i.className&&this.graphic.addClass(i.className),this.graphic.labelrank=i.labelrank,controllableMixin.render.call(this)},redraw:function(t){var i,o,n,e=this.options,l=this.text||e.format||e.text,a=this.graphic,r=this.points[0];a.attr({text:l?format(l,r.getLabelConfig(),this.annotation.chart):e.formatter.call(r,this)}),o=this.anchor(r),(i=n=this.position(o))?(a.alignAttr=n,n.anchorX=o.absolutePosition.x,n.anchorY=o.absolutePosition.y,a[t?"animate":"attr"](n)):a.attr({x:0,y:-9999}),a.placed=Boolean(i),controllableMixin.redraw.call(this,t)},anchor:function(){var t=controllableMixin.anchor.apply(this,arguments),i=this.options.x||0,o=this.options.y||0;return t.absolutePosition.x-=i,t.absolutePosition.y-=o,t.relativePosition.x-=i,t.relativePosition.y-=o,t},position:function(t){var i,o,n,e,l=this.graphic,a=this.annotation.chart,r=this.points[0],s=this.options,h=t.absolutePosition,c=t.relativePosition,p=r.series.visible&&MockPoint.prototype.isInsidePlot.call(r);return p&&(s.distance?i=Tooltip.prototype.getPosition.call({chart:a,distance:pick(s.distance,16)},l.width,l.height,{plotX:c.x,plotY:c.y,negative:r.negative,ttBelow:r.ttBelow,h:c.height||c.width}):s.positioner?i=s.positioner.call(this):(o={x:h.x,y:h.y,width:0,height:0},i=ControllableLabel.alignedPosition(extend(s,{width:l.width,height:l.height}),o),"justify"===this.options.overflow&&(i=ControllableLabel.alignedPosition(ControllableLabel.justifiedOptions(a,l,s,i),o))),s.crop&&(n=i.x-a.plotLeft,e=i.y-a.plotTop,p=a.isInsidePlot(n,e)&&a.isInsidePlot(n+l.width,e+l.height))),p?i:null}}),H.SVGRenderer.prototype.symbols.connector=function(t,i,o,n,e){var l,a,r=e&&e.anchorX,s=e&&e.anchorY,h=o/2;return isNumber(r)&&isNumber(s)&&(l=[["M",r,s]],(a=i-s)<0&&(a=-n-a),a<o&&(h=r<t+o/2?a:o-a),s>i+n?l.push(["L",t+h,i+n]):s<i?l.push(["L",t+h,i]):r<t?l.push(["L",t,i+n/2]):r>t+o&&l.push(["L",t+o,i+n/2])),l||[]};export default ControllableLabel;