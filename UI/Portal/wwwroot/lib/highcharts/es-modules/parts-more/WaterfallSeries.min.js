"use strict";import Axis from"../parts/Axis.js";import Chart from"../parts/Chart.js";import H from"../parts/Globals.js";import Point from"../parts/Point.js";import StackItem from"../parts/Stacking.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,arrayMax=U.arrayMax,arrayMin=U.arrayMin,correctFloat=U.correctFloat,isNumber=U.isNumber,objectEach=U.objectEach,pick=U.pick,seriesType=U.seriesType;import"../parts/Options.js";import"../parts/Series.js";var WaterfallAxis,Series=H.Series,seriesTypes=H.seriesTypes;function ownProp(t,a){return Object.hasOwnProperty.call(t,a)}!function(t){var a=function(){function t(t){this.axis=t,this.stacks={changed:!1}}return t.prototype.renderStackTotals=function(){var t=this.axis,a=t.waterfall.stacks,e=t.stacking&&t.stacking.stackTotalGroup,s=new StackItem(t,t.options.stackLabels,!1,0,void 0);this.dummyStackItem=s,objectEach(a,function(t){objectEach(t,function(t){s.total=t.stackTotal,t.label&&(s.label=t.label),StackItem.prototype.render.call(s,e),t.label=s.label,delete s.label})}),s.total=null},t}();function e(){var t=this.waterfall.stacks;t&&(t.changed=!1,delete t.alreadyChanged)}function s(){var t=this.options.stackLabels;t&&t.enabled&&this.waterfall.stacks&&this.waterfall.renderStackTotals()}function i(){for(var t=this.axes,a=this.series,e=a.length;e--;)a[e].options.stacking&&(t.forEach(function(t){t.isXAxis||(t.waterfall.stacks.changed=!0)}),e=0)}function o(){this.waterfall||(this.waterfall=new a(this))}t.Composition=a,t.compose=function(t,a){addEvent(t,"init",o),addEvent(t,"afterBuildStacks",e),addEvent(t,"afterRender",s),addEvent(a,"beforeRedraw",i)}}(WaterfallAxis||(WaterfallAxis={})),seriesType("waterfall","column",{dataLabels:{inside:!0},lineWidth:1,lineColor:"#333333",dashStyle:"Dot",borderColor:"#333333",states:{hover:{lineWidthPlus:0}}},{pointValKey:"y",showLine:!0,generatePoints:function(){var t,a,e,s;for(seriesTypes.column.prototype.generatePoints.apply(this),e=0,a=this.points.length;e<a;e++)t=this.points[e],s=this.processedYData[e],(t.isIntermediateSum||t.isSum)&&(t.y=correctFloat(s))},translate:function(){var t,a,e,s,i,o,r,n,l,h,c,d,p,u,g,m,y,f=this.options,k=this.yAxis,b=pick(f.minPointLength,5),S=b/2,x=f.threshold,v=f.stacking,P=k.waterfall.stacks[this.stackKey];for(seriesTypes.column.prototype.translate.apply(this),n=l=x,a=0,t=(e=this.points).length;a<t;a++)s=e[a],r=this.processedYData[a],i=s.shapeArgs,h=[0,r],g=s.y,v?(P&&(d=P[a],"overlap"===v?(u=d.stackState[d.stateIndex--],o=g>=0?u:u-g,ownProp(d,"absolutePos")&&delete d.absolutePos,ownProp(d,"absoluteNeg")&&delete d.absoluteNeg):(g>=0?(u=d.threshold+d.posTotal,d.posTotal-=g,o=u):(u=d.threshold+d.negTotal,d.negTotal-=g,o=u-g),d.posTotal||ownProp(d,"absolutePos")&&(d.posTotal=d.absolutePos,delete d.absolutePos),d.negTotal||ownProp(d,"absoluteNeg")&&(d.negTotal=d.absoluteNeg,delete d.absoluteNeg)),s.isSum||(d.connectorThreshold=d.threshold+d.stackTotal),k.reversed?(m=g>=0?o-g:o+g,y=o):(m=o,y=o-g),s.below=m<=pick(x,0),i.y=k.translate(m,0,1,0,1),i.height=Math.abs(i.y-k.translate(y,0,1,0,1))),(p=k.waterfall.dummyStackItem)&&(p.x=a,p.label=P[a].label,p.setOffset(this.pointXOffset||0,this.barW||0,this.stackedYNeg[a],this.stackedYPos[a]))):(o=Math.max(n,n+g)+h[0],i.y=k.translate(o,0,1,0,1),s.isSum?(i.y=k.translate(h[1],0,1,0,1),i.height=Math.min(k.translate(h[0],0,1,0,1),k.len)-i.y):s.isIntermediateSum?(g>=0?(m=h[1]+l,y=l):(m=l,y=h[1]+l),k.reversed&&(m^=y,m^=y^=m),i.y=k.translate(m,0,1,0,1),i.height=Math.abs(i.y-Math.min(k.translate(y,0,1,0,1),k.len)),l+=h[1]):(i.height=r>0?k.translate(n,0,1,0,1)-i.y:k.translate(n,0,1,0,1)-k.translate(n-r,0,1,0,1),n+=r,s.below=n<pick(x,0)),i.height<0&&(i.y+=i.height,i.height*=-1)),s.plotY=i.y=Math.round(i.y)-this.borderWidth%2/2,i.height=Math.max(Math.round(i.height),.001),s.yBottom=i.y+i.height,i.height<=b&&!s.isNull?(i.height=b,i.y-=S,s.plotY=i.y,s.y<0?s.minPointLengthOffset=-S:s.minPointLengthOffset=S):(s.isNull&&(i.width=0),s.minPointLengthOffset=0),c=s.plotY+(s.negative?i.height:0),this.chart.inverted?s.tooltipPos[0]=k.len-c:s.tooltipPos[1]=c},processData:function(t){var a,e,s,i,o,r,n,l=this.options,h=this.yData,c=l.data,d=h.length,p=l.threshold||0;for(s=e=i=o=0,n=0;n<d;n++)r=h[n],a=c&&c[n]?c[n]:{},"sum"===r||a.isSum?h[n]=correctFloat(s):"intermediateSum"===r||a.isIntermediateSum?(h[n]=correctFloat(e),e=0):(s+=r,e+=r),i=Math.min(s,i),o=Math.max(s,o);Series.prototype.processData.call(this,t),l.stacking||(this.dataMin=i+p,this.dataMax=o)},toYData:function(t){return t.isSum?"sum":t.isIntermediateSum?"intermediateSum":t.y},updateParallelArrays:function(t,a){Series.prototype.updateParallelArrays.call(this,t,a),"sum"!==this.yData[0]&&"intermediateSum"!==this.yData[0]||(this.yData[0]=null)},pointAttribs:function(t,a){var e,s=this.options.upColor;return s&&!t.options.color&&(t.color=t.y>0?s:null),delete(e=seriesTypes.column.prototype.pointAttribs.call(this,t,a)).dashstyle,e},getGraphPath:function(){return[["M",0,0]]},getCrispPath:function(){var t,a,e,s,i,o,r,n,l,h=this.data,c=this.yAxis,d=h.length,p=Math.round(this.graph.strokeWidth())%2/2,u=Math.round(this.borderWidth)%2/2,g=this.xAxis.reversed,m=this.yAxis.reversed,y=this.options.stacking,f=[];for(l=1;l<d;l++)n=h[l].shapeArgs,s=h[l-1],r=h[l-1].shapeArgs,a=c.waterfall.stacks[this.stackKey],o=s.y>0?-r.height:0,a&&r&&n&&(e=a[l-1],y?(t=e.connectorThreshold,i=Math.round(c.translate(t,0,1,0,1)+(m?o:0))-p):i=r.y+s.minPointLengthOffset+u-p,f.push(["M",(r.x||0)+(g?0:r.width||0),i],["L",(n.x||0)+(g&&n.width||0),i])),!y&&f.length&&r&&(s.y<0&&!m||s.y>0&&m)&&(f[f.length-2][2]+=r.height,f[f.length-1][2]+=r.height);return f},drawGraph:function(){Series.prototype.drawGraph.call(this),this.graph.attr({d:this.getCrispPath()})},setStackedPoints:function(){var t,a,e,s,i,o,r,n,l,h,c,d,p,u=this.options,g=this.yAxis.waterfall.stacks,m=u.threshold,y=m||0,f=y,k=this.stackKey,b=this.xData,S=b.length;function x(t,e,s,i){if(o)for(;s<o;s++)a.stackState[s]+=i;else a.stackState[0]=t,o=a.stackState.length;a.stackState.push(a.stackState[o-1]+e)}if(this.yAxis.stacking.usePercentage=!1,e=s=i=y,this.visible||!this.chart.options.chart.ignoreHiddenSeries){p=g.changed,(d=g.alreadyChanged)&&d.indexOf(k)<0&&(p=!0),g[k]||(g[k]={}),t=g[k];for(var v=0;v<S;v++)t[c=b[v]]&&!p||(t[c]={negTotal:0,posTotal:0,stackTotal:0,threshold:0,stateIndex:0,stackState:[],label:p&&t[c]?t[c].label:void 0}),a=t[c],(h=this.yData[v])>=0?a.posTotal+=h:a.negTotal+=h,l=u.data[v],r=a.absolutePos=a.posTotal,n=a.absoluteNeg=a.negTotal,a.stackTotal=r+n,o=a.stackState.length,l&&l.isIntermediateSum?(x(i,s,0,i),i=s,s=m,y^=f,y^=f^=y):l&&l.isSum?(x(m,e,o),y=m):(x(y,h,0,e),l&&(e+=h,s+=h)),a.stateIndex++,a.threshold=y,y+=a.stackTotal;g.changed=!1,g.alreadyChanged||(g.alreadyChanged=[]),g.alreadyChanged.push(k)}},getExtremes:function(){var t,a,e,s=this.options.stacking;return s?(t=this.yAxis.waterfall.stacks,a=this.stackedYNeg=[],e=this.stackedYPos=[],objectEach(t[this.stackKey],"overlap"===s?function(t){a.push(arrayMin(t.stackState)),e.push(arrayMax(t.stackState))}:function(t){a.push(t.negTotal+t.threshold),e.push(t.posTotal+t.threshold)}),{dataMin:arrayMin(a),dataMax:arrayMax(e)}):{dataMin:this.dataMin,dataMax:this.dataMax}}},{getClassName:function(){var t=Point.prototype.getClassName.call(this);return this.isSum?t+=" highcharts-sum":this.isIntermediateSum&&(t+=" highcharts-intermediate-sum"),t},isValid:function(){return isNumber(this.y)||this.isSum||Boolean(this.isIntermediateSum)}}),WaterfallAxis.compose(Axis,Chart);export default WaterfallAxis;