"use strict";import Chart from"../parts/Chart.js";import Color from"../parts/Color.js";var color=Color.parse;import H from"../parts/Globals.js";import Point from"../parts/Point.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,clamp=U.clamp,defined=U.defined,extend=U.extend,extendClass=U.extendClass,fireEvent=U.fireEvent,isArray=U.isArray,isNumber=U.isNumber,merge=U.merge,pick=U.pick,seriesType=U.seriesType;import"../parts/Axis.js";import"../parts/Series.js";import"../modules/networkgraph/layouts.js";import"../modules/networkgraph/draggable-nodes.js";var Series=H.Series,Reingold=H.layouts["reingold-fruchterman"],NetworkPoint=H.seriesTypes.bubble.prototype.pointClass,dragNodesMixin=H.dragNodesMixin;Chart.prototype.getSelectedParentNodes=function(){var t=this.series,e=[];return t.forEach(function(t){t.parentNode&&t.parentNode.selected&&e.push(t.parentNode)}),e},H.networkgraphIntegrations.packedbubble={repulsiveForceFunction:function(t,e,i,a){return Math.min(t,(i.marker.radius+a.marker.radius)/2)},barycenter:function(){var t,e,i=this,a=i.options.gravitationalConstant,o=i.box,s=i.nodes;s.forEach(function(r){i.options.splitSeries&&!r.isParentNode?(t=r.series.parentNode.plotX,e=r.series.parentNode.plotY):(t=o.width/2,e=o.height/2),r.fixedPosition||(r.plotX-=(r.plotX-t)*a/(r.mass*Math.sqrt(s.length)),r.plotY-=(r.plotY-e)*a/(r.mass*Math.sqrt(s.length)))})},repulsive:function(t,e,i,a){var o=e*this.diffTemperature/t.mass/t.degree,s=i.x*o,r=i.y*o;t.fixedPosition||(t.plotX+=s,t.plotY+=r),a.fixedPosition||(a.plotX-=s,a.plotY-=r)},integrate:H.networkgraphIntegrations.verlet.integrate,getK:H.noop},H.layouts.packedbubble=extendClass(Reingold,{beforeStep:function(){this.options.marker&&this.series.forEach(function(t){t&&t.calculateParentRadius()})},setCircularPositions:function(){var t,e,i=this,a=i.box,o=i.nodes,s=o.length+1,r=2*Math.PI/s,n=i.options.initialPositionRadius;o.forEach(function(o,s){i.options.splitSeries&&!o.isParentNode?(t=o.series.parentNode.plotX,e=o.series.parentNode.plotY):(t=a.width/2,e=a.height/2),o.plotX=o.prevX=pick(o.plotX,t+n*Math.cos(o.index||s*r)),o.plotY=o.prevY=pick(o.plotY,e+n*Math.sin(o.index||s*r)),o.dispX=0,o.dispY=0})},repulsiveForces:function(){var t,e,i,a=this,o=a.options.bubblePadding;a.nodes.forEach(function(s){s.degree=s.mass,s.neighbours=0,a.nodes.forEach(function(r){t=0,s===r||s.fixedPosition||!a.options.seriesInteraction&&s.series!==r.series||(i=a.getDistXY(s,r),(e=a.vectorLength(i)-(s.marker.radius+r.marker.radius+o))<0&&(s.degree+=.01,s.neighbours++,t=a.repulsiveForce(-e/Math.sqrt(s.neighbours),a.k,s,r)),a.force("repulsive",s,t*r.mass,i,r,e))})})},applyLimitBox:function(t){var e,i;this.options.splitSeries&&!t.isParentNode&&this.options.parentNodeLimit&&(e=this.getDistXY(t,t.series.parentNode),(i=t.series.parentNodeRadius-t.marker.radius-this.vectorLength(e))<0&&i>-2*t.marker.radius&&(t.plotX-=.01*e.x,t.plotY-=.01*e.y)),Reingold.prototype.applyLimitBox.apply(this,arguments)}}),seriesType("packedbubble","bubble",{minSize:"10%",maxSize:"50%",sizeBy:"area",zoneAxis:"y",crisp:!1,tooltip:{pointFormat:"Value: {point.value}"},draggable:!0,useSimulation:!0,parentNode:{allowPointSelect:!1},dataLabels:{formatter:function(){return this.point.value},parentNodeFormatter:function(){return this.name},parentNodeTextPath:{enabled:!0},padding:0,style:{transition:"opacity 2000ms"}},layoutAlgorithm:{initialPositions:"circle",initialPositionRadius:20,bubblePadding:5,parentNodeLimit:!1,seriesInteraction:!0,dragBetweenSeries:!1,parentNodeOptions:{maxIterations:400,gravitationalConstant:.03,maxSpeed:50,initialPositionRadius:100,seriesInteraction:!0,marker:{fillColor:null,fillOpacity:1,lineWidth:1,lineColor:null,symbol:"circle"}},enableSimulation:!0,type:"packedbubble",integration:"packedbubble",maxIterations:1e3,splitSeries:!1,maxSpeed:5,gravitationalConstant:.01,friction:-.981}},{hasDraggableNodes:!0,forces:["barycenter","repulsive"],pointArrayMap:["value"],trackerGroups:["group","dataLabelsGroup","parentNodesGroup"],pointValKey:"value",isCartesian:!1,requireSorting:!1,directTouch:!0,axisTypes:[],noSharedTooltip:!0,searchPoint:H.noop,accumulateAllPoints:function(t){var e,i,a=t.chart,o=[];for(e=0;e<a.series.length;e++)if((t=a.series[e]).is("packedbubble")&&t.visible||!a.options.chart.ignoreHiddenSeries)for(i=0;i<t.yData.length;i++)o.push([null,null,t.yData[i],t.index,i,{id:i,marker:{radius:0}}]);return o},init:function(){return Series.prototype.init.apply(this,arguments),addEvent(this,"updatedData",function(){this.chart.series.forEach(function(t){t.type===this.type&&(t.isDirty=!0)},this)}),this},render:function(){var t=[];Series.prototype.render.apply(this,arguments),this.options.dataLabels.allowOverlap||(this.data.forEach(function(e){isArray(e.dataLabels)&&e.dataLabels.forEach(function(e){t.push(e)})}),this.options.useSimulation&&this.chart.hideOverlappingLabels(t))},setVisible:function(){var t=this;Series.prototype.setVisible.apply(t,arguments),t.parentNodeLayout&&t.graph?t.visible?(t.graph.show(),t.parentNode.dataLabel&&t.parentNode.dataLabel.show()):(t.graph.hide(),t.parentNodeLayout.removeElementFromCollection(t.parentNode,t.parentNodeLayout.nodes),t.parentNode.dataLabel&&t.parentNode.dataLabel.hide()):t.layout&&(t.visible?t.layout.addElementsToCollection(t.points,t.layout.nodes):t.points.forEach(function(e){t.layout.removeElementFromCollection(e,t.layout.nodes)}))},drawDataLabels:function(){var t=this.options.dataLabels.textPath,e=this.points;Series.prototype.drawDataLabels.apply(this,arguments),this.parentNode&&(this.parentNode.formatPrefix="parentNode",this.points=[this.parentNode],this.options.dataLabels.textPath=this.options.dataLabels.parentNodeTextPath,Series.prototype.drawDataLabels.apply(this,arguments),this.points=e,this.options.dataLabels.textPath=t)},seriesBox:function(){var t,e=this.chart,i=this.data,a=Math.max,o=Math.min,s=[e.plotLeft,e.plotLeft+e.plotWidth,e.plotTop,e.plotTop+e.plotHeight];return i.forEach(function(e){defined(e.plotX)&&defined(e.plotY)&&e.marker.radius&&(t=e.marker.radius,s[0]=o(s[0],e.plotX-t),s[1]=a(s[1],e.plotX+t),s[2]=o(s[2],e.plotY-t),s[3]=a(s[3],e.plotY+t))}),isNumber(s.width/s.height)?s:null},calculateParentRadius:function(){var t;t=this.seriesBox(),this.parentNodeRadius=clamp(Math.sqrt(2*this.parentNodeMass/Math.PI)+20,20,t?Math.max(Math.sqrt(Math.pow(t.width,2)+Math.pow(t.height,2))/2+20,20):Math.sqrt(2*this.parentNodeMass/Math.PI)+20),this.parentNode&&(this.parentNode.marker.radius=this.parentNode.radius=this.parentNodeRadius)},drawGraph:function(){if(this.layout&&this.layout.options.splitSeries){var t,e=this.chart,i=this.layout.options.parentNodeOptions.marker,a={fill:i.fillColor||color(this.color).brighten(.4).get(),opacity:i.fillOpacity,stroke:i.lineColor||this.color,"stroke-width":i.lineWidth},o=this.visible?"inherit":"hidden";this.parentNodesGroup||(this.parentNodesGroup=this.plotGroup("parentNodesGroup","parentNode",o,.1,e.seriesGroup),this.group.attr({zIndex:2})),this.calculateParentRadius(),t=merge({x:this.parentNode.plotX-this.parentNodeRadius,y:this.parentNode.plotY-this.parentNodeRadius,width:2*this.parentNodeRadius,height:2*this.parentNodeRadius},a),this.parentNode.graphic||(this.graph=this.parentNode.graphic=e.renderer.symbol(a.symbol).add(this.parentNodesGroup)),this.parentNode.graphic.attr(t)}},createParentNodes:function(){var t,e=this,i=e.chart,a=e.parentNodeLayout,o=e.parentNode,s=e.pointClass;e.parentNodeMass=0,e.points.forEach(function(t){e.parentNodeMass+=Math.PI*Math.pow(t.marker.radius,2)}),e.calculateParentRadius(),a.nodes.forEach(function(i){i.seriesIndex===e.index&&(t=!0)}),a.setArea(0,0,i.plotWidth,i.plotHeight),t||(o||(o=(new s).init(this,{mass:e.parentNodeRadius/2,marker:{radius:e.parentNodeRadius},dataLabels:{inside:!1},dataLabelOnNull:!0,degree:e.parentNodeRadius,isParentNode:!0,seriesIndex:e.index})),e.parentNode&&(o.plotX=e.parentNode.plotX,o.plotY=e.parentNode.plotY),e.parentNode=o,a.addElementsToCollection([e],a.series),a.addElementsToCollection([o],a.nodes))},drawTracker:function(){this.chart.pointer;var t,e=this.parentNode;H.TrackerMixin.drawTrackerPoint.call(this),e&&(t=isArray(e.dataLabels)?e.dataLabels:e.dataLabel?[e.dataLabel]:[],e.graphic&&(e.graphic.element.point=e),t.forEach(function(t){t.div?t.div.point=e:t.element.point=e}))},addSeriesLayout:function(){var t,e=this.options.layoutAlgorithm,i=this.chart.graphLayoutsStorage,a=this.chart.graphLayoutsLookup,o=merge(e,e.parentNodeOptions,{enableSimulation:this.layout.options.enableSimulation});(t=i[e.type+"-series"])||(i[e.type+"-series"]=t=new H.layouts[e.type],t.init(o),a.splice(t.index,0,t)),this.parentNodeLayout=t,this.createParentNodes()},addLayout:function(){var t,e=this.options.layoutAlgorithm,i=this.chart.graphLayoutsStorage,a=this.chart.graphLayoutsLookup,o=this.chart.options.chart;i||(this.chart.graphLayoutsStorage=i={},this.chart.graphLayoutsLookup=a=[]),(t=i[e.type])||(e.enableSimulation=defined(o.forExport)?!o.forExport:e.enableSimulation,i[e.type]=t=new H.layouts[e.type],t.init(e),a.splice(t.index,0,t)),this.layout=t,this.points.forEach(function(t){t.mass=2,t.degree=1,t.collisionNmb=1}),t.setArea(0,0,this.chart.plotWidth,this.chart.plotHeight),t.addElementsToCollection([this],t.series),t.addElementsToCollection(this.points,t.nodes)},deferLayout:function(){var t=this.options.layoutAlgorithm;this.visible&&(this.addLayout(),t.splitSeries&&this.addSeriesLayout())},translate:function(){var t,e,i,a,o=this.chart,s=this.data,r=this.index,n=this.options.useSimulation;for(this.processedXData=this.xData,this.generatePoints(),defined(o.allDataPoints)||(o.allDataPoints=this.accumulateAllPoints(this),this.getPointRadius()),n?i=o.allDataPoints:(i=this.placeBubbles(o.allDataPoints),this.options.draggable=!1),a=0;a<i.length;a++)i[a][3]===r&&(t=s[i[a][4]],e=i[a][2],n||(t.plotX=i[a][0]-o.plotLeft+o.diffX,t.plotY=i[a][1]-o.plotTop+o.diffY),t.marker=extend(t.marker,{radius:e,width:2*e,height:2*e}),t.radius=e);n&&this.deferLayout(),fireEvent(this,"afterTranslate")},checkOverlap:function(t,e){var i=t[0]-e[0],a=t[1]-e[1],o=t[2]+e[2];return Math.sqrt(i*i+a*a)-Math.abs(o)<-.001},positionBubble:function(t,e,i){var a=Math.sqrt,o=Math.asin,s=Math.acos,r=Math.pow,n=Math.abs,p=a(r(t[0]-e[0],2)+r(t[1]-e[1],2)),l=s((r(p,2)+r(i[2]+e[2],2)-r(i[2]+t[2],2))/(2*(i[2]+e[2])*p)),h=o(n(t[0]-e[0])/p),d=(t[1]-e[1]<0?0:Math.PI)+l+h*((t[0]-e[0])*(t[1]-e[1])<0?1:-1),u=Math.cos(d),c=Math.sin(d);return[e[0]+(e[2]+i[2])*c,e[1]-(e[2]+i[2])*u,i[2],i[3],i[4]]},placeBubbles:function(t){var e,i,a,o=this.checkOverlap,s=this.positionBubble,r=[],n=1,p=0,l=0,h=[];if((i=t.sort(function(t,e){return e[2]-t[2]})).length){if(r.push([[0,0,i[0][2],i[0][3],i[0][4]]]),i.length>1)for(r.push([[0,0-i[1][2]-i[0][2],i[1][2],i[1][3],i[1][4]]]),a=2;a<i.length;a++)i[a][2]=i[a][2]||1,o(e=s(r[n][p],r[n-1][l],i[a]),r[n][0])?(r.push([]),l=0,r[n+1].push(s(r[n][p],r[n][0],i[a])),n++,p=0):n>1&&r[n-1][l+1]&&o(e,r[n-1][l+1])?(l++,r[n].push(s(r[n][p],r[n-1][l],i[a])),p++):(p++,r[n].push(e));this.chart.stages=r,this.chart.rawPositions=[].concat.apply([],r),this.resizeRadius(),h=this.chart.rawPositions}return h},resizeRadius:function(){var t,e,i,a,o,s,r,n,p,l=this.chart,h=l.rawPositions,d=Math.min,u=Math.max,c=l.plotLeft,f=l.plotTop,m=l.plotHeight,g=l.plotWidth;for(t=i=Number.POSITIVE_INFINITY,e=a=Number.NEGATIVE_INFINITY,p=0;p<h.length;p++)o=h[p][2],t=d(t,h[p][0]-o),e=u(e,h[p][0]+o),i=d(i,h[p][1]-o),a=u(a,h[p][1]+o);if(r=[(g-c)/(s=[e-t,a-i])[0],(m-f)/s[1]],n=d.apply([],r),Math.abs(n-1)>1e-10){for(p=0;p<h.length;p++)h[p][2]*=n;this.placeBubbles(h)}else l.diffY=m/2+f-i-(a-i)/2,l.diffX=g/2+c-t-(e-t)/2},calculateZExtremes:function(){var t=this.chart,e=this.options.zMin,i=this.options.zMax,a=1/0,o=-1/0;return e&&i?[e,i]:(t.series.forEach(function(t){t.yData.forEach(function(t){defined(t)&&(t>o&&(o=t),t<a&&(a=t))})}),[e=pick(e,a),i=pick(i,o)])},getPointRadius:function(){var t,e,i,a,o,s=this,r=s.chart,n=r.plotWidth,p=r.plotHeight,l=s.options,h=l.useSimulation,d=Math.min(n,p),u={},c=[],f=r.allDataPoints;["minSize","maxSize"].forEach(function(t){var e=parseInt(l[t],10),i=/%$/.test(l[t]);u[t]=i?d*e/100:e*Math.sqrt(f.length)}),r.minRadius=t=u.minSize/Math.sqrt(f.length),r.maxRadius=e=u.maxSize/Math.sqrt(f.length),o=h?s.calculateZExtremes():[t,e],(f||[]).forEach(function(r,n){i=h?clamp(r[2],o[0],o[1]):r[2],0===(a=s.getRadius(o[0],o[1],t,e,i))&&(a=null),f[n][2]=a,c.push(a)}),s.radii=c},redrawHalo:dragNodesMixin.redrawHalo,onMouseDown:dragNodesMixin.onMouseDown,onMouseMove:dragNodesMixin.onMouseMove,onMouseUp:function(t){if(t.fixedPosition&&!t.removed){var e,i=this.layout,a=this.parentNodeLayout;a&&i.options.dragBetweenSeries&&a.nodes.forEach(function(a){t&&t.marker&&a!==t.series.parentNode&&(e=i.getDistXY(t,a),i.vectorLength(e)-a.marker.radius-t.marker.radius<0&&(a.series.addPoint(merge(t.options,{plotX:t.plotX,plotY:t.plotY}),!1),i.removeElementFromCollection(t,i.nodes),t.remove()))}),dragNodesMixin.onMouseUp.apply(this,arguments)}},destroy:function(){this.chart.graphLayoutsLookup&&this.chart.graphLayoutsLookup.forEach(function(t){t.removeElementFromCollection(this,t.series)},this),this.parentNode&&(this.parentNodeLayout.removeElementFromCollection(this.parentNode,this.parentNodeLayout.nodes),this.parentNode.dataLabel&&(this.parentNode.dataLabel=this.parentNode.dataLabel.destroy())),H.Series.prototype.destroy.apply(this,arguments)},alignDataLabel:H.Series.prototype.alignDataLabel},{destroy:function(){return this.series.layout&&this.series.layout.removeElementFromCollection(this,this.series.layout.nodes),Point.prototype.destroy.apply(this,arguments)},firePointEvent:function(t,e,i){var a=this.series.options;if(this.isParentNode&&a.parentNode){var o=a.allowPointSelect;a.allowPointSelect=a.parentNode.allowPointSelect,Point.prototype.firePointEvent.apply(this,arguments),a.allowPointSelect=o}else Point.prototype.firePointEvent.apply(this,arguments)},select:function(t,e){var i=this.series.chart;this.isParentNode?(i.getSelectedPoints=i.getSelectedParentNodes,Point.prototype.select.apply(this,arguments),i.getSelectedPoints=H.Chart.prototype.getSelectedPoints):Point.prototype.select.apply(this,arguments)}}),addEvent(Chart,"beforeRedraw",function(){this.allDataPoints&&delete this.allDataPoints});