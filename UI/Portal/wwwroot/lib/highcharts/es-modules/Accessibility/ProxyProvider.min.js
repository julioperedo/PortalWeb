"use strict";import H from"../Core/Globals.js";const doc=H["doc"];import U from"../Core/Utilities.js";const{attr,css}=U;import CU from"./Utils/ChartUtilities.js";const unhideChartElementFromAT=CU["unhideChartElementFromAT"];import DOMElementProvider from"./Utils/DOMElementProvider.js";import HU from"./Utils/HTMLUtilities.js";const{removeElement,removeChildNodes}=HU;import ProxyElement from"./ProxyElement.js";class ProxyProvider{constructor(r){this.chart=r,this.domElementProvider=new DOMElementProvider,this.groups={},this.groupOrder=[],this.beforeChartProxyPosContainer=this.createProxyPosContainer("before"),this.afterChartProxyPosContainer=this.createProxyPosContainer("after"),this.update()}addProxyElement(r,e,t="button",o){const s=this.groups[r];if(!s)throw new Error("ProxyProvider.addProxyElement: Invalid group key "+r);r="ul"===s.type||"ol"===s.type?"li":void 0,e=new ProxyElement(this.chart,e,t,r,o);return s.proxyContainerElement.appendChild(e.element),s.proxyElements.push(e),e}addGroup(r,e="div",t){var o=this.groups[r];if(o)return o.groupElement;const s=this.domElementProvider.createElement(e);let i;return t&&t.role&&"div"!==e?(i=this.domElementProvider.createElement("div")).appendChild(s):i=s,i.className="highcharts-a11y-proxy-group highcharts-a11y-proxy-group-"+r.replace(/\W/g,"-"),this.groups[r]={proxyContainerElement:s,groupElement:i,type:e,proxyElements:[]},attr(i,t||{}),"ul"===e&&s.setAttribute("role","list"),this.afterChartProxyPosContainer.appendChild(i),this.updateGroupOrder(this.groupOrder),i}updateGroupAttrs(r,e){var t=this.groups[r];if(!t)throw new Error("ProxyProvider.updateGroupAttrs: Invalid group key "+r);attr(t.groupElement,e)}updateGroupOrder(r){if(this.groupOrder=r.slice(),!this.isDOMOrderGroupOrder()){var e=r.indexOf("series");const o=-1<e?r.slice(0,e):r,s=-1<e?r.slice(e+1):[],t=doc.activeElement;["before","after"].forEach(r=>{const e=this["before"===r?"beforeChartProxyPosContainer":"afterChartProxyPosContainer"],t="before"===r?o:s;removeChildNodes(e),t.forEach(r=>{r=this.groups[r];r&&e.appendChild(r.groupElement)})}),(this.beforeChartProxyPosContainer.contains(t)||this.afterChartProxyPosContainer.contains(t))&&t&&t.focus&&t.focus()}}clearGroup(r){var e=this.groups[r];if(!e)throw new Error("ProxyProvider.clearGroup: Invalid group key "+r);removeChildNodes(e.proxyContainerElement)}removeGroup(r){var e=this.groups[r];e&&(removeElement(e.groupElement),delete this.groups[r])}update(){this.updatePosContainerPositions(),this.updateGroupOrder(this.groupOrder),this.updateProxyElementPositions()}updateProxyElementPositions(){Object.keys(this.groups).forEach(this.updateGroupProxyElementPositions.bind(this))}updateGroupProxyElementPositions(r){const e=this.groups[r];e&&e.proxyElements.forEach(r=>r.refreshPosition())}destroy(){this.domElementProvider.destroyCreatedElements()}createProxyPosContainer(r){const e=this.domElementProvider.createElement("div");return e.setAttribute("aria-hidden","false"),e.className="highcharts-a11y-proxy-container"+(r?"-"+r:""),css(e,{top:"0",left:"0"}),this.chart.styledMode||(e.style.whiteSpace="nowrap",e.style.position="absolute"),e}getCurrentGroupOrderInDOM(){const s=r=>{var e=Object.keys(this.groups);let t=e.length;for(;t--;){var o=e[t],s=this.groups[o];if(s&&r===s.groupElement)return o}};var r=r=>{const e=[];var t=r.children;for(let r=0;r<t.length;++r){var o=s(t[r]);o&&e.push(o)}return e};const e=r(this.beforeChartProxyPosContainer);r=r(this.afterChartProxyPosContainer);return e.push("series"),e.concat(r)}isDOMOrderGroupOrder(){var r=this.getCurrentGroupOrderInDOM(),e=this.groupOrder.filter(r=>"series"===r||!!this.groups[r]);let t=r.length;if(t!==e.length)return!1;for(;t--;)if(r[t]!==e[t])return!1;return!0}updatePosContainerPositions(){const r=this.chart;var e;r.renderer.forExport||(e=r.renderer.box,r.container.insertBefore(this.afterChartProxyPosContainer,e.nextSibling),r.container.insertBefore(this.beforeChartProxyPosContainer,e),unhideChartElementFromAT(this.chart,this.afterChartProxyPosContainer),unhideChartElementFromAT(this.chart,this.beforeChartProxyPosContainer))}}export default ProxyProvider;