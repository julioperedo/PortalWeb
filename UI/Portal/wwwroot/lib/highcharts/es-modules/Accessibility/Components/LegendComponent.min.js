"use strict";import A from"../../Core/Animation/AnimationUtilities.js";const animObject=A["animObject"];import H from"../../Core/Globals.js";const doc=H["doc"];import Legend from"../../Core/Legend/Legend.js";import U from"../../Core/Utilities.js";const{addEvent,fireEvent,isNumber,pick,syncTimeout}=U;import AccessibilityComponent from"../AccessibilityComponent.js";import KeyboardNavigationHandler from"../KeyboardNavigationHandler.js";import CU from"../Utils/ChartUtilities.js";const getChartTitle=CU["getChartTitle"];import HU from"../Utils/HTMLUtilities.js";const{stripHTMLTagsFromString:stripHTMLTags,addClass,removeClass}=HU;function scrollLegendToItem(e,t){var t=(e.allItems[t].legendItem||{}).pageIx,i=e.currentPage;void 0!==t&&t+1!==i&&e.scroll(1+t-i)}function shouldDoLegendA11y(e){var t=e.legend&&e.legend.allItems,i=e.options.legend.accessibility||{},e=e.colorAxis&&e.colorAxis.some(e=>!e.dataClasses||!e.dataClasses.length);return!(!t||!t.length||e||!1===i.enabled)}function setLegendItemHoverState(e,t){var i=t.legendItem||{};t.setState(e?"hover":"",!0);for(const r of["group","label","symbol"]){var n=i[r],n=n&&n.element||n;n&&fireEvent(n,e?"mouseover":"mouseout")}}class LegendComponent extends AccessibilityComponent{constructor(){super(...arguments),this.highlightedLegendItemIx=NaN,this.proxyGroup=null}init(){const t=this;this.recreateProxies(),this.addEvent(Legend,"afterScroll",function(){this.chart===t.chart&&(t.proxyProvider.updateGroupProxyElementPositions("legend"),t.updateLegendItemProxyVisibility(),-1<t.highlightedLegendItemIx&&this.chart.highlightLegendItem(t.highlightedLegendItemIx))}),this.addEvent(Legend,"afterPositionItem",function(e){this.chart===t.chart&&this.chart.renderer&&t.updateProxyPositionForItem(e.item)}),this.addEvent(Legend,"afterRender",function(){this.chart===t.chart&&this.chart.renderer&&t.recreateProxies()&&syncTimeout(()=>t.proxyProvider.updateGroupProxyElementPositions("legend"),animObject(pick(this.chart.renderer.globalAnimation,!0)).duration)})}updateLegendItemProxyVisibility(){const o=this.chart,s=o.legend,e=s.allItems||[],a=s.currentPage||1,l=s.clipHeight||0;let d;e.forEach(t=>{if(t.a11yProxyElement){var i,n=s.pages&&s.pages.length;const r=t.a11yProxyElement.element;let e=!1;d=t.legendItem||{},n&&(t=d.pageIx||0,n=d.y||0,i=d.label?Math.round(d.label.getBBox().height):0,e=n+i-s.pages[t]>l||t!==a-1),e?o.styledMode?addClass(r,"highcharts-a11y-invisible"):r.style.visibility="hidden":(removeClass(r,"highcharts-a11y-invisible"),r.style.visibility="")}})}onChartRender(){shouldDoLegendA11y(this.chart)||this.removeProxies()}highlightAdjacentLegendPage(e){const t=this.chart;var i=t.legend,n=(i.currentPage||1)+e,e=i.pages||[];if(0<n&&n<=e.length){let e=0;for(const r of i.allItems)((r.legendItem||{}).pageIx||0)+1===n&&t.highlightLegendItem(e)&&(this.highlightedLegendItemIx=e),++e}}updateProxyPositionForItem(e){e.a11yProxyElement&&e.a11yProxyElement.refreshPosition()}recreateProxies(){var e=doc.activeElement;const t=this.proxyGroup;e=e&&t&&t.contains(e);return this.removeProxies(),!!shouldDoLegendA11y(this.chart)&&(this.addLegendProxyGroup(),this.proxyLegendItems(),this.updateLegendItemProxyVisibility(),this.updateLegendTitle(),e&&this.chart.highlightLegendItem(this.highlightedLegendItemIx),!0)}removeProxies(){this.proxyProvider.removeGroup("legend")}updateLegendTitle(){const e=this.chart;var t=stripHTMLTags((e.legend&&e.legend.options.title&&e.legend.options.title.text||"").replace(/<br ?\/?>/g," "),e.renderer.forExport),t=e.langFormat("accessibility.legend.legendLabel"+(t?"":"NoTitle"),{chart:e,legendTitle:t,chartTitle:getChartTitle(e)});this.proxyProvider.updateGroupAttrs("legend",{"aria-label":t})}addLegendProxyGroup(){var e="all"===this.chart.options.accessibility.landmarkVerbosity?"region":null;this.proxyGroup=this.proxyProvider.addGroup("legend","ul",{"aria-label":"_placeholder_",role:e})}proxyLegendItems(){const t=this,e=(this.chart.legend||{}).allItems||[];let i;e.forEach(e=>{(i=e.legendItem||{}).label&&i.label.element&&t.proxyLegendItem(e)})}proxyLegendItem(e){var t,i,n=e.legendItem||{};n.label&&n.group&&(t=this.chart.langFormat("accessibility.legend.legendItem",{chart:this.chart,itemName:stripHTMLTags(e.name,this.chart.renderer.forExport),item:e}),t={tabindex:-1,"aria-pressed":e.visible,"aria-label":t},i=n.group.div?n.label:n.group,e.a11yProxyElement=this.proxyProvider.addProxyElement("legend",{click:n.label,visual:i.element},"button",t))}getKeyboardNavigation(){const t=this.keyCodes,i=this,e=this.chart;return new KeyboardNavigationHandler(e,{keyCodeMap:[[[t.left,t.right,t.up,t.down],function(e){return i.onKbdArrowKey(this,e)}],[[t.enter,t.space],function(){return i.onKbdClick(this)}],[[t.pageDown,t.pageUp],function(e){e=e===t.pageDown?1:-1;return i.highlightAdjacentLegendPage(e),this.response.success}]],validate:function(){return i.shouldHaveLegendNavigation()},init:function(){e.highlightLegendItem(0),i.highlightedLegendItemIx=0},terminate:function(){i.highlightedLegendItemIx=-1,e.legend.allItems.forEach(e=>setLegendItemHoverState(!1,e))}})}onKbdArrowKey(e,t){const i=this.keyCodes,n=e.response,r=this.chart,o=r.options.accessibility,s=r.legend.allItems.length,a=t===i.left||t===i.up?-1:1;return r.highlightLegendItem(this.highlightedLegendItemIx+a)?this.highlightedLegendItemIx+=a:1<s&&o.keyboardNavigation.wrapAround&&e.init(a),n.success}onKbdClick(e){const t=this.chart.legend.allItems[this.highlightedLegendItemIx];return t&&t.a11yProxyElement&&t.a11yProxyElement.click(),e.response.success}shouldHaveLegendNavigation(){if(!shouldDoLegendA11y(this.chart))return!1;var e=this.chart,t=(e.options.legend||{}).accessibility||{};return!!(e.legend.display&&t.keyboardNavigation&&t.keyboardNavigation.enabled)}destroy(){this.removeProxies()}}!function(e){const n=[];function r(e){var t=this.legend.allItems,i=this.accessibility&&this.accessibility.components.legend.highlightedLegendItemIx,n=t[e],r=n.legendItem||{};return!!n&&(isNumber(i)&&t[i]&&setLegendItemHoverState(!1,t[i]),scrollLegendToItem(this.legend,e),t=r.label,i=n.a11yProxyElement&&n.a11yProxyElement.innerElement,t&&t.element&&i&&this.setFocusToElement(t,i),setLegendItemHoverState(!0,n),!0)}function o(e){const t=this.chart,i=t.options.accessibility,n=e.item;i.enabled&&n&&n.a11yProxyElement&&n.a11yProxyElement.innerElement.setAttribute("aria-pressed",e.visible?"true":"false")}e.compose=function(e,t){if(U.pushUnique(n,e)){const i=e.prototype;i.highlightLegendItem=r}U.pushUnique(n,t)&&addEvent(t,"afterColorizeItem",o)}}(LegendComponent=LegendComponent||{});export default LegendComponent;