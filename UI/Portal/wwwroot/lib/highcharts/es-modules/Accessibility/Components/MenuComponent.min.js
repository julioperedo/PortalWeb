"use strict";import Chart from"../../Core/Chart/Chart.js";import U from"../../Core/Utilities.js";const attr=U["attr"];import AccessibilityComponent from"../AccessibilityComponent.js";import KeyboardNavigationHandler from"../KeyboardNavigationHandler.js";import ChartUtilities from"../Utils/ChartUtilities.js";const{getChartTitle,unhideChartElementFromAT}=ChartUtilities;import HTMLUtilities from"../Utils/HTMLUtilities.js";const getFakeMouseEvent=HTMLUtilities["getFakeMouseEvent"];function getExportMenuButtonElement(t){return t.exportSVGElements&&t.exportSVGElements[0]}function exportingShouldHaveA11y(t){var e=t.options.exporting,t=getExportMenuButtonElement(t);return!!(e&&!1!==e.enabled&&e.accessibility&&e.accessibility.enabled&&t&&t.element)}class MenuComponent extends AccessibilityComponent{init(){const t=this.chart,e=this;this.addEvent(t,"exportMenuShown",function(){e.onMenuShown()}),this.addEvent(t,"exportMenuHidden",function(){e.onMenuHidden()}),this.createProxyGroup()}onMenuHidden(){const t=this.chart.exportContextMenu;t&&t.setAttribute("aria-hidden","true"),this.setExportButtonExpandedState("false")}onMenuShown(){var t=this.chart,e=t.exportContextMenu;e&&(this.addAccessibleContextMenuAttribs(),unhideChartElementFromAT(t,e)),this.setExportButtonExpandedState("true")}setExportButtonExpandedState(t){this.exportButtonProxy&&this.exportButtonProxy.innerElement.setAttribute("aria-expanded",t)}onChartRender(){const t=this.chart,e=t.focusElement,o=t.accessibility;this.proxyProvider.clearGroup("chartMenu"),this.proxyMenuButton(),this.exportButtonProxy&&e&&e===t.exportingGroup&&(e.focusBorder?t.setFocusToElement(e,this.exportButtonProxy.innerElement):o&&o.keyboardNavigation.tabindexContainer.focus())}proxyMenuButton(){const t=this.chart,e=this.proxyProvider;var o=getExportMenuButtonElement(t);exportingShouldHaveA11y(t)&&o&&(this.exportButtonProxy=e.addProxyElement("chartMenu",{click:o},"button",{"aria-label":t.langFormat("accessibility.exporting.menuButtonLabel",{chart:t,chartTitle:getChartTitle(t)}),"aria-expanded":!1,title:t.options.lang.contextButtonTitle||null}))}createProxyGroup(){this.chart&&this.proxyProvider&&this.proxyProvider.addGroup("chartMenu")}addAccessibleContextMenuAttribs(){const t=this.chart,e=t.exportDivElements;var o;e&&e.length&&(e.forEach(t=>{t&&("LI"!==t.tagName||t.children&&t.children.length?t.setAttribute("aria-hidden","true"):t.setAttribute("tabindex",-1))}),(o=e[0]&&e[0].parentNode)&&attr(o,{"aria-hidden":void 0,"aria-label":t.langFormat("accessibility.exporting.chartMenuLabel",{chart:t}),role:"list"}))}getKeyboardNavigation(){const t=this.keyCodes,o=this.chart,n=this;return new KeyboardNavigationHandler(o,{keyCodeMap:[[[t.left,t.up],function(){return n.onKbdPrevious(this)}],[[t.right,t.down],function(){return n.onKbdNext(this)}],[[t.enter,t.space],function(){return n.onKbdClick(this)}]],validate:function(){return!!o.exporting&&!1!==o.options.exporting.enabled&&!1!==o.options.exporting.accessibility.enabled},init:function(){var t=n.exportButtonProxy,e=n.chart.exportingGroup;t&&e&&o.setFocusToElement(e,t.innerElement)},terminate:function(){o.hideExportMenu()}})}onKbdPrevious(t){const e=this.chart;var o=e.options.accessibility,n=t.response;let i=e.highlightedExportItemIx||0;for(;i--;)if(e.highlightExportItem(i))return n.success;return o.keyboardNavigation.wrapAround?(e.highlightLastExportItem(),n.success):n.prev}onKbdNext(t){const e=this.chart;var o=e.options.accessibility,n=t.response;for(let t=(e.highlightedExportItemIx||0)+1;t<e.exportDivElements.length;++t)if(e.highlightExportItem(t))return n.success;return o.keyboardNavigation.wrapAround?(e.highlightExportItem(0),n.success):n.next}onKbdClick(t){const e=this.chart;var o=e.exportDivElements[e.highlightedExportItemIx],n=getExportMenuButtonElement(e).element;return e.openMenu?this.fakeClickEvent(o):(this.fakeClickEvent(n),e.highlightExportItem(0)),t.response.success}}!function(t){const o=[];function n(){var t=getExportMenuButtonElement(this);if(t){const e=t.element;e.onclick&&e.onclick(getFakeMouseEvent("click"))}}function i(){const t=this,e=t.exportDivElements;e&&t.exportContextMenu&&t.openMenu&&(e.forEach(t=>{t&&"highcharts-menu-item"===t.className&&t.onmouseout&&t.onmouseout(getFakeMouseEvent("mouseout"))}),t.highlightedExportItemIx=0,t.exportContextMenu.hideMenu(),t.container.focus())}function r(t){const e=this.exportDivElements&&this.exportDivElements[t],o=this.exportDivElements&&this.exportDivElements[this.highlightedExportItemIx];var n;return!(!e||"LI"!==e.tagName||e.children&&e.children.length)&&(n=!!(this.renderTo.getElementsByTagName("g")[0]||{}).focus,e.focus&&n&&e.focus(),o&&o.onmouseout&&o.onmouseout(getFakeMouseEvent("mouseout")),e.onmouseover&&e.onmouseover(getFakeMouseEvent("mouseover")),this.highlightedExportItemIx=t,!0)}function s(){if(this.exportDivElements){let t=this.exportDivElements.length;for(;t--;)if(this.highlightExportItem(t))return!0}return!1}t.compose=function(t){if(U.pushUnique(o,t)){const e=Chart.prototype;e.hideExportMenu=i,e.highlightExportItem=r,e.highlightLastExportItem=s,e.showExportMenu=n}}}(MenuComponent=MenuComponent||{});export default MenuComponent;