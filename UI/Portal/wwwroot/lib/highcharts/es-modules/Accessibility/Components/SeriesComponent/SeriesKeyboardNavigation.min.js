"use strict";import Point from"../../../Core/Series/Point.js";import Series from"../../../Core/Series/Series.js";import SeriesRegistry from"../../../Core/Series/SeriesRegistry.js";const seriesTypes=SeriesRegistry["seriesTypes"];import H from"../../../Core/Globals.js";const doc=H["doc"];import U from"../../../Core/Utilities.js";const{defined,fireEvent}=U;import KeyboardNavigationHandler from"../../KeyboardNavigationHandler.js";import EventProvider from"../../Utils/EventProvider.js";import ChartUtilities from"../../Utils/ChartUtilities.js";const{getPointFromXY,getSeriesFromName,scrollAxisToPoint}=ChartUtilities;function getPointIndex(i){var t=i.index,e=i.series.points;let n=e.length;if(e[t]===i)return t;for(;n--;)if(e[n]===i)return n}function isSkipSeries(i){var t=i.chart.options.accessibility.keyboardNavigation.seriesNavigation,e=i.options.accessibility||{},n=e.keyboardNavigation;return n&&!1===n.enabled||!1===e.enabled||!1===i.options.enableMouseTracking||!i.visible||t.pointNavigationEnabledThreshold&&+t.pointNavigationEnabledThreshold<=i.points.length}function isSkipPoint(i){var t=i.series.chart.options.accessibility,e=i.options.accessibility&&!1===i.options.accessibility.enabled;return i.isNull&&t.keyboardNavigation.seriesNavigation.skipNullPoints||!1===i.visible||!1===i.isInside||e||isSkipSeries(i.series)}function getFirstValidPointInSeries(i){var t=i.points||[],e=t.length;for(let i=0;i<e;++i)if(!isSkipPoint(t[i]))return t[i];return null}function getFirstValidPointInChart(i){var t=i.series||[],e=t.length;for(let i=0;i<e;++i)if(!isSkipSeries(t[i])){var n=getFirstValidPointInSeries(t[i]);if(n)return n}return null}function highlightLastValidPointInChart(i){let t=i.series.length,e=!1;for(;t--&&(i.highlightedPoint=i.series[t].points[i.series[t].points.length-1],!(e=i.series[t].highlightNextValidPoint())););return e}function updateChartFocusAfterDrilling(i){const t=getFirstValidPointInChart(i);t&&t.highlight(!1)}function highlightFirstValidPointInChart(i){delete i.highlightedPoint;const t=getFirstValidPointInChart(i);return!!t&&t.highlight()}class SeriesKeyboardNavigation{constructor(i,t){this.keyCodes=t,this.chart=i}init(){const e=this,s=this.chart,i=this.eventProvider=new EventProvider;i.addEvent(Series,"destroy",function(){return e.onSeriesDestroy(this)}),i.addEvent(s,"afterApplyDrilldown",function(){updateChartFocusAfterDrilling(this)}),i.addEvent(s,"drilldown",function(i){var i=i.point,t=i.series;e.lastDrilledDownPoint={x:i.x,y:i.y,seriesName:t?t.name:""}}),i.addEvent(s,"drillupall",function(){setTimeout(function(){e.onDrillupAll()},10)}),i.addEvent(Point,"afterSetState",function(){var i=this;const t=i.graphic&&i.graphic.element,e=doc.activeElement,n=e&&e.getAttribute("class");var o=n&&-1<n.indexOf("highcharts-a11y-proxy-element");s.highlightedPoint===i&&e!==t&&!o&&t&&t.focus&&t.focus()})}onDrillupAll(){const i=this.lastDrilledDownPoint,t=this.chart,e=i&&getSeriesFromName(t,i.seriesName);let n;n=(n=i&&e&&defined(i.x)&&defined(i.y)?getPointFromXY(e,i.x,i.y):n)||getFirstValidPointInChart(t),t.container&&t.container.focus(),n&&n.highlight&&n.highlight(!1)}getKeyboardNavigationHandler(){const t=this,e=this.keyCodes,n=this.chart,i=n.inverted;return new KeyboardNavigationHandler(n,{keyCodeMap:[[i?[e.up,e.down]:[e.left,e.right],function(i){return t.onKbdSideways(this,i)}],[i?[e.left,e.right]:[e.up,e.down],function(i){return t.onKbdVertical(this,i)}],[[e.enter,e.space],function(i,t){const e=n.highlightedPoint;return e&&(t.point=e,fireEvent(e.series,"click",t),e.firePointEvent("click")),this.response.success}],[[e.home],function(){return highlightFirstValidPointInChart(n),this.response.success}],[[e.end],function(){return highlightLastValidPointInChart(n),this.response.success}],[[e.pageDown,e.pageUp],function(i){return n.highlightAdjacentSeries(i===e.pageDown),this.response.success}]],init:function(){return t.onHandlerInit(this)},validate:function(){return!!getFirstValidPointInChart(n)},terminate:function(){return t.onHandlerTerminate()}})}onKbdSideways(i,t){var e=this.keyCodes,t=t===e.right||t===e.down;return this.attemptHighlightAdjacentPoint(i,t)}onHandlerInit(i){const t=this.chart,e=t.options.accessibility.keyboardNavigation;return e.seriesNavigation.rememberPointFocus&&t.highlightedPoint?t.highlightedPoint.highlight():highlightFirstValidPointInChart(t),i.response.success}onKbdVertical(i,t){const e=this.chart,n=this.keyCodes,o=t===n.down||t===n.right,s=e.options.accessibility.keyboardNavigation.seriesNavigation;if(s.mode&&"serialize"===s.mode)return this.attemptHighlightAdjacentPoint(i,o);t=e.highlightedPoint&&e.highlightedPoint.series.keyboardMoveVertical?"highlightAdjacentPointVertical":"highlightAdjacentSeries";return e[t](o),i.response.success}onHandlerTerminate(){const i=this.chart,t=i.options.accessibility.keyboardNavigation,e=(i.tooltip&&i.tooltip.hide(0),i.highlightedPoint&&i.highlightedPoint.series);e&&e.onMouseOut&&e.onMouseOut(),i.highlightedPoint&&i.highlightedPoint.onMouseOut&&i.highlightedPoint.onMouseOut(),t.seriesNavigation.rememberPointFocus||delete i.highlightedPoint}attemptHighlightAdjacentPoint(i,t){const e=this.chart,n=e.options.accessibility.keyboardNavigation.wrapAround,o=e.highlightAdjacentPoint(t);return o||n&&(t?highlightFirstValidPointInChart:highlightLastValidPointInChart)(e)?i.response.success:i.response[t?"next":"prev"]}onSeriesDestroy(i){const t=this.chart,e=t.highlightedPoint&&t.highlightedPoint.series===i;e&&(delete t.highlightedPoint,t.focusElement&&t.focusElement.removeFocusBorder())}destroy(){this.eventProvider.removeAddedEvents()}}!function(i){const r=[];function h(i){var t=this,e=t.series,n=t.highlightedPoint,o=n&&getPointIndex(n)||0,s=n&&n.series.points||[],r=t.series&&t.series[t.series.length-1],r=r&&r.points&&r.points[r.points.length-1];let h,l;if(!e[0]||!e[0].points)return!1;if(n){if(h=e[n.series.index+(i?1:-1)],!(l=!(l=s[o+(i?1:-1)])&&h?h.points[i?0:h.points.length-1]:l))return!1}else l=i?e[0].points[0]:r;return isSkipPoint(l)?(isSkipSeries(h=l.series)?t.highlightedPoint=i?h.points[h.points.length-1]:h.points[0]:t.highlightedPoint=l,t.highlightAdjacentPoint(i)):l.highlight()}function l(o){const s=this.highlightedPoint;let r=1/0,h;return!(!defined(s.plotX)||!defined(s.plotY))&&(this.series.forEach(n=>{isSkipSeries(n)||n.points.forEach(t=>{if(defined(t.plotY)&&defined(t.plotX)&&t!==s){let i=t.plotY-s.plotY;var e=Math.abs(t.plotX-s.plotX),e=Math.abs(i)*Math.abs(i)+e*e*4;n.yAxis&&n.yAxis.reversed&&(i*=-1),i<=0&&o||0<=i&&!o||e<5||isSkipPoint(t)||e<r&&(r=e,h=t)}})}),!!h&&h.highlight())}function a(i){const t=this,e=t.highlightedPoint,n=t.series&&t.series[t.series.length-1],o=n&&n.points&&n.points[n.points.length-1];let s,r,h;return t.highlightedPoint?!!(s=t.series[e.series.index+(i?-1:1)])&&(!!(r=function(i,t,e,n){let o=1/0,s,r,h,l=t.points.length;var a=i=>!(defined(i.plotX)&&defined(i.plotY));if(!a(i)){for(;l--;)s=t.points[l],a(s)||(h=(i.plotX-s.plotX)*(i.plotX-s.plotX)*(e||1)+(i.plotY-s.plotY)*(i.plotY-s.plotY)*(n||1))<o&&(o=h,r=l);return defined(r)?t.points[r]:void 0}}(e,s,4))&&(isSkipSeries(s)?(r.highlight(),(h=t.highlightAdjacentSeries(i))?h:(e.highlight(),!1)):(r.highlight(),r.series.highlightNextValidPoint()))):(s=i?t.series&&t.series[0]:n,!!(r=i?s&&s.points&&s.points[0]:o)&&r.highlight())}function g(i=!0){const t=this.series.chart,e=t.tooltip?.label?.element;!this.isNull&&i?this.onMouseOver():t.tooltip&&t.tooltip.hide(0),scrollAxisToPoint(this),this.graphic&&(t.setFocusToElement(this.graphic),!i&&t.focusElement&&t.focusElement.removeFocusBorder()),t.highlightedPoint=this;var n,i=e?.getBoundingClientRect().top;return e&&i&&i<0&&(n=window.scrollY,window.scrollTo({behavior:"smooth",top:n+i})),this}function d(){const i=this.chart.highlightedPoint,t=(i&&i.series)===this?getPointIndex(i):0,e=this.points,n=e.length;if(e&&n){for(let i=t;i<n;++i)if(!isSkipPoint(e[i]))return e[i].highlight();for(let i=t;0<=i;--i)if(!isSkipPoint(e[i]))return e[i].highlight()}return!1}i.compose=function(i,t,e){if(U.pushUnique(r,i)){const n=i.prototype;n.highlightAdjacentPoint=h,n.highlightAdjacentPointVertical=l,n.highlightAdjacentSeries=a}if(U.pushUnique(r,t)){const o=t.prototype;o.highlight=g}if(U.pushUnique(r,e)){const s=e.prototype;s.keyboardMoveVertical=!0,["column","gantt","pie"].forEach(i=>{seriesTypes[i]&&(seriesTypes[i].prototype.keyboardMoveVertical=!1)}),s.highlightNextValidPoint=d}}}(SeriesKeyboardNavigation=SeriesKeyboardNavigation||{});export default SeriesKeyboardNavigation;