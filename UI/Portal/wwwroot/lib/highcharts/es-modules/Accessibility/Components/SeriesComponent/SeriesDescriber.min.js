"use strict";import AnnotationsA11y from"../AnnotationsA11y.js";const getPointAnnotationTexts=AnnotationsA11y["getPointAnnotationTexts"];import ChartUtilities from"../../Utils/ChartUtilities.js";const{getAxisDescription,getSeriesFirstPointElement,getSeriesA11yElement,unhideChartElementFromAT}=ChartUtilities;import F from"../../../Core/Templating.js";const{format,numberFormat}=F;import HTMLUtilities from"../../Utils/HTMLUtilities.js";const{reverseChildNodes,stripHTMLTagsFromString:stripHTMLTags}=HTMLUtilities;import U from"../../../Core/Utilities.js";const{find,isNumber,isString,pick,defined}=U;function findFirstPointWithGraphic(i){const t=i.index;return i.series&&i.series.data&&defined(t)&&find(i.series.data,function(i){return!!(i&&void 0!==i.index&&i.index>t&&i.graphic&&i.graphic.element)})||null}function shouldAddMockPoint(i){const t=i.series,e=t&&t.chart,s=t&&t.is("sunburst"),r=i.isNull,o=e&&e.options.accessibility.point.describeNull;return r&&!s&&o}function makeMockElement(i,t){const e=i.series.chart.renderer,s=e.rect(t.x,t.y,1,1);return s.attr({class:"highcharts-a11y-mock-point",fill:"none",opacity:0,"fill-opacity":0,"stroke-opacity":0}),s}function addMockPointElement(i){const t=i.series,e=findFirstPointWithGraphic(i),s=e&&e.graphic,r=s?s.parentGroup:t.graph||t.group,o=e?{x:pick(i.plotX,e.plotX,0),y:pick(i.plotY,e.plotY,0)}:{x:pick(i.plotX,0),y:pick(i.plotY,0)},n=makeMockElement(i,o);if(r&&r.element)return i.graphic=n,i.hasMockGraphic=!0,n.add(r),r.element.insertBefore(n.element,s?s.element:null),n.element}function hasMorePointsThanDescriptionThreshold(i){var t=i.chart.options.accessibility.series.pointDescriptionEnabledThreshold;return!!(!1!==t&&i.points&&i.points.length>=+t)}function shouldSetScreenReaderPropsOnPoints(i){var t=i.options.accessibility||{};return!hasMorePointsThanDescriptionThreshold(i)&&!t.exposeAsGroupOnly}function shouldSetKeyboardNavPropsOnPoints(i){var t=i.chart.options.accessibility.keyboardNavigation.seriesNavigation;return!(!i.points||!(i.points.length<+t.pointNavigationEnabledThreshold||!1===t.pointNavigationEnabledThreshold))}function shouldDescribeSeriesElement(i){var t=i.chart,e=t.options.chart,e=e.options3d&&e.options3d.enabled,s=1<t.series.length,t=t.options.accessibility.series.describeSingleSeries,r=(i.options.accessibility||{}).exposeAsGroupOnly;return!(e&&s)&&(s||t||r||hasMorePointsThanDescriptionThreshold(i))}function pointNumberToString(i,t){var i=i.series,e=i.chart,s=e.options.accessibility.point||{},r=i.options.accessibility&&i.options.accessibility.point||{},i=i.tooltipOptions||{},e=e.options.lang;return isNumber(t)?numberFormat(t,r.valueDecimals||s.valueDecimals||i.valueDecimals||-1,e.decimalPoint,e.accessibility.thousandsSep||e.thousandsSep):t}function getSeriesDescriptionText(i){var t=(i.options.accessibility||{}).description;return t&&i.chart.langFormat("accessibility.series.description",{description:t,series:i})||""}function getSeriesAxisDescriptionText(i,t){var e=i[t];return i.chart.langFormat("accessibility.series."+t+"Description",{name:getAxisDescription(e),series:i})}function getPointA11yTimeDescription(i){const t=i.series,e=t.chart,s=t.options.accessibility&&t.options.accessibility.point||{},r=e.options.accessibility.point||{},o=t.xAxis&&t.xAxis.dateTime;var n;if(o)return n=o.getXDateFormat(i.x||0,e.options.tooltip.dateTimeLabelFormats),n=s.dateFormatter&&s.dateFormatter(i)||r.dateFormatter&&r.dateFormatter(i)||s.dateFormat||r.dateFormat||n,e.time.dateFormat(n,i.x||0,void 0)}function getPointXDescription(i){var t=getPointA11yTimeDescription(i),e=(i.series.xAxis||{}).categories&&defined(i.category)&&(""+i.category).replace("<br/>"," "),s=defined(i.id)&&(""+i.id).indexOf("highcharts-")<0,r="x, "+i.x;return i.name||t||e||(s?i.id:r)}function getPointArrayMapValueDescription(s,i,t){const r=i||"",o=t||"",e=s.series.pointArrayMap;return e.reduce(function(i,t){t=t;var e,t=void 0!==(e=pointNumberToString(s,pick(s[t],s.options[t])))?t+": "+r+e+o:e;return t?i+(i.length?", ":"")+t:i},"")}function getPointValue(i){const t=i.series,e=t.chart.options.accessibility.point||{},s=t.chart.options.accessibility&&t.chart.options.accessibility.point||{},r=t.tooltipOptions||{},o=s.valuePrefix||e.valuePrefix||r.valuePrefix||"",n=s.valueSuffix||e.valueSuffix||r.valueSuffix||"",a=void 0!==i.value?"value":"y",c=pointNumberToString(i,i[a]);return i.isNull?t.chart.langFormat("accessibility.series.nullPointValue",{point:i}):t.pointArrayMap?getPointArrayMapValueDescription(i,o,n):o+c+n}function getPointAnnotationDescription(i){const t=i.series.chart;var e=getPointAnnotationTexts(i);return e.length?t.langFormat("accessibility.series.pointAnnotationsDescription",{point:i,annotations:e}):""}function getPointValueDescription(i){var t=i.series,e=t.chart,s=t.options.accessibility,s=s&&s.point&&s.point.valueDescriptionFormat||e.options.accessibility.point.valueDescriptionFormat,t=pick(t.xAxis&&t.xAxis.options.accessibility&&t.xAxis.options.accessibility.enabled,!e.angular&&"flowmap"!==t.type),r=t?getPointXDescription(i):"",r={point:i,index:defined(i.index)?i.index+1:"",xDescription:r,value:getPointValue(i),separator:t?", ":""};return format(s,r,e)}function defaultPointDescriptionFormatter(i){var t=i.series,e=1<t.chart.series.length||t.options.name,s=getPointValueDescription(i),r=i.options&&i.options.accessibility&&i.options.accessibility.description,r=r?" "+r:"",e=e?" "+t.name+".":"",t=getPointAnnotationDescription(i),t=t?" "+t:"";return i.accessibility=i.accessibility||{},(i.accessibility.valueDescription=s)+r+e+t}function setPointScreenReaderAttribs(i,t){const e=i.series,s=e.options.accessibility?.point||{},r=e.chart.options.accessibility.point||{},o=stripHTMLTags(isString(s.descriptionFormat)&&format(s.descriptionFormat,i,e.chart)||s.descriptionFormatter?.(i)||isString(r.descriptionFormat)&&format(r.descriptionFormat,i,e.chart)||r.descriptionFormatter?.(i)||defaultPointDescriptionFormatter(i),e.chart.renderer.forExport);t.setAttribute("role","img"),t.setAttribute("aria-label",o)}function describePointsInSeries(s){const r=shouldSetScreenReaderPropsOnPoints(s),i=shouldSetKeyboardNavPropsOnPoints(s),o=s.chart.options.accessibility.point.describeNull;(r||i)&&s.points.forEach(i=>{const t=i.graphic&&i.graphic.element||shouldAddMockPoint(i)&&addMockPointElement(i),e=i.options&&i.options.accessibility&&!1===i.options.accessibility.enabled;t&&(i.isNull&&!o?t.setAttribute("aria-hidden",!0):(t.setAttribute("tabindex","-1"),s.chart.styledMode||(t.style.outline="none"),r&&!e?setPointScreenReaderAttribs(i,t):t.setAttribute("aria-hidden",!0)))})}function defaultSeriesDescriptionFormatter(t){function i(i){return e[i]&&1<e[i].length&&t[i]}const e=t.chart,s=e.types||[],r=getSeriesDescriptionText(t),o=t.index+1,n=getSeriesAxisDescriptionText(t,"xAxis"),a=getSeriesAxisDescriptionText(t,"yAxis"),c={seriesNumber:o,series:t,chart:e},l=1<s.length?"Combination":"",p=e.langFormat("accessibility.series.summary."+t.type+l,c)||e.langFormat("accessibility.series.summary.default"+l,c),d=(i("yAxis")?" "+a+".":"")+(i("xAxis")?" "+n+".":""),u=pick(t.options.accessibility&&t.options.accessibility.descriptionFormat,e.options.accessibility.series.descriptionFormat,"");return format(u,{seriesDescription:p,authorDescription:r?" "+r:"",axisDescription:d,series:t,chart:e,seriesNumber:o},void 0)}function describeSeriesElement(i,t){const e=i.options.accessibility||{},s=i.chart.options.accessibility,r=s.landmarkVerbosity;e.exposeAsGroupOnly?t.setAttribute("role","img"):"all"===r?t.setAttribute("role","region"):t.setAttribute("role","group"),t.setAttribute("tabindex","-1"),i.chart.styledMode||(t.style.outline="none"),t.setAttribute("aria-label",stripHTMLTags(s.series.descriptionFormatter&&s.series.descriptionFormatter(i)||defaultSeriesDescriptionFormatter(i),i.chart.renderer.forExport))}function describeSeries(i){const t=i.chart,e=getSeriesFirstPointElement(i),s=getSeriesA11yElement(i),r=t.is3d&&t.is3d();s&&(s.lastChild!==e||r||reverseChildNodes(s),describePointsInSeries(i),unhideChartElementFromAT(t,s),shouldDescribeSeriesElement(i)?describeSeriesElement(i,s):s.removeAttribute("aria-label"))}const SeriesDescriber={defaultPointDescriptionFormatter:defaultPointDescriptionFormatter,defaultSeriesDescriptionFormatter:defaultSeriesDescriptionFormatter,describeSeries:describeSeries};export default SeriesDescriber;