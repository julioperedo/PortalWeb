"use strict";import A11yI18n from"../A11yI18n.js";import AccessibilityComponent from"../AccessibilityComponent.js";import Announcer from"../Utils/Announcer.js";import AnnotationsA11y from"./AnnotationsA11y.js";const getAnnotationsInfoHTML=AnnotationsA11y["getAnnotationsInfoHTML"];import AST from"../../Core/Renderer/HTML/AST.js";import CU from"../Utils/ChartUtilities.js";const{getAxisDescription,getAxisRangeDescription,getChartTitle,unhideChartElementFromAT}=CU;import F from"../../Core/Templating.js";const format=F["format"];import H from"../../Core/Globals.js";const doc=H["doc"];import HU from"../Utils/HTMLUtilities.js";const{addClass,getElement,getHeadingTagNameForElement,stripHTMLTagsFromString,visuallyHideElement}=HU;import U from"../../Core/Utilities.js";const{attr,pick}=U;function getTableSummary(t){return t.langFormat("accessibility.table.tableSummary",{chart:t})}function getTypeDescForMapChart(t,e){return e.mapTitle?t.langFormat("accessibility.chartTypes.mapTypeDescription",e):t.langFormat("accessibility.chartTypes.unknownMap",e)}function getTypeDescForCombinationChart(t,e){return t.langFormat("accessibility.chartTypes.combinationChart",e)}function getTypeDescForEmptyChart(t,e){return t.langFormat("accessibility.chartTypes.emptyChart",e)}function buildTypeDescriptionFromSeries(t,e,i){var e=e[0],n=t.langFormat("accessibility.seriesTypeDescriptions."+e,i),r=t.series&&t.series.length<2?"Single":"Multiple";return(t.langFormat("accessibility.chartTypes."+e+r,i)||t.langFormat("accessibility.chartTypes.default"+r,i))+(n?" "+n:"")}function getTypeDescription(t,e){var i=e[0],n=t.series&&t.series[0]||{},r=t.mapView&&t.mapView.geoMap&&t.mapView.geoMap.title,n={numSeries:t.series.length,numPoints:n.points&&n.points.length,chart:t,mapTitle:r};return i?"map"===i||"tiledwebmap"===i?getTypeDescForMapChart(t,n):1<t.types.length?getTypeDescForCombinationChart(t,n):buildTypeDescriptionFromSeries(t,e,n):getTypeDescForEmptyChart(t,n)}function stripEmptyHTMLTags(t){return t.replace(/<(\w+)[^>]*?>\s*<\/\1>/g,"")}class InfoRegionsComponent extends AccessibilityComponent{constructor(){super(...arguments),this.announcer=void 0,this.screenReaderSections={}}init(){var t=this.chart;const e=this;this.initRegionsDefinitions(),this.addEvent(t,"aftergetTableAST",function(t){e.onDataTableCreated(t)}),this.addEvent(t,"afterViewData",function(t){t.wasHidden&&(e.dataTableDiv=t.element,setTimeout(function(){e.focusDataTable()},300))}),this.addEvent(t,"afterHideData",function(){e.viewDataTableButton&&e.viewDataTableButton.setAttribute("aria-expanded","false")}),this.announcer=new Announcer(t,"assertive")}initRegionsDefinitions(){const i=this,n=this.chart.options.accessibility;this.screenReaderSections={before:{element:null,buildContent:function(t){const e=n.screenReaderSection.beforeChartFormatter;return e?e(t):i.defaultBeforeChartFormatter(t)},insertIntoDOM:function(t,e){e.renderTo.insertBefore(t,e.renderTo.firstChild)},afterInserted:function(){void 0!==i.sonifyButtonId&&i.initSonifyButton(i.sonifyButtonId),void 0!==i.dataTableButtonId&&i.initDataTableButton(i.dataTableButtonId)}},after:{element:null,buildContent:function(t){const e=n.screenReaderSection.afterChartFormatter;return e?e(t):i.defaultAfterChartFormatter()},insertIntoDOM:function(t,e){e.renderTo.insertBefore(t,e.container.nextSibling)},afterInserted:function(){i.chart.accessibility&&n.keyboardNavigation.enabled&&i.chart.accessibility.keyboardNavigation.updateExitAnchor()}}}}onChartRender(){const e=this;this.linkedDescriptionElement=this.getLinkedDescriptionElement(),this.setLinkedDescriptionAttrs(),Object.keys(this.screenReaderSections).forEach(function(t){e.updateScreenReaderSection(t)})}getLinkedDescriptionElement(){var t=this.chart.options.accessibility.linkedDescription;if(t){if("string"!=typeof t)return t;t=format(t,this.chart),t=doc.querySelectorAll(t);return 1===t.length?t[0]:void 0}}setLinkedDescriptionAttrs(){const t=this.linkedDescriptionElement;t&&(t.setAttribute("aria-hidden","true"),addClass(t,"highcharts-linked-description"))}updateScreenReaderSection(t){var e=this.chart;const i=this.screenReaderSections[t];var n=i.buildContent(e);const r=i.element=i.element||this.createElement("div");var a=r.firstChild||this.createElement("div");n?(this.setScreenReaderSectionAttribs(r,t),AST.setElementHTML(a,n),r.appendChild(a),i.insertIntoDOM(r,e),e.styledMode?addClass(a,"highcharts-visually-hidden"):visuallyHideElement(a),unhideChartElementFromAT(e,a),i.afterInserted&&i.afterInserted()):(r.parentNode&&r.parentNode.removeChild(r),i.element=null)}setScreenReaderSectionAttribs(t,e){const i=this.chart,n=i.langFormat("accessibility.screenReaderSection."+e+"RegionLabel",{chart:i,chartTitle:getChartTitle(i)}),r=`highcharts-screen-reader-region-${e}-`+i.index;attr(t,{id:r,"aria-label":n||void 0}),t.style.position="relative",n&&t.setAttribute("role","all"===i.options.accessibility.landmarkVerbosity?"region":"group")}defaultBeforeChartFormatter(){const t=this.chart,e=t.options.accessibility.screenReaderSection.beforeChartFormat;if(!e)return"";var i=this.getAxesDescription(),n=t.sonify&&t.options.sonification&&t.options.sonification.enabled,r="highcharts-a11y-sonify-data-btn-"+t.index,a="hc-linkto-highcharts-data-table-"+t.index,s=getAnnotationsInfoHTML(t),o=t.langFormat("accessibility.screenReaderSection.annotations.heading",{chart:t}),i={headingTagName:getHeadingTagNameForElement(t.renderTo),chartTitle:getChartTitle(t),typeDescription:this.getTypeDescriptionText(),chartSubtitle:this.getSubtitleText(),chartLongdesc:this.getLongdescText(),xAxisDescription:i.xAxis,yAxisDescription:i.yAxis,playAsSoundButton:n?this.getSonifyButtonText(r):"",viewTableButton:t.getCSV?this.getDataTableButtonText(a):"",annotationsTitle:s?o:"",annotationsList:s},n=A11yI18n.i18nFormat(e,i,t);return this.dataTableButtonId=a,this.sonifyButtonId=r,stripEmptyHTMLTags(n)}defaultAfterChartFormatter(){var t=this.chart,e=t.options.accessibility.screenReaderSection.afterChartFormat;if(!e)return"";var i={endOfChartMarker:this.getEndOfChartMarkerText()};return stripEmptyHTMLTags(A11yI18n.i18nFormat(e,i,t))}getLinkedDescription(){var t=this.linkedDescriptionElement,t=t&&t.innerHTML||"";return stripHTMLTagsFromString(t,this.chart.renderer.forExport)}getLongdescText(){var t=this.chart.options,e=t.caption,e=e&&e.text,i=this.getLinkedDescription();return t.accessibility.description||i||e||""}getTypeDescriptionText(){var t=this.chart;return t.types?t.options.accessibility.typeDescription||getTypeDescription(t,t.types):""}getDataTableButtonText(t){const e=this.chart,i=e.langFormat("accessibility.table.viewAsDataTableButtonText",{chart:e,chartTitle:getChartTitle(e)});return'<button id="'+t+'">'+i+"</button>"}getSonifyButtonText(t){const e=this.chart;return e.options.sonification&&!1===e.options.sonification.enabled?"":'<button id="'+t+'">'+e.langFormat("accessibility.sonification.playAsSoundButtonText",{chart:e,chartTitle:getChartTitle(e)})+"</button>"}getSubtitleText(){var t=this.chart.options.subtitle;return stripHTMLTagsFromString(t&&t.text||"",this.chart.renderer.forExport)}getEndOfChartMarkerText(){const t=this.chart,e=t.langFormat("accessibility.screenReaderSection.endOfChartMarker",{chart:t}),i="highcharts-end-of-chart-marker-"+t.index;return'<div id="'+i+'">'+e+"</div>"}onDataTableCreated(t){var e=this.chart;if(e.options.accessibility.enabled){this.viewDataTableButton&&this.viewDataTableButton.setAttribute("aria-expanded","true");const i=t.tree.attributes||{};i.tabindex=-1,i.summary=getTableSummary(e),t.tree.attributes=i}}focusDataTable(){const t=this.dataTableDiv,e=t&&t.getElementsByTagName("table")[0];e&&e.focus&&e.focus()}initSonifyButton(t){const e=this.sonifyButton=getElement(t),i=this.chart,n=t=>{e&&(e.setAttribute("aria-hidden","true"),e.setAttribute("aria-label","")),t.preventDefault(),t.stopPropagation();t=i.langFormat("accessibility.sonification.playAsSoundClickAnnouncement",{chart:i});this.announcer.announce(t),setTimeout(()=>{e&&(e.removeAttribute("aria-hidden"),e.removeAttribute("aria-label")),i.sonify&&i.sonify()},1e3)};e&&i&&(e.setAttribute("tabindex",-1),e.onclick=function(t){const e=i.options.accessibility&&i.options.accessibility.screenReaderSection.onPlayAsSoundClick;(e||n).call(this,t,i)})}initDataTableButton(t){const e=this.viewDataTableButton=getElement(t),i=this.chart,n=t.replace("hc-linkto-","");e&&(attr(e,{tabindex:-1,"aria-expanded":!!getElement(n)}),e.onclick=i.options.accessibility.screenReaderSection.onViewDataTableClick||function(){i.viewData()})}getAxesDescription(){function t(t,e){return 1<(t=i[t]).length||t[0]&&pick(t[0].options.accessibility&&t[0].options.accessibility.enabled,e)}const i=this.chart,e=!!i.types&&i.types.indexOf("map")<0&&i.types.indexOf("treemap")<0&&i.types.indexOf("tilemap")<0,n=!!i.hasCartesianSeries,r=t("xAxis",!i.angular&&n&&e),a=t("yAxis",n&&e),s={};return r&&(s.xAxis=this.getAxisDescriptionText("xAxis")),a&&(s.yAxis=this.getAxisDescriptionText("yAxis")),s}getAxisDescriptionText(t){const e=this.chart,i=e[t];return e.langFormat("accessibility.axis."+t+"Description"+(1<i.length?"Plural":"Singular"),{chart:e,names:i.map(function(t){return getAxisDescription(t)}),ranges:i.map(function(t){return getAxisRangeDescription(t)}),numAxes:i.length})}destroy(){this.announcer&&this.announcer.destroy()}}export default InfoRegionsComponent;