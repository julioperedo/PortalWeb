"use strict";import H from"../Core/Globals.js";const{doc,win}=H;import MenuComponent from"./Components/MenuComponent.js";import U from"../Core/Utilities.js";const{addEvent,fireEvent}=U;import EventProvider from"./Utils/EventProvider.js";import HTMLUtilities from"./Utils/HTMLUtilities.js";const{getElement,simulatedEventTarget}=HTMLUtilities;class KeyboardNavigation{constructor(t,e){this.chart=void 0,this.components=void 0,this.currentModuleIx=NaN,this.eventProvider=void 0,this.exitAnchor=void 0,this.modules=[],this.tabindexContainer=void 0,this.init(t,e)}init(e,t){const i=this.eventProvider=new EventProvider;this.chart=e,this.components=t,this.modules=[],this.currentModuleIx=0,this.update(),i.addEvent(this.tabindexContainer,"keydown",t=>this.onKeydown(t)),i.addEvent(this.tabindexContainer,"focus",t=>this.onFocus(t)),["mouseup","touchend"].forEach(t=>i.addEvent(doc,t,t=>this.onMouseUp(t))),["mousedown","touchstart"].forEach(t=>i.addEvent(e.renderTo,t,()=>{this.isClickingChart=!0}))}update(t){const e=this.chart.options.accessibility,i=e&&e.keyboardNavigation,n=this.components;this.updateContainerTabindex(),i&&i.enabled&&t&&t.length?(this.modules=t.reduce(function(t,e){e=n[e].getKeyboardNavigation();return t.concat(e)},[]),this.updateExitAnchor()):(this.modules=[],this.currentModuleIx=0,this.removeExitAnchor())}updateExitAnchor(){var t="highcharts-end-of-chart-marker-"+this.chart.index,t=getElement(t);this.removeExitAnchor(),t?(this.makeElementAnExitAnchor(t),this.exitAnchor=t):this.createExitAnchor()}move(t){const e=this.modules&&this.modules[this.currentModuleIx],i=(e&&e.terminate&&e.terminate(t),this.chart.focusElement&&this.chart.focusElement.removeFocusBorder(),this.currentModuleIx+=t,this.modules&&this.modules[this.currentModuleIx]);if(i){if(i.validate&&!i.validate())return this.move(t);if(i.init)return i.init(t),!0}return this.currentModuleIx=0,this.exiting=!0,0<t?this.exitAnchor&&this.exitAnchor.focus():this.tabindexContainer.focus(),!1}onFocus(t){const e=this.chart,i=t.relatedTarget&&e.container.contains(t.relatedTarget),n=e.options.accessibility,o=n&&n.keyboardNavigation,s=o&&o.enabled;!s||this.exiting||this.tabbingInBackwards||this.isClickingChart||i||null!==(t=this.getFirstValidModuleIx())&&(this.currentModuleIx=t,this.modules[t].init(1)),this.exiting=!1}onMouseUp(t){if(delete this.isClickingChart,!this.keyboardReset&&t.relatedTarget!==simulatedEventTarget){const e=this.chart;if(!t.target||!e.container.contains(t.target)){const i=this.modules&&this.modules[this.currentModuleIx||0];i&&i.terminate&&i.terminate(),this.currentModuleIx=0}e.focusElement&&(e.focusElement.removeFocusBorder(),delete e.focusElement),this.keyboardReset=!0}}onKeydown(t){const e=t||win.event,i=this.modules&&this.modules.length&&this.modules[this.currentModuleIx];let n;const o=e.target;o&&"INPUT"===o.nodeName&&!o.classList.contains("highcharts-a11y-proxy-element")||(this.keyboardReset=!1,this.exiting=!1,i&&((t=i.run(e))===i.response.success?n=!0:t===i.response.prev?n=this.move(-1):t===i.response.next&&(n=this.move(1)),n&&(e.preventDefault(),e.stopPropagation())))}updateContainerTabindex(){const t=this.chart.options.accessibility,e=t&&t.keyboardNavigation,i=!(e&&!1===e.enabled),n=this.chart,o=n.container;let s;s=n.renderTo.hasAttribute("tabindex")?(o.removeAttribute("tabindex"),n.renderTo):o;var r=(this.tabindexContainer=s).getAttribute("tabindex");i&&!r?s.setAttribute("tabindex","0"):i||n.container.removeAttribute("tabindex")}createExitAnchor(){const t=this.chart,e=this.exitAnchor=doc.createElement("div");t.renderTo.appendChild(e),this.makeElementAnExitAnchor(e)}makeElementAnExitAnchor(t){var e=this.tabindexContainer.getAttribute("tabindex")||0;t.setAttribute("class","highcharts-exit-anchor"),t.setAttribute("tabindex",e),t.setAttribute("aria-hidden",!1),this.addExitAnchorEventsToEl(t)}removeExitAnchor(){this.exitAnchor&&this.exitAnchor.parentNode&&(this.exitAnchor.parentNode.removeChild(this.exitAnchor),delete this.exitAnchor)}addExitAnchorEventsToEl(t){const s=this.chart,r=this;this.eventProvider.addEvent(t,"focus",function(t){const e=t||win.event,i=e.relatedTarget&&s.container.contains(e.relatedTarget),n=!(i||r.exiting);if(s.focusElement&&delete s.focusElement,n){if(r.tabbingInBackwards=!0,r.tabindexContainer.focus(),delete r.tabbingInBackwards,e.preventDefault(),r.modules&&r.modules.length){r.currentModuleIx=r.modules.length-1;const o=r.modules[r.currentModuleIx];o&&o.validate&&!o.validate()?r.move(-1):o&&o.init(-1)}}else r.exiting=!1})}getFirstValidModuleIx(){var e=this.modules.length;for(let t=0;t<e;++t){const i=this.modules[t];if(!i.validate||i.validate())return t}return null}destroy(){this.removeExitAnchor(),this.eventProvider.removeAddedEvents(),this.chart.container.removeAttribute("tabindex")}}!function(t){const i=[];function n(){const t=this;fireEvent(this,"dismissPopupContent",{},function(){t.tooltip&&t.tooltip.hide(0),t.hideExportMenu()})}function o(t){27===(t.which||t.keyCode)&&H.charts&&H.charts.forEach(t=>{t&&t.dismissPopupContent&&t.dismissPopupContent()})}t.compose=function(t){if(MenuComponent.compose(t),U.pushUnique(i,t)){const e=t.prototype;e.dismissPopupContent=n}return U.pushUnique(i,doc)&&addEvent(doc,"keydown",o),t}}(KeyboardNavigation=KeyboardNavigation||{});export default KeyboardNavigation;