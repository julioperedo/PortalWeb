"use strict";import EulerIntegration from"./EulerIntegration.js";import H from"../../Core/Globals.js";const win=H["win"];import GraphLayout from"../GraphLayoutComposition.js";import QuadTree from"./QuadTree.js";import U from"../../Core/Utilities.js";const{clamp,defined,isFunction,fireEvent,pick}=U;import VerletIntegration from"./VerletIntegration.js";class ReingoldFruchtermanLayout{constructor(){this.attractiveForce=void 0,this.box={},this.currentStep=0,this.initialRendering=!0,this.integration=void 0,this.links=[],this.nodes=[],this.options=void 0,this.quadTree=void 0,this.repulsiveForce=void 0,this.series=[],this.simulation=!1}static compose(t){GraphLayout.compose(t),GraphLayout.integrations.euler=EulerIntegration,GraphLayout.integrations.verlet=VerletIntegration,GraphLayout.layouts["reingold-fruchterman"]=ReingoldFruchtermanLayout}init(t){this.options=t,this.nodes=[],this.links=[],this.series=[],this.box={x:0,y:0,width:0,height:0},this.setInitialRendering(!0),this.integration=GraphLayout.integrations[t.integration],this.enableSimulation=t.enableSimulation,this.attractiveForce=pick(t.attractiveForce,this.integration.attractiveForceFunction),this.repulsiveForce=pick(t.repulsiveForce,this.integration.repulsiveForceFunction),this.approximation=t.approximation}updateSimulation(t){this.enableSimulation=pick(t,this.options.enableSimulation)}start(){const t=this,i=this.series,e=this.options;t.currentStep=0,t.forces=i[0]&&i[0].forces||[],t.chart=i[0]&&i[0].chart,t.initialRendering&&(t.initPositions(),i.forEach(function(t){t.finishedAnimating=!0,t.render()})),t.setK(),t.resetSimulation(e),t.enableSimulation&&t.step()}step(){var t=this.series;this.currentStep++,"barnes-hut"===this.approximation&&(this.createQuadTree(),this.quadTree.calculateMassAndCenter());for(const i of this.forces||[])this[i+"Forces"](this.temperature);if(this.applyLimits(),this.temperature=this.coolDown(this.startTemperature,this.diffTemperature,this.currentStep),this.prevSystemTemperature=this.systemTemperature,this.systemTemperature=this.getSystemTemperature(),this.enableSimulation){for(const e of t)e.chart&&e.render();this.maxIterations--&&isFinite(this.temperature)&&!this.isStable()?(this.simulation&&win.cancelAnimationFrame(this.simulation),this.simulation=win.requestAnimationFrame(()=>this.step())):(this.simulation=!1,this.series.forEach(t=>{fireEvent(t,"afterSimulation")}))}}stop(){this.simulation&&win.cancelAnimationFrame(this.simulation)}setArea(t,i,e,s){this.box={left:t,top:i,width:e,height:s}}setK(){this.k=this.options.linkLength||this.integration.getK(this)}addElementsToCollection(t,i){for(const e of t)-1===i.indexOf(e)&&i.push(e)}removeElementFromCollection(t,i){t=i.indexOf(t);-1!==t&&i.splice(t,1)}clear(){this.nodes.length=0,this.links.length=0,this.series.length=0,this.resetSimulation()}resetSimulation(){this.forcedStop=!1,this.systemTemperature=0,this.setMaxIterations(),this.setTemperature(),this.setDiffTemperature()}restartSimulation(){this.simulation?this.resetSimulation():(this.setInitialRendering(!1),this.enableSimulation?this.start():this.setMaxIterations(1),this.chart&&this.chart.redraw(),this.setInitialRendering(!0))}setMaxIterations(t){this.maxIterations=pick(t,this.options.maxIterations)}setTemperature(){this.temperature=this.startTemperature=Math.sqrt(this.nodes.length)}setDiffTemperature(){this.diffTemperature=this.startTemperature/(this.options.maxIterations+1)}setInitialRendering(t){this.initialRendering=t}createQuadTree(){this.quadTree=new QuadTree(this.box.left,this.box.top,this.box.width,this.box.height),this.quadTree.insertNodes(this.nodes)}initPositions(){const t=this.options.initialPositions;if(isFunction(t)){t.call(this);for(const i of this.nodes)defined(i.prevX)||(i.prevX=i.plotX),defined(i.prevY)||(i.prevY=i.plotY),i.dispX=0,i.dispY=0}else"circle"===t?this.setCircularPositions():this.setRandomPositions()}setCircularPositions(){const e=this.box,t=this.nodes,i=t.length+1,s=2*Math.PI/i,o=t.filter(function(t){return 0===t.linksTo.length}),r={},n=this.options.initialPositionRadius,a=t=>{for(const i of t.linksFrom||[])r[i.toNode.id]||(r[i.toNode.id]=!0,h.push(i.toNode),a(i.toNode))};let h=[];for(const p of o)h.push(p),a(p);if(h.length)for(const l of t)-1===h.indexOf(l)&&h.push(l);else h=t;let l;for(let t=0,i=h.length;t<i;++t)(l=h[t]).plotX=l.prevX=pick(l.plotX,e.width/2+n*Math.cos(t*s)),l.plotY=l.prevY=pick(l.plotY,e.height/2+n*Math.sin(t*s)),l.dispX=0,l.dispY=0}setRandomPositions(){var e=this.box,s=this.nodes,o=s.length+1,r=t=>{t=t*t/Math.PI;return t-=Math.floor(t)};let n;for(let t=0,i=s.length;t<i;++t)(n=s[t]).plotX=n.prevX=pick(n.plotX,e.width*r(t)),n.plotY=n.prevY=pick(n.plotY,e.height*r(o+t)),n.dispX=0,n.dispY=0}force(t,...i){this.integration[t].apply(this,i)}barycenterForces(){this.getBarycenter(),this.force("barycenter")}getBarycenter(){let t=0,i=0,e=0;for(const s of this.nodes)i+=s.plotX*s.mass,e+=s.plotY*s.mass,t+=s.mass;return this.barycenter={x:i,y:e,xFactor:i/t,yFactor:e/t},this.barycenter}barnesHutApproximation(t,i){var e=this.getDistXY(t,i),s=this.vectorLength(e);let o,r;return t!==i&&0!==s&&(i.isInternal?o=!(i.boxSize/s<this.options.theta&&0!==s)||(r=this.repulsiveForce(s,this.k),this.force("repulsive",t,r*i.mass,e,s),!1):(r=this.repulsiveForce(s,this.k),this.force("repulsive",t,r*i.mass,e,s))),o}repulsiveForces(){var t,i,e;if("barnes-hut"===this.approximation)for(const s of this.nodes)this.quadTree.visitNodeRecursive(null,t=>this.barnesHutApproximation(s,t));else for(const o of this.nodes)for(const r of this.nodes)o===r||o.fixedPosition||(e=this.getDistXY(o,r),0!==(i=this.vectorLength(e))&&(t=this.repulsiveForce(i,this.k),this.force("repulsive",o,t*r.mass,e,i)))}attractiveForces(){var t,i,e;for(const s of this.links)s.fromNode&&s.toNode&&(t=this.getDistXY(s.fromNode,s.toNode),0!==(i=this.vectorLength(t))&&(e=this.attractiveForce(i,this.k),this.force("attractive",s,e,t,i)))}applyLimits(){for(const t of this.nodes){if(t.fixedPosition)return;this.integration.integrate(this,t),this.applyLimitBox(t,this.box),t.dispX=0,t.dispY=0}}applyLimitBox(t,i){var e=t.radius;t.plotX=clamp(t.plotX,i.left+e,i.width-e),t.plotY=clamp(t.plotY,i.top+e,i.height-e)}coolDown(t,i,e){return t-i*e}isStable(){return Math.abs(this.systemTemperature-this.prevSystemTemperature)<1e-5||this.temperature<=0}getSystemTemperature(){let t=0;for(const i of this.nodes)t+=i.temperature;return t}vectorLength(t){return Math.sqrt(t.x*t.x+t.y*t.y)}getDistR(t,i){t=this.getDistXY(t,i);return this.vectorLength(t)}getDistXY(t,i){var e=t.plotX-i.plotX,t=t.plotY-i.plotY;return{x:e,y:t,absX:Math.abs(e),absY:Math.abs(t)}}}export default ReingoldFruchtermanLayout;