"use strict";import SeriesRegistry from"../Core/Series/SeriesRegistry.js";const{prototype:seriesProto,prototype:{pointClass:{prototype:pointProto}}}=SeriesRegistry["series"];import U from"../Core/Utilities.js";const{defined,extend,find,merge,pick}=U;var NodesComposition;!function(o){const i=[];function n(){return this.data=[].concat(this.points||[],this.nodes),seriesProto.destroy.apply(this,arguments)}function r(){this.nodes&&(this.nodes.forEach(o=>{o.destroy()}),this.nodes.length=0),seriesProto.setData.apply(this,arguments)}function d(o){const t=arguments,e=this.isNode?this.linksTo.concat(this.linksFrom):[this.fromNode,this.toNode];"select"!==o&&e.forEach(o=>{o&&o.series&&(pointProto.setState.apply(o,t),o.isNode||(o.fromNode.graphic&&pointProto.setState.apply(o.fromNode,t),o.toNode&&o.toNode.graphic&&pointProto.setState.apply(o.toNode,t)))}),pointProto.setState.apply(this,t)}function h(o,t,e,s){const i=this.series.options.nodes,n=this.series.options.data,r=n&&n.length||0,d=n&&n[this.index];pointProto.update.call(this,o,!this.isNode&&t,e,s),this.isNode&&(o=(i||[]).reduce((o,t,e)=>this.id===t.id?e:o,-1),s=merge(i&&i[o]||{},n&&n[this.index]||{}),n&&(d?n[this.index]=d:n.length=r),i?0<=o?i[o]=s:i.push(s):this.series.options.nodes=[s],pick(t,!0)&&this.series.chart.redraw(e))}o.compose=function(o,t){if(U.pushUnique(i,o)){const e=o.prototype;e.setNodeState=d,e.setState=d,e.update=h}if(U.pushUnique(i,t)){const s=t.prototype;s.destroy=n,s.setData=r}return t},o.createNode=function(o){const t=this.pointClass,e=(o,t)=>find(o,o=>o.id===t);let s=e(this.nodes,o),i;if(!s){i=this.options.nodes&&e(this.options.nodes,o);const n=(new t).init(this,extend({className:"highcharts-node",isNode:!0,id:o,y:1},i));n.linksTo=[],n.linksFrom=[],n.getSum=function(){let t=0,e=0;return n.linksTo.forEach(o=>{t+=o.weight||0}),n.linksFrom.forEach(o=>{e+=o.weight||0}),Math.max(t,e)},n.offset=function(t,e){let s=0;for(let o=0;o<n[e].length;o++){if(n[e][o]===t)return s;s+=n[e][o].weight}},n.hasShape=function(){let t=0;return n.linksTo.forEach(o=>{o.outgoing&&t++}),!n.linksTo.length||t!==n.linksTo.length},n.index=this.nodes.push(n)-1,s=n}return s.formatPrefix="node",s.name=s.name||s.options.id||"",s.mass=pick(s.options.mass,s.options.marker&&s.options.marker.radius,this.options.marker&&this.options.marker.radius,4),s},o.destroy=n,o.generatePoints=function(){const t=this.chart,e={};seriesProto.generatePoints.call(this),this.nodes||(this.nodes=[]),this.colorCounter=0,this.nodes.forEach(o=>{o.linksFrom.length=0,o.linksTo.length=0,o.level=o.options.level}),this.points.forEach(o=>{defined(o.from)&&(e[o.from]||(e[o.from]=this.createNode(o.from)),e[o.from].linksFrom.push(o),o.fromNode=e[o.from],t.styledMode?o.colorIndex=pick(o.options.colorIndex,e[o.from].colorIndex):o.color=o.options.color||e[o.from].color),defined(o.to)&&(e[o.to]||(e[o.to]=this.createNode(o.to)),e[o.to].linksTo.push(o),o.toNode=e[o.to]),o.name=o.name||o.id},this),this.nodeLookup=e},o.setNodeState=d,o.updateNode=h}(NodesComposition=NodesComposition||{});export default NodesComposition;