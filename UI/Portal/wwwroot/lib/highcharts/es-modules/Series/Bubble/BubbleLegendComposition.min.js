"use strict";import BubbleLegendDefaults from"./BubbleLegendDefaults.js";import BubbleLegendItem from"./BubbleLegendItem.js";import D from"../../Core/Defaults.js";const setOptions=D["setOptions"];import U from"../../Core/Utilities.js";const{addEvent,objectEach,wrap}=U,composedMembers=[];function chartDrawChartBox(e,t,n){const s=this,l=s.legend,i=0<=getVisibleBubbleSeriesIndex(s);let b,o,r;l&&l.options.enabled&&l.bubbleLegend&&l.options.bubbleLegend.autoRanges&&i?(b=l.bubbleLegend.options,o=l.bubbleLegend.predictBubbleSizes(),l.bubbleLegend.updateRanges(o[0],o[1]),b.placed||(l.group.placed=!1,l.allItems.forEach(e=>{(r=e.legendItem||{}).group&&(r.group.translateY=void 0)})),l.render(),s.getMargins(),s.axes.forEach(function(e){e.visible&&e.render(),b.placed||(e.setScale(),e.updateNames(),objectEach(e.ticks,function(e){e.isNew=!0,e.isNewLabel=!0}))}),b.placed=!0,s.getMargins(),e.call(s,t,n),l.bubbleLegend.correctSizes(),retranslateItems(l,getLinesHeights(l))):(e.call(s,t,n),l&&l.options.enabled&&l.bubbleLegend&&(l.render(),retranslateItems(l,getLinesHeights(l))))}function compose(e,t,n){U.pushUnique(composedMembers,e)&&(setOptions({legend:{bubbleLegend:BubbleLegendDefaults}}),wrap(e.prototype,"drawChartBox",chartDrawChartBox)),U.pushUnique(composedMembers,t)&&addEvent(t,"afterGetAllItems",onLegendAfterGetAllItems),U.pushUnique(composedMembers,n)&&addEvent(n,"legendItemClick",onSeriesLegendItemClick)}function getVisibleBubbleSeriesIndex(e){var t=e.series;let n=0;for(;n<t.length;){if(t[n]&&t[n].isBubble&&t[n].visible&&t[n].zData.length)return n;n++}return-1}function getLinesHeights(e){const t=e.allItems,n=[],s=t.length;let l,i,b,o=0,r=0;for(o=0;o<s;o++)if(i=t[o].legendItem||{},b=(t[o+1]||{}).legendItem||{},i.labelHeight&&(t[o].itemHeight=i.labelHeight),t[o]===t[s-1]||i.y!==b.y){for(n.push({height:0}),l=n[n.length-1],r;r<=o;r++)t[r].itemHeight>l.height&&(l.height=t[r].itemHeight);l.step=o}return n}function onLegendAfterGetAllItems(e){const t=this,n=t.bubbleLegend,s=t.options,l=s.bubbleLegend,i=getVisibleBubbleSeriesIndex(t.chart);n&&n.ranges&&n.ranges.length&&(l.ranges.length&&(l.autoRanges=!!l.ranges[0].autoRanges),t.destroyItem(n)),0<=i&&s.enabled&&l.enabled&&(l.seriesIndex=i,t.bubbleLegend=new BubbleLegendItem(l,t),t.bubbleLegend.addToLegend(e.allItems))}function onSeriesLegendItemClick(e){if(e.defaultPrevented)return!1;const t=this,n=t.chart,s=t.visible,l=t.chart.legend;l&&l.bubbleLegend&&(t.visible=!s,t.ignoreSeries=s,e=0<=getVisibleBubbleSeriesIndex(n),l.bubbleLegend.visible!==e&&(l.update({bubbleLegend:{enabled:e}}),l.bubbleLegend.visible=e),t.visible=s)}function retranslateItems(e,n){const t=e.allItems,s=e.options.rtl;let l,i,b,o,r=0;t.forEach((e,t)=>{(o=e.legendItem||{}).group&&(l=o.group.translateX||0,i=o.y||0,((b=e.movementX)||s&&e.ranges)&&(b=s?l-e.options.maxSize/2:l+b,o.group.attr({translateX:b})),t>n[r].step&&r++,o.group.attr({translateY:Math.round(i+n[r].height/2)}),o.y=i+n[r].height/2)})}const BubbleLegendComposition={compose:compose};export default BubbleLegendComposition;