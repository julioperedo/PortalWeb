"use strict";import ArcDiagramPoint from"./ArcDiagramPoint.js";import SankeyColumnComposition from"../Sankey/SankeyColumnComposition.js";import Series from"../../Core/Series/Series.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";import SVGRenderer from"../../Core/Renderer/SVG/SVGRenderer.js";import U from"../../Core/Utilities.js";const{symbols}=SVGRenderer["prototype"],{column:ColumnSeries,sankey:SankeySeries}=SeriesRegistry["seriesTypes"],{extend,merge,pick,relativeLength}=U;class ArcDiagramSeries extends SankeySeries{constructor(){super(...arguments),this.data=void 0,this.options=void 0,this.nodeColumns=void 0,this.nodes=void 0,this.points=void 0}createNodeColumns(){const h=this,m=h.chart,c=SankeyColumnComposition.compose([],h);return c.sankeyColumn.maxLength=m.inverted?m.plotHeight:m.plotWidth,c.sankeyColumn.getTranslationFactor=e=>{const t=c.slice(),i=this.options.minLinkWidth||0;let o,s=0,a,n,r=0,l=1,p=0,h=(m.plotSizeX||0)-(e.options.marker&&e.options.marker.lineWidth||0)-(c.length-1)*e.nodePadding;for(;c.length;){for(s=h/c.sankeyColumn.sum(),o=!1,a=c.length;a--;){n=c[a].getSum()*s*l;var d=Math.min(m.plotHeight,m.plotWidth);n>d?l=Math.min(d/n,l):n<i&&(c.splice(a,1),h-=i,n=i,o=!0),p+=n*(1-l)/2,r=Math.max(r,n)}if(!o)break}return c.length=0,t.forEach(e=>{e.scale=l,c.push(e)}),c.sankeyColumn.maxRadius=r,c.sankeyColumn.scale=l,c.sankeyColumn.additionalSpace=p,s},c.sankeyColumn.offset=function(t,i){var o=t.series.options.equalNodes;let s=c.sankeyColumn.additionalSpace||0,a,n=h.nodePadding,r=Math.min(m.plotWidth,m.plotHeight,(c.sankeyColumn.maxLength||0)/h.nodes.length-n);for(let e=0;e<c.length;e++){var l=c[e].getSum()*(c.sankeyColumn.scale||0),p=o?r:Math.max(l*i,h.options.minLinkWidth||0);if(a=l?p+n:0,c[e]===t)return{relativeLeft:s+relativeLength(t.options.offset||0,a)};s+=a}},h.nodes.forEach(function(e){e.column=0,c.push(e)}),[c]}translateLink(i){const e=this,t=i.fromNode,o=i.toNode,s=this.chart,a=e.translationFactor,n=i.options,r=e.options,l=pick(n.linkWeight,r.linkWeight,Math.max((i.weight||0)*a*t.scale,e.options.minLinkWidth||0)),p=i.series.options.centeredLinks,h=t.nodeY;var d=(e,t)=>{t=(e.offset(i,t)||0)*a;return Math.min(e.nodeX+t,e.nodeX+(e.shapeArgs&&e.shapeArgs.height||0)-l)};let m=p?t.nodeX+((t.shapeArgs.height||0)-l)/2:d(t,"linksFrom"),c=p?o.nodeX+((o.shapeArgs.height||0)-l)/2:d(o,"linksTo"),g=h;l;m>c&&([m,c]=[c,m]),r.reversed&&([m,c]=[c,m],g=(s.plotSizeY||0)-g),i.shapeType="path",i.linkBase=[m,m+l,c,c+l];d=(c+l-m)/Math.abs(c+l-m)*pick(r.linkRadius,Math.min(Math.abs(c+l-m)/2,t.nodeY-Math.abs(l)));i.shapeArgs={d:[["M",m,g],["A",(c+l-m)/2,d,0,0,1,c+l,g],["L",c,g],["A",(c-m-l)/2,d-l,0,0,0,m+l,g],["Z"]]},i.dlBox={x:m+(c-m)/2,y:g-d,height:l,width:0},i.tooltipPos=s.inverted?[(s.plotSizeY||0)-i.dlBox.y-l/2,(s.plotSizeX||0)-i.dlBox.x]:[i.dlBox.x,i.dlBox.y+l/2],i.y=i.plotY=1,i.x=i.plotX=1,i.color||(i.color=t.color)}translateNode(t,i){var o=this,s=o.translationFactor,a=o.chart,n=a.inverted?a.plotWidth:a.plotHeight,o=o.options,n=Math.min(a.plotWidth,a.plotHeight,n/t.series.nodes.length-this.nodePadding),r=t.getSum()*(i.sankeyColumn.scale||0),n=o.equalNodes?n:Math.max(r*s,this.options.minLinkWidth||0),l=Math.round(o.marker&&o.marker.lineWidth||0)%2/2,p=i.sankeyColumn.offset(t,s),s=Math.floor(pick(p&&p.absoluteLeft,(i.sankeyColumn.left(s)||0)+(p&&p.relativeLeft||0)))+l,p=merge(o.marker,t.options.marker),h=p.symbol,d=p.radius,p=parseInt(o.offset,10)*((a.inverted?a.plotWidth:a.plotHeight)-(Math.floor(this.colDistance*(t.column||0)+(p.lineWidth||0)/2)+l+(i.sankeyColumn.scale||0)*(i.sankeyColumn.maxRadius||0)/2))/100;if(t.sum=r){t.nodeX=s,t.nodeY=p;l=s,i=t.options.width||o.width||n,r=t.options.height||o.height||n;let e=p;o.reversed&&(e=(a.plotSizeY||0)-p,a.inverted&&(e=(a.plotSizeY||0)-p)),this.mapOptionsToLevel&&(t.dlOptions=SankeySeries.getDLOptions({level:this.mapOptionsToLevel[t.level],optionsPoint:t.options})),t.plotX=1,t.plotY=1,t.tooltipPos=a.inverted?[(a.plotSizeY||0)-e-r/2,(a.plotSizeX||0)-l-i/2]:[l+i/2,e+r/2],t.shapeType="path",t.shapeArgs={d:symbols[h||"circle"](l,e-(d||r)/2,d||i,d||r),width:d||i,height:d||r},t.dlBox={x:l+i/2,y:e,height:0,width:0}}else t.dlOptions={enabled:!1}}drawDataLabels(){var e;this.options.dataLabels&&(e=this.options.dataLabels.textPath,ColumnSeries.prototype.drawDataLabels.call(this,this.nodes),this.options.dataLabels.textPath=this.options.dataLabels.linkTextPath,ColumnSeries.prototype.drawDataLabels.call(this,this.data),this.options.dataLabels.textPath=e)}pointAttribs(e,t){if(e&&e.isNode){const{opacity:i,...o}=Series.prototype.pointAttribs.apply(this,arguments);return o}return super.pointAttribs.apply(this,arguments)}markerAttribs(e){return e.isNode?super.markerAttribs.apply(this,arguments):{}}}ArcDiagramSeries.defaultOptions=merge(SankeySeries.defaultOptions,{centeredLinks:!1,offset:"100%",equalNodes:!1,reversed:!1,dataLabels:{linkTextPath:{attributes:{startOffset:"25%"}}},marker:{symbol:"circle",fillOpacity:1,lineWidth:0,states:{}}}),extend(ArcDiagramSeries.prototype,{orderNodes:!1}),ArcDiagramSeries.prototype.pointClass=ArcDiagramPoint,SeriesRegistry.registerSeriesType("arcdiagram",ArcDiagramSeries);export default ArcDiagramSeries;