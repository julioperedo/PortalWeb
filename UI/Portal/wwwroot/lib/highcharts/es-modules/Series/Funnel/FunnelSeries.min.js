"use strict";import FunnelSeriesDefaults from"./FunnelSeriesDefaults.js";import H from"../../Core/Globals.js";const noop=H["noop"];import BorderRadius from"../../Extensions/BorderRadius.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";const{column:ColumnSeries,pie:PieSeries}=SeriesRegistry.seriesTypes;import U from"../../Core/Utilities.js";const{addEvent,extend,fireEvent,isArray,merge,pick,pushUnique,relativeLength,splat}=U,baseAlignDataLabel=SeriesRegistry.series.prototype.alignDataLabel;function getLength(t,e){return/%$/.test(t)?e*parseInt(t,10)/100:parseInt(t,10)}class FunnelSeries extends PieSeries{constructor(){super(...arguments),this.data=void 0,this.options=void 0,this.points=void 0}alignDataLabel(t,e,i,s,a){const n=t.series,o=n.options.reversed,d=t.dlBox||t.shapeArgs,r=i.align,l=i.verticalAlign,h=((n.options||{}).dataLabels||{}).inside,p=n.center[1],g=o?2*p-t.plotY:t.plotY,u=n.getWidthAt(g-d.height/2+e.height),c="middle"===l?(d.topWidth-d.bottomWidth)/4:(u-d.bottomWidth)/2;let x=d.y,y=d.x;var L=pick(e.height,e.getBBox().height);"middle"===l?x=d.y-d.height/2+L/2:"top"===l&&(x=d.y-d.height+L+(i.padding||0)),("top"===l&&!o||"bottom"===l&&o||"middle"===l)&&("right"===r?y=d.x-i.padding+c:"left"===r&&(y=d.x+i.padding-c)),s={x:y,y:o?x-d.height:x,width:d.bottomWidth,height:d.height},i.verticalAlign="bottom",h&&!t.visible||baseAlignDataLabel.call(n,t,e,i,s,a),h&&(!t.visible&&t.dataLabel&&(t.dataLabel.placed=!1),t.contrastColor&&e.css({color:t.contrastColor}))}drawDataLabels(){(splat(this.options.dataLabels)[0].inside?ColumnSeries:PieSeries).prototype.drawDataLabels.call(this)}getDataLabelPosition(t,e){var i=t.plotY||0,s=t.half?1:-1,a=this.getX(i,!!t.half,t);return{distance:e,natural:{x:0,y:i},computed:{},alignment:t.half?"right":"left",connectorPosition:{breakAt:{x:a+(e-5)*s,y:i},touchingSliceAt:{x:a+e*s,y:i}}}}translate(){const s=this,t=s.chart,e=s.options,d=e.reversed,i=e.ignoreHiddenPoint,a=BorderRadius.optionsToObject(e.borderRadius),n=t.plotWidth,o=t.plotHeight,H=e.center,r=getLength(H[0],n),l=getLength(H[1],o),h=getLength(e.width,n),p=getLength(e.height,o),g=getLength(e.neckWidth,n),u=getLength(e.neckHeight,o),c=l-p/2+p-u,x=s.data,w=relativeLength(a.radius,h),y=a.scope,E="left"===e.dataLabels.position?1:0,L=t=>{var e=Math.tan(t/2),i=Math.cos(S),s=Math.sin(S);let a=w,n=a/e,o=Math.tan((Math.PI-t)/3.2104);return n>M&&(n=M,a=n*e),o*=a,{dx:[n*i,(n-o)*i,n-o,n],dy:[n*s,(n-o)*s,n-o,n].map(t=>d?-t:t)}};let b=0,T=0,f,m,v,S,M,A,C,P,W,D,F,k;s.getWidthAt=function(t){var e=l-p/2;return t>c||p===u?g:g+(h-g)*(1-(t-e)/(p-u))},s.getX=function(t,e,i){return r+(e?-1:1)*(s.getWidthAt(d?2*l-t:t)/2+(i.dataLabel?.dataLabelPosition?.distance??relativeLength(this.options.dataLabels?.distance||0,h)))},s.center=[r,l,p],s.centerX=r;for(const Y of x)!Y.y||!Y.isValid()||i&&!1===Y.visible||(b+=Y.y);for(const j of x){if(k=null,v=b?j.y/b:0,C=l-p/2+T*p,D=C+v*p,f=s.getWidthAt(C),A=r-f/2,P=A+f,f=s.getWidthAt(D),W=r-f/2,F=W+f,C>c?(A=W=r-g/2,P=F=r+g/2):D>c&&(k=D,f=s.getWidthAt(c),W=r-f/2,F=W+f,D=c),d&&(C=2*l-C,D=2*l-D,null!==k&&(k=2*l-k)),!w||"point"!==y&&0!==j.index&&j.index!==x.length-1&&null===k)m=[["M",A,C],["L",P,C],["L",F,D]],null!==k&&m.push(["L",F,k],["L",W,k]),m.push(["L",W,D]);else{var R=Math.abs(D-C),B=P-F,I=F-W,U=Math.sqrt(B*B+R*R);S=Math.atan(R/B),M=U/2,null!==k&&(M=Math.min(M,Math.abs(k-D)/2)),1<=I&&(M=Math.min(M,I/2));let t=L(S);m="stack"===y&&0!==j.index?[["M",A,C],["L",P,C]]:[["M",A+t.dx[0],C+t.dy[0]],["C",A+t.dx[1],C+t.dy[1],A+t.dx[2],C,A+t.dx[3],C],["L",P-t.dx[3],C],["C",P-t.dx[2],C,P-t.dx[1],C+t.dy[1],P-t.dx[0],C+t.dy[0]]],null!==k?(R=L(Math.PI/2),t=L(Math.PI/2+S),m.push(["L",F+t.dx[0],D-t.dy[0]],["C",F+t.dx[1],D-t.dy[1],F,D+t.dy[2],F,D+t.dy[3]]),"stack"===y&&j.index!==x.length-1?m.push(["L",F,k],["L",W,k]):m.push(["L",F,k-R.dy[3]],["C",F,k-R.dy[2],F-R.dx[2],k,F-R.dx[3],k],["L",W+R.dx[3],k],["C",W+R.dx[2],k,W,k-R.dy[2],W,k-R.dy[3]]),m.push(["L",W,D+t.dy[3]],["C",W,D+t.dy[2],W-t.dx[1],D-t.dy[1],W-t.dx[0],D-t.dy[0]])):1<=I?(t=L(Math.PI-S),"stack"===y&&0===j.index?m.push(["L",F,D],["L",W,D]):m.push(["L",F+t.dx[0],D-t.dy[0]],["C",F+t.dx[1],D-t.dy[1],F-t.dx[2],D,F-t.dx[3],D],["L",W+t.dx[3],D],["C",W+t.dx[2],D,W-t.dx[1],D-t.dy[1],W-t.dx[0],D-t.dy[0]])):(t=L(Math.PI-2*S),m.push(["L",W+t.dx[0],D-t.dy[0]],["C",W+t.dx[1],D-t.dy[1],W-t.dx[1],D-t.dy[1],W-t.dx[0],D-t.dy[0]]))}m.push(["Z"]),j.shapeType="path",j.shapeArgs={d:m},j.percentage=100*v,j.plotX=r,j.plotY=(C+(k||D))/2,j.tooltipPos=[r,j.plotY],j.dlBox={x:W,y:C,topWidth:P-A,bottomWidth:F-W,height:Math.abs(pick(k,D)-C),width:NaN},j.slice=noop,j.half=E,!j.isValid()||i&&!1===j.visible||(T+=v)}fireEvent(s,"afterTranslate")}sortByAngle(t){t.sort((t,e)=>t.plotY-e.plotY)}}FunnelSeries.defaultOptions=merge(PieSeries.defaultOptions,FunnelSeriesDefaults),extend(FunnelSeries.prototype,{animate:noop}),function(t){const e=[];function i(){for(const e of this.series){let t=e.options&&e.options.dataLabels;isArray(t)&&(t=t[0]),e.is("pie")&&e.placeDataLabels&&t&&!t.inside&&e.placeDataLabels()}}t.compose=function(t){pushUnique(e,t)&&addEvent(t,"afterHideAllOverlappingLabels",i)}}(FunnelSeries=FunnelSeries||{}),SeriesRegistry.registerSeriesType("funnel",FunnelSeries);export default FunnelSeries;