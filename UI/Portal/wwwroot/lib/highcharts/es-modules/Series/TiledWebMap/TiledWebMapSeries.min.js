"use strict";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";const MapSeries=SeriesRegistry.seriesTypes["map"];import TilesProvidersRegistry from"../../Maps/TilesProviders/TilesProviderRegistry.js";import TiledWebMapSeriesDefaults from"./TiledWebMapSeriesDefaults.js";import U from"../../Core/Utilities.js";const{addEvent,defined,error,merge,pick,pushUnique}=U,composedMembers=[];function onChartBeforeMapViewInit(e){var t,i,o,r=(this.options.series||[]).filter(e=>"tiledwebmap"===e.type)[0],e=e["geoBounds"];if(r&&r.provider&&r.provider.type&&!r.provider.url){const s=TilesProvidersRegistry[r.provider.type];if(defined(s))return r=(new s)["initialProjectionName"],this.options.mapView&&(e?({x1:e,y1:t,x2:i,y2:o}=e,this.options.mapView.recommendedMapView={projection:{name:r,parallels:[t,o],rotation:[-(e+i)/2]}}):this.options.mapView.recommendedMapView={projection:{name:r},minZoom:0}),!1;error("Highcharts warning: Tiles Provider not defined in the Provider Registry.",!1)}return!0}class TiledWebMapSeries extends MapSeries{constructor(){super(...arguments),this.options=void 0,this.redrawTiles=!1,this.isAnimating=!1}static compose(e){pushUnique(composedMembers,e)&&addEvent(e,"beforeMapViewInit",onChartBeforeMapViewInit)}lonLatToTile(e,t){var{lon:e,lat:i}=e;return{x:Math.floor((e+180)/360*Math.pow(2,t)),y:Math.floor((1-Math.log(Math.tan(i*Math.PI/180)+1/Math.cos(i*Math.PI/180))/Math.PI)/2*Math.pow(2,t))}}tileToLonLat(e,t,i){e=e/Math.pow(2,i)*360-180,t=Math.PI-2*Math.PI*t/Math.pow(2,i);return{lon:e,lat:180/Math.PI*Math.atan(.5*(Math.exp(t)-Math.exp(-t)))}}drawPoints(){const p=this.chart,d=p.mapView;if(d){const h=this.tiles=this.tiles||{},m=this.transformGroups=this.transformGroups||[],c=this,E=this.options,f=E.provider,t=d["zoom"],a=pick(d.projection.options.rotation&&d.projection.options.rotation[0],0),u=400.979322,y=256,M=p.renderer.forExport?0:200,T=i=>{for(const o of Object.keys(h))parseFloat(o)===(d.zoom<0?0:Math.floor(d.zoom))||c.minZoom&&(d.zoom<0?0:Math.floor(d.zoom))<c.minZoom&&parseFloat(o)===c.minZoom||c.maxZoom&&(d.zoom<0?0:Math.floor(d.zoom))>c.maxZoom&&parseFloat(o)===c.maxZoom?Object.keys(h[o].tiles).forEach((e,t)=>{h[o].tiles[e].animate({opacity:1},{duration:i},()=>{t===Object.keys(h[o].tiles).length-1&&(h[o].isActive=!0)})}):Object.keys(h[o].tiles).forEach((e,t)=>{h[o].tiles[e].animate({opacity:0},{duration:i,defer:i/2},()=>{h[o].tiles[e].destroy(),delete h[o].tiles[e],t===Object.keys(h[o].tiles).length-1&&(h[o].isActive=!1,h[o].loaded=!1)})})};let o=t<0?0:Math.floor(t),n=Math.pow(2,o),e=y/u*Math.pow(2,t)/(y/u*Math.pow(2,o)),l=256*e;if(f&&(f.type||f.url)){if(f.type&&!f.url){const g=TilesProvidersRegistry[f.type];if(!defined(g))return void error("Highcharts warning: Tiles Provider '"+f.type+"' not defined in the ProviderRegistry.",!1);const w=new g,K=w.initialProjectionName;let e,t="";f.theme&&defined(w.themes[f.theme])?e=w.themes[f.theme]:(i=Object.keys(w.themes)[0],e=w.themes[i],error("Highcharts warning: The Tiles Provider's Theme '"+f.theme+"' is not defined in the Provider definition - falling back to '"+i+"'.",!1)),f.subdomain&&w.subdomains&&-1!==w.subdomains.indexOf(f.subdomain)?t=f.subdomain:defined(w.subdomains)&&-1!==e.url.indexOf("{s}")&&(t=pick(w.subdomains&&w.subdomains[0],""),error("Highcharts warning: The Tiles Provider's Subdomain '"+f.subdomain+"' is not defined in the Provider definition - falling back to '"+t+"'.",!1)),w.requiresApiKey&&(f.apiKey?e.url=e.url.replace("{apikey}",f.apiKey):(error("Highcharts warning: The Tiles Provider requires API Key to use tiles, use provider.apiKey to provide a token.",!1),e.url=e.url.replace("?apikey={apikey}",""))),f.url=e.url.replace("{s}",t),this.minZoom=e.minZoom,this.maxZoom=e.maxZoom;var i=pick(p.userOptions.credits&&p.userOptions.credits.text,"Highcharts.com "+pick(e.credits,w.defaultCredits));p.credits?p.credits.update({text:i}):p.addCredits({text:i,style:pick(p.options.credits?.style,{})}),d.projection.options.name!==K&&error("Highcharts warning: The set projection is different than supported by Tiles Provider.",!1)}else d.projection.options.name||error("Highcharts warning: The set projection is different than supported by Tiles Provider.",!1);if(defined(this.minZoom)&&o<this.minZoom?(o=this.minZoom,n=Math.pow(2,o),e=y/u*Math.pow(2,t)/(y/u*Math.pow(2,o)),l=256*e):defined(this.maxZoom)&&o>this.maxZoom&&(o=this.maxZoom,n=Math.pow(2,o),e=y/u*Math.pow(2,t)/(y/u*Math.pow(2,o)),l=256*e),d.projection&&d.projection.def){d.projection.hasCoordinates=!0,m[o]||(m[o]=p.renderer.g().add(this.group));const X=(e,t,i,o)=>e.replace("{x}",t.toString()).replace("{y}",i.toString()).replace("{zoom}",o.toString()).replace("{z}",o.toString());const x=d.pixelsToProjectedUnits({x:0,y:0}),j=d.projection.def.inverse([x.x,x.y]),v={lon:j[0]-a,lat:j[1]},b=d.pixelsToProjectedUnits({x:p.plotWidth,y:p.plotHeight}),P=d.projection.def.inverse([b.x,b.y]),k={lon:P[0]-a,lat:P[1]};(v.lat>d.projection.maxLatitude||k.lat<-1*d.projection.maxLatitude)&&(v.lat=d.projection.maxLatitude,k.lat=-1*d.projection.maxLatitude);var r=this.lonLatToTile(v,o),s=this.lonLatToTile(k,o),i=this.tileToLonLat(r.x,r.y,o),i=d.projection.def.forward([i.lon+a,i.lat]),i=d.projectedUnitsToPixels({x:i[0],y:i[1]}),F=r.x*l-i.x,N=r.y*l-i.y;h[""+o]||(h[""+o]={tiles:{},isActive:!1,howManyTiles:0,actualTilesCount:0,loaded:!1}),h[""+o].howManyTiles=(s.x-r.x+1)*(s.y-r.y+1),h[""+o].actualTilesCount=0;for(let t=r.x;t<=s.x;t++)for(let e=r.y;e<=s.y;e++)((e,t,i,o,r)=>{var s=e%n,a=t%n,s=s<0?s+n:s,a=a<0?a+n:a;h[""+i].tiles[e+","+t]||f.url&&(s=X(f.url,s,a,i),h[i].loaded=!1,h[""+i].tiles[e+","+t]=p.renderer.image(s,e*l-o,t*l-r,l,l).attr({zIndex:2,opacity:0}).on("load",function(){f.onload&&f.onload.apply(this),i!==(d.zoom<0?0:Math.floor(d.zoom))&&i!==c.minZoom||(h[""+i].actualTilesCount++,h[""+i].howManyTiles===h[""+i].actualTilesCount&&(h[i].loaded=!0,c.isAnimating?c.redrawTiles=!0:(c.redrawTiles=!1,T(M)),h[""+i].actualTilesCount=0))}).add(m[i]),h[""+i].tiles[e+","+t].posX=e,h[""+i].tiles[e+","+t].posY=t,h[""+i].tiles[e+","+t].originalURL=s)})(t,e,o,F,N)}for(const S of Object.keys(h))for(const Z of Object.keys(h[S].tiles))if(d.projection&&d.projection.def){const e=y/u*Math.pow(2,t)/(y/u*Math.pow(2,parseFloat(S))),i=256*e,O=h[S].tiles[Object.keys(h[S].tiles)[0]],{posX:L,posY:R}=h[S].tiles[Z];if(defined(L)&&defined(R)&&defined(O.posX)&&defined(O.posY)){const z=this.tileToLonLat(O.posX,O.posY,parseFloat(S)),C=d.projection.def.forward([z.lon+a,z.lat]),A=d.projectedUnitsToPixels({x:C[0],y:C[1]}),I=O.posX*i-A.x,H=O.posY*i-A.y;if(p.renderer.globalAnimation&&p.hasRendered){const U=Number(h[S].tiles[Z].attr("x")),V=Number(h[S].tiles[Z].attr("y")),W=Number(h[S].tiles[Z].attr("width")),Y=Number(h[S].tiles[Z].attr("height"));c.isAnimating=!0,h[S].tiles[Z].attr({animator:0}).animate({animator:1},{step:(e,t)=>{h[S].tiles[Z].attr({x:U+(L*i-I-U)*t.pos,y:V+(R*i-H-V)*t.pos,width:W+(Math.ceil(i)+1-W)*t.pos,height:Y+(Math.ceil(i)+1-Y)*t.pos})}},function(){c.isAnimating=!1,c.redrawTiles&&(c.redrawTiles=!1,T(M))})}else(c.redrawTiles||parseFloat(S)!==o||(h[S].isActive||parseFloat(S)===o)&&Object.keys(h[S].tiles).map(e=>h[S].tiles[e]).some(e=>0===e.opacity))&&(c.redrawTiles=!1,T(M)),h[S].tiles[Z].attr({x:L*i-I,y:R*i-H,width:Math.ceil(i)+1,height:Math.ceil(i)+1})}}}else error("Highcharts warning: Tiles Provider not defined in the Provider Registry.",!1)}}update(){const e=this["transformGroups"],t=this.chart,i=t.mapView,o=arguments[0],r=o["provider"];if(e&&(e.forEach(e=>{0!==Object.keys(e).length&&e.destroy()}),this.transformGroups=[]),i&&!defined(i.options.projection)&&r&&r.type){const a=TilesProvidersRegistry[r.type];var s;a&&(s=(new a)["initialProjectionName"],i.update({projection:{name:s}}))}super.update.apply(this,arguments)}}TiledWebMapSeries.defaultOptions=merge(MapSeries.defaultOptions,TiledWebMapSeriesDefaults),SeriesRegistry.registerSeriesType("tiledwebmap",TiledWebMapSeries);export default TiledWebMapSeries;