"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var correctFloat=U.correctFloat,error=U.error,extend=U.extend,isNumber=U.isNumber,isObject=U.isObject,isString=U.isString,merge=U.merge,seriesType=U.seriesType,splat=U.splat;import"../mixins/centered-series.js";import drawPoint from"../mixins/draw-point.js";import mixinTreeSeries from"../mixins/tree-series.js";import"../parts/Series.js";import"./treemap.src.js";var CenteredSeriesMixin=H.CenteredSeriesMixin,Series=H.Series,getCenter=CenteredSeriesMixin.getCenter,getColor=mixinTreeSeries.getColor,getLevelOptions=mixinTreeSeries.getLevelOptions,getStartAndEndRadians=CenteredSeriesMixin.getStartAndEndRadians,isBoolean=function(e){return"boolean"==typeof e},noop=H.noop,rad2deg=180/Math.PI,seriesTypes=H.seriesTypes,setTreeValues=mixinTreeSeries.setTreeValues,updateRootId=mixinTreeSeries.updateRootId,range=function(e,t){var r,a=[];if(isNumber(e)&&isNumber(t)&&e<=t)for(r=e;r<=t;r++)a.push(r);return a},calculateLevelSizes=function(e,t){var r,a,i,n,s,o,l,d=isObject(t)?t:{},p=0;return isObject(e)&&(r=merge({},e),o=isNumber(d.from)?d.from:0,l=isNumber(d.to)?d.to:0,i=range(o,l),n=Object.keys(r).filter(function(e){return-1===i.indexOf(+e)}),a=s=isNumber(d.diffRadius)?d.diffRadius:0,i.forEach(function(e){var t=r[e],i=t.levelSize.unit,n=t.levelSize.value;"weight"===i?p+=n:"percentage"===i?(t.levelSize={unit:"pixels",value:n/100*a},s-=t.levelSize.value):"pixels"===i&&(s-=n)}),i.forEach(function(e){var t,a=r[e];"weight"===a.levelSize.unit&&(t=a.levelSize.value,r[e].levelSize={unit:"pixels",value:t/p*s})}),n.forEach(function(e){r[e].levelSize={value:0,unit:"pixels"}})),r},getEndPoint=function(e,t,r,a){return{x:e+Math.cos(r)*a,y:t+Math.sin(r)*a}},layoutAlgorithm=function(e,t,r){var a=e.start,i=e.end-a,n=e.val,s=e.x,o=e.y,l=r&&isObject(r.levelSize)&&isNumber(r.levelSize.value)?r.levelSize.value:0,d=e.r,p=d+l,c=r&&isNumber(r.slicedOffset)?r.slicedOffset:0;return(t||[]).reduce(function(e,t){var r=1/n*t.val*i,u=getEndPoint(s,o,a+r/2,c),h={x:t.sliced?u.x:s,y:t.sliced?u.y:o,innerR:d,r:p,radius:l,start:a,end:a+r};return e.push(h),a=h.end,e},[])},getDlOptions=function(e){var t,r,a=e.point,i=isObject(e.shapeArgs)?e.shapeArgs:{},n=isObject(e.optionsPoint)?e.optionsPoint.dataLabels:{},s=splat(isObject(e.level)?e.level.dataLabels:{})[0],o=merge({style:{}},s,n),l=o.rotationMode;return isNumber(o.rotation)||("auto"!==l&&"circular"!==l||(a.innerArcLength<1&&a.outerArcLength>i.radius?(t=0,a.dataLabelPath&&"circular"===l&&(o.textPath={enabled:!0})):a.innerArcLength>1&&a.outerArcLength>1.5*i.radius?"circular"===l?o.textPath={enabled:!0,attributes:{dy:5}}:l="parallel":(a.dataLabel&&a.dataLabel.textPathWrapper&&"circular"===l&&(o.textPath={enabled:!1}),l="perpendicular")),"auto"!==l&&"circular"!==l&&(t=i.end-(i.end-i.start)/2),o.style.width="parallel"===l?Math.min(2.5*i.radius,(a.outerArcLength+a.innerArcLength)/2):i.radius,"perpendicular"===l&&a.series.chart.renderer.fontMetrics(o.style.fontSize).h>a.outerArcLength&&(o.style.width=1),o.style.width=Math.max(o.style.width-2*(o.padding||0),1),r=t*rad2deg%180,"parallel"===l&&(r-=90),r>90?r-=180:r<-90&&(r+=180),o.rotation=r),o.textPath&&(0===a.shapeExisting.innerR&&o.textPath.enabled?(o.rotation=0,o.textPath.enabled=!1,o.style.width=Math.max(2*a.shapeExisting.r-2*(o.padding||0),1)):a.dlOptions&&a.dlOptions.textPath&&!a.dlOptions.textPath.enabled&&"circular"===l&&(o.textPath.enabled=!0),o.textPath.enabled&&(o.rotation=0,o.style.width=Math.max((a.outerArcLength+a.innerArcLength)/2-2*(o.padding||0),1))),0===o.rotation&&(o.rotation=.001),o},getAnimation=function(e,t){var r=t.point,a=t.radians,i=t.innerR,n=t.idRoot,s=t.idPreviousRoot,o=t.shapeExisting,l=t.shapeRoot,d=t.shapePreviousRoot,p=t.visible,c={},u={end:e.end,start:e.start,innerR:e.innerR,r:e.r,x:e.x,y:e.y};return p?!r.graphic&&d&&((c=n===r.id?{start:a.start,end:a.end}:d.end<=e.start?{start:a.end,end:a.end}:{start:a.start,end:a.start}).innerR=c.r=i):r.graphic&&(s===r.id?u={innerR:i,r:i}:l&&(u=l.end<=o.start?{innerR:i,r:i,start:a.end,end:a.end}:{innerR:i,r:i,start:a.start,end:a.start})),{from:c,to:u}},getDrillId=function(e,t,r){var a;return e.node.isLeaf||(a=t===e.id?r[t].parent:e.id),a},getLevelFromAndTo=function(e){var t=e.level;return{from:t>0?t:1,to:t+e.height}},cbSetTreeValuesBefore=function(e,t){var r=t.mapIdToNode[e.parent],a=t.series,i=a.chart,n=a.points[e.i],s=a.options.colors||i&&i.options.colors,o=getColor(e,{colors:s,colorIndex:a.colorIndex,index:t.index,mapOptionsToLevel:t.mapOptionsToLevel,parentColor:r&&r.color,parentColorIndex:r&&r.colorIndex,series:t.series,siblings:t.siblings});return e.color=o.color,e.colorIndex=o.colorIndex,n&&(n.color=e.color,n.colorIndex=e.colorIndex,e.sliced=e.id!==t.idRoot&&n.sliced),e},sunburstOptions={center:["50%","50%"],colorByPoint:!1,opacity:1,dataLabels:{allowOverlap:!0,defer:!0,rotationMode:"auto",style:{textOverflow:"ellipsis"}},rootId:void 0,levelIsConstant:!0,levelSize:{value:1,unit:"weight"},slicedOffset:10},sunburstSeries={drawDataLabels:noop,drawPoints:function(){var e,t=this,r=t.mapOptionsToLevel,a=t.shapeRoot,i=t.group,n=t.hasRendered,s=t.rootNode,o=t.idPreviousRoot,l=t.nodeMap,d=l[o],p=d&&d.shapeArgs,c=t.points,u=t.startAndEndRadians,h=t.chart,v=h&&h.options&&h.options.chart||{},g=!isBoolean(v.animation)||v.animation,b=t.center,f={x:b[0],y:b[1]},m=b[3]/2,x=t.chart.renderer,y=!1,L=!1,P=!!(g&&n&&s!==o&&t.dataLabelsGroup);P&&(t.dataLabelsGroup.attr({opacity:0}),e=function(){var e=t;y=!0,e.dataLabelsGroup&&e.dataLabelsGroup.animate({opacity:1,visibility:"visible"})}),c.forEach(function(d){var c,v,b=d.node,y=r[b.level],P=d.shapeExisting||{},S=b.shapeArgs||{},A=!(!b.visible||!b.shapeArgs);c=n&&g?getAnimation(S,{center:f,point:d,radians:u,innerR:m,idRoot:s,idPreviousRoot:o,shapeExisting:P,shapeRoot:a,shapePreviousRoot:p,visible:A}):{to:S,from:{}},extend(d,{shapeExisting:S,tooltipPos:[S.plotX,S.plotY],drillId:getDrillId(d,s,l),name:""+(d.name||d.id||d.index),plotX:S.plotX,plotY:S.plotY,value:b.val,isNull:!A}),d.dlOptions=getDlOptions({point:d,level:y,optionsPoint:d.options,shapeArgs:S}),!L&&A&&(L=!0,v=e),d.draw({animatableAttribs:c.to,attribs:extend(c.from,!h.styledMode&&t.pointAttribs(d,d.selected&&"select")),onComplete:v,group:i,renderer:x,shapeType:"arc",shapeArgs:S})}),P&&L?(t.hasRendered=!1,t.options.dataLabels.defer=!0,Series.prototype.drawDataLabels.call(t),t.hasRendered=!0,y&&e()):Series.prototype.drawDataLabels.call(t)},pointAttribs:seriesTypes.column.prototype.pointAttribs,layoutAlgorithm:layoutAlgorithm,setShapeArgs:function(e,t,r){var a,i=e.level+1,n=r[i],s=e.children.filter(function(e){return e.visible});a=this.layoutAlgorithm(t,s,n),s.forEach(function(e,t){var i=a[t],n=i.start+(i.end-i.start)/2,s=i.innerR+(i.r-i.innerR)/2,o=i.end-i.start,l=0===i.innerR&&o>6.28?{x:i.x,y:i.y}:getEndPoint(i.x,i.y,n,s),d=e.val?e.childrenTotal>e.val?e.childrenTotal:e.val:e.childrenTotal;this.points[e.i]&&(this.points[e.i].innerArcLength=o*i.innerR,this.points[e.i].outerArcLength=o*i.r),e.shapeArgs=merge(i,{plotX:l.x,plotY:l.y+4*Math.abs(Math.cos(n))}),e.values=merge(i,{val:d}),e.children.length&&this.setShapeArgs(e,e.values,r)},this)},translate:function(){var e,t,r,a,i=this,n=i.options,s=i.center=getCenter.call(i),o=i.startAndEndRadians=getStartAndEndRadians(n.startAngle,n.endAngle),l=s[3]/2,d=s[2]/2-l,p=updateRootId(i),c=i.nodeMap,u=c&&c[p],h={};i.shapeRoot=u&&u.shapeArgs,Series.prototype.translate.call(i),r=i.tree=i.getTree(),i.renderTraverseUpButton(p),u=(c=i.nodeMap)[p],t=c[isString(u.parent)?u.parent:""];var v=getLevelFromAndTo(u),g=v.from,b=v.to;e=getLevelOptions({from:g,levels:i.options.levels,to:b,defaults:{colorByPoint:n.colorByPoint,dataLabels:n.dataLabels,levelIsConstant:n.levelIsConstant,levelSize:n.levelSize,slicedOffset:n.slicedOffset}}),e=calculateLevelSizes(e,{diffRadius:d,from:g,to:b}),setTreeValues(r,{before:cbSetTreeValuesBefore,idRoot:p,levelIsConstant:n.levelIsConstant,mapOptionsToLevel:e,mapIdToNode:c,points:i.points,series:i}),a=c[""].shapeArgs={end:o.end,r:l,start:o.start,val:u.val,x:s[0],y:s[1]},this.setShapeArgs(t,a,e),i.mapOptionsToLevel=e,i.data.forEach(function(e){h[e.id]&&error(31,!1,i.chart),h[e.id]=!0}),h={}},alignDataLabel:function(e,t,r){if(!r.textPath||!r.textPath.enabled)return seriesTypes.treemap.prototype.alignDataLabel.apply(this,arguments)},animate:function(e){var t,r=this.chart,a=[r.plotWidth/2,r.plotHeight/2],i=r.plotLeft,n=r.plotTop,s=this.group;e?(t={translateX:a[0]+i,translateY:a[1]+n,scaleX:.001,scaleY:.001,rotation:10,opacity:.01},s.attr(t)):(t={translateX:i,translateY:n,scaleX:1,scaleY:1,rotation:0,opacity:1},s.animate(t,this.options.animation))},utils:{calculateLevelSizes:calculateLevelSizes,getLevelFromAndTo:getLevelFromAndTo,range:range}},sunburstPoint={draw:drawPoint,shouldDraw:function(){return!this.isNull},isValid:function(){return!0},getDataLabelPath:function(e){var t,r=this.series.chart.renderer,a=this.shapeExisting,i=a.start,n=a.end,s=i+(n-i)/2,o=s<0&&s>-Math.PI||s>Math.PI,l=a.r+(e.options.distance||0);return i===-Math.PI/2&&correctFloat(n)===correctFloat(1.5*Math.PI)&&(i=-Math.PI+Math.PI/360,n=-Math.PI/360,o=!0),n-i>Math.PI&&(o=!1,t=!0),this.dataLabelPath&&(this.dataLabelPath=this.dataLabelPath.destroy()),this.dataLabelPath=r.arc({open:!0,longArc:t?1:0}).add(e),this.dataLabelPath.attr({start:o?i:n,end:o?n:i,clockwise:+o,x:a.x,y:a.y,r:(l+a.innerR)/2}),this.dataLabelPath}};seriesType("sunburst","treemap",sunburstOptions,sunburstSeries,sunburstPoint);