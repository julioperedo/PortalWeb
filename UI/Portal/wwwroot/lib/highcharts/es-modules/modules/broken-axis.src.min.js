"use strict";import Axis from"../parts/Axis.js";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,find=U.find,fireEvent=U.fireEvent,isArray=U.isArray,isNumber=U.isNumber,pick=U.pick;import"../parts/Series.js";import StackItem from"../parts/Stacking.js";var Series=H.Series,BrokenAxisAdditions=function(){function i(i){this.hasBreaks=!1,this.axis=i}return i.isInBreak=function(i,t){var r=i.repeat||1/0,s=i.from,n=i.to-i.from,e=t>=s?(t-s)%r:r-(s-t)%r;return i.inclusive?e<=n:e<n&&0!==e},i.lin2Val=function(t){var r=this.brokenAxis,s=r&&r.breakArray;if(!s)return t;var n,e,o=t;for(e=0;e<s.length&&!((n=s[e]).from>=o);e++)n.to<o?o+=n.len:i.isInBreak(n,o)&&(o+=n.len);return o},i.val2Lin=function(t){var r=this.brokenAxis,s=r&&r.breakArray;if(!s)return t;var n,e,o=t;for(e=0;e<s.length;e++)if((n=s[e]).to<=t)o-=n.len;else{if(n.from>=t)break;if(i.isInBreak(n,t)){o-=t-n.from;break}}return o},i.prototype.findBreakAt=function(i,t){return find(t,function(t){return t.from<i&&i<t.to})},i.prototype.isInAnyBreak=function(t,r){var s,n,e,o=this.axis,a=o.options.breaks,f=a&&a.length;if(f){for(;f--;)i.isInBreak(a[f],t)&&(s=!0,n||(n=pick(a[f].showPoints,!o.isXAxis)));e=s&&r?s&&!n:s}return e},i.prototype.setBreaks=function(t,r){var s=this,n=s.axis,e=isArray(t)&&!!t.length;n.isDirty=s.hasBreaks!==e,s.hasBreaks=e,n.options.breaks=n.userOptions.breaks=t,n.forceRedraw=!0,n.series.forEach(function(i){i.isDirty=!0}),e||n.val2lin!==i.val2Lin||(delete n.val2lin,delete n.lin2val),e&&(n.userOptions.ordinal=!1,n.lin2val=i.lin2Val,n.val2lin=i.val2Lin,n.setExtremes=function(i,t,r,n,e){if(s.hasBreaks){for(var o,a=this.options.breaks;o=s.findBreakAt(i,a);)i=o.to;for(;o=s.findBreakAt(t,a);)t=o.from;t<i&&(t=i)}Axis.prototype.setExtremes.call(this,i,t,r,n,e)},n.setAxisTranslation=function(t){if(Axis.prototype.setAxisTranslation.call(this,t),s.unitLength=null,s.hasBreaks){var r,e,o,a,f=n.options.breaks||[],k=[],u=[],h=0,c=n.userMin||n.min,p=n.userMax||n.max,l=pick(n.pointRangePadding,0);f.forEach(function(t){e=t.repeat||1/0,i.isInBreak(t,c)&&(c+=t.to%e-c%e),i.isInBreak(t,p)&&(p-=p%e-t.from%e)}),f.forEach(function(i){for(o=i.from,e=i.repeat||1/0;o-e>c;)o-=e;for(;o<c;)o+=e;for(a=o;a<p;a+=e)k.push({value:a,move:"in"}),k.push({value:a+(i.to-i.from),move:"out",size:i.breakSize})}),k.sort(function(i,t){return i.value===t.value?("in"===i.move?0:1)-("in"===t.move?0:1):i.value-t.value}),r=0,o=c,k.forEach(function(i){1===(r+="in"===i.move?1:-1)&&"in"===i.move&&(o=i.value),0===r&&(u.push({from:o,to:i.value,len:i.value-o-(i.size||0)}),h+=i.value-o-(i.size||0))}),n.breakArray=s.breakArray=u,s.unitLength=p-c-h+l,fireEvent(n,"afterBreaks"),n.staticScale?n.transA=n.staticScale:s.unitLength&&(n.transA*=(p-n.min+l)/s.unitLength),l&&(n.minPixelPadding=n.transA*n.minPointOffset),n.min=c,n.max=p}}),pick(r,!0)&&n.chart.redraw()},i}(),BrokenAxis=function(){function i(){}return i.compose=function(i,t){i.keepProps.push("brokenAxis");var r=Series.prototype;r.drawBreaks=function(i,t){var r,s,n,e,o=this,a=o.points;if(i&&i.brokenAxis&&i.brokenAxis.hasBreaks){var f=i.brokenAxis;t.forEach(function(t){r=f&&f.breakArray||[],s=i.isXAxis?i.min:pick(o.options.threshold,i.min),a.forEach(function(o){e=pick(o["stack"+t.toUpperCase()],o[t]),r.forEach(function(t){isNumber(s)&&isNumber(e)&&(n=!1,s<t.from&&e>t.to||s>t.from&&e<t.from?n="pointBreak":(s<t.from&&e>t.from&&e<t.to||s>t.from&&e>t.to&&e<t.from)&&(n="pointInBreak"),n&&fireEvent(i,n,{point:o,brk:t}))})})})}},r.gappedPath=function(){var i=this.currentDataGrouping,t=i&&i.gapSize,r=this.options.gapSize,s=this.points.slice(),n=s.length-1,e=this.yAxis;if(r&&n>0){"value"!==this.options.gapUnit&&(r*=this.basePointRange),t&&t>r&&t>=this.basePointRange&&(r=t);for(var o=void 0,a=void 0;n--;)if(a&&!1!==a.visible||(a=s[n+1]),o=s[n],!1!==a.visible&&!1!==o.visible){if(a.x-o.x>r){var f=(o.x+a.x)/2;s.splice(n+1,0,{isNull:!0,x:f}),e.stacking&&this.options.stacking&&((e.stacking.stacks[this.stackKey][f]=new StackItem(e,e.options.stackLabels,!1,f,this.stack)).total=0)}a=o}}return this.getGraphPath(s)},addEvent(i,"init",function(){this.brokenAxis||(this.brokenAxis=new BrokenAxisAdditions(this))}),addEvent(i,"afterInit",function(){void 0!==this.brokenAxis&&this.brokenAxis.setBreaks(this.options.breaks,!1)}),addEvent(i,"afterSetTickPositions",function(){var i=this.brokenAxis;if(i&&i.hasBreaks){var t,r=this.tickPositions,s=this.tickPositions.info,n=[];for(t=0;t<r.length;t++)i.isInAnyBreak(r[t])||n.push(r[t]);this.tickPositions=n,this.tickPositions.info=s}}),addEvent(i,"afterSetOptions",function(){this.brokenAxis&&this.brokenAxis.hasBreaks&&(this.options.ordinal=!1)}),addEvent(t,"afterGeneratePoints",function(){var i=this,t=i.isDirty,r=i.options.connectNulls,s=i.points,n=i.xAxis,e=i.yAxis;if(t)for(var o=s.length;o--;){var a=s[o],f=!(null===a.y&&!1===r)&&(n&&n.brokenAxis&&n.brokenAxis.isInAnyBreak(a.x,!0)||e&&e.brokenAxis&&e.brokenAxis.isInAnyBreak(a.y,!0));a.visible=!f&&!1!==a.options.visible}}),addEvent(t,"afterRender",function(){this.drawBreaks(this.xAxis,["x"]),this.drawBreaks(this.yAxis,pick(this.pointArrayMap,["y"]))})},i}();BrokenAxis.compose(Axis,Series);export default BrokenAxis;