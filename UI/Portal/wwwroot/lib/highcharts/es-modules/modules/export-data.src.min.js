"use strict";import Axis from"../parts/Axis.js";import Chart from"../parts/Chart.js";import H from"../parts/Globals.js";var doc=H.doc,seriesTypes=H.seriesTypes,win=H.win;import U from"../parts/Utilities.js";var addEvent=U.addEvent,defined=U.defined,extend=U.extend,find=U.find,fireEvent=U.fireEvent,getOptions=U.getOptions,isNumber=U.isNumber,pick=U.pick,setOptions=U.setOptions;import"../mixins/ajax.js";import"../mixins/download-url.js";var downloadURL=H.downloadURL;function htmlencode(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")}function getBlobFromContent(e,t){var o=win.navigator,a=o.userAgent.indexOf("WebKit")>-1&&o.userAgent.indexOf("Chrome")<0,i=win.URL||win.webkitURL||win;try{if(o.msSaveOrOpenBlob&&win.MSBlobBuilder){var n=new win.MSBlobBuilder;return n.append(e),n.getBlob("image/svg+xml")}if(!a)return i.createObjectURL(new win.Blob(["\ufeff"+e],{type:t}))}catch(e){}}setOptions({exporting:{csv:{columnHeaderFormatter:null,dateFormat:"%Y-%m-%d %H:%M:%S",decimalPoint:null,itemDelimiter:null,lineDelimiter:"\n"},showTable:!1,useMultiLevelHeaders:!0,useRowspanHeaders:!0},lang:{downloadCSV:"Download CSV",downloadXLS:"Download XLS",exportData:{categoryHeader:"Category",categoryDatetimeHeader:"DateTime"},viewData:"View data table"}}),addEvent(Chart,"render",function(){this.options&&this.options.exporting&&this.options.exporting.showTable&&!this.options.chart.forExport&&this.viewData()}),Chart.prototype.setUpKeyToAxis=function(){seriesTypes.arearange&&(seriesTypes.arearange.prototype.keyToAxis={low:"y",high:"y"}),seriesTypes.gantt&&(seriesTypes.gantt.prototype.keyToAxis={start:"x",end:"x"})},Chart.prototype.getDataRows=function(e){var t,o,a,i,n,r,s,l,p=this.hasParallelCoordinates,c=this.time,d=this.options.exporting&&this.options.exporting.csv||{},h=this.xAxis,m={},x=[],u=[],f=[],g=this.options.lang.exportData,y=g.categoryHeader,b=g.categoryDatetimeHeader,v=function(t,o,a){if(d.columnHeaderFormatter){var i=d.columnHeaderFormatter(t,o,a);if(!1!==i)return i}return t?t instanceof Axis?t.options.title&&t.options.title.text||(t.dateTime?b:y):e?{columnTitle:a>1?o:t.name,topLevelColumnTitle:t.name}:t.name+(a>1?" ("+o+")":""):y},w=function(e,t,o){var a={},i={};return t.forEach(function(t){var n=(e.keyToAxis&&e.keyToAxis[t]||t)+"Axis",r=isNumber(o)?e.chart[n][o]:e[n];a[t]=r&&r.categories||[],i[t]=r&&r.dateTime}),{categoryMap:a,dateTimeValueAxisMap:i}},T=[];for(n in i=0,this.setUpKeyToAxis(),this.series.forEach(function(t){var o,n,r=t.options.keys,s=t.xAxis,l=r||function(e,t){if(e.data.filter(function(e){return e.name}).length&&t&&!t.categories&&!e.keyToAxis)return e.pointArrayMap&&e.pointArrayMap.filter(function(e){return"x"===e}).length?(e.pointArrayMap.unshift("x"),e.pointArrayMap):["x","y"];return e.pointArrayMap||["y"]}(t,s),x=l.length,g=!t.requireSorting&&{},y=h.indexOf(s),b=w(t,l);if(!1!==t.options.includeInDataExport&&!t.options.isInternal&&!1!==t.visible){for(find(T,function(e){return e[0]===y})||T.push([y,i]),n=0;n<x;)a=v(t,l[n],l.length),f.push(a.columnTitle||a),e&&u.push(a.topLevelColumnTitle||a),n++;o={chart:t.chart,autoIncrement:t.autoIncrement,options:t.options,pointArrayMap:t.pointArrayMap},t.options.data.forEach(function(e,a){var r,h,u,f,v;for(p&&(b=w(t,l,a)),v={series:o},t.pointClass.prototype.applyOptions.apply(v,[e]),r=v.x,f=t.data[a]&&t.data[a].name,n=0,(!s||"name"===t.exportKey||!p&&s&&s.hasNames&&f)&&(r=f),g&&(g[r]&&(r+="|"+a),g[r]=!0),m[r]||(m[r]=[],m[r].xValues=[]),m[r].x=v.x,m[r].name=f,m[r].xValues[y]=v.x;n<x;)u=v[h=l[n]],m[r][i+n]=pick(b.categoryMap[h][u],b.dateTimeValueAxisMap[h]?c.dateFormat(d.dateFormat,u):null,u),n++}),i+=n}}),m)Object.hasOwnProperty.call(m,n)&&x.push(m[n]);for(o=e?[u,f]:[f],i=T.length;i--;)s=T[i][0],l=T[i][1],t=h[s],x.sort(function(e,t){return e.xValues[s]-t.xValues[s]}),r=v(t),o[0].splice(l,0,r),e&&o[1]&&o[1].splice(l,0,r),x.forEach(function(e){var o=e.name;t&&!defined(o)&&(t.dateTime?(e.x instanceof Date&&(e.x=e.x.getTime()),o=c.dateFormat(d.dateFormat,e.x)):o=t.categories?pick(t.names[e.x],t.categories[e.x],e.x):e.x),e.splice(l,0,o)});return o=o.concat(x),fireEvent(this,"exportData",{dataRows:o}),o},Chart.prototype.getCSV=function(e){var t="",o=this.getDataRows(),a=this.options.exporting.csv,i=pick(a.decimalPoint,","!==a.itemDelimiter&&e?1.1.toLocaleString()[1]:"."),n=pick(a.itemDelimiter,","===i?";":","),r=a.lineDelimiter;return o.forEach(function(e,a){for(var s="",l=e.length;l--;)"string"==typeof(s=e[l])&&(s='"'+s+'"'),"number"==typeof s&&"."!==i&&(s=s.toString().replace(".",i)),e[l]=s;t+=e.join(n),a<o.length-1&&(t+=r)}),t},Chart.prototype.getTable=function(e){var t='<table id="highcharts-data-table-'+this.index+'">',o=this.options,a=e?1.1.toLocaleString()[1]:".",i=pick(o.exporting.useMultiLevelHeaders,!0),n=this.getDataRows(i),r=0,s=i?n.shift():null,l=n.shift(),p=function(e,t,o,i){var n=pick(i,""),r="text"+(t?" "+t:"");return"number"==typeof n?(n=n.toString(),","===a&&(n=n.replace(".",a)),r="number"):i||(r="empty"),"<"+e+(o?" "+o:"")+' class="'+r+'">'+n+"</"+e+">"};!1!==o.exporting.tableCaption&&(t+='<caption class="highcharts-table-caption">'+pick(o.exporting.tableCaption,o.title.text?htmlencode(o.title.text):"Chart")+"</caption>");for(var c=0,d=n.length;c<d;++c)n[c].length>r&&(r=n[c].length);t+=function(e,t,a){var n,r,s="<thead>",l=0,c=a||t&&t.length,d=0;if(i&&e&&t&&!function(e,t){var o=e.length;if(t.length!==o)return!1;for(;o--;)if(e[o]!==t[o])return!1;return!0}(e,t)){for(s+="<tr>";l<c;++l)(n=e[l])===e[l+1]?++d:d?(s+=p("th","highcharts-table-topheading",'scope="col" colspan="'+(d+1)+'"',n),d=0):(n===t[l]?o.exporting.useRowspanHeaders?(r=2,delete t[l]):(r=1,t[l]=""):r=1,s+=p("th","highcharts-table-topheading",'scope="col"'+(r>1?' valign="top" rowspan="'+r+'"':""),n));s+="</tr>"}if(t){for(s+="<tr>",l=0,c=t.length;l<c;++l)void 0!==t[l]&&(s+=p("th",null,'scope="col"',t[l]));s+="</tr>"}return s+="</thead>"}(s,l,Math.max(r,l.length)),t+="<tbody>",n.forEach(function(e){t+="<tr>";for(var o=0;o<r;o++)t+=p(o?"td":"th",null,o?"":'scope="row"',e[o]);t+="</tr>"});var h={html:t+="</tbody></table>"};return fireEvent(this,"afterGetTable",h),h.html},Chart.prototype.downloadCSV=function(){var e=this.getCSV(!0);downloadURL(getBlobFromContent(e,"text/csv")||"data:text/csv,\ufeff"+encodeURIComponent(e),this.getFilename()+".csv")},Chart.prototype.downloadXLS=function(){var e,t='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head>\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Ark1</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\x3e<style>td{border:none;font-family: Calibri, sans-serif;} .number{mso-number-format:"0.00";} .text{ mso-number-format:"@";}</style><meta name=ProgId content=Excel.Sheet><meta charset=UTF-8></head><body>'+this.getTable(!0)+"</body></html>";downloadURL(getBlobFromContent(t,"application/vnd.ms-excel")||"data:application/vnd.ms-excel;base64,"+(e=t,win.btoa(unescape(encodeURIComponent(e)))),this.getFilename()+".xls")},Chart.prototype.viewData=function(){this.dataTableDiv||(this.dataTableDiv=doc.createElement("div"),this.dataTableDiv.className="highcharts-data-table",this.renderTo.parentNode.insertBefore(this.dataTableDiv,this.renderTo.nextSibling)),this.dataTableDiv.innerHTML=this.getTable(),fireEvent(this,"afterViewData",this.dataTableDiv)};var exportingOptions=getOptions().exporting;exportingOptions&&(extend(exportingOptions.menuItemDefinitions,{downloadCSV:{textKey:"downloadCSV",onclick:function(){this.downloadCSV()}},downloadXLS:{textKey:"downloadXLS",onclick:function(){this.downloadXLS()}},viewData:{textKey:"viewData",onclick:function(){this.viewData()}}}),exportingOptions.buttons&&exportingOptions.buttons.contextButton.menuItems.push("separator","downloadCSV","downloadXLS","viewData")),seriesTypes.map&&(seriesTypes.map.prototype.exportKey="name"),seriesTypes.mapbubble&&(seriesTypes.mapbubble.prototype.exportKey="name"),seriesTypes.treemap&&(seriesTypes.treemap.prototype.exportKey="name");