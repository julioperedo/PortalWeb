"use strict";import A from"../Animation/AnimationUtilities.js";const{animObject,setAnimation}=A;import F from"../Templating.js";const format=F["format"];import H from"../Globals.js";const marginNames=H["marginNames"];import Point from"../Series/Point.js";import R from"../Renderer/RendererUtilities.js";const distribute=R["distribute"];import U from"../Utilities.js";const{addEvent,createElement,css,defined,discardElement,find,fireEvent,isNumber,merge,pick,relativeLength,stableSort,syncTimeout}=U;class Legend{constructor(t,e){this.allItems=[],this.box=void 0,this.contentGroup=void 0,this.display=!1,this.group=void 0,this.initialItemY=0,this.itemHeight=0,this.itemMarginBottom=0,this.itemMarginTop=0,this.itemX=0,this.itemY=0,this.lastItemY=0,this.lastLineHeight=0,this.legendHeight=0,this.legendWidth=0,this.maxItemWidth=0,this.maxLegendWidth=0,this.offsetWidth=0,this.options=void 0,this.padding=0,this.pages=[],this.proximate=!1,this.scrollGroup=void 0,this.symbolHeight=0,this.symbolWidth=0,this.titleHeight=0,this.totalItemWidth=0,this.widthOption=0,this.chart=t,this.init(t,e)}init(t,e){this.chart=t,this.setOptions(e),e.enabled&&(this.render(),addEvent(this.chart,"endResize",function(){this.legend.positionCheckboxes()})),addEvent(this.chart,"render",()=>{this.options.enabled&&this.proximate&&(this.proximatePositions(),this.positionItems())})}setOptions(t){var e=pick(t.padding,8);this.options=t,this.chart.styledMode||(this.itemStyle=t.itemStyle,this.itemHiddenStyle=merge(this.itemStyle,t.itemHiddenStyle)),this.itemMarginTop=t.itemMarginTop,this.itemMarginBottom=t.itemMarginBottom,this.padding=e,this.initialItemY=e-5,this.symbolWidth=pick(t.symbolWidth,16),this.pages=[],this.proximate="proximate"===t.layout&&!this.chart.inverted,this.baseline=void 0}update(t,e){const i=this.chart;this.setOptions(merge(!0,this.options,t)),this.destroy(),i.isDirtyLegend=i.isDirtyBox=!0,pick(e,!0)&&i.redraw(),fireEvent(this,"afterUpdate",{redraw:e})}colorizeItem(e,i){const{group:t,label:s,line:o,symbol:n}=e.legendItem||{};if(t&&t[i?"removeClass":"addClass"]("highcharts-legend-item-hidden"),!this.chart.styledMode){var h=this["itemHiddenStyle"],r=h.color,a=i&&e.color||r,l=e.options&&e.options.marker;let t={fill:a};s?.css(merge(i?this.itemStyle:h)),o?.attr({stroke:a}),n&&(l&&n.isMarker&&(t=e.pointAttribs(),i||(t.stroke=t.fill=r)),n.attr(t))}fireEvent(this,"afterColorizeItem",{item:e,visible:i})}positionItems(){this.allItems.forEach(this.positionItem,this),this.chart.isResizing||this.positionCheckboxes()}positionItem(t){const{group:e,x:i=0,y:s=0}=t.legendItem||{},o=this.options,n=o.symbolPadding,h=!o.rtl,r=t.checkbox;var a;e&&e.element&&(a={translateX:h?i:this.legendWidth-i-2*n-4,translateY:s},e[defined(e.translateY)?"animate":"attr"](a,void 0,()=>{fireEvent(this,"afterPositionItem",{item:t})})),r&&(r.x=i,r.y=s)}destroyItem(t){const e=t.checkbox,i=t.legendItem||{};for(const s of["group","label","line","symbol"])i[s]&&(i[s]=i[s].destroy());e&&discardElement(e),t.legendItem=void 0}destroy(){var t=this;for(const e of this.getAllItems())this.destroyItem(e);for(const i of["clipRect","up","down","pager","nav","box","title","group"])t[i]&&(t[i]=t[i].destroy());this.display=null}positionCheckboxes(){const s=this.group&&this.group.alignAttr,o=this.clipHeight||this.legendHeight,n=this.titleHeight;let h;s&&(h=s.translateY,this.allItems.forEach(function(t){var e,i=t.checkbox;i&&(e=h+n+i.y+(this.scrollOffset||0)+3,css(i,{left:s.translateX+t.checkboxOffset+i.x-20+"px",top:e+"px",display:this.proximate||e>h-6&&e<h+o-6?"":"none"}))},this))}renderTitle(){var t=this.options,e=this.padding,i=t.title;let s,o=0;i.text&&(this.title||(this.title=this.chart.renderer.label(i.text,e-3,e-4,void 0,void 0,void 0,t.useHTML,void 0,"legend-title").attr({zIndex:1}),this.chart.styledMode||this.title.css(i.style),this.title.add(this.group)),i.width||this.title.css({width:this.maxLegendWidth+"px"}),s=this.title.getBBox(),o=s.height,this.offsetWidth=s.width,this.contentGroup.attr({translateY:o})),this.titleHeight=o}setText(t){const e=this.options;t.legendItem.label.attr({text:e.labelFormat?format(e.labelFormat,t,this.chart):e.labelFormatter.call(t)})}renderItem(t){const e=this,i=t.legendItem=t.legendItem||{},s=e.chart,o=s.renderer,n=e.options,h="horizontal"===n.layout,r=e.symbolWidth,a=n.symbolPadding||0,l=e.itemStyle,d=e.itemHiddenStyle,c=h?pick(n.itemDistance,20):0,m=!n.rtl,g=!t.series,p=!g&&t.series.drawLegendSymbol?t.series:t,f=p.options,u=!!e.createCheckboxForItem&&f&&f.showCheckbox,b=n.useHTML,x=t.options.className;let v=i.label,y=r+a+c+(u?20:0);v||(i.group=o.g("legend-item").addClass("highcharts-"+p.type+"-series highcharts-color-"+t.colorIndex+(x?" "+x:"")+(g?" highcharts-series-"+t.index:"")).attr({zIndex:1}).add(e.scrollGroup),i.label=v=o.text("",m?r+a:-a,e.baseline||0,b),s.styledMode||v.css(merge(t.visible?l:d)),v.attr({align:m?"left":"right",zIndex:2}).add(i.group),e.baseline||(e.fontMetrics=o.fontMetrics(v),e.baseline=e.fontMetrics.f+3+e.itemMarginTop,v.attr("y",e.baseline),e.symbolHeight=pick(n.symbolHeight,e.fontMetrics.f),n.squareSymbol&&(e.symbolWidth=pick(n.symbolWidth,Math.max(e.symbolHeight,16)),y=e.symbolWidth+a+c+(u?20:0),m&&v.attr("x",e.symbolWidth+a))),p.drawLegendSymbol(e,t),e.setItemEvents&&e.setItemEvents(t,v,b)),u&&!t.checkbox&&e.createCheckboxForItem&&e.createCheckboxForItem(t),e.colorizeItem(t,t.visible),!s.styledMode&&l.width||v.css({width:(n.itemWidth||e.widthOption||s.spacingBox.width)-y+"px"}),e.setText(t);var I=v.getBBox(),k=e.fontMetrics&&e.fontMetrics.h||0;t.itemWidth=t.checkboxOffset=n.itemWidth||i.labelWidth||I.width+y,e.maxItemWidth=Math.max(e.maxItemWidth,t.itemWidth),e.totalItemWidth+=t.itemWidth,e.itemHeight=t.itemHeight=Math.round(i.labelHeight||(I.height>1.5*k?I.height:k))}layoutItem(t){const e=this.options,i=this.padding,s="horizontal"===e.layout,o=t.itemHeight,n=this.itemMarginBottom,h=this.itemMarginTop,r=s?pick(e.itemDistance,20):0,a=this.maxLegendWidth,l=e.alignColumns&&this.totalItemWidth>a?this.maxItemWidth:t.itemWidth,d=t.legendItem||{};s&&this.itemX-i+l>a&&(this.itemX=i,this.lastLineHeight&&(this.itemY+=h+this.lastLineHeight+n),this.lastLineHeight=0),this.lastItemY=h+this.itemY+n,this.lastLineHeight=Math.max(o,this.lastLineHeight),d.x=this.itemX,d.y=this.itemY,s?this.itemX+=l:(this.itemY+=h+o+n,this.lastLineHeight=o),this.offsetWidth=this.widthOption||Math.max((s?this.itemX-i-(t.checkbox?0:r):l)+i,this.offsetWidth)}getAllItems(){let i=[];return this.chart.series.forEach(function(t){var e=t&&t.options;t&&pick(e.showInLegend,!defined(e.linkedTo)&&void 0,!0)&&(i=i.concat((t.legendItem||{}).labels||("point"===e.legendType?t.data:t)))}),fireEvent(this,"afterGetAllItems",{allItems:i}),i}getAlignment(){const t=this.options;return this.proximate?t.align.charAt(0)+"tv":t.floating?"":t.align.charAt(0)+t.verticalAlign.charAt(0)+t.layout.charAt(0)}adjustMargins(i,s){const o=this.chart,n=this.options,h=this.getAlignment();h&&[/(lth|ct|rth)/,/(rtv|rm|rbv)/,/(rbh|cb|lbh)/,/(lbv|lm|ltv)/].forEach(function(t,e){t.test(h)&&!defined(i[e])&&(o[marginNames[e]]=Math.max(o[marginNames[e]],o.legend[(e+1)%2?"legendHeight":"legendWidth"]+[1,-1,-1,1][e]*n[e%2?"x":"y"]+pick(n.margin,12)+s[e]+(o.titleOffset[e]||0)))})}proximatePositions(){const h=this.chart,r=[],a="left"===this.options.align;this.allItems.forEach(function(t){let e,i,s=a,o,n;t.yAxis&&(t.xAxis.options.reversed&&(s=!s),t.points&&(e=find(s?t.points:t.points.slice(0).reverse(),function(t){return isNumber(t.plotY)})),i=this.itemMarginTop+t.legendItem.label.getBBox().height+this.itemMarginBottom,n=t.yAxis.top-h.plotTop,t.visible?(o=e?e.plotY:t.yAxis.height,o+=n-.3*i):o=n+t.yAxis.height,r.push({target:o,size:i,item:t}))},this);let t;for(const e of distribute(r,h.plotHeight))t=e.item.legendItem||{},isNumber(e.pos)&&(t.y=h.plotTop-h.spacing[0]+e.pos)}render(){const t=this,e=t.chart,i=e.renderer,s=t.options,o=t.padding,n=t.getAllItems();let h,r,a,l=t.group,d,c=t.box;t.itemX=o,t.itemY=t.initialItemY,t.offsetWidth=0,t.lastItemY=0,t.widthOption=relativeLength(s.width,e.spacingBox.width-o),d=e.spacingBox.width-2*o-s.x,-1<["rm","lm"].indexOf(t.getAlignment().substring(0,2))&&(d/=2),t.maxLegendWidth=t.widthOption||d,l||(t.group=l=i.g("legend").addClass(s.className||"").attr({zIndex:7}).add(),t.contentGroup=i.g().attr({zIndex:1}).add(l),t.scrollGroup=i.g().add(t.contentGroup)),t.renderTitle(),stableSort(n,(t,e)=>(t.options&&t.options.legendIndex||0)-(e.options&&e.options.legendIndex||0)),s.reversed&&n.reverse(),t.allItems=n,t.display=h=!!n.length,t.lastLineHeight=0,t.maxItemWidth=0,t.totalItemWidth=0,t.itemHeight=0,n.forEach(t.renderItem,t),n.forEach(t.layoutItem,t),r=(t.widthOption||t.offsetWidth)+o,a=t.lastItemY+t.lastLineHeight+t.titleHeight,a=t.handleOverflow(a),a+=o,c||(t.box=c=i.rect().addClass("highcharts-legend-box").attr({r:s.borderRadius}).add(l)),e.styledMode||c.attr({stroke:s.borderColor,"stroke-width":s.borderWidth||0,fill:s.backgroundColor||"none"}).shadow(s.shadow),0<r&&0<a&&c[c.placed?"animate":"attr"](c.crisp.call({},{x:0,y:0,width:r,height:a},c.strokeWidth())),l[h?"show":"hide"](),e.styledMode&&"none"===l.getStyle("display")&&(r=a=0),t.legendWidth=r,t.legendHeight=a,h&&t.align(),this.proximate||this.positionItems(),fireEvent(this,"afterRender")}align(t=this.chart.spacingBox){var e=this.chart,i=this.options;let s=t.y;/(lth|ct|rth)/.test(this.getAlignment())&&0<e.titleOffset[0]?s+=e.titleOffset[0]:/(lbh|cb|rbh)/.test(this.getAlignment())&&0<e.titleOffset[2]&&(s-=e.titleOffset[2]),s!==t.y&&(t=merge(t,{y:s})),e.hasRendered||(this.group.placed=!1),this.group.align(merge(i,{width:this.legendWidth,height:this.legendHeight,verticalAlign:this.proximate?"top":i.verticalAlign}),!0,t)}handleOverflow(t){function e(t){"number"==typeof t?I.attr({height:t}):I&&(s.clipRect=I.destroy(),s.contentGroup.clip()),s.contentGroup.div&&(s.contentGroup.div.style.clip=t?"rect("+l+"px,9999px,"+(l+t)+"px,0)":"auto")}function i(t){return s[t]=n.circle(0,0,1.3*g).translate(g/2,g/2).add(y),o.styledMode||s[t].attr("fill","rgba(0,0,0,0.0001)"),s[t]}const s=this,o=this.chart,n=o.renderer,h=this.options,r=h.y,a="top"===h.verticalAlign,l=this.padding,d=h.maxHeight,c=h.navigation,m=pick(c.animation,!0),g=c.arrowSize||12,p=this.pages,f=this.allItems;let u,b,x,v=o.spacingBox.height+(a?-r:r)-l,y=this.nav,I=this.clipRect;return"horizontal"!==h.layout||"middle"===h.verticalAlign||h.floating||(v/=2),d&&(v=Math.min(v,d)),p.length=0,t&&0<v&&t>v&&!1!==c.enabled?(this.clipHeight=u=Math.max(v-20-this.titleHeight-l,0),this.currentPage=pick(this.currentPage,1),this.fullHeight=t,f.forEach((t,e)=>{var t=(x=t.legendItem||{}).y||0,i=Math.round(x.label.getBBox().height);let s=p.length;(!s||t-p[s-1]>u&&(b||t)!==p[s-1])&&(p.push(b||t),s++),x.pageIx=s-1,b&&((f[e-1].legendItem||{}).pageIx=s-1),e===f.length-1&&t+i-p[s-1]>u&&t>p[s-1]&&(p.push(t),x.pageIx=s),t!==b&&(b=t)}),I||(I=s.clipRect=n.clipRect(0,l-2,9999,0),s.contentGroup.clip(I)),e(u),y||(this.nav=y=n.g().attr({zIndex:1}).add(this.group),this.up=n.symbol("triangle",0,0,g,g).add(y),i("upTracker").on("click",function(){s.scroll(-1,m)}),this.pager=n.text("",15,10).addClass("highcharts-legend-navigation"),!o.styledMode&&c.style&&this.pager.css(c.style),this.pager.add(y),this.down=n.symbol("triangle-down",0,0,g,g).add(y),i("downTracker").on("click",function(){s.scroll(1,m)})),s.scroll(0),t=v):y&&(e(),this.nav=y.destroy(),this.scrollGroup.attr({translateY:1}),this.clipHeight=0),t}scroll(t,e){const i=this.chart,s=this.pages,o=s.length,n=this.clipHeight,h=this.options.navigation,r=this.pager,a=this.padding;let l=this.currentPage+t;0<(l=l>o?o:l)&&(void 0!==e&&setAnimation(e,i),this.nav.attr({translateX:a,translateY:n+this.padding+7+this.titleHeight,visibility:"inherit"}),[this.up,this.upTracker].forEach(function(t){t.attr({class:1===l?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})}),r.attr({text:l+"/"+o}),[this.down,this.downTracker].forEach(function(t){t.attr({x:18+this.pager.getBBox().width,class:l===o?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})},this),i.styledMode||(this.up.attr({fill:1===l?h.inactiveColor:h.activeColor}),this.upTracker.css({cursor:1===l?"default":"pointer"}),this.down.attr({fill:l===o?h.inactiveColor:h.activeColor}),this.downTracker.css({cursor:l===o?"default":"pointer"})),this.scrollOffset=-s[l-1]+this.initialItemY,this.scrollGroup.animate({translateY:this.scrollOffset}),this.currentPage=l,this.positionCheckboxes(),t=animObject(pick(e,i.renderer.globalAnimation,!0)),syncTimeout(()=>{fireEvent(this,"afterScroll",{currentPage:l})},t.duration))}setItemEvents(s,t,e){const i=this,o=s.legendItem||{},n=i.chart.renderer.boxWrapper,h=s instanceof Point,r="highcharts-legend-"+(h?"point":"series")+"-active",a=i.chart.styledMode,l=e?[t,o.symbol]:[o.group],d=e=>{i.allItems.forEach(t=>{s!==t&&[t].concat(t.linkedSeries||[]).forEach(t=>{t.setState(e,!h)})})};for(const c of l)c&&c.on("mouseover",function(){s.visible&&d("inactive"),s.setState("hover"),s.visible&&n.addClass(r),a||t.css(i.options.itemHoverStyle)}).on("mouseout",function(){i.chart.styledMode||t.css(merge(s.visible?i.itemStyle:i.itemHiddenStyle)),d(""),n.removeClass(r),s.setState()}).on("click",function(t){function e(){s.setVisible&&s.setVisible(),d(s.visible?"inactive":"")}var i="legendItemClick";n.removeClass(r),t={browserEvent:t},s.firePointEvent?s.firePointEvent(i,t,e):fireEvent(s,i,t,e)})}createCheckboxForItem(e){e.checkbox=createElement("input",{type:"checkbox",className:"highcharts-legend-checkbox",checked:e.selected,defaultChecked:e.selected},this.options.itemCheckboxStyle,this.chart.container),addEvent(e.checkbox,"click",function(t){t=t.target;fireEvent(e.series||e,"checkboxClick",{checked:t.checked,item:e},function(){e.select()})})}}!function(e){const i=[];e.compose=function(t){U.pushUnique(i,t)&&addEvent(t,"beforeMargins",function(){this.legend=new e(this,this.options.legend)})}}(Legend=Legend||{});export default Legend;