"use strict";import AST from"../Renderer/HTML/AST.js";import A from"../Animation/AnimationUtilities.js";const animObject=A["animObject"];import D from"../Defaults.js";const defaultOptions=D["defaultOptions"];import F from"../Templating.js";const format=F["format"];import U from"../Utilities.js";const{addEvent,defined,erase,extend,fireEvent,getNestedProperty,isArray,isFunction,isNumber,isObject,merge,objectEach,pick,syncTimeout,removeEvent,uniqueKey}=U;class Point{constructor(){this.category=void 0,this.destroyed=!1,this.formatPrefix="point",this.id=void 0,this.isNull=!1,this.name=void 0,this.options=void 0,this.percentage=void 0,this.selected=!1,this.series=void 0,this.shapeArgs=void 0,this.total=void 0,this.visible=!0,this.x=void 0}animateBeforeDestroy(){const i=this,s={x:i.startXPos,opacity:0},t=i.getGraphicalProps();t.singular.forEach(function(t){var e="dataLabel"===t;i[t]=i[t].animate(e?{x:i[t].startXPos,y:i[t].startYPos,opacity:0}:s)}),t.plural.forEach(function(t){i[t].forEach(function(t){t.element&&t.animate(extend({x:i.startXPos},t.startYPos?{x:t.startXPos,y:t.startYPos}:{}))})})}applyOptions(t,e){const i=this,s=i.series,o=s.options.pointValKey||s.pointValKey;return t=Point.prototype.optionsToObject.call(this,t),extend(i,t),i.options=i.options?extend(i.options,t):t,t.group&&delete i.group,t.dataLabels&&delete i.dataLabels,o&&(i.y=Point.prototype.getNestedProperty.call(i,o)),i.selected&&(i.state="select"),"name"in i&&void 0===e&&s.xAxis&&s.xAxis.hasNames&&(i.x=s.xAxis.nameToX(i)),void 0===i.x&&s?i.x=void 0===e?s.autoIncrement():e:isNumber(t.x)&&s.options.relativeXValue&&(i.x=s.autoIncrement(t.x)),i.isNull=this.isValid&&!this.isValid(),i.formatPrefix=i.isNull?"null":"point",i}destroy(){if(!this.destroyed){const e=this,i=e.series,s=i.chart,o=i.options.dataSorting,r=s.hoverPoints,a=e.series.chart.renderer.globalAnimation,n=animObject(a);var t=()=>{(e.graphic||e.graphics||e.dataLabel||e.dataLabels)&&(removeEvent(e),e.destroyElements());for(const t in e)delete e[t]};e.legendItem&&s.legend.destroyItem(e),r&&(e.setState(),erase(r,e),r.length||(s.hoverPoints=null)),e===s.hoverPoint&&e.onMouseOut(),o&&o.enabled?(this.animateBeforeDestroy(),syncTimeout(t,n.duration)):t(),s.pointCount--}this.destroyed=!0}destroyElements(t){const e=this,i=e.getGraphicalProps(t);i.singular.forEach(function(t){e[t]=e[t].destroy()}),i.plural.forEach(function(t){e[t].forEach(function(t){t&&t.element&&t.destroy()}),delete e[t]})}firePointEvent(t,e,i){const s=this,o=this.series,r=o.options;(r.point.events[t]||s.options&&s.options.events&&s.options.events[t])&&s.importEvents(),"click"===t&&r.allowPointSelect&&(i=function(t){!s.destroyed&&s.select&&s.select(null,t.ctrlKey||t.metaKey||t.shiftKey)}),fireEvent(s,t,e,i)}getClassName(){var t=this;return"highcharts-point"+(t.selected?" highcharts-point-select":"")+(t.negative?" highcharts-negative":"")+(t.isNull?" highcharts-null-point":"")+(void 0!==t.colorIndex?" highcharts-color-"+t.colorIndex:"")+(t.options.className?" "+t.options.className:"")+(t.zone&&t.zone.className?" "+t.zone.className.replace("highcharts-negative",""):"")}getGraphicalProps(i){const s=this,t=[],o={singular:[],plural:[]};let e,r;for((i=i||{graphic:1,dataLabel:1}).graphic&&t.push("graphic","connector"),i.dataLabel&&t.push("dataLabel","dataLabelPath","dataLabelUpper"),r=t.length;r--;)e=t[r],s[e]&&o.singular.push(e);return["graphic","dataLabel"].forEach(function(t){var e=t+"s";i[t]&&s[e]&&o.plural.push(e)}),o}getLabelConfig(){return{x:this.category,y:this.y,color:this.color,colorIndex:this.colorIndex,key:this.name||this.category,series:this.series,point:this,percentage:this.percentage,total:this.total||this.stackTotal}}getNestedProperty(t){if(t)return 0===t.indexOf("custom.")?getNestedProperty(t,this.options):this[t]}getZone(){var t=this.series,e=t.zones,i=t.zoneAxis||"y";let s,o=0;for(s=e[o];this[i]>=s.value;)s=e[++o];return this.nonZonedColor||(this.nonZonedColor=this.color),s&&s.color&&!this.options.color?this.color=s.color:this.color=this.nonZonedColor,s}hasNewShapeType(){var t=this;return(t.graphic&&(t.graphic.symbolName||t.graphic.element.nodeName))!==this.shapeType}init(t,e,i){return this.series=t,this.applyOptions(e,i),this.id=defined(this.id)?this.id:uniqueKey(),this.resolveColor(),t.chart.pointCount++,fireEvent(this,"afterInit"),this}isValid(){return(isNumber(this.x)||this.x instanceof Date)&&isNumber(this.y)}optionsToObject(t){const e=this.series,i=e.options.keys,s=i||e.pointArrayMap||["y"],o=s.length;let r={},a,n=0,l=0;if(isNumber(t)||null===t)r[s[0]]=t;else if(isArray(t))for(!i&&t.length>o&&("string"==(a=typeof t[0])?r.name=t[0]:"number"==a&&(r.x=t[0]),n++);l<o;)i&&void 0===t[n]||(0<s[l].indexOf(".")?Point.prototype.setNestedProperty(r,t[n],s[l]):r[s[l]]=t[n]),n++,l++;else"object"==typeof t&&((r=t).dataLabels&&(e.hasDataLabels=()=>!0),t.marker&&(e._hasPointMarkers=!0));return r}pos(i,s=this.plotY){if(!this.destroyed){var{plotX:o,series:r}=this,{chart:r,xAxis:a,yAxis:n}=r;let t=0,e=0;if(isNumber(o)&&isNumber(s))return i&&(t=a?a.pos:r.plotLeft,e=n?n.pos:r.plotTop),r.inverted&&a&&n?[n.len-s+e,a.len-o+t]:[o+t,s+e]}}resolveColor(){const t=this.series,e=t.chart.options.chart,i=t.chart.styledMode;let s,o,r=e.colorCount,a;delete this.nonZonedColor,t.options.colorByPoint?(i||(o=t.options.colors||t.chart.options.colors,s=o[t.colorCounter],r=o.length),a=t.colorCounter,t.colorCounter++,t.colorCounter===r&&(t.colorCounter=0)):(i||(s=t.color),a=t.colorIndex),this.colorIndex=pick(this.options.colorIndex,a),this.color=pick(this.options.color,s)}setNestedProperty(t,o,e){const i=e.split(".");return i.reduce(function(t,e,i,s){s=s.length-1===i;return t[e]=s?o:isObject(t[e],!0)?t[e]:{},t[e]},t),t}shouldDraw(){return!this.isNull}tooltipFormatter(e){const t=this.series,i=t.tooltipOptions,s=pick(i.valueDecimals,""),o=i.valuePrefix||"",r=i.valueSuffix||"";return t.chart.styledMode&&(e=t.chart.tooltip.styledModeFormat(e)),(t.pointArrayMap||["y"]).forEach(function(t){t="{point."+t,e=(e=o||r?e.replace(RegExp(t+"}","g"),o+t+"}"+r):e).replace(RegExp(t+"}","g"),t+":,."+s+"f}")}),format(e,{point:this,series:this.series},t.chart)}update(e,i,s,t){const o=this,r=o.series,a=o.graphic,n=r.chart,l=r.options;let c;function h(){o.applyOptions(e);var t=a&&o.hasMockGraphic,t=null===o.y?!t:t;a&&t&&(o.graphic=a.destroy(),delete o.hasMockGraphic),isObject(e,!0)&&(a&&a.element&&e&&e.marker&&void 0!==e.marker.symbol&&(o.graphic=a.destroy()),e?.dataLabels&&o.dataLabel&&(o.dataLabel=o.dataLabel.destroy())),c=o.index,r.updateParallelArrays(o,c),l.data[c]=isObject(l.data[c],!0)||isObject(e,!0)?o.options:pick(e,l.data[c]),r.isDirty=r.isDirtyData=!0,!r.fixedBox&&r.hasCartesianSeries&&(n.isDirtyBox=!0),"point"===l.legendType&&(n.isDirtyLegend=!0),i&&n.redraw(s)}i=pick(i,!0),!1===t?h():o.firePointEvent("update",{options:e},h)}remove(t,e){this.series.removePoint(this.series.data.indexOf(this),t,e)}select(t,e){const i=this,s=i.series,o=s.chart;t=pick(t,!i.selected),this.selectedStaging=t,i.firePointEvent(t?"select":"unselect",{accumulate:e},function(){i.selected=i.options.selected=t,s.options.data[s.data.indexOf(i)]=i.options,i.setState(t&&"select"),e||o.getSelectedPoints().forEach(function(t){const e=t.series;t.selected&&t!==i&&(t.selected=t.options.selected=!1,e.options.data[e.data.indexOf(t)]=t.options,t.setState(o.hoverPoints&&e.options.inactiveOtherPoints?"inactive":""),t.firePointEvent("unselect"))})}),delete this.selectedStaging}onMouseOver(t){const e=this.series,i=e.chart,s=i.pointer;t=t?s.normalize(t):s.getChartCoordinatesFromPoint(this,i.inverted),s.runPointActions(t,this)}onMouseOut(){const t=this.series.chart;this.firePointEvent("mouseOut"),this.series.options.inactiveOtherPoints||(t.hoverPoints||[]).forEach(function(t){t.setState()}),t.hoverPoints=t.hoverPoint=null}importEvents(){if(!this.hasImportedEvents){const i=this,t=merge(i.series.options.point,i.options),e=t.events;i.events=e,objectEach(e,function(t,e){isFunction(t)&&addEvent(i,e,t)}),this.hasImportedEvents=!0}}setState(t,e){const i=this,s=i.series,o=i.state,r=s.options.states[t||"normal"]||{},a=defaultOptions.plotOptions[s.type].marker&&s.options.marker,n=a&&!1===a.enabled,l=a&&a.states&&a.states[t||"normal"]||{},c=!1===l.enabled,h=i.marker||{},p=s.chart,d=a&&s.markerAttribs;let u=s.halo,m,y,f,g=s.stateMarkerGraphic,v;if(!((t=t||"")===i.state&&!e||i.selected&&"select"!==t||!1===r.enabled||t&&(c||n&&!1===l.enabled)||t&&h.states&&h.states[t]&&!1===h.states[t].enabled)){if(i.state=t,d&&(m=s.markerAttribs(i,t)),i.graphic&&!i.hasMockGraphic){if(o&&i.graphic.removeClass("highcharts-point-"+o),t&&i.graphic.addClass("highcharts-point-"+t),!p.styledMode){y=s.pointAttribs(i,t),f=pick(p.options.chart.animation,r.animation);const E=y.opacity;s.options.inactiveOtherPoints&&isNumber(E)&&(i.dataLabels||[]).forEach(function(t){t&&!t.hasClass("highcharts-data-label-hidden")&&(t.animate({opacity:E},f),t.connector&&t.connector.animate({opacity:E},f))}),i.graphic.animate(y,f)}m&&i.graphic.animate(m,pick(p.options.chart.animation,l.animation,a.animation)),g&&g.hide()}else t&&l&&(v=h.symbol||s.symbol,g&&g.currentSymbol!==v&&(g=g.destroy()),m&&(g?g[e?"animate":"attr"]({x:m.x,y:m.y}):v&&(s.stateMarkerGraphic=g=p.renderer.symbol(v,m.x,m.y,m.width,m.height).add(s.markerGroup),g.currentSymbol=v)),!p.styledMode&&g&&"inactive"!==i.state&&g.attr(s.pointAttribs(i,t))),g&&(g[t&&i.isInside?"show":"hide"](),g.element.point=i,g.addClass(i.getClassName(),!0));var b=r.halo,x=i.graphic||g,P=x&&x.visibility||"inherit";b&&b.size&&x&&"hidden"!==P&&!i.isCluster?(u||(s.halo=u=p.renderer.path().add(x.parentGroup)),u.show()[e?"animate":"attr"]({d:i.haloPath(b.size)}),u.attr({class:"highcharts-halo highcharts-color-"+pick(i.colorIndex,s.colorIndex)+(i.className?" "+i.className:""),visibility:P,zIndex:-1}),u.point=i,p.styledMode||u.attr(extend({fill:i.color||s.color,"fill-opacity":b.opacity},AST.filterUserAttributes(b.attributes||{})))):u&&u.point&&u.point.haloPath&&u.animate({d:u.point.haloPath(0)},null,u.hide),fireEvent(i,"afterSetState",{state:t})}}haloPath(t){var e=this.pos();return e?this.series.chart.renderer.symbols.circle(Math.floor(e[0])-t,e[1]-t,2*t,2*t):[]}}export default Point;