"use strict";import F from"./Templating.js";const format=F["format"];import H from"./Globals.js";const{doc,isSafari}=H;import R from"./Renderer/RendererUtilities.js";const distribute=R["distribute"];import RendererRegistry from"./Renderer/RendererRegistry.js";import U from"./Utilities.js";const{addEvent,clamp,css,discardElement,extend,fireEvent,isArray,isNumber,isString,merge,pick,splat,syncTimeout}=U;class Tooltip{constructor(t,e){this.allowShared=!0,this.crosshairs=[],this.distance=0,this.isHidden=!0,this.isSticky=!1,this.now={},this.options={},this.outside=!1,this.chart=t,this.init(t,e)}bodyFormatter(t){return t.map(function(t){const e=t.series.tooltipOptions;return(e[(t.point.formatPrefix||"point")+"Formatter"]||t.point.tooltipFormatter).call(t.point,e[(t.point.formatPrefix||"point")+"Format"]||"")})}cleanSplit(i){this.chart.series.forEach(function(t){const e=t&&t.tt;e&&(!e.isActive||i?t.tt=e.destroy():e.isActive=!1)})}defaultFormatter(t){var e=this.points||splat(this);let i;return(i=(i=[t.tooltipFooterHeaderFormatter(e[0])]).concat(t.bodyFormatter(e))).push(t.tooltipFooterHeaderFormatter(e[0],!0)),i}destroy(){this.label&&(this.label=this.label.destroy()),this.split&&(this.cleanSplit(!0),this.tt&&(this.tt=this.tt.destroy())),this.renderer&&(this.renderer=this.renderer.destroy(),discardElement(this.container)),U.clearTimeout(this.hideTimer),U.clearTimeout(this.tooltipTimeout)}getAnchor(t,o){const e=this.chart,i=e.pointer,r=e.inverted,s=e.plotTop,a=e.plotLeft;let l;if((t=splat(t))[0].series&&t[0].series.yAxis&&!t[0].series.yAxis.options.reversedStacks&&(t=t.slice().reverse()),this.followPointer&&o)void 0===o.chartX&&(o=i.normalize(o)),l=[o.chartX-a,o.chartY-s];else if(t[0].tooltipPos)l=t[0].tooltipPos;else{let e=0,i=0;t.forEach(function(t){t=t.pos(!0);t&&(e+=t[0],i+=t[1])}),e/=t.length,i/=t.length,this.shared&&1<t.length&&o&&(r?e=o.chartX:i=o.chartY),l=[e-a,i-s]}return l.map(Math.round)}getClassName(t,e,i){const o=this.options,r=t.series,s=r.options;return[o.className,"highcharts-label",i&&"highcharts-tooltip-header",e?"highcharts-tooltip-box":"highcharts-tooltip",!i&&"highcharts-color-"+pick(t.colorIndex,r.colorIndex),s&&s.className].filter(isString).join(" ")}getLabel(){const e=this,t=this.chart.styledMode,i=this.options,o=this.split&&this.allowShared;let r=this.container,s=this.chart.renderer;var a;if(this.label&&(a=!this.label.hasClass("highcharts-label"),(!o&&a||o&&!a)&&this.destroy()),!this.label){if(this.outside){const l=this.chart.options.chart.style,n=RendererRegistry.getRendererType();this.container=r=H.doc.createElement("div"),r.className="highcharts-tooltip-container",css(r,{position:"absolute",top:"1px",pointerEvents:"none",zIndex:Math.max(this.options.style.zIndex||0,(l&&l.zIndex||0)+3)}),this.renderer=s=new n(r,0,0,l,void 0,void 0,s.styledMode)}if(o?this.label=s.g("tooltip"):(this.label=s.label("",0,0,i.shape,void 0,void 0,i.useHTML,void 0,"tooltip").attr({padding:i.padding,r:i.borderRadius}),t||this.label.attr({fill:i.backgroundColor,"stroke-width":i.borderWidth||0}).css(i.style).css({pointerEvents:i.style.pointerEvents||(this.shouldStickOnContact()?"auto":"none")})),e.outside){const h=this.label,{xSetter:c,ySetter:d}=h;h.xSetter=function(t){c.call(h,e.distance),r&&(r.style.left=t+"px")},h.ySetter=function(t){d.call(h,e.distance),r&&(r.style.top=t+"px")}}this.label.attr({zIndex:8}).shadow(i.shadow).add()}return r&&!r.parentElement&&H.doc.body.appendChild(r),this.label}getPlayingField(){var{body:t,documentElement:e}=doc,{chart:i,distance:o,outside:r}=this;return{width:r?Math.max(t.scrollWidth,e.scrollWidth,t.offsetWidth,e.offsetWidth,e.clientWidth)-2*o:i.chartWidth,height:r?Math.max(t.scrollHeight,e.scrollHeight,t.offsetHeight,e.offsetHeight,e.clientHeight):i.chartHeight}}getPosition(i,o,r){const s=this.chart,p=this.distance,f={},g=s.inverted&&r.h||0,u=this.outside,t=this.getPlayingField(),a=t.width,l=t.height,n=s.pointer.getChartPosition(),m=t=>t*n.scaleX,x=t=>t*n.scaleY,e=t=>{var e="x"===t;return[t,e?a:l,e?i:o].concat(u?[e?m(i):x(o),e?n.left-p+m(r.plotX+s.plotLeft):n.top-p+x(r.plotY+s.plotTop),0,e?a:l]:[e?i:o,e?r.plotX+s.plotLeft:r.plotY+s.plotTop,e?s.plotLeft:s.plotTop,e?s.plotLeft+s.plotWidth:s.plotTop+s.plotHeight])};let h=e("y"),c=e("x"),d,y=!!r.negative;!s.polar&&s.hoverSeries&&s.hoverSeries.yAxis&&s.hoverSeries.yAxis.reversed&&(y=!y);const b=!this.followPointer&&pick(r.ttBelow,!s.inverted===y),v=function(t,e,i,o,r,s,a){var l=u?("y"===t?x:m)(p):p,n=(i-o)/2,h=o<r-p,c=r+p+o<e,d=r-l-i+n,r=r+l-n;if(b&&c)f[t]=r;else if(!b&&h)f[t]=d;else if(h)f[t]=Math.min(a-o,d-g<0?d:d-g);else{if(!c)return!1;f[t]=Math.max(s,r+g+i>e?r:r+g)}},T=function(t,e,i,o,r){let s;return r<p||r>e-p?s=!1:f[t]=r<i/2?1:e-o/2<r?e-o-2:r-i/2,s},w=function(t){var e=h;h=c,c=e,d=t},S=function(){!1!==v.apply(0,h)?!1!==T.apply(0,c)||d||(w(!0),S()):d?f.x=f.y=0:(w(!0),S())};return(s.inverted||1<this.len)&&w(),S(),f}hide(e){const i=this;U.clearTimeout(this.hideTimer),e=pick(e,this.options.hideDelay),this.isHidden||(this.hideTimer=syncTimeout(function(){const t=i.getLabel();i.getLabel().animate({opacity:0},{duration:e&&150,complete:()=>{t.hide(),i.container&&i.container.remove()}}),i.isHidden=!0},e))}init(t,e){this.chart=t,this.options=e,this.crosshairs=[],this.now={x:0,y:0},this.isHidden=!0,this.split=e.split&&!t.inverted&&!t.polar,this.shared=e.shared||this.split,this.outside=pick(e.outside,Boolean(t.scrollablePixelsX||t.scrollablePixelsY))}shouldStickOnContact(t){return!(this.followPointer||!this.options.stickOnContact||t&&!this.chart.pointer.inClass(t.target,"highcharts-tooltip"))}move(t,e,i,o){const r=this,s=r.now,a=!1!==r.options.animation&&!r.isHidden&&(1<Math.abs(t-s.x)||1<Math.abs(e-s.y)),l=r.followPointer||1<r.len;extend(s,{x:a?(2*s.x+t)/3:t,y:a?(s.y+e)/2:e,anchorX:l?void 0:a?(2*s.anchorX+i)/3:i,anchorY:l?void 0:a?(s.anchorY+o)/2:o}),r.getLabel().attr(s),r.drawTracker(),a&&(U.clearTimeout(this.tooltipTimeout),this.tooltipTimeout=setTimeout(function(){r&&r.move(t,e,i,o)},32))}refresh(t,o){const r=this,s=this.chart,a=r.options,l=s.pointer,n=splat(t),h=n[0],e=[],i=a.format,c=a.formatter||r.defaultFormatter,d=r.shared,p=s.styledMode;let f={};if(a.enabled&&h.series){U.clearTimeout(this.hideTimer),r.allowShared=!(!isArray(t)&&t.series&&t.series.noSharedTooltip),r.followPointer=!r.split&&h.series.tooltipOptions.followPointer;var t=r.getAnchor(t,o),g=t[0],u=t[1];d&&r.allowShared?(l.applyInactiveState(n),n.forEach(function(t){t.setState("hover"),e.push(t.getLabelConfig())}),(f=h.getLabelConfig()).points=e):f=h.getLabelConfig(),this.len=e.length;const x=isString(i)?format(i,f,s):c.call(f,r);var m=h.series;if(this.distance=pick(m.tooltipOptions.distance,16),!1===x)this.hide();else{if(r.split&&r.allowShared)this.renderSplit(x,n);else{let e=g,i=u;if(o&&l.isDirectTouch&&(e=o.chartX-s.plotLeft,i=o.chartY-s.plotTop),!s.polar&&!1!==m.options.clip&&!n.some(t=>l.isDirectTouch||t.series.shouldShowTooltip(e,i)))return void r.hide();{const y=r.getLabel();a.style.width&&!p||y.css({width:(this.outside?this.getPlayingField():s.spacingBox).width+"px"}),y.attr({text:x&&x.join?x.join(""):x}),y.addClass(r.getClassName(h),!0),p||y.attr({stroke:a.borderColor||h.color||m.color||"#666666"}),r.updatePosition({plotX:g,plotY:u,negative:h.negative,ttBelow:h.ttBelow,h:t[2]||0})}}r.isHidden&&r.label&&r.label.attr({opacity:1}).show(),r.isHidden=!1}fireEvent(this,"refresh")}}renderSplit(t,c){const d=this,{chart:e,chart:{chartWidth:i,chartHeight:o,plotHeight:p,plotLeft:f,plotTop:g,pointer:r,scrollablePixelsY:s=0,scrollablePixelsX:a,scrollingContainer:{scrollLeft:l,scrollTop:n}={scrollLeft:0,scrollTop:0},styledMode:u},distance:m,options:x,options:{positioner:y}}=d,b=d.outside&&"number"!=typeof a?doc.documentElement.getBoundingClientRect():{left:l,right:l+i,top:n,bottom:n+o},v=d.getLabel(),T=this.renderer||e.renderer,w=Boolean(e.xAxis[0]&&e.xAxis[0].opposite),{left:h,top:S}=r.getChartPosition();let k=g+n,H,M=p-s;function X(t,e,i,o,r=!0){let s,a;return{x:a=i?(s=w?0:M,clamp(t-o/2,b.left,b.right-o-(d.outside?h:0))):(s=e-k,a=r?t-o-m:t+m,clamp(a,r?a:b.left,b.right)),y:s}}let F=(t=isString(t)?[!1,t]:t).slice(0,c.length+1).reduce(function(t,e,i){if(!1!==e&&""!==e){var i=c[i-1]||{isHeader:!0,plotX:c[0].plotX,plotY:p,series:{}},o=i.isHeader;const n=o?d:i.series,h=n.tt=function(t,e,i){let o=t;var{isHeader:t,series:r}=e;if(!o){const s={padding:x.padding,r:x.borderRadius};u||(s.fill=x.backgroundColor,s["stroke-width"]=x.borderWidth??1),o=T.label("",0,0,x[t?"headerShape":"shape"],void 0,void 0,x.useHTML).addClass(d.getClassName(e,!0,t)).attr(s).add(v)}return o.isActive=!0,o.attr({text:i}),u||o.css(x.style).attr({stroke:x.borderColor||e.color||r.color||"#333333"}),o}(n.tt,i,e.toString());var r,e=h.getBBox(),s=e.width+h.strokeWidth(),{anchorX:a,anchorY:l}=(o&&(H=e.height,M+=H,w&&(k-=H)),function(t){const{isHeader:e,plotX:i=0,plotY:o=0,series:r}=t;let s,a;var l;return e?(s=Math.max(f+i,f),a=g+p/2):({xAxis:t,yAxis:l}=r,s=t.pos+clamp(i,-m,t.len+m),r.shouldShowTooltip(0,l.pos-g+o,{ignoreX:!0})&&(a=l.pos+o)),{anchorX:s=clamp(s,b.left-m,b.right+m),anchorY:a}}(i));"number"==typeof l?(e=e.height+1,r=y?y.call(d,s,e,i):X(a,l,o,s),t.push({align:y?0:void 0,anchorX:a,anchorY:l,boxWidth:s,point:i,rank:pick(r.rank,o?1:0),size:e,target:r.y,tt:h,x:r.x})):h.isActive=!1}return t},[]);!y&&F.some(t=>{var e=d["outside"],e=(e?h:0)+t.anchorX;return e<b.left&&e+t.boxWidth<b.right||e<h-b.left+t.boxWidth&&b.right-e>e})&&(F=F.map(t=>{var{x:e,y:i}=X(t.anchorX,t.anchorY,t.point.isHeader,t.boxWidth,!1);return extend(t,{target:i,x:e})})),d.cleanSplit(),distribute(F,M);const C={left:h,right:h},{container:P,outside:L,renderer:Y}=(F.forEach(function(t){var{x:t,boxWidth:e,isHeader:i}=t;i||(d.outside&&h+t<C.left&&(C.left=h+t),!i&&d.outside&&C.left+e>C.right&&(C.right=h+t))}),F.forEach(function(t){var{x:e,anchorX:i,anchorY:o,pos:r,point:{isHeader:s}}=t;const a={visibility:void 0===r?"hidden":"inherit",x:e,y:(r||0)+k,anchorX:i,anchorY:o};d.outside&&e<i&&(0<(r=h-C.left)&&(s||(a.x=e+r,a.anchorX=i+r),s&&(a.x=(C.right-C.left)/2,a.anchorX=i+r))),t.tt.attr(a)}),d);var E,A,W;L&&P&&Y&&({width:t,height:E,x:A,y:W}=v.getBBox(),Y.setSize(t+A,E+W,!1),P.style.left=C.left+"px",P.style.top=S+"px"),isSafari&&v.attr({opacity:1===v.opacity?.999:1})}drawTracker(){var t=this;if(this.shouldStickOnContact()){var e=t.chart;const o=t.label;var i=t.shared?e.hoverPoints:e.hoverPoint;if(o&&i){const r={x:0,y:0,width:0,height:0},s=this.getAnchor(i);i=o.getBBox();s[0]+=e.plotLeft-(o.translateX||0),s[1]+=e.plotTop-(o.translateY||0),r.x=Math.min(0,s[0]),r.y=Math.min(0,s[1]),r.width=s[0]<0?Math.max(Math.abs(s[0]),i.width-s[0]):Math.max(Math.abs(s[0]),i.width),r.height=s[1]<0?Math.max(Math.abs(s[1]),i.height-Math.abs(s[1])):Math.max(Math.abs(s[1]),i.height),t.tracker?t.tracker.attr(r):(t.tracker=o.renderer.rect(r).addClass("highcharts-tracker").add(o),e.styledMode||t.tracker.attr({fill:"rgba(0,0,0,0)"}))}}else t.tracker&&(t.tracker=t.tracker.destroy())}styledModeFormat(t){return t.replace('style="font-size: 0.8em"','class="highcharts-header"').replace(/style="color:{(point|series)\.color}"/g,'class="highcharts-color-{$1.colorIndex} {series.options.className} {point.options.className}"')}tooltipFooterHeaderFormatter(e,t){const i=e.series,o=i.tooltipOptions,r=i.xAxis,s=r&&r.dateTime,a={isFooter:t,labelConfig:e};let l=o.xDateFormat,n=o[t?"footerFormat":"headerFormat"];return fireEvent(this,"headerFormatter",a,function(t){s&&!l&&isNumber(e.key)&&(l=s.getXDateFormat(e.key,o.dateTimeLabelFormats)),s&&l&&(e.point&&e.point.tooltipDateKeys||["key"]).forEach(function(t){n=n.replace("{point."+t+"}","{point."+t+":"+l+"}")}),i.chart.styledMode&&(n=this.styledModeFormat(n)),t.text=format(n,{point:e,series:i},this.chart)}),a.text}update(t){this.destroy(),this.init(this.chart,merge(!0,this.options,t))}updatePosition(t){const{chart:e,container:i,distance:o,options:r,renderer:s}=this,{height:a=0,width:l=0}=this.getLabel(),n=e.pointer,{left:h,top:c,scaleX:d,scaleY:p}=n.getChartPosition(),f=(r.positioner||this.getPosition).call(this,l,a,t);let g=(t.plotX||0)+e.plotLeft,u=(t.plotY||0)+e.plotTop,m;s&&i&&(r.positioner&&(f.x+=h-o,f.y+=c-o),m=(r.borderWidth||0)+2*o+2,s.setSize(l+m,a+m,!1),1===d&&1===p||(css(i,{transform:`scale(${d}, ${p})`}),g*=d,u*=p),g+=h-f.x,u+=c-f.y),this.move(Math.round(f.x),Math.round(f.y||0),g,u)}}!function(e){const i=[];e.compose=function(t){U.pushUnique(i,t)&&addEvent(t,"afterInit",function(){const t=this.chart;t.options.tooltip&&(t.tooltip=new e(t,t.options.tooltip))})}}(Tooltip=Tooltip||{});export default Tooltip;