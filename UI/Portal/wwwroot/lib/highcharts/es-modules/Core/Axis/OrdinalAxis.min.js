"use strict";import Axis from"./Axis.js";import H from"../Globals.js";import Series from"../Series/Series.js";import U from"../Utilities.js";const{addEvent,correctFloat,css,defined,error,pick,timeUnits}=U,composedMembers=[];var OrdinalAxis;!function(o){function n(t,e,r,i,o=[],n=0,s){const a={},l=this.options.tickPixelInterval,d=this.chart.time,c=[];let p,h,f,g,u,x=0,v=[],m=-Number.MAX_VALUE;if(!this.options.ordinal&&!this.options.breaks||!o||o.length<3||void 0===e)return d.getTimeTicks.apply(d,arguments);var P=o.length;for(p=0;p<P;p++){if(u=p&&o[p-1]>r,o[p]<e&&(x=p),p===P-1||o[p+1]-o[p]>5*n||u){if(o[p]>m){for(h=d.getTimeTicks(t,o[x],o[p],i);h.length&&h[0]<=m;)h.shift();h.length&&(m=h[h.length-1]),c.push(v.length),v=v.concat(h)}x=p+1}if(u)break}if(h){if(g=h.info,s&&g.unitRange<=timeUnits.hour){for(p=v.length-1,x=1;x<p;x++)d.dateFormat("%d",v[x])!==d.dateFormat("%d",v[x-1])&&(a[v[x]]="day",f=!0);f&&(a[v[0]]="day"),g.higherRanks=a}g.segmentStarts=c,v.info=g}else error(12,!1,this.chart);if(s&&defined(l)){const M=v.length,y=[],A=[];let t,e,i,o,n,s=M;for(;s--;)e=this.translate(v[s]),i&&(A[s]=i-e),y[s]=i=e;for(A.sort(),(o=A[Math.floor(A.length/2)])<.6*l&&(o=null),s=v[M-1]>r?M-1:M,i=void 0;s--;)e=y[s],n=Math.abs(i-e),i&&n<.8*l&&(null===o||n<.8*o)?(a[v[s]]&&!a[v[s+1]]?(t=s+1,i=e):t=s,v.splice(t,1)):i=e}return v}function s(t){var e=this.ordinal.positions;if(!e)return t;let i=e.length-1,o;return t<0?t=e[0]:t>i?t=e[i]:(i=Math.floor(t),o=t-i),void 0!==o&&void 0!==e[i]?e[i]+(o?o*(e[i+1]-e[i]):0):t}function r(t){const e=this,i=e.ordinal,o=(e.old||e).min,n=(e.old||e).transA;let s=i.positions;if(!s)return t;var r,a=correctFloat((t-o)*n+e.minPixelPadding),l=t>=s[0]&&t<=s[s.length-1];return(s=l?s:i.getExtendedPositions())&&s.length?(l=-1!==(l=s.indexOf(t))?l:correctFloat(i.getIndexOfPoint(a,s)),a=correctFloat(l%1),0<=l&&l<=s.length-1?(r=s[Math.floor(l)],r=s[Math.ceil(l)]-r,s[Math.floor(l)]+a*r):t):t}function d(t,e){var i=o.Additions.findIndexOf(t,e,!0);return t[i]===e?i:i+(e-t[i])/(t[i+1]-t[i])}function a(){this.ordinal||(this.ordinal=new o.Additions(this))}function l(){var t=this;t.isXAxis&&defined(t.options.overscroll)&&t.max===t.dataMax&&(!t.chart.mouseIsDown||t.isInternal)&&(!t.eventArgs||t.eventArgs&&"navigator"!==t.eventArgs.trigger)&&(t.max+=t.options.overscroll,!t.isInternal&&defined(t.userMin)&&(t.min+=t.options.overscroll))}function c(){var t=this;t.horiz&&!t.isDirty&&(t.isDirty=t.isOrdinal&&t.chart.navigator&&!t.chart.navigator.adaptToUpdatedData)}function p(){var t=this;t.ordinal&&(t.ordinal.beforeSetTickPositions(),t.tickInterval=t.ordinal.postProcessTickInterval(t.tickInterval))}function h(t){const n=this,s=n.xAxis[0],r=s.options.overscroll,a=t.originalEvent.chartX,e=n.options.chart.panning;let l=!1;if(e&&"y"!==e.type&&s.options.ordinal&&s.series.length){const d=n.mouseDownX,c=s.getExtremes(),p=c.dataMax,h=c.min,f=c.max,g=n.hoverPoints,u=s.closestPointRange||s.ordinal&&s.ordinal.overscrollPointsRange,x=s.translationSlope*(s.ordinal.slope||u),v=Math.round((d-a)/x),m=s.ordinal.getExtendedPositions(),P={ordinal:{positions:m,extendedOrdinalPositions:m}},M=s.index2val,y=s.val2lin;let t,e,i,o;P.ordinal.positions?1<Math.abs(v)&&(g&&g.forEach(function(t){t.setState()}),o=v<0?(i=P,s.ordinal.positions?s:P):(i=s.ordinal.positions?s:P,P),p>(e=o.ordinal.positions)[e.length-1]&&e.push(p),n.fixedRange=f-h,(t=s.navigatorAxis.toFixedRange(void 0,void 0,M.apply(i,[y.apply(i,[h,!0])+v]),M.apply(o,[y.apply(o,[f,!0])+v]))).min>=Math.min(c.dataMin,h)&&t.max<=Math.max(p,f)+r&&s.setExtremes(t.min,t.max,!0,!1,{trigger:"pan"}),n.mouseDownX=a,css(n.container,{cursor:"move"})):l=!0}else l=!0;l||e&&/y/.test(e.type)?r&&(s.max=s.dataMax+r):t.preventDefault()}function f(){const t=this.xAxis;t&&t.options.ordinal&&delete t.ordinal.index}function g(t,e){const i=this.ordinal,o=i.positions;let n=i.slope,s;if(!o)return t;var r=o.length;let a;if(o[0]<=t&&o[r-1]>=t)a=d(o,t);else{if(!(s=i.getExtendedPositions&&i.getExtendedPositions())||!s.length)return t;var r=s.length,l=(n=n||(s[r-1]-s[0])/r,d(s,o[0]));if(t>=s[0]&&t<=s[r-1])a=d(s,t)-l;else{if(!e)return t;a=t<s[0]?-l-(s[0]-t)/n:(t-s[r-1])/n+r-l}}return e?a:n*(a||0)+i.offset}o.compose=function(t,e,i){if(U.pushUnique(composedMembers,t)){const o=t.prototype;o.getTimeTicks=n,o.index2val=s,o.lin2val=r,o.val2lin=g,o.ordinal2lin=o.val2lin,addEvent(t,"afterInit",a),addEvent(t,"foundExtremes",l),addEvent(t,"afterSetScale",c),addEvent(t,"initialAxisTranslation",p)}return U.pushUnique(composedMembers,i)&&addEvent(i,"pan",h),U.pushUnique(composedMembers,e)&&addEvent(e,"updatedData",f),t};class u{constructor(t){this.index={},this.axis=t}beforeSetTickPositions(){const t=this.axis,e=t.ordinal,i=t.getExtremes(),o=i.min,n=i.max,s=t.brokenAxis?.hasBreaks,r=t.options.ordinal;let a,l,d,c,p,h,f,g=[],u=Number.MAX_VALUE,x=!1,v=!1,m=!1;if(r||s){let i=0;if(t.series.forEach(function(t,e){if(l=[],0<e&&"highcharts-navigator-series"!==t.options.id&&1<t.processedXData.length&&(v=i!==t.processedXData[1]-t.processedXData[0]),i=t.processedXData[1]-t.processedXData[0],t.boosted&&(m=t.boosted),t.reserveSpace()&&(!1!==t.takeOrdinalPosition||s)&&(g=g.concat(t.processedXData),a=g.length,g.sort(function(t,e){return t-e}),u=Math.min(u,pick(t.closestPointRange,u)),a)){for(e=0;e<a-1;)g[e]!==g[e+1]&&l.push(g[e+1]),e++;l[0]!==g[0]&&l.unshift(g[0]),g=l}}),v&&m&&(g.pop(),g.shift()),2<(a=g.length)){for(d=g[1]-g[0],f=a-1;f--&&!x;)g[f+1]-g[f]!=d&&(x=!0);!t.options.keepOrdinalPadding&&(g[0]-o>d||n-g[g.length-1]>d)&&(x=!0)}else t.options.overscroll&&(2===a?u=g[1]-g[0]:1===a?(u=t.options.overscroll,g=[g[0],g[0]+u]):u=e.overscrollPointsRange);x||t.forceOrdinal?(t.options.overscroll&&(e.overscrollPointsRange=u,g=g.concat(e.getOverscrollPositions())),e.positions=g,c=t.ordinal2lin(Math.max(o,g[0]),!0),p=Math.max(t.ordinal2lin(Math.min(n,g[g.length-1]),!0),1),e.slope=h=(n-o)/(p-c),e.offset=o-c*h):(e.overscrollPointsRange=pick(t.closestPointRange,e.overscrollPointsRange),e.positions=t.ordinal.slope=e.offset=void 0)}t.isOrdinal=r&&x,e.groupIntervalFactor=null}static findIndexOf(t,e,i){let o=0,n=t.length-1,s;for(;o<n;)t[s=Math.ceil((o+n)/2)]<=e?o=s:n=s-1;return t[o]===e||i?o:-1}getExtendedPositions(){const e=this,t=e.axis,i=t.constructor.prototype,o=t.chart,n=t.series[0].currentDataGrouping,s=n?n.count+n.unitName:"raw",r=t.options.overscroll,a=t.getExtremes();let l,d=void 0,c=e.index;return(c=c||(e.index={}))[s]||((l={series:[],chart:o,forceOrdinal:!1,getExtremes:function(){return{min:a.dataMin,max:a.dataMax+r}},applyGrouping:i.applyGrouping,getGroupPixelWidth:i.getGroupPixelWidth,getTimeTicks:i.getTimeTicks,options:{ordinal:!0},ordinal:{getGroupIntervalFactor:this.getGroupIntervalFactor},ordinal2lin:i.ordinal2lin,getIndexOfPoint:i.getIndexOfPoint,val2lin:i.val2lin}).ordinal.axis=l,t.series.forEach(function(t){(d={xAxis:l,xData:t.xData.slice(),chart:o,groupPixelWidth:t.groupPixelWidth,destroyGroupedData:H.noop,getProcessedData:Series.prototype.getProcessedData,applyGrouping:Series.prototype.applyGrouping,reserveSpace:Series.prototype.reserveSpace,visible:t.visible}).xData=d.xData.concat(e.getOverscrollPositions()),d.options={dataGrouping:n?{firstAnchor:"firstPoint",anchor:"middle",lastAnchor:"lastPoint",enabled:!0,forced:!0,approximation:"open",units:[[n.unitName,[n.count]]]}:{enabled:!1}},l.series.push(d),t.processData.apply(d)}),l.applyGrouping({hasExtremesChanged:!0}),d.closestPointRange!==d.basePointRange&&d.currentDataGrouping&&(l.forceOrdinal=!0),t.ordinal.beforeSetTickPositions.apply({axis:l}),c[s]=l.ordinal.positions),c[s]}getGroupIntervalFactor(t,e,i){this.axis;const o=i.processedXData,n=o.length,s=[];let r,a,l=this.groupIntervalFactor;if(!l){for(a=0;a<n-1;a++)s[a]=o[a+1]-o[a];s.sort(function(t,e){return t-e}),r=s[Math.floor(n/2)],t=Math.max(t,o[0]),e=Math.min(e,o[n-1]),this.groupIntervalFactor=l=n*r/(e-t)}return l}getIndexOfPoint(t,e){const i=this,o=i.axis,n=i.positions?i.positions[0]:0;let s;o.series.forEach(t=>{var e=t.points?.[0];defined(e?.plotX)&&(e.plotX<s||!defined(s))&&function(t){const{min:e,max:i}=o;return!(!defined(e)||!defined(i))&&t.points.some(t=>t.x>=e&&t.x<=i)}(t)&&(s=e.plotX)}),s=s??o.minPixelPadding;var r=o.translationSlope*(i.slope||o.closestPointRange||i.overscrollPointsRange),t=correctFloat((t-s)/r);return u.findIndexOf(e,n,!0)+t}getOverscrollPositions(){const t=this.axis,e=t.options.overscroll,i=this.overscrollPointsRange,o=[];let n=t.dataMax;if(defined(i))for(;n<=t.dataMax+e;)n+=i,o.push(n);return o}postProcessTickInterval(t){var e=this.axis,i=this.slope;let o;return o=i?e.options.breaks?e.closestPointRange||t:t/(i/e.closestPointRange):t}}o.Additions=u}(OrdinalAxis=OrdinalAxis||{});export default OrdinalAxis;