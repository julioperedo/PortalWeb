"use strict";import Axis from"./Axis.js";import H from"../Globals.js";const dateFormats=H["dateFormats"];import U from"../Utilities.js";const{addEvent,defined,erase,find,isArray,isNumber,merge,pick,timeUnits,wrap}=U;var GridAxisSide;!function(t){t[t.top=0]="top",t[t.right=1]="right",t[t.bottom=2]="bottom",t[t.left=3]="left"}(GridAxisSide=GridAxisSide||{});const composedMembers=[];function argsToArray(t){return Array.prototype.slice.call(t,1)}function isObject(t){return U.isObject(t,!0)}function applyGridOptions(t){const e=t.options;e.labels.align=pick(e.labels.align,"center"),t.categories||(e.showLastLabel=!1),t.labelRotation=0,e.labels.rotation=0,e.minTickInterval=1}function compose(t,e,i){return U.pushUnique(composedMembers,t)&&(t.keepProps.push("grid"),t.prototype.getMaxLabelDimensions=getMaxLabelDimensions,wrap(t.prototype,"unsquish",wrapUnsquish),addEvent(t,"init",onInit),addEvent(t,"afterGetOffset",onAfterGetOffset),addEvent(t,"afterGetTitlePosition",onAfterGetTitlePosition),addEvent(t,"afterInit",onAfterInit),addEvent(t,"afterRender",onAfterRender),addEvent(t,"afterSetAxisTranslation",onAfterSetAxisTranslation),addEvent(t,"afterSetOptions",onAfterSetOptions),addEvent(t,"afterSetOptions",onAfterSetOptions2),addEvent(t,"afterSetScale",onAfterSetScale),addEvent(t,"afterTickSize",onAfterTickSize),addEvent(t,"trimTicks",onTrimTicks),addEvent(t,"destroy",onDestroy)),U.pushUnique(composedMembers,e)&&addEvent(e,"afterSetChartSize",onChartAfterSetChartSize),U.pushUnique(composedMembers,i)&&(addEvent(i,"afterGetLabelPosition",onTickAfterGetLabelPosition),addEvent(i,"labelFormat",onTickLabelFormat)),t}function getMaxLabelDimensions(r,t){const o={width:0,height:0};return t.forEach(function(t){t=r[t];let e,i=0,n;isObject(t)&&(e=(n=isObject(t.label)?t.label:{}).getBBox?n.getBBox().height:0,n.textStr&&!isNumber(n.textPxLength)&&(n.textPxLength=n.getBBox().width),i=isNumber(n.textPxLength)?Math.round(n.textPxLength):0,n.textStr&&(i=Math.round(n.getBBox().width)),o.height=Math.max(e,o.height),o.width=Math.max(i,o.width))}),"treegrid"===this.options.type&&this.treeGrid&&this.treeGrid.mapOfPosToGridNode&&(t=this.treeGrid.mapOfPosToGridNode[-1].height||0,o.width+=this.options.labels.indentation*(t-1)),o}function onAfterGetOffset(){const t=this["grid"];(t&&t.columns||[]).forEach(function(t){t.getOffset()})}function onAfterGetTitlePosition(t){var e=this;const i=e.options;if(!0===(i.grid||{}).enabled){const{axisTitle:l,height:h,horiz:c,left:f,offset:g,opposite:m,options:i,top:p,width:u}=e;var n=e.tickSize(),r=l&&l.getBBox().width,o=i.title.x,s=i.title.y,a=pick(i.title.margin,c?5:10),d=l?e.chart.renderer.fontMetrics(l).f:0,n=(c?p+h:f)+(c?1:-1)*(m?-1:1)*(n?n[0]/2:0)+(e.side===GridAxisSide.bottom?d:0);t.titlePosition.x=c?f-(r||0)/2-a+o:n+(m?u:0)+g+o,t.titlePosition.y=c?n-(m?h:0)+(m?d:-d)/2+g+s:p-a+s}}function onAfterInit(){var e=this,{chart:i,options:{grid:n={}},userOptions:r}=e;if(n.enabled&&applyGridOptions(e),n.columns){const o=e.grid.columns=[];let t=e.grid.columnIndex=0;for(;++t<n.columns.length;){const s=merge(r,n.columns[n.columns.length-t-1],{isInternal:!0,linkedTo:0,type:"category",scrollbar:{enabled:!1}}),a=(delete s.grid.columns,new Axis(e.chart,s,"yAxis"));a.grid.isColumn=!0,a.grid.columnIndex=t,erase(i.axes,a),erase(i[e.coll]||[],a),o.push(a)}}}function onAfterRender(){const i=this,t=i.grid,e=i.options,n=e.grid||{};if(!0===n.enabled){var r=i.min||0,o=i.max||0;if(i.maxLabelDimensions=i.getMaxLabelDimensions(i.ticks,i.tickPositions),i.rightWall&&i.rightWall.destroy(),i.grid&&i.grid.isOuterAxis()&&i.axisLine){var s=e.lineWidth;if(s){const l=i.getLinePath(s),h=l[0],c=l[1],f=(i.tickSize("tick")||[1])[0],g=(f-1)*(i.side===GridAxisSide.top||i.side===GridAxisSide.left?-1:1);"M"===h[0]&&"L"===c[0]&&(i.horiz?(h[2]+=g,c[2]+=g):(h[1]+=g,c[1]+=g)),!i.horiz&&i.chart.marginRight&&(s=[h,["L",i.left,h[2]||0]],a=["L",i.chart.chartWidth-i.chart.marginRight,i.toPixels(o+i.tickmarkOffset)],a=[["M",c[1]||0,i.toPixels(o+i.tickmarkOffset)],a],i.grid.upperBorder||r%1==0||(i.grid.upperBorder=i.grid.renderBorder(s)),i.grid.upperBorder&&(i.grid.upperBorder.attr({stroke:e.lineColor,"stroke-width":e.lineWidth}),i.grid.upperBorder.animate({d:s})),i.grid.lowerBorder||o%1==0||(i.grid.lowerBorder=i.grid.renderBorder(a)),i.grid.lowerBorder&&(i.grid.lowerBorder.attr({stroke:e.lineColor,"stroke-width":e.lineWidth}),i.grid.lowerBorder.animate({d:a}))),i.grid.axisLineExtra?(i.grid.axisLineExtra.attr({stroke:e.lineColor,"stroke-width":e.lineWidth}),i.grid.axisLineExtra.animate({d:l})):i.grid.axisLineExtra=i.grid.renderBorder(l),i.axisLine[i.showAxis?"show":"hide"]()}}if((t&&t.columns||[]).forEach(t=>t.render()),!i.horiz&&i.chart.hasRendered&&(i.scrollbar||i.linkedParent&&i.linkedParent.scrollbar)){var s=i.tickmarkOffset,a=i.tickPositions[i.tickPositions.length-1],d=i.tickPositions[0];let t,e;for(;(t=i.hiddenLabels.pop())&&t.element;)t.show();for(;(e=i.hiddenMarks.pop())&&e.element;)e.show();(t=i.ticks[d].label)&&(s<r-d?i.hiddenLabels.push(t.hide()):t.show()),(t=i.ticks[a].label)&&(s<a-o?i.hiddenLabels.push(t.hide()):t.show());const m=i.ticks[a].mark;m&&a-o<s&&0<a-o&&i.ticks[a].isLast&&i.hiddenMarks.push(m.hide())}}}function onAfterSetAxisTranslation(){var t=this,e=t.tickPositions&&t.tickPositions.info;const i=t.options;var n=i.grid||{},r=t.userOptions.labels||{};n.enabled&&(t.horiz?(t.series.forEach(t=>{t.options.pointRange=0}),e&&i.dateTimeLabelFormats&&i.labels&&!defined(r.align)&&(!1===i.dateTimeLabelFormats[e.unitName].range||1<e.count)&&(i.labels.align="left",defined(r.x)||(i.labels.x=3))):"treegrid"!==this.options.type&&t.grid&&t.grid.columns&&(this.minPointOffset=this.tickInterval))}function onAfterSetOptions(t){const e=this.options,i=t.userOptions,n=e&&isObject(e.grid)?e.grid:{};let l;!0===n.enabled&&(l=merge(!0,{className:"highcharts-grid-axis "+(i.className||""),dateTimeLabelFormats:{hour:{list:["%H:%M","%H"]},day:{list:["%A, %e. %B","%a, %e. %b","%E"]},week:{list:["Week %W","W%W"]},month:{list:["%B","%b","%o"]}},grid:{borderWidth:1},labels:{padding:2,style:{fontSize:"0.9em"}},margin:0,title:{text:null,reserveSpace:!1,rotation:0},units:[["millisecond",[1,10,100]],["second",[1,10]],["minute",[1,5,15]],["hour",[1,6]],["day",[1]],["week",[1]],["month",[1]],["year",null]]},i),"xAxis"===this.coll&&(defined(i.linkedTo)&&!defined(i.tickPixelInterval)&&(l.tickPixelInterval=350),defined(i.tickPixelInterval)||!defined(i.linkedTo)||defined(i.tickPositioner)||defined(i.tickInterval)||(l.tickPositioner=function(n,r){var o=this.linkedParent&&this.linkedParent.tickPositions&&this.linkedParent.tickPositions.info;if(o){var s=l.units||[];let e,t=1,i="year";for(let t=0;t<s.length;t++){var a=s[t];if(a&&a[0]===o.unitName){e=t;break}}var d=isNumber(e)&&s[e+1],d=(d?(i=d[0]||"year",d=d[1],t=d&&d[0]||1):"year"===o.unitName&&(t=10*o.count),timeUnits[i]);return this.tickInterval=d*t,this.chart.time.getTimeTicks({unitRange:d,count:t,unitName:i},n,r,this.options.startOfWeek)}})),merge(!0,this.options,l),this.horiz&&(e.minPadding=pick(i.minPadding,0),e.maxPadding=pick(i.maxPadding,0)),isNumber(e.grid.borderWidth)&&(e.tickWidth=e.lineWidth=n.borderWidth))}function onAfterSetOptions2(t){var t=t.userOptions,t=t&&t.grid||{},e=t.columns;t.enabled&&e&&merge(!0,this.options,e[e.length-1])}function onAfterSetScale(){(this.grid.columns||[]).forEach(t=>t.setScale())}function onAfterTickSize(t){var e,{horiz:i,maxLabelDimensions:n,options:{grid:r={}}}=this;r.enabled&&n&&(e=2*this.options.labels.distance,i=i?r.cellHeight||e+n.height:e+n.width,isArray(t.tickSize)?t.tickSize[0]=i:t.tickSize=[i,0])}function onChartAfterSetChartSize(){this.axes.forEach(t=>{(t.grid&&t.grid.columns||[]).forEach(t=>{t.setAxisSize(),t.setAxisTranslation()})})}function onDestroy(e){const t=this["grid"];(t.columns||[]).forEach(t=>t.destroy(e.keepEvents)),t.columns=void 0}function onInit(t){var e=this;const i=t.userOptions||{};t=i.grid||{};t.enabled&&defined(t.borderColor)&&(i.tickColor=i.lineColor=t.borderColor),e.grid||(e.grid=new GridAxisAdditions(e)),e.hiddenLabels=[],e.hiddenMarks=[]}function onTickAfterGetLabelPosition(r){const o=this.label,s=this.axis,a=s.reversed,d=s.chart,t=s.options,e=t.grid||{},l=s.options.labels,h=l.align,c=GridAxisSide[s.side],i=r.tickmarkOffset,n=s.tickPositions,f=this.pos-i,g=isNumber(n[r.index+1])?n[r.index+1]-i:(s.max||0)+i,m=s.tickSize("tick"),p=m?m[0]:0,u=m?m[1]/2:0;if(!0===e.enabled){let t,e,i,n;var k,x;"top"===c?(t=s.top+s.offset,e=t-p):"bottom"===c?(e=d.chartHeight-s.bottom+s.offset,t=e+p):(t=s.top+s.len-(s.translate(a?g:f)||0),e=s.top+s.len-(s.translate(a?f:g)||0)),"right"===c?(i=d.chartWidth-s.right+s.offset,n=i+p):"left"===c?(n=s.left+s.offset,i=n-p):(i=Math.round(s.left+(s.translate(a?g:f)||0))-u,n=Math.min(Math.round(s.left+(s.translate(a?f:g)||0))-u,s.left+s.len)),this.slotWidth=n-i,r.pos.x="left"===h?i:"right"===h?n:i+(n-i)/2,r.pos.y=e+(t-e)/2,o&&(k=d.renderer.fontMetrics(o),x=o.getBBox().height,l.useHTML?r.pos.y+=k.b+-x/2:(x=Math.round(x/k.h),r.pos.y+=(k.b-(k.h-k.f))/2+-((x-1)*k.h)/2)),r.pos.x+=s.horiz&&l.x||0}}function onTickLabelFormat(e){const{axis:i,value:n}=e;if(i.options.grid&&i.options.grid.enabled){var r=i.tickPositions;const a=(i.linkedParent||i).series[0];var o=n===r[0],r=n===r[r.length-1],s=a&&find(a.options.data,function(t){return t[i.isXAxis?"x":"y"]===n});let t;s&&a.is("gantt")&&(t=merge(s),H.seriesTypes.gantt.prototype.pointClass.setGanttPointAliases(t)),e.isFirst=o,e.isLast=r,e.point=t}}function onTrimTicks(){var t=this,e=t.options,i=e.grid||{},n=t.categories;const r=t.tickPositions;var o=r[0],s=r[r.length-1],a=t.linkedParent&&t.linkedParent.min,d=t.linkedParent&&t.linkedParent.max,a=a||t.min,d=d||t.max,l=t.tickInterval,s=d<s&&s-l<d;!0!==i.enabled||n||!t.horiz&&!t.isLinked||(o<a&&a<o+l&&!e.startOnTick&&(r[0]=a),s&&!e.endOnTick&&(r[r.length-1]=d))}function wrapUnsquish(t){var{options:{grid:e={}}}=this;return!0===e.enabled&&this.categories?this.tickInterval:t.apply(this,argsToArray(arguments))}class GridAxisAdditions{constructor(t){this.axis=t}isOuterAxis(){const i=this.axis,t=i.chart;var e=i.grid.columnIndex,n=i.linkedParent&&i.linkedParent.grid.columns||i.grid.columns;const r=e?i.linkedParent:i;let o=-1,s=0;return(t[i.coll]||[]).forEach((t,e)=>{t.side!==i.side||t.options.isInternal||(s=e,t===r&&(o=e))}),s===o&&(!isNumber(e)||n.length===e)}renderBorder(t){const e=this.axis,i=e.chart.renderer,n=e.options,r=i.path(t).addClass("highcharts-axis-line").add(e.axisBorder);return i.styledMode||r.attr({stroke:n.lineColor,"stroke-width":n.lineWidth,zIndex:7}),r}}dateFormats.E=function(t){return this.dateFormat("%a",t,!0).charAt(0)},dateFormats.W=function(t){const e=this,i=new this.Date(t);["Hours","Milliseconds","Minutes","Seconds"].forEach(function(t){e.set(t,i,0)});t=(this.get("Day",i)+6)%7;const n=new this.Date(i.valueOf()),r=(this.set("Date",n,this.get("Date",i)-t+3),new this.Date(this.get("FullYear",n),0,1));return 4!==this.get("Day",r)&&(this.set("Month",i,0),this.set("Date",i,1+(11-this.get("Day",r))%7)),(1+Math.floor((n.valueOf()-r.valueOf())/6048e5)).toString()};const GridAxis={compose:compose};export default GridAxis;