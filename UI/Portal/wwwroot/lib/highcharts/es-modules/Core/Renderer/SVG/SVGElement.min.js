"use strict";import A from"../../Animation/AnimationUtilities.js";const{animate,animObject,stop}=A;import Color from"../../Color/Color.js";import H from"../../Globals.js";const{deg2rad,doc,noop,svg,SVG_NS,win}=H;import U from"../../Utilities.js";const{addEvent,attr,createElement,css,defined,erase,extend,fireEvent,isArray,isFunction,isObject,isString,merge,objectEach,pick,pInt,syncTimeout,uniqueKey}=U;class SVGElement{constructor(){this.element=void 0,this.onEvents={},this.opacity=1,this.renderer=void 0,this.SVG_NS=SVG_NS}_defaultGetter(t){let e=pick(this[t+"Value"],this[t],this.element?this.element.getAttribute(t):null,0);return e=/^[\-0-9\.]+$/.test(e)?parseFloat(e):e}_defaultSetter(t,e,i){i.setAttribute(e,t)}add(t){const e=this.renderer,i=this.element;let r;return t&&(this.parentGroup=t),void 0!==this.textStr&&"text"===this.element.nodeName&&e.buildText(this),this.added=!0,(r=t&&!t.handleZ&&!this.zIndex?r:this.zIndexSetter())||(t?t.element:e.box).appendChild(i),this.onAdd&&this.onAdd(),this}addClass(t,e){const i=!e&&this.attr("class")||"";return(t=(t||"").split(/ /g).reduce(function(t,e){return-1===i.indexOf(e)&&t.push(e),t},i?[i]:[]).join(" "))!==i&&this.attr("class",t),this}afterSetters(){this.doTransform&&(this.updateTransform(),this.doTransform=!1)}align(t,e,i){const r={},s=this.renderer,n=s.alignedObjects;let o,a,h,l,d;t?(this.alignOptions=t,this.alignByTranslate=e,i&&!isString(i)||(this.alignTo=h=i||"renderer",erase(n,this),n.push(this),i=void 0)):(t=this.alignOptions,e=this.alignByTranslate,h=this.alignTo),i=pick(i,s[h],"scrollablePlotBox"===h?s.plotBox:void 0,s);var c=t.align,p=t.verticalAlign;return o=(i.x||0)+(t.x||0),a=(i.y||0)+(t.y||0),"right"===c?l=1:"center"===c&&(l=2),l&&(o+=(i.width-(t.width||0))/l),r[e?"translateX":"x"]=Math.round(o),"bottom"===p?d=1:"middle"===p&&(d=2),d&&(a+=(i.height-(t.height||0))/d),r[e?"translateY":"y"]=Math.round(a),this[this.placed?"animate":"attr"](r),this.placed=!0,this.alignAttr=r,this}alignSetter(t){var e={left:"start",center:"middle",right:"end"};e[t]&&(this.alignValue=t,this.element.setAttribute("text-anchor",e[t]))}animate(t,e,i){const r=animObject(pick(e,this.renderer.globalAnimation,!0)),s=r.defer;return doc.hidden&&(r.duration=0),0!==r.duration?(i&&(r.complete=i),syncTimeout(()=>{this.element&&animate(this,t,r)},s)):(this.attr(t,void 0,i||r.complete),objectEach(t,function(t,e){r.step&&r.step.call(this,t,{prop:e,pos:1,elem:this})},this)),this}applyTextOutline(t){const i=this.element,e=-1!==t.indexOf("contrast");var t=(t=e?t.replace(/contrast/g,this.renderer.getContrast(i.style.fill)):t).split(" "),r=t[t.length-1];let s=t[0];if(s&&"none"!==s&&H.svg){this.fakeTS=!0,s=s.replace(/(^[\d\.]+)(.*?)$/g,function(t,e,i){return 2*Number(e)+i}),this.removeTextOutline();const n=doc.createElementNS(SVG_NS,"tspan"),o=(attr(n,{class:"highcharts-text-outline",fill:r,stroke:r,"stroke-width":s,"stroke-linejoin":"round"}),i.querySelector("textPath")||i);[].forEach.call(o.childNodes,t=>{const e=t.cloneNode(!0);e.removeAttribute&&["fill","stroke","stroke-width","stroke"].forEach(t=>e.removeAttribute(t)),n.appendChild(e)});let e=0;[].forEach.call(o.querySelectorAll("text tspan"),t=>{e+=Number(t.getAttribute("dy"))});const a=doc.createElementNS(SVG_NS,"tspan");a.textContent="â€‹",attr(a,{x:Number(i.getAttribute("x")),dy:-e}),n.appendChild(a),o.insertBefore(n,o.firstChild)}}attr(i,t,e,r){const s=this.element,n=SVGElement.symbolCustomAttribs;let o,a,h=this,l,d;return"string"==typeof i&&void 0!==t&&(o=i,(i={})[o]=t),"string"==typeof i?h=(this[i+"Getter"]||this._defaultGetter).call(this,i,s):(objectEach(i,function(t,e){l=!1,r||stop(this,e),this.symbolName&&-1!==n.indexOf(e)&&(a||(this.symbolAttr(i),a=!0),l=!0),!this.rotation||"x"!==e&&"y"!==e||(this.doTransform=!0),l||(d=this[e+"Setter"]||this._defaultSetter).call(this,t,e,s)},this),this.afterSetters()),e&&e.call(this),h}clip(t){return this.attr("clip-path",t?"url("+this.renderer.url+"#"+t.id+")":"none")}crisp(t,e){e=e||t.strokeWidth||0;var i=Math.round(e)%2/2;return t.x=Math.floor(t.x||this.x||0)+i,t.y=Math.floor(t.y||this.y||0)+i,t.width=Math.floor((t.width||this.width||0)-2*i),t.height=Math.floor((t.height||this.height||0)-2*i),defined(t.strokeWidth)&&(t.strokeWidth=e),t}complexColor(t,i,r){const s=this.renderer;let n,o,a,h,l,d,c,p,u,m,f=[],g;fireEvent(this.renderer,"complexColor",{args:arguments},function(){if(t.radialGradient?o="radialGradient":t.linearGradient&&(o="linearGradient"),o){if(a=t[o],l=s.gradients,d=t.stops,u=r.radialReference,isArray(a)&&(t[o]=a={x1:a[0],y1:a[1],x2:a[2],y2:a[3],gradientUnits:"userSpaceOnUse"}),"radialGradient"===o&&u&&!defined(a.gradientUnits)&&(h=a,a=merge(a,s.getRadialAttr(u,h),{gradientUnits:"userSpaceOnUse"})),objectEach(a,function(t,e){"id"!==e&&f.push(e,t)}),objectEach(d,function(t){f.push(t)}),f=f.join(","),l[f])m=l[f].attr("id");else{a.id=m=uniqueKey();const e=l[f]=s.createElement(o).attr(a).add(s.defs);e.radAttr=h,e.stops=[],d.forEach(function(t){p=0===t[1].indexOf("rgba")?(n=Color.parse(t[1]),c=n.get("rgb"),n.get("a")):(c=t[1],1);t=s.createElement("stop").attr({offset:t[0],"stop-color":c,"stop-opacity":p}).add(e);e.stops.push(t)})}g="url("+s.url+"#"+m+")",r.setAttribute(i,g),r.gradient=f,t.toString=function(){return g}}})}css(t){const i=this.styles,r={},e=this.element;let s,n=!i;if(i&&objectEach(t,function(t,e){i&&i[e]!==t&&(r[e]=t,n=!0)}),n){null===(t=i?extend(i,r):t).width||"auto"===t.width?delete this.textWidth:"text"===e.nodeName.toLowerCase()&&t.width&&(s=this.textWidth=pInt(t.width)),this.styles=t,s&&!svg&&this.renderer.forExport&&delete t.width;const o=merge(t);e.namespaceURI===this.SVG_NS&&(["textOutline","textOverflow","width"].forEach(t=>o&&delete o[t]),o.color&&(o.fill=o.color)),css(e,o)}return this.added&&("text"===this.element.nodeName&&this.renderer.buildText(this),t.textOutline&&this.applyTextOutline(t.textOutline)),this}dashstyleSetter(t){let e,i=this["stroke-width"];if("inherit"===i&&(i=1),t=t&&t.toLowerCase()){const r=t.replace("shortdashdotdot","3,1,1,1,1,1,").replace("shortdashdot","3,1,1,1").replace("shortdot","1,1,").replace("shortdash","3,1,").replace("longdash","8,3,").replace(/dot/g,"1,3,").replace("dash","4,3,").replace(/,$/,"").split(",");for(e=r.length;e--;)r[e]=""+pInt(r[e])*pick(i,NaN);t=r.join(",").replace(/NaN/g,"none"),this.element.setAttribute("stroke-dasharray",t)}}destroy(){const i=this,t=i.element||{},e=i.renderer,r=t.ownerSVGElement;let s="SPAN"===t.nodeName&&i.parentGroup||void 0,n,o;if(t.onclick=t.onmouseout=t.onmouseover=t.onmousemove=t.point=null,stop(i),i.clipPath&&r){const a=i.clipPath;[].forEach.call(r.querySelectorAll("[clip-path],[CLIP-PATH]"),function(t){-1<t.getAttribute("clip-path").indexOf(a.element.id)&&t.removeAttribute("clip-path")}),i.clipPath=a.destroy()}if(i.connector=i.connector?.destroy(),i.stops){for(o=0;o<i.stops.length;o++)i.stops[o].destroy();i.stops.length=0,i.stops=void 0}for(i.safeRemoveChild(t);s&&s.div&&0===s.div.childNodes.length;)n=s.parentGroup,i.safeRemoveChild(s.div),delete s.div,s=n;i.alignTo&&erase(e.alignedObjects,i),objectEach(i,function(t,e){i[e]&&i[e].parentGroup===i&&i[e].destroy&&i[e].destroy(),delete i[e]})}dSetter(t,e,i){isArray(t)&&("string"==typeof t[0]&&(t=this.renderer.pathToSegments(t)),t=(this.pathArray=t).reduce((t,e,i)=>e&&e.join?(i?t+" ":"")+e.join(" "):(e||"").toString(),"")),/(NaN| {2}|^$)/.test(t)&&(t="M 0 0"),this[e]!==t&&(i.setAttribute(e,t),this[e]=t)}fillSetter(t,e,i){"string"==typeof t?i.setAttribute(e,t):t&&this.complexColor(t,e,i)}hrefSetter(t,e,i){i.setAttributeNS("http://www.w3.org/1999/xlink",e,t)}getBBox(t,e){const i=this,{alignValue:r,element:s,renderer:n,styles:o,textStr:a}=i,{cache:h,cacheKeys:l}=n,d=s.namespaceURI===i.SVG_NS,c=pick(e,i.rotation,0),p=n.styledMode?s&&SVGElement.prototype.getStyle.call(s,"font-size"):o&&o.fontSize;let u,m,f,g,x;if(defined(a)&&(-1===(x=a.toString()).indexOf("<")&&(x=x.replace(/[0-9]/g,"0")),x+=["",n.rootFontSize,p,c,i.textWidth,r,o&&o.textOverflow,o&&o.fontWeight].join(",")),!(u=x&&!t?h[x]:u)){if(d||n.forExport){try{g=this.fakeTS&&function(t){var e=s.querySelector(".highcharts-text-outline");e&&css(e,{display:t})},isFunction(g)&&g("none"),u=s.getBBox?extend({},s.getBBox()):{width:s.offsetWidth,height:s.offsetHeight,x:0,y:0},isFunction(g)&&g("")}catch(t){}(!u||u.width<0)&&(u={x:0,y:0,width:0,height:0})}else u=i.htmlGetBBox();var y,S,b,v,A,E;m=u.width,f=u.height,d&&(u.height=f={"11px,17":14,"13px,20":16}[`${p||""},`+Math.round(f)]||f),c&&(e=Number(s.getAttribute("y")||0)-u.y,t={right:1,center:.5}[r||0]||0,E=c*deg2rad,A=(c-90)*deg2rad,v=m*Math.cos(E),E=m*Math.sin(E),b=Math.cos(A),A=Math.sin(A),y=u.x+t*(m-v),t=u.y+e-t*E,v=(b=(S=(y=y+e*b)+v)-f*b)-v,E=(A=(e=(t=t+e*A)+E)-f*A)-E,u.x=Math.min(y,S,b,v),u.y=Math.min(t,e,A,E),u.width=Math.max(y,S,b,v)-u.x,u.height=Math.max(t,e,A,E)-u.y)}if(x&&(""===a||0<u.height)){for(;250<l.length;)delete h[l.shift()];h[x]||l.push(x),h[x]=u}return u}getStyle(t){return win.getComputedStyle(this.element||this,"").getPropertyValue(t)}hasClass(t){return-1!==(""+this.attr("class")).split(" ").indexOf(t)}hide(){return this.attr({visibility:"hidden"})}htmlGetBBox(){return{height:0,width:0,x:0,y:0}}init(t,e){this.element="span"===e?createElement(e):doc.createElementNS(this.SVG_NS,e),this.renderer=t,fireEvent(this,"afterInit")}on(t,e){const i=this["onEvents"];return i[t]&&i[t](),i[t]=addEvent(this.element,t,e),this}opacitySetter(t,e,i){t=Number(Number(t).toFixed(3));this.opacity=t,i.setAttribute(e,t)}removeClass(t){return this.attr("class",(""+this.attr("class")).replace(isString(t)?new RegExp(`(^| )${t}( |$)`):t," ").replace(/ +/g," ").trim())}removeTextOutline(){var t=this.element.querySelector("tspan.highcharts-text-outline");t&&this.safeRemoveChild(t)}safeRemoveChild(t){const e=t.parentNode;e&&e.removeChild(t)}setRadialReference(t){const e=this.element.gradient&&this.renderer.gradients[this.element.gradient];return this.element.radialReference=t,e&&e.radAttr&&e.animate(this.renderer.getRadialAttr(t,e.radAttr)),this}setTextPath(s,t){t=merge(!0,{enabled:!0,attributes:{dy:-5,startOffset:"50%",textAnchor:"middle"}},t);const n=this.renderer.url,o=this.text||this,e=o.textPath,{attributes:a,enabled:h}=t;return s=s||e&&e.path,e&&e.undo(),s&&h?(t=addEvent(o,"afterModifyTree",e=>{if(s&&h){let t=s.attr("id");t||s.attr("id",t=uniqueKey());const r={x:0,y:0};defined(a.dx)&&(r.dx=a.dx,delete a.dx),defined(a.dy)&&(r.dy=a.dy,delete a.dy),o.attr(r),this.attr({transform:""}),this.box&&(this.box=this.box.destroy());var i=e.nodes.slice(0);e.nodes.length=0,e.nodes[0]={tagName:"textPath",attributes:extend(a,{"text-anchor":a.textAnchor,href:n+"#"+t}),children:i}}}),o.textPath={path:s,undo:t}):(o.attr({dx:0,dy:0}),delete o.textPath),this.added&&(o.textCache="",this.renderer.buildText(o)),this}shadow(t){const e=this["renderer"],i=merge(90===this.parentGroup?.rotation?{offsetX:-1,offsetY:-1}:{},isObject(t)?t:{}),r=e.shadowDefinition(i);return this.attr({filter:t?`url(${e.url}#${r})`:"none"})}show(t=!0){return this.attr({visibility:t?"inherit":"visible"})}"stroke-widthSetter"(t,e,i){this[e]=t,i.setAttribute(e,t)}strokeWidth(){if(!this.renderer.styledMode)return this["stroke-width"]||0;const t=this.getStyle("stroke-width");let e=0,i;return t.indexOf("px")===t.length-2?e=pInt(t):""!==t&&(i=doc.createElementNS(SVG_NS,"rect"),attr(i,{width:t,"stroke-width":0}),this.element.parentNode.appendChild(i),e=i.getBBox().width,i.parentNode.removeChild(i)),e}symbolAttr(e){const i=this;SVGElement.symbolCustomAttribs.forEach(function(t){i[t]=pick(e[t],i[t])}),i.attr({d:i.renderer.symbols[i.symbolName](i.x,i.y,i.width,i.height,i)})}textSetter(t){t!==this.textStr&&(delete this.textPxLength,this.textStr=t,this.added&&this.renderer.buildText(this))}titleSetter(t){const e=this.element,i=e.getElementsByTagName("title")[0]||doc.createElementNS(this.SVG_NS,"title");e.insertBefore?e.insertBefore(i,e.firstChild):e.appendChild(i),i.textContent=String(pick(t,"")).replace(/<[^>]*>/g,"").replace(/&lt;/g,"<").replace(/&gt;/g,">")}toFront(){const t=this.element;return t.parentNode.appendChild(t),this}translate(t,e){return this.attr({translateX:t,translateY:e})}updateTransform(){const{element:t,matrix:e,rotation:i=0,scaleX:r,scaleY:s,translateX:n=0,translateY:o=0}=this,a=["translate("+n+","+o+")"];defined(e)&&a.push("matrix("+e.join(",")+")"),i&&a.push("rotate("+i+" "+pick(this.rotationOriginX,t.getAttribute("x"),0)+" "+pick(this.rotationOriginY,t.getAttribute("y")||0)+")"),(defined(r)||defined(s))&&a.push("scale("+pick(r,1)+" "+pick(s,1)+")"),a.length&&!(this.text||this).textPath&&t.setAttribute("transform",a.join(" "))}visibilitySetter(t,e,i){"inherit"===t?i.removeAttribute(e):this[e]!==t&&i.setAttribute(e,t),this[e]=t}xGetter(t){return"circle"===this.element.nodeName&&("x"===t?t="cx":"y"===t&&(t="cy")),this._defaultGetter(t)}zIndexSetter(t,e){const i=this.renderer,r=this.parentGroup,s=r||i,n=s.element||i.box,o=this.element,a=n===i.box;let h,l,d,c=!1,p,u=this.added,m;if(defined(t)?(o.setAttribute("data-z-index",t),this[e]===(t=+t)&&(u=!1)):defined(this[e])&&o.removeAttribute("data-z-index"),this[e]=t,u){for((t=this.zIndex)&&r&&(r.handleZ=!0),h=n.childNodes,m=h.length-1;0<=m&&!c;m--)d=(l=h[m]).getAttribute("data-z-index"),p=!defined(d),l!==o&&(t<0&&p&&!a&&!m?(n.insertBefore(o,h[m]),c=!0):(pInt(d)<=t||p&&(!defined(t)||0<=t))&&(n.insertBefore(o,h[m+1]),c=!0));c||(n.insertBefore(o,h[a?3:0]),c=!0)}return c}}SVGElement.symbolCustomAttribs=["anchorX","anchorY","clockwise","end","height","innerR","r","start","width","x","y"],SVGElement.prototype.strokeSetter=SVGElement.prototype.fillSetter,SVGElement.prototype.yGetter=SVGElement.prototype.xGetter,SVGElement.prototype.matrixSetter=SVGElement.prototype.rotationOriginXSetter=SVGElement.prototype.rotationOriginYSetter=SVGElement.prototype.rotationSetter=SVGElement.prototype.scaleXSetter=SVGElement.prototype.scaleYSetter=SVGElement.prototype.translateXSetter=SVGElement.prototype.translateYSetter=SVGElement.prototype.verticalAlignSetter=function(t,e){this[e]=t,this.doTransform=!0};export default SVGElement;