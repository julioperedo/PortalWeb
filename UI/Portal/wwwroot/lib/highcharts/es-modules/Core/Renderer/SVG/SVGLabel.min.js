import SVGElement from"./SVGElement.js";import U from"../../Utilities.js";const{defined,extend,isNumber,merge,pick,removeEvent}=U;class SVGLabel extends SVGElement{constructor(t,i,e,h,s,r,d,n,o,a){super(),this.paddingLeftSetter=this.paddingSetter,this.paddingRightSetter=this.paddingSetter,this.init(t,"g"),this.textStr=i,this.x=e,this.y=h,this.anchorX=r,this.anchorY=d,this.baseline=o,this.className=a,this.addClass("button"===a?"highcharts-no-tooltip":"highcharts-label"),a&&this.addClass("highcharts-"+a),this.text=t.text(void 0,0,0,n).attr({zIndex:1});let x;"string"==typeof s&&((x=/^url\((.*?)\)$/.test(s))||this.renderer.symbols[s])&&(this.symbolKey=s),this.bBox=SVGLabel.emptyBBox,this.padding=3,this.baselineOffset=0,this.needsBox=t.styledMode||x,this.deferredAttr={},this.alignFactor=0}alignSetter(t){t={left:0,center:.5,right:1}[t];t!==this.alignFactor&&(this.alignFactor=t,this.bBox&&isNumber(this.xSetting)&&this.attr({x:this.xSetting}))}anchorXSetter(t,i){this.anchorX=t,this.boxAttr(i,Math.round(t)-this.getCrispAdjust()-this.xSetting)}anchorYSetter(t,i){this.anchorY=t,this.boxAttr(i,t-this.ySetting)}boxAttr(t,i){this.box?this.box.attr(t,i):this.deferredAttr[t]=i}css(i){if(i){const e={};i=merge(i),SVGLabel.textProps.forEach(t=>{void 0!==i[t]&&(e[t]=i[t],delete i[t])}),this.text.css(e),"fontSize"in e||"fontWeight"in e?this.updateTextPadding():("width"in e||"textOverflow"in e)&&this.updateBoxSize()}return SVGElement.prototype.css.call(this,i)}destroy(){removeEvent(this.element,"mouseenter"),removeEvent(this.element,"mouseleave"),this.text&&this.text.destroy(),this.box&&(this.box=this.box.destroy()),SVGElement.prototype.destroy.call(this)}fillSetter(t,i){t&&(this.needsBox=!0),this.fill=t,this.boxAttr(i,t)}getBBox(){this.textStr&&0===this.bBox.width&&0===this.bBox.height&&this.updateBoxSize();var t=this.padding,i=pick(this.paddingLeft,t);return{width:this.width||0,height:this.height||0,x:this.bBox.x-i,y:this.bBox.y-t}}getCrispAdjust(){return this.renderer.styledMode&&this.box?this.box.strokeWidth()%2/2:(this["stroke-width"]?parseInt(this["stroke-width"],10):0)%2/2}heightSetter(t){this.heightSetting=t}onAdd(){this.text.add(this),this.attr({text:pick(this.textStr,""),x:this.x||0,y:this.y||0}),this.box&&defined(this.anchorX)&&this.attr({anchorX:this.anchorX,anchorY:this.anchorY})}paddingSetter(t,i){isNumber(t)?t!==this[i]&&(this[i]=t,this.updateTextPadding()):this[i]=void 0}rSetter(t,i){this.boxAttr(i,t)}strokeSetter(t,i){this.stroke=t,this.boxAttr(i,t)}"stroke-widthSetter"(t,i){t&&(this.needsBox=!0),this["stroke-width"]=t,this.boxAttr(i,t)}"text-alignSetter"(t){this.textAlign=t}textSetter(t){void 0!==t&&this.text.attr({text:t}),this.updateTextPadding()}updateBoxSize(){const t=this.text,i={},e=this.padding,h=this.bBox=isNumber(this.widthSetting)&&isNumber(this.heightSetting)&&!this.textAlign||!defined(t.textStr)?SVGLabel.emptyBBox:t.getBBox();this.width=this.getPaddedWidth(),this.height=(this.heightSetting||h.height||0)+2*e;var s=this.renderer.fontMetrics(t);if(this.baselineOffset=e+Math.min((this.text.firstLineMetrics||s).b,h.height||1/0),this.heightSetting&&(this.baselineOffset+=(this.heightSetting-s.h)/2),this.needsBox&&!t.textPath){if(!this.box){const r=this.box=this.symbolKey?this.renderer.symbol(this.symbolKey):this.renderer.rect();r.addClass(("button"===this.className?"":"highcharts-label-box")+(this.className?" highcharts-"+this.className+"-box":"")),r.add(this)}s=this.getCrispAdjust(),i.x=s,i.y=(this.baseline?-this.baselineOffset:0)+s,i.width=Math.round(this.width),i.height=Math.round(this.height),this.box.attr(extend(i,this.deferredAttr)),this.deferredAttr={}}}updateTextPadding(){const i=this.text;if(!i.textPath){this.updateBoxSize();var e=this.baseline?0:this.baselineOffset;let t=pick(this.paddingLeft,this.padding);defined(this.widthSetting)&&this.bBox&&("center"===this.textAlign||"right"===this.textAlign)&&(t+={center:.5,right:1}[this.textAlign]*(this.widthSetting-this.bBox.width)),t===i.x&&e===i.y||(i.attr("x",t),i.hasBoxWidthChanged&&(this.bBox=i.getBBox(!0)),void 0!==e&&i.attr("y",e)),i.x=t,i.y=e}}widthSetter(t){this.widthSetting=isNumber(t)?t:void 0}getPaddedWidth(){var t=this.padding,i=pick(this.paddingLeft,t),t=pick(this.paddingRight,t);return(this.widthSetting||this.bBox.width||0)+i+t}xSetter(t){this.x=t,this.alignFactor&&(t-=this.alignFactor*this.getPaddedWidth(),this["forceAnimate:x"]=!0),this.xSetting=Math.round(t),this.attr("translateX",this.xSetting)}ySetter(t){this.ySetting=this.y=Math.round(t),this.attr("translateY",this.ySetting)}}SVGLabel.emptyBBox={width:0,height:0,x:0,y:0},SVGLabel.textProps=["color","direction","fontFamily","fontSize","fontStyle","fontWeight","lineHeight","textAlign","textDecoration","textOutline","textOverflow","whiteSpace","width"];export default SVGLabel;