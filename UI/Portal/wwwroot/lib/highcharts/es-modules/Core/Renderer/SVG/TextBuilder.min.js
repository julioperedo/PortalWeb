"use strict";import AST from"../HTML/AST.js";import H from"../../Globals.js";const{doc,SVG_NS,win}=H;import U from"../../Utilities.js";const{attr,extend,fireEvent,isString,objectEach,pick}=U;class TextBuilder{constructor(t){var e=t.styles;this.renderer=t.renderer,this.svgElement=t,this.width=t.textWidth,this.textLineHeight=e&&e.lineHeight,this.textOutline=e&&e.textOutline,this.ellipsis=Boolean(e&&"ellipsis"===e.textOverflow),this.noWrap=Boolean(e&&"nowrap"===e.whiteSpace)}buildSVG(){const t=this.svgElement,e=t.element,i=t.renderer,n=pick(t.textStr,"").toString(),s=-1!==n.indexOf("<"),r=e.childNodes,o=!t.added&&i.box,l=[n,this.ellipsis,this.noWrap,this.textLineHeight,this.textOutline,t.getStyle("font-size"),this.width].join(",");if(l!==t.textCache){t.textCache=l,delete t.actualWidth;for(let t=r.length;t--;)e.removeChild(r[t]);if(s||this.ellipsis||this.width||t.textPath||-1!==n.indexOf(" ")&&(!this.noWrap||/<br.*?>/g.test(n))){if(""!==n){o&&o.appendChild(e);const h=new AST(n);this.modifyTree(h.nodes),h.addToDOM(e),this.modifyDOM(),this.ellipsis&&-1!==(e.textContent||"").indexOf("…")&&t.attr("title",this.unescapeEntities(t.textStr||"",["&lt;","&gt;"])),o&&o.removeChild(e)}}else e.appendChild(doc.createTextNode(this.unescapeEntities(n)));isString(this.textOutline)&&t.applyTextOutline&&t.applyTextOutline(this.textOutline)}}modifyDOM(){const c=this.svgElement,d=attr(c.element,"x");var t;for(c.firstLineMetrics=void 0;(t=c.element.firstChild)&&/^[\s\u200B]*$/.test(t.textContent||" ");)c.element.removeChild(t);[].forEach.call(c.element.querySelectorAll("tspan.highcharts-br"),(t,e)=>{t.nextSibling&&t.previousSibling&&(0===e&&1===t.previousSibling.nodeType&&(c.firstLineMetrics=c.renderer.fontMetrics(t.previousSibling)),attr(t,{dy:this.getLineHeight(t.nextSibling),x:d}))});const g=this.width||0;if(g){const i=(i,n)=>{const t=i.textContent||"",s=t.replace(/([^\^])-/g,"$1- ").split(" ");var e=!this.noWrap&&(1<s.length||1<c.element.childNodes.length);const r=this.getLineHeight(n);let o=0,l=c.actualWidth;if(this.ellipsis)t&&this.truncate(i,t,void 0,0,Math.max(0,g-.8*r),(t,e)=>t.substring(0,e)+"…");else if(e){const h=[],a=[];for(;n.firstChild&&n.firstChild!==i;)a.push(n.firstChild),n.removeChild(n.firstChild);for(;s.length;)s.length&&!this.noWrap&&0<o&&(h.push(i.textContent||""),i.textContent=s.join(" ").replace(/- /g,"-")),this.truncate(i,void 0,s,0===o&&l||0,g,(t,e)=>s.slice(0,e).join(" ").replace(/- /g,"-")),l=c.actualWidth,o++;a.forEach(t=>{n.insertBefore(t,i)}),h.forEach(t=>{n.insertBefore(doc.createTextNode(t),i);const e=doc.createElementNS(SVG_NS,"tspan");e.textContent="​",attr(e,{dy:r,x:d}),n.insertBefore(e,i)})}},n=e=>{const t=[].slice.call(e.childNodes);t.forEach(t=>{t.nodeType===win.Node.TEXT_NODE?i(t,e):(-1!==t.className.baseVal.indexOf("highcharts-br")&&(c.actualWidth=0),n(t))})};n(c.element)}}getLineHeight(t){t=t.nodeType===win.Node.TEXT_NODE?t.parentElement:t;return this.textLineHeight?parseInt(this.textLineHeight.toString(),10):this.renderer.fontMetrics(t||this.svgElement.element).h}modifyTree(h){const a=(t,e)=>{const{attributes:i={},children:n,style:s={},tagName:r}=t,o=this.renderer.styledMode;if("b"===r||"strong"===r?o?i.class="highcharts-strong":s.fontWeight="bold":"i"!==r&&"em"!==r||(o?i.class="highcharts-emphasized":s.fontStyle="italic"),s&&s.color&&(s.fill=s.color),"br"===r){i.class="highcharts-br",t.textContent="​";const l=h[e+1];l&&l.textContent&&(l.textContent=l.textContent.replace(/^ +/gm,""))}else"a"===r&&n&&n.some(t=>"#text"===t.tagName)&&(t.children=[{children:n,tagName:"tspan"}]);"#text"!==r&&"a"!==r&&(t.tagName="tspan"),extend(t,{attributes:i,style:s}),n&&n.filter(t=>"#text"!==t.tagName).forEach(a)};h.forEach(a),fireEvent(this.svgElement,"afterModifyTree",{nodes:h})}truncate(n,t,s,r,e,i){const o=this.svgElement;var l=o["rotation"];const h=[];let a=s?1:0,c=(t||s||"").length,d=c,g,f;function p(t,e){e=e||t;const i=n.parentNode;if(i&&void 0===h[e]&&i.getSubStringLength)try{h[e]=r+i.getSubStringLength(0,s?e+1:e)}catch(t){}return h[e]}if(o.rotation=0,f=p(n.textContent.length),r+f>e){for(;a<=c;)d=Math.ceil((a+c)/2),s&&(g=i(s,d)),f=p(d,g&&g.length-1),a===c?a=c+1:f>e?c=d-1:a=d;0===c?n.textContent="":t&&c===t.length-1||(n.textContent=g||i(t||s,d))}s&&s.splice(0,d),o.actualWidth=f,o.rotation=l}unescapeEntities(i,n){return objectEach(this.renderer.escapes,function(t,e){n&&-1!==n.indexOf(t)||(i=i.toString().replace(new RegExp(t,"g"),e))}),i}}export default TextBuilder;