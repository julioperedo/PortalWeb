"use strict";import Color from"./Color/Color.js";const color=Color["parse"];import H from"./Globals.js";const{charts,noop}=H;import U from"./Utilities.js";const{addEvent,attr,css,defined,extend,find,fireEvent,isNumber,isObject,objectEach,offset,pick,splat}=U;class Pointer{constructor(t,e){this.lastValidTouch={},this.pinchDown=[],this.runChartClick=!1,this.eventsToUnbind=[],this.chart=t,this.hasDragged=!1,this.options=e,this.init(t,e)}applyInactiveState(t){let e=[],o;(t||[]).forEach(function(t){o=t.series,e.push(o),o.linkedParent&&e.push(o.linkedParent),o.linkedSeries&&(e=e.concat(o.linkedSeries)),o.navigatorSeries&&e.push(o.navigatorSeries)}),this.chart.series.forEach(function(t){-1===e.indexOf(t)?t.setState("inactive",!0):t.options.inactiveOtherPoints&&t.setAllPointsToState("inactive")})}destroy(){const o=this;this.eventsToUnbind.forEach(t=>t()),this.eventsToUnbind=[],H.chartCount||(Pointer.unbindDocumentMouseUp&&(Pointer.unbindDocumentMouseUp=Pointer.unbindDocumentMouseUp()),Pointer.unbindDocumentTouchEnd&&(Pointer.unbindDocumentTouchEnd=Pointer.unbindDocumentTouchEnd())),clearInterval(o.tooltipTimeout),objectEach(o,function(t,e){o[e]=void 0})}getSelectionMarkerAttrs(h,c){var t={args:{chartX:h,chartY:c},attrs:{},shapeType:"rect"};return fireEvent(this,"getSelectionMarkerAttrs",t,t=>{const{chart:e,mouseDownX:o=0,mouseDownY:i=0,zoomHor:n,zoomVert:s}=this,r=t.attrs;let a;r.x=e.plotLeft,r.y=e.plotTop,r.width=n?1:e.plotWidth,r.height=s?1:e.plotHeight,n&&(a=h-o,r.width=Math.abs(a),r.x=(0<a?0:a)+o),s&&(a=c-i,r.height=Math.abs(a),r.y=(0<a?0:a)+i)}),t}drag(t){const e=this.chart,o=e.options.chart,i=e.plotLeft,n=e.plotTop,s=e.plotWidth,r=e.plotHeight,a=this.mouseDownX||0,h=this.mouseDownY||0,c=isObject(o.panning)?o.panning&&o.panning.enabled:o.panning,l=o.panKey&&t[o.panKey+"Key"];let u=t.chartX,d=t.chartY,p,v=this.selectionMarker;var m,f;v&&v.touch||(u<i?u=i:u>i+s&&(u=i+s),d<n?d=n:d>n+r&&(d=n+r),this.hasDragged=Math.sqrt(Math.pow(a-u,2)+Math.pow(h-d,2)),10<this.hasDragged&&(p=e.isInsidePlot(a-i,h-n,{visiblePlotOnly:!0}),{shapeType:m,attrs:f}=this.getSelectionMarkerAttrs(u,d),!e.hasCartesianSeries&&!e.mapView||!this.zoomX&&!this.zoomY||!p||l||v||(this.selectionMarker=v=e.renderer[m](),v.attr({class:"highcharts-selection-marker",zIndex:7}).add(),e.styledMode||v.attr({fill:o.selectionMarkerFill||color("#334eff").setOpacity(.25).get()})),v&&v.attr(f),p&&!v&&c&&e.pan(t,o.panning)))}dragStart(t){const e=this.chart;e.mouseIsDown=t.type,e.cancelClick=!1,e.mouseDownX=this.mouseDownX=t.chartX,e.mouseDownY=this.mouseDownY=t.chartY}getSelectionBox(e){var t={args:{marker:e},result:{}};return fireEvent(this,"getSelectionBox",t,t=>{t.result={x:e.attr?+e.attr("x"):e.x,y:e.attr?+e.attr("y"):e.y,width:e.attr?e.attr("width"):e.width,height:e.attr?e.attr("height"):e.height}}),t.result}drop(s){const r=this,e=this.chart,a=this.hasPinched;if(this.selectionMarker){const{x:h,y:c,width:l,height:u}=this.getSelectionBox(this.selectionMarker),d={originalEvent:s,xAxis:[],yAxis:[],x:h,y:c,width:l,height:u};let n=Boolean(e.mapView);(this.hasDragged||a)&&(e.axes.forEach(function(t){var e,o,i;t.zoomEnabled&&defined(t.min)&&(a||r[{xAxis:"zoomX",yAxis:"zoomY"}[t.coll]])&&isNumber(h)&&isNumber(c)&&isNumber(l)&&isNumber(u)&&(i=t.horiz,e="touchend"===s.type?t.minPixelPadding:0,o=t.toValue((i?h:c)+e),i=t.toValue((i?h+l:c+u)-e),d[t.coll].push({axis:t,min:Math.min(o,i),max:Math.max(o,i)}),n=!0)}),n&&fireEvent(e,"selection",d,function(t){e.zoom(extend(t,a?{animation:!1}:null))})),isNumber(e.index)&&(this.selectionMarker=this.selectionMarker.destroy()),a&&this.scaleGroups()}e&&isNumber(e.index)&&(css(e.container,{cursor:e._cursor}),e.cancelClick=10<+this.hasDragged,e.mouseIsDown=this.hasDragged=this.hasPinched=!1,this.pinchDown=[])}findNearestKDPoint(t,r,o){let i;return t.forEach(function(t){var e=!(t.noSharedTooltip&&r)&&t.options.findNearestPointBy.indexOf("y")<0,t=t.searchPoint(o,e);isObject(t,!0)&&t.series&&(!isObject(i,!0)||0<function(t,e){var o=t.distX-e.distX,i=t.dist-e.dist,n=(e.series.group&&e.series.group.zIndex)-(t.series.group&&t.series.group.zIndex);let s;return s=0!=o&&r?o:0!=i?i:0!=n?n:t.series.index>e.series.index?-1:1}(i,t))&&(i=t)}),i}getChartCoordinatesFromPoint(o,i){var n=o.series,s=n.xAxis,n=n.yAxis,r=o.shapeArgs;if(s&&n){let t=pick(o.clientX,o.plotX),e=o.plotY||0;return o.isNode&&r&&isNumber(r.x)&&isNumber(r.y)&&(t=r.x,e=r.y),i?{chartX:n.len+n.pos-e,chartY:s.len+s.pos-t}:{chartX:t+s.pos,chartY:e+n.pos}}if(r&&r.x&&r.y)return{chartX:r.x,chartY:r.y}}getChartPosition(){if(this.chartPosition)return this.chartPosition;var t=this.chart["container"],e=offset(t),o=(this.chartPosition={left:e.left,top:e.top,scaleX:1,scaleY:1},t.offsetWidth),t=t.offsetHeight;return 2<o&&2<t&&(this.chartPosition.scaleX=e.width/o,this.chartPosition.scaleY=e.height/t),this.chartPosition}getCoordinates(e){const o={xAxis:[],yAxis:[]};return this.chart.axes.forEach(function(t){o[t.isXAxis?"xAxis":"yAxis"].push({axis:t,value:t.toValue(e[t.horiz?"chartX":"chartY"])})}),o}getHoverData(t,e,o,i,n,s){const r=[],a=!(!i||!t),h=function(t){return t.visible&&!(!n&&t.directTouch)&&pick(t.options.enableMouseTracking,!0)};let c=e,l,u={chartX:s?s.chartX:void 0,chartY:s?s.chartY:void 0,shared:n};fireEvent(this,"beforeGetHoverData",u);i=c&&!c.stickyTracking;l=i?[c]:o.filter(t=>t.stickyTracking&&(u.filter||h)(t));const d=a||!s?t:this.findNearestKDPoint(l,n,s);return c=d&&d.series,d&&(n&&!c.noSharedTooltip?(l=o.filter(function(t){return u.filter?u.filter(t):h(t)&&!t.noSharedTooltip})).forEach(function(t){let e=find(t.points,function(t){return t.x===d.x&&!t.isNull});isObject(e)&&(t.boosted&&t.boost&&(e=t.boost.getPoint(e)),r.push(e))}):r.push(d)),u={hoverPoint:d},fireEvent(this,"afterGetHoverData",u),{hoverPoint:u.hoverPoint,hoverSeries:c,hoverPoints:r}}getPointFromEvent(t){let e=t.target,o;for(;e&&!o;)o=e.point,e=e.parentNode;return o}onTrackerMouseOut(t){var e=this.chart,t=t.relatedTarget;const o=e.hoverSeries;this.isDirectTouch=!1,!o||!t||o.stickyTracking||this.inClass(t,"highcharts-tooltip")||this.inClass(t,"highcharts-series-"+o.index)&&this.inClass(t,"highcharts-tracker")||o.onMouseOut()}inClass(t,e){let o=t,i;for(;o;){if(i=attr(o,"class")){if(-1!==i.indexOf(e))return!0;if(-1!==i.indexOf("highcharts-container"))return!1}o=o.parentElement}}init(t,e){this.options=e,this.chart=t,this.runChartClick=Boolean(e.chart.events&&e.chart.events.click),this.pinchDown=[],this.lastValidTouch={},this.setDOMEvents(),fireEvent(this,"afterInit")}normalize(t,e){const o=t.touches;var i=o?o.length?o.item(0):pick(o.changedTouches,t.changedTouches)[0]:t,n=(e=e||this.getChartPosition(),i.pageX-e.left),i=i.pageY-e.top;return n/=e.scaleX,i/=e.scaleY,extend(t,{chartX:Math.round(n),chartY:Math.round(i)})}onContainerClick(t){const e=this.chart,o=e.hoverPoint;var t=this.normalize(t),i=e.plotLeft,n=e.plotTop;e.cancelClick||(o&&this.inClass(t.target,"highcharts-tracker")?(fireEvent(o.series,"click",extend(t,{point:o})),e.hoverPoint&&o.firePointEvent("click",t)):(extend(t,this.getCoordinates(t)),e.isInsidePlot(t.chartX-i,t.chartY-n,{visiblePlotOnly:!0})&&fireEvent(e,"click",t)))}onContainerMouseDown(t){var e=1==(1&(t.buttons||t.button));t=this.normalize(t),H.isFirefox&&0!==t.button&&this.onContainerMouseMove(t),void 0!==t.button&&!e||(this.zoomOption(t),e&&t.preventDefault&&t.preventDefault(),this.dragStart(t))}onContainerMouseLeave(t){const e=charts[pick(Pointer.hoverChartIndex,-1)];t=this.normalize(t),this.onContainerMouseMove(t),e&&t.relatedTarget&&!this.inClass(t.relatedTarget,"highcharts-tooltip")&&(e.pointer.reset(),e.pointer.chartPosition=void 0)}onContainerMouseEnter(t){delete this.chartPosition}onContainerMouseMove(t){const e=this.chart,o=e.tooltip,i=this.normalize(t);this.setHoverChartIndex(t),"mousedown"!==e.mouseIsDown&&!this.touchSelect(i)||this.drag(i),e.openMenu||!this.inClass(i.target,"highcharts-tracker")&&!e.isInsidePlot(i.chartX-e.plotLeft,i.chartY-e.plotTop,{visiblePlotOnly:!0})||o&&o.shouldStickOnContact(i)||(this.inClass(i.target,"highcharts-no-tooltip")?this.reset(!1,0):this.runPointActions(i))}onDocumentTouchEnd(t){const e=charts[pick(Pointer.hoverChartIndex,-1)];e&&e.pointer.drop(t)}onContainerTouchMove(t){this.touchSelect(t)?this.onContainerMouseMove(t):this.touch(t)}onContainerTouchStart(t){this.touchSelect(t)?this.onContainerMouseDown(t):(this.zoomOption(t),this.touch(t,!0))}onDocumentMouseMove(t){const e=this.chart,o=e.tooltip;var i=this.chartPosition,t=this.normalize(t,i);!i||e.isInsidePlot(t.chartX-e.plotLeft,t.chartY-e.plotTop,{visiblePlotOnly:!0})||o&&o.shouldStickOnContact(t)||this.inClass(t.target,"highcharts-tracker")||this.reset()}onDocumentMouseUp(t){const e=charts[pick(Pointer.hoverChartIndex,-1)];e&&e.pointer.drop(t)}pinch(t){const e=this,a=e.chart,o=e.pinchDown,i=t.touches||[],n=i.length,s=e.lastValidTouch,r=e.hasZoom,h={},c=1===n&&(e.inClass(t.target,"highcharts-tracker")&&a.runTrackerClick||e.runChartClick),l={},u=e.chart.tooltip,d=1===n&&pick(u&&u.options.followTouchMove,!0);let p=e.selectionMarker;1<n?e.initiated=!0:d&&(e.initiated=!1),r&&e.initiated&&!c&&!1!==t.cancelable&&t.preventDefault(),[].map.call(i,function(t){return e.normalize(t)}),"touchstart"===t.type?([].forEach.call(i,function(t,e){o[e]={chartX:t.chartX,chartY:t.chartY}}),s.x=[o[0].chartX,o[1]&&o[1].chartX],s.y=[o[0].chartY,o[1]&&o[1].chartY],a.axes.forEach(function(t){if(t.zoomEnabled){const e=a.bounds[t.horiz?"h":"v"],o=t.minPixelPadding,i=t.toPixels(Math.min(pick(t.options.min,t.dataMin),t.dataMin)),n=t.toPixels(Math.max(pick(t.options.max,t.dataMax),t.dataMax)),s=Math.min(i,n),r=Math.max(i,n);e.min=Math.min(t.pos,s-o),e.max=Math.max(t.pos+t.len,r+o)}}),e.res=!0):d?this.runPointActions(e.normalize(t)):o.length&&(fireEvent(a,"touchpan",{originalEvent:t},()=>{p||(e.selectionMarker=p=extend({destroy:noop,touch:!0},a.plotBox)),e.pinchTranslate(o,i,h,p,l,s),e.hasPinched=r,e.scaleGroups(h,l)}),e.res&&(e.res=!1,this.reset(!1,0)))}pinchTranslate(t,e,o,i,n,s){this.zoomHor&&this.pinchTranslateDirection(!0,t,e,o,i,n,s),this.zoomVert&&this.pinchTranslateDirection(!1,t,e,o,i,n,s)}pinchTranslateDirection(t,e,o,i,n,s,r,a){function h(){"number"==typeof T&&20<Math.abs(x-P)&&(D=a||Math.abs(k-T)/Math.abs(x-P)),C=(v-k)/D+x,M=c["plot"+(t?"Width":"Height")]/D}const c=this.chart,l=t?"x":"y",u=t?"X":"Y",d="chart"+u,p=t?"width":"height",v=c["plot"+(t?"Left":"Top")],m=c.inverted,f=c.bounds[t?"h":"v"],g=1===e.length,x=e[0][d],P=!g&&e[1][d];let M,b,C,D=a||1,k=o[0][d],T=!g&&o[1][d],E;h(),(b=C)<f.min?(b=f.min,E=!0):b+M>f.max&&(b=f.max-M,E=!0),E?(k-=.8*(k-r[l][0]),"number"==typeof T&&(T-=.8*(T-r[l][1])),h()):r[l]=[k,T],m||(s[l]=C-v,s[p]=M);e=m?t?"scaleY":"scaleX":"scale"+u,o=m?1/D:D;n[p]=M,n[l]=b,i[e]=D*(m&&!t?-1:1),i["translate"+u]=o*v+(k-o*x)}reset(e,t){const o=this,i=o.chart,n=i.hoverSeries,s=i.hoverPoint,r=i.hoverPoints,a=i.tooltip,h=a&&a.shared?r:s;e&&h&&splat(h).forEach(function(t){t.series.isCartesian&&void 0===t.plotX&&(e=!1)}),e?a&&h&&splat(h).length&&(a.refresh(h),a.shared&&r?r.forEach(function(t){t.setState(t.state,!0),t.series.isCartesian&&(t.series.xAxis.crosshair&&t.series.xAxis.drawCrosshair(null,t),t.series.yAxis.crosshair&&t.series.yAxis.drawCrosshair(null,t))}):s&&(s.setState(s.state,!0),i.axes.forEach(function(t){t.crosshair&&s.series[t.coll]===t&&t.drawCrosshair(null,s)}))):(s&&s.onMouseOut(),r&&r.forEach(function(t){t.setState()}),n&&n.onMouseOut(),a&&a.hide(t),o.unDocMouseMove&&(o.unDocMouseMove=o.unDocMouseMove()),i.axes.forEach(function(t){t.hideCrosshair()}),o.hoverX=i.hoverPoints=i.hoverPoint=null)}runPointActions(i,t,e){const o=this,n=o.chart,s=n.series,r=n.tooltip&&n.tooltip.options.enabled?n.tooltip:void 0,a=!!r&&r.shared;let h=t||n.hoverPoint,c=h&&h.series||n.hoverSeries;var t=(!i||"touchmove"!==i.type)&&(!!t||c&&c.directTouch&&o.isDirectTouch),t=this.getHoverData(h,c,s,t,a,i);h=t.hoverPoint,c=t.hoverSeries;const l=t.hoverPoints,u=c&&c.tooltipOptions.followPointer&&!c.tooltipOptions.split,d=a&&c&&!c.noSharedTooltip;if(h&&(e||h!==n.hoverPoint||r&&r.isHidden)){if((n.hoverPoints||[]).forEach(function(t){-1===l.indexOf(t)&&t.setState()}),n.hoverSeries!==c&&c.onMouseOver(),o.applyInactiveState(l),(l||[]).forEach(function(t){t.setState("hover")}),n.hoverPoint&&n.hoverPoint.firePointEvent("mouseOut"),!h.series)return;n.hoverPoints=l,(n.hoverPoint=h).firePointEvent("mouseOver",void 0,()=>{r&&h&&r.refresh(d?l:h,i)})}else u&&r&&!r.isHidden&&(t=r.getAnchor([{}],i),n.isInsidePlot(t[0],t[1],{visiblePlotOnly:!0})&&r.updatePosition({plotX:t[0],plotY:t[1]}));o.unDocMouseMove||(o.unDocMouseMove=addEvent(n.container.ownerDocument,"mousemove",function(t){const e=charts[Pointer.hoverChartIndex];e&&e.pointer.onDocumentMouseMove(t)}),o.eventsToUnbind.push(o.unDocMouseMove)),n.axes.forEach(function(e){var t=pick((e.crosshair||{}).snap,!0);let o;(o=!t||(o=n.hoverPoint)&&o.series[e.coll]===e?o:find(l,t=>t.series&&t.series[e.coll]===e))||!t?e.drawCrosshair(i,o):e.hideCrosshair()})}scaleGroups(o,i){const n=this.chart;n.series.forEach(function(t){var e=o||t.getPlotBox("series");t.group&&(t.xAxis&&t.xAxis.zoomEnabled||n.mapView)&&(t.group.attr(e),t.markerGroup&&(t.markerGroup.attr(o||t.getPlotBox("marker")),t.markerGroup.clip(i?n.clipRect:null)),t.dataLabelsGroup&&t.dataLabelsGroup.attr(e))}),n.clipRect.attr(i||n.clipBox)}setDOMEvents(){const t=this.chart.container,e=t.ownerDocument;t.onmousedown=this.onContainerMouseDown.bind(this),t.onmousemove=this.onContainerMouseMove.bind(this),t.onclick=this.onContainerClick.bind(this),this.eventsToUnbind.push(addEvent(t,"mouseenter",this.onContainerMouseEnter.bind(this))),this.eventsToUnbind.push(addEvent(t,"mouseleave",this.onContainerMouseLeave.bind(this))),Pointer.unbindDocumentMouseUp||(Pointer.unbindDocumentMouseUp=addEvent(e,"mouseup",this.onDocumentMouseUp.bind(this)));let o=this.chart.renderTo.parentElement;for(;o&&"BODY"!==o.tagName;)this.eventsToUnbind.push(addEvent(o,"scroll",()=>{delete this.chartPosition})),o=o.parentElement;H.hasTouch&&(this.eventsToUnbind.push(addEvent(t,"touchstart",this.onContainerTouchStart.bind(this),{passive:!1})),this.eventsToUnbind.push(addEvent(t,"touchmove",this.onContainerTouchMove.bind(this),{passive:!1})),Pointer.unbindDocumentTouchEnd||(Pointer.unbindDocumentTouchEnd=addEvent(e,"touchend",this.onDocumentTouchEnd.bind(this),{passive:!1})))}setHoverChartIndex(t){var e=this.chart;const o=H.charts[pick(Pointer.hoverChartIndex,-1)];o&&o!==e&&o.pointer.onContainerMouseLeave(t||{relatedTarget:e.container}),o&&o.mouseIsDown||(Pointer.hoverChartIndex=e.index)}touch(t,e){const o=this.chart;let i,n;this.setHoverChartIndex(),1===t.touches.length?(t=this.normalize(t),o.isInsidePlot(t.chartX-o.plotLeft,t.chartY-o.plotTop,{visiblePlotOnly:!0})&&!o.openMenu?(e&&this.runPointActions(t),"touchmove"===t.type&&(n=this.pinchDown,i=!!n[0]&&4<=Math.sqrt(Math.pow(n[0].chartX-t.chartX,2)+Math.pow(n[0].chartY-t.chartY,2))),pick(i,!0)&&this.pinch(t)):e&&this.reset()):2===t.touches.length&&this.pinch(t)}touchSelect(t){return Boolean(this.chart.zooming.singleTouch&&t.touches&&1===t.touches.length)}zoomOption(t){var e=this.chart,o=(e.options.chart,e.inverted);let i=e.zooming.type||"",n,s;/touch/.test(t.type)&&(i=pick(e.zooming.pinchType,i)),this.zoomX=n=/x/.test(i),this.zoomY=s=/y/.test(i),this.zoomHor=n&&!o||s&&o,this.zoomVert=s&&!o||n&&o,this.hasZoom=n||s}}!function(e){const o=[],i=[];e.compose=function(t){U.pushUnique(i,t)&&addEvent(t,"beforeRender",function(){this.pointer=new e(this,this.options)})},e.dissolve=function(){for(let t=0,e=o.length;t<e;++t)o[t]();o.length=0}}(Pointer=Pointer||{});export default Pointer;