"use strict";import Axis from"./Axis.js";import Chart from"./Chart.js";import H from"./Globals.js";import O from"./Options.js";var defaultOptions=O.defaultOptions;import SVGElement from"./SVGElement.js";import U from"./Utilities.js";var addEvent=U.addEvent,createElement=U.createElement,css=U.css,defined=U.defined,destroyObjectProperties=U.destroyObjectProperties,discardElement=U.discardElement,extend=U.extend,fireEvent=U.fireEvent,isNumber=U.isNumber,merge=U.merge,objectEach=U.objectEach,pick=U.pick,pInt=U.pInt,splat=U.splat;extend(defaultOptions,{rangeSelector:{verticalAlign:"top",buttonTheme:{width:28,height:18,padding:2,zIndex:7},floating:!1,x:0,y:0,height:void 0,inputPosition:{align:"right",x:0,y:0},buttonPosition:{align:"left",x:0,y:0},labelStyle:{color:"#666666"}}}),defaultOptions.lang=merge(defaultOptions.lang,{rangeSelectorZoom:"Zoom",rangeSelectorFrom:"From",rangeSelectorTo:"To"});var RangeSelector=function(){function t(e){this.buttons=void 0,this.buttonOptions=t.prototype.defaultButtons,this.options=void 0,this.chart=e,this.init(e)}return t.prototype.clickButton=function(t,e){var n,i,o,a,r,s,l,p=this.chart,u=this.buttonOptions[t],c=p.xAxis[0],d=p.scroller&&p.scroller.getUnionExtremes()||c||{},g=d.dataMin,h=d.dataMax,m=c&&Math.round(Math.min(c.max,pick(h,c.max))),x=u.type,f=u._range,v=u.dataGrouping;if(null!==g&&null!==h){if(p.fixedRange=f,v&&(this.forcedDataGrouping=!0,Axis.prototype.setDataGrouping.call(c||{chart:this.chart},v,!1),this.frozenStates=u.preserveDataGrouping),"month"===x||"year"===x)c?(s={range:u,max:m,chart:p,dataMin:g,dataMax:h},n=c.minFromRange.call(s),isNumber(s.newMax)&&(m=s.newMax)):f=u;else if(f)n=Math.max(m-f,g),m=Math.min(n+f,h);else if("ytd"===x){if(!c)return void(this.deferredYTDClick=t);void 0===h&&(g=Number.MAX_VALUE,h=Number.MIN_VALUE,p.series.forEach(function(t){var e=t.xData;g=Math.min(e[0],g),h=Math.max(e[e.length-1],h)}),e=!1),n=o=(l=this.getYTDExtremes(h,g,p.time.useUTC)).min,m=l.max}else"all"===x&&c&&(n=g,m=h);n+=u._offsetMin,m+=u._offsetMax,this.setSelected(t),c?c.setExtremes(n,m,pick(e,1),null,{trigger:"rangeSelectorButton",rangeSelectorButton:u}):(i=splat(p.options.xAxis)[0],r=i.range,i.range=f,a=i.min,i.min=o,addEvent(p,"load",function(){i.range=r,i.min=a}))}},t.prototype.setSelected=function(t){this.selected=this.options.selected=t},t.prototype.init=function(t){var e=this,n=t.options.rangeSelector,i=n.buttons||e.defaultButtons.slice(),o=n.selected,a=function(){var t=e.minInput,n=e.maxInput;t&&t.blur&&fireEvent(t,"blur"),n&&n.blur&&fireEvent(n,"blur")};e.chart=t,e.options=n,e.buttons=[],e.buttonOptions=i,this.unMouseDown=addEvent(t.container,"mousedown",a),this.unResize=addEvent(t,"resize",a),i.forEach(e.computeButtonRange),void 0!==o&&i[o]&&this.clickButton(o,!1),addEvent(t,"load",function(){t.xAxis&&t.xAxis[0]&&addEvent(t.xAxis[0],"setExtremes",function(n){this.max-this.min!==t.fixedRange&&"rangeSelectorButton"!==n.trigger&&"updatedData"!==n.trigger&&e.forcedDataGrouping&&!e.frozenStates&&this.setDataGrouping(!1,!1)})})},t.prototype.updateButtonStates=function(){var t=this,e=this.chart,n=e.xAxis[0],i=Math.round(n.max-n.min),o=!n.hasVisibleSeries,a=e.scroller&&e.scroller.getUnionExtremes()||n,r=a.dataMin,s=a.dataMax,l=t.getYTDExtremes(s,r,e.time.useUTC),p=l.min,u=l.max,c=t.selected,d=isNumber(c),g=t.options.allButtonsEnabled,h=t.buttons;t.buttonOptions.forEach(function(e,a){var l,m,x=e._range,f=e.type,v=e.count||1,y=h[a],b=0,M=e._offsetMax-e._offsetMin,B=a===c,S=x>s-r,E=x<n.minRange,T=!1,w=!1,A=x===i;("month"===f||"year"===f)&&i+36e5>=864e5*{month:28,year:365}[f]*v-M&&i-36e5<=864e5*{month:31,year:366}[f]*v+M?A=!0:"ytd"===f?(A=u-p+M===i,T=!B):"all"===f&&(A=n.max-n.min>=s-r,w=!B&&d&&A),l=!g&&(S||E||w||o),m=B&&A||A&&!d&&!T||B&&t.frozenStates,l?b=3:m&&(d=!0,b=2),y.state!==b&&(y.setState(b),0===b&&c===a&&t.setSelected(null))})},t.prototype.computeButtonRange=function(t){var e=t.type,n=t.count||1,i={millisecond:1,second:1e3,minute:6e4,hour:36e5,day:864e5,week:6048e5};i[e]?t._range=i[e]*n:"month"!==e&&"year"!==e||(t._range=24*{month:30,year:365}[e]*36e5*n),t._offsetMin=pick(t.offsetMin,0),t._offsetMax=pick(t.offsetMax,0),t._range+=t._offsetMax-t._offsetMin},t.prototype.setInputValue=function(t,e){var n=this.chart.options.rangeSelector,i=this.chart.time,o=this[t+"Input"];defined(e)&&(o.previousValue=o.HCTime,o.HCTime=e),o.value=i.dateFormat(n.inputEditDateFormat||"%Y-%m-%d",o.HCTime),this[t+"DateBox"].attr({text:i.dateFormat(n.inputDateFormat||"%b %e, %Y",o.HCTime)})},t.prototype.showInput=function(t){var e=this.inputGroup,n=this[t+"DateBox"];css(this[t+"Input"],{left:e.translateX+n.x+"px",top:e.translateY+"px",width:n.width-2+"px",height:n.height-2+"px",border:"2px solid silver"})},t.prototype.hideInput=function(t){css(this[t+"Input"],{border:0,width:"1px",height:"1px"}),this.setInputValue(t)},t.prototype.drawInput=function(t){var e,n,i,o=this,a=o.chart,r=a.renderer.style||{},s=a.renderer,l=a.options.rangeSelector,p=defaultOptions.lang,u=o.div,c="min"===t,d=this.inputGroup;function g(){var t=e.value,n=(l.inputDateParser||Date.parse)(t),i=a.xAxis[0],r=a.scroller&&a.scroller.xAxis?a.scroller.xAxis:i,s=r.dataMin,p=r.dataMax;n!==e.previousValue&&(e.previousValue=n,isNumber(n)||(n=t.split("-"),n=Date.UTC(pInt(n[0]),pInt(n[1])-1,pInt(n[2]))),isNumber(n)&&(a.time.useUTC||(n+=60*(new Date).getTimezoneOffset()*1e3),c?n>o.maxInput.HCTime?n=void 0:n<s&&(n=s):n<o.minInput.HCTime?n=void 0:n>p&&(n=p),void 0!==n&&i.setExtremes(c?n:i.min,c?i.max:n,void 0,void 0,{trigger:"rangeSelectorInput"})))}this[t+"Label"]=n=s.label(p[c?"rangeSelectorFrom":"rangeSelectorTo"],this.inputGroup.offset).addClass("highcharts-range-label").attr({padding:2}).add(d),d.offset+=n.width+5,this[t+"DateBox"]=i=s.label("",d.offset).addClass("highcharts-range-input").attr({padding:2,width:l.inputBoxWidth||90,height:l.inputBoxHeight||17,"text-align":"center"}).on("click",function(){o.showInput(t),o[t+"Input"].focus()}),a.styledMode||i.attr({stroke:l.inputBoxBorderColor||"#cccccc","stroke-width":1}),i.add(d),d.offset+=i.width+(c?10:0),this[t+"Input"]=e=createElement("input",{name:t,className:"highcharts-range-selector",type:"text"},{top:a.plotTop+"px"},u),a.styledMode||(n.css(merge(r,l.labelStyle)),i.css(merge({color:"#333333"},r,l.inputStyle)),css(e,extend({position:"absolute",border:0,width:"1px",height:"1px",padding:0,textAlign:"center",fontSize:r.fontSize,fontFamily:r.fontFamily,top:"-9999em"},l.inputStyle))),e.onfocus=function(){o.showInput(t)},e.onblur=function(){e===H.doc.activeElement&&g(),o.hideInput(t),e.blur()},e.onchange=g,e.onkeypress=function(t){13===t.keyCode&&g()}},t.prototype.getPosition=function(){var t=this.chart,e=t.options.rangeSelector,n="top"===e.verticalAlign?t.plotTop-t.axisOffset[0]:0;return{buttonTop:n+e.buttonPosition.y,inputTop:n+e.inputPosition.y-10}},t.prototype.getYTDExtremes=function(t,e,n){var i,o=this.chart.time,a=new o.Date(t),r=o.get("FullYear",a),s=n?o.Date.UTC(r,0,1):+new o.Date(r,0,1);return i=Math.max(e||0,s),a=a.getTime(),{max:Math.min(t||a,a),min:i}},t.prototype.render=function(t,e){var n,i,o,a,r,s=this,l=s.chart,p=l.renderer,u=l.container,c=l.options,d=c.exporting&&!1!==c.exporting.enabled&&c.navigation&&c.navigation.buttonOptions,g=defaultOptions.lang,h=s.div,m=c.rangeSelector,x=pick(c.chart.style&&c.chart.style.zIndex,0)+1,f=m.floating,v=s.buttons,y=s.inputGroup,b=m.buttonTheme,M=m.buttonPosition,B=m.inputPosition,S=m.inputEnabled,E=b&&b.states,T=l.plotLeft,w=s.buttonGroup,A=s.rendered,I=s.options.verticalAlign,D=l.legend,k=D&&D.options,C=M.y,O=B.y,U=l.hasLoaded,G=U?"animate":"attr",N=0,R=0;if(!1!==m.enabled){var Y,z,H,_;if(A||(s.group=i=p.g("range-selector-group").attr({zIndex:7}).add(),s.buttonGroup=w=p.g("range-selector-buttons").add(i),s.zoomText=p.text(g.rangeSelectorZoom,0,15).add(w),l.styledMode||(s.zoomText.css(m.labelStyle),b["stroke-width"]=pick(b["stroke-width"],0)),s.buttonOptions.forEach(function(t,e){v[e]=p.button(t.text,0,0,function(n){var i,o=t.events&&t.events.click;o&&(i=o.call(t,n)),!1!==i&&s.clickButton(e),s.isActive=!0},b,E&&E.hover,E&&E.select,E&&E.disabled).attr({"text-align":"center"}).add(w)}),!1!==S&&(s.div=h=createElement("div",null,{position:"relative",height:0,zIndex:x}),u.parentNode.insertBefore(h,u),s.inputGroup=y=p.g("input-group").add(i),y.offset=0,s.drawInput("min"),s.drawInput("max"))),s.zoomText[G]({x:pick(T+M.x,T)}),n=pick(T+M.x,T)+s.zoomText.getBBox().width+5,s.buttonOptions.forEach(function(t,e){v[e][G]({x:n}),n+=v[e].width+pick(m.buttonSpacing,5)}),T=l.plotLeft-l.spacing[3],s.updateButtonStates(),d&&this.titleCollision(l)&&"top"===I&&"right"===M.align&&M.y+w.getBBox().height-12<(d.y||0)+d.height&&(N=-40),r=M.x-l.spacing[3],"right"===M.align?r+=N-T:"center"===M.align&&(r-=T/2),w.align({y:M.y,width:w.getBBox().width,align:M.align,x:r},!0,l.spacingBox),s.group.placed=U,s.buttonGroup.placed=U,!1!==S)N=d&&this.titleCollision(l)&&"top"===I&&"right"===B.align&&B.y-y.getBBox().height-12<(d.y||0)+d.height+l.spacing[0]?-40:0,"left"===B.align?r=T:"right"===B.align&&(r=-Math.max(l.axisOffset[1],-N)),y.align({y:B.y,width:y.getBBox().width,align:B.align,x:B.x+r-2},!0,l.spacingBox),Y=y.alignAttr.translateX+y.alignOptions.x-N+y.getBBox().x+2,z=y.alignOptions.width,H=w.alignAttr.translateX+w.getBBox().x,_=w.getBBox().width+20,(B.align===M.align||H+_>Y&&Y+z>H&&C<O+y.getBBox().height)&&y.attr({translateX:y.alignAttr.translateX+(l.axisOffset[1]>=-N?0:-N),translateY:y.alignAttr.translateY+w.getBBox().height+10}),s.setInputValue("min",t),s.setInputValue("max",e),s.inputGroup.placed=U;s.group.align({verticalAlign:I},!0,l.spacingBox),o=s.group.getBBox().height+20,a=s.group.alignAttr.translateY,"bottom"===I&&(R=a-(o=o+(k&&"bottom"===k.verticalAlign&&k.enabled&&!k.floating?D.legendHeight+pick(k.margin,10):0)-20)-(f?0:m.y)-(l.titleOffset?l.titleOffset[2]:0)-10),"top"===I?(f&&(R=0),l.titleOffset&&l.titleOffset[0]&&(R=l.titleOffset[0]),R+=l.margin[0]-l.spacing[0]||0):"middle"===I&&(O===C?R=O<0?a+void 0:a:(O||C)&&(O<0||C<0?R-=Math.min(O,C):R=a-o+void 0)),s.group.translate(m.x,m.y+Math.floor(R)),!1!==S&&(s.minInput.style.marginTop=s.group.translateY+"px",s.maxInput.style.marginTop=s.group.translateY+"px"),s.rendered=!0}},t.prototype.getHeight=function(){var t,e=this.options,n=this.group,i=e.inputPosition,o=e.buttonPosition,a=e.y,r=o.y,s=i.y,l=0;return e.height?e.height:(l=n?n.getBBox(!0).height+13+a:0,t=Math.min(s,r),(s<0&&r<0||s>0&&r>0)&&(l+=Math.abs(t)),l)},t.prototype.titleCollision=function(t){return!(t.options.title.text||t.options.subtitle.text)},t.prototype.update=function(t){var e=this.chart;merge(!0,e.options.rangeSelector,t),this.destroy(),this.init(e),e.rangeSelector.render()},t.prototype.destroy=function(){var e=this,n=e.minInput,i=e.maxInput;e.unMouseDown(),e.unResize(),destroyObjectProperties(e.buttons),n&&(n.onfocus=n.onblur=n.onchange=null),i&&(i.onfocus=i.onblur=i.onchange=null),objectEach(e,function(n,i){n&&"chart"!==i&&(n instanceof SVGElement?n.destroy():n instanceof window.HTMLElement&&discardElement(n)),n!==t.prototype[i]&&(e[i]=null)},this)},t}();RangeSelector.prototype.defaultButtons=[{type:"month",count:1,text:"1m"},{type:"month",count:3,text:"3m"},{type:"month",count:6,text:"6m"},{type:"ytd",text:"YTD"},{type:"year",count:1,text:"1y"},{type:"all",text:"All"}],Axis.prototype.minFromRange=function(){var t,e,n,i=this.range,o=i.type,a=this.max,r=this.chart.time,s=function(t,e){var n="year"===o?"FullYear":"Month",i=new r.Date(t),a=r.get(n,i);return r.set(n,i,a+e),a===r.get(n,i)&&r.set("Date",i,0),i.getTime()-t};return isNumber(i)?(t=a-i,n=i):(t=a+s(a,-i.count),this.chart&&(this.chart.fixedRange=a-t)),e=pick(this.dataMin,Number.MIN_VALUE),isNumber(t)||(t=e),t<=e&&(t=e,void 0===n&&(n=s(t,i.count)),this.newMax=Math.min(t+n,this.dataMax)),isNumber(a)||(t=void 0),t},H.RangeSelector||(addEvent(Chart,"afterGetContainer",function(){this.options.rangeSelector.enabled&&(this.rangeSelector=new RangeSelector(this))}),addEvent(Chart,"beforeRender",function(){var t,e=this.axes,n=this.rangeSelector;n&&(isNumber(n.deferredYTDClick)&&(n.clickButton(n.deferredYTDClick),delete n.deferredYTDClick),e.forEach(function(t){t.updateNames(),t.setScale()}),this.getAxisMargins(),n.render(),t=n.options.verticalAlign,n.options.floating||("bottom"===t?this.extraBottomMargin=!0:"middle"!==t&&(this.extraTopMargin=!0)))}),addEvent(Chart,"update",function(t){var e,n=t.options.rangeSelector,i=this.rangeSelector,o=this.extraBottomMargin,a=this.extraTopMargin;n&&n.enabled&&!defined(i)&&(this.options.rangeSelector.enabled=!0,this.rangeSelector=new RangeSelector(this)),this.extraBottomMargin=!1,this.extraTopMargin=!1,i&&(i.render(),e=n&&n.verticalAlign||i.options&&i.options.verticalAlign,i.options.floating||("bottom"===e?this.extraBottomMargin=!0:"middle"!==e&&(this.extraTopMargin=!0)),this.extraBottomMargin===o&&this.extraTopMargin===a||(this.isDirtyBox=!0))}),addEvent(Chart,"render",function(){var t,e=this.rangeSelector;e&&!e.options.floating&&(e.render(),"bottom"===(t=e.options.verticalAlign)?this.extraBottomMargin=!0:"middle"!==t&&(this.extraTopMargin=!0))}),addEvent(Chart,"getMargins",function(){var t,e=this.rangeSelector;e&&(t=e.getHeight(),this.extraTopMargin&&(this.plotTop+=t),this.extraBottomMargin&&(this.marginBottom+=t))}),Chart.prototype.callbacks.push(function(t){var e,n,i,o,a,r,s=t.rangeSelector;function l(){e=t.xAxis[0].getExtremes(),o=t.legend,r=null==s?void 0:s.options.verticalAlign,isNumber(e.min)&&s.render(e.min,e.max),s&&o.display&&"top"===r&&r===o.options.verticalAlign&&(a=merge(t.spacingBox),"vertical"===o.options.layout?a.y=t.plotTop:a.y+=s.getHeight(),o.group.placed=!1,o.align(a))}s&&(i=addEvent(t.xAxis[0],"afterSetExtremes",function(t){s.render(t.min,t.max)}),n=addEvent(t,"redraw",l),l()),addEvent(t,"destroy",function(){s&&(n(),i())})}),H.RangeSelector=RangeSelector);export default H.RangeSelector;