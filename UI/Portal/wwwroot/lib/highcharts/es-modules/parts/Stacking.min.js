"use strict";import Axis from"./Axis.js";import Chart from"./Chart.js";import H from"./Globals.js";import StackingAxis from"./StackingAxis.js";import U from"./Utilities.js";var correctFloat=U.correctFloat,defined=U.defined,destroyObjectProperties=U.destroyObjectProperties,format=U.format,isNumber=U.isNumber,pick=U.pick;import"./Series.js";var Series=H.Series,StackItem=function(){function t(t,i,s,e,a){var o=t.chart.inverted;this.axis=t,this.isNegative=s,this.options=i=i||{},this.x=e,this.total=null,this.points={},this.hasValidPoints=!1,this.stack=a,this.leftCliff=0,this.rightCliff=0,this.alignOptions={align:i.align||(o?s?"left":"right":"center"),verticalAlign:i.verticalAlign||(o?"middle":s?"bottom":"top"),y:i.y,x:i.x},this.textAlign=i.textAlign||(o?s?"right":"left":"center")}return t.prototype.destroy=function(){destroyObjectProperties(this,this.axis)},t.prototype.render=function(t){var i=this.axis.chart,s=this.options,e=s.format,a={},o=e?format(e,this,i):s.formatter.call(this);this.label?this.label.attr({text:o,visibility:"hidden"}):(this.label=i.renderer.label(o,null,null,s.shape,null,null,s.useHTML,!1,"stack-labels"),a={r:s.borderRadius||0,text:o,rotation:s.rotation,padding:pick(s.padding,5),visibility:"hidden"},i.styledMode||(a.fill=s.backgroundColor,a.stroke=s.borderColor,a["stroke-width"]=s.borderWidth,this.label.css(s.style)),this.label.attr(a),this.label.added||this.label.add(t)),this.label.labelrank=i.plotHeight},t.prototype.setOffset=function(t,i,s,e,a){var o=this.axis,n=o.chart,r=o.translate(o.stacking.usePercentage?100:e||this.total,0,0,0,1),l=o.translate(s||0),c=defined(r)&&Math.abs(r-l),h=pick(a,n.xAxis[0].translate(this.x))+t,p=defined(r)&&this.getStackBox(n,this,h,r,i,c,o),d=this.label,g=this.isNegative,k="justify"===pick(this.options.overflow,"justify"),u=this.textAlign;if(d&&p){var f,x,y=d.getBBox(),m=d.padding;f="left"===u?n.inverted?-m:m:"right"===u?y.width:n.inverted&&"center"===u?y.width/2:n.inverted?g?y.width+m:-m:y.width/2,x=n.inverted?y.height/2:g?-m:y.height,this.alignOptions.x=pick(this.options.x,0),this.alignOptions.y=pick(this.options.y,0),p.x-=f,p.y-=x,d.align(this.alignOptions,null,p),n.isInsidePlot(d.alignAttr.x+f-this.alignOptions.x,d.alignAttr.y+x-this.alignOptions.y)?d.show():(d.alignAttr.y=-9999,k=!1),k&&Series.prototype.justifyDataLabel.call(this.axis,d,this.alignOptions,d.alignAttr,y,p),d.attr({x:d.alignAttr.x,y:d.alignAttr.y}),pick(!k&&this.options.crop,!0)&&(isNumber(d.x)&&isNumber(d.y)&&n.isInsidePlot(d.x-m+d.width,d.y)&&n.isInsidePlot(d.x+m,d.y)||d.hide())}},t.prototype.getStackBox=function(t,i,s,e,a,o,n){var r=i.axis.reversed,l=t.inverted,c=n.height+n.pos-(l?t.plotLeft:t.plotTop),h=i.isNegative&&!r||!i.isNegative&&r;return{x:l?h?e-n.right:e-o+n.pos-t.plotLeft:s+t.xAxis[0].transB-t.plotLeft,y:l?n.height-s-a:h?c-e-o:c-e,width:l?o:a,height:l?a:o}},t}();Chart.prototype.getStacks=function(){var t=this,i=t.inverted;t.yAxis.forEach(function(t){t.stacking&&t.stacking.stacks&&t.hasVisibleSeries&&(t.stacking.oldStacks=t.stacking.stacks)}),t.series.forEach(function(s){var e=s.xAxis&&s.xAxis.options||{};!s.options.stacking||!0!==s.visible&&!1!==t.options.chart.ignoreHiddenSeries||(s.stackKey=[s.type,pick(s.options.stack,""),i?e.top:e.left,i?e.height:e.width].join(","))})},StackingAxis.compose(Axis),Series.prototype.setGroupedPoints=function(){this.options.centerInCategory&&(this.is("column")||this.is("columnrange"))&&!this.options.stacking&&this.chart.series.length>1&&Series.prototype.setStackedPoints.call(this,"group")},Series.prototype.setStackedPoints=function(t){var i=t||this.options.stacking;if(i&&(!0===this.visible||!1===this.chart.options.chart.ignoreHiddenSeries)){var s,e,a,o,n,r,l,c,h,p=this.processedXData,d=this.processedYData,g=[],k=d.length,u=this.options,f=u.threshold,x=pick(u.startFromThreshold&&f,0),y=u.stack,m=t?this.type+","+i:this.stackKey,v="-"+m,S=this.negStacks,b=this.yAxis,A=b.stacking.stacks,j=b.stacking.oldStacks;for(b.stacking.stacksTouched+=1,l=0;l<k;l++)c=p[l],h=d[l],r=(s=this.getStackIndicator(s,c,this.index)).key,A[n=(e=S&&h<(x?0:f))?v:m]||(A[n]={}),A[n][c]||(j[n]&&j[n][c]?(A[n][c]=j[n][c],A[n][c].total=null):A[n][c]=new StackItem(b,b.options.stackLabels,e,c,y)),a=A[n][c],null!==h?(a.points[r]=a.points[this.index]=[pick(a.cumulative,x)],defined(a.cumulative)||(a.base=r),a.touched=b.stacking.stacksTouched,s.index>0&&!1===this.singleStacks&&(a.points[r][0]=a.points[this.index+","+c+",0"][0])):a.points[r]=a.points[this.index]=null,"percent"===i?(o=e?m:v,S&&A[o]&&A[o][c]?(o=A[o][c],a.total=o.total=Math.max(o.total,a.total)+Math.abs(h)||0):a.total=correctFloat(a.total+(Math.abs(h)||0))):"group"===i?null!==h&&(a.total=(a.total||0)+1):a.total=correctFloat(a.total+(h||0)),a.cumulative="group"===i?(a.total||1)-1:pick(a.cumulative,x)+(h||0),null!==h&&(a.points[r].push(a.cumulative),g[l]=a.cumulative,a.hasValidPoints=!0);"percent"===i&&(b.stacking.usePercentage=!0),"group"!==i&&(this.stackedYData=g),b.stacking.oldStacks={}}},Series.prototype.modifyStacks=function(){var t,i=this,s=i.yAxis,e=i.stackKey,a=s.stacking.stacks,o=i.processedXData,n=i.options.stacking;i[n+"Stacker"]&&[e,"-"+e].forEach(function(s){for(var e,r,l,c=o.length;c--;)e=o[c],t=i.getStackIndicator(t,e,i.index,s),(l=(r=a[s]&&a[s][e])&&r.points[t.key])&&i[n+"Stacker"](l,r,c)})},Series.prototype.percentStacker=function(t,i,s){var e=i.total?100/i.total:0;t[0]=correctFloat(t[0]*e),t[1]=correctFloat(t[1]*e),this.stackedYData[s]=t[1]},Series.prototype.getStackIndicator=function(t,i,s,e){return!defined(t)||t.x!==i||e&&t.key!==e?t={x:i,index:0,key:e}:t.index++,t.key=[s,i,t.index].join(","),t},H.StackItem=StackItem;export default H.StackItem;