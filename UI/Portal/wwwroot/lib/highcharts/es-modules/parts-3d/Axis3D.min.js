"use strict";import H from"../parts/Globals.js";import Tick from"../parts/Tick.js";import Tick3D from"./Tick3D.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,merge=U.merge,pick=U.pick,wrap=U.wrap,deg2rad=H.deg2rad,perspective=H.perspective,perspective3D=H.perspective3D,shapeArea=H.shapeArea,Axis3DAdditions=function(){function t(t){this.axis=t}return t.prototype.fix3dPosition=function(t,i){var s=this.axis,e=s.chart;if("colorAxis"===s.coll||!e.chart3d||!e.is3d())return t;var o,a=deg2rad*e.options.chart.options3d.alpha,r=deg2rad*e.options.chart.options3d.beta,p=pick(i&&s.options.title.position3d,s.options.labels.position3d),x=pick(i&&s.options.title.skew3d,s.options.labels.skew3d),n=e.chart3d.frame3d,l=e.plotLeft,h=e.plotWidth+l,c=e.plotTop,y=e.plotHeight+c,d=!1,f=0,u=0,z={x:0,y:1,z:0};if(t=s.axis3D.swapZ({x:t.x,y:t.y,z:0}),s.isZAxis)if(s.opposite){if(null===n.axes.z.top)return{};u=t.y-c,t.x=n.axes.z.top.x,t.y=n.axes.z.top.y,o=n.axes.z.top.xDir,d=!n.top.frontFacing}else{if(null===n.axes.z.bottom)return{};u=t.y-y,t.x=n.axes.z.bottom.x,t.y=n.axes.z.bottom.y,o=n.axes.z.bottom.xDir,d=!n.bottom.frontFacing}else if(s.horiz)if(s.opposite){if(null===n.axes.x.top)return{};u=t.y-c,t.y=n.axes.x.top.y,t.z=n.axes.x.top.z,o=n.axes.x.top.xDir,d=!n.top.frontFacing}else{if(null===n.axes.x.bottom)return{};u=t.y-y,t.y=n.axes.x.bottom.y,t.z=n.axes.x.bottom.z,o=n.axes.x.bottom.xDir,d=!n.bottom.frontFacing}else if(s.opposite){if(null===n.axes.y.right)return{};f=t.x-h,t.x=n.axes.y.right.x,t.z=n.axes.y.right.z,o={x:(o=n.axes.y.right.xDir).z,y:o.y,z:-o.x}}else{if(null===n.axes.y.left)return{};f=t.x-l,t.x=n.axes.y.left.x,t.z=n.axes.y.left.z,o=n.axes.y.left.xDir}if("chart"===p);else if("flap"===p)if(s.horiz){var v=Math.sin(a),b=Math.cos(a);s.opposite&&(v=-v),d&&(v=-v),z={x:o.z*v,y:b,z:-o.x*v}}else o={x:Math.cos(r),y:0,z:Math.sin(r)};else if("ortho"===p)if(s.horiz){var m=Math.sin(a),g=Math.cos(a),w={x:Math.sin(r)*g,y:-m,z:-g*Math.cos(r)};z={x:o.y*w.z-o.z*w.y,y:o.z*w.x-o.x*w.z,z:o.x*w.y-o.y*w.x};var D=1/Math.sqrt(z.x*z.x+z.y*z.y+z.z*z.z);d&&(D=-D),z={x:D*z.x,y:D*z.y,z:D*z.z}}else o={x:Math.cos(r),y:0,z:Math.sin(r)};else s.horiz?z={x:Math.sin(r)*Math.sin(a),y:Math.cos(a),z:-Math.cos(r)*Math.sin(a)}:o={x:Math.cos(r),y:0,z:Math.sin(r)};t.x+=f*o.x+u*z.x,t.y+=f*o.y+u*z.y,t.z+=f*o.z+u*z.z;var P=perspective([t],s.chart)[0];if(x){shapeArea(perspective([t,{x:t.x+o.x,y:t.y+o.y,z:t.z+o.z},{x:t.x+z.x,y:t.y+z.y,z:t.z+z.z}],s.chart))<0&&(o={x:-o.x,y:-o.y,z:-o.z});var k=perspective([{x:t.x,y:t.y,z:t.z},{x:t.x+o.x,y:t.y+o.y,z:t.z+o.z},{x:t.x+z.x,y:t.y+z.y,z:t.z+z.z}],s.chart);P.matrix=[k[1].x-k[0].x,k[1].y-k[0].y,k[2].x-k[0].x,k[2].y-k[0].y,P.x,P.y],P.matrix[4]-=P.x*P.matrix[0]+P.y*P.matrix[2],P.matrix[5]-=P.x*P.matrix[1]+P.y*P.matrix[3]}return P},t.prototype.swapZ=function(t,i){var s=this.axis;if(s.isZAxis){var e=i?0:s.chart.plotLeft;return{x:e+t.z,y:t.y,z:t.x-e}}return t},t}(),Axis3D=function(){function t(){}return t.compose=function(i){merge(!0,i.defaultOptions,t.defaultOptions),i.keepProps.push("axis3D"),addEvent(i,"init",t.onInit),addEvent(i,"afterSetOptions",t.onAfterSetOptions),addEvent(i,"drawCrosshair",t.onDrawCrosshair),addEvent(i,"destroy",t.onDestroy);var s=i.prototype;wrap(s,"getLinePath",t.wrapGetLinePath),wrap(s,"getPlotBandPath",t.wrapGetPlotBandPath),wrap(s,"getPlotLinePath",t.wrapGetPlotLinePath),wrap(s,"getSlotWidth",t.wrapGetSlotWidth),wrap(s,"getTitlePosition",t.wrapGetTitlePosition),Tick3D.compose(Tick)},t.onAfterSetOptions=function(){var t=this.chart,i=this.options;t.is3d&&t.is3d()&&"colorAxis"!==this.coll&&(i.tickWidth=pick(i.tickWidth,0),i.gridLineWidth=pick(i.gridLineWidth,1))},t.onDestroy=function(){["backFrame","bottomFrame","sideFrame"].forEach(function(t){this[t]&&(this[t]=this[t].destroy())},this)},t.onDrawCrosshair=function(t){this.chart.is3d()&&"colorAxis"!==this.coll&&t.point&&(t.point.crosshairPos=this.isXAxis?t.point.axisXpos:this.len-t.point.axisYpos)},t.onInit=function(){this.axis3D||(this.axis3D=new Axis3DAdditions(this))},t.wrapGetLinePath=function(t){return this.chart.is3d()&&"colorAxis"!==this.coll?[]:t.apply(this,[].slice.call(arguments,1))},t.wrapGetPlotBandPath=function(t){if(!this.chart.is3d()||"colorAxis"===this.coll)return t.apply(this,[].slice.call(arguments,1));var i=arguments,s=i[1],e=i[2],o=[],a=this.getPlotLinePath({value:s}),r=this.getPlotLinePath({value:e});if(a&&r)for(var p=0;p<a.length;p+=2){var x=a[p],n=a[p+1],l=r[p],h=r[p+1];"M"===x[0]&&"L"===n[0]&&"M"===l[0]&&"L"===h[0]&&o.push(x,n,h,["L",l[1],l[2]],["Z"])}return o},t.wrapGetPlotLinePath=function(t){var i=this.axis3D,s=this.chart,e=t.apply(this,[].slice.call(arguments,1));if("colorAxis"===this.coll||!s.chart3d||!s.is3d())return e;if(null===e)return e;var o,a=s.options.chart.options3d,r=this.isZAxis?s.plotWidth:a.depth,p=s.chart3d.frame3d,x=e[0],n=e[1],l=[];return"M"===x[0]&&"L"===n[0]&&(o=[i.swapZ({x:x[1],y:x[2],z:0}),i.swapZ({x:x[1],y:x[2],z:r}),i.swapZ({x:n[1],y:n[2],z:0}),i.swapZ({x:n[1],y:n[2],z:r})],this.horiz?this.isZAxis?(p.left.visible&&l.push(o[0],o[2]),p.right.visible&&l.push(o[1],o[3]),p.top.visible&&l.push(o[0],o[1]),p.bottom.visible&&l.push(o[2],o[3])):(p.front.visible&&l.push(o[0],o[2]),p.back.visible&&l.push(o[1],o[3]),p.top.visible&&l.push(o[0],o[1]),p.bottom.visible&&l.push(o[2],o[3])):(p.front.visible&&l.push(o[0],o[2]),p.back.visible&&l.push(o[1],o[3]),p.left.visible&&l.push(o[0],o[1]),p.right.visible&&l.push(o[2],o[3])),l=perspective(l,this.chart,!1)),s.renderer.toLineSegments(l)},t.wrapGetSlotWidth=function(t,i){var s=this.chart,e=this.ticks,o=this.gridGroup;if(this.categories&&s.frameShapes&&s.is3d()&&o&&i&&i.label){var a,r,p,x=o.element.childNodes[0].getBBox(),n=s.frameShapes.left.getBBox(),l=s.options.chart.options3d,h={x:s.plotWidth/2,y:s.plotHeight/2,z:l.depth/2,vd:pick(l.depth,1)*pick(l.viewDistance,0)},c=i.pos,y=e[c-1],d=e[c+1];return 0!==c&&y&&y.label.xy&&(r=perspective3D({x:y.label.xy.x,y:y.label.xy.y,z:null},h,h.vd)),d&&d.label.xy&&(p=perspective3D({x:d.label.xy.x,y:d.label.xy.y,z:null},h,h.vd)),a={x:i.label.xy.x,y:i.label.xy.y,z:null},a=perspective3D(a,h,h.vd),Math.abs(r?a.x-r.x:p?p.x-a.x:x.x-n.x)}return t.apply(this,[].slice.call(arguments,1))},t.wrapGetTitlePosition=function(t){var i=t.apply(this,[].slice.call(arguments,1));return this.axis3D?this.axis3D.fix3dPosition(i,!0):i},t.defaultOptions={labels:{position3d:"offset",skew3d:!1},title:{position3d:null,skew3d:null}},t}();export default Axis3D;