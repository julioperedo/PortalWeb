"use strict";import H from"../parts/Globals.js";import StackItem from"../parts/Stacking.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,pick=U.pick,wrap=U.wrap;import"../parts/Series.js";var perspective=H.perspective,Series=H.Series,seriesTypes=H.seriesTypes,svg=H.svg;function retrieveStacks(t,e){var s,i=t.series,r={},p=1;return i.forEach(function(t){s=pick(t.options.stack,e?0:i.length-1-t.index),r[s]?r[s].series.push(t):(r[s]={series:[t],position:p},p++)}),r.totalStacks=p+1,r}function pointAttribs(t){var e=t.apply(this,[].slice.call(arguments,1));return this.chart.is3d&&this.chart.is3d()&&(e.stroke=this.options.edgeColor||e.fill,e["stroke-width"]=pick(this.options.edgeWidth,1)),e}function setState(t,e,s){var i=this.chart.is3d&&this.chart.is3d();i&&(this.options.inactiveOtherPoints=!0),t.call(this,e,s),i&&(this.options.inactiveOtherPoints=!1)}function hasNewShapeType(t){for(var e=[],s=1;s<arguments.length;s++)e[s-1]=arguments[s];return this.series.chart.is3d()?this.graphic&&"g"!==this.graphic.element.nodeName:t.apply(this,e)}wrap(seriesTypes.column.prototype,"translate",function(t){t.apply(this,[].slice.call(arguments,1)),this.chart.is3d()&&this.translate3dShapes()}),wrap(H.Series.prototype,"justifyDataLabel",function(t){return!arguments[2].outside3dPlot&&t.apply(this,[].slice.call(arguments,1))}),seriesTypes.column.prototype.translate3dPoints=function(){},seriesTypes.column.prototype.translate3dShapes=function(){var t,e=this,s=e.chart,i=e.options,r=i.depth,p=(i.stacking?i.stack||0:e.index)*(r+(i.groupZPadding||1)),o=e.borderWidth%2?.5:0;s.inverted&&!e.yAxis.reversed&&(o*=-1),!1!==i.grouping&&(p=0),p+=i.groupZPadding||1,e.data.forEach(function(i){if(i.outside3dPlot=null,null!==i.y){var a,n=i.shapeArgs,h=i.tooltipPos;[["x","width"],["y","height"]].forEach(function(t){if((a=n[t[0]]-o)<0&&(n[t[1]]+=n[t[0]]+o,n[t[0]]=-o,a=0),a+n[t[1]]>e[t[0]+"Axis"].len&&0!==n[t[1]]&&(n[t[1]]=e[t[0]+"Axis"].len-n[t[0]]),0!==n[t[1]]&&(n[t[0]]>=e[t[0]+"Axis"].len||n[t[0]]+n[t[1]]<=o)){for(var s in n)n[s]=0;i.outside3dPlot=!0}}),"rect"===i.shapeType&&(i.shapeType="cuboid"),n.z=p,n.depth=r,n.insidePlotArea=!0,t={x:n.x+n.width/2,y:n.y,z:p+r/2},s.inverted&&(t.x=n.height,t.y=i.clientX),i.plot3d=perspective([t],s,!0,!1)[0],h=perspective([{x:h[0],y:h[1],z:p+r/2}],s,!0,!1)[0],i.tooltipPos=[h.x,h.y]}}),e.z=p},wrap(seriesTypes.column.prototype,"animate",function(t){if(this.chart.is3d()){var e=arguments[1],s=this.yAxis,i=this,r=this.yAxis.reversed;svg&&(e?i.data.forEach(function(t){null!==t.y&&(t.height=t.shapeArgs.height,t.shapey=t.shapeArgs.y,t.shapeArgs.height=1,r||(t.stackY?t.shapeArgs.y=t.plotY+s.translate(t.stackY):t.shapeArgs.y=t.plotY+(t.negative?-t.height:t.height)))}):(i.data.forEach(function(t){null!==t.y&&(t.shapeArgs.height=t.height,t.shapeArgs.y=t.shapey,t.graphic&&t.graphic.animate(t.shapeArgs,i.options.animation))}),this.drawDataLabels()))}else t.apply(this,[].slice.call(arguments,1))}),wrap(seriesTypes.column.prototype,"plotGroup",function(t,e,s,i,r,p){return"dataLabelsGroup"!==e&&this.chart.is3d()&&(this[e]&&delete this[e],p&&(this.chart.columnGroup||(this.chart.columnGroup=this.chart.renderer.g("columnGroup").add(p)),this[e]=this.chart.columnGroup,this.chart.columnGroup.attr(this.getPlotBox()),this[e].survive=!0,"group"!==e&&"markerGroup"!==e||(arguments[3]="visible"))),t.apply(this,Array.prototype.slice.call(arguments,1))}),wrap(seriesTypes.column.prototype,"setVisible",function(t,e){var s,i=this;i.chart.is3d()&&i.data.forEach(function(t){t.visible=t.options.visible=e=void 0===e?!pick(i.visible,t.visible):e,s=e?"visible":"hidden",i.options.data[i.data.indexOf(t)]=t.options,t.graphic&&t.graphic.attr({visibility:s})}),t.apply(this,Array.prototype.slice.call(arguments,1))}),seriesTypes.column.prototype.handle3dGrouping=!0,addEvent(Series,"afterInit",function(){if(this.chart.is3d()&&this.handle3dGrouping){var t=this.options,e=t.grouping,s=t.stacking,i=pick(this.yAxis.options.reversedStacks,!0),r=0;if(void 0===e||e){var p,o=retrieveStacks(this.chart,s),a=t.stack||0;for(p=0;p<o[a].series.length&&o[a].series[p]!==this;p++);r=10*(o.totalStacks-o[a].position)+(i?p:-p),this.xAxis.reversed||(r=10*o.totalStacks-r)}t.depth=t.depth||25,this.z=this.z||0,t.zIndex=r}}),wrap(seriesTypes.column.prototype,"pointAttribs",pointAttribs),wrap(seriesTypes.column.prototype,"setState",setState),wrap(seriesTypes.column.prototype.pointClass.prototype,"hasNewShapeType",hasNewShapeType),seriesTypes.columnrange&&(wrap(seriesTypes.columnrange.prototype,"pointAttribs",pointAttribs),wrap(seriesTypes.columnrange.prototype,"setState",setState),wrap(seriesTypes.columnrange.prototype.pointClass.prototype,"hasNewShapeType",hasNewShapeType),seriesTypes.columnrange.prototype.plotGroup=seriesTypes.column.prototype.plotGroup,seriesTypes.columnrange.prototype.setVisible=seriesTypes.column.prototype.setVisible),wrap(Series.prototype,"alignDataLabel",function(t,e,s,i,r){var p=this.chart;if(i.outside3dPlot=e.outside3dPlot,p.is3d()&&this.is("column")){var o=this.options,a=pick(i.inside,!!this.options.stacking),n=p.options.chart.options3d,h=e.pointWidth/2||0,c={x:r.x+h,y:r.y,z:this.z+o.depth/2};p.inverted&&(a&&(r.width=0,c.x+=e.shapeArgs.height/2),n.alpha>=90&&n.alpha<=270&&(c.y+=e.shapeArgs.width)),c=perspective([c],p,!0,!1)[0],r.x=c.x-h,r.y=e.outside3dPlot?-9e9:c.y}t.apply(this,[].slice.call(arguments,1))}),wrap(StackItem.prototype,"getStackBox",function(t,e,s,i,r,p,o,a){var n=t.apply(this,[].slice.call(arguments,1));if(e.is3d()&&s.base){var h=+s.base.split(",")[0],c=e.series[h],l=e.options.chart.options3d;if(c&&c instanceof seriesTypes.column){var d={x:n.x+(e.inverted?o:p/2),y:n.y,z:c.options.depth/2};e.inverted&&(n.width=0,l.alpha>=90&&l.alpha<=270&&(d.y+=p)),d=perspective([d],e,!0,!1)[0],n.x=d.x-p/2,n.y=d.y}}return n});