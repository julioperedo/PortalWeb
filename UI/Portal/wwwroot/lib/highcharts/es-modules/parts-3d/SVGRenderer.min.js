"use strict";import Color from"../parts/Color.js";var color=Color.parse;import H from"../parts/Globals.js";import SVGElement from"../parts/SVGElement.js";import SVGRenderer from"../parts/SVGRenderer.js";import U from"../parts/Utilities.js";var dFactor,element3dMethods,cuboidMethods,animObject=U.animObject,defined=U.defined,extend=U.extend,merge=U.merge,objectEach=U.objectEach,pick=U.pick,cos=Math.cos,PI=Math.PI,sin=Math.sin,charts=H.charts,deg2rad=H.deg2rad,perspective=H.perspective;function curveTo(t,e,r,i,s,n,a,o){var d=[],h=n-s;return n>s&&n-s>Math.PI/2+1e-4?d=(d=d.concat(curveTo(t,e,r,i,s,s+Math.PI/2,a,o))).concat(curveTo(t,e,r,i,s+Math.PI/2,n,a,o)):n<s&&s-n>Math.PI/2+1e-4?d=(d=d.concat(curveTo(t,e,r,i,s,s-Math.PI/2,a,o))).concat(curveTo(t,e,r,i,s-Math.PI/2,n,a,o)):[["C",t+r*Math.cos(s)-r*dFactor*h*Math.sin(s)+a,e+i*Math.sin(s)+i*dFactor*h*Math.cos(s)+o,t+r*Math.cos(n)+r*dFactor*h*Math.sin(n)+a,e+i*Math.sin(n)-i*dFactor*h*Math.cos(n)+o,t+r*Math.cos(n)+a,e+i*Math.sin(n)+o]]}dFactor=4*(Math.sqrt(2)-1)/3/(PI/2),SVGRenderer.prototype.toLinePath=function(t,e){var r=[];return t.forEach(function(t){r.push(["L",t.x,t.y])}),t.length&&(r[0][0]="M",e&&r.push(["Z"])),r},SVGRenderer.prototype.toLineSegments=function(t){var e=[],r=!0;return t.forEach(function(t){e.push(r?["M",t.x,t.y]:["L",t.x,t.y]),r=!r}),e},SVGRenderer.prototype.face3d=function(t){var e=this,r=this.createElement("path");return r.vertexes=[],r.insidePlotArea=!1,r.enabled=!0,r.attr=function(t){if("object"==typeof t&&(defined(t.enabled)||defined(t.vertexes)||defined(t.insidePlotArea))){this.enabled=pick(t.enabled,this.enabled),this.vertexes=pick(t.vertexes,this.vertexes),this.insidePlotArea=pick(t.insidePlotArea,this.insidePlotArea),delete t.enabled,delete t.vertexes,delete t.insidePlotArea;var r=charts[e.chartIndex],i=perspective(this.vertexes,r,this.insidePlotArea),s=e.toLinePath(i,!0),n=H.shapeArea(i),a=this.enabled&&n>0?"visible":"hidden";t.d=s,t.visibility=a}return SVGElement.prototype.attr.apply(this,arguments)},r.animate=function(t){if("object"==typeof t&&(defined(t.enabled)||defined(t.vertexes)||defined(t.insidePlotArea))){this.enabled=pick(t.enabled,this.enabled),this.vertexes=pick(t.vertexes,this.vertexes),this.insidePlotArea=pick(t.insidePlotArea,this.insidePlotArea),delete t.enabled,delete t.vertexes,delete t.insidePlotArea;var r=charts[e.chartIndex],i=perspective(this.vertexes,r,this.insidePlotArea),s=e.toLinePath(i,!0),n=H.shapeArea(i),a=this.enabled&&n>0?"visible":"hidden";t.d=s,this.attr("visibility",a)}return SVGElement.prototype.animate.apply(this,arguments)},r.attr(t)},SVGRenderer.prototype.polyhedron=function(t){var e=this,r=this.g(),i=r.destroy;return this.styledMode||r.attr({"stroke-linejoin":"round"}),r.faces=[],r.destroy=function(){for(var t=0;t<r.faces.length;t++)r.faces[t].destroy();return i.call(this)},r.attr=function(t,i,s,n){if("object"==typeof t&&defined(t.faces)){for(;r.faces.length>t.faces.length;)r.faces.pop().destroy();for(;r.faces.length<t.faces.length;)r.faces.push(e.face3d().add(r));for(var a=0;a<t.faces.length;a++)e.styledMode&&delete t.faces[a].fill,r.faces[a].attr(t.faces[a],null,s,n);delete t.faces}return SVGElement.prototype.attr.apply(this,arguments)},r.animate=function(t,i,s){if(t&&t.faces){for(;r.faces.length>t.faces.length;)r.faces.pop().destroy();for(;r.faces.length<t.faces.length;)r.faces.push(e.face3d().add(r));for(var n=0;n<t.faces.length;n++)r.faces[n].animate(t.faces[n],i,s);delete t.faces}return SVGElement.prototype.animate.apply(this,arguments)},r.attr(t)},cuboidMethods=merge(element3dMethods={initArgs:function(t){var e=this,r=e.renderer,i=r[e.pathType+"Path"](t),s=i.zIndexes;e.parts.forEach(function(t){e[t]=r.path(i[t]).attr({class:"highcharts-3d-"+t,zIndex:s[t]||0}).add(e)}),e.attr({"stroke-linejoin":"round",zIndex:s.group}),e.originalDestroy=e.destroy,e.destroy=e.destroyParts,e.forcedSides=i.forcedSides},singleSetterForParts:function(t,e,r,i,s,n){var a={},o=[null,null,i||"attr",s,n],d=r&&r.zIndexes;return r?(d&&d.group&&this.attr({zIndex:d.group}),objectEach(r,function(e,i){a[i]={},a[i][t]=e,d&&(a[i].zIndex=r.zIndexes[i]||0)}),o[1]=a):(a[t]=e,o[0]=a),this.processParts.apply(this,o)},processParts:function(t,e,r,i,s){var n=this;return n.parts.forEach(function(a){e&&(t=pick(e[a],!1)),!1!==t&&n[a][r](t,i,s)}),n},destroyParts:function(){return this.processParts(null,null,"destroy"),this.originalDestroy()}},{parts:["front","top","side"],pathType:"cuboid",attr:function(t,e,r,i){if("string"==typeof t&&void 0!==e){var s=t;(t={})[s]=e}return t.shapeArgs||defined(t.x)?this.singleSetterForParts("d",null,this.renderer[this.pathType+"Path"](t.shapeArgs||t)):SVGElement.prototype.attr.call(this,t,void 0,r,i)},animate:function(t,e,r){if(defined(t.x)&&defined(t.y)){var i=this.renderer[this.pathType+"Path"](t),s=i.forcedSides;this.singleSetterForParts("d",null,i,"animate",e,r),this.attr({zIndex:i.zIndexes.group}),s!==this.forcedSides&&(this.forcedSides=s,cuboidMethods.fillSetter.call(this,this.fill))}else SVGElement.prototype.animate.call(this,t,e,r);return this},fillSetter:function(t){return this.forcedSides=this.forcedSides||[],this.singleSetterForParts("fill",null,{front:t,top:color(t).brighten(this.forcedSides.indexOf("top")>=0?0:.1).get(),side:color(t).brighten(this.forcedSides.indexOf("side")>=0?0:-.1).get()}),this.color=this.fill=t,this}}),SVGRenderer.prototype.elements3d={base:element3dMethods,cuboid:cuboidMethods},SVGRenderer.prototype.element3d=function(t,e){var r=this.g();return extend(r,this.elements3d[t]),r.initArgs(e),r},SVGRenderer.prototype.cuboid=function(t){return this.element3d("cuboid",t)},SVGRenderer.prototype.cuboidPath=function(t){var e,r,i,s,n,a,o,d,h=t.x,c=t.y,p=t.z||0,l=t.height,u=t.width,f=t.depth,y=charts[this.chartIndex],v=y.options.chart.options3d.alpha,x=0,M=[{x:h,y:c,z:p},{x:h+u,y:c,z:p},{x:h+u,y:c+l,z:p},{x:h,y:c+l,z:p},{x:h,y:c+l,z:p+f},{x:h+u,y:c+l,z:p+f},{x:h+u,y:c,z:p+f},{x:h,y:c,z:p+f}],P=[];function m(t){return 0===l&&t>1&&t<6?{x:M[t].x,y:M[t].y+10,z:M[t].z}:M[0].x===M[7].x&&t>=4?{x:M[t].x+10,y:M[t].y,z:M[t].z}:0===f&&t<2||t>5?{x:M[t].x,y:M[t].y,z:M[t].z+10}:M[t]}function b(t){return M[t]}return M=perspective(M,y,t.insidePlotArea),r=(e=(d=function(t,e,r){var i=[[],-1],s=t.map(b),n=e.map(b),a=t.map(m),o=e.map(m);return H.shapeArea(s)<0?i=[s,0]:H.shapeArea(n)<0?i=[n,1]:r&&(P.push(r),i=H.shapeArea(a)<0?[s,0]:H.shapeArea(o)<0?[n,1]:[s,0]),i})([3,2,1,0],[7,6,5,4],"front"))[0],n=e[1],i=(e=d([1,6,7,0],[4,5,2,3],"top"))[0],a=e[1],s=(e=d([1,2,5,6],[0,7,4,3],"side"))[0],1===(o=e[1])?x+=1e6*(y.plotWidth-h):o||(x+=1e6*h),x+=10*(!a||v>=0&&v<=180||v<360&&v>357.5?y.plotHeight-c:10+c),1===n?x+=100*p:n||(x+=100*(1e3-p)),{front:this.toLinePath(r,!0),top:this.toLinePath(i,!0),side:this.toLinePath(s,!0),zIndexes:{group:Math.round(x)},forcedSides:P,isFront:n,isTop:a}},SVGRenderer.prototype.arc3d=function(t){var e=this.g(),r=e.renderer,i=["x","y","r","innerR","start","end","depth"];function s(t){var e,r=!1,s={};for(e in t=merge(t))-1!==i.indexOf(e)&&(s[e]=t[e],delete t[e],r=!0);return!!r&&[s,t]}return(t=merge(t)).alpha=(t.alpha||0)*deg2rad,t.beta=(t.beta||0)*deg2rad,e.top=r.path(),e.side1=r.path(),e.side2=r.path(),e.inn=r.path(),e.out=r.path(),e.onAdd=function(){var t=e.parentGroup,r=e.attr("class");e.top.add(e),["out","inn","side1","side2"].forEach(function(i){e[i].attr({class:r+" highcharts-3d-side"}).add(t)})},["addClass","removeClass"].forEach(function(t){e[t]=function(){var r=arguments;["top","out","inn","side1","side2"].forEach(function(i){e[i][t].apply(e[i],r)})}}),e.setPaths=function(t){var r=e.renderer.arc3dPath(t),i=100*r.zTop;e.attribs=t,e.top.attr({d:r.top,zIndex:r.zTop}),e.inn.attr({d:r.inn,zIndex:r.zInn}),e.out.attr({d:r.out,zIndex:r.zOut}),e.side1.attr({d:r.side1,zIndex:r.zSide1}),e.side2.attr({d:r.side2,zIndex:r.zSide2}),e.zIndex=i,e.attr({zIndex:i}),t.center&&(e.top.setRadialReference(t.center),delete t.center)},e.setPaths(t),e.fillSetter=function(t){var e=color(t).brighten(-.1).get();return this.fill=t,this.side1.attr({fill:e}),this.side2.attr({fill:e}),this.inn.attr({fill:e}),this.out.attr({fill:e}),this.top.attr({fill:t}),this},["opacity","translateX","translateY","visibility"].forEach(function(t){e[t+"Setter"]=function(t,r){e[r]=t,["out","inn","side1","side2","top"].forEach(function(i){e[i].attr(r,t)})}}),e.attr=function(t){var r,i;return"object"==typeof t&&(i=s(t))&&(r=i[0],arguments[0]=i[1],extend(e.attribs,r),e.setPaths(e.attribs)),SVGElement.prototype.attr.apply(e,arguments)},e.animate=function(t,r,i){var n,a,o,d=this.attribs,h="data-"+Math.random().toString(26).substring(2,9);return delete t.center,delete t.z,delete t.alpha,delete t.beta,(o=animObject(pick(r,this.renderer.globalAnimation))).duration&&(n=s(t),e[h]=0,t[h]=1,e[h+"Setter"]=H.noop,n&&(a=n[0],o.step=function(t,e){function r(t){return d[t]+(pick(a[t],d[t])-d[t])*e.pos}e.prop===h&&e.elem.setPaths(merge(d,{x:r("x"),y:r("y"),r:r("r"),innerR:r("innerR"),start:r("start"),end:r("end"),depth:r("depth")}))}),r=o),SVGElement.prototype.animate.call(this,t,r,i)},e.destroy=function(){return this.top.destroy(),this.out.destroy(),this.inn.destroy(),this.side1.destroy(),this.side2.destroy(),SVGElement.prototype.destroy.call(this)},e.hide=function(){this.top.hide(),this.out.hide(),this.inn.hide(),this.side1.hide(),this.side2.hide()},e.show=function(t){this.top.show(t),this.out.show(t),this.inn.show(t),this.side1.show(t),this.side2.show(t)},e},SVGRenderer.prototype.arc3dPath=function(t){var e=t.x,r=t.y,i=t.start,s=t.end-1e-5,n=t.r,a=t.innerR||0,o=t.depth||0,d=t.alpha,h=t.beta,c=Math.cos(i),p=Math.sin(i),l=Math.cos(s),u=Math.sin(s),f=n*Math.cos(h),y=n*Math.cos(d),v=a*Math.cos(h),x=a*Math.cos(d),M=o*Math.sin(h),P=o*Math.sin(d),m=[["M",e+f*c,r+y*p]];(m=m.concat(curveTo(e,r,f,y,i,s,0,0))).push(["L",e+v*l,r+x*u]),(m=m.concat(curveTo(e,r,v,x,s,i,0,0))).push(["Z"]);var b=h>0?Math.PI/2:0,g=d>0?0:Math.PI/2,S=i>-b?i:s>-b?-b:i,z=s<PI-g?s:i<PI-g?PI-g:s,I=2*PI-g,A=[["M",e+f*cos(S),r+y*sin(S)]];A=A.concat(curveTo(e,r,f,y,S,z,0,0)),s>I&&i<I?(A.push(["L",e+f*cos(z)+M,r+y*sin(z)+P]),(A=A.concat(curveTo(e,r,f,y,z,I,M,P))).push(["L",e+f*cos(I),r+y*sin(I)]),(A=A.concat(curveTo(e,r,f,y,I,s,0,0))).push(["L",e+f*cos(s)+M,r+y*sin(s)+P]),(A=A.concat(curveTo(e,r,f,y,s,I,M,P))).push(["L",e+f*cos(I),r+y*sin(I)]),A=A.concat(curveTo(e,r,f,y,I,z,0,0))):s>PI-g&&i<PI-g&&(A.push(["L",e+f*Math.cos(z)+M,r+y*Math.sin(z)+P]),(A=A.concat(curveTo(e,r,f,y,z,s,M,P))).push(["L",e+f*Math.cos(s),r+y*Math.sin(s)]),A=A.concat(curveTo(e,r,f,y,s,z,0,0))),A.push(["L",e+f*Math.cos(z)+M,r+y*Math.sin(z)+P]),(A=A.concat(curveTo(e,r,f,y,z,S,M,P))).push(["Z"]);var G=[["M",e+v*c,r+x*p]];(G=G.concat(curveTo(e,r,v,x,i,s,0,0))).push(["L",e+v*Math.cos(s)+M,r+x*Math.sin(s)+P]),(G=G.concat(curveTo(e,r,v,x,s,i,M,P))).push(["Z"]);var T=[["M",e+f*c,r+y*p],["L",e+f*c+M,r+y*p+P],["L",e+v*c+M,r+x*p+P],["L",e+v*c,r+x*p],["Z"]],E=[["M",e+f*l,r+y*u],["L",e+f*l+M,r+y*u+P],["L",e+v*l+M,r+x*u+P],["L",e+v*l,r+x*u],["Z"]],L=Math.atan2(P,-M),V=Math.abs(s+L),R=Math.abs(i+L),j=Math.abs((i+s)/2+L);function k(t){return(t%=2*Math.PI)>Math.PI&&(t=2*Math.PI-t),t}V=k(V),R=k(R);var H=1e5*(j=k(j)),F=1e5*R,O=1e5*V;return{top:m,zTop:1e5*Math.PI+1,out:A,zOut:Math.max(H,F,O),inn:G,zInn:Math.max(H,F,O),side1:T,zSide1:.99*O,side2:E,zSide2:.99*F}};