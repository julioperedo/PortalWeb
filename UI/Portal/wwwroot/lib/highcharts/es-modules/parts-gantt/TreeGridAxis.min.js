"use strict";import Axis from"../parts/Axis.js";import Tick from"../parts/Tick.js";import Tree from"./Tree.js";import TreeGridTick from"./TreeGridTick.js";import TreeSeriesMixin from"../mixins/tree-series.js";import U from"../parts/Utilities.js";var TreeGridAxis,addEvent=U.addEvent,find=U.find,fireEvent=U.fireEvent,isNumber=U.isNumber,isObject=U.isObject,isString=U.isString,merge=U.merge,pick=U.pick,wrap=U.wrap;import"./GridAxis.js";import"../modules/broken-axis.src.js";!function(e){var t=!1;function i(e,t){var i=e.collapseStart||0,r=e.collapseEnd||0;return r>=t&&(i-=.5),{from:i,to:r,showPoints:!1}}function r(e,t,i){var r,o=[],s=[],n={},a={},d=-1,p="boolean"==typeof t&&t,c={after:function(e){var t=a[e.pos],i=0,r=0;t.children.forEach(function(e){r+=(e.descendants||0)+1,i=Math.max((e.height||0)+1,i)}),t.descendants=r,t.height=i,t.collapsed&&s.push(t)},before:function(e){var t,i,r=isObject(e.data,!0)?e.data:{},s=isString(r.name)?r.name:"",c=n[e.parent],l=isObject(c,!0)?a[c.pos]:null;p&&isObject(l,!0)&&(t=find(l.children,function(e){return e.name===s}))?(i=t.pos,t.nodes.push(e)):i=d++,a[i]||(a[i]=t={depth:l?l.depth+1:0,name:s,nodes:[e],children:[],pos:i},-1!==i&&o.push(s),isObject(l,!0)&&l.children.push(t)),isString(e.id)&&(n[e.id]=e),t&&!0===r.collapsed&&(t.collapsed=!0),e.pos=i}};return r=Tree.getTree(e,c),a=function(e,t){var i=function(e,r,o){var s=e.nodes,n=r+(-1===r?0:t-1),a=(n-r)/2,d=r+a;return s.forEach(function(e){var t=e.data;isObject(t,!0)&&(t.y=r+(t.seriesIndex||0),delete t.seriesIndex),e.pos=d}),o[d]=e,e.pos=d,e.tickmarkOffset=a+.5,e.collapseStart=n+.5,e.children.forEach(function(e){i(e,n+1,o),n=(e.collapseEnd||0)-.5}),e.collapseEnd=n+.5,o};return i(e[-1],-1,{})}(a,i),{categories:o,mapOfIdToNode:n,mapOfPosToGridNode:a,collapsedNodes:s,tree:r}}function o(e){e.target.axes.filter(function(e){return"treegrid"===e.options.type}).forEach(function(t){var i,o=t.options||{},s=o.labels,n=o.uniqueNames,a=0;(!t.treeGrid.mapOfPosToGridNode||t.series.some(function(e){return!e.hasRendered||e.isDirtyData||e.isDirty}))&&(i=r(t.series.reduce(function(e,t){return t.visible&&((t.options.data||[]).forEach(function(t){isObject(t,!0)&&(t.seriesIndex=a,e.push(t))}),!0===n&&a++),e},[]),n||!1,!0===n?a:1),t.categories=i.categories,t.treeGrid.mapOfPosToGridNode=i.mapOfPosToGridNode,t.hasNames=!0,t.treeGrid.tree=i.tree,t.series.forEach(function(e){var t=(e.options.data||[]).map(function(e){return isObject(e,!0)?merge(e):e});e.visible&&e.setData(t,!1)}),t.treeGrid.mapOptionsToLevel=TreeSeriesMixin.getLevelOptions({defaults:s,from:1,levels:s&&s.levels,to:t.treeGrid.tree&&t.treeGrid.tree.height}),"beforeRender"===e.type&&(t.treeGrid.collapsedNodes=i.collapsedNodes))})}function s(e,t){var i,r,o,s=this.treeGrid.mapOptionsToLevel||{},n="treegrid"===this.options.type,a=this.ticks,d=a[t];n&&this.treeGrid.mapOfPosToGridNode?((i=s[(o=this.treeGrid.mapOfPosToGridNode[t]).depth])&&(r={labels:i}),d?(d.parameters.category=o.name,d.options=r,d.addLabel()):a[t]=d=new Tick(this,t,void 0,void 0,{category:o.name,tickmarkOffset:o.tickmarkOffset,options:r})):e.apply(this,Array.prototype.slice.call(arguments,1))}function n(e){var t,i=this.options,r=i&&i.labels,o=r&&isNumber(r.indentation)?r.indentation:0,s=e.apply(this,Array.prototype.slice.call(arguments,1));return"treegrid"===this.options.type&&this.treeGrid.mapOfPosToGridNode&&(t=this.treeGrid.mapOfPosToGridNode[-1].height||0,s.width+=o*(t-1)),s}function a(e,t,i){var s=this,n="treegrid"===i.type;s.treeGrid||(s.treeGrid=new p(s)),n&&(addEvent(t,"beforeRender",o),addEvent(t,"beforeRedraw",o),addEvent(t,"addSeries",function(e){if(e.options.data){var t=r(e.options.data,i.uniqueNames||!1,1);s.treeGrid.collapsedNodes=(s.treeGrid.collapsedNodes||[]).concat(t.collapsedNodes)}}),addEvent(s,"foundExtremes",function(){s.treeGrid.collapsedNodes&&s.treeGrid.collapsedNodes.forEach(function(e){var t=s.treeGrid.collapse(e);s.brokenAxis&&(s.brokenAxis.setBreaks(t,!1),s.treeGrid.collapsedNodes&&(s.treeGrid.collapsedNodes=s.treeGrid.collapsedNodes.filter(function(t){return e.collapseStart!==t.collapseStart||e.collapseEnd!==t.collapseEnd})))})}),addEvent(s,"afterBreaks",function(){var e;"yAxis"===s.coll&&!s.staticScale&&(null===(e=s.chart.options.chart)||void 0===e?void 0:e.height)&&(s.isDirty=!0)}),i=merge({grid:{enabled:!0},labels:{align:"left",levels:[{level:void 0},{level:1,style:{fontWeight:"bold"}}],symbol:{type:"triangle",x:-5,y:-5,height:10,width:10,padding:5}},uniqueNames:!1},i,{reversed:!0,grid:{columns:void 0}})),e.apply(s,[t,i]),n&&(s.hasNames=!0,s.options.showLastLabel=!0)}function d(e){var t=this.options;"treegrid"===t.type?(this.min=pick(this.userMin,t.min,this.dataMin),this.max=pick(this.userMax,t.max,this.dataMax),fireEvent(this,"foundExtremes"),this.setAxisTranslation(!0),this.tickmarkOffset=.5,this.tickInterval=1,this.tickPositions=this.treeGrid.mapOfPosToGridNode?this.treeGrid.getTickPositions():[]):e.apply(this,Array.prototype.slice.call(arguments,1))}e.compose=function(e){t||(wrap(e.prototype,"generateTick",s),wrap(e.prototype,"getMaxLabelDimensions",n),wrap(e.prototype,"init",a),wrap(e.prototype,"setTickInterval",d),TreeGridTick.compose(Tick),t=!0)};var p=function(){function e(e){this.axis=e}return e.prototype.collapse=function(e){var t=this.axis,r=t.options.breaks||[],o=i(e,t.max);return r.push(o),r},e.prototype.expand=function(e){var t=this.axis,r=t.options.breaks||[],o=i(e,t.max);return r.reduce(function(e,t){return t.to===o.to&&t.from===o.from||e.push(t),e},[])},e.prototype.getTickPositions=function(){var e=this.axis;return Object.keys(e.treeGrid.mapOfPosToGridNode||{}).reduce(function(t,i){var r=+i;return!(e.min<=r&&e.max>=r)||e.brokenAxis&&e.brokenAxis.isInAnyBreak(r)||t.push(r),t},[])},e.prototype.isCollapsed=function(e){var t=this.axis,r=t.options.breaks||[],o=i(e,t.max);return r.some(function(e){return e.from===o.from&&e.to===o.to})},e.prototype.toggleCollapse=function(e){return this.isCollapsed(e)?this.expand(e):this.collapse(e)},e}();e.Additions=p}(TreeGridAxis||(TreeGridAxis={})),Axis.prototype.utils={getNode:Tree.getNode},TreeGridAxis.compose(Axis);export default TreeGridAxis;