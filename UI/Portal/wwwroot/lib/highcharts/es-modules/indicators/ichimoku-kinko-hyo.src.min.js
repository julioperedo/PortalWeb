"use strict";import H from"../parts/Globals.js";import Color from"../parts/Color.js";var color=Color.parse;import U from"../parts/Utilities.js";var UNDEFINED,defined=U.defined,isArray=U.isArray,merge=U.merge,objectEach=U.objectEach,seriesType=U.seriesType,SMA=H.seriesTypes.sma;function maxHigh(o){return o.reduce(function(o,n){return Math.max(o,n[1])},-1/0)}function minLow(o){return o.reduce(function(o,n){return Math.min(o,n[2])},1/0)}function highlowLevel(o){return{high:maxHigh(o),low:minLow(o)}}function getClosestPointRange(o){var n,t,e,i,p;return o.series.forEach(function(o){if(o.xData)for(i=o.xData,t=o.xIncrement?1:i.length-1,p=t;p>0;p--)e=i[p]-i[p-1],(n===UNDEFINED||e<n)&&(n=e)}),n}function checkLineIntersection(o,n,t,e){if(o&&n&&t&&e){var i,p,a=n.plotX-o.plotX,l=n.plotY-o.plotY,r=e.plotX-t.plotX,s=e.plotY-t.plotY,h=o.plotX-t.plotX,c=o.plotY-t.plotY;if(p=(r*c-s*h)/(-r*l+a*s),(i=(-l*h+a*c)/(-r*l+a*s))>=0&&i<=1&&p>=0&&p<=1)return{plotX:o.plotX+p*a,plotY:o.plotY+p*l}}return!1}function drawSenkouSpan(o){var n=o.indicator;n.points=o.points,n.nextPoints=o.nextPoints,n.color=o.color,n.options=merge(o.options.senkouSpan.styles,o.gap),n.graph=o.graph,n.fillGraph=!0,SMA.prototype.drawGraph.call(n)}H.approximations["ichimoku-averages"]=function(){var o,n=[];return[].forEach.call(arguments,function(t,e){n.push(H.approximations.average(t)),o=!o&&void 0===n[e]}),o?void 0:n},seriesType("ikh","sma",{params:{period:26,periodTenkan:9,periodSenkouSpanB:52},marker:{enabled:!1},tooltip:{pointFormat:'<span style="color:{point.color}">‚óè</span> <b> {series.name}</b><br/>TENKAN SEN: {point.tenkanSen:.3f}<br/>KIJUN SEN: {point.kijunSen:.3f}<br/>CHIKOU SPAN: {point.chikouSpan:.3f}<br/>SENKOU SPAN A: {point.senkouSpanA:.3f}<br/>SENKOU SPAN B: {point.senkouSpanB:.3f}<br/>'},tenkanLine:{styles:{lineWidth:1,lineColor:void 0}},kijunLine:{styles:{lineWidth:1,lineColor:void 0}},chikouLine:{styles:{lineWidth:1,lineColor:void 0}},senkouSpanA:{styles:{lineWidth:1,lineColor:void 0}},senkouSpanB:{styles:{lineWidth:1,lineColor:void 0}},senkouSpan:{styles:{fill:"rgba(255, 0, 0, 0.5)"}},dataGrouping:{approximation:"ichimoku-averages"}},{pointArrayMap:["tenkanSen","kijunSen","chikouSpan","senkouSpanA","senkouSpanB"],pointValKey:"tenkanSen",nameComponents:["periodSenkouSpanB","period","periodTenkan"],init:function(){SMA.prototype.init.apply(this,arguments),this.options=merge({tenkanLine:{styles:{lineColor:this.color}},kijunLine:{styles:{lineColor:this.color}},chikouLine:{styles:{lineColor:this.color}},senkouSpanA:{styles:{lineColor:this.color,fill:color(this.color).setOpacity(.5).get()}},senkouSpanB:{styles:{lineColor:this.color,fill:color(this.color).setOpacity(.5).get()}},senkouSpan:{styles:{fill:color(this.color).setOpacity(.2).get()}}},this.options)},toYData:function(o){return[o.tenkanSen,o.kijunSen,o.chikouSpan,o.senkouSpanA,o.senkouSpanB]},translate:function(){var o=this;SMA.prototype.translate.apply(o),o.points.forEach(function(n){o.pointArrayMap.forEach(function(t){defined(n[t])&&(n["plot"+t]=o.yAxis.toPixels(n[t],!0),n.plotY=n["plot"+t],n.tooltipPos=[n.plotX,n["plot"+t]],n.isNull=!1)})})},drawGraph:function(){var o,n,t,e,i,p,a,l,r,s,h,c,u,g=this,S=g.points,k=S.length,f=g.options,d=g.graph,y=g.color,A={options:{gapSize:f.gapSize}},m=g.pointArrayMap.length,v=[[],[],[],[],[],[]],E={tenkanLine:v[0],kijunLine:v[1],chikouLine:v[2],senkouSpanA:v[3],senkouSpanB:v[4],senkouSpan:v[5]},N=[],C=g.options.senkouSpan,D=C.color||C.styles.fill,x=C.negativeColor,Y=[[],[]],P=[[],[]],U=0;for(g.ikhMap=E;k--;){for(n=S[k],t=0;t<m;t++)o=g.pointArrayMap[t],defined(n[o])&&v[t].push({plotX:n.plotX,plotY:n["plot"+o],isNull:!1});if(x&&k!==S.length-1){var L=E.senkouSpanB.length-1,B=checkLineIntersection(E.senkouSpanA[L-1],E.senkouSpanA[L],E.senkouSpanB[L-1],E.senkouSpanB[L]),M={plotX:B.plotX,plotY:B.plotY,isNull:!1,intersectPoint:!0};B&&(E.senkouSpanA.splice(L,0,M),E.senkouSpanB.splice(L,0,M),N.push(L))}}if(objectEach(E,function(o,n){f[n]&&"senkouSpan"!==n&&(g.points=v[U],g.options=merge(f[n].styles,A),g.graph=g["graph"+n],g.fillGraph=!1,g.color=y,SMA.prototype.drawGraph.call(g),g["graph"+n]=g.graph),U++}),g.graphCollection&&g.graphCollection.forEach(function(o){g[o].destroy(),delete g[o]}),g.graphCollection=[],x&&E.senkouSpanA[0]&&E.senkouSpanB[0]){for(N.unshift(0),N.push(E.senkouSpanA.length-1),c=0;c<N.length-1;c++)if(e=N[c],i=N[c+1],p=E.senkouSpanB.slice(e,i+1),a=E.senkouSpanA.slice(e,i+1),Math.floor(p.length/2)>=1){var w=Math.floor(p.length/2);if(p[w].plotY===a[w].plotY){for(l=0,r=0,u=0;u<p.length;u++)l+=p[u].plotY,r+=a[u].plotY;Y[h=l>r?0:1]=Y[h].concat(p),P[h]=P[h].concat(a)}else h=p[w].plotY>a[w].plotY?0:1,Y[h]=Y[h].concat(p),P[h]=P[h].concat(a)}else h=p[0].plotY>a[0].plotY?0:1,Y[h]=Y[h].concat(p),P[h]=P[h].concat(a);["graphsenkouSpanColor","graphsenkouSpanNegativeColor"].forEach(function(o,n){Y[n].length&&P[n].length&&(s=0===n?D:x,drawSenkouSpan({indicator:g,points:Y[n],nextPoints:P[n],color:s,options:f,gap:A,graph:g[o]}),g[o]=g.graph,g.graphCollection.push(o))})}else drawSenkouSpan({indicator:g,points:E.senkouSpanB,nextPoints:E.senkouSpanA,color:D,options:f,gap:A,graph:g.graphsenkouSpan}),g.graphsenkouSpan=g.graph;delete g.nextPoints,delete g.fillGraph,g.points=S,g.options=f,g.graph=d},getGraphPath:function(o){var n,t=[],e=[];if(o=o||this.points,this.fillGraph&&this.nextPoints){(n=SMA.prototype.getGraphPath.call(this,this.nextPoints))[0][0]="L",t=SMA.prototype.getGraphPath.call(this,o);for(var i=(e=n.slice(0,t.length)).length-1;i>=0;i--)t.push(e[i])}else t=SMA.prototype.getGraphPath.apply(this,arguments);return t},getValues:function(o,n){var t,e,i,p,a,l,r,s,h,c,u,g=n.period,S=n.periodTenkan,k=n.periodSenkouSpanB,f=o.xData,d=o.yData,y=o.xAxis,A=d&&d.length||0,m=getClosestPointRange(y),v=[],E=[];if(!(f.length<=g)&&isArray(d[0])&&4===d[0].length){for(t=f[0]-g*m,l=0;l<g;l++)E.push(t+l*m);for(l=0;l<A;l++)l>=S&&(r=((i=highlowLevel(d.slice(l-S,l))).high+i.low)/2),l>=g&&(c=(r+(s=((p=highlowLevel(d.slice(l-g,l))).high+p.low)/2))/2),l>=k&&(u=((a=highlowLevel(d.slice(l-k,l))).high+a.low)/2),h=d[l][3],e=f[l],v[l]===UNDEFINED&&(v[l]=[]),v[l+g]===UNDEFINED&&(v[l+g]=[]),v[l+g][0]=r,v[l+g][1]=s,v[l+g][2]=UNDEFINED,v[l][2]=h,l<=g&&(v[l+g][3]=UNDEFINED,v[l+g][4]=UNDEFINED),v[l+2*g]===UNDEFINED&&(v[l+2*g]=[]),v[l+2*g][3]=c,v[l+2*g][4]=u,E.push(e);for(l=1;l<=g;l++)E.push(e+l*m);return{values:v,xData:E,yData:v}}}});