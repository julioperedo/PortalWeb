"use strict";import Axis from"../../Core/Axis/Axis.js";import D from"../../Core/Defaults.js";const defaultOptions=D["defaultOptions"];import H from"../../Core/Globals.js";import RangeSelectorComposition from"./RangeSelectorComposition.js";import SVGElement from"../../Core/Renderer/SVG/SVGElement.js";import U from"../../Core/Utilities.js";const{addEvent,createElement,css,defined,destroyObjectProperties,discardElement,extend,fireEvent,isNumber,merge,objectEach,pad,pick,pInt,splat}=U;function preferredInputType(e){if(-1!==e.indexOf("%L"))return"text";var t=["a","A","d","e","w","b","B","m","o","y","Y"].some(t=>-1!==e.indexOf("%"+t)),i=["H","k","I","l","M","S"].some(t=>-1!==e.indexOf("%"+t));return t&&i?"datetime-local":t?"date":i?"time":"text"}class RangeSelector{static compose(t,e){RangeSelectorComposition.compose(t,e,RangeSelector)}constructor(t){this.buttons=void 0,this.buttonOptions=RangeSelector.prototype.defaultButtons,this.initialButtonGroupWidth=0,this.options=void 0,this.chart=t,this.init(t)}clickButton(t,e){const i=this,n=i.chart,o=i.buttonOptions[t],s=n.xAxis[0],a=n.scroller&&n.scroller.getUnionExtremes()||s||{},r=o.type,h=o.dataGrouping;let d=a.dataMin,l=a.dataMax,p,u=s&&Math.round(Math.min(s.max,pick(l,s.max))),c,m=o._range,g,x,f,b,v,y=!0;if(null!==d&&null!==l){if(n.fixedRange=m,i.setSelected(t),h&&(this.forcedDataGrouping=!0,Axis.prototype.setDataGrouping.call(s||{chart:this.chart},h,!1),this.frozenStates=o.preserveDataGrouping),"month"===r||"year"===r)s?(b={range:o,max:u,chart:n,dataMin:d,dataMax:l},p=s.minFromRange.call(b),isNumber(b.newMax)&&(u=b.newMax),y=!1):m=o;else if(m)p=Math.max(u-m,d),u=Math.min(p+m,l),y=!1;else if("ytd"===r){if(!s)return void(i.deferredYTDClick=t);void 0!==l&&void 0!==d||(d=Number.MAX_VALUE,l=Number.MIN_VALUE,n.series.forEach(t=>{t=t.xData;t&&(d=Math.min(t[0],d),l=Math.max(t[t.length-1],l))}),e=!1),v=i.getYTDExtremes(l,d,n.time.useUTC),p=g=v.min,u=v.max}else"all"===r&&s&&(n.navigator&&n.navigator.baseSeries[0]&&(n.navigator.baseSeries[0].xAxis.options.range=void 0),p=d,u=l);y&&o._offsetMin&&defined(p)&&(p+=o._offsetMin),o._offsetMax&&defined(u)&&(u+=o._offsetMax),this.dropdown&&(this.dropdown.selectedIndex=t+1),s?s.setExtremes(p,u,pick(e,!0),void 0,{trigger:"rangeSelectorButton",rangeSelectorButton:o}):(c=splat(n.options.xAxis)[0],f=c.range,c.range=m,x=c.min,c.min=g,addEvent(n,"load",function(){c.range=f,c.min=x})),fireEvent(this,"afterBtnClick")}}setSelected(t){this.selected=this.options.selected=t}init(e){function t(){var t=i.minInput,e=i.maxInput;t&&t.blur&&fireEvent(t,"blur"),e&&e.blur&&fireEvent(e,"blur")}const i=this,n=e.options.rangeSelector,o=n.buttons||i.defaultButtons.slice(),s=n.selected;i.chart=e,i.options=n,i.buttons=[],i.buttonOptions=o,this.eventsToUnbind=[],this.eventsToUnbind.push(addEvent(e.container,"mousedown",t)),this.eventsToUnbind.push(addEvent(e,"resize",t)),o.forEach(i.computeButtonRange),void 0!==s&&o[s]&&this.clickButton(s,!1),this.eventsToUnbind.push(addEvent(e,"load",function(){e.xAxis&&e.xAxis[0]&&addEvent(e.xAxis[0],"setExtremes",function(t){this.max-this.min!==e.fixedRange&&"rangeSelectorButton"!==t.trigger&&"updatedData"!==t.trigger&&i.forcedDataGrouping&&!i.frozenStates&&this.setDataGrouping(!1,!1)})}))}updateButtonStates(){const g=this,t=this.chart,x=this.dropdown,f=t.xAxis[0],b=Math.round(f.max-f.min),v=!f.hasVisibleSeries,e=t.scroller&&t.scroller.getUnionExtremes()||f,y=e.dataMin,B=e.dataMax,i=g.getYTDExtremes(B,y,t.time.useUTC),w=i.min,I=i.max,E=g.selected,S=g.options.allButtonsEnabled,M=g.buttons;let T=isNumber(E);g.buttonOptions.forEach((t,e)=>{const i=t._range,n=t.type,o=t.count||1,s=M[e],a=t._offsetMax-t._offsetMin,r=e===E,h=i>B-y,d=i<f.minRange;let l=0,p=!1,u=!1,c=i===b;("month"===n||"year"===n)&&b+36e5>=864e5*{month:28,year:365}[n]*o-a&&b-36e5<=864e5*{month:31,year:366}[n]*o+a?c=!0:"ytd"===n?(c=I-w+a===b,p=!r):"all"===n&&(c=f.max-f.min>=B-y,u=!r&&T&&c);var t=!S&&(h||d||u||v),m=r&&c||c&&!T&&!p||r&&g.frozenStates;t?l=3:m&&(T=!0,l=2),s.state!==l&&(s.setState(l),x&&(x.options[e+1].disabled=t,2===l&&(x.selectedIndex=e+1)),0===l&&E===e&&g.setSelected())})}computeButtonRange(t){var e=t.type,i=t.count||1,n={millisecond:1,second:1e3,minute:6e4,hour:36e5,day:864e5,week:6048e5};n[e]?t._range=n[e]*i:"month"!==e&&"year"!==e||(t._range=24*{month:30,year:365}[e]*36e5*i),t._offsetMin=pick(t.offsetMin,0),t._offsetMax=pick(t.offsetMax,0),t._range+=t._offsetMax-t._offsetMin}getInputValue(t){t="min"===t?this.minInput:this.maxInput;const e=this.chart.options.rangeSelector;var i=this.chart.time;return t?("text"===t.type&&e.inputDateParser||this.defaultInputDateParser)(t.value,i.useUTC,i):0}setInputValue(e,i){const n=this.options,o=this.chart.time,s="min"===e?this.minInput:this.maxInput,a="min"===e?this.minDateBox:this.maxDateBox;if(s){var e=s.getAttribute("data-hc-time");let t=defined(e)?Number(e):void 0;defined(i)&&(e=t,defined(e)&&s.setAttribute("data-hc-time-previous",e),s.setAttribute("data-hc-time",i),t=i),s.value=o.dateFormat(this.inputTypeFormats[s.type]||n.inputEditDateFormat,t),a&&a.attr({text:o.dateFormat(n.inputDateFormat,t)})}}setInputExtremes(t,e,i){const n="min"===t?this.minInput:this.maxInput;if(n){t=this.inputTypeFormats[n.type];const o=this.chart.time;t&&(e=o.dateFormat(t,e),n.min!==e&&(n.min=e),e=o.dateFormat(t,i),n.max!==e&&(n.max=e))}}showInput(t){var e,i,n,o,s,a,r="min"===t?this.minDateBox:this.maxDateBox,t="min"===t?this.minInput:this.maxInput;t&&r&&this.inputGroup&&(e="text"===t.type,{translateX:i=0,translateY:n=0}=this.inputGroup,{x:r=0,width:o=0,height:s=0}=r,a=this.options["inputBoxWidth"],css(t,{width:e?o+(a?-2:20)+"px":"auto",height:s-2+"px",border:"2px solid silver"}),e&&a?css(t,{left:i+r+"px",top:n+"px"}):css(t,{left:Math.min(Math.round(r+i-(t.offsetWidth-o)/2),this.chart.chartWidth-t.offsetWidth)+"px",top:n-(t.offsetHeight-s)/2+"px"}))}hideInput(t){t="min"===t?this.minInput:this.maxInput;t&&css(t,{top:"-9999em",border:0,width:"1px",height:"1px"})}defaultInputDateParser(t,e,i){var n;let o=t.split("/").join("-").split(" ").join("T"),s=(-1===o.indexOf("T")&&(o+="T00:00"),e?o+="Z":!H.isSafari||6<(n=o).length&&(n.lastIndexOf("-")===n.length-6||n.lastIndexOf("+")===n.length-6)||(n=new Date(o).getTimezoneOffset()/60,o+=n<=0?`+${pad(-n)}:00`:`-${pad(n)}:00`),Date.parse(o));return isNumber(s)||(n=t.split("-"),s=Date.UTC(pInt(n[0]),pInt(n[1])-1,pInt(n[2]))),i&&e&&isNumber(s)&&(s+=i.getTimezoneOffset(s)),s}drawInput(r){const{chart:h,div:t,inputGroup:e}=this,d=this,i=h.renderer.style||{},n=h.renderer,o=h.options.rangeSelector,s=defaultOptions.lang,l="min"===r;function a(){const{maxInput:t,minInput:e}=d,i=h.xAxis[0],n=h.scroller&&h.scroller.getUnionExtremes()||i,o=n.dataMin,s=n.dataMax;let a=d.getInputValue(r);a!==Number(m.getAttribute("data-hc-time-previous"))&&isNumber(a)&&(m.setAttribute("data-hc-time-previous",a),l&&t&&isNumber(o)?a>Number(t.getAttribute("data-hc-time"))?a=void 0:a<o&&(a=o):e&&isNumber(s)&&(a<Number(e.getAttribute("data-hc-time"))?a=void 0:a>s&&(a=s)),void 0!==a&&i.setExtremes(l?a:i.min,l?i.max:a,void 0,void 0,{trigger:"rangeSelectorInput"}))}var p=s[l?"rangeSelectorFrom":"rangeSelectorTo"]||"";const u=n.label(p,0).addClass("highcharts-range-label").attr({padding:p?2:0,height:p?o.inputBoxHeight:0}).add(e),c=n.label("",0).addClass("highcharts-range-input").attr({padding:2,width:o.inputBoxWidth,height:o.inputBoxHeight,"text-align":"center"}).on("click",function(){d.showInput(r),d[r+"Input"].focus()}),m=(h.styledMode||c.attr({stroke:o.inputBoxBorderColor,"stroke-width":1}),c.add(e),createElement("input",{name:r,className:"highcharts-range-selector"},void 0,t));m.setAttribute("type",preferredInputType(o.inputDateFormat||"%e %b %Y")),h.styledMode||(u.css(merge(i,o.labelStyle)),c.css(merge({color:"#333333"},i,o.inputStyle)),css(m,extend({position:"absolute",border:0,boxShadow:"0 0 15px rgba(0,0,0,0.3)",width:"1px",height:"1px",padding:0,textAlign:"center",fontSize:i.fontSize,fontFamily:i.fontFamily,top:"-9999em"},o.inputStyle))),m.onfocus=()=>{d.showInput(r)};let g=!(m.onblur=()=>{m===H.doc.activeElement&&a(),d.hideInput(r),d.setInputValue(r),m.blur()});return m.onchange=()=>{g||(a(),d.hideInput(r),m.blur())},m.onkeypress=t=>{13===t.keyCode&&a()},m.onkeydown=t=>{g=!0,38!==t.keyCode&&40!==t.keyCode||a()},m.onkeyup=()=>{g=!1},{dateBox:c,input:m,label:u}}getPosition(){var t=this.chart,e=t.options.rangeSelector,t="top"===e.verticalAlign?t.plotTop-t.axisOffset[0]:0;return{buttonTop:t+e.buttonPosition.y,inputTop:t+e.inputPosition.y-10}}getYTDExtremes(t,e,i){const n=this.chart.time,o=new n.Date(t),s=n.get("FullYear",o),a=i?n.Date.UTC(s,0,1):+new n.Date(s,0,1),r=Math.max(e,a),h=o.getTime();return{max:Math.min(t||h,h),min:r}}render(t,e){const i=this.chart,n=i.renderer,o=i.container,s=i.options,a=s.rangeSelector,r=pick(s.chart.style&&s.chart.style.zIndex,0)+1,h=a.inputEnabled,d=this.rendered;if(!1!==a.enabled){if(d||(this.group=n.g("range-selector-group").attr({zIndex:7}).add(),this.div=createElement("div",void 0,{position:"relative",height:0,zIndex:r}),this.buttonOptions.length&&this.renderButtons(),o.parentNode&&o.parentNode.insertBefore(this.div,o),h&&(this.inputGroup=n.g("input-group").add(this.group),l=this.drawInput("min"),this.minDateBox=l.dateBox,this.minLabel=l.label,this.minInput=l.input,l=this.drawInput("max"),this.maxDateBox=l.dateBox,this.maxLabel=l.label,this.maxInput=l.input)),h){this.setInputValue("min",t),this.setInputValue("max",e);var l=i.scroller&&i.scroller.getUnionExtremes()||i.xAxis[0]||{};if(defined(l.dataMin)&&defined(l.dataMax)&&(t=i.xAxis[0].minRange||0,this.setInputExtremes("min",l.dataMin,Math.min(l.dataMax,this.getInputValue("max"))-t),this.setInputExtremes("max",Math.max(l.dataMin,this.getInputValue("min"))+t,l.dataMax)),this.inputGroup){let i=0;[this.minLabel,this.minDateBox,this.maxLabel,this.maxDateBox].forEach(t=>{var e;t&&(e=t.getBBox()["width"],e&&(t.attr({x:i}),i+=e+a.inputSpacing))})}}this.alignElements(),this.rendered=!0}}renderButtons(){const{buttons:s,chart:t,options:e}=this;var i=defaultOptions.lang;const a=t.renderer,r=merge(e.buttonTheme),h=r&&r.states,d=r.width||28,l=(delete r.width,delete r.states,this.buttonGroup=a.g("range-selector-buttons").add(this.group),this.dropdown=createElement("select",void 0,{position:"absolute",width:"1px",height:"1px",padding:0,border:0,top:"-9999em",cursor:"pointer",opacity:1e-4},this.div));addEvent(l,"touchstart",()=>{l.style.fontSize="16px"}),[[H.isMS?"mouseover":"mouseenter"],[H.isMS?"mouseout":"mouseleave"],["change","click"]].forEach(([e,i])=>{addEvent(l,e,()=>{var t=s[this.currentButtonIndex()];t&&fireEvent(t.element,i||e)})}),this.zoomText=a.label(i&&i.rangeSelectorZoom||"",0).attr({padding:e.buttonTheme.padding,height:e.buttonTheme.height,paddingLeft:0,paddingRight:0}).add(this.buttonGroup),this.chart.styledMode||(this.zoomText.css(e.labelStyle),r["stroke-width"]=pick(r["stroke-width"],0)),createElement("option",{textContent:this.zoomText.textStr,disabled:!0},void 0,l),this.buttonOptions.forEach((n,o)=>{createElement("option",{textContent:n.title||n.text},void 0,l),s[o]=a.button(n.text,0,0,t=>{const e=n.events&&n.events.click;let i;!1!==(i=e?e.call(n,t):i)&&this.clickButton(o),this.isActive=!0},r,h&&h.hover,h&&h.select,h&&h.disabled).attr({"text-align":"center",width:d}).add(this.buttonGroup),n.title&&s[o].attr("title",n.title)})}alignElements(){const{buttonGroup:o,buttons:s,chart:a,group:r,inputGroup:h,options:d,zoomText:l}=this;var p=a.options;const i=p.exporting&&!1!==p.exporting.enabled&&p.navigation&&p.navigation.buttonOptions,{buttonPosition:u,inputPosition:c,verticalAlign:m}=d;p=(t,e)=>i&&this.titleCollision(a)&&"top"===m&&"right"===e.align&&e.y-t.getBBox().height-12<(i.y||0)+(i.height||0)+a.spacing[0]?-40:0;let g=a.plotLeft;if(r&&u&&c){let t=u.x-a.spacing[3];if(o){if(this.positionButtons(),!this.initialButtonGroupWidth){let i=0;l&&(i+=l.getBBox().width+5),s.forEach((t,e)=>{i+=t.width||0,e!==s.length-1&&(i+=d.buttonSpacing)}),this.initialButtonGroupWidth=i}g-=a.spacing[3],this.updateButtonStates();var x=p(o,u);this.alignButtonGroup(x),r.placed=o.placed=a.hasLoaded}let e=0;h&&(e=p(h,c),"left"===c.align?t=g:"right"===c.align&&(t=-Math.max(a.axisOffset[1],-e)),h.align({y:c.y,width:h.getBBox().width,align:c.align,x:c.x+t-2},!0,a.spacingBox),h.placed=a.hasLoaded),this.handleCollision(e),r.align({verticalAlign:m},!0,a.spacingBox);x=r.alignAttr.translateY;let i=r.getBBox().height+20,n=0;"bottom"===m&&(p=(p=a.legend&&a.legend.options)&&"bottom"===p.verticalAlign&&p.enabled&&!p.floating?a.legend.legendHeight+pick(p.margin,10):0,i=i+p-20,n=x-i-(d.floating?0:d.y)-(a.titleOffset?a.titleOffset[2]:0)-10),"top"===m?(d.floating&&(n=0),a.titleOffset&&a.titleOffset[0]&&(n=a.titleOffset[0]),n+=a.margin[0]-a.spacing[0]||0):"middle"===m&&(c.y===u.y?n=x:(c.y||u.y)&&(c.y<0||u.y<0?n-=Math.min(c.y,u.y):n=x-i)),r.translate(d.x,d.y+Math.floor(n));const{minInput:f,maxInput:b,dropdown:v}=this;d.inputEnabled&&f&&b&&(f.style.marginTop=r.translateY+"px",b.style.marginTop=r.translateY+"px"),v&&(v.style.marginTop=r.translateY+"px")}}alignButtonGroup(t,e){const{chart:i,options:n,buttonGroup:o}=this;var s=n["buttonPosition"],a=i.plotLeft-i.spacing[3];let r=s.x-i.spacing[3];"right"===s.align?r+=t-a:"center"===s.align&&(r-=a/2),o&&o.align({y:s.y,width:pick(e,this.initialButtonGroupWidth),align:s.align,x:r},!0,i.spacingBox)}positionButtons(){const{buttons:i,chart:t,options:n,zoomText:e}=this;var o=t.hasLoaded?"animate":"attr",s=n["buttonPosition"],a=t.plotLeft;let r=a;e&&"hidden"!==e.visibility&&(e[o]({x:pick(a+s.x,a)}),r+=s.x+e.getBBox().width+5);for(let t=0,e=this.buttonOptions.length;t<e;++t)"hidden"!==i[t].visibility?(i[t][o]({x:r}),r+=(i[t].width||0)+n.buttonSpacing):i[t][o]({x:a})}handleCollision(o){const{chart:t,buttonGroup:s,inputGroup:a}=this,{buttonPosition:r,dropdown:e,inputPosition:h}=this.options;var i=()=>{let e=0;return this.buttons.forEach(t=>{t=t.getBBox();t.width>e&&(e=t.width)}),e},n=t=>{var e,i,n;return!(!a||!s)&&(e=a.alignAttr.translateX+a.alignOptions.x-o+a.getBBox().x+2,i=a.alignOptions.width,e<(n=s.alignAttr.translateX+s.getBBox().x)+t&&n<e+i&&r.y<h.y+a.getBBox().height)},d=()=>{a&&s&&a.attr({translateX:a.alignAttr.translateX+(t.axisOffset[1]>=-o?0:-o),translateY:a.alignAttr.translateY+s.getBBox().height+10})};if(s){if("always"===e)return this.collapseButtons(o),void(n(i())&&d());"never"===e&&this.expandButtons()}a&&s?h.align===r.align||n(this.initialButtonGroupWidth+20)?"responsive"===e?(this.collapseButtons(o),n(i())&&d()):d():"responsive"===e&&this.expandButtons():s&&"responsive"===e&&(this.initialButtonGroupWidth>t.plotWidth?this.collapseButtons(o):this.expandButtons())}collapseButtons(t){const{buttons:n,buttonOptions:e,chart:i,dropdown:o,options:s,zoomText:a}=this,r=i.userOptions.rangeSelector&&i.userOptions.rangeSelector.buttonTheme||{},h=t=>({text:t?t+" ▾":"▾",width:"auto",paddingLeft:pick(s.buttonTheme.paddingLeft,r.padding,8),paddingRight:pick(s.buttonTheme.paddingRight,r.padding,8)});a&&a.hide();let d=!1;e.forEach((t,e)=>{const i=n[e];2!==i.state?i.hide():(i.show(),i.attr(h(t.text)),d=!0)}),d||(o&&(o.selectedIndex=0),n[0].show(),n[0].attr(h(this.zoomText&&this.zoomText.textStr)));var l=s.buttonPosition["align"];this.positionButtons(),"right"!==l&&"center"!==l||this.alignButtonGroup(t,n[this.currentButtonIndex()].getBBox().width),this.showDropdown()}expandButtons(){const{buttons:n,buttonOptions:t,options:o,zoomText:e}=this;this.hideDropdown(),e&&e.show(),t.forEach((t,e)=>{const i=n[e];i.show(),i.attr({text:t.text,width:o.buttonTheme.width||28,paddingLeft:pick(o.buttonTheme.paddingLeft,"unset"),paddingRight:pick(o.buttonTheme.paddingRight,"unset")}),i.state<2&&i.setState(0)}),this.positionButtons()}currentButtonIndex(){var t=this["dropdown"];return t&&0<t.selectedIndex?t.selectedIndex-1:0}showDropdown(){const{buttonGroup:t,buttons:e,chart:i,dropdown:n}=this;var o,s,a;t&&n&&({translateX:o=0,translateY:s=0}=t,a=e[this.currentButtonIndex()].getBBox(),css(n,{left:i.plotLeft+o+"px",top:s+.5+"px",width:a.width+"px",height:a.height+"px"}),this.hasVisibleDropdown=!0)}hideDropdown(){var t=this["dropdown"];t&&(css(t,{top:"-9999em",width:"1px",height:"1px"}),this.hasVisibleDropdown=!1)}getHeight(){const t=this.options,e=this.group,i=t.inputPosition,n=t.buttonPosition,o=t.y,s=n.y,a=i.y;let r=0;if(t.height)return t.height;this.alignElements(),r=e?e.getBBox(!0).height+13+o:0;var h=Math.min(a,s);return(a<0&&s<0||0<a&&0<s)&&(r+=Math.abs(h)),r}titleCollision(t){return!(t.options.title.text||t.options.subtitle.text)}update(t){var e=this.chart;merge(!0,e.options.rangeSelector,t),this.destroy(),this.init(e),this.render()}destroy(){const i=this,t=i.minInput,e=i.maxInput;i.eventsToUnbind&&(i.eventsToUnbind.forEach(t=>t()),i.eventsToUnbind=void 0),destroyObjectProperties(i.buttons),t&&(t.onfocus=t.onblur=t.onchange=null),e&&(e.onfocus=e.onblur=e.onchange=null),objectEach(i,function(t,e){t&&"chart"!==e&&(t instanceof SVGElement?t.destroy():t instanceof window.HTMLElement&&discardElement(t)),t!==RangeSelector.prototype[e]&&(i[e]=null)},this)}}extend(RangeSelector.prototype,{defaultButtons:[{type:"month",count:1,text:"1m",title:"View 1 month"},{type:"month",count:3,text:"3m",title:"View 3 months"},{type:"month",count:6,text:"6m",title:"View 6 months"},{type:"ytd",text:"YTD",title:"View year to date"},{type:"year",count:1,text:"1y",title:"View 1 year"},{type:"all",text:"All",title:"View all"}],inputTypeFormats:{"datetime-local":"%Y-%m-%dT%H:%M:%S",date:"%Y-%m-%d",time:"%H:%M:%S"}});export default RangeSelector;