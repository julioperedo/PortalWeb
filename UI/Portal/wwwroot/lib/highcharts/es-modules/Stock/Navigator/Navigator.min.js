"use strict";import Axis from"../../Core/Axis/Axis.js";import D from"../../Core/Defaults.js";const defaultOptions=D["defaultOptions"];import H from"../../Core/Globals.js";const{hasTouch,isTouchDevice}=H;import NavigatorAxisAdditions from"../../Core/Axis/NavigatorAxisComposition.js";import NavigatorComposition from"./NavigatorComposition.js";import Scrollbar from"../Scrollbar/Scrollbar.js";import U from"../../Core/Utilities.js";const{addEvent,clamp,correctFloat,defined,destroyObjectProperties,erase,extend,find,fireEvent,isArray,isNumber,merge,pick,removeEvent,splat}=U;function numExt(e,...t){t=[].filter.call(t,isNumber);if(t.length)return Math[e].apply(0,t)}class Navigator{static compose(e,t,i){NavigatorComposition.compose(e,t,Navigator,i)}constructor(e){this.baseSeries=void 0,this.chart=void 0,this.handles=void 0,this.height=void 0,this.left=void 0,this.navigatorEnabled=void 0,this.navigatorGroup=void 0,this.navigatorOptions=void 0,this.navigatorSeries=void 0,this.navigatorSize=void 0,this.opposite=void 0,this.outline=void 0,this.range=void 0,this.rendered=void 0,this.scrollbarHeight=0,this.scrollButtonSize=void 0,this.shades=void 0,this.size=void 0,this.top=void 0,this.xAxis=void 0,this.yAxis=void 0,this.zoomedMax=void 0,this.zoomedMin=void 0,this.init(e)}drawHandle(e,t,i,a){var s=this,r=s.navigatorOptions.handles.height;s.handles[t][a](i?{translateX:Math.round(s.left+s.height/2),translateY:Math.round(s.top+parseInt(e,10)+.5-r)}:{translateX:Math.round(s.left+parseInt(e,10)),translateY:Math.round(s.top+s.height/2-r/2-1)})}drawOutline(e,t,i,a){var s=this,r=s.navigatorOptions.maskInside,o=s.outline.strokeWidth(),n=o/2,o=o%2/2,d=s.scrollButtonSize,h=s.size,l=s.top,x=s.height,g=l-n,v=l+x;let c=s.left,m,p;i?(m=l+t+o,t=l+e+o,p=[["M",c+x,l-d-o],["L",c+x,m],["L",c,m],["M",c,t],["L",c+x,t],["L",c+x,l+h+d]],r&&p.push(["M",c+x,m-n],["L",c+x,t+n])):(e+=(c-=d)+d-o,t+=c+d-o,p=[["M",c,g],["L",e,g],["L",e,v],["M",t,v],["L",t,g],["L",c+h+2*d,l+n]],r&&p.push(["M",e-n,g],["L",t+n,g])),s.outline[a]({d:p})}drawMasks(e,t,i,a){var s=this,r=s.left,o=s.top,n=s.height;let d,h,l,x;d=i?(l=[r,r,r],x=[o,o+e,o+t],h=[n,n,n],[e,t-e,s.size-t]):(l=[r,r+e,r+t],x=[o,o,o],h=[e,t-e,s.size-t],[n,n,n]),s.shades.forEach((e,t)=>{e[a]({x:l[t],y:x[t],width:h[t],height:d[t]})})}renderElements(){const a=this,s=a.navigatorOptions,e=s.maskInside,r=a.chart,t=r.inverted,o=r.renderer,n={cursor:t?"ns-resize":"ew-resize"},d=a.navigatorGroup=o.g("navigator").attr({zIndex:8,visibility:"hidden"}).add();if([!e,e,!e].forEach((e,t)=>{const i=o.rect().addClass("highcharts-navigator-mask"+(1===t?"-inside":"-outside")).add(d);r.styledMode||(i.attr({fill:e?s.maskFill:"rgba(0,0,0,0)"}),1===t&&i.css(n)),a.shades[t]=i}),a.outline=o.path().addClass("highcharts-navigator-outline").add(d),r.styledMode||a.outline.attr({"stroke-width":s.outlineWidth,stroke:s.outlineColor}),s.handles&&s.handles.enabled){const i=s.handles,{height:h,width:l}=i;[0,1].forEach(e=>{a.handles[e]=o.symbol(i.symbols[e],-l/2-1,0,l,h,i),r.inverted&&a.handles[e].attr({rotation:90,rotationOriginX:Math.floor(-l/2),rotationOriginY:(h+l)/2}),a.handles[e].attr({zIndex:7-e}).addClass("highcharts-navigator-handle highcharts-navigator-handle-"+["left","right"][e]).add(d),r.styledMode||a.handles[e].attr({fill:i.backgroundColor,stroke:i.borderColor,"stroke-width":i.lineWidth}).css(n)})}}update(e){(this.series||[]).forEach(e=>{e.baseSeries&&delete e.baseSeries.navigatorSeries}),this.destroy();var t=this.chart.options;merge(!0,t.navigator,e),this.init(this.chart)}render(e,t,i,a){const s=this,r=s.chart,o=s.xAxis,n=o.pointRange||0,d=o.navigatorAxis.fake?r.xAxis[0]:o,h=s.navigatorEnabled,l=s.rendered,x=r.inverted,g=r.xAxis[0].minRange,v=r.xAxis[0].options.maxRange,c=s.scrollButtonSize;let m,p,u,b=s.scrollbarHeight,f,M;if(!this.hasDragged||defined(i)){if(e=correctFloat(e-n/2),t=correctFloat(t+n/2),!isNumber(e)||!isNumber(t)){if(!l)return;i=0,a=pick(o.width,d.width)}s.left=pick(o.left,r.plotLeft+c+(x?r.plotWidth:0));var E=s.size=f=pick(o.len,(x?r.plotHeight:r.plotWidth)-2*c),e=(m=x?b:f+2*c,i=pick(i,o.toPixels(e,!0)),a=pick(a,o.toPixels(t,!0)),isNumber(i)&&Math.abs(i)!==1/0||(i=0,a=m),o.toValue(i,!0)),t=o.toValue(a,!0),A=Math.abs(correctFloat(t-e)),A=(A<g?this.grabbedLeft?i=o.toPixels(t-g-n,!0):this.grabbedRight&&(a=o.toPixels(e+g+n,!0)):defined(v)&&correctFloat(A-n)>v&&(this.grabbedLeft?i=o.toPixels(t-v-n,!0):this.grabbedRight&&(a=o.toPixels(e+v+n,!0))),s.zoomedMax=clamp(Math.max(i,a),0,E),s.zoomedMin=clamp(s.fixedWidth?s.zoomedMax-s.fixedWidth:Math.min(i,a),0,E),s.range=s.zoomedMax-s.zoomedMin,E=Math.round(s.zoomedMax),Math.round(s.zoomedMin));h&&(s.navigatorGroup.attr({visibility:"inherit"}),M=l&&!s.hasDragged?"animate":"attr",s.drawMasks(A,E,x,M),s.drawOutline(A,E,x,M),s.navigatorOptions.handles.enabled&&(s.drawHandle(A,0,x,M),s.drawHandle(E,1,x,M))),s.scrollbar&&(x?(u=s.top-c,p=s.left-b+(h||!d.opposite?0:(d.titleOffset||0)+d.axisTitleMargin),b=f+2*c):(u=s.top+(h?s.height:-b),p=s.left-c),s.scrollbar.position(p,u,m,b),s.scrollbar.setRange(s.zoomedMin/(f||1),s.zoomedMax/(f||1))),s.rendered=!0,fireEvent(this,"afterRender")}}addMouseEvents(){const t=this,e=t.chart,i=e.container;let a=[],s,r;t.mouseMoveHandler=s=function(e){t.onMouseMove(e)},t.mouseUpHandler=r=function(e){t.onMouseUp(e)},(a=t.getPartsEvents("mousedown")).push(addEvent(e.renderTo,"mousemove",s),addEvent(i.ownerDocument,"mouseup",r)),hasTouch&&(a.push(addEvent(e.renderTo,"touchmove",s),addEvent(i.ownerDocument,"touchend",r)),a.concat(t.getPartsEvents("touchstart"))),t.eventsToUnbind=a,t.series&&t.series[0]&&a.push(addEvent(t.series[0].xAxis,"foundExtremes",function(){e.navigator.modifyNavigatorAxisExtremes()}))}getPartsEvents(a){const s=this,r=[];return["shades","handles"].forEach(function(i){s[i].forEach(function(e,t){r.push(addEvent(e.element,a,function(e){s[i+"Mousedown"](e,t)}))})}),r}shadesMousedown(e,t){e=this.chart.pointer.normalize(e);const i=this,a=i.chart,s=i.xAxis,r=i.zoomedMin,o=i.size,n=i.range;let d=i.left,h=e.chartX,l,x,g,v;a.inverted&&(h=e.chartY,d=i.top),1===t?(i.grabbedCenter=h,i.fixedWidth=n,i.dragOffset=h-r):(v=h-d-n/2,0===t?v=Math.max(0,v):2===t&&v+n>=o&&(v=o-n,i.reversedExtremes?(v-=n,x=i.getUnionExtremes().dataMin):l=i.getUnionExtremes().dataMax),v!==r&&(i.fixedWidth=n,g=s.navigatorAxis.toFixedRange(v,v+n,x,l),defined(g.min)&&a.xAxis[0].setExtremes(Math.min(g.min,g.max),Math.max(g.min,g.max),!0,null,{trigger:"navigator"})))}handlesMousedown(e,t){e=this.chart.pointer.normalize(e);const i=this,a=i.chart,s=a.xAxis[0],r=i.reversedExtremes;0===t?(i.grabbedLeft=!0,i.otherHandlePos=i.zoomedMax,i.fixedExtreme=r?s.min:s.max):(i.grabbedRight=!0,i.otherHandlePos=i.zoomedMin,i.fixedExtreme=r?s.max:s.min),a.fixedRange=null}onMouseMove(e){const t=this,i=t.chart,a=t.navigatorSize,s=t.range,r=t.dragOffset,o=i.inverted;let n=t.left,d;e.touches&&0===e.touches[0].pageX||(e=i.pointer.normalize(e),d=e.chartX,o&&(n=t.top,d=e.chartY),t.grabbedLeft?(t.hasDragged=!0,t.render(0,0,d-n,t.otherHandlePos)):t.grabbedRight?(t.hasDragged=!0,t.render(0,0,t.otherHandlePos,d-n)):t.grabbedCenter&&(t.hasDragged=!0,d<r?d=r:d>a+r-s&&(d=a+r-s),t.render(0,0,d-r,d-r+s)),t.hasDragged&&t.scrollbar&&pick(t.scrollbar.options.liveRedraw,!isTouchDevice&&!this.chart.boosted)&&(e.DOMType=e.type,setTimeout(function(){t.onMouseUp(e)},0)))}onMouseUp(e){const t=this,i=t.chart,a=t.xAxis,s=t.scrollbar,r=e.DOMEvent||e,o=i.inverted,n=t.rendered&&!t.hasDragged?"animate":"attr";let d,h,l,x,g,v;(!t.hasDragged||s&&s.hasDragged)&&"scrollbar"!==e.trigger||(l=t.getUnionExtremes(),t.zoomedMin===t.otherHandlePos?x=t.fixedExtreme:t.zoomedMax===t.otherHandlePos&&(g=t.fixedExtreme),t.zoomedMax===t.size&&(g=t.reversedExtremes?l.dataMin:l.dataMax),0===t.zoomedMin&&(x=t.reversedExtremes?l.dataMax:l.dataMin),v=a.navigatorAxis.toFixedRange(t.zoomedMin,t.zoomedMax,x,g),defined(v.min)&&i.xAxis[0].setExtremes(Math.min(v.min,v.max),Math.max(v.min,v.max),!0,!t.hasDragged&&null,{trigger:"navigator",triggerOp:"navigator-drag",DOMEvent:r})),"mousemove"!==e.DOMType&&"touchmove"!==e.DOMType&&(t.grabbedLeft=t.grabbedRight=t.grabbedCenter=t.fixedWidth=t.fixedExtreme=t.otherHandlePos=t.hasDragged=t.dragOffset=null),t.navigatorEnabled&&isNumber(t.zoomedMin)&&isNumber(t.zoomedMax)&&(h=Math.round(t.zoomedMin),d=Math.round(t.zoomedMax),t.shades&&t.drawMasks(h,d,o,n),t.outline&&t.drawOutline(h,d,o,n),t.navigatorOptions.handles.enabled&&Object.keys(t.handles).length===t.handles.length&&(t.drawHandle(h,0,o,n),t.drawHandle(d,1,o,n)))}removeEvents(){this.eventsToUnbind&&(this.eventsToUnbind.forEach(function(e){e()}),this.eventsToUnbind=void 0),this.removeBaseSeriesEvents()}removeBaseSeriesEvents(){const e=this.baseSeries||[];this.navigatorEnabled&&e[0]&&(!1!==this.navigatorOptions.adaptToUpdatedData&&e.forEach(function(e){removeEvent(e,"updatedData",this.updatedDataHandler)},this),e[0].xAxis&&removeEvent(e[0].xAxis,"foundExtremes",this.modifyBaseAxisExtremes))}init(n){const e=n.options,t=e.navigator||{},i=t.enabled,a=e.scrollbar||{},s=a.enabled,r=i&&t.height||0,o=s&&a.height||0,d=a.buttonsEnabled&&o||0,h=(this.handles=[],this.shades=[],this.chart=n,this.setBaseSeries(),this.height=r,this.scrollbarHeight=o,this.scrollButtonSize=d,this.scrollbarEnabled=s,this.navigatorEnabled=i,this.navigatorOptions=t,this.scrollbarOptions=a,this.opposite=pick(t.opposite,Boolean(!i&&n.inverted)),this),l=h.baseSeries,x=n.xAxis.length,g=n.yAxis.length,v=l&&l[0]&&l[0].xAxis||n.xAxis[0]||{options:{}};if(n.isDirtyBox=!0,h.navigatorEnabled?(h.xAxis=new Axis(n,merge({breaks:v.options.breaks,ordinal:v.options.ordinal},t.xAxis,{id:"navigator-x-axis",yAxis:"navigator-y-axis",type:"datetime",index:x,isInternal:!0,offset:0,keepOrdinalPadding:!0,startOnTick:!1,endOnTick:!1,minPadding:0,maxPadding:0,zoomEnabled:!1},n.inverted?{offsets:[d,0,-d,0],width:r}:{offsets:[0,-d,0,d],height:r}),"xAxis"),h.yAxis=new Axis(n,merge(t.yAxis,{id:"navigator-y-axis",alignTicks:!1,offset:0,index:g,isInternal:!0,reversed:pick(t.yAxis&&t.yAxis.reversed,n.yAxis[0]&&n.yAxis[0].reversed,!1),zoomEnabled:!1},n.inverted?{width:r}:{height:r}),"yAxis"),l||t.series.data?h.updateNavigatorSeries(!1):0===n.series.length&&(h.unbindRedraw=addEvent(n,"beforeRedraw",function(){0<n.series.length&&!h.series&&(h.setBaseSeries(),h.unbindRedraw())})),h.reversedExtremes=n.inverted&&!h.xAxis.reversed||!n.inverted&&h.xAxis.reversed,h.renderElements(),h.addMouseEvents()):(h.xAxis={chart:n,navigatorAxis:{fake:!0},translate:function(e,t){const i=n.xAxis[0],a=i.getExtremes(),s=i.len-2*d,r=numExt("min",i.options.min,a.dataMin),o=numExt("max",i.options.max,a.dataMax)-r;return t?e*o/s+r:s*(e-r)/o},toPixels:function(e){return this.translate(e)},toValue:function(e){return this.translate(e,!0)}},h.xAxis.navigatorAxis.axis=h.xAxis,h.xAxis.navigatorAxis.toFixedRange=NavigatorAxisAdditions.prototype.toFixedRange.bind(h.xAxis.navigatorAxis)),n.options.scrollbar.enabled){const c=merge(n.options.scrollbar,{vertical:n.inverted});!isNumber(c.margin)&&h.navigatorEnabled&&(c.margin=n.inverted?-3:3),n.scrollbar=h.scrollbar=new Scrollbar(n.renderer,c,n),addEvent(h.scrollbar,"changed",function(e){var t=h.size,i=t*this.to,t=t*this.from;h.hasDragged=h.scrollbar.hasDragged,h.render(0,0,t,i),this.shouldUpdateExtremes(e.DOMType)&&setTimeout(function(){h.onMouseUp(e)})})}h.addBaseSeriesEvents(),h.addChartEvents()}getUnionExtremes(e){var t=this.chart.xAxis[0],i=this.xAxis,a=i.options,s=t.options;let r;return r=e&&null===t.dataMin?r:{dataMin:pick(a&&a.min,numExt("min",s.min,t.dataMin,i.dataMin,i.min)),dataMax:pick(a&&a.max,numExt("max",s.max,t.dataMax,i.dataMax,i.max))}}setBaseSeries(i,e){const t=this.chart,a=this.baseSeries=[];i=i||t.options&&t.options.navigator.baseSeries||(t.series.length?find(t.series,e=>!e.options.isInternal).index:0),(t.series||[]).forEach((e,t)=>{e.options.isInternal||!e.options.showInNavigator&&(t!==i&&e.options.id!==i||!1===e.options.showInNavigator)||a.push(e)}),this.xAxis&&!this.xAxis.navigatorAxis.fake&&this.updateNavigatorSeries(!0,e)}updateNavigatorSeries(e,s){const r=this,o=r.chart,n=r.baseSeries,d={enableMouseTracking:!1,index:null,linkedTo:null,group:"nav",padXAxis:!1,xAxis:"navigator-x-axis",yAxis:"navigator-y-axis",showInLegend:!1,stacking:void 0,isInternal:!0,states:{inactive:{opacity:1}}},h=r.series=(r.series||[]).filter(e=>{const t=e.baseSeries;return!(n.indexOf(t)<0)||(t&&(removeEvent(t,"updatedData",r.updatedDataHandler),delete t.navigatorSeries),e.chart&&e.destroy(),!1)});let l,x,g=r.navigatorOptions.series,v;n&&n.length&&n.forEach(e=>{const t=e.navigatorSeries,i=extend({color:e.color,visible:e.visible},isArray(g)?defaultOptions.navigator.series:g);var a;t&&!1===r.navigatorOptions.adaptToUpdatedData||(d.name="Navigator "+n.length,l=e.options||{},v=l.navigatorOptions||{},i.dataLabels=splat(i.dataLabels),(x=merge(l,d,i,v)).pointRange=pick(i.pointRange,v.pointRange,defaultOptions.plotOptions[x.type||"line"].pointRange),a=v.data||i.data,r.hasNavigatorData=r.hasNavigatorData||!!a,x.data=a||l.data&&l.data.slice(0),t&&t.options?t.update(x,s):(e.navigatorSeries=o.initSeries(x),e.navigatorSeries.baseSeries=e,h.push(e.navigatorSeries)))}),(!g.data||n&&n.length)&&!isArray(g)||(r.hasNavigatorData=!1,(g=splat(g)).forEach((e,t)=>{d.name="Navigator "+(h.length+1),(x=merge(defaultOptions.navigator.series,{color:o.series[t]&&!o.series[t].options.isInternal&&o.series[t].color||o.options.colors[t]||o.options.colors[0]},d,e)).data=e.data,x.data&&(r.hasNavigatorData=!0,h.push(o.initSeries(x)))})),e&&this.addBaseSeriesEvents()}addBaseSeriesEvents(){const t=this,e=t.baseSeries||[];e[0]&&e[0].xAxis&&e[0].eventsToUnbind.push(addEvent(e[0].xAxis,"foundExtremes",this.modifyBaseAxisExtremes)),e.forEach(e=>{e.eventsToUnbind.push(addEvent(e,"show",function(){this.navigatorSeries&&this.navigatorSeries.setVisible(!0,!1)})),e.eventsToUnbind.push(addEvent(e,"hide",function(){this.navigatorSeries&&this.navigatorSeries.setVisible(!1,!1)})),!1!==this.navigatorOptions.adaptToUpdatedData&&e.xAxis&&e.eventsToUnbind.push(addEvent(e,"updatedData",this.updatedDataHandler)),e.eventsToUnbind.push(addEvent(e,"remove",function(){this.navigatorSeries&&(erase(t.series,this.navigatorSeries),defined(this.navigatorSeries.options)&&this.navigatorSeries.remove(!1),delete this.navigatorSeries)}))})}getBaseSeriesMin(e){return this.baseSeries.reduce(function(e,t){return Math.min(e,t.xData&&t.xData.length?t.xData[0]:e)},e)}modifyNavigatorAxisExtremes(){const e=this.xAxis;var t;void 0===e.getExtremes||!(t=this.getUnionExtremes(!0))||t.dataMin===e.min&&t.dataMax===e.max||(e.min=t.dataMin,e.max=t.dataMax)}modifyBaseAxisExtremes(){const e=this,t=e.chart.navigator,i=e.getExtremes(),a=i.min,s=i.max,r=i.dataMin,o=i.dataMax,n=s-a,d=t.stickToMin,h=t.stickToMax,l=pick(e.options.overscroll,0),x=t.series&&t.series[0],g=!!e.setExtremes,v=e.eventArgs&&"rangeSelectorButton"===e.eventArgs.trigger;let c,m;v||(d&&(m=r,c=m+n),h&&(c=o+l,d||(m=Math.max(r,c-n,t.getBaseSeriesMin(x&&x.xData?x.xData[0]:-Number.MAX_VALUE)))),g&&(d||h)&&isNumber(m)&&(e.min=e.userMin=m,e.max=e.userMax=c)),t.stickToMin=t.stickToMax=null}updatedDataHandler(){const e=this.chart.navigator,t=this.navigatorSeries,i=e.reversedExtremes?0===Math.round(e.zoomedMin):Math.round(e.zoomedMax)>=Math.round(e.size);e.stickToMax=pick(this.chart.options.navigator&&this.chart.options.navigator.stickToMax,i),e.stickToMin=e.shouldStickToMin(this,e),t&&!e.hasNavigatorData&&(t.options.pointStart=this.xData[0],t.setData(this.options.data,!1,null,!1))}shouldStickToMin(e,t){var t=t.getBaseSeriesMin(e.xData[0]),e=e.xAxis,i=e.max,a=e.min,e=e.options.range;let s=!0;return s=!(!isNumber(i)||!isNumber(a))&&(e&&0<i-t?i-t<e:a<=t)}addChartEvents(){this.eventsToUnbind||(this.eventsToUnbind=[]),this.eventsToUnbind.push(addEvent(this.chart,"redraw",function(){const e=this.navigator,t=e&&(e.baseSeries&&e.baseSeries[0]&&e.baseSeries[0].xAxis||this.xAxis[0]);t&&e.render(t.min,t.max)}),addEvent(this.chart,"getMargins",function(){let e=this,t=e.navigator,i=t.opposite?"plotTop":"marginBottom";e[i=e.inverted?t.opposite?"marginRight":"plotLeft":i]=(e[i]||0)+(t.navigatorEnabled||!e.inverted?t.height+t.scrollbarHeight:0)+t.navigatorOptions.margin}))}destroy(){this.removeEvents(),this.xAxis&&(erase(this.chart.xAxis,this.xAxis),erase(this.chart.axes,this.xAxis)),this.yAxis&&(erase(this.chart.yAxis,this.yAxis),erase(this.chart.axes,this.yAxis)),(this.series||[]).forEach(e=>{e.destroy&&e.destroy()}),["series","xAxis","yAxis","shades","outline","scrollbarTrack","scrollbarRifles","scrollbarGroup","scrollbar","navigatorGroup","rendered"].forEach(e=>{this[e]&&this[e].destroy&&this[e].destroy(),this[e]=null}),[this.handles].forEach(e=>{destroyObjectProperties(e)})}}export default Navigator;