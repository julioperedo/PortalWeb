"use strict";import D from"../../Core/Defaults.js";const getOptions=D["getOptions"];import NBU from"../../Extensions/Annotations/NavigationBindingsUtilities.js";const{getAssignedAxis,getFieldType}=NBU;import Series from"../../Core/Series/Series.js";import U from"../../Core/Utilities.js";const{defined,fireEvent,isNumber,uniqueKey}=U,indicatorsWithAxes=["apo","ad","aroon","aroonoscillator","atr","ao","cci","chaikin","cmf","cmo","disparityindex","dmi","dpo","linearRegressionAngle","linearRegressionIntercept","linearRegressionSlope","klinger","macd","mfi","momentum","natr","obv","ppo","roc","rsi","slowstochastic","stochastic","trix","williamsr"],indicatorsWithVolume=["ad","cmf","klinger","mfi","obv","vbp","vwap"];function addFlagFromForm(a){return function(i){const e=this,t=e.chart,s=t.stockTools,o=attractToPoint(i,t);if(o){i={x:o.x,y:o.y};const n={type:"flags",onSeries:o.series.id,shape:a,data:[i],xAxis:o.xAxis,yAxis:o.yAxis,point:{events:{click:function(){const t=this,i=t.options;fireEvent(e,"showPopup",{point:t,formType:"annotation-toolbar",options:{langKey:"flags",type:"flags",title:[i.title,getFieldType("title",i.title)],name:[i.name,getFieldType("name",i.name)]},onSubmit:function(i){"remove"===i.actionType?t.remove():t.update(e.fieldsToOptions(i.fields,{}))}})}}}};s&&s.guiEnabled||t.addSeries(n),fireEvent(e,"showPopup",{formType:"flag",options:{langKey:"flags",type:"flags",title:["A",getFieldType("label","A")],name:["Flag A",getFieldType("label","Flag A")]},onSubmit:function(i){e.fieldsToOptions(i.fields,n.data[0]),t.addSeries(n)}})}}}function attractToPoint(i,t){i=t.pointer.getCoordinates(i);let e,s,o=Number.MAX_VALUE,n;if(t.navigationBindings&&(e=getAssignedAxis(i.xAxis),s=getAssignedAxis(i.yAxis)),e&&s){const a=e.value;t=s.value;return s.axis.series.forEach(i=>{i.points&&i.points.forEach(i=>{i&&o>Math.abs(i.x-a)&&(o=Math.abs(i.x-a),n=i)})}),n&&n.x&&n.y?{x:n.x,y:n.y,below:t<n.y,series:n.series,xAxis:n.series.xAxis.index||0,yAxis:n.series.yAxis.index||0}:void 0}}function isNotNavigatorYAxis(i){return"highcharts-navigator-yaxis"!==i.userOptions.className}function isPriceIndicatorEnabled(i){return i.some(i=>i.lastVisiblePrice||i.lastPrice)}function manageIndicators(i){const t=this.chart,e={linkedTo:i.linkedTo,type:i.type};let s,o,n,a;var r;"edit"===i.actionType?(this.fieldsToOptions(i.fields,e),(a=t.get(i.seriesId))&&a.update(e,!1)):"remove"===i.actionType?(a=t.get(i.seriesId))&&(s=a.yAxis,a.linkedSeries&&a.linkedSeries.forEach(i=>{i.remove(!1)}),a.remove(!1),0<=indicatorsWithAxes.indexOf(a.type)&&(r={height:s.options.height,top:s.options.top},s.remove(!1),this.resizeYAxes(r))):(e.id=uniqueKey(),this.fieldsToOptions(i.fields,e),o=t.get(e.linkedTo),n=getOptions().plotOptions,void 0!==o&&o instanceof Series&&"sum"===o.getDGApproximation()&&!defined(n&&n[e.type]&&n.dataGrouping&&n.dataGrouping.approximation)&&(e.dataGrouping={approximation:"sum"}),0<=indicatorsWithAxes.indexOf(i.type)?(s=t.addAxis({id:uniqueKey(),offset:0,opposite:!0,title:{text:""},tickPixelInterval:40,showLastLabel:!1,labels:{align:"left",y:-2}},!1,!1),e.yAxis=s.options.id,this.resizeYAxes()):e.yAxis=t.get(i.linkedTo).options.yAxis,0<=indicatorsWithVolume.indexOf(i.type)&&(e.params.volumeSeriesID=t.series.filter(function(i){return"column"===i.options.type})[0].options.id),t.addSeries(e,!1)),fireEvent(this,"deselectButton",{button:this.selectedButtonElement}),t.redraw()}function updateHeight(i,t){const e=t.options.typeOptions,s=isNumber(e.yAxis)&&this.chart.yAxis[e.yAxis];s&&e.points&&t.update({typeOptions:{height:s.toValue(i[s.horiz?"chartX":"chartY"])-(e.points[1].y||0)}})}function updateNthPoint(n){return function(e,i){const t=i.options.typeOptions,s=isNumber(t.xAxis)&&this.chart.xAxis[t.xAxis],o=isNumber(t.yAxis)&&this.chart.yAxis[t.yAxis];s&&o&&(t.points.forEach((i,t)=>{n<=t&&(i.x=s.toValue(e[s.horiz?"chartX":"chartY"]),i.y=o.toValue(e[o.horiz?"chartX":"chartY"]))}),i.update({typeOptions:{points:t.points}}))}}function updateRectSize(i,t){const e=t.chart,s=t.options.typeOptions,o=isNumber(s.xAxis)&&e.xAxis[s.xAxis],n=isNumber(s.yAxis)&&e.yAxis[s.yAxis];var a;o&&n&&(a=o.toValue(i[o.horiz?"chartX":"chartY"]),i=n.toValue(i[n.horiz?"chartX":"chartY"]),a=a-s.point.x,i=s.point.y-i,t.update({typeOptions:{background:{width:e.inverted?i:a,height:e.inverted?a:i}}}))}const StockToolsUtilities={indicatorsWithAxes:indicatorsWithAxes,indicatorsWithVolume:indicatorsWithVolume,addFlagFromForm:addFlagFromForm,attractToPoint:attractToPoint,getAssignedAxis:getAssignedAxis,isNotNavigatorYAxis:isNotNavigatorYAxis,isPriceIndicatorEnabled:isPriceIndicatorEnabled,manageIndicators:manageIndicators,updateHeight:updateHeight,updateNthPoint:updateNthPoint,updateRectSize:updateRectSize};export default StockToolsUtilities;