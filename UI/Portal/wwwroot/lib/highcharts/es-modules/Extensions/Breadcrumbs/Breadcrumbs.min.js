"use strict";import BreadcrumbsDefaults from"./BreadcrumbsDefaults.js";import Chart from"../../Core/Chart/Chart.js";import F from"../../Core/Templating.js";const format=F["format"];import U from"../../Core/Utilities.js";const{addEvent,defined,extend,fireEvent,isString,merge,objectEach,pick}=U,composedMembers=[];function onChartAfterShowResetZoom(){var t,e,r=this;r.breadcrumbs&&(t=r.resetZoomButton&&r.resetZoomButton.getBBox(),e=r.breadcrumbs.options,t&&"right"===e.position.align&&"plotBox"===e.relativeTo&&r.breadcrumbs.alignBreadcrumbsGroup(-t.width-e.buttonSpacing))}function onChartDestroy(){this.breadcrumbs&&(this.breadcrumbs.destroy(),this.breadcrumbs=void 0)}function onChartGetMargins(){const t=this.breadcrumbs;var e,r;t&&!t.options.floating&&t.level&&(e=((e=(r=t.options).buttonTheme).height||0)+2*(e.padding||0)+r.buttonSpacing,"bottom"===(r=r.position.verticalAlign)?(this.marginBottom=(this.marginBottom||0)+e,t.yOffset=e):"middle"!==r?(this.plotTop+=e,t.yOffset=-e):t.yOffset=void 0)}function onChartRedraw(){this.breadcrumbs&&this.breadcrumbs.redraw()}function onChartSelection(t){!0===t.resetSelection&&this.breadcrumbs&&this.breadcrumbs.alignBreadcrumbsGroup()}class Breadcrumbs{static compose(t,e){U.pushUnique(composedMembers,t)&&(addEvent(Chart,"destroy",onChartDestroy),addEvent(Chart,"afterShowResetZoom",onChartAfterShowResetZoom),addEvent(Chart,"getMargins",onChartGetMargins),addEvent(Chart,"redraw",onChartRedraw),addEvent(Chart,"selection",onChartSelection)),U.pushUnique(composedMembers,e)&&extend(e.lang,BreadcrumbsDefaults.lang)}constructor(t,e){this.elementList={},this.isDirty=!0,this.level=0,this.list=[];e=merge(t.options.drilldown&&t.options.drilldown.drillUpButton,Breadcrumbs.defaultOptions,t.options.navigation&&t.options.navigation.breadcrumbs,e);this.chart=t,this.options=e||{}}updateProperties(t){this.setList(t),this.setLevel(),this.isDirty=!0}setList(t){this.list=t}setLevel(){this.level=this.list.length&&this.list.length-1}getLevel(){return this.level}getButtonText(t){const e=this.chart,r=this.options,s=e.options.lang,o=pick(r.format,r.showFullPath?"{level.name}":"← {level.name}"),i=s&&pick(s.drillUpText,s.mainBreadcrumb);let n=r.formatter&&r.formatter(t)||format(o,{level:t.levelOptions},e)||"";return n=(isString(n)&&!n.length||"← "===n)&&defined(i)?r.showFullPath?i:"← "+i:n}redraw(){this.isDirty&&this.render(),this.group&&this.group.align(),this.isDirty=!1}render(){const t=this,e=t.chart,r=t.options;!t.group&&r&&(t.group=e.renderer.g("breadcrumbs-group").addClass("highcharts-no-tooltip highcharts-breadcrumbs").attr({zIndex:r.zIndex}).add()),r.showFullPath?this.renderFullPathButtons():this.renderSingleButton(),this.alignBreadcrumbsGroup()}renderFullPathButtons(){this.destroySingleButton(),this.resetElementListState(),this.updateListElements(),this.destroyListElements()}renderSingleButton(){const t=this,e=t.chart,r=t.list,s=t.options,o=s.buttonSpacing;this.destroyListElements();var i=t.group?t.group.getBBox().width:o,n=r[r.length-2];!e.drillUpButton&&0<this.level?e.drillUpButton=t.renderButton(n,i,o):e.drillUpButton&&(0<this.level?this.updateSingleButton():this.destroySingleButton())}alignBreadcrumbsGroup(t){var e=this;if(e.group){const r=e.options,s=r.buttonTheme,o=r.position,i="chart"===r.relativeTo||"spacingBox"===r.relativeTo?void 0:"scrollablePlotBox",n=e.group.getBBox(),a=2*(s.padding||0)+r.buttonSpacing,l=(o.width=n.width+a,o.height=n.height+a,merge(o));t&&(l.x+=t),e.options.rtl&&(l.x+=o.width),l.y=pick(l.y,this.yOffset,0),e.group.align(l,!0,i)}}renderButton(s,t,e){const o=this,r=this.chart,i=o.options,n=merge(i.buttonTheme),a=r.renderer.button(o.getButtonText(s),t,e,function(t){const e=i.events&&i.events.click;let r;!1!==(r=e?e.call(o,t,s):r)&&(i.showFullPath?t.newLevel=s.level:t.newLevel=o.level-1,fireEvent(o,"up",t))},n).addClass("highcharts-breadcrumbs-button").add(o.group);return r.styledMode||a.attr(i.style),a}renderSeparator(t,e){const r=this.chart,s=this.options,o=s.separator,i=r.renderer.label(o.text,t,e,void 0,void 0,void 0,!1).addClass("highcharts-breadcrumbs-separator").add(this.group);return r.styledMode||i.css(o.style),i}update(t){merge(!0,this.options,t),this.destroy(),this.isDirty=!0}updateSingleButton(){const t=this.chart,e=this.list[this.level-1];t.drillUpButton&&t.drillUpButton.attr({text:this.getButtonText(e)})}destroy(){this.destroySingleButton(),this.destroyListElements(!0),this.group&&this.group.destroy(),this.group=void 0}destroyListElements(r){const s=this.elementList;objectEach(s,(t,e)=>{!r&&s[e].updated||((t=s[e]).button&&t.button.destroy(),t.separator&&t.separator.destroy(),delete t.button,delete t.separator,delete s[e])}),r&&(this.elementList={})}destroySingleButton(){this.chart.drillUpButton&&(this.chart.drillUpButton.destroy(),this.chart.drillUpButton=void 0)}resetElementListState(){objectEach(this.elementList,t=>{t.updated=!1})}updateListElements(){function o(t,e){return p*t.getBBox().width+p*e}function i(t,e,r){t.translate(e-t.getBBox().width,r)}const n=this,a=n.elementList,l=n.options.buttonSpacing,d=l,h=n.list,u=n.options.rtl,p=u?-1:1;let c=n.group?o(n.group,l):l,m,g;for(let r=0,s=h.length;r<s;++r){var b=r===s-1;let t,e;g=h[r],a[g.level]?(m=a[g.level],t=m.button,m.separator||b?m.separator&&b&&(m.separator.destroy(),delete m.separator):(c+=p*l,m.separator=n.renderSeparator(c,d),u&&i(m.separator,c,d),c+=o(m.separator,l)),a[g.level].updated=!0):(t=n.renderButton(g,c,d),u&&i(t,c,d),c+=o(t,l),b||(e=n.renderSeparator(c,d),u&&i(e,c,d),c+=o(e,l)),a[g.level]={button:t,separator:e,updated:!0}),t&&t.setState(b?2:0)}}}Breadcrumbs.defaultOptions=BreadcrumbsDefaults.options;export default Breadcrumbs;