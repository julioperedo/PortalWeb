"use strict";import TimelineChannel from"./TimelineChannel.js";import toMIDI from"./MIDI.js";import DU from"../DownloadURL.js";const downloadURL=DU["downloadURL"];import U from"../../Core/Utilities.js";const{defined,find,merge}=U;function filterChannels(t,e){const s=e.map(e=>(e.cancel(),{channel:e,filteredEvents:e.muted?[]:e.events.filter(t)})),i=s.reduce((e,t)=>Math.min(e,t.filteredEvents.length?t.filteredEvents[0].time:1/0),1/0);return s.map(e=>new TimelineChannel(e.channel.type,e.channel.engine,e.channel.showPlayMarker,e.filteredEvents.map(e=>merge(e,{time:e.time-i})),e.channel.muted))}class SonificationTimeline{constructor(e,t){this.chart=t,this.isPaused=!1,this.isPlaying=!1,this.channels=[],this.scheduledCallbacks=[],this.playTimestamp=0,this.resumeFromTime=0,this.options=e||{}}addChannel(e,t,s=!1,i){if("instrument"===e&&!t.scheduleEventAtTime||"speech"===e&&!t.sayAtTime)throw new Error("Highcharts Sonification: Invalid channel engine.");e=new TimelineChannel(e,t,s,i);return this.channels.push(e),e}play(e,t=!0,s=!0,i){this.isPlaying?this.cancel():this.clearScheduledCallbacks(),this.onEndArgument=i,this.playTimestamp=Date.now(),this.resumeFromTime=0,this.isPaused=!1,this.isPlaying=!0;const d=this.options.skipThreshold||2,n=this.options.onPlay,u=this.options.showTooltip,p=this.options.showCrosshair,a=e?filterChannels(e,this.playingChannels||this.channels):this.channels,y=[];t&&(this.playingChannels=a),n&&n({chart:this.chart,timeline:this});let g=0;a.forEach(n=>{if(!n.muted){var a,h=n.events.length;let t=-1/0,s=-1/0,i="";g=Math.max(n.events[h-1]&&n.events[h-1].time||0,g);for(let e=0;e<h;++e){const l=n.events[e],r=(a=l,Object.keys(a.speechOptions||{}).concat(Object.keys(a.instrumentEventOptions||{})).join());if(!(r===i&&l.time-s<d)){i=r,s=l.time,"instrument"===n.type?n.engine.scheduleEventAtTime(l.time/1e3,l.instrumentEventOptions||{}):n.engine.sayAtTime(l.time,l.message||"",l.speechOptions||{});const o=l.relatedPoint,c=o&&o.series&&o.series.chart,m=l.callback||o&&(u||p)&&!1!==n.showPlayMarker&&(50<l.time-t||e===h-1);o&&y.push(o),m&&(this.scheduledCallbacks.push(setTimeout(()=>{if(l.callback&&l.callback(),o){if(p){const e=o.series;e&&e.xAxis&&e.xAxis.crosshair&&e.xAxis.drawCrosshair(void 0,o),e&&e.yAxis&&e.yAxis.crosshair&&e.yAxis.drawCrosshair(void 0,o)}!u||c&&c.hoverPoints&&1<c.hoverPoints.length&&find(c.hoverPoints,e=>e===o)&&o.onMouseOver||o.onMouseOver()}},l.time)),t=l.time)}}}});const h=this.options.onEnd,l=this.options.onStop;this.scheduledCallbacks.push(setTimeout(()=>{const e=this.chart,t={chart:e,timeline:this,pointsPlayed:y};this.isPlaying=!1,s&&this.resetPlayState(),l&&l(t),h&&h(t),i&&i(t),e&&(e.tooltip&&e.tooltip.hide(0),e.hoverSeries&&e.hoverSeries.onMouseOut(),e.axes.forEach(e=>e.hideCrosshair()))},g+250)),this.resumeFromTime=t?g:this.getLength()}pause(){return this.isPaused=!0,this.cancel(),this.resumeFromTime=Date.now()-this.playTimestamp-10,this.resumeFromTime}getCurrentTime(){return this.isPlaying?Date.now()-this.playTimestamp:this.resumeFromTime}getLength(){return this.channels.reduce((e,t)=>{t=t.events[t.events.length-1];return t?Math.max(t.time,e):e},0)}resume(){if(this.playingChannels){const t=this.resumeFromTime-50;this.play(e=>e.time>t,!1,!1,this.onEndArgument),this.playTimestamp-=t}else this.play(void 0,!1,!1,this.onEndArgument)}anchorPlayMoment(i,e){this.isPlaying&&this.pause();let n=0;this.play((e,t,s)=>{t=i(e,t,s);return t&&e.time>n&&(n=e.time),t},!1,!1,e),this.playingChannels=this.playingChannels||this.channels,this.isPaused=!0,this.isPlaying=!1,this.resumeFromTime=n}playAdjacent(o,e,t,c){this.isPlaying&&this.pause();const m=this.resumeFromTime,n=this.channels.reduce((e,t)=>{var s=c?t.events.filter(c):t.events;let i=0,n=s.length,a=e;for(;i<n;){var h=i+n>>1,l=s[h].time,r=l-m;0<r?(o&&l<a&&(a=l),n=h):r<0?(!o&&l>a&&(a=l),i=1+h):o?i=1+h:n=h}return a},o?1/0:-1/0);n===1/0||n===-1/0?t&&t({chart:this.chart,timeline:this,attemptedNext:o}):this.anchorPlayMoment((e,t,s)=>{var i=o?e.time>m&&e.time<=n+.02:e.time<m&&e.time>=n-.02;return c?i&&c(e,t,s):i},e)}playClosestToPropValue(h,l,e,t,r){let o=1/0,c=null;(this.playingChannels||this.channels).forEach(e=>{var t,s,i,n=e.events;let a=n.length;for(;a--;)t=n[a],s=a,i=n,r&&!r(t,s,i)||!t.relatedPoint||(s=n[a].relatedPoint[h],!1!==(i=defined(s)&&Math.abs(l-s))&&i<o&&(o=i,c=n[a]))}),c?(this.play(e=>!!(c&&e.time<c.time+1&&e.time>c.time-1&&e.relatedPoint===c.relatedPoint),!1,!1,e),this.playingChannels=this.playingChannels||this.channels,this.isPaused=!0,this.isPlaying=!1,this.resumeFromTime=c.time):t&&t({chart:this.chart,timeline:this})}getEventsForPoint(s){return this.channels.reduce((e,t)=>{t=t.events.filter(e=>e.relatedPoint===s);return e.concat(t)},[])}playSegment(e,t){const s={first:1/0,last:-1/0};if(this.channels.forEach(e=>{e.events.length&&(s.first=Math.min(e.events[0].time,s.first),s.last=Math.max(e.events[e.events.length-1].time,s.last))}),s.first<1/0){const i=(s.last-s.first)/100,h=s.first+e*i,l=h+i;this.channels.some(e=>{var t=e.events;let s=0,i=t.length;for(;s<i;){var n=s+i>>1,a=t[n].time;if(a<h)s=1+n;else{if(!(a>l))return!0;i=n}}return!1})&&(this.play(e=>e.time>=h&&e.time<=l,!1,!1,t),this.playingChannels=this.playingChannels||this.channels,this.isPaused=!0,this.isPlaying=!1,this.resumeFromTime=l)}}getLastPlayedPoint(i){const n=this.getCurrentTime(),e=this.playingChannels||this.channels;let s=1/0,a=null;return e.forEach(e=>{var t,e=e.events.filter((e,t,s)=>!(!(e.relatedPoint&&e.time<=n)||i&&!i(e,t,s))),e=e[e.length-1];e&&(t=e.time,(t=Math.abs(t-n))<s&&(s=t,a=e.relatedPoint))}),a}reset(){this.isPlaying&&this.cancel(),this.resetPlayState()}cancel(){const e=this.options.onStop;e&&e({chart:this.chart,timeline:this}),this.isPlaying=!1,this.channels.forEach(e=>e.cancel()),this.playingChannels&&this.playingChannels!==this.channels&&this.playingChannels.forEach(e=>e.cancel()),this.clearScheduledCallbacks(),this.resumeFromTime=0}destroy(){this.cancel(),this.playingChannels&&this.playingChannels!==this.channels&&this.playingChannels.forEach(e=>e.destroy()),this.channels.forEach(e=>e.destroy())}setMasterVolume(t){this.channels.forEach(e=>e.engine.setMasterVolume(t))}getMIDIData(){return toMIDI(this.channels.filter(e=>"instrument"===e.type))}downloadMIDI(e){var t=this.getMIDIData(),e=(e||this.chart&&this.chart.options.title&&this.chart.options.title.text||"chart")+".mid",t=new Blob([t],{type:"application/octet-stream"}),t=window.URL.createObjectURL(t);downloadURL(t,e),window.URL.revokeObjectURL(t)}resetPlayState(){delete this.playingChannels,delete this.onEndArgument,this.playTimestamp=this.resumeFromTime=0,this.isPaused=!1}clearScheduledCallbacks(){this.scheduledCallbacks.forEach(clearTimeout),this.scheduledCallbacks=[]}}export default SonificationTimeline;