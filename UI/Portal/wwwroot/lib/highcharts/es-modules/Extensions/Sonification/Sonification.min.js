"use strict";import D from"../../Core/Defaults.js";const{defaultOptions,getOptions}=D;import U from"../../Core/Utilities.js";const{addEvent,extend,fireEvent,merge,pick}=U;import H from"../../Core/Globals.js";const{doc,win}=H;import defaultSonificationOptions from"./Options.js";import SonificationInstrument from"./SonificationInstrument.js";import SonificationSpeaker from"./SonificationSpeaker.js";import SynthPatch from"./SynthPatch.js";import InstrumentPresets from"./InstrumentPresets.js";import timelineFromChart from"./TimelineFromChart.js";class Sonification{constructor(i){this.chart=i,this.retryContextCounter=0,this.lastUpdate=0,this.unbindKeydown=addEvent(doc,"keydown",function(t){i&&i.sonification&&("Esc"===t.key||"Escape"===t.key)&&i.sonification.cancel()});try{this.audioContext=new win.AudioContext,this.audioContext.suspend(),this.audioDestination=this.audioContext.destination}catch(t){}}setAudioDestination(t){this.audioDestination=t,this.update()}isPlaying(){return!!this.timeline&&this.timeline.isPlaying}playSegment(t,i){this.ready(this.playSegment.bind(this,t,i))&&this.timeline&&this.timeline.playSegment(t,i)}playAdjacent(t,i,e){var n;this.ready(this.playAdjacent.bind(this,t,i,e))&&this.timeline&&((n=(n=this.chart.options.sonification)&&n.events&&n.events.onBoundaryHit)||this.initBoundaryInstrument(),this.timeline.playAdjacent(t,i,n||(()=>{this.defaultBoundaryHit()}),e))}playAdjacentSeries(t,i="x",e){var n=this.getLastPlayedPoint();if(n){const s=n.series.index+(t?1:-1);return this.playClosestToProp(i,n[i],t=>!!t.relatedPoint&&t.relatedPoint.series.index===s,e),this.chart.series[s]||null}return null}playClosestToProp(t,i,e,n){var s;this.ready(this.playClosestToProp.bind(this,t,i,e,n))&&this.timeline&&((s=(s=this.chart.options.sonification)&&s.events&&s.events.onBoundaryHit)||this.initBoundaryInstrument(),this.timeline.playClosestToPropValue(t,i,n,s||(()=>this.defaultBoundaryHit()),e))}getLastPlayedPoint(){return this.timeline?this.timeline.getLastPlayedPoint():null}playNote(t,i,e=0){if(this.ready(this.playNote.bind(this,t,i))){var n=i.noteDuration=i.noteDuration||500;const s=new SonificationInstrument(this.audioContext,this.audioDestination,{synthPatch:t,capabilities:{filters:!0,tremolo:!0,pan:!0}});s.scheduleEventAtTime(e/1e3,i),setTimeout(()=>s&&s.destroy(),e+n+500)}}speak(t,i,e=0){const n=new SonificationSpeaker(merge({language:"en-US",rate:1.5,volume:.4},i||{}));n.sayAtTime(e,t)}cancel(){this.timeline&&this.timeline.cancel(),fireEvent(this,"cancel")}downloadMIDI(){this.ready(this.downloadMIDI.bind(this))&&this.timeline&&(this.timeline.reset(),this.timeline.downloadMIDI())}sonifyChart(t,i){this.ready(this.sonifyChart.bind(this,t,i))&&this.timeline&&(this.timeline.reset(),this.beforePlay(),this.timeline.play(void 0,void 0,t,i))}sonifySeries(i,t,e){this.ready(this.sonifySeries.bind(this,i,t,e))&&this.timeline&&(this.timeline.reset(),this.beforePlay(),this.timeline.play(t=>!!t.relatedPoint&&t.relatedPoint.series===i,void 0,t,e))}sonifyPoint(i,t){this.ready(this.sonifyPoint.bind(this,i,t))&&this.timeline&&(this.timeline.reset(),this.beforePlay(),this.timeline.anchorPlayMoment(t=>t.relatedPoint===i,t))}setMasterVolume(t){this.timeline&&this.timeline.setMasterVolume(t)}destroy(){this.unbindKeydown(),this.timeline&&(this.timeline.destroy(),delete this.timeline),this.boundaryInstrument&&this.boundaryInstrument.stop(),this.audioContext&&(this.audioContext.close(),delete this.audioContext)}update(){const t=this.chart.options&&this.chart.options.sonification;if(this.ready(this.update.bind(this))&&t){var i=Date.now(),e=t.updateInterval;if(i-this.lastUpdate<e&&!this.forceReady)return clearTimeout(this.scheduledUpdate),void(this.scheduledUpdate=setTimeout(this.update.bind(this),e/2));const n=t.events||{};if(n.beforeUpdate&&n.beforeUpdate({chart:this.chart,timeline:this.timeline}),this.lastUpdate=i,this.timeline&&this.timeline.destroy(),this.audioContext&&this.audioDestination){this.timeline=timelineFromChart(this.audioContext,this.audioDestination,this.chart);const t=this.chart.options.sonification;this.timeline.setMasterVolume(pick(t&&t.masterVolume,1))}n.afterUpdate&&n.afterUpdate({chart:this.chart,timeline:this.timeline})}}ready(t){return!(!(this.audioContext&&this.audioDestination&&this.chart.options)||this.chart.options.sonification&&!1===this.chart.options.sonification.enabled)&&("suspended"!==this.audioContext.state||this.forceReady?!(this.retryContextCounter=0):(this.retryContextCounter++<20&&setTimeout(()=>{this.audioContext&&"suspended"===this.audioContext.state?this.audioContext.resume().then(t):t()},5),!1))}beforePlay(){const t=this.chart.options.sonification,i=t&&t.events&&t.events.beforePlay;i&&i({chart:this.chart,timeline:this.timeline})}initBoundaryInstrument(){this.boundaryInstrument||(this.boundaryInstrument=new SynthPatch(this.audioContext,merge(InstrumentPresets.chop,{masterVolume:.3})),this.boundaryInstrument.startSilently(),this.boundaryInstrument.connect(this.audioDestination))}defaultBoundaryHit(){this.boundaryInstrument&&(this.boundaryInstrument.playFreqAtTime(.1,1,200),this.boundaryInstrument.playFreqAtTime(.2,1,200))}}!function(e){const s=[];function o(){const t=this.sonification,i=this.options&&this.options.sonification;i&&i.enabled?t?t.update():(this.sonification=new e(this),this.sonification.update()):t&&(t.destroy(),delete this.sonification)}function a(){this&&this.sonification&&this.sonification.destroy()}function h(){this.updateSonificationEnabled&&this.updateSonificationEnabled()}function r(t){t=t.options.sonification;t&&(merge(!0,this.options.sonification,t),h.call(this))}e.compose=function(t,i,e){-1===s.indexOf(t)&&(s.push(t),extend(t.prototype,{updateSonificationEnabled:o,sonify:function(t){this.sonification&&this.sonification.sonifyChart(!1,t)},toggleSonify:function(t=!0,i){if(this.sonification){const e=this.sonification.timeline;win.speechSynthesis&&win.speechSynthesis.cancel(),e&&this.sonification.isPlaying()?t?this.sonification.cancel():e.pause():e&&e.isPaused?e.resume():this.sonification.sonifyChart(t,i)}}}),addEvent(t,"destroy",a),addEvent(t,"render",h),addEvent(t,"update",r)),-1===s.indexOf(i)&&(s.push(i),i.prototype.sonify=function(t){this.chart.sonification&&this.chart.sonification.sonifySeries(this,!1,t)}),-1===s.indexOf(e)&&(s.push(e),e.prototype.sonify=function(t){this.series.chart.sonification&&this.series.chart.sonification.sonifyPoint(this,t)});const n=getOptions().exporting;n&&n.buttons&&n.buttons.contextButton.menuItems&&n.buttons.contextButton.menuItems.push("separator","downloadMIDI","playAsSound")}}(Sonification=Sonification||{}),merge(!0,defaultOptions,defaultSonificationOptions);export default Sonification;