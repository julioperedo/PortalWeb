"use strict";import SonificationInstrument from"./SonificationInstrument.js";import U from"../../Core/Utilities.js";const pick=U["pick"],freqToNote=t=>Math.round(12*Math.log(t)/Math.LN2-48.37632),b=(t,e)=>e>>>8*t&255,getHeader=t=>[77,84,104,100,0,0,0,6,0,1<t?1:0,b(1,t),b(0,t),1,244],timeInfo=[0,255,81,3,7,161,32],varLenEnc=t=>{let e=127&t;const n=[];for(;t>>=7;)e=e<<8|127&t|128;for(;;){if(n.push(255&e),!(128&e))break;e>>=8}return n},toMIDIEvents=t=>{let h,l;const n=[],u=t=>{let e=n.length;for(;e--&&n[e].timeMS>t.timeMS;);n.splice(e+1,0,t)};return t.forEach(t=>{const e=t.instrumentEventOptions||{},a=t.time,n=l=pick(e.noteDuration,l),r=n&&t.time+n,o=[{valMap:t=>64+63*t&127,data:{10:e.pan,92:e.tremoloDepth,93:e.tremoloSpeed}},{valMap:t=>127*t/2e4&127,data:{74:e.lowpassFreq,75:e.highpassFreq}},{valMap:t=>63*Math.min(18,Math.max(-18,t))/18+63&127,data:{71:e.lowpassResonance,76:e.highpassResonance}}],i=h=void 0===e.volume?pick(h,127):127*e.volume&127,c=e.frequency,s=e.note||0,m=12+(c?freqToNote(c):"string"==typeof s?SonificationInstrument.noteStringToC0Distance(s):s)&127;o.forEach(n=>Object.keys(n.data).forEach(t=>{var e=n.data[t];void 0!==e&&u({timeMS:a,type:"CTRL_CHG",data:[176,parseInt(t,10),n.valMap(e)]})})),r&&(u({timeMS:a,type:"NON",data:[144,m,i]}),u({timeMS:r,type:"NOF",data:[128,m,i]}))}),n},getMetaEvents=(e,t)=>{const n=[];if(t&&n.push(0,192,127&t),e){const r=[];for(let t=0;t<e.length;++t){var a=e.charCodeAt(t);a<128&&r.push(a)}return n.concat([0,255,3],varLenEnc(r.length),r)}return n},getTrackChunk=(t,e,n,a)=>{let r=0;var n=getMetaEvents(n,a),a=toMIDIEvents(t).reduce((t,e)=>{var n=varLenEnc(e.timeMS-r);return r=e.timeMS,t.concat(n,e.data)},[]),t=[0,255,47,0],o=(e?timeInfo.length:0)+n.length+a.length+t.length;return[77,84,114,107,b(3,o),b(2,o),b(1,o),b(0,o)].concat(e?timeInfo:[],n,a,t)};function toMIDI(t){const e=t.filter(t=>!!t.events.length),n=e.length,a=1<n;return new Uint8Array(getHeader(a?n+1:n).concat(a?getTrackChunk([],!0):[],e.reduce((t,e)=>{var n=e.engine;return t.concat(getTrackChunk(e.events,!a,n.midiTrackName,n.midiInstrument))},[])))}export default toMIDI;