"use strict";import SonificationTimeline from"./SonificationTimeline.js";import SonificationInstrument from"./SonificationInstrument.js";import SonificationSpeaker from"./SonificationSpeaker.js";import U from"../../Core/Utilities.js";const{clamp,defined,extend,getNestedProperty,merge,pick}=U;import T from"../../Core/Templating.js";const format=T["format"],isNoteDefinition=e=>/^([a-g][#b]?)[0-8]$/i.test(e);function getPointPropValue(e,t){let i;if(t){if("number"==typeof(i=e[t]))return i;i=getNestedProperty(t,e)}return"number"==typeof i?i:void 0}function getChartExtremesForProps(e,i,n){var o=e.series,a=i.length,r=n.length,t=e=>e.reduce((e,t)=>(e[t]={min:1/0,max:-1/0},e),{}),p=(e,t,i)=>{let n=t[i];"number"==typeof(n=void 0===n?getNestedProperty(i,t):n)&&(e[i].min=Math.min(e[i].min,n),e[i].max=Math.max(e[i].max,n))},m=t(i);let s=o.length;const l=new Array(s);for(;s--;){var c=t(n),u=o[s].options;if(!(!o[s].visible||u&&u.sonification&&!1===u.sonification.enabled)){var f=o[s].points||[];let t=f.length;for(;t--;){let e=a;for(;e--;)p(m,f[t],i[e]);for(e=r;e--;)p(c,f[t],n[e])}l[s]=c}}return{globalExtremes:m,seriesExtremes:l}}function getPropMetrics(e){const t=e.options.sonification||{},i=(t.defaultInstrumentOptions||{}).mapping||{time:"x",pitch:"y"},n=t.defaultSpeechOptions&&t.defaultSpeechOptions.mapping||{},o=[],a={},r=(e,t)=>{null!==t?(o[t]=o[t]||{},o[t][e]=!0):a[e]=!0},p={},m={},s=(e,t,i)=>{var n,o=e=>"-"===e.charAt(0)?e.slice(1):e;return"string"==typeof t&&"text"!==e?"pitch"===e&&isNoteDefinition(t)?void 0:("time"===e&&(m[t]=!0,r(t,i)),void(p[o(t)]=!0)):(n=t)&&n.mapTo&&"string"==typeof n.mapTo?(o=o(n.mapTo),"time"===e&&r(o,i),"time"!==e&&"series"!==n.within||(m[o]=!0),void(p[o]=!0)):void(-1<["tremolo","lowpass","highpass"].indexOf(e)&&"object"==typeof t&&Object.keys(t).forEach(e=>s(e,t[e],i)))},l=(t,i)=>{Object.keys(t).forEach(e=>s(e,t[e],i))},c=e=>e.forEach(e=>{p[e.valueProp||"x"]=m[e.valueProp||"x"]=!0}),u=(l(i,null),l(n,null),c(t.globalContextTracks||[]),Object.keys(a).length);return e.series.forEach(t=>{const e=t.options.sonification;var i,n;!t.visible||e&&!1===e.enabled||(u&&(o[t.index]=merge(a)),e&&(i=(e.defaultInstrumentOptions||{}).mapping,n=(e.defaultSpeechOptions||{}).mapping,i&&l(i,t.index),n&&l(n,t.index),c(e.contextTracks||[]),(e.tracks||[]).concat(e.contextTracks||[]).forEach(e=>{e.mapping&&l(e.mapping,t.index)})))}),{seriesTimeProps:o,...getChartExtremesForProps(e,Object.keys(p),Object.keys(m))}}function mapToVirtualAxis(e,t,i,n,o){var a=t.max-t.min;if(a<=0)return i.min;var r=i.max-i.min;let p=r*(e-t.min)/a;if(o){const m=0<t.min?e=>Math.log(e)/Math.LOG10E:e=>{let t=Math.abs(e);t<10&&(t+=(10-t)/10);var i=Math.log(t)/Math.LN10;return e<0?-i:i};a=m(t.min);p=r*(m(e)-a)/(m(t.max)-a)}o=n?i.max-p:i.min+p;return clamp(o,i.min,i.max)}function getMappingParameterValue(e,t,i,n,o,a){if("number"==typeof o)return o;if("function"==typeof o)return o(extend({time:0},e));let r=o,p=n.mapFunction,m=n.min,s=n.max,l=n.within,c;if("object"==typeof o&&(r=o.mapTo,p=o.mapFunction||p,m=pick(o.min,m),s=pick(o.max,s),l=o.within||n.within,c=o.scale),!r)return null;n="-"===r.charAt(0);n&&(r=r.slice(1));let u=e.value;var f="value"===r&&void 0!==u&&a;if(!f){var o=o.value;if(void 0!==o)u=o;else{if(!e.point)return null;u=e.point[r]}void 0===u&&(u=getNestedProperty(r,e.point))}if("number"!=typeof u||null===u)return null;let h=null;if(e.point&&("xAxis"===l||"yAxis"===l?(o=e.point.series[l])&&defined(o.dataMin)&&defined(o.dataMax)&&(h={min:o.dataMin,max:o.dataMax}):("series"===l||i)&&e.point.series&&(h=t.seriesExtremes[e.point.series.index][f?a:r])),h=h||t.globalExtremes[f?a:r],c){const g=[],x=Math.floor(m/12),v=Math.ceil(s/12)+1,y=c.length;for(let t=x;t<v;++t)for(let e=0;e<y;++e){var d=12*t+c[e];d>=m&&d<=s&&g.push(d)}o=mapToVirtualAxis(u,h,{min:0,max:g.length-1},n,"logarithmic"===p);return g[Math.round(o)]}return mapToVirtualAxis(u,h,{min:m,max:s},n,"logarithmic"===p)}function getParamValWithDefault(e,t,i,n,o,a,r){return pick(getMappingParameterValue(e,t,i,extend({min:0,max:1,mapTo:"y",mapFunction:"linear",within:"chart"},a||{}),n,r),o)}function getPointTime(e,t,i,n,o,a){return getParamValWithDefault({point:e,time:0},o,a,n,0,{min:0,max:i,mapTo:"x"})+t}function getAvailableDurationForSeries(e,t,i,n){let o,a;var t=t-(e.chart.series.length-1)*n,n=i.seriesTimeProps.every(e=>{e=Object.keys(e);return!(1<e.length)&&(o=o||e[0])===e[0]});return a=n?(n=(n=i.seriesExtremes[e.index][o]).max-n.min,i=i.seriesExtremes.reduce((e,t)=>t[o]?e+t[o].max-t[o].min:e,0),Math.round(n/i*t)):(n=e.chart.series.reduce((e,t)=>e+t.points.length,0),Math.round((e.points||[]).length/n*t)),Math.max(50,a)}function addTimelineChannelFromTrack(e,t,i,n){var o=n.mapping||{},t="speech"===n.type?new SonificationSpeaker({language:n.language,name:n.preferredVoice}):new SonificationInstrument(t,i,{capabilities:{pan:!!o.pan,tremolo:!!o.tremolo,filters:!(!o.highpass&&!o.lowpass)},synthPatch:n.instrument,midiTrackName:n.midiName});return e.addChannel(n.type||"instrument",t,pick(n.showPlayMarker,!0))}function addMappedInstrumentEvent(o,n,a,r,p,m){var e=(e,t,i,n)=>getParamValWithDefault(o,r,!1,(n||a)[e],t,i,m);const s=[],l={noteDuration:e("noteDuration",200,{min:40,max:1e3}),pan:e("pan",0,{min:-1,max:1}),volume:e("volume",1,{min:.1,max:1})},c=(a.frequency&&(l.frequency=e("frequency",440,{min:50,max:6e3})),a.lowpass&&(l.lowpassFreq=e("frequency",2e4,{min:0,max:2e4},a.lowpass),l.lowpassResonance=e("resonance",0,{min:-6,max:12},a.lowpass)),a.highpass&&(l.highpassFreq=e("frequency",2e4,{min:0,max:2e4},a.highpass),l.highpassResonance=e("resonance",0,{min:-6,max:12},a.highpass)),a.tremolo&&(l.tremoloDepth=e("depth",0,{min:0,max:.8},a.tremolo),l.tremoloSpeed=e("speed",0,{min:0,max:.8},a.tremolo)),e("gapBetweenNotes",150,{min:50,max:1e3})),u=e("playDelay",0,{max:200});e=(e,t=0)=>{let i=e;e.mapTo?("string"==typeof e.min&&(i.min=SonificationInstrument.noteStringToC0Distance(e.min)),"string"==typeof e.max&&(i.max=SonificationInstrument.noteStringToC0Distance(e.max))):"string"==typeof e&&isNoteDefinition(e)&&(i=SonificationInstrument.noteStringToC0Distance(e)),l.note=getParamValWithDefault(o,r,!1,i,-1,{min:0,max:107},m),-1<l.note&&(p&&(l.note=Math.round(l.note)),s.push(n.addEvent({time:o.time+u+c*t,relatedPoint:o.point,instrumentEventOptions:void 0!==t?extend({},l):l})))};return a.pitch&&a.pitch.constructor===Array?a.pitch.forEach(e):a.pitch?e(a.pitch):a.frequency&&s.push(n.addEvent({time:o.time+u,relatedPoint:o.point,instrumentEventOptions:l})),s}function getSpeechMessageValue(e,t){return format("function"==typeof t?t(e):t,e,e.point&&e.point.series.chart)}function addMappedSpeechEvent(n,e,o,a,r){var t=(e,t,i)=>getParamValWithDefault(n,a,!1,o[e],t,i,r),i=t("playDelay",0,{max:200}),p=t("pitch",1,{min:.3,max:2}),m=t("rate",1,{min:.4,max:4}),t=t("volume",1,{min:.1}),s=getSpeechMessageValue(n,o.text);if(s)return e.addEvent({time:n.time+i,relatedPoint:n.point,speechOptions:{pitch:p,rate:m,volume:t},message:s})}function addMappedEventForPoint(e,t,i,n){let o=[];var a;return"speech"===i.type&&i.mapping?(a=addMappedSpeechEvent(e,t,i.mapping,n))&&(o=[a]):i.mapping&&(o=addMappedInstrumentEvent(e,t,i.mapping,n,pick(i.roundToMusicalNotes,!0))),o}function getGroupedPoints(e,t){var i=e.algorithm||"minmax",n=e=>t[e]?[t[e].point]:[];if("first"===i)return n(0);if("last"===i)return n(t.length-1);if("middle"===i)return n(t.length>>1);if("firstlast"===i)return n(0).concat(n(t.length-1));if("minmax"===i){const r=e.prop||"y";let i,n,o,a;if(t.forEach(e=>{var t=getPointPropValue(e.point,r);void 0!==t&&((!i||t<o)&&(i=e,o=t),(!n||t>a)&&(n=e,a=t))}),i&&n)return i.point===n.point?[i.point]:i.time>n.time?[n.point,i.point]:[i.point,n.point]}return[]}function isActive(t,i,n){if("function"==typeof i)return i(t);if("object"!=typeof i)return!0;{var o=i.prop,t=pick(t.value,t.point&&getPointPropValue(t.point,o));if("number"!=typeof t)return!1;let e=!0;var o=i.crossingUp,a=i.crossingDown,r="number"==typeof n,o=(e=o&&a?r&&(n<o&&o<=t||a<n&&t<=a):(void 0===o||r&&n<o&&o<=t)&&(void 0===a||r&&a<n&&t<=a),pick(i.max,1/0)),r=pick(i.min,-1/0);return t<=o&&r<=t&&e}}function timelineFromChart(v,y,e){const t=e.options.sonification||{},c=t.defaultInstrumentOptions,u=t.defaultSpeechOptions,s=merge({enabled:!0,groupTimespan:15,algorithm:"minmax",prop:"y"},t.pointGrouping),f=t.globalTracks||[],T=t.globalContextTracks||[],P="sequential"===t.order,b=Math.max(50,t.duration-300),S=t.afterSeriesWait,E=t.events||{},M=getPropMetrics(e),k=new SonificationTimeline({onPlay:E.onPlay,onEnd:E.onEnd,onStop:E.onStop,showCrosshair:t.showCrosshair,showTooltip:t.showTooltip},e);e.sonification&&(e.sonification.propMetrics=M);let w=0;return e.series.forEach((d,l)=>{const e=d.options.sonification||{};if(d.visible&&!1!==e.enabled){const g=P?getAvailableDurationForSeries(d,b,M,S):b,i=merge(c,e.defaultInstrumentOptions),n=merge(u,e.defaultSpeechOptions),o=merge(s,e.pointGrouping),t=(e.tracks||[i]).concat(f),a=!!k.channels.length,r=a&&!P?e.contextTracks||[]:(e.contextTracks||[]).concat(T),x=[];let h;t.forEach(e=>{const r=merge({pointGrouping:o,midiName:e.midiName||d.name},"speech"===e.type?n:i,e),p=r.pointGrouping,m=r.activeWhen,s=e=>{"object"==typeof m&&m.prop&&(h=getPointPropValue(e,m.prop))},t=addTimelineChannelFromTrack(k,v,y,r),l=e=>x.push(...addMappedEventForPoint(e,t,r,M));let c=[],u=0;const f=e=>{if(1===c.length)l({point:c[0].point,time:u+e/2});else{const t=getGroupedPoints(p,c),i=e/t.length;t.forEach((e,t)=>l({point:e,time:u+i/2+i*t}))}c=[]};(d.points||[]).forEach((e,t)=>{var i,n,t=t===d.points.length-1,o=getPointTime(e,w,g,r.mapping&&r.mapping.time||0,M,P),a={point:e,time:o};if(!r.mapping||!isActive(a,m,h))return s(e),void(t&&c.length&&f(c[c.length-1].time-c[0].time));s(e),p.enabled?(e=o-u,i=p.groupTimespan,n=t&&e<=i?e:i,t||i<e?(e<=i&&c.push(a),f(n),u=Math.floor(o/i)*i,t&&i<e?l({point:a.point,time:u+n/2}):c=[a]):c.push(a)):l(a)})});const p=x.reduce((e,t)=>t.time<e.time?t:e,{time:1/0}),m=x.reduce((e,t)=>t.time>e.time?t:e,{time:-1/0});p.callback=E.onSeriesStart?E.onSeriesStart.bind(null,{series:d,timeline:k}):void 0,m.callback=E.onSeriesEnd?E.onSeriesEnd.bind(null,{series:d,timeline:k}):void 0,r.forEach(e=>{const i="speech"===e.type?merge(u,e):merge(c,{mapping:{pitch:{mapTo:"value"}}},e),n=addTimelineChannelFromTrack(k,v,y,i),{timeInterval:t,valueInterval:o}=(h=void 0,i),a=i.valueProp||"x",r=i.activeWhen,p=M.seriesExtremes[l][a],m=(e,t)=>{i.mapping&&isActive({time:e,value:t},"object"==typeof r?extend({prop:a},r):r,h)?(h=t,"speech"===i.type?addMappedSpeechEvent({time:e,value:t},n,i.mapping,M,a):addMappedInstrumentEvent({time:e,value:t},n,i.mapping,M,pick(i.roundToMusicalNotes,!0),a)):h=t};if(t){let e=0;for(;e<=g;){var s=mapToVirtualAxis(e,{min:0,max:g},p);m(e+w,s),e+=t}}if(o){let e=p.min;for(;e<=p.max;)m(mapToVirtualAxis(e,p,{min:0,max:g},!1,"logarithmic"===i.valueMapFunction)+w,e),e+=o}}),P&&(w+=g+S)}}),k}export default timelineFromChart;