"use strict";import A from"../../Core/Animation/AnimationUtilities.js";const animObject=A["animObject"];import Chart from"../../Core/Chart/Chart.js";import T from"../../Core/Templating.js";const format=T["format"];import D from"../../Core/Defaults.js";const setOptions=D["setOptions"];import SeriesLabelDefaults from"./SeriesLabelDefaults.js";import SLU from"./SeriesLabelUtilities.js";const{boxIntersectLine,intersectRect}=SLU;import U from"../../Core/Utilities.js";const{addEvent,extend,fireEvent,isNumber,pick,syncTimeout}=U,composedMembers=[],labelDistance=3;function checkClearPoint(t,e,o,r,a){var i=t.chart,s=t.options.label||{},n=pick(s.onArea,!!t.area),h=n||s.connectorAllowed,l=16,c=i.boxesToAvoid;let p=Number.MAX_VALUE,d=Number.MAX_VALUE,b,m,f,x,u,g,y;for(g=0;c&&g<c.length;g+=1)if(intersectRect(c[g],{left:e,right:e+r.width,top:o,bottom:o+r.height}))return!1;for(g=0;g<i.series.length;g+=1){const X=i.series[g],M=X.interpolatedPoints&&[...X.interpolatedPoints];if(X.visible&&M){var Y=i.plotHeight/10;for(let t=i.plotTop;t<=i.plotTop+i.plotHeight;t+=Y)M.unshift({chartX:i.plotLeft,chartY:t}),M.push({chartX:i.plotLeft+i.plotWidth,chartY:t});for(y=1;y<M.length;y+=1){if(M[y].chartX>=e-l&&M[y-1].chartX<=e+r.width+l){if(boxIntersectLine(e,o,r.width,r.height,M[y-1].chartX,M[y-1].chartY,M[y].chartX,M[y].chartY))return!1;t===X&&!f&&a&&(f=boxIntersectLine(e-l,o-l,r.width+32,r.height+32,M[y-1].chartX,M[y-1].chartY,M[y].chartX,M[y].chartY))}!h&&!f||t===X&&!n||(x=e+r.width/2-M[y].chartX,u=o+r.height/2-M[y].chartY,p=Math.min(p,x*x+u*u))}if(!n&&h&&t===X&&(a&&!f||p<Math.pow(s.connectorNeighbourDistance||1,2))){for(y=1;y<M.length;y+=1)(b=Math.min(Math.pow(e+r.width/2-M[y].chartX,2)+Math.pow(o+r.height/2-M[y].chartY,2),Math.pow(e-M[y].chartX,2)+Math.pow(o-M[y].chartY,2),Math.pow(e+r.width-M[y].chartX,2)+Math.pow(o-M[y].chartY,2),Math.pow(e+r.width-M[y].chartX,2)+Math.pow(o+r.height-M[y].chartY,2),Math.pow(e-M[y].chartX,2)+Math.pow(o+r.height-M[y].chartY,2)))<d&&(d=b,m=M[y]);f=!0}}}return!(a&&!f)&&{x:e,y:o,weight:p-(m?d:0),connectorPoint:m}}function compose(t,e){U.pushUnique(composedMembers,t)&&(addEvent(Chart,"load",onChartRedraw),addEvent(Chart,"redraw",onChartRedraw)),U.pushUnique(composedMembers,e)&&(e.prototype.symbols.connector=symbolConnector),U.pushUnique(composedMembers,setOptions)&&setOptions({plotOptions:{series:{label:SeriesLabelDefaults}}})}function drawSeriesLabels(v){v.boxesToAvoid=[];const t=v.labelSeries||[],i=v.boxesToAvoid;v.series.forEach(a=>(a.points||[]).forEach(t=>(t.dataLabels||[]).forEach(t=>{var{width:e,height:o}=t.getBBox(),r=(t.translateX||0)+(a.xAxis?a.xAxis.pos:a.chart.plotLeft),t=(t.translateY||0)+(a.yAxis?a.yAxis.pos:a.chart.plotTop);i.push({left:r,top:t,right:r+e,bottom:t+o})}))),t.forEach(function(t){var e=t.options.label||{};t.interpolatedPoints=getPointsOnGraph(t),i.push(...e.boxesToAvoid||[])}),v.series.forEach(function(c){const p=c.options.label;if(p&&(c.xAxis||c.yAxis)){const f="highcharts-color-"+pick(c.colorIndex,"none"),x=!c.labelBySeries,u=p.minFontSize,g=p.maxFontSize,y=v.inverted,Y=(y?c.yAxis:c.xAxis).pos,X=(y?c.xAxis:c.yAxis).pos,M=(v.inverted?c.yAxis:c.xAxis).len,w=(v.inverted?c.xAxis:c.yAxis).len,A=c.interpolatedPoints,S=pick(p.onArea,!!c.area),L=[],C=c.xData||[];let t,e,o,r,a,i,s=c.labelBySeries,n,h,l;if(S&&!y&&(n=[c.xAxis.toPixels(C[0]),c.xAxis.toPixels(C[C.length-1])],h=Math.min.apply(Math,n),l=Math.max.apply(Math,n)),c.visible&&!c.boosted&&A){if(!s){let t=c.name;"string"==typeof p.format?t=format(p.format,c,v):p.formatter&&(t=p.formatter.call(c)),c.labelBySeries=s=v.renderer.label(t,0,0,"connector",0,0,p.useHTML).addClass("highcharts-series-label highcharts-series-label-"+c.index+" "+(c.options.className||"")+" "+f),v.renderer.styledMode||(d="string"==typeof c.color?c.color:"#666666",s.css(extend({color:S?v.renderer.getContrast(d):d},p.style||{})),s.attr({opacity:v.renderer.forExport?1:0,stroke:c.color,"stroke-width":1})),u&&g&&s.css({fontSize:labelFontSize(c,u,g)}),s.attr({padding:0,zIndex:3}).add()}for((t=s.getBBox()).width=Math.round(t.width),a=A.length-1;0<a;--a)S?(e=A[a].chartX-t.width/2,o=(A[a].chartCenterY||0)-t.height/2,(i=b(e,o,t)?checkClearPoint(c,e,o,t):i)&&L.push(i)):(e=A[a].chartX+labelDistance,o=A[a].chartY-t.height-labelDistance,(i=b(e,o,t)?checkClearPoint(c,e,o,t,!0):i)&&L.push(i),e=A[a].chartX+labelDistance,o=A[a].chartY+labelDistance,(i=b(e,o,t)?checkClearPoint(c,e,o,t,!0):i)&&L.push(i),e=A[a].chartX-t.width-labelDistance,o=A[a].chartY+labelDistance,(i=b(e,o,t)?checkClearPoint(c,e,o,t,!0):i)&&L.push(i),e=A[a].chartX-t.width-labelDistance,o=A[a].chartY-t.height-labelDistance,(i=b(e,o,t)?checkClearPoint(c,e,o,t,!0):i)&&L.push(i));if(p.connectorAllowed&&!L.length&&!S)for(e=Y+M-t.width;e>=Y;e-=16)for(o=X;o<X+w-t.height;o+=16)(r=checkClearPoint(c,e,o,t,!0))&&L.push(r);if(L.length){L.sort((t,e)=>e.weight-t.weight),i=L[0],(v.boxesToAvoid||[]).push({left:i.x,right:i.x+t.width,top:i.y,bottom:i.y+t.height});var d=Math.sqrt(Math.pow(Math.abs(i.x-(s.x||0)),2)+Math.pow(Math.abs(i.y-(s.y||0)),2));if(d&&c.labelBySeries){let t={opacity:v.renderer.forExport?1:0,x:i.x,y:i.y},e={opacity:1};d<=10&&(e={x:t.x,y:t.y},t={});let o;x&&((o=animObject(c.options.animation)).duration*=.2),c.labelBySeries.attr(extend(t,{anchorX:i.connectorPoint&&(i.connectorPoint.plotX||0)+Y,anchorY:i.connectorPoint&&(i.connectorPoint.plotY||0)+X})).animate(e,o),c.options.kdNow=!0,c.buildKDTree();d=c.searchPoint({chartX:i.x,chartY:i.y},!0);d&&(s.closest=[d,i.x-(d.plotX||0),i.y-(d.plotY||0)])}}else m()}else m();function b(t,e,o){var r=Math.max(Y,pick(h,-1/0)),a=Math.min(Y+M,pick(l,1/0));return r<t&&t<=a-o.width&&e>=X&&e<=X+w-o.height}function m(){s&&(c.labelBySeries=s.destroy())}}}),fireEvent(v,"afterDrawSeriesLabels")}function getPointsOnGraph(t){if(t.xAxis||t.yAxis){const m=t.points,f=[],x=t.graph||t.area,u=x&&x.element,g=t.chart.inverted,y=t.xAxis,Y=t.yAxis,X=(g?Y:y).pos,M=(g?y:Y).pos,w=t.options.label||{},A=pick(w.onArea,!!t.area),S=Y.getThreshold(t.options.threshold),L={};let e,o,r,a,i,s,n;if(t.getPointSpline&&u&&u.getPointAtLength&&!A&&m.length<(t.chart.plotSizeX||0)/16){t=x.toD&&x.attr("d");for(x.toD&&x.attr({d:x.toD}),i=u.getTotalLength(),e=0;e<i;e+=16){var h=u.getPointAtLength(e);b({chartX:X+h.x,chartY:M+h.y,plotX:h.x,plotY:h.y})}t&&x.attr({d:t});t=m[m.length-1];b({chartX:X+(t.plotX||0),chartY:M+(t.plotY||0)})}else{i=m.length;let t;for(e=0;e<i;e+=1){var l=m[e],{plotX:c,plotY:p,plotHigh:d}=l;if(isNumber(c)&&isNumber(p)){const C={plotX:c,plotY:p,chartX:X+c,chartY:M+p};if(A&&(d&&(C.plotY=d,C.chartY=M+d),C.chartCenterY=M+((d||p)+pick(l.yBottom,S))/2),t&&(o=Math.abs(C.chartX-t.chartX),r=Math.abs(C.chartY-t.chartY),16<(a=Math.max(o,r))))for(s=Math.ceil(a/16),n=1;n<s;n+=1)b({chartX:t.chartX+(C.chartX-t.chartX)*(n/s),chartY:t.chartY+(C.chartY-t.chartY)*(n/s),chartCenterY:(t.chartCenterY||0)+((C.chartCenterY||0)-(t.chartCenterY||0))*(n/s),plotX:(t.plotX||0)+(c-(t.plotX||0))*(n/s),plotY:(t.plotY||0)+(p-(t.plotY||0))*(n/s)});b(C),t=C}}}return f;function b(t){var e=Math.round((t.plotX||0)/8)+","+Math.round((t.plotY||0)/8);L[e]||(L[e]=1,f.push(t))}}}function labelFontSize(t,e,o){return e+(t.sum||0)/(t.chart.labelSeriesMaxSum||0)*(o-e)+"px"}function onChartRedraw(i){if(this.renderer){const s=this;let a=animObject(s.renderer.globalAnimation).duration;s.labelSeries=[],s.labelSeriesMaxSum=0,s.seriesLabelTimer&&U.clearTimeout(s.seriesLabelTimer),s.series.forEach(function(t){const e=t.options.label||{},o=t.labelBySeries,r=o&&o.closest;e.enabled&&t.visible&&(t.graph||t.area)&&!t.boosted&&s.labelSeries&&(s.labelSeries.push(t),e.minFontSize&&e.maxFontSize&&t.yData&&(t.sum=t.yData.reduce((t,e)=>(t||0)+(e||0),0),s.labelSeriesMaxSum=Math.max(s.labelSeriesMaxSum||0,t.sum||0)),"load"===i.type&&(a=Math.max(a,animObject(t.options.animation).duration)),r&&(void 0!==r[0].plotX?o.animate({x:r[0].plotX+r[1],y:r[0].plotY+r[2]}):o.attr({opacity:0})))}),s.seriesLabelTimer=syncTimeout(function(){s.series&&s.labelSeries&&drawSeriesLabels(s)},s.renderer.forExport||!a?0:a)}}function symbolConnector(t,e,o,r,a){var i=a&&a.anchorX,a=a&&a.anchorY;let s,n,h=o/2;return isNumber(i)&&isNumber(a)&&(s=[["M",i,a]],(n=(n=e-a)<0?-r-n:n)<o&&(h=i<t+o/2?n:o-n),e+r<a?s.push(["L",t+h,e+r]):a<e?s.push(["L",t+h,e]):i<t?s.push(["L",t,e+r/2]):t+o<i&&s.push(["L",t+o,e+r/2])),s||[]}const SeriesLabel={compose:compose};export default SeriesLabel;