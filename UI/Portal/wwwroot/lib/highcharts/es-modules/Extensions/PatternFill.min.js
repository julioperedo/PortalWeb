"use strict";import A from"../Core/Animation/AnimationUtilities.js";const animObject=A["animObject"];import Chart from"../Core/Chart/Chart.js";import H from"../Core/Globals.js";import D from"../Core/Defaults.js";const getOptions=D["getOptions"];import Point from"../Core/Series/Point.js";import Series from"../Core/Series/Series.js";import SVGRenderer from"../Core/Renderer/SVG/SVGRenderer.js";import U from"../Core/Utilities.js";const{addEvent,defined,erase,merge,pick,removeEvent,wrap}=U,patterns=H.patterns=(()=>{const r=[],i=getOptions().colors;return["M 0 0 L 5 5 M 4.5 -0.5 L 5.5 0.5 M -0.5 4.5 L 0.5 5.5","M 0 5 L 5 0 M -0.5 0.5 L 0.5 -0.5 M 4.5 5.5 L 5.5 4.5","M 2 0 L 2 5 M 4 0 L 4 5","M 0 2 L 5 2 M 0 4 L 5 4","M 0 1.5 L 2.5 1.5 L 2.5 0 M 2.5 5 L 2.5 3.5 L 5 3.5"].forEach((t,e)=>{r.push({path:t,color:i[e],width:5,height:5,patternTransform:"scale(1.4 1.4)"})}),["M 0 0 L 5 10 L 10 0","M 3 3 L 8 3 L 8 8 L 3 8 Z","M 5 5 m -4 0 a 4 4 0 1 1 8 0 a 4 4 0 1 1 -8 0","M 0 0 L 10 10 M 9 -1 L 11 1 M -1 9 L 1 11","M 0 10 L 10 0 M -1 1 L 1 -1 M 9 11 L 11 9"].forEach((t,e)=>{r.push({path:t,color:i[e+5],width:10,height:10})}),r})();function hashFromObject(t,e){const r=JSON.stringify(t),i=r.length||0;let o=0,n=0,a,s;if(e){s=Math.max(Math.floor(i/500),1);for(let t=0;t<i;t+=s)o+=r.charCodeAt(t);o&=o}for(;n<i;++n)a=r.charCodeAt(n),o=(o<<5)-o+a,o&=o;return o.toString(16).replace("-","1")}Point.prototype.calculatePatternDimensions=function(t){if(!t.width||!t.height){const r=this.graphic&&(this.graphic.getBBox&&this.graphic.getBBox(!0)||this.graphic.element&&this.graphic.element.getBBox())||{},i=this.shapeArgs;if(i&&(r.width=i.width||r.width,r.height=i.height||r.height,r.x=i.x||r.x,r.y=i.y||r.y),t.image){var e;if(!r.width||!r.height)return t._width="defer",t._height="defer",e=this.series.chart.mapView&&this.series.chart.mapView.getSVGTransform().scaleY,void(defined(e)&&e<0&&(t._inverted=!0));t.aspectRatio&&(r.aspectRatio=r.width/r.height,t.aspectRatio>r.aspectRatio?r.aspectWidth=r.height*t.aspectRatio:r.aspectHeight=r.width/t.aspectRatio),t._width=t.width||Math.ceil(r.aspectWidth||r.width),t._height=t.height||Math.ceil(r.aspectHeight||r.height)}t.width||(t._x=t.x||0,t._x+=r.x-Math.round(r.aspectWidth?Math.abs(r.aspectWidth-r.width)/2:0)),t.height||(t._y=t.y||0,t._y+=r.y-Math.round(r.aspectHeight?Math.abs(r.aspectHeight-r.height)/2:0))}},SVGRenderer.prototype.addPattern=function(e,t){let r,i=pick(t,!0),o=animObject(i),n,a=e.width||e._width||32,s=e.height||e._height||32,h=e.color||"#343434",p=e.id,c=this,d;if(p||(this.idCounter=this.idCounter||0,p="highcharts-pattern-"+this.idCounter+"-"+(this.chartIndex||0),++this.idCounter),this.forExport&&(p+="-export"),this.defIds=this.defIds||[],!(-1<this.defIds.indexOf(p))){this.defIds.push(p);const l={id:p,patternUnits:"userSpaceOnUse",patternContentUnits:e.patternContentUnits||"userSpaceOnUse",width:a,height:s,x:e._x||e.x||0,y:e._y||e.y||0};return e._inverted&&(l.patternTransform="scale(1, -1)",e.patternTransform&&(e.patternTransform+=" scale(1, -1)")),e.patternTransform&&(l.patternTransform=e.patternTransform),(r=this.createElement("pattern").attr(l).add(this.defs)).id=p,e.path?(n=U.isObject(e.path)?e.path:{d:e.path},e.backgroundColor&&(t=e.backgroundColor,c.rect(0,0,a,s).attr({fill:t}).add(r)),d={d:n.d},this.styledMode||(d.stroke=n.stroke||h,d["stroke-width"]=pick(n.strokeWidth,2),d.fill=n.fill||"none"),n.transform&&(d.transform=n.transform),this.createElement("path").attr(d).add(r),r.color=h):e.image&&(i?this.image(e.image,0,0,a,s,function(){this.animate({opacity:pick(e.opacity,1)},o),removeEvent(this.element,"load")}).attr({opacity:0}):this.image(e.image,0,0,a,s)).add(r),e.image&&i||void 0===e.opacity||[].forEach.call(r.element.childNodes,function(t){t.setAttribute("opacity",e.opacity)}),this.patternElements=this.patternElements||{},this.patternElements[p]=r}},wrap(Series.prototype,"getColor",function(t){const e=this.options.color;e&&e.pattern&&!e.pattern.color?(delete this.options.color,t.apply(this,Array.prototype.slice.call(arguments,1)),e.pattern.color=this.color,this.color=this.options.color=e):t.apply(this,Array.prototype.slice.call(arguments,1))}),addEvent(Series,"render",function(){const r=this.chart.isResizing;!this.isDirtyData&&!r&&this.chart.hasRendered||(this.points||[]).forEach(function(t){const e=t.options&&t.options.color;e&&e.pattern&&(!r||t.shapeArgs&&t.shapeArgs.width&&t.shapeArgs.height?t.calculatePatternDimensions(e.pattern):(e.pattern._width="defer",e.pattern._height="defer"))})}),addEvent(Point,"afterInit",function(){const t=this,e=t.options.color;e&&e.pattern&&("string"==typeof e.pattern.path&&(e.pattern.path={d:e.pattern.path}),t.color=t.options.color=merge(t.series.options.color,e))}),addEvent(SVGRenderer,"complexColor",function(t){const e=t.args[0],r=t.args[1],i=t.args[2],o=this.chartIndex||0;let n=e.pattern,a="#343434";if(!(n=void 0!==e.patternIndex&&patterns?patterns[e.patternIndex]:n))return!0;if(n.image||"string"==typeof n.path||n.path&&n.path.d){let t=i.parentNode&&i.parentNode.getAttribute("class");t=t&&-1<t.indexOf("highcharts-legend"),"defer"!==n._width&&"defer"!==n._height||Point.prototype.calculatePatternDimensions.call({graphic:{element:i}},n),!t&&n.id||((n=merge({},n)).id="highcharts-pattern-"+o+"-"+hashFromObject(n)+hashFromObject(n,!0)),this.addPattern(n,!this.forExport&&pick(n.animation,this.globalAnimation,{duration:100})),a=`url(${this.url}#${n.id+(this.forExport?"-export":"")})`}else a=n.color||a;return i.setAttribute(r,a),!(e.toString=function(){return a})}),addEvent(Chart,"endResize",function(){(this.renderer&&this.renderer.defIds||[]).filter(function(t){return t&&t.indexOf&&0===t.indexOf("highcharts-pattern-")}).length&&(this.series.forEach(function(t){t.visible&&t.points.forEach(function(t){const e=t.options&&t.options.color;e&&e.pattern&&(e.pattern._width="defer",e.pattern._height="defer")})}),this.redraw(!1))}),addEvent(Chart,"redraw",function(){const r={},i=this.renderer,t=(i.defIds||[]).filter(function(t){return t.indexOf&&0===t.indexOf("highcharts-pattern-")});t.length&&([].forEach.call(this.renderTo.querySelectorAll('[color^="url("], [fill^="url("], [stroke^="url("]'),function(t){const e=t.getAttribute("fill")||t.getAttribute("color")||t.getAttribute("stroke");e&&(t=e.replace(i.url,"").replace("url(#","").replace(")",""),r[t]=!0)}),t.forEach(function(t){r[t]||(erase(i.defIds,t),i.patternElements[t]&&(i.patternElements[t].destroy(),delete i.patternElements[t]))}))});