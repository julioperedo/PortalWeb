"use strict";import BoostChart from"./Boost/BoostChart.js";const{getBoostClipRect,isChartSeriesBoosting}=BoostChart;import BoostSeries from"./Boost/BoostSeries.js";const destroyGraphics=BoostSeries["destroyGraphics"];import Chart from"../Core/Chart/Chart.js";import Color from"../Core/Color/Color.js";const color=Color["parse"];import H from"../Core/Globals.js";const{doc,noop}=H;import U from"../Core/Utilities.js";const{addEvent,fireEvent,isNumber,merge,pick,pushUnique,wrap}=U;var BoostCanvas;!function(t){const g="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",$=5e4,h=[];let tt;function p(t,o,e,i,s){s&&o!==s.clientX&&(t.moveTo(s.clientX,s.yBottom),t.lineTo(s.clientX,s.plotY),t.lineTo(o,e),t.lineTo(o,i))}function d(t,o,e,i,s){t.moveTo(o,e),t.arc(o,e,this.radii&&this.radii[s],0,2*Math.PI,!1)}function u(t,o,e,i){t.rect(o-1,e,1,i-e)}function v(){this.boost&&this.boost.copy&&this.boost.copy()}function f(){const t=this.boost||{};t.target&&t.target.attr({href:g}),t.canvas&&t.canvas.getContext("2d").clearRect(0,0,t.canvas.width,t.canvas.height)}function m(){isChartSeriesBoosting(this.chart)?this.boost&&this.boost.clear&&this.boost.clear():this.boost&&this.boost.copy?this.boost.copy():this.chart.boost&&this.chart.boost.copy&&this.chart.boost.copy()}function b(t,o,e){t.lineTo(o,e)}function y(){function o(t,o,e,i,s,r,a){t.call(this,e,o,i,s,r,a)}const t=this.chart,e=isChartSeriesBoosting(t)?t:this,i=e===t?t.seriesGroup:t.seriesGroup||this.group,s=t.chartWidth,r=t.chartHeight;let a;const n=e.boost=e.boost||{};return a=n.targetCtx,n.canvas?e:(n.canvas=doc.createElement("canvas"),n.target=t.renderer.image("",0,0,s,r).addClass("highcharts-boost-canvas").add(i),a=n.targetCtx=n.canvas.getContext("2d"),t.inverted&&["moveTo","lineTo","rect","arc"].forEach(t=>{wrap(a,t,o)}),n.copy=function(){n.target.attr({href:n.canvas.toDataURL("image/png")})},n.clear=function(){a.clearRect(0,0,n.canvas.width,n.canvas.height),e===n.target&&n.target.attr({href:g})},n.clipRect=t.renderer.clipRect(),n.target.clip(n.clipRect)),n.canvas.width!==s&&(n.canvas.width=s),n.canvas.height!==r&&(n.canvas.height=r),n.target.attr({x:0,y:0,width:s,height:r,style:"pointer-events: none",href:g}),n.clipRect&&n.clipRect.attr(getBoostClipRect(t,e)),a}function C(){const A=this,t=A.options,x=A.chart,S=A.xAxis,B=A.yAxis,o=x.options.boost||{},e={timeRendering:o.timeRendering||!1,timeSeriesProcessing:o.timeSeriesProcessing||!1,timeSetup:o.timeSetup||!1},i=A.processedXData,w=A.processedYData,a=t.data,s=S.getExtremes(),T=s.min,k=s.max,r=B.getExtremes(),R=r.min,E=r.max,n={},I=!!A.sampling,c=t.marker&&t.marker.radius,K=A.cvsStrokeBatch||1e3,W=t.enableMouseTracking,l=t.threshold,M=isNumber(l),N=B.getThreshold(l),Q=A.fill,D=A.pointArrayMap&&"low,high"===A.pointArrayMap.join(","),G=!!t.stacking,h=A.cropStart||0,p=x.options.loading,z=A.requireSorting,J=t.connectNulls,P=!i,q=G?A.data:i||a,_=A.fillOpacity?Color.parse(A.color).setOpacity(pick(t.fillOpacity,.75)).get():A.color,F="x"===t.findNearestPointBy,d=this.boost||{},u=A.cvsDrawPoint,Y=t.lineWidth?A.cvsLineTo:void 0,X=c&&c<=1?A.cvsMarkerSquare:A.cvsMarkerCircle,Z=(d.target&&d.target.attr({href:g}),(A.points||A.graph)&&destroyGraphics(A),A.plotGroup("group","series",A.visible?"visible":"hidden",t.zIndex,x.seriesGroup),A.markerGroup=A.group,addEvent(A,"destroy",function(){A.markerGroup=null}),this.points=[]),j=this.getContext();if(A.buildKDTree=noop,d.clear&&d.clear(),A.visible){99999<a.length&&(x.options.loading=merge(p,{labelStyle:{backgroundColor:color("#ffffff").setOpacity(.75).get(),padding:"1em",borderRadius:"0.5em"},style:{backgroundColor:"none",opacity:1}}),U.clearTimeout(tt),x.showLoading("Drawing..."),x.options.loading=p),e.timeRendering&&console.time("canvas rendering");let s=0,g,r,v=N,f,m,b,y,C,i;const L=function(){Q?(j.fillStyle=_,j.fill()):(j.strokeStyle=A.color,j.lineWidth=t.lineWidth,j.stroke())},O=function(t,o,e,i){0===s&&(j.beginPath(),Y&&(j.lineJoin="round")),x.scroller&&"highcharts-navigator-series"===A.options.className?(o+=x.scroller.top,e&&(e+=x.scroller.top)):o+=x.plotTop,t+=x.plotLeft,f?j.moveTo(t,o):u?u(j,t,o,e,r):Y?Y(j,t,o):X&&X.call(A,j,t,o,c,i),(s+=1)===K&&(L(),s=0),r={clientX:t,plotY:o,yBottom:e}},V=this.xData||this.options.xData||this.processedXData||!1,H=function(t,o,e){i=F?t:t+","+o,W&&!n[i]&&(n[i]=!0,x.inverted&&(t=S.len-t,o=B.len-o),Z.push({x:!!V&&V[h+e],clientX:t,plotX:t,plotY:o,i:h+e}))};BoostSeries.eachAsync(q,(t,o)=>{var e=void 0===x.index;let i,s,r,a,n,c,l=!1,h=!1,p=NaN,d=NaN,u=!0;return e||(P?(i=t[0],s=t[1],q[o+1]&&(p=q[o+1][0]),q[o-1]&&(d=q[o-1][0])):(i=t,s=w[o],q[o+1]&&(p=q[o+1]),q[o-1]&&(d=q[o-1])),p&&p>=T&&p<=k&&(l=!0),d&&d>=T&&d<=k&&(h=!0),D?(P&&(s=t.slice(1,3)),c=s[0],s=s[1]):G&&(i=t.x,s=t.stackY,c=s-t.y),n=null===s,z||(u=s>=R&&s<=E),!n&&(i>=T&&i<=k&&u||l||h)&&(r=Math.round(S.toPixels(i,!0)),I?(void 0!==y&&r!==g||(D||(c=s),(void 0===C||s>b)&&(b=s,C=o),(void 0===y||c<m)&&(m=c,y=o)),r!==g&&(void 0!==y&&(a=B.toPixels(b,!0),v=B.toPixels(m,!0),O(r,M?Math.min(a,N):a,M?Math.max(v,N):v,o),H(r,a,C),v!==a&&H(r,v,y)),y=C=void 0,g=r)):(a=Math.round(B.toPixels(s,!0)),O(r,a,v,o),H(r,a,o))),f=n&&!J,o%$==0&&(A.boost&&A.boost.copy?A.boost.copy():A.chart.boost&&A.chart.boost.copy&&A.chart.boost.copy())),!e},function(){const t=x.loadingDiv,o=x.loadingShown;L(),A.canvasToSVG(),e.timeRendering&&console.timeEnd("canvas rendering"),fireEvent(A,"renderedCanvas"),o&&(t.style.transition="opacity 250ms",t.opacity=0,x.loadingShown=!1,tt=setTimeout(function(){t.parentNode&&t.parentNode.removeChild(t),x.loadingDiv=x.loadingSpan=null},250)),delete A.buildKDTree,A.buildKDTree()},x.renderer.forExport?Number.MAX_VALUE:void 0)}}function A(t,o,e,i){t.moveTo(o,e),t.arc(o,e,i,0,2*Math.PI,!1)}function x(t,o,e,i){t.rect(o-i,e-i,2*i,2*i)}function S(){const n=this.chart,c=this.getContext(),l=this.chart.inverted,h=this.xAxis,p=this.yAxis;c?(this.points.forEach(t=>{let o=t.plotY,e;var i,s,r,a;void 0!==o&&!isNaN(o)&&null!==t.y&&c&&({x:i=0,y:s=0,width:r=0,height:a=0}=t.shapeArgs||{},e=n.styledMode?t.series.colorAttribs(t):t.series.pointAttribs(t),c.fillStyle=e.fill,l?c.fillRect(p.len-s+h.left,h.len-i+p.top,-a,-r):c.fillRect(i+h.left,s+p.top,r,a))}),this.canvasToSVG()):this.chart.showLoading("Your browser doesn't support HTML5 canvas, <br>please use a modern browser")}t.compose=function(t,o,e){if(pushUnique(h,t)&&Chart.prototype.callbacks.push(t=>{addEvent(t,"predraw",f),addEvent(t,"render",v)}),pushUnique(h,o)){const r=o.prototype;r.canvasToSVG=m,r.cvsLineTo=b,r.getContext=y,r.renderCanvas=C}var{area:t,bubble:o,column:e,heatmap:i,scatter:s}=e;if(t&&pushUnique(h,t)){const a=t.prototype;a.cvsDrawPoint=p,a.fill=!0,a.fillOpacity=!0,a.sampling=!0}if(o&&pushUnique(h,o)){const n=o.prototype;n.cvsMarkerCircle=d,n.cvsStrokeBatch=1}if(e&&pushUnique(h,e)){const c=e.prototype;c.cvsDrawPoint=u,c.fill=!0,c.sampling=!0}if(i&&pushUnique(h,i)&&(t=i.prototype,wrap(t,"drawPoints",S)),s&&pushUnique(h,s)){const l=s.prototype;l.cvsMarkerCircle=A,l.cvsMarkerSquare=x,l.fill=!0}}}(BoostCanvas=BoostCanvas||{});export default BoostCanvas;