"use strict";import A from"../../Core/Animation/AnimationUtilities.js";const animObject=A["animObject"];import Breadcrumbs from"../Breadcrumbs/Breadcrumbs.js";import Color from"../../Core/Color/Color.js";import H from"../../Core/Globals.js";const noop=H["noop"];import DrilldownDefaults from"./DrilldownDefaults.js";import DrilldownSeries from"./DrilldownSeries.js";import U from"../../Core/Utilities.js";const{addEvent,defined,diffObjects,extend,fireEvent,merge,objectEach,pick,pushUnique,removeEvent,syncTimeout}=U;let ddSeriesId=1;function axisDrilldownCategory(i,o){this.getDDPoints(i).forEach(function(e){e&&e.series&&e.series.visible&&e.runDrilldown&&e.runDrilldown(!0,i,o)}),this.chart.applyDrilldown()}function axisGetDDPoints(e){return this.ddPoints&&this.ddPoints[e]||[]}function createBreadcrumbsList(e){const t=[],i=e.drilldownLevels;return i&&i.length&&(t[0]||t.push({level:0,levelOptions:i[0].seriesOptions}),i.forEach(function(e,i){var o=t[t.length-1];e.levelNumber+1>o.level&&t.push({level:e.levelNumber+1,levelOptions:merge({name:e.lowerSeries.name},e.pointOptions)})})),t}class ChartAdditions{constructor(e){this.chart=e}addSeriesAsDrilldown(i,o){const t=this.chart||this;var e;if(t.mapView)if(i.series.isDrilling=!0,t.series.forEach(e=>{e.options.inactiveOtherPoints=!0,e.dataLabelsGroup?.destroy(),delete e.dataLabelsGroup}),t.options.drilldown&&!t.mapView.projection.hasGeoProjection&&DrilldownDefaults&&(e=diffObjects(t.options.drilldown,DrilldownDefaults),defined(e.mapZooming)||(t.options.drilldown.mapZooming=!1)),t.options.drilldown&&t.options.drilldown.animation&&t.options.drilldown.mapZooming){t.mapView.allowTransformAnimation=!0;const r=animObject(t.options.drilldown.animation);if("boolean"!=typeof r){const l=r.complete;r.complete=function(){l&&l.apply(this,arguments),function(e){e&&e.applyDrilldown&&t.mapView&&(t.addSingleSeriesAsDrilldown(i,o),t.applyDrilldown(),t.mapView.allowTransformAnimation=!1)}.apply(this,arguments)}}i.zoomTo(r)}else t.addSingleSeriesAsDrilldown(i,o),t.applyDrilldown();else t.addSingleSeriesAsDrilldown(i,o),t.applyDrilldown()}addSingleSeriesAsDrilldown(e,i){const o=this.chart||this,t=e.series,r=t.xAxis,l=t.yAxis,s=o.styledMode?{colorIndex:pick(e.colorIndex,t.colorIndex)}:{color:e.color||t.color},n=t.options._levelNumber||0,d=t.points.indexOf(e);o.drilldownLevels||(o.drilldownLevels=[]),i=extend(extend({_ddSeriesId:ddSeriesId++},s),i);let a=[],p=[],m;(m=o.drilldownLevels[o.drilldownLevels.length-1])&&m.levelNumber!==n&&(m=void 0),t.chart.series.forEach(e=>{e.xAxis===r&&(e.options._ddSeriesId=e.options._ddSeriesId||ddSeriesId++,e.options.colorIndex=e.colorIndex,e.options._levelNumber=e.options._levelNumber||n,m?(a=m.levelSeries,p=m.levelSeriesOptions):(a.push(e),e.purgedOptions=merge({_ddSeriesId:e.options._ddSeriesId,_levelNumber:e.options._levelNumber,selected:e.options.selected},e.userOptions),p.push(e.purgedOptions)))});const u=extend({levelNumber:n,seriesOptions:t.options,seriesPurgedOptions:t.purgedOptions,levelSeriesOptions:p,levelSeries:a,shapeArgs:e.shapeArgs,bBox:e.graphic?e.graphic.getBBox():{},color:e.isNull?Color.parse(s.color).setOpacity(0).get():s.color,lowerSeriesOptions:i,pointOptions:t.options.data[d],pointIndex:d,oldExtremes:{xMin:r&&r.userMin,xMax:r&&r.userMax,yMin:l&&l.userMin,yMax:l&&l.userMax},resetZoomButton:m&&m.levelNumber===n?void 0:o.resetZoomButton},s),c=(o.drilldownLevels.push(u),r&&r.names&&(r.names.length=0),u.lowerSeries=o.addSeries(i,!1));c.options._levelNumber=n+1,r&&(r.oldPos=r.pos,r.userMin=r.userMax=null,l.userMin=l.userMax=null),c.isDrilling=!0,t.type===c.type&&(c.animate=c.animateDrilldown||noop,c.options.animation=!0)}applyDrilldown(){const t=this.chart||this,e=t.drilldownLevels;let r;e&&0<e.length&&(r=e[e.length-1].levelNumber,t.hasCartesianSeries=e.some(e=>e.lowerSeries.isCartesian),(t.drilldownLevels||[]).forEach(o=>{t.mapView&&t.options.drilldown&&t.options.drilldown.mapZooming&&(t.redraw(),o.lowerSeries.isDrilling=!1,t.mapView.fitToBounds(o.lowerSeries.bounds),o.lowerSeries.isDrilling=!0),o.levelNumber===r&&o.levelSeries.forEach(i=>{if(t.mapView){if(i.options&&i.options._levelNumber===r&&i.group){let e={};t.options.drilldown&&(e=t.options.drilldown.animation),i.group.animate({opacity:0},e,()=>{i.remove(!1),o.levelSeries.filter(e=>Object.keys(e).length).length||(t.resetZoomButton&&(t.resetZoomButton.hide(),delete t.resetZoomButton),t.pointer.reset(),fireEvent(t,"afterDrilldown"),t.mapView&&(t.series.forEach(e=>{e.isDirtyData=!0,e.isDrilling=!1}),t.mapView.fitToBounds(void 0,void 0)),fireEvent(t,"afterApplyDrilldown"))})}}else i.options&&i.options._levelNumber===r&&i.remove(!1)})})),t.mapView||(t.resetZoomButton&&(t.resetZoomButton.hide(),delete t.resetZoomButton),t.pointer.reset(),fireEvent(t,"afterDrilldown"),t.hasCartesianSeries||t.axes.forEach(e=>{e.destroy(!0),e.init(t,merge(e.userOptions,e.options))}),t.redraw(),fireEvent(t,"afterApplyDrilldown"))}drillUp(e){const t=this.chart||this;if(!t.drilldownLevels||0===t.drilldownLevels.length)return;fireEvent(t,"beforeDrillUp");const r=t.drilldownLevels,l=r[r.length-1].levelNumber,s=t.series,n=t.drilldownLevels.length,d=e=>{e.remove(!1),t.series.forEach(e=>{e.colorAxis&&(e.isDirtyData=!0),e.options.inactiveOtherPoints=!1}),t.redraw()};let a=r.length,p,m,u;for(t.symbolCounter=t.colorCounter=0;a--;){let i,o;if((m=r[a]).levelNumber===l){if(r.pop(),!(i=m.lowerSeries).chart)for(p=s.length;p--;)if(s[p].options.id===m.lowerSeriesOptions.id&&s[p].options._levelNumber===l+1){i=s[p];break}i.xData=[],i.xAxis&&i.xAxis.names&&(0===n||a===n)&&(i.xAxis.names.length=0),m.levelSeriesOptions.forEach(e=>{e=((i,e)=>{let o;if(s.forEach(e=>{e.options._ddSeriesId===i._ddSeriesId&&(o=e)}),(o=o||t.addSeries(i,!1)).type===e.type&&o.animateDrillupTo&&(o.animate=o.animateDrillupTo),i===m.seriesPurgedOptions)return o})(e,i);e&&(o=e)}),fireEvent(t,"drillup",{seriesOptions:m.seriesPurgedOptions||m.seriesOptions}),o&&(o.type===i.type&&(o.drilldownLevel=m,o.options.animation=t.options.drilldown.animation,i.animateDrillupFrom&&i.chart&&i.animateDrillupFrom(m)),o.options._levelNumber=l);const h=i;var c,w;t.mapView||h.remove(!1),o&&o.xAxis&&(u=m.oldExtremes,o.xAxis.setExtremes(u.xMin,u.xMax,!1),o.yAxis.setExtremes(u.yMin,u.yMax,!1)),m.resetZoomButton&&(t.resetZoomButton=m.resetZoomButton),t.mapView?(c=m.levelNumber===l&&e,w=t.options.drilldown&&t.options.drilldown.animation&&t.options.drilldown.mapZooming,c?i.remove(!1):(i.dataLabelsGroup&&(i.dataLabelsGroup.destroy(),delete i.dataLabelsGroup),t.mapView&&o&&(w&&(i.isDrilling=!0,o.isDrilling=!0,t.redraw(!1),t.mapView.fitToBounds(i.bounds,void 0,!0,!1)),t.mapView.allowTransformAnimation=!0,fireEvent(t,"afterDrillUp",{seriesOptions:o?o.userOptions:void 0}),w?t.mapView.setView(void 0,1,!0,{complete:function(){Object.prototype.hasOwnProperty.call(this,"complete")&&d(i)}}):(t.mapView.allowTransformAnimation=!1,i.group?i.group.animate({opacity:0},t.options.drilldown.animation,()=>{d(i),t.mapView&&(t.mapView.allowTransformAnimation=!0)}):(d(i),t.mapView.allowTransformAnimation=!0)),o.isDrilling=!1,t.ddDupes&&(t.ddDupes.length=0),fireEvent(t,"drillupall")))):(fireEvent(t,"afterDrillUp"),t.redraw(),t.ddDupes&&(t.ddDupes.length=0),fireEvent(t,"drillupall"))}}}fadeInGroup(e){var i=this.chart,i=animObject(i.options.drilldown.animation);e&&(e.hide(),syncTimeout(()=>{e&&e.added&&e.fadeIn()},Math.max(i.duration-50,0)))}update(e,i){const o=this.chart;merge(!0,o.options.drilldown,e),pick(i,!0)&&o.redraw()}}var Drilldown;!function(e){const m=[];function u(e){const i=this.chart,o=this.getLevel()-e.newLevel;let t=1<o;for(let e=0;e<o;e++)e===o-1&&(t=!1),i.drillUp(t)}function c(){var e=this,i=e.options.drilldown,i=i&&i.breadcrumbs;e.breadcrumbs||(e.breadcrumbs=new Breadcrumbs(e,i)),e.breadcrumbs.updateProperties(createBreadcrumbsList(e))}function w(){this.breadcrumbs&&this.breadcrumbs.updateProperties(createBreadcrumbsList(this))}function h(){this.drilldown=new ChartAdditions(this)}function f(){this.resetZoomButton&&(this.resetZoomButton=this.resetZoomButton.destroy())}function v(){this.resetZoomButton&&this.showResetZoom()}function b(){(this.xAxis||[]).forEach(n=>{n.ddPoints={},n.series.forEach(t=>{var r,l=t.xData||[],s=t.points;for(let e=0,i=l.length,o;e<i;e++)"number"!=typeof(o=t.options.data[e])&&t.pointClass.prototype.optionsToObject.call({series:t},o).drilldown&&(n.ddPoints[l[e]]||(n.ddPoints[l[e]]=[]),r=e-(t.cropStart||0),n.ddPoints[l[e]].push(!(s&&0<=r&&r<s.length)||s[r]))}),objectEach(n.ticks,e=>e.drillable())})}function D(e){const i=this.breadcrumbs,o=e.options.drilldown&&e.options.drilldown.breadcrumbs;i&&o&&i.update(o)}function g(e){this.attr({opacity:.1,visibility:"inherit"}).animate({opacity:pick(this.newOpacity,1)},e||{duration:250})}function y(){const i=this.pos,e=this.label,o=this.axis,t="xAxis"===o.coll&&o.getDDPoints,r=t&&o.getDDPoints(i),l=o.chart.styledMode;t&&(e&&r&&r.length?(e.drillable=!0,e.basicStyles||l||(e.basicStyles=merge(e.styles)),e.addClass("highcharts-drilldown-axis-label"),e.removeOnDrillableClick&&removeEvent(e.element,"click"),e.removeOnDrillableClick=addEvent(e.element,"click",function(e){e.preventDefault(),o.drilldownCategory(i,e)}),!l&&o.chart.options.drilldown&&e.css(o.chart.options.drilldown.activeAxisLabelStyle||{})):e&&e.drillable&&e.removeOnDrillableClick&&(l||(e.styles={},e.element.removeAttribute("style"),e.css(e.basicStyles)),e.removeOnDrillableClick(),e.removeClass("highcharts-drilldown-axis-label")))}e.compose=function(e,i,o,t,r,l,s){if(l=l.prototype.Element,DrilldownSeries.compose(t,r),pushUnique(m,e)){const n=e.prototype;n.drilldownCategory=axisDrilldownCategory,n.getDDPoints=axisGetDDPoints}if(pushUnique(m,Breadcrumbs)&&(Breadcrumbs.compose(i,o),addEvent(Breadcrumbs,"up",u)),pushUnique(m,i)){t=i,r=ChartAdditions.prototype;const d=t.prototype;d.addSeriesAsDrilldown=r.addSeriesAsDrilldown,d.addSingleSeriesAsDrilldown=r.addSingleSeriesAsDrilldown,d.applyDrilldown=r.applyDrilldown,d.drillUp=r.drillUp,addEvent(t,"afterDrilldown",c),addEvent(t,"afterDrillUp",w),addEvent(t,"afterInit",h),addEvent(t,"drillup",f),addEvent(t,"drillupall",v),addEvent(t,"render",b),addEvent(t,"update",D)}if(pushUnique(m,o)&&(o.drilldown=DrilldownDefaults),pushUnique(m,l)){const a=l.prototype;a.fadeIn=g}if(pushUnique(m,s)){const p=s.prototype;p.drillable=y}}}(Drilldown=Drilldown||{});export default Drilldown;