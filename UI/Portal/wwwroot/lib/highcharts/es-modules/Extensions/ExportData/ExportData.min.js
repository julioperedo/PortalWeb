"use strict";import AST from"../../Core/Renderer/HTML/AST.js";import ExportDataDefaults from"./ExportDataDefaults.js";import H from"../../Core/Globals.js";const{doc,win}=H;import D from"../../Core/Defaults.js";const{getOptions,setOptions}=D;import DownloadURL from"../DownloadURL.js";const downloadURL=DownloadURL["downloadURL"];import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";const{series:SeriesClass,seriesTypes:{arearange:AreaRangeSeries,gantt:GanttSeries,map:MapSeries,mapbubble:MapBubbleSeries,treemap:TreemapSeries,xrange:XRangeSeries}}=SeriesRegistry;import U from"../../Core/Utilities.js";const{addEvent,defined,extend,find,fireEvent,isNumber,pick}=U,composedMembers=[];function chartDownloadCSV(){var e=this.getCSV(!0);downloadURL(getBlobFromContent(e,"text/csv")||"data:text/csv,\ufeff"+encodeURIComponent(e),this.getFilename()+".csv")}function chartDownloadXLS(){var e='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head>\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Ark1</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\x3e<style>td{border:none;font-family: Calibri, sans-serif;} .number{mso-number-format:"0.00";} .text{ mso-number-format:"@";}</style><meta name=ProgId content=Excel.Sheet><meta charset=UTF-8></head><body>'+this.getTable(!0)+"</body></html>";downloadURL(getBlobFromContent(e,"application/vnd.ms-excel")||"data:application/vnd.ms-excel;base64,"+(e=e,win.btoa(unescape(encodeURIComponent(e)))),this.getFilename()+".xls")}function chartGetCSV(e){let n="";const i=this.getDataRows(),t=this.options.exporting.csv,s=pick(t.decimalPoint,","!==t.itemDelimiter&&e?1.1.toLocaleString()[1]:"."),r=pick(t.itemDelimiter,","===s?";":","),l=t.lineDelimiter;return i.forEach((e,t)=>{let a="",o=e.length;for(;o--;)"number"==typeof(a="string"==typeof(a=e[o])?`"${a}"`:a)&&"."!==s&&(a=a.toString().replace(".",s)),e[o]=a;e.length=i.length?i[0].length:0,n+=e.join(r),t<i.length-1&&(n+=l)}),n}function chartGetDataRows(n){function i(e,t,a){if(D.columnHeaderFormatter){var o=D.columnHeaderFormatter(e,t,a);if(!1!==o)return o}return e?e instanceof SeriesClass?n?{columnTitle:1<a?t:e.name,topLevelColumnTitle:e.name}:e.name+(1<a?" ("+t+")":""):e.options.title&&e.options.title.text||(e.dateTime?c:l):l}function x(a,e,o){const n={},i={};return e.forEach(function(e){var t=(a.keyToAxis&&a.keyToAxis[e]||e)+"Axis",t=isNumber(o)?a.chart[t][o]:a[t];n[e]=t&&t.categories||[],i[e]=t&&t.dateTime}),{categoryMap:n,dateTimeValueAxisMap:i}}const b=this.hasParallelCoordinates,T=this.time,D=this.options.exporting&&this.options.exporting.csv||{},s=this.xAxis,S={},e=[],r=[],w=[],t=this.options.lang,a=t.exportData,l=a.categoryHeader,c=a.categoryDatetimeHeader,y=[];let o,h,v,C=0,p,d;for(p in this.series.forEach(function(l){const e=l.options.keys,c=l.xAxis,h=e||(a=c,o=(t=l).pointArrayMap||["y"],t.data.some(e=>void 0!==e.y&&e.name)&&a&&!a.categories&&"name"!==t.exportKey?["x",...o]:o),p=h.length,d=!l.requireSorting&&{},m=s.indexOf(c);var t,a,o;let u=x(l,h),g,f;if(!1!==l.options.includeInDataExport&&!l.options.isInternal&&!1!==l.visible){for(find(y,function(e){return e[0]===m})||y.push([m,C]),f=0;f<p;)v=i(l,h[f],h.length),w.push(v.columnTitle||v),n&&r.push(v.topLevelColumnTitle||v),f++;g={chart:l.chart,autoIncrement:l.autoIncrement,options:l.options,pointArrayMap:l.pointArrayMap,index:l.index};l.options.data.forEach(function(e,t){var a={series:g};let o,n,i;b&&(u=x(l,h,t)),l.pointClass.prototype.applyOptions.apply(a,[e]);e=l.data[t]&&l.data[t].name;if(o=(a.x??"")+","+e,f=0,(!c||"name"===l.exportKey||!b&&c&&c.hasNames&&e)&&(o=e),d&&(d[o]&&(o+="|"+t),d[o]=!0),S[o]){var t=o+","+S[o].pointers[l.index],s=o;S[o].pointers[l.index]&&(S[t]||(S[t]=[],S[t].xValues=[],S[t].pointers=[]),o=t),S[s].pointers[l.index]+=1}else{S[o]=[],S[o].xValues=[];const r=[];for(let e=0;e<l.chart.series.length;e++)r[e]=0;S[o].pointers=r,S[o].pointers[l.index]=1}for(S[o].x=a.x,S[o].name=e,S[o].xValues[m]=a.x;f<p;)i=a[n=h[f]],S[o][C+f]=pick(u.categoryMap[n][i],u.dateTimeValueAxisMap[n]?T.dateFormat(D.dateFormat,i):null,i),f++}),C+=f}}),S)Object.hasOwnProperty.call(S,p)&&e.push(S[p]);let m,u;for(h=n?[r,w]:[w],C=y.length;C--;)m=y[C][0],u=y[C][1],o=s[m],e.sort(function(e,t){return e.xValues[m]-t.xValues[m]}),d=i(o),h[0].splice(u,0,d),n&&h[1]&&h[1].splice(u,0,d),e.forEach(function(e){let t=e.name;o&&!defined(t)&&(t=o.dateTime?(e.x instanceof Date&&(e.x=e.x.getTime()),T.dateFormat(D.dateFormat,e.x)):o.categories?pick(o.names[e.x],o.categories[e.x],e.x):e.x),e.splice(u,0,t)});return h=h.concat(e),fireEvent(this,"exportData",{dataRows:h}),h}function chartGetTable(e){const t=e=>{if(!e.tagName||"#text"===e.tagName)return e.textContent||"";const a=e.attributes;let o="<"+e.tagName;return a&&Object.keys(a).forEach(e=>{var t=a[e];o+=` ${e}="${t}"`}),o=(o+=">")+(e.textContent||""),(e.children||[]).forEach(e=>{o+=t(e)}),o+=`</${e.tagName}>`};e=this.getTableAST(e);return t(e)}function chartGetTableAST(e){let o=0;const t=[],d=this.options,s=e?1.1.toLocaleString()[1]:".",m=pick(d.exporting.useMultiLevelHeaders,!0),a=this.getDataRows(m),n=m?a.shift():null,i=a.shift(),u=function(e,t){let a=e.length;if(t.length!==a)return!1;for(;a--;)if(e[a]!==t[a])return!1;return!0},g=function(e,t,a,o){let n=pick(o,""),i="highcharts-text"+(t?" "+t:"");return"number"==typeof n?(n=n.toString(),","===s&&(n=n.replace(".",s)),i="highcharts-number"):o||(i="highcharts-empty"),{tagName:e,attributes:a=extend({class:i},a),textContent:n}};!1!==d.exporting.tableCaption&&t.push({tagName:"caption",attributes:{class:"highcharts-table-caption"},textContent:pick(d.exporting.tableCaption,d.title.text||"Chart")});for(let e=0,t=a.length;e<t;++e)a[e].length>o&&(o=a[e].length);t.push(function(e,t,a){const o=[];let n=0,i=a||t&&t.length,s,r=0,l;if(m&&e&&t&&!u(e,t)){const c=[];for(;n<i;++n)if((s=e[n])===e[n+1])++r;else if(r)c.push(g("th","highcharts-table-topheading",{scope:"col",colspan:r+1},s)),r=0;else{s===t[n]?d.exporting.useRowspanHeaders?(l=2,delete t[n]):(l=1,t[n]=""):l=1;const h=g("th","highcharts-table-topheading",{scope:"col"},s);1<l&&h.attributes&&(h.attributes.valign="top",h.attributes.rowspan=l),c.push(h)}o.push({tagName:"tr",children:c})}if(t){const p=[];for(n=0,i=t.length;n<i;++n)void 0!==t[n]&&p.push(g("th",null,{scope:"col"},t[n]));o.push({tagName:"tr",children:p})}return{tagName:"thead",children:o}}(n,i,Math.max(o,i.length)));const r=[];a.forEach(function(t){const a=[];for(let e=0;e<o;e++)a.push(g(e?"td":"th",null,e?{}:{scope:"row"},t[e]));r.push({tagName:"tr",children:a})}),t.push({tagName:"tbody",children:r});e={tree:{tagName:"table",id:"highcharts-data-table-"+this.index,children:t}};return fireEvent(this,"aftergetTableAST",e),e.tree}function chartHideData(){this.toggleDataTable(!1)}function chartToggleDataTable(e){var t=(e=pick(e,!this.isDataTableVisible))&&!this.dataTableDiv;if(t&&(this.dataTableDiv=doc.createElement("div"),this.dataTableDiv.className="highcharts-data-table",this.renderTo.parentNode.insertBefore(this.dataTableDiv,this.renderTo.nextSibling)),this.dataTableDiv){const s=this.dataTableDiv.style,r=s.display;if(s.display=e?"block":"none",e){this.dataTableDiv.innerHTML=AST.emptyHTML;const l=new AST([this.getTableAST()]);l.addToDOM(this.dataTableDiv),fireEvent(this,"afterViewData",{element:this.dataTableDiv,wasHidden:t||r!==s.display})}else fireEvent(this,"afterHideData")}this.isDataTableVisible=e;const a=this.exportDivElements,o=this.options.exporting,n=o&&o.buttons&&o.buttons.contextButton.menuItems,i=this.options.lang;o&&o.menuItemDefinitions&&i&&i.viewData&&i.hideData&&n&&a&&((t=a[n.indexOf("viewData")])&&AST.setElementHTML(t,this.isDataTableVisible?i.hideData:i.viewData))}function chartViewData(){this.toggleDataTable(!0)}function compose(e){if(U.pushUnique(composedMembers,e)){addEvent(e,"afterViewData",onChartAfterViewData),addEvent(e,"render",onChartRenderer);const t=e.prototype;t.downloadCSV=chartDownloadCSV,t.downloadXLS=chartDownloadXLS,t.getCSV=chartGetCSV,t.getDataRows=chartGetDataRows,t.getTable=chartGetTable,t.getTableAST=chartGetTableAST,t.hideData=chartHideData,t.toggleDataTable=chartToggleDataTable,t.viewData=chartViewData}if(U.pushUnique(composedMembers,setOptions)){const a=getOptions().exporting;a&&(extend(a.menuItemDefinitions,{downloadCSV:{textKey:"downloadCSV",onclick:function(){this.downloadCSV()}},downloadXLS:{textKey:"downloadXLS",onclick:function(){this.downloadXLS()}},viewData:{textKey:"viewData",onclick:function(){this.toggleDataTable()}}}),a.buttons&&a.buttons.contextButton.menuItems&&a.buttons.contextButton.menuItems.push("separator","downloadCSV","downloadXLS","viewData")),setOptions(ExportDataDefaults)}AreaRangeSeries&&U.pushUnique(composedMembers,AreaRangeSeries)&&(AreaRangeSeries.prototype.keyToAxis={low:"y",high:"y"}),GanttSeries&&U.pushUnique(composedMembers,GanttSeries)&&(GanttSeries.prototype.exportKey="name",GanttSeries.prototype.keyToAxis={start:"x",end:"x"}),XRangeSeries&&U.pushUnique(composedMembers,XRangeSeries)&&(XRangeSeries.prototype.keyToAxis={x2:"x"}),MapSeries&&U.pushUnique(composedMembers,MapSeries)&&(MapSeries.prototype.exportKey="name"),MapBubbleSeries&&U.pushUnique(composedMembers,MapBubbleSeries)&&(MapBubbleSeries.prototype.exportKey="name"),TreemapSeries&&U.pushUnique(composedMembers,TreemapSeries)&&(TreemapSeries.prototype.exportKey="name")}function getBlobFromContent(e,t){const a=win.navigator,o=win.URL||win.webkitURL||win;try{if(a.msSaveOrOpenBlob&&win.MSBlobBuilder){const n=new win.MSBlobBuilder;return n.append(e),n.getBlob("image/svg+xml")}return o.createObjectURL(new win.Blob(["\ufeff"+e],{type:t}))}catch(e){}}function onChartAfterViewData(){const n=this,i=n.dataTableDiv,s=(e,t)=>e.children[t].textContent,r=(o,n)=>(e,t)=>{var a;return a=s(n?e:t,o),t=s(n?t:e,o),""===a||""===t||isNaN(a)||isNaN(t)?a.toString().localeCompare(t):a-t};if(i&&n.options.exporting&&n.options.exporting.allowTableSorting){const e=i.querySelector("thead tr");e&&e.childNodes.forEach(a=>{const o=a.closest("table");a.addEventListener("click",function(){const e=[...i.querySelectorAll("tr:not(thead tr)")],t=[...a.parentNode.children];e.sort(r(t.indexOf(a),n.ascendingOrderInTable=!n.ascendingOrderInTable)).forEach(e=>{o.appendChild(e)}),t.forEach(t=>{["highcharts-sort-ascending","highcharts-sort-descending"].forEach(e=>{t.classList.contains(e)&&t.classList.remove(e)})}),a.classList.add(n.ascendingOrderInTable?"highcharts-sort-ascending":"highcharts-sort-descending")})})}}function onChartRenderer(){this.options&&this.options.exporting&&this.options.exporting.showTable&&!this.options.chart.forExport&&this.viewData()}const ExportData={compose:compose};export default ExportData;