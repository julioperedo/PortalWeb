"use strict";import U from"../Core/Utilities.js";const{addEvent,fireEvent,isNumber,objectEach,pick,pushUnique}=U,composedMembers=[];function chartHideOverlappingLabels(a){const e=this,i=a.length,c=e.renderer;let t,l,n,o,r,s=!1;for(let e=0;e<i;e++)(t=a[e])&&(t.oldOpacity=t.opacity,t.newOpacity=1,t.absoluteBox=(e=>{var t=!e.box&&e.padding||0;let a,i,l,n=0,o=0,r,s;if(e&&(!e.alignAttr||e.placed))return a=e.alignAttr||{x:e.attr("x"),y:e.attr("y")},i=e.parentGroup,e.width||(l=e.getBBox(),e.width=l.width,e.height=l.height,n=c.fontMetrics(e.element).h),r=e.width-2*t,(s={left:"0",center:"0.5",right:"1"}[e.alignValue])?o=+s*r:isNumber(e.x)&&Math.round(e.x)!==e.translateX&&(o=e.x-(e.translateX||0)),{x:a.x+(i.translateX||0)+t-(o||0),y:a.y+(i.translateY||0)+t-n,width:e.width-2*t,height:(e.height||0)-2*t}})(t));a.sort((e,t)=>(t.labelrank||0)-(e.labelrank||0));for(let t=0;t<i;++t){o=(l=a[t])&&l.absoluteBox;for(let e=t+1;e<i;++e)n=a[e],r=n&&n.absoluteBox,o&&r&&l!==n&&0!==l.newOpacity&&0!==n.newOpacity&&"hidden"!==l.visibility&&"hidden"!==n.visibility&&(h=o,(p=r).x>=h.x+h.width||p.x+p.width<=h.x||p.y>=h.y+h.height||p.y+p.height<=h.y||((l.labelrank<n.labelrank?l:n).newOpacity=0))}var h,p;for(const t of a)hideOrShow(t,e)&&(s=!0);s&&fireEvent(e,"afterHideAllOverlappingLabels")}function compose(e){if(pushUnique(composedMembers,e)){const t=e.prototype;t.hideOverlappingLabels=chartHideOverlappingLabels,addEvent(e,"render",onChartRender)}}function hideOrShow(e,t){let a,i,l=!1;return e&&(i=e.newOpacity,e.oldOpacity!==i&&(e.alignAttr&&e.placed?(e[i?"removeClass":"addClass"]("highcharts-data-label-hidden"),a=function(){t.styledMode||e.css({pointerEvents:i?"auto":"none"})},l=!0,e.alignAttr.opacity=i,e[e.isOld?"animate":"attr"](e.alignAttr,null,a),fireEvent(t,"afterHideOverlappingLabel")):e.attr({opacity:i})),e.isOld=!0),l}function onChartRender(){const i=this;let l=[];for(const t of i.labelCollectors||[])l=l.concat(t());for(const a of i.yAxis||[])a.stacking&&a.options.stackLabels&&!a.options.stackLabels.allowOverlap&&objectEach(a.stacking.stacks,e=>{objectEach(e,e=>{e.label&&l.push(e.label)})});for(const n of i.series||[]){var e;n.visible&&n.hasDataLabels?.()&&((e=e=>{for(const a of e)a.visible&&(a.dataLabels||[]).forEach(e=>{var t=e.options||{};e.labelrank=pick(t.labelrank,a.labelrank,a.shapeArgs?.height),t.allowOverlap??0<Number(t.distance)?(e.oldOpacity=e.opacity,e.newOpacity=1,hideOrShow(e,i)):l.push(e)})})(n.nodes||[]),e(n.points))}this.hideOverlappingLabels(l)}const OverlappingDataLabels={compose:compose};export default OverlappingDataLabels;