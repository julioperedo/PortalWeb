"use strict";import BoostableMap from"./BoostableMap.js";import Boostables from"./Boostables.js";import BoostChart from"./BoostChart.js";const{getBoostClipRect,isChartSeriesBoosting}=BoostChart;import D from"../../Core/Defaults.js";const getOptions=D["getOptions"];import H from"../../Core/Globals.js";const{doc,noop,win}=H;import U from"../../Core/Utilities.js";const{addEvent,error,extend,fireEvent,isArray,isNumber,pick,wrap,defined}=U;import WGLRenderer from"./WGLRenderer.js";const CHUNK_SIZE=3e3,composedMembers=[];let index,mainCanvas;function allocateIfNotSeriesBoosting(t,e){var o=e.boost;t&&o&&o.target&&o.canvas&&!isChartSeriesBoosting(e.chart)&&t.allocateBufferForSingleSeries(e)}function boostEnabled(t){return pick(t&&t.options&&t.options.boost&&t.options.boost.enabled,!0)}function compose(t,o,e){if(U.pushUnique(composedMembers,t)){addEvent(t,"destroy",onSeriesDestroy),addEvent(t,"hide",onSeriesHide);const s=t.prototype;e&&(s.renderCanvas=seriesRenderCanvas),wrap(s,"getExtremes",wrapSeriesGetExtremes),wrap(s,"processData",wrapSeriesProcessData),wrap(s,"searchPoint",wrapSeriesSearchPoint),["translate","generatePoints","drawTracker","drawPoints","render"].forEach(t=>wrapSeriesFunctions(s,o,t))}if(U.pushUnique(composedMembers,getOptions)){const r=getOptions().plotOptions;Boostables.forEach(t=>{const e=r[t];e&&(e.boostThreshold=5e3,e.boostData=[],o[t].prototype.fillOpacity=!0)})}if(e){const{area:i,areaspline:a,bubble:n,column:c,heatmap:p,scatter:h,treemap:l}=o;if(i&&U.pushUnique(composedMembers,i)&&extend(i.prototype,{fill:!0,fillOpacity:!0,sampling:!0}),a&&U.pushUnique(composedMembers,a)&&extend(a.prototype,{fill:!0,fillOpacity:!0,sampling:!0}),n&&U.pushUnique(composedMembers,n)){const d=n.prototype;delete d.buildKDTree,wrap(d,"markerAttribs",function(t){return!this.boosted&&t.apply(this,[].slice.call(arguments,1))})}c&&U.pushUnique(composedMembers,c)&&extend(c.prototype,{fill:!0,sampling:!0}),h&&U.pushUnique(composedMembers,h)&&(h.prototype.fill=!0),[p,l].forEach(t=>{t&&U.pushUnique(composedMembers,t)&&wrap(t.prototype,"drawPoints",wrapSeriesDrawPoints)})}return t}function createAndAttachRenderer(t,e){const o=t.constructor,s=t.seriesGroup||e.group;let r=t.chartWidth,i=t.chartHeight,a=t;const n=(a=isChartSeriesBoosting(t)?t:e).boost=a.boost||{};return mainCanvas=mainCanvas||doc.createElement("canvas"),n.target||(n.canvas=mainCanvas,t.renderer.forExport,a.renderTarget=n.target=t.renderer.image("",0,0,r,i).addClass("highcharts-boost-canvas").add(s),n.clear=function(){n.target.attr({href:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="})},n.copy=function(){n.resize(),n.target.attr({href:n.canvas.toDataURL("image/png")})},n.resize=function(){r=t.chartWidth,i=t.chartHeight,(n.targetFo||n.target).attr({x:0,y:0,width:r,height:i}).css({pointerEvents:"none",mixedBlendMode:"normal",opacity:1}),a instanceof o&&a.boost.markerGroup.translate(t.plotLeft,t.plotTop)},n.clipRect=t.renderer.clipRect(),(n.targetFo||n.target).attr({zIndex:e.options.zIndex}).clip(n.clipRect),a instanceof o&&(a.boost.markerGroup=a.renderer.g().add(s).translate(e.xAxis.pos,e.yAxis.pos))),n.canvas.width=r,n.canvas.height=i,n.clipRect&&n.clipRect.attr(getBoostClipRect(t,a)),n.resize(),n.clear(),n.wgl||(n.wgl=new WGLRenderer(t=>{t.settings.debug.timeBufferCopy&&console.time("buffer copy"),n.copy(),t.settings.debug.timeBufferCopy&&console.timeEnd("buffer copy")}),n.wgl.init(n.canvas)||error("[highcharts boost] - unable to init WebGL renderer"),n.wgl.setOptions(t.options.boost||{}),a instanceof o&&n.wgl.allocateBuffer(t)),n.wgl.setSize(r,i),n.wgl}function destroyGraphics(o){var s=o.points;if(s){let t,e;for(e=0;e<s.length;e+=1)(t=s[e])&&t.destroyElements&&t.destroyElements()}["graph","area","tracker"].forEach(t=>{const e=o[t];e&&(o[t]=e.destroy())});const r=o;if(r.getZonesGraphs){const t=r.getZonesGraphs([["graph","highcharts-graph"]]);t.forEach(t=>{const e=r[t[0]];e&&(r[t[0]]=e.destroy())})}}function eachAsync(t,e,o,s,r,i){r=r||0,s=s||CHUNK_SIZE;var a=r+s;let n=!0;for(;n&&r<a&&r<t.length;)n=e(t[r],r),++r;n&&(r<t.length?i?eachAsync(t,e,o,s,r,i):win.requestAnimationFrame?win.requestAnimationFrame(function(){eachAsync(t,e,o,s,r)}):setTimeout(eachAsync,0,t,e,o,s,r):o&&o())}function enterBoost(e){e.boost=e.boost||{getPoint:t=>getPoint(e,t)};const o=e.boost.altered=[];["allowDG","directTouch","stickyTracking"].forEach(t=>{o.push({prop:t,val:e[t],own:Object.hasOwnProperty.call(e,t)})}),e.allowDG=!1,e.directTouch=!1,e.stickyTracking=!0,e.finishedAnimating=!0,e.labelBySeries&&(e.labelBySeries=e.labelBySeries.destroy())}function exitBoost(e){const t=e.boost;t&&((t.altered||[]).forEach(t=>{t.own?e[t.prop]=t.val:delete e[t.prop]}),t.clear&&t.clear())}function hasExtremes(t,e){var o=t.options,s=o.data,r=t.xAxis&&t.xAxis.options,i=t.yAxis&&t.yAxis.options,t=t.colorAxis&&t.colorAxis.options;return s.length>(o.boostThreshold||Number.MAX_VALUE)&&isNumber(i.min)&&isNumber(i.max)&&(!e||isNumber(r.min)&&isNumber(r.max))&&(!t||isNumber(t.min)&&isNumber(t.max))}function onSeriesDestroy(){const e=this,t=e.chart;t.boost&&t.boost.markerGroup===e.markerGroup&&(e.markerGroup=null),t.hoverPoints&&(t.hoverPoints=t.hoverPoints.filter(function(t){return t.series===e})),t.hoverPoint&&t.hoverPoint.series===e&&(t.hoverPoint=null)}function onSeriesHide(){const t=this.boost;t&&t.canvas&&t.target&&(t.wgl&&t.wgl.clear(),t.clear&&t.clear())}function renderIfNotSeriesBoosting(t){const e=t.boost;e&&e.canvas&&e.target&&e.wgl&&!isChartSeriesBoosting(t.chart)&&e.wgl.render(t.chart)}function getPoint(t,e){const o=t.options,s=t.xAxis,r=t.pointClass;if(e instanceof r)return e;const i=t.xData||o.xData||t.processedXData||!1,a=(new r).init(t,t.options.data[e.i],i?i[e.i]:void 0);return a.category=pick(s.categories?s.categories[a.x]:a.x,a.x),a.dist=e.dist,a.distX=e.distX,a.plotX=e.plotX,a.plotY=e.plotY,a.index=e.i,a.percentage=e.percentage,a.isInside=t.isPointInside(a),a}function seriesRenderCanvas(){const t=this.options||{},h=this.chart,l=this.xAxis,d=this.yAxis,e=t.xData||this.processedXData,u=t.yData||this.processedYData,o=t.data,s=l.getExtremes(),m=s.min,g=s.max,r=d.getExtremes(),b=r.min,f=r.max,a={},y=!!this.sampling,n=t.enableMouseTracking,i=t.threshold,A=this.pointArrayMap&&"low,high"===this.pointArrayMap.join(","),x=!!t.stacking,c=this.cropStart||0,v=this.requireSorting,w=!e,S="x"===t.findNearestPointBy,p=this.xData||this.options.xData||this.processedXData||!1;let B=!1,E,C=d.getThreshold(i),k,G,D,P;if(B=createAndAttachRenderer(h,this),h.boosted=!0,this.visible){(this.points||this.graph)&&destroyGraphics(this),isChartSeriesBoosting(h)?(this.markerGroup&&this.markerGroup!==h.boost.markerGroup&&this.markerGroup.destroy(),this.markerGroup=h.boost.markerGroup,this.boost&&this.boost.target&&(this.renderTarget=this.boost.target=this.boost.target.destroy())):(h.boost&&this.markerGroup===h.boost.markerGroup&&(this.markerGroup=void 0),this.markerGroup=this.plotGroup("markerGroup","markers",!0,1,h.seriesGroup));const U=this.points=[],M=(t,e,o,s)=>{const r=!!p&&p[c+o],i=t=>{h.inverted&&(t=l.len-t,e=d.len-e),U.push({destroy:noop,x:r,clientX:t,plotX:t,plotY:e,i:c+o,percentage:s})};t=Math.ceil(t),index=S?t:t+","+e,n&&(a[index]?r===p[p.length-1]&&(U.length--,i(t)):(a[index]=!0,i(t)))},N=(this.buildKDTree=noop,B&&(allocateIfNotSeriesBoosting(B,this),B.pushSeries(this),renderIfNotSeriesBoosting(this)),B.settings),T=()=>{fireEvent(this,"renderedCanvas"),delete this.buildKDTree,this.buildKDTree(),N.debug.timeKDTree&&console.timeEnd("kd tree building")};h.renderer.forExport||(N.debug.timeKDTree&&console.time("kd tree building"),eachAsync(x?this.data:e||o,function(t,e){var o=void 0===h.index;let s,r,i,a,n,c=!1,p=!0;return!defined(t)||(o||(r=w?(s=t[0],t[1]):(s=t,u[e]),A?(w&&(r=t.slice(1,3)),c=r[0],r=r[1]):x&&(s=t.x,r=t.stackY,c=r-t.y,n=t.percentage),v||(p=(r||0)>=b&&r<=f),null!==r&&s>=m&&s<=g&&p&&(i=l.toPixels(s,!0),y?(void 0!==D&&i!==E||(A||(c=r),(void 0===P||r>G)&&(G=r,P=e),(void 0===D||c<k)&&(k=c,D=e)),S&&i===E||(void 0!==D&&(a=d.toPixels(G,!0),C=d.toPixels(k,!0),M(i,a,P,n),C!==a&&M(i,C,D,n)),D=P=void 0,E=i)):(a=Math.ceil(d.toPixels(r,!0)),M(i,a,e,n)))),!o)},T))}}function wrapSeriesDrawPoints(t){let e=!0;if(!(e=this.chart.options&&this.chart.options.boost?void 0===this.chart.options.boost.enabled||this.chart.options.boost.enabled:e)||!this.boosted)return t.call(this);this.chart.boosted=!0;const o=createAndAttachRenderer(this.chart,this);o&&(allocateIfNotSeriesBoosting(o,this),o.pushSeries(this)),renderIfNotSeriesBoosting(this)}function wrapSeriesFunctions(t,e,o){function s(t){var e=this.options.stacking&&("translate"===o||"generatePoints"===o);this.boosted&&!e&&boostEnabled(this.chart)&&"heatmap"!==this.type&&"treemap"!==this.type&&BoostableMap[this.type]&&0!==this.options.boostThreshold?"render"===o&&this.renderCanvas&&this.renderCanvas():t.call(this)}wrap(t,o,s),"translate"===o&&["column","arearange","columnrange","heatmap","treemap"].forEach(function(t){e[t]&&wrap(e[t].prototype,o,s)})}function wrapSeriesGetExtremes(t){return this.boosted&&hasExtremes(this)?{}:t.apply(this,[].slice.call(arguments,1))}function wrapSeriesProcessData(t){let e=this.options.data;var o,s=t=>{return!this.forceCrop&&(isChartSeriesBoosting(this.chart)||(t?t.length:0)>=(this.options.boostThreshold||Number.MAX_VALUE))};boostEnabled(this.chart)&&BoostableMap[this.type]?(o=this,s(e)&&"heatmap"!==o.type&&"treemap"!==o.type&&!o.options.stacking&&hasExtremes(o,!0)||(t.apply(o,[].slice.call(arguments,1)),e=o.processedXData),o.boosted=s(e),o.boosted?(o.options.data&&o.options.data.length&&(s=o.getFirstValidPoint(o.options.data),isNumber(s)||isArray(s)||error(12,!1,o.chart)),enterBoost(o)):exitBoost(o)):t.apply(this,[].slice.call(arguments,1))}function wrapSeriesSearchPoint(t){t=t.apply(this,[].slice.call(arguments,1));return this.boost&&t?this.boost.getPoint(t):t}const BoostSeries={compose:compose,destroyGraphics:destroyGraphics,eachAsync:eachAsync,getPoint:getPoint};export default BoostSeries;