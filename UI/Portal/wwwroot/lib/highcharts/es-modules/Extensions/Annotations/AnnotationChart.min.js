"use strict";import U from"../../Core/Utilities.js";const{addEvent,erase,find,fireEvent,pick,wrap}=U,composedMembers=[];function chartAddAnnotation(t,o){const n=this.initAnnotation(t);return this.options.annotations.push(n.options),pick(o,!0)&&(n.redraw(),n.graphic.attr({opacity:1})),n}function chartCallback(){const r=this;r.plotBoxClip=this.renderer.clipRect(this.plotBox),r.controlPointsGroup=r.renderer.g("control-points").attr({zIndex:99}).clip(r.plotBoxClip).add(),r.options.annotations.forEach((o,t)=>{var n;r.annotations.some(t=>t.options===o)||(n=r.initAnnotation(o),r.options.annotations[t]=n.options)}),r.drawAnnotations(),addEvent(r,"redraw",r.drawAnnotations),addEvent(r,"destroy",function(){r.plotBoxClip.destroy(),r.controlPointsGroup.destroy()}),addEvent(r,"exportData",function(c){const t=r.annotations,n=(this.options.exporting&&this.options.exporting.csv||{}).columnHeaderFormatter,a=!c.dataRows[1].xValues,i=r.options.lang&&r.options.lang.exportData&&r.options.lang.exportData.annotationHeader,l=c.dataRows[0].length,h=r.options.exporting&&r.options.exporting.csv&&r.options.exporting.csv.annotations&&r.options.exporting.csv.annotations.itemDelimiter,d=r.options.exporting&&r.options.exporting.csv&&r.options.exporting.csv.annotations&&r.options.exporting.csv.annotations.join;t.forEach(t=>{t.options.labelOptions&&t.options.labelOptions.includeInDataExport&&t.labels.forEach(t=>{if(t.options.text){const p=t.options.text;t.points.forEach(t=>{const o=t.x,n=t.series.xAxis?t.series.xAxis.index:-1;let a=!1;if(-1===n){const i=c.dataRows[0].length,s=new Array(i);for(let t=0;t<i;++t)s[t]="";s.push(p),s.xValues=[],s.xValues[n]=o,c.dataRows.push(s),a=!0}if(a||c.dataRows.forEach(t=>{!a&&t.xValues&&void 0!==n&&o===t.xValues[n]&&(d&&t.length>l?t[t.length-1]+=h+p:t.push(p),a=!0)}),!a){const e=c.dataRows[0].length,r=new Array(e);for(let t=0;t<e;++t)r[t]="";r[0]=o,r.push(p),r.xValues=[],void 0!==n&&(r.xValues[n]=o),c.dataRows.push(r)}})}})});let o=0;c.dataRows.forEach(t=>{o=Math.max(o,t.length)});var s=o-c.dataRows[0].length;for(let t=0;t<s;t++){var e=function(t){let o;return n&&!1!==(o=n(t))?o:(o=i+" "+t,a?{columnTitle:o,topLevelColumnTitle:o}:o)}(t+1);a?(c.dataRows[0].push(e.topLevelColumnTitle),c.dataRows[1].push(e.columnTitle)):c.dataRows[0].push(e)}})}function chartDrawAnnotations(){this.plotBoxClip.attr(this.plotBox),this.annotations.forEach(t=>{t.redraw(),t.graphic.animate({opacity:1},t.animationConfig)})}function chartRemoveAnnotation(o){const t=this.annotations,n="annotations"===o.coll?o:find(t,function(t){return t.options.id===o});n&&(fireEvent(n,"remove"),erase(this.options.annotations,n.options),erase(t,n),n.destroy())}function onChartAfterInit(){this.annotations=[],this.options.annotations||(this.options.annotations=[])}function wrapPointerOnContainerMouseDown(t){this.chart.hasDraggedAnnotation||t.apply(this,Array.prototype.slice.call(arguments,1))}var AnnotationChart;(AnnotationChart||(AnnotationChart={})).compose=function(a,t,o){if(U.pushUnique(composedMembers,t)){addEvent(t,"afterInit",onChartAfterInit);const n=t.prototype;n.addAnnotation=chartAddAnnotation,n.callbacks.push(chartCallback),n.collectionsWithInit.annotations=[chartAddAnnotation],n.collectionsWithUpdate.push("annotations"),n.drawAnnotations=chartDrawAnnotations,n.removeAnnotation=chartRemoveAnnotation,n.initAnnotation=function(t){const o=a.types[t.type]||a,n=new o(this,t);return this.annotations.push(n),n}}U.pushUnique(composedMembers,o)&&(t=o.prototype,wrap(t,"onContainerMouseDown",wrapPointerOnContainerMouseDown))};export default AnnotationChart;