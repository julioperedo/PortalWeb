"use strict";import ChartNavigationComposition from"../../Core/Chart/ChartNavigationComposition.js";import D from"../../Core/Defaults.js";const setOptions=D["setOptions"];import F from"../../Core/Templating.js";const format=F["format"];import H from"../../Core/Globals.js";const{doc,win}=H;import NavigationBindingDefaults from"./NavigationBindingsDefaults.js";import NBU from"./NavigationBindingsUtilities.js";const getFieldType=NBU["getFieldType"];import U from"../../Core/Utilities.js";const{addEvent,attr,defined,fireEvent,isArray,isFunction,isNumber,isObject,merge,objectEach,pick}=U,composedMembers=[];function closestPolyfill(t,e){const n=win.Element.prototype,i=n.matches||n.msMatchesSelector||n.webkitMatchesSelector;let s=null;if(n.closest)s=n.closest.call(t,e);else do{if(i.call(t,e))return t}while(null!==(t=t.parentElement||t.parentNode)&&1===t.nodeType);return s}function onAnnotationRemove(){this.chart.navigationBindings&&this.chart.navigationBindings.deselectAnnotation()}function onChartDestroy(){this.navigationBindings&&this.navigationBindings.destroy()}function onChartLoad(){var t=this.options;t&&t.navigation&&t.navigation.bindings&&(this.navigationBindings=new NavigationBindings(this,t.navigation),this.navigationBindings.initEvents(),this.navigationBindings.initUpdate())}function onChartRender(){const t=this.navigationBindings,a="highcharts-disabled-btn";if(this&&t){let o=!1;if(this.series.forEach(t=>{!t.options.isInternal&&t.visible&&(o=!0)}),this.navigationBindings&&this.navigationBindings.container&&this.navigationBindings.container[0]){const r=this.navigationBindings.container[0];objectEach(t.boundClassNames,(e,t)=>{var n=r.querySelectorAll("."+t);if(n)for(let t=0;t<n.length;t++){const i=n[t],s=i.className;"normal"===e.noDataState||o?-1!==s.indexOf(a)&&i.classList.remove(a):-1===s.indexOf(a)&&(i.className+=" "+a)}})}}}function onNavigationBindingsClosePopup(){this.deselectAnnotation()}function onNavigationBindingsDeselectButton(){this.selectedButtonElement=null}function selectableAnnotation(t){const n=t.prototype.defaultOptions.events&&t.prototype.defaultOptions.events.click;function e(t){const i=this,s=i.chart.navigationBindings,e=s.activeAnnotation;n&&n.call(i,t),e!==i?(s.deselectAnnotation(),(s.activeAnnotation=i).setControlPointsVisibility(!0),fireEvent(s,"showPopup",{annotation:i,formType:"annotation-toolbar",options:s.annotationToFields(i),onSubmit:function(t){if("remove"===t.actionType)s.activeAnnotation=!1,s.chart.removeAnnotation(i);else{var e={};s.fieldsToOptions(t.fields,e),s.deselectAnnotation();const n=e.typeOptions;"measure"===i.options.type&&(n.crosshairY.enabled=0!==n.crosshairY.strokeWidth,n.crosshairX.enabled=0!==n.crosshairX.strokeWidth),i.update(e)}}})):fireEvent(s,"closePopup"),t.activeAnnotation=!0}let i,s;merge(!0,t.prototype.defaultOptions.events,{click:e,touchstart:function(t){i=t.touches[0].clientX,s=t.touches[0].clientY},touchend:function(t){!!i&&4<=Math.sqrt(Math.pow(i-t.changedTouches[0].clientX,2)+Math.pow(s-t.changedTouches[0].clientY,2))||e.call(this,t)}})}class NavigationBindings{static compose(t,e){U.pushUnique(composedMembers,t)&&(addEvent(t,"remove",onAnnotationRemove),selectableAnnotation(t),objectEach(t.types,t=>{selectableAnnotation(t)})),U.pushUnique(composedMembers,e)&&(addEvent(e,"destroy",onChartDestroy),addEvent(e,"load",onChartLoad),addEvent(e,"render",onChartRender)),U.pushUnique(composedMembers,NavigationBindings)&&(addEvent(NavigationBindings,"closePopup",onNavigationBindingsClosePopup),addEvent(NavigationBindings,"deselectButton",onNavigationBindingsDeselectButton)),U.pushUnique(composedMembers,setOptions)&&setOptions(NavigationBindingDefaults)}constructor(t,e){this.boundClassNames=void 0,this.selectedButton=void 0,this.chart=t,this.options=e,this.eventsToUnbind=[],this.container=this.chart.container.getElementsByClassName(this.options.bindingsClassName||""),this.container.length||(this.container=doc.getElementsByClassName(this.options.bindingsClassName||""))}initEvents(){const i=this,e=i.chart,t=i.container,n=i.options;i.boundClassNames={},objectEach(n.bindings||{},t=>{i.boundClassNames[t.className]=t}),[].forEach.call(t,n=>{i.eventsToUnbind.push(addEvent(n,"click",t=>{const e=i.getButtonEvents(n,t);e&&!e.button.classList.contains("highcharts-disabled-btn")&&i.bindingsButtonClick(e.button,e.events,t)}))}),objectEach(n.events||{},(t,e)=>{isFunction(t)&&i.eventsToUnbind.push(addEvent(i,e,t,{passive:!1}))}),i.eventsToUnbind.push(addEvent(e.container,"click",function(t){!e.cancelClick&&e.isInsidePlot(t.chartX-e.plotLeft,t.chartY-e.plotTop,{visiblePlotOnly:!0})&&i.bindingsChartClick(this,t)})),i.eventsToUnbind.push(addEvent(e.container,H.isTouchDevice?"touchmove":"mousemove",function(t){i.bindingsContainerMouseMove(this,t)},H.isTouchDevice?{passive:!1}:void 0))}initUpdate(){const e=this;ChartNavigationComposition.compose(this.chart).navigation.addUpdate(t=>{e.update(t)})}bindingsButtonClick(t,e,n){const i=this,s=i.chart,o=s.renderer.boxWrapper;let a=!0;i.selectedButtonElement&&(i.selectedButtonElement.classList===t.classList&&(a=!1),fireEvent(i,"deselectButton",{button:i.selectedButtonElement}),i.nextEvent&&(i.currentUserDetails&&"annotations"===i.currentUserDetails.coll&&s.removeAnnotation(i.currentUserDetails),i.mouseMoveEvent=i.nextEvent=!1)),a?(i.selectedButton=e,i.selectedButtonElement=t,fireEvent(i,"selectButton",{button:t}),e.init&&e.init.call(i,t,n),(e.start||e.steps)&&s.renderer.boxWrapper.addClass("highcharts-draw-mode")):(s.stockTools&&s.stockTools.toggleButtonActiveClass(t),o.removeClass("highcharts-draw-mode"),i.nextEvent=!1,i.mouseMoveEvent=!1,i.selectedButton=null)}bindingsChartClick(t,e){t=this.chart;const n=this,i=n.activeAnnotation,s=n.selectedButton,o=t.renderer.boxWrapper;i&&(i.cancelClick||e.activeAnnotation||!e.target.parentNode||closestPolyfill(e.target,".highcharts-popup")?i.cancelClick&&setTimeout(()=>{i.cancelClick=!1},0):fireEvent(n,"closePopup")),s&&s.start&&(n.nextEvent?(n.nextEvent(e,n.currentUserDetails),n.steps&&(n.stepIndex++,s.steps[n.stepIndex]?n.mouseMoveEvent=n.nextEvent=s.steps[n.stepIndex]:(fireEvent(n,"deselectButton",{button:n.selectedButtonElement}),o.removeClass("highcharts-draw-mode"),s.end&&s.end.call(n,e,n.currentUserDetails),n.nextEvent=!1,n.mouseMoveEvent=!1,n.selectedButton=null))):(n.currentUserDetails=s.start.call(n,e),n.currentUserDetails&&s.steps?(n.stepIndex=0,n.steps=!0,n.mouseMoveEvent=n.nextEvent=s.steps[n.stepIndex]):(fireEvent(n,"deselectButton",{button:n.selectedButtonElement}),o.removeClass("highcharts-draw-mode"),n.steps=!1,n.selectedButton=null,s.end&&s.end.call(n,e,n.currentUserDetails))))}bindingsContainerMouseMove(t,e){this.mouseMoveEvent&&this.mouseMoveEvent(e,this.currentUserDetails)}fieldsToOptions(t,n){return objectEach(t,(s,t)=>{const e=parseFloat(s),o=t.split("."),a=o.length-1;if("undefined"!==(s=!isNumber(e)||s.match(/px|em/g)||t.match(/format/g)?s:e)){let i=n;o.forEach((t,e)=>{const n=pick(o[e+1],"");a===e?i[t]=s:i=i[t]||(i[t]=n.match(/\d/g)?[]:{},i[t])})}}),n}deselectAnnotation(){this.activeAnnotation&&(this.activeAnnotation.setControlPointsVisibility(!1),this.activeAnnotation=!1)}annotationToFields(a){const e=a.options,i=NavigationBindings.annotationsEditable,r=i.nestedOptions,s=pick(e.type,e.shapes&&e.shapes[0]&&e.shapes[0].type,e.labels&&e.labels[0]&&e.labels[0].type,"label"),l=NavigationBindings.annotationsNonEditable[e.langKey]||[],o={langKey:e.langKey,type:s};function c(t,i,n,s,e){let o;n&&defined(t)&&-1===l.indexOf(i)&&(0<=(n.indexOf&&n.indexOf(i))||n[i]||!0===n)&&(isArray(t)?(s[i]=[],t.forEach((t,n)=>{isObject(t)?(s[i][n]={},objectEach(t,(t,e)=>{c(t,e,r[i],s[i][n],i)})):c(t,0,r[i],s[i],i)})):isObject(t)?(o={},isArray(s)?(s.push(o),o[i]={},o=o[i]):s[i]=o,objectEach(t,(t,e)=>{c(t,e,0===i?n:r[i],o,i)})):"format"===i?s[i]=[format(t,a.labels[0].points[0]).toString(),"text"]:isArray(s)?s.push([t,getFieldType(e,t)]):s[i]=[t,getFieldType(i,t)])}return objectEach(e,(t,n)=>{"typeOptions"===n?(o[n]={},objectEach(e[n],(t,e)=>{c(t,e,r,o[n],e)})):c(t,n,i[s],o,n)}),o}getClickedClassNames(t,e){let n=e.target,i=[],s;for(;n&&n.tagName;)if((s=attr(n,"class"))&&(i=i.concat(s.split(" ").map(t=>[t,n]))),(n=n.parentNode)===t)return i;return i}getButtonEvents(t,e){const n=this,i=this.getClickedClassNames(t,e);let s;return i.forEach(t=>{n.boundClassNames[t[0]]&&!s&&(s={events:n.boundClassNames[t[0]],button:t[1]})}),s}update(t){this.options=merge(!0,this.options,t),this.removeEvents(),this.initEvents()}removeEvents(){this.eventsToUnbind.forEach(t=>t())}destroy(){this.removeEvents()}}NavigationBindings.annotationsEditable={nestedOptions:{labelOptions:["style","format","backgroundColor"],labels:["style"],label:["style"],style:["fontSize","color"],background:["fill","strokeWidth","stroke"],innerBackground:["fill","strokeWidth","stroke"],outerBackground:["fill","strokeWidth","stroke"],shapeOptions:["fill","strokeWidth","stroke"],shapes:["fill","strokeWidth","stroke"],line:["strokeWidth","stroke"],backgroundColors:[!0],connector:["fill","strokeWidth","stroke"],crosshairX:["strokeWidth","stroke"],crosshairY:["strokeWidth","stroke"]},circle:["shapes"],ellipse:["shapes"],verticalLine:[],label:["labelOptions"],measure:["background","crosshairY","crosshairX"],fibonacci:[],tunnel:["background","line","height"],pitchfork:["innerBackground","outerBackground"],rect:["shapes"],crookedLine:[],basicAnnotation:["shapes","labelOptions"]},NavigationBindings.annotationsNonEditable={rectangle:["crosshairX","crosshairY","labelOptions"],ellipse:["labelOptions"],circle:["labelOptions"]};export default NavigationBindings;