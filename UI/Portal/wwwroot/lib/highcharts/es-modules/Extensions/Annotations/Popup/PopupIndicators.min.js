"use strict";import AST from"../../../Core/Renderer/HTML/AST.js";import H from"../../../Core/Globals.js";const doc=H["doc"];import NU from"../NavigationBindingsUtilities.js";const annotationsFieldsTypes=NU["annotationsFieldsTypes"];import SeriesRegistry from"../../../Core/Series/SeriesRegistry.js";const seriesTypes=SeriesRegistry["seriesTypes"];import U from"../../../Core/Utilities.js";const{addEvent,createElement,defined,isArray,isObject,objectEach,stableSort}=U;var DropdownProperties;!function(e){e[e["params.algorithm"]=0]="params.algorithm",e[e["params.average"]=1]="params.average"}(DropdownProperties=DropdownProperties||{});const dropdownParameters={"algorithm-pivotpoints":["standard","fibonacci","camarilla"],"average-disparityindex":["sma","ema","dema","tema","wma"]};function addColsContainer(e){var t=createElement("div",{className:"highcharts-popup-lhs-col"},void 0,e),e=createElement("div",{className:"highcharts-popup-rhs-col"},void 0,e);return createElement("div",{className:"highcharts-popup-rhs-col-wrapper"},void 0,e),{lhsCol:t,rhsCol:e}}function addForm(e,t,i){var a,s=this.lang;if(e){this.tabs.init.call(this,e);const r=this.container.querySelectorAll(".highcharts-tab-item-content");addColsContainer(r[0]),addSearchBox.call(this,e,r[0]),addIndicatorList.call(this,e,r[0],"add"),a=r[0].querySelectorAll(".highcharts-popup-rhs-col")[0],this.addButton(a,s.addButton||"add","add",a,i),addColsContainer(r[1]),addIndicatorList.call(this,e,r[1],"edit"),a=r[1].querySelectorAll(".highcharts-popup-rhs-col")[0],this.addButton(a,s.saveButton||"save","edit",a,i),this.addButton(a,s.removeButton||"remove","remove",a,i)}}function addFormFields(e,t,i,a){var s=t.params||t.options.params;a.innerHTML=AST.emptyHTML,createElement("h3",{className:"highcharts-indicator-title"},void 0,a).appendChild(doc.createTextNode(getNameType(t,i).indicatorFullName)),createElement("input",{type:"hidden",name:"highcharts-type-"+i,value:i},void 0,a),listAllSeries.call(this,i,"series",e,a,t,t.linkedParent&&t.linkedParent.options.id),s.volumeSeriesID&&listAllSeries.call(this,i,"volume",e,a,t,t.linkedParent&&s.volumeSeriesID),addParamInputs.call(this,e,"params",s,i,a)}function addIndicatorList(r,e,t,i){const o=this,a=o.lang,n=e.querySelectorAll(".highcharts-popup-lhs-col")[0],l=e.querySelectorAll(".highcharts-popup-rhs-col")[0],c="edit"===t,d=c?r.series:r.options.plotOptions||{};if(r||!d){let s,e=[];c||isArray(d)?isArray(d)&&(e=filterSeriesArray.call(this,d)):e=filterSeries.call(this,d,i),stableSort(e,(e,t)=>{e=e.indicatorFullName.toLowerCase(),t=t.indicatorFullName.toLowerCase();return e<t?-1:t<e?1:0}),n.children[1]&&n.children[1].remove();const h=createElement("ul",{className:"highcharts-indicator-list"},void 0,n),p=l.querySelectorAll(".highcharts-popup-rhs-col-wrapper")[0];e.forEach(e=>{const{indicatorFullName:t,indicatorType:i,series:a}=e;(s=createElement("li",{className:"highcharts-indicator-list"},void 0,h)).appendChild(doc.createTextNode(t)),["click","touchstart"].forEach(e=>{addEvent(s,e,function(){const e=p.parentNode.children[1];addFormFields.call(o,r,a,i,p),e&&(e.style.display="block"),c&&a.options&&createElement("input",{type:"hidden",name:"highcharts-id-"+i,value:a.options.id},void 0,p).setAttribute("highcharts-data-series-id",a.options.id)})})}),0<h.childNodes.length?h.childNodes[0].click():c||(AST.setElementHTML(p.parentNode.children[0],a.noFilterMatch||""),p.parentNode.children[1].style.display="none")}}function addParamInputs(s,r,e,o,n){if(s){const l=this.addInput;objectEach(e,(e,t)=>{var i,a=annotationsFieldsTypes[t],a=(a&&0,r+"."+t);defined(e)&&a&&(isObject(e)&&(l.call(this,a,o,n,{}),addParamInputs.call(this,s,a,e,o,n)),a in DropdownProperties?(i=addSelection.call(this,o,a,n),addSelectionOptions.call(this,s,r,i,o,t,e)):"params.volumeSeriesID"==a||isArray(e)||l.call(this,a,o,n,{value:e,type:"number"}))})}}function addSearchBox(t,e){function i(e){addIndicatorList.call(a,t,a.container,"add",e)}const a=this,s=e.querySelectorAll(".highcharts-popup-lhs-col")[0],r=this.lang.clearFilter,o=createElement("div",{className:"highcharts-input-wrapper"},void 0,s),n=this.addInput("searchIndicators","input",o,{value:"",type:"text",htmlFor:"search-indicators",labelClassName:"highcharts-input-search-indicators-label"}),l=createElement("a",{textContent:r},void 0,o);n.classList.add("highcharts-input-search-indicators"),l.classList.add("clear-filter-button"),addEvent(n,"input",function(e){i(this.value),this.value.length?l.style.display="inline-block":l.style.display="none"}),["click","touchstart"].forEach(e=>{addEvent(l,e,function(){n.value="",i(""),l.style.display="none"})})}function addSelection(e,t,i){var a=t.split("."),a=a[a.length-1],e="highcharts-"+t+"-type-"+e,s=this.lang;createElement("label",{htmlFor:e},null,i).appendChild(doc.createTextNode(s[a]||t));const r=createElement("select",{name:e,className:"highcharts-popup-field",id:"highcharts-select-"+t},null,i);return r.setAttribute("id","highcharts-select-"+t),r}function addSelectionOptions(e,a,s,t,i,r,o){if("series"===a||"volume"===a)e.series.forEach(e=>{var t=e.options,i=t.name||t.params?e.name:t.id||"";"highcharts-navigator-series"!==t.id&&t.id!==(o&&o.options&&o.options.id)&&(defined(r)||"volume"!==a||"column"!==e.type||(r=t.id),createElement("option",{value:t.id},void 0,s).appendChild(doc.createTextNode(i)))});else if(t&&i){const n=i+"-"+t,l=dropdownParameters[n];l.forEach(e=>{createElement("option",{value:e},void 0,s).appendChild(doc.createTextNode(e))})}defined(r)&&(s.value=r)}function filterSeries(e,n){this.indicators;const t=this.chart&&this.chart.options.lang,l=t&&t.navigation&&t.navigation.popup&&t.navigation.popup.indicatorAliases,c=[];let d;return objectEach(e,(e,t)=>{var i=e&&e.options;if(e.params||i&&i.params){const{indicatorFullName:a,indicatorType:s}=getNameType(e,t);if(n){i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");const r=new RegExp(i,"i"),o=l&&l[s]&&l[s].join(" ")||"";(a.match(r)||o.match(r))&&(d={indicatorFullName:a,indicatorType:s,series:e},c.push(d))}else d={indicatorFullName:a,indicatorType:s,series:e},c.push(d)}}),c}function filterSeriesArray(e){const t=[];return e.forEach(e=>{e.is("sma")&&t.push({indicatorFullName:e.name,indicatorType:e.type,series:e})}),t}function getAmount(){let t=0;return this.series.forEach(e=>{(e.params||e.options.params)&&t++}),t}function getNameType(e,t){var i=e.options;let a=seriesTypes[t]&&seriesTypes[t].prototype.nameBase||t.toUpperCase(),s=t;return i&&i.type&&(s=e.options.type,a=e.name),{indicatorFullName:a,indicatorType:s}}function listAllSeries(e,t,i,a,s,r){this.indicators;if(i){const o=addSelection.call(this,e,t,a);addSelectionOptions.call(this,i,t,o,void 0,void 0,void 0,s),defined(r)&&(o.value=r)}}const PopupIndicators={addForm:addForm,getAmount:getAmount};export default PopupIndicators;