function setupControls(){$("#Guard").kendoDropDownList({dataSource:{transport:{read:{url:urlGetGuards}}},dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Guardia ..."});var n=new Date,r=new Date(n.getFullYear(),n.getMonth(),n.getDate(),0,0,0,0),u=new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,59,999),t=$("#Since").kendoDateTimePicker({value:r,format:"d/M/yyyy HH:mm",interval:30,change:function(){var n=this.value();n===null&&this.value("");i.min(n?n:_minDate)}}).data("kendoDateTimePicker"),i=$("#Until").kendoDateTimePicker({value:u,format:"d/M/yyyy HH:mm",interval:30,change:function(){var n=this.value();n===null&&this.value("");t.max(n?n:_maxDate)}}).data("kendoDateTimePicker");_maxDate=i.max();_minDate=t.min();$("#resumePoints").kendoGrid({dataSource:[],sortable:!0,selectable:!0,groupable:!1,pageable:!1,noRecords:{template:'<div class="w-100 text-center p-3">No hay resultados para el criterio de b&uacute;squeda.<\/div>'},columns:[{field:"position",title:"#",width:25},{field:"date",title:"Fecha",width:150},{field:"type",title:"Tipo",width:110}],change:function(){for(var i,t=this.select(),n=0;n<t.length;n++)i=this.dataItem(t[n]),mymap.eachLayer(function(n){n._leaflet_id===i.id&&n.openPopup()})}});mymap=L.map("map").setView([_latitude,_longitude],13);L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap<\/a> contributors'}).addTo(mymap)}function setMapHeight(){var t=$("#map"),i=t.height()+$(window).height()-$(".container-fluid .card").height()-35,n;t.height(i);n=$("#resumePoints").data("kendoGrid");n&&n.setOptions({height:i})}function getFilters(){var i="",r=$("#Guard").data("kendoDropDownList").value(),n=$("#Since").data("kendoDateTimePicker").value(),t=$("#Until").data("kendoDateTimePicker").value();return n&&(n=kendo.toString(n,"yyyy-MM-dd HH:mm")),t&&(t=kendo.toString(t,"yyyy-MM-dd HH:mm")),n===""&t===""&r===""&&(i="Debe escoger algún criterio de búsqueda."),{message:i,data:{GuardId:r,Since:n,Until:t,_:new Date}}}function filterData(n){var t=getFilters();t.message===""?(mymap.eachLayer(function(n){n._leaflet_id!==24&&mymap.removeLayer(n)}),$.get(urlGetPoints,t.data,function(n){if(n.message!=="")showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`);else if(n.items){var t=L.Icon.extend({options:{}}),i=[11,28],f=new t({iconUrl:urlPinIcon,iconAnchor:[8,16]}),e=new t({iconUrl:urlTraceIcon,iconAnchor:i}),o=new t({iconUrl:urlRouteIcon,iconAnchor:i}),r=[],u=[];n.items.forEach((n,t)=>{var i=JSON.toDate(n.date),h=`<strong># ${t+1}</strong>`+`<br /><strong>Fecha:</strong> ${kendo.toString(i,"dd/MM/yyyy HH:mm:ss")}`+`<br /><strong>Latitud:</strong> ${n.latitude}`+`<br /><strong>Longitud:</strong> ${n.longitude}`+`<br /><strong>Altitud:</strong> ${kendo.toString(n.altitude,"#,##0.00")} msnm`+`<br /><strong>Precisión:</strong> ${kendo.toString(n.accuracy,"#,##0.00")} m`+`<br /><strong>Fuente:</strong> ${n.provider}`,c=n.type==="A"?f:n.type==="C"?o:e,s;r.push([n.latitude,n.longitude]);s=L.marker([n.latitude,n.longitude],{icon:c}).addTo(mymap).bindPopup(h).openPopup();u.push({position:t+1,date:kendo.toString(i,"dd/MM/yyyy HH:mm:ss"),type:n.type=="A"?"Automático":"Punto de Control",id:s._leaflet_id})});L.polyline(r,{color:"red",weight:1}).addTo(mymap);loadGrid(u)}})):n||showInfo(`Se deben ingresar los siguientes campos: <br />${t.message}`);setMapHeight()}function loadGrid(n){var t=$("#resumePoints").getKendoGrid(),i=new kendo.data.DataSource({data:n});t.setDataSource(i)}var _minDate,_maxDate,_latitude=-17.8100395202637,_longitude=-63.2070960998535,mymap;$(function(){setMapHeight();setTimeout(function(){setupControls();filterData(!0)},900)});$(window).resize(function(){setMapHeight()});$("#action-filter").click(function(){filterData(!1)});