function setupControls(){$("#FilClient").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente",filter:"contains",dataSource:{transport:{read:{url:urlClients}}},virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}}});$("#FilStaff").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una persona",filter:"contains",dataSource:{transport:{read:{url:urlStaff}}}});var n=new Date,t=$("#FilSince").kendoDatePicker({value:n,change:function(){var n=this.value();n===null&&this.value("");i.min(n?n:_minDate)}}).data("kendoDatePicker"),i=$("#FilUntil").kendoDatePicker({value:n,change:function(){var n=this.value();n===null&&this.value("");t.max(n?n:_maxDate)}}).data("kendoDatePicker");_maxDate=i.max();_minDate=t.min();$("#Listado").kendoGrid({sortable:!0,noRecords:{template:'<div class="w-100 text-center p-3">No hay resultados para el criterio de b&uacute;squeda.<\/div>'},columns:[{title:"Cliente",width:180,field:"clientName"},{title:"Nombre",width:180,field:"visitor.fullName"},{title:"Doc. Identidad",width:120,field:"visitor.documentId"},{title:"Personal Visitado",width:220,field:"staff.fullName"},{title:"Fecha",attributes:alignCenter,headerAttributes:alignCenter,width:100,field:"initialDate",format:dateFormat},{title:"Ingreso",attributes:alignCenter,headerAttributes:alignCenter,width:80,field:"initialDate",format:"{0:HH:mm:ss}"},{title:"Salida",attributes:alignCenter,headerAttributes:alignCenter,width:130,template:'# if(finalDate) {# #=kendo.toString(finalDate, "HH:mm:ss")# #} else {# #if(editable) {# <a class="finish-visit k-button">Marcar Salida<\/a> #}# #} #',field:"finalDate"},{field:"id",title:" ",attributes:alignCenter,width:50,sortable:!1,headerAttributes:alignCenter,headerTemplate:'<i class="fas fa-plus action action-new" title="Nueva Visita"><\/i>',template:'<i class="fas fa-pen action action-edit" title="Editar Visita"><\/i>'}],selectable:"Single, Row",dataSource:[]});$("#Detail").kendoWindow({visible:!1,width:1050,title:"Visita",modal:!0,close:onCloseWindow,refresh:function(n){setupControlsDetail();onRefreshWindow(n)}})}function getFilters(){var i="",r=$("#FilClient").data("kendoDropDownList").value(),u=$("#FilVisitor").val(),f=$("#FilStaff").data("kendoDropDownList").value(),n=$("#FilSince").data("kendoDatePicker").value(),t=$("#FilUntil").data("kendoDatePicker").value(),e=$("#NotFinished").prop("checked");return n&&(n=n.toISOString()),t&&(t=t.toISOString()),n===""&t===""&r===""&u===""&f===""&&(i="Debe escoger algún criterio de búsqueda."),{message:i,data:{CardCode:r,Visitor:u,Staff:f,Since:n,Until:t,NotFinished:e,_:new Date}}}function filterData(n){var t=getFilters();t.message===""?$.get(urlFilter,t.data,function(n){loadGrid(n.items);n.message!==""&&showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`)}):n||(setGridHeight("Listado",_gridMargin),showInfo(`Se deben ingresar los siguientes campos: <br />${t.message}`))}function loadGrid(n){var i,r,t;n.forEach(n=>{n.initialDate=JSON.toDate(n.initialDate),n.finalDate=JSON.toDate(n.finalDate)});i=$("#Listado").getKendoGrid();r=new kendo.data.DataSource({data:n});i.setDataSource(r);t=_gridMargin;n&&n.length>0&&($("#filter-box").collapse("hide"),t-=20);setTimeout(()=>{setGridHeight("Listado",t)},200)}function cleanFilters(){var n=new Date,t,i;$("#FilClient").data("kendoDropDownList").value("");$("#FilVisitor").val("");$("#FilStaff").data("kendoDropDownList").value("");t=$("#FilSince").data("kendoDatePicker");i=$("#FilUntil").data("kendoDatePicker");i.min(n);t.max(n);t.value(n);i.value(n);$("#NotFinished").prop("checked",!0);filterData(!1)}function setupControlsDetail(){$("#CardCode").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente",filter:"contains",dataSource:{transport:{read:{url:urlClients}}},virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}},change:function(){var n=$("label[for='ClientDescription']"),t=$("#ClientDescription").parent();this.value()=="CVAR-001"||this.value()=="AVAR-001"?(n.removeClass("d-none"),t.removeClass("d-none")):(n.addClass("d-none"),t.addClass("d-none"))}});$("#VisitorId").kendoDropDownList({dataTextField:"name",dataValueField:"id",noDataTemplate:$("#noDataTemplate").html(),optionLabel:"Seleccione una persona",filter:"contains",dataSource:{transport:{read:{url:urlVisitors}}},virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.id===+n.value));n.success(i)}},change:function(){var n=$("#photo"),t=$("#clientDocId"),i=$("#clientDocIdRev");this.value()==""?(n.attr("src",urlNoPhoto),t.attr("src",urlNoCI),i.attr("src",urlNoCIR),$(".visitor-image").removeClass("selected")):$.get(urlGetImages,{Id:this.value()},function(r){var u=urlNoPhoto,f=urlNoCI,e=urlNoCIR;r.message==""?(u=r.photo!=""?urImages+r.photo:urlNoPhoto,f=r.ci!=""?urImages+r.ci:urlNoCI,e=r.cir!=""?urImages+r.cir:urlNoCIR):showError(r.message);n.attr("src",u);t.attr("src",f);i.attr("src",e);$(".visitor-image").addClass("selected")})}});var n=$("#InitialDate").kendoDateTimePicker({change:function(){var n=this.value();n===null&&this.value("");t.min(n?n:_minDate)}}).data("kendoDatePicker"),t=$("#FinalDate").kendoDateTimePicker({change:function(){var t=this.value();t===null&&this.value("");n.max(t?t:_maxDate)}}).data("kendoDatePicker");$("#StaffId").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una persona",filter:"contains",dataSource:{transport:{read:{url:urlStaff}}}})}function addNewVisitor(){$("#VisitorId").getKendoDropDownList().close();var n=$("#newVisitor").kendoWindow({width:900,title:"Nuevo Visitante",visible:!1,modal:!0}).data("kendoWindow"),t=kendo.template($("#newVisitorTemplate").html());n.content(t({}));n.open().center()}function takingPhoto(){Webcam.snap(function(n){var i=$("#picture-type").val(),t;i=="N"?($("#new-photo").attr("src",n),$.post(urlSaveImage,{ImageBase64:n},function(n){n.message==""?$("#photo-value").val(n.fileName):showError(n.message)})):($("#photo").attr("src",n),t=$("#VisitorId").getKendoDropDownList().value(),t!=""&&$.post(urlSaveImagePerson,{PersonId:t,ImageBase64:n},function(n){n.message==""?$("#photo-value").val(n.fileName):showError(n.message)}));$("#camera").getKendoWindow().close()})}var _minDate,_maxDate;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}",_gridMargin=30,objConfig={messages:{required:"*"}};$(function(){setupControls();filterData(!0)});$(window).resize(function(){setGridHeight("Listado",_gridMargin)});$("#action-clean").click(()=>{cleanFilters()});$("#action-filter").click(()=>{filterData(!1)});$("#Listado").on("click",".action-new",function(){var n=$("#Detail").data("kendoWindow");n.refresh({url:urlEdit,data:{Id:0}});n.open()});$("#Listado").on("click",".action-edit",function(n){var i=$("#Listado").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),u,t;i.select(r);u=i.dataItem(r);t=$("#Detail").data("kendoWindow");t.refresh({url:urlEdit,data:{Id:u.id}});t.open()});$("#Detail").on("click",".take-picture",function(){var n=$("#camera").kendoWindow({title:"Foto",visible:!1,modal:!0,close:function(){Webcam.reset()}}).data("kendoWindow");Webcam.set({width:600,height:450,dest_width:960,dest_height:720,crop_width:960,crop_height:720,image_format:"jpeg",jpeg_quality:90});Webcam.attach("#my_camera");$("#picture-type").val("E");n.open().center()});$("#Detail").on("click",".save-visit",function(){var i={rules:{client:function(n){return n.is("[name=ClientDescription]")?!(($("#CardCode").getKendoDropDownList().value()=="CVAR-001"||$("#CardCode").getKendoDropDownList().value()=="AVAR-001")&n.val()==""):!0}},messages:{required:"*",client:"Se requiere aclaración de nombre."}},n=$(this).closest("form"),r=n.kendoValidator(i).data("kendoValidator"),t;r.validate()&&(t=n.serializeObject(),$.post(urlEdit,{Item:t},function(n){n.message===""?($("#Detail").getKendoWindow().close(),cleanFilters(),showMessage("Se ha guardado exitosamente.")):showError("Se ha producido un error al guardar la visita, por favor intente nuevamente.")}))});$("#newVisitor").on("click","#photo-camera",function(){var n=$("#camera").kendoWindow({title:"Foto",visible:!1,modal:!0,close:function(){Webcam.reset()}}).data("kendoWindow");Webcam.set({width:600,height:450,dest_width:960,dest_height:720,crop_width:960,crop_height:720,image_format:"jpeg",jpeg_quality:90});Webcam.attach("#my_camera");$("#picture-type").val("N");n.open().center()});$("#newVisitor").on("click","#photo-gallery, #docId-gallery, #docIdR-gallery",function(){$("#gallery-data").val(this.id.split("-")[0]);$("#gallery").click()});$("#newVisitor").on("click","#photo-remove, #docId-remove, #docIdR-remove",function(){var n=this.id.split("-")[0],t=n=="photo"?urlNoPhoto:n=="docId"?urlNoCI:urlNoCIR;$("#new-"+n).attr("src",t);$("#"+n+"-value").val("")});$("#Listado").on("click",".finish-visit",function(){var n=$("#Listado").getKendoGrid(),t=$(this).closest("tr"),i;n.select(t);i=n.dataItem(t);$.post(urlFinish,{Id:i.id},function(n){n.message===""?cleanFilters():showError("Se ha producido un error al terminar la visita, por favor intente nuevamente.")})});$("#newVisitor").on("click","#save-visitor",function(n){var u,f,e,o,t,i,r;n.preventDefault();var s=$(this).closest("form"),h=s.kendoValidator({rules:{},messages:{required:"*"}}).data("kendoValidator");h.validate()&&(u=$("#newVisitor").find("#DocumentId").val(),f=$("#newVisitor").find("#FirstName").val(),e=$("#newVisitor").find("#LastName").val(),o=$("#newVisitor").find("#Phone").val(),t=$("#newVisitor").find("#photo-value").val(),i=$("#newVisitor").find("#docId-value").val(),r=$("#newVisitor").find("#docIdR-value").val(),$.post(urlAddVisitor,{DocumentId:u,FirstName:f,LastName:e,Phone:o,PhotoImage:t,DocumentIdImage:i,DocumentIdReverseImage:r},function(n){if(n.message===""){var o=$("#VisitorId").getKendoDropDownList(),s=o.dataSource;s.add({id:n.id,name:`${u} - ${f} ${e}`});s.one("sync",function(){o.select(s.view().length-1)});s.sync();o.close();o.value(n.id);t!=""&&$("#Detail").find("#photo").attr("src",urImages+t);i!=""&&$("#Detail").find("#clientDocId").attr("src",urImages+i);r!=""&&$("#Detail").find("#clientDocIdRev").attr("src",urImages+r);$("#newVisitor").getKendoWindow().close()}else showError("Se ha producido un error al guardar el visitante, por favor intente nuevamente.")}))});$("#gallery").on("change",function(){var t=$("#gallery-data").val(),n;this.files&&this.files[0]&&(this.files[0].size<=29e5?(n=new FileReader,n.addEventListener("load",function(n){$("#new-"+t).attr("src",n.target.result);$.post(urlSaveImage,{ImageBase64:n.target.result},function(n){n.message===""?$("#"+t+"-value").val(n.fileName):showError(n.message)})}),n.readAsDataURL(this.files[0])):showInfo("El archivo no debe pesar más de 2.2MB."),$(this).val(""))});