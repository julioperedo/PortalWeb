function setupControls(){$("#FilClient").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente",filter:"contains",dataSource:{transport:{read:{url:urlClients}}},virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}}});$("#FilStaff").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una persona",filter:"contains",dataSource:{transport:{read:{url:urlStaff}}}});var n=new Date,t=$("#FilSince").kendoDatePicker({value:n,change:function(){var n=this.value();n===null&&this.value("");i.min(n?n:_minDate)}}).data("kendoDatePicker"),i=$("#FilUntil").kendoDatePicker({value:n,change:function(){var n=this.value();n===null&&this.value("");t.max(n?n:_maxDate)}}).data("kendoDatePicker");_maxDate=i.max();_minDate=t.min();$("#Listado").kendoGrid({sortable:!0,noRecords:{template:"No hay resultados para el criterio de búsqueda."},columns:[{title:"Tarjeta",attributes:alignCenter,headerAttributes:alignCenter,width:80,field:"securityCardId"},{title:"Cliente",width:180,field:"clientName"},{title:"Nombre",width:180,field:"visitor.fullName"},{title:"Doc. Identidad",width:120,field:"visitor.documentId"},{title:"Personal Visitado",width:220,field:"staff.fullName"},{title:"Fecha",attributes:alignCenter,headerAttributes:alignCenter,width:100,field:"initialDate",format:dateFormat},{title:"Ingreso",attributes:alignCenter,headerAttributes:alignCenter,width:80,field:"initialDate",format:"{0:HH:mm:ss}"},{title:"Salida",attributes:alignCenter,headerAttributes:alignCenter,width:130,template:'# if(finalDate) {# #=kendo.toString(finalDate, "HH:mm:ss")# #} else {# #if(editable) {# <a class="finish-visit k-button">Marcar Salida<\/a> #}# #} #',field:"finalDate"},{field:"id",title:" ",attributes:alignCenter,width:50,sortable:!1,headerAttributes:alignCenter,headerTemplate:'<i class="fas fa-plus action action-new" title="Nueva Visita"><\/i>',template:'<i class="fas fa-pen action action-edit" title="Editar Visita"><\/i>'}],selectable:"Single, Row",dataSource:[]});$("#Detail").kendoWindow({visible:!1,width:1050,title:"Visita",modal:!0,close:onCloseWindow,refresh:function(n){setupControlsDetail();onRefreshWindow(n)}})}function getFilters(){var i="",r=$("#FilClient").data("kendoDropDownList").value(),u=$("#FilVisitor").val(),f=$("#FilStaff").data("kendoDropDownList").value(),n=$("#FilSince").data("kendoDatePicker").value(),t=$("#FilUntil").data("kendoDatePicker").value(),e=$("#NotFinished").prop("checked");return n&&(n=n.toISOString()),t&&(t=t.toISOString()),n===""&t===""&r===""&u===""&f===""&&(i="Debe escoger algún criterio de búsqueda."),{message:i,data:{CardCode:r,Visitor:u,Staff:f,Since:n,Until:t,NotFinished:e,_:new Date}}}function filterData(n){var t=getFilters();t.message===""?$.get(urlFilter,t.data,function(n){loadGrid(n.items);n.message!==""&&showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`)}):n||(setGridHeight("Listado",_gridMargin),showInfo(`Se deben ingresar los siguientes campos: <br />${t.message}`))}function loadGrid(n){var i,r,t;n.forEach(n=>{n.initialDate=JSON.toDate(n.initialDate),n.finalDate=JSON.toDate(n.finalDate)});i=$("#Listado").getKendoGrid();r=new kendo.data.DataSource({data:n});i.setDataSource(r);t=_gridMargin;n&&n.length>0&&($("#filter-box").collapse("hide"),t-=20);setTimeout(()=>{setGridHeight("Listado",t)},200)}function cleanFilters(){var n=new Date,t,i;$("#FilClient").data("kendoDropDownList").value("");$("#FilVisitor").val("");$("#FilStaff").data("kendoDropDownList").value("");t=$("#FilSince").data("kendoDatePicker");i=$("#FilUntil").data("kendoDatePicker");i.min(n);t.max(n);t.value(n);i.value(n);$("#NotFinished").prop("checked",!0);filterData(!1)}function setupControlsDetail(){$("#CardCode").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente",filter:"contains",dataSource:{transport:{read:{url:urlClients}}},virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}},change:function(){var n=$("label[for='ClientDescription']"),t=$("#ClientDescription").parent();this.value()=="CVAR-001"?(n.removeClass("d-none"),t.removeClass("d-none")):(n.addClass("d-none"),t.addClass("d-none"))}});$("#VisitorId").kendoDropDownList({dataTextField:"name",dataValueField:"id",noDataTemplate:$("#noDataTemplate").html(),optionLabel:"Seleccione una persona",filter:"contains",dataSource:{transport:{read:{url:urlVisitors}}},virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.id===+n.value));n.success(i)}}});$("#StaffId").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una persona",filter:"contains",dataSource:{transport:{read:{url:urlStaff}}}});$("#IdReason").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un motivo",filter:"contains",dataSource:{transport:{read:{url:urlReasons}}},change:function(){this.value()==="55"?$("#ReasonVisit").removeClass("d-none"):$("#ReasonVisit").addClass("d-none")}})}function addNewVisitor(){$("#VisitorId").getKendoDropDownList().close();var n=$("#newVisitor").kendoWindow({width:900,title:"Nuevo Visitante",visible:!1,modal:!0}).data("kendoWindow"),t=kendo.template($("#newVisitorTemplate").html());n.content(t({}));n.open().center()}var _minDate,_maxDate;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}",_gridMargin=30,objConfig={messages:{required:"*"}};$(function(){setupControls();filterData(!0)});$(window).resize(function(){setGridHeight("Listado",_gridMargin)});$("#action-clean").click(()=>{cleanFilters()});$("#action-filter").click(()=>{filterData(!1)});$("#Listado").on("click",".action-new",function(){var n=$("#Detail").data("kendoWindow");n.refresh({url:urlEdit,data:{Id:0}});n.open()});$("#Listado").on("click",".action-edit",function(n){var i=$("#Listado").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),u,t;i.select(r);u=i.dataItem(r);t=$("#Detail").data("kendoWindow");t.refresh({url:urlEdit,data:{Id:u.id}});t.open()});$("#Listado").on("click",".finish-visit",function(){var n=$("#Listado").getKendoGrid(),t=$(this).closest("tr"),i;n.select(t);i=n.dataItem(t);$.post(urlFinish,{Id:i.id},function(n){n.message===""?cleanFilters():showError("Se ha producido un error al terminar la visita, por favor intente nuevamente.")})});$("#Detail").on("click",".save-visit",function(n){var i;n.preventDefault();var r={rules:{client:function(n){return n.is("[name=ClientDescription]")?!($("#CardCode").getKendoDropDownList().value()=="CVAR-001"&n.val()==""):!0},securityCard:function(n){return n.is("[name=SecurityCardId]")?n.val()>0:!0},reason:function(n){return n.is("[name=ReasonVisit]")?!($("#IdReason").getKendoDropDownList().value()=="55"&n.val()==""):!0}},messages:{required:"*",client:"Se requiere aclaración de nombre.",securityCard:"Debe ser un número válido de tarjeta",reason:"Debe aclarar el motivo."}},t=$(this).closest("form"),u=t.kendoValidator(r).data("kendoValidator");u.validate()&&(i=t.serializeObject(),$.post(urlEdit,{Item:i},function(n){n.message===""?(cleanFilters(),$("#Detail").getKendoWindow().close()):showError("Se ha producido un error al guardar la visita, por favor intente nuevamente.")}))});$("#newVisitor").on("click",".save-visitor",function(n){var u,f,t,i,r,e;n.preventDefault();u=$(this).closest("form");f=u.kendoValidator().data("kendoValidator");f.validate()&&(t=$("#newVisitor").find("#DocumentId").val(),i=$("#newVisitor").find("#FirstName").val(),r=$("#newVisitor").find("#LastName").val(),e=$("#newVisitor").find("#Phone").val(),$.post(urlAddVisitor,{DocumentId:t,FirstName:i,LastName:r,Phone:e},function(n){if(n.message===""){var u=$("#VisitorId").getKendoDropDownList(),f=u.dataSource;f.add({id:n.id,name:t+" - "+i+" "+r});f.one("sync",function(){u.select(f.view().length-1)});f.sync();u.close();u.value(n.id);$("#newVisitor").getKendoWindow().close()}else showError("Se ha producido un error al guardar el visitante, por favor intente nuevamente.")},"json"))});