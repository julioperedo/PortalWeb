function setupControls(){$("#FilEnabled").kendoDropDownList();$("#FilOffers").kendoDropDownList();$("#FilLine").kendoDropDownList({dataSource:{transport:{read:{url:urlLines}}},optionLabel:"Seleccione una Línea...",filter:"contains",dataTextField:"name",dataValueField:"id"});$("#FilCategory").kendoDropDownList({dataSource:{serverFiltering:!0,transport:{read:{url:urlCategories,data:function(){return{LineId:$("#FilLine").val()}}}}},cascadeFrom:"FilLine",optionLabel:"Seleccione una Categoría...",filter:"contains",dataTextField:"name",dataValueField:"name"});$("#Listado").kendoGrid({columns:[{field:"line",title:"Line",hidden:!0,aggregates:["count"],groupHeaderTemplate:"Línea: #= value #    ( Total: #= count# )"},{field:"category",title:"Category",hidden:!0,aggregates:["count"],groupHeaderTemplate:"Categoría: #= value #    ( Total: #= count# )"},{field:"itemCode",title:"Item",width:150},{field:"name",title:"Nombre",width:255},{field:"enabled",title:"Habilitado",attributes:alignCenter,headerAttributes:alignCenter,width:90,template:'# if(enabled) {# <i class="fas fa-check"><\/i> #} #'},{field:"isDigital",title:"Digital",attributes:alignCenter,headerAttributes:alignCenter,width:70,template:'# if(isDigital) {# <i class="fas fa-check"><\/i> #} #'},{title:"Precios",headerAttributes:alignCenter,columns:[{field:"santaCruz",title:"Santa Cruz",attributes:alignRight,headerAttributes:alignRight,width:90,format:"{0:N2}"},{field:"miami",title:"Miami",attributes:alignRight,headerAttributes:alignRight,width:75,format:"{0:N2}"},{field:"iquique",title:"Iquique",attributes:alignRight,headerAttributes:alignRight,width:80,format:"{0:N2}"}]},{title:"Stock",headerAttributes:alignCenter,columns:[{field:"stockSantaCruz",title:"Santa Cruz",attributes:alignRight,headerAttributes:alignRight,width:105,template:"#=stockSantaCruz#"},{field:"stockMiami",title:"Miami",attributes:alignRight,headerAttributes:alignRight,width:105,template:"#=stockMiami#"},{field:"stockIquique",title:"Iquique",attributes:alignRight,headerAttributes:alignRight,width:105,template:"#=stockIquique#"}]},{title:"Mostrar",headerAttributes:alignCenter,columns:[{field:"showAlways",title:"Siempre",attributes:alignCenter,headerAttributes:alignCenter,width:70,template:'# if(showAlways) {# <i class="fas fa- check"><\/i> #} #'},{field:"showInWeb",title:"en Web",attributes:alignCenter,headerAttributes:alignCenter,width:70,template:'# if(showInWeb) {# <i class="fas fa-check"><\/i> #} #'},{field:"showTeamOnly",title:"Sólo DMC",attributes:alignCenter,headerAttributes:alignCenter,width:80,template:'# if(showTeamOnly) {# <i class="fas fa-check"><\/i> #} #'}]},{field:"imageURL",title:" ",attributes:alignCenter,width:30,template:'# if(imageURL != null && $.trim(imageURL) != "") {# <i class="fas fa-image" title="Tiene Imagen"><\/i> #} #'},{title:" ",attributes:alignCenter,width:60,sortable:!1,headerAttributes:alignCenter,template:'<a class="action action-link action-sync" title="Sincronizar Producto"><i class="fas fa-sync-alt"><\/i><\/a><a class="action action-link action-prices" title="Historial de Precios"><i class="fas fa-dollar-sign"><\/i><\/a>'},{field:"itemCode",title:" ",attributes:alignCenter,width:60,sortable:!1,headerAttributes:alignCenter,sticky:!0,headerTemplate:'<a class="action action-link new-product" title="Nuevo Producto"><i class="fas fa-plus"><\/i><\/a>',template:'<a class="action action-link action-edit" title="Editar Producto"><i class="fas fa-pen"><\/i><\/a><a class="action action-link action-delete" title="Eliminar Producto"><i class="fas fa-trash-alt"><\/i><\/a>'}],sortable:!0,selectable:"Single, Row",scrollable:{height:"200px"},messages:{noRecords:'<div class="w-100 text-center p-3">No hay registros para el criterio de b&uacute;squeda.<\/div>'},dataSource:{group:[{field:"line",dir:"asc",aggregates:[{field:"line",aggregate:"count"},{field:"category",aggregate:"count"}]},{field:"category",dir:"asc",aggregates:[{field:"line",aggregate:"count"},{field:"category",aggregate:"count"}]}],aggregate:[{field:"line",aggregate:"count"},{field:"category",aggregate:"count"}],schema:{data:"Data",total:"Total",errors:"Errors",model:{id:"id"}},data:[]}});var n=$("#FilProduct").magicSuggest({hideTrigger:!0,placeholder:"Escriba su criterio de búsqueda, separado por comas si desea ingresar más de uno"});$(n).on("keydown",function(n,t,i){i.keyCode==13&&filterData()});setGridHeight("Listado",marginGrid);$("#Line").kendoDropDownList({dataSource:{transport:{read:{url:urlSAPLines}}},optionLabel:"Seleccione una Línea...",filter:"contains",dataTextField:"name",dataValueField:"name"});$("#Category").kendoDropDownList({dataSource:{transport:{read:{url:urlSAPCategories}}},optionLabel:"Seleccione una Categoría...",filter:"contains",dataTextField:"name",dataValueField:"name"});$("#SubCategory").kendoDropDownList({dataSource:{serverFiltering:!0,transport:{read:{url:urlSAPSubcategories,data:getCategoryValue}}},cascadeFrom:"Category",optionLabel:"Seleccione una subcategoría...",filter:"contains",dataTextField:"name",dataValueField:"name"});$("#ExtraComments").kendoEditor({resizable:{content:!0},tools:["bold","italic","underline","strikethrough","fontSize","foreColor","backColor","justifyLeft","justifyCenter","justifyRight","justifyFull","insertUnorderedList","insertOrderedList","indent","outdent","createLink","unlink","tableWizard","createTable","addRowAbove","addRowBelow","addColumnLeft","addColumnRight","deleteRow","deleteColumn","viewHtml","formatting","cleanFormatting"],messages:{dialogCancel:"Cancelar",dialogInsert:"Agregar",dialogUpdate:"Aceptar",imageAltTex:"Texto Alternativo",imageWebAddress:"Dirección Imagen",insertImage:"Insertar Imagen",viewHtml:"Ver HTML"}})}function cleanFilters(){$("#FilProduct").val("");$("#FilEnabled").data("kendoDropDownList").value("");$("#FilOffers").data("kendoDropDownList").value("");$("#FilLine").data("kendoDropDownList").value("");$("#FilCategory").data("kendoDropDownList").value("")}function loadGrid(n){var t=$("#Listado").data("kendoGrid"),i=getDataSource(n);t.setDataSource(i);n&&n.length>0?($("#filter-box").collapse("hide"),$("#action-excel").removeClass("d-none")):$("#action-excel").addClass("d-none");setGridHeight("Listado",marginGrid)}function filterData(){var n=getFilters();n.message===""?$.get(urlFilter,n.data,function(n){n.message!==""?(showError(n.message),loadGrid([])):loadGrid(n.items)}):showInfo(`Debe seleccionar los siguientes campos: <br />${n.message}`)}function getDataSource(n){return new kendo.data.DataSource({data:n,pageSize:500,group:[{field:"line",dir:"asc",aggregates:[{field:"line",aggregate:"count"}]},{field:"category",dir:"asc",aggregates:[{field:"category",aggregate:"count"}]}]})}function getFilters(){$("#FilProduct").blur();var n=$("#FilProduct").magicSuggest().getValue().join(),t=$("#FilEnabled").data("kendoDropDownList").value(),i=$("#FilOffers").data("kendoDropDownList").value(),r=$("#FilLine").data("kendoDropDownList").value(),u=$("#FilCategory").data("kendoDropDownList").value(),f="";return t===""&&n===""&&i===""&&r===""&&u===""&&(f+="- Al menos un criterio de búsqueda."),{message:f,data:{Name:n,LineId:r,CategoryId:u,Enabled:t,Offer:i}}}function onProductEdit(n){loadProduct($(n.currentTarget).hasClass("action-edit")?$("#Listado").data("kendoGrid").dataItem($(n.currentTarget).closest("tr")):{editable:!0,enabled:!0,line:"",category:"",subcategory:"",showInWeb:!0})}function onProductCancel(n){n.preventDefault();$("#Detail").addClass("d-none");$("#Listado").removeClass("d-none");$("#page-title").text("Configuración de Productos");$("#back-list").addClass("d-none");$("#action-excel, #toggle-filter-box").removeClass("d-none")}function loadProduct(n){$("#filter-box").collapse("hide");$("#Listado").addClass("d-none");$("#Detail").removeClass("d-none");$("#page-title").text("Detalle de Producto");$("#back-list").removeClass("d-none");$("#action-excel, #toggle-filter-box").addClass("d-none");var r=$("#Line").getKendoDropDownList(),u=$("#Category").getKendoDropDownList(),f=$("#SubCategory").getKendoDropDownList();$("#Id").val(n.id);$("#ItemCode").val(n.itemCode);$("#Name").val(n.name);$("#Editable").prop("checked",n.editable);$("#Enabled").prop("checked",n.enabled);$("#ShowInWeb").prop("checked",n.showInWeb);$("#ShowAlways").prop("checked",n.showAlways);$("#ShowTeamOnly").prop("checked",n.showTeamOnly);$("#IsDigital").prop("checked",n.isDigital);$("#Description").val(n.description);$("#Commentaries").val(n.commentaries);$("#Link").val(n.link);$("#Warranty").val(n.warranty);$("#Consumables").val(n.consumables);r.value(n.line);u.value(n.category);f.value(n.subCategory);$("#ExtraComments").getKendoEditor().value(formatHTMLSafe(n.extraComments));$("#ImageURL").val(n.imageURL);$("#Photo").attr("src",$.trim(n.imageURL)===""?urlNoImage:`${urlImages}${$.trim(n.imageURL)}`);$("#DeletePhoto").toggleClass("d-none",$.trim(n.imageURL)==="");$("#ItemCode, #Name, #Enabled, #Description, #Commentaries, #Warranty, #Consumables, #DeletePhoto").attr("disabled",!n.editable);r.enable(n.editable);u.enable(n.editable);f.enable(n.editable);$("#files").getKendoUpload().enable(n.editable);var t=$("#tab-prices").find("ul"),i=$("#tab-prices").find(".tab-content"),e=$("#tab-volume-prices").find("ul"),o=$("#tab-volume-prices").find(".tab-content");t.empty();i.empty();e.empty();o.empty();$.get(urlEdit,{Id:n.id,ItemCode:n.itemCode},function(n){var r,u,f;n.message===""?(n.prices.forEach((n,r)=>{var e=r===0?"active show":"",o=r===0?'aria-selected="true"':"",u="",f="";t.append(`<li class="nav-item"><a class="nav-link ${e}" data-toggle="tab" href="#tab-price-${n.idSubsidiary}" role="tab" ${o}>${n.subsidiary}</a></li>`);n.stockDetail.length>0&&(u=`<table class="table table-condensed table-striped w-100 mt-4" style="font-size: 0.9em;">
                <thead><tr><th>Almac&eacute;n</th><th class="text-right">Stock</th><th class="text-right">Reserva</th><th class="text-right">Pedido</th></tr></thead>`,n.stockDetail.forEach(n=>{u+=`<tr><td>${n.warehouse}</td><td class="text-right">${n.stock}</td><td class="text-right">${n.reserve}</td><td class="text-right">${n.transit}</td></tr>`}),u+="<\/table>");n.fifoDetail.length>0&&(f=`<table class="table table-condensed table-striped w-100 mt-4" style="font-size: 0.9em;">
                <thead><tr><th>Almac&eacute;n</th><th class="text-right">Stock</th><th class="text-right">Costo</th><th class="text-right">Total</th><th class="text-center">Fecha</th></tr></thead>`,n.fifoDetail.forEach(n=>{f+=`<tr>
                    <td>${n.warehouse}</td>
                    <td class="text-right">${n.stock}</td>
                    <td class="text-right">${n.realCost?kendo.toString(n.realCost,"N2"):""}</td>
                    <td class="text-right">${n.total?kendo.toString(n.total,"N2"):""}</td>
                    <td class="text-center">${n.date?kendo.toString(JSON.toDate(n.date),"dd-MM-yyyy"):""}</td>
                </tr>`}),f+="<\/table>");i.append(`<div class="price-subsidiary tab-pane ${e} pt-3" id="tab-price-${n.idSubsidiary}" role="tabpanel">
    <input type="hidden" class="id-subsidiary" value="${n.idSubsidiary}" />
    <input type="hidden" class="id" value="${n.id}" />
    <div class="row">
        <div class="col-4 col-md-2"><label for="regular-price-${n.idSubsidiary}" class="control-label">Regular</label></div>
        <div class="col-8 col-md-4"><input id="regular-price-${n.idSubsidiary}" type="number" value="${n.regular??""}" min="0" class="regular-price form-control" /></div>
        <div class="col-4 col-md-2"><label for="client-suggested-${n.idSubsidiary}" class="control-label">Sugerido Cliente</label></div>
        <div class="col-8 col-md-4"><input id="client-suggested-${n.idSubsidiary}" type="number" value="${n.clientSuggested??""}" class="client-suggested form-control" /></div>
    </div>
    <div class="row">
        <div class="col-4 col-md-2"><label for="observations-${n.idSubsidiary}" class="control-label">Observaciones</label></div>
        <div class="col-8 col-md-10"><input id="observations-${n.idSubsidiary}" type="text" value="${n.observations??""}" class="form-control observations" /></div>
    </div>
    <div class="row">
        <div class="col-4 col-md-2"><label for="commentaries-${n.idSubsidiary}" class="control-label">Comentarios Internos</label></div>
        <div class="col-8 col-md-10"><input id="commentaries-${n.idSubsidiary}" type="text" value="${n.commentaries??""}" class="form-control commentaries" /></div>
    </div>
    <div class="row">
        <div class="col pt-3 pb-3">
            <h5>Precios de Oferta</h5>
            <div class="price-offers"></div>
            <div class="card detail-offer d-none mt-2">
                <div class="card-header">Detalle</div>
                <div class="card-body">
                    <input type="hidden" class="id-offer" />
                    <input type="hidden" class="id-subsidiary" />
                    <div class="row">
                        <div class="col-6"><h5>Detalle Oferta</h5></div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <label for="po-price-${n.idSubsidiary}">Precio</label>
                            <input type="number" class="po-price form-control" id="po-price-${n.idSubsidiary}" min="0" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="po-description-${n.idSubsidiary}">Descripci&oacute;n</label>
                            <textarea type="number" class="po-description form-control" id="po-description-${n.idSubsidiary}" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="po-since-${n.idSubsidiary}" class="mr-2">Desde</label>
                            <input id="po-since-${n.idSubsidiary}" type="date" class="po-since" />
                        </div>
                        <div class="col">
                            <label for="po-until-${n.idSubsidiary}" class="mr-2">Hasta</label>
                            <input id="po-until-${n.idSubsidiary}" type="date" class="po-until" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input selected po-enabled" id="po-enabled-${n.idSubsidiary}" />
                                <input name="po-enabled-${n.idSubsidiary}" type="hidden" value="false" />
                                <label class="custom-control-label" for="po-enabled-${n.idSubsidiary}"> Habilitado</label>
                            </div>
                        </div>
                        <div class="col">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input selected po-only-with-stock" id="po-only-with-stock-${n.idSubsidiary}" />
                                <input name="po-only-with-stock-${n.idSubsidiary}" type="hidden" value="false" />
                                <label class="custom-control-label" for="po-only-with-stock-${n.idSubsidiary}"> Deshabilitar sin stock</label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col text-right pb-2">
                            <button class="btn btn-light cancel-offer">Cancelar Edici&oacute;n</button>
                            <button class="btn btn-secondary save-offer">Guardar Oferta</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12 col-sm-6">${u}</div>
        <div class="col-12 col-sm-6">${f}</div>
    </div>
</div>`)}),r=$(".po-since").kendoDatePicker({format:"d/M/yyyy",change:function(){var n=this.value();n===null&&this.value("");u.min(n?n:_minDate)}}).data("kendoDatePicker"),u=$(".po-until").kendoDatePicker({format:"d/M/yyyy",change:function(){var n=this.value();n===null&&this.value("");r.max(n?n:_maxDate)}}).data("kendoDatePicker"),_maxDate=u.max(),_minDate=r.min(),$(".price-subsidiary").each(function(t,i){var u=+$(i).find(".id").val(),r=n.prices.find(n=>n.id===u).offers;r.forEach(n=>{n.since&&(n.since=JSON.toDate(n.since)),n.until&&(n.until=JSON.toDate(n.until))});$(i).find(".price-offers").kendoGrid({sortable:!0,scrollable:{height:200},selectable:"Single, Row",noRecords:{template:'<div class="w-100 p-2">No hay precios de oferta para esta sucursal.<\/div>'},columns:[{title:"Precio",field:"price",width:130,attributes:alignRight,headerAttributes:alignRight,format:"{0:N2}"},{title:"Desde",field:"since",width:120,format:dateFormat,attributes:alignCenter,headerAttributes:alignCenter},{title:"Hasta",field:"until",width:120,format:dateFormat,attributes:alignCenter,headerAttributes:alignCenter},{field:"onlyWithStock",title:"Eliminar sin stock",attributes:alignCenter,headerAttributes:alignCenter,width:140,template:n=>n.onlyWithStock?'<i class="fas fa-check"><\/i>':""},{field:"enabled",title:"Habilitado",attributes:alignCenter,headerAttributes:alignCenter,width:110,template:n=>n.enabled?'<i class="fas fa-check"><\/i>':""},{title:"",attributes:alignCenter,headerAttributes:alignCenter,headerAttributes:alignCenter,width:60,template:'<i class="fas fa-pen action action-link edit-offer" title="Editar Precio de Oferta"><\/i><i class="fas fa-trash-alt action action-link delete-offer" title="Eliminar Precio de Oferta"><\/i>',headerTemplate:'<i class="fas fa-plus action action-link new-offer" title="Nuevo Precio de Oferta"><\/i>'}],dataSource:{filter:[{logic:"and",filters:[{field:"statusType",operator:"neq",value:3}]}],schema:{model:{id:"id"}},data:r}})}),n.externalSite!==""&&(t.append(`<li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-price-external" role="tab">${n.externalSite}</a></li>`),i.append(`<div class="price-external-site tab-pane" id="tab-price-external" role="tabpanel">
    <input type="hidden" id="id-external" value="${n.externalPrice.id}" />
    <table style="width: 100%">
        <tr>
            <td class="control-label" style="width: 100px;"><label for="external-price">Precio</label></td>
            <td><input type="number" value="${n.externalPrice.price}" min="0" class="form-control" id="external-price" /></td>
        </tr>
        <tr>
            <td class="control-label"><label for="external-price-commentaries">Comentario</label></td>
            <td><input type="text" class="form-control" value="${n.externalPrice.commentaries}" id="external-price-commentaries" /></td>
        </tr>
        <tr>
            <td colspan="2">
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input selected" value="${n.externalPrice.showAlways}" id="external-price-show-always" />
                    <label class="custom-control-label" for="external-price-show-always"> Mostrar Siempre</label>
                </div>
            </td>
        </tr>
    </table>
</div>`)),n.volumePrices.forEach((n,t)=>{var u=t===0?"active show":"",f=t===0?'aria-selected="true"':"",i="",r="";e.append(`<li class="nav-item"><a class="nav-link ${u}" data-toggle="tab" href="#tab-volumeprice-${n.id}" role="tab" ${f}>${n.name}</a></li>`);n.stockDetail.length>0&&(i=`<table class="table table-condensed table-striped w-100 mt-4" style="font-size: 0.9em;">
                <thead><tr><th>Almac&eacute;n</th><th class="text-right">Stock</th><th class="text-right">Reserva</th><th class="text-right">Pedido</th></tr></thead>`,n.stockDetail.forEach(n=>{i+=`<tr><td>${n.warehouse}</td><td class="text-right">${n.stock}</td><td class="text-right">${n.reserve}</td><td class="text-right">${n.transit}</td></tr>`}),i+="<\/table>");n.fifoDetail.length>0&&(r=`<table class="table table-condensed table-striped w-100 mt-4" style="font-size: 0.9em;">
                <thead>
                    <tr>
                        <th>Almac&eacute;n</th>
                        <th class="text-right">Stock</th>
                        <th class="text-right">Costo</th>
                        <th class="text-right">Total</th>
                        <th class="text-center">Fecha</th>
                    </tr>
                </thead>`,n.fifoDetail.forEach(n=>{r+=`<tr>
                    <td>${n.warehouse}</td>
                    <td class="text-right">${n.stock}</td>
                    <td class="text-right">${n.realCost?kendo.toString(n.realCost,"N2"):""}</td>
                    <td class="text-right">${n.total?kendo.toString(n.total,"N2"):""}</td>
                    <td class="text-center">${n.date?kendo.toString(JSON.toDate(n.date),"dd-MM-yyyy"):""}</td>
                </tr>`}),r+="<\/table>");o.append(`<div class="volumeprice-subsidiary tab-pane ${u}" id="tab-volumeprice-${n.id}" role="tabpanel">
    <input type="hidden" value="${n.id}" class="id-subsidiary" />
    <div class="grid-volume" id="grid-volume-${n.id}"></div>
    <div class="card d-none detail-volume" style="margin-top: 8px;">
        <div class="card-header">Detalle</div>
        <div class="card-body">
        </div>
    </div>
    <div class="row">
        <div class="col-12 col-sm-6">${i}</div>
        <div class="col-12 col-sm-6">${r}</div>
    </div>
</div>`)}),$(".volumeprice-subsidiary").each(function(t,i){var r=+$(i).find(".id-subsidiary").val(),u=n.volumePrices.find(n=>n.id===r).items;$(i).find(".grid-volume").kendoGrid({sortable:!0,scrollable:{height:200},selectable:"Single, Row",noRecords:{template:'<div class="w-100 p-2">No hay precios por volumen para esta sucursal.<\/div>'},columns:[{title:"Cantidad",field:"quantity",width:110,attributes:alignRight,headerAttributes:alignRight},{title:"Precio",field:"price",width:120,attributes:alignRight,headerAttributes:alignRight,format:"{0:N2}"},{title:"Comentarios",field:"observations"},{title:"",attributes:alignCenter,headerAttributes:alignCenter,width:60,template:'<i class="fas fa-pen action action-link edit-volume-price" title="Editar Precio por Volúmen"><\/i><i class="fas fa-trash-alt action action-link delete-volume-price" title="Eliminar Precio por Volúmen"><\/i>',headerAttributes:alignCenter,headerTemplate:'<i class="fas fa-plus action action-link new-volume-price" title="Nuevo Precio por Volúmen"><\/i>'}],dataSource:{filter:[{logic:"and",filters:[{field:"statusType",operator:"neq",value:3}]}],schema:{model:{id:"id"}},data:u}})}),f=n.accelerators??[],f.forEach(n=>{n.initialDate=JSON.toDate(n.initialDate),n.finalDate=JSON.toDate(n.finalDate)}),$("#AcceleratorLots").kendoGrid({columns:[{title:"Cantidad Inicial",field:"initialQuantity",attributes:alignRight,headerAttributes:alignRight},{title:"Cantidad",field:"quantity",attributes:alignRight,headerAttributes:alignRight},{title:"Acelerador",field:"accelerator",attributes:alignRight,headerAttributes:alignRight},{title:"Desde",field:"initialDate",format:dateFormat,attributes:alignCenter,headerAttributes:alignCenter},{title:"Hasta",field:"finalDate",format:dateFormat,attributes:alignCenter,headerAttributes:alignCenter},{title:"Habilitado",attributes:alignCenter,headerAttributes:alignCenter,width:80,template:'# if(enabled) {# <i class="fas fa-check"><\/i> #} #',field:"enabled"},{field:"id",title:" ",attributes:alignCenter,width:70,sortable:!1,headerAttributes:alignCenter,headerTemplate:'<i class="fas fa-plus action action-link new-lot" title="Nuevo Acelerador"><\/i>',template:'<i class="fas fa-pen action action-link edit-lot" title="Editar Acelerador"><\/i><i class="fas fa-trash-alt action action-link delete-lot" title="Eliminar Acelerador"><\/i>'}],sortable:!0,selectable:"Single, Row",noRecords:{template:'<div class="w-100 p-3">No hay aceleradores para este producto.<\/div>'},dataSource:{filter:[{logic:"and",filters:[{field:"statusType",operator:"neq",value:3}]}],schema:{model:{id:"id"}},data:f}})):showError(`Se ha producido un error al traer los datos del servidor`)})}function onProductDelete(n){var i=$("#Listado").data("kendoGrid"),t=i.dataItem($(n.currentTarget).closest("tr")),r=getFilters();t.editable?showConfirm(`¿Está seguro que desea eliminar el producto <b>${t.itemCode}</b>?`,()=>{$.post(urlDelete,{Id:t.id,Filters:r.data},function(n){n.message===""?(loadGrid(n.items),showMessage(`Se ha eliminado el producto <b>${t.itemCode}</b> correctamente.`)):showError(n.message)})}):showInfo(`No se puede eliminar el Producto <b>${t.itemCode}</b>, est&aacute; ligado a un producto en el SAP.`)}function onProductSync(n){var i=$("#Listado").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),t=i.dataItem(r),u=getFilters();$.post(urlSync,{Id:t.id,Filters:u.data},function(n){n.error?showError(n.message):(loadGrid(n.items),n.message===""?showMessage(`Se ha sincronizado el Item: <b>${t.itemCode}</b> exitosamente.`):showInfo(n.message))})}function onProductSave(n){var i,r,t,u,f;n.preventDefault();i=$(this).closest("form");r=i.kendoValidator().data("kendoValidator");r.validate()&&(t=i.serializeObject(),t.Editable||(t.ItemCode=$("#ItemCode").val(),t.Name=$("#Name").val(),t.Description=$("#Description").val(),t.Commentaries=$("#Commentaries").val(),t.Warranty=$("#Warranty").val(),t.Consumables=$("#Consumables").val(),t.Line=$("#Line").getKendoDropDownList().value(),t.Category=$("#Category").getKendoDropDownList().value(),t.SubCategory=$("#SubCategory").getKendoDropDownList().value()),t.Prices=[],t.Volumen=[],t.Offers=[],$.each($(".price-subsidiary"),function(n,i){var u={Id:$(i).find(".id").val(),IdSubsidiary:$(i).find(".id-subsidiary").val(),Regular:$(i).find(".regular-price").val(),ClientSuggested:$(i).find(".client-suggested").val(),Observations:$(i).find(".observations").val(),Commentaries:$(i).find(".commentaries").val()},r;t.Prices.push(u);r=$(i).find(".price-offers").getKendoGrid().dataSource.data().map(n=>({Id:n.id,IdProduct:n.idProduct,IdSubsidiary:n.idSubsidiary,Price:n.price,Description:n.description,Enabled:n.enabled,Since:n.since?kendo.toString(n.since,"yyyy-MM-dd"):"",Until:n.until?kendo.toString(n.until,"yyyy-MM-dd"):"",OnlyWithStock:n.onlyWithStock,StatusType:n.statusType}));t.Offers.push(...r)}),$("#id-external").length>0&&(t.ExternalPrice={Id:$("#id-external").val(),Price:$("#external-price").val(),Commentaries:$("#external-price-commentaries").val(),ShowAlways:$("#external-price-show-always").prop("checked")}),$.each($(".volumeprice-subsidiary"),function(n,i){var r=$(i).find(".grid-volume").getKendoGrid().dataSource.data().map(n=>({Id:n.id,IdProduct:n.idProduct,IdSubsidiary:n.idSubsidiary,Price:n.price,Quantity:n.quantity,Observations:n.observations,StatusType:n.statusType}));t.Volumen.push(...r)}),u=$("#AcceleratorLots").data("kendoGrid").dataSource.data(),t.Lots=u.map(n=>({Id:n.id,IdProduct:n.idProduct,InitialQuantity:n.initialQuantity,Quantity:n.quantity,Accelerator:n.accelerator,InitialDate:n.initialDate,FinalDate:n.finalDate,Enabled:n.enabled,StatusType:n.statusType})),f=getFilters(),$.post(urlEdit,{Item:t,Filters:f.data},function(n){n.message===""?(loadGrid(n.items),$("#Detail, #back-list").addClass("d-none"),$("#Listado, #toggle-filter-box").removeClass("d-none"),$("#page-title").text("Configuración de Productos"),showMessage("Se realizaron los cambios correctamente.")):showError(n.message)}))}function onOfferEdit(n){var r=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),t=r.dataItem($(n.currentTarget).closest("tr"));if($(n.currentTarget).hasClass("delete-offer")&&showConfirm(`¿Está seguro que desea eliminar este precio de oferta?`,()=>{t&&(t.id>0?(t.statusType=3,r.dataSource.pushUpdate(t)):r.dataSource.remove(t))}),$(n.currentTarget).hasClass("new-offer")||$(n.currentTarget).hasClass("edit-offer")){var u=$("#Id").val(),f=$(n.currentTarget).closest(".price-subsidiary").find(".id-subsidiary").val(),i=$(n.currentTarget).closest(".price-subsidiary").find(".detail-offer");$(n.currentTarget).hasClass("new-offer")&&(t={id:getId(),idProduct:u,idSubsidiary:f,price:0,description:"",enabled:!0,since:null,until:null,onlyWithStock:!1});i.find(".id-offer").val(t.id);i.find(".id-subsidiary").val(t.idSubsidiary);i.find(".po-price").val(t.price);i.find(".po-description").val(t.description);i.find(".po-since.k-input-inner").getKendoDatePicker().value(t.since);i.find(".po-until.k-input-inner").getKendoDatePicker().value(t.until);i.find(".po-enabled").prop("checked",t.enabled);i.find(".po-only-with-stock").prop("checked",t.onlyWithStock);i.removeClass("d-none");$("#save-product").attr("disabled",!0)}}function onOfferSave(n){if(n.preventDefault(),$(n.currentTarget).hasClass("cancel-offer"))$(n.currentTarget).closest(".detail-offer").addClass("d-none");else{var t=$(n.currentTarget).closest(".detail-offer"),i=t.find(".id-offer").val(),u=t.prev().getKendoGrid(),r;r={id:i,idSubsidiary:t.find(".id-subsidiary").val(),price:+t.find(".po-price").val(),description:t.find(".po-description").val(),since:t.find(".po-since.k-input-inner").getKendoDatePicker().value(),until:t.find(".po-until.k-input-inner").getKendoDatePicker().value(),enabled:t.find(".po-enabled").prop("checked"),onlyWithStock:t.find(".po-only-with-stock").prop("checked"),statusType:i<1?1:2};u.dataSource.pushUpdate(r);t.addClass("d-none")}$("#save-product").removeAttr("disabled")}function onEditVolumePrice(n){var r=$(this).closest(".k-grid").data("kendoGrid"),t=r.dataItem($(this).closest("tr")),i=$(this).closest(".volumeprice-subsidiary").find(".detail-volume"),u;$(n.currentTarget).hasClass("delete-volume-price")&&showConfirm(`¿Está seguro que desea eliminar este precio por volumen?`,()=>{t&&(t.id>0?(t.statusType=3,r.dataSource.pushUpdate(t)):r.dataSource.remove(t))});($(n.currentTarget).hasClass("new-volume-price")||$(n.currentTarget).hasClass("edit-volume-price"))&&($(n.currentTarget).hasClass("new-volume-price")&&(t={id:getId(),idProduct:$("#Id").val(),idSubsidiary:$(this).closest(".volumeprice-subsidiary").find(".id-subsidiary").val(),quantity:0,price:0,observations:""}),u=kendo.template(priceVolumeTemplate),t.observations===null&&(t.observations=""),i.find(".card-body").html(u(t)),i.find("#Quantity").kendoNumericTextBox({format:"N0",decimals:0}),i.find("#Price").kendoNumericTextBox(),i.removeClass("d-none"),$("#save-product").attr("disabled",!0))}function onVolumePriceSave(n){var i=$(this).closest(".card");if($(n.currentTarget).hasClass("save-volume-price")){var t=$(n.currentTarget).closest(".detail-volume"),r=t.find(".id").val(),f=t.prev().getKendoGrid(),u;u={id:r,idSubsidiary:$(n.currentTarget).closest(".volumeprice-subsidiary").find(".id-subsidiary").val(),quantity:+t.find(".quantity").val(),price:+t.find(".price").val(),observations:t.find(".observations").val(),statusType:r<1?1:2};f.dataSource.pushUpdate(u)}i.find(".card-body").empty();i.addClass("d-none");$("#save-product").removeAttr("disabled")}function onLotEdit(n){var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),t=i.dataItem($(n.currentTarget).closest("tr")),r,f,u,e;$(n.currentTarget).hasClass("delete-lot")&&showConfirm("¿Está seguro que desea eliminar este Lote con acelerador?",()=>{t&&(t.id>0?(t.statusType=3,i.dataSource.pushUpdate(t)):i.dataSource.remove(t))});($(n.currentTarget).hasClass("new-lot")||$(n.currentTarget).hasClass("edit-lot"))&&(r=$(n.currentTarget).closest(".kbyte-detail").find(".card"),$(n.currentTarget).hasClass("new-lot")&&(t={id:0,idProduct:$("#Id").val(),initialQuantity:0,quantity:0,accelerator:0,initialDate:null,finalDate:null,enabled:!0}),f=kendo.template(lotTemplate),r.find(".card-body").html(f(t)),$("#AccEnabled").prop("checked",t.enabled),u=$("#Quantity").kendoNumericTextBox({format:"N0",decimals:0}).data("kendoNumericTextBox"),e=$("#InitialQuantity").kendoNumericTextBox({format:"N0",decimals:0,change:n=>u.value(n.sender.value())}).data("kendoNumericTextBox"),$("#Accelerator").kendoNumericTextBox(),$("#InitialDate").kendoDatePicker({value:t.initialDate}),$("#FinalDate").kendoDatePicker({value:t.finalDate}),t.id!==0&&e.enable(!1),u.enable(!1),r.removeClass("d-none"),$("#save-product").attr("disabled",!0))}function onLotSave(n){var i,t,r;n.preventDefault();i=$(this).closest(".kbyte-detail").find(".card");n.currentTarget.id==="save-lot"&&(t=i.serializeToObject(),r=$("#AcceleratorLots").data("kendoGrid"),t=toCamel(t),t.enabled=t.accEnabled,+t.id==0&&(t.id=getId()),t.statusType=t.id>0?2:1,t.enabled=t.accEnabled,r.dataSource.pushUpdate(t));i.find(".card-body").empty();i.addClass("d-none");$("#save-product").removeAttr("disabled")}function ExportExcel(){var n=getFilters();n.message===""?window.location.href=`${urlExcel}?${$.param(n.data)}`:showInfo(`Los siguientes campos son necesarios <br />${n.message}`)}function getId(){return _intId-=1}function getCategoryValue(){return{Category:$("#Category").val()}}function toCamel(n){var r,i,u,t;if(n instanceof Array)return n.map(function(n){return typeof n=="object"&&(n=toCamel(n)),n});r={};for(i in n)n.hasOwnProperty(i)&&(u=(i.charAt(0).toLowerCase()+i.slice(1)||i).toString(),t=n[i],(t instanceof Array||t!==null&&t.constructor===Object)&&(t=toCamel(t)),r[u]=t);return r}function toTitle(n){var r,i,u,t;if(n instanceof Array)return n.map(function(n){return typeof n=="object"&&(n=toTitle(n)),n});r={};for(i in n)n.hasOwnProperty(i)&&(u=(i.charAt(0).toUpperCase()+i.slice(1)||i).toString(),t=n[i],(t instanceof Array||t!==null&&t.constructor===Object)&&(t=toTitle(t)),r[u]=t);return r}function onSelect(n){var t=n.files[0].extension.toLowerCase();Enumerable.From([".jpg",".jpeg",".gif",".png",".bmp"]).Where(`$ === '${t}'`).Count()===0&&(n.preventDefault(),showInfo("Debe ser una imagen."))}function onUploadSucceded(n){var i=n.files,t;n.operation=="upload"?$.each(i,function(n,t){$("#Photo").attr("src",urlImages+t.name);$("#DeletePhoto").hide();$("#NewImageURL").val(t.name)}):(t=$("#ImageURL").val(),$("#NewImageURL").val(""),t===""?($("#Photo").attr("src",urlNoImage),$("#DeletePhoto").hide()):($("#Photo").attr("src",urlImages+t),$("#DeletePhoto").show()))}function onGettingPriceHistory(n){var t=$("#Listado").data("kendoGrid"),i=$(n.currentTarget).closest("tr"),r,u;t.select(i);r=t.dataItem(i);u=$("#HistoryDetail").data("kendoWindow");$.get(urlHistory,{Id:r.id},function(n){$.each(n.prices,function(n,t){t.logDate=JSON.toDate(t.logDate)});$.each(n.volume,function(n,t){t.logDate=JSON.toDate(t.logDate)});$("#prices-history-grid").kendoGrid({sortable:!0,scrollable:{height:200},selectable:"Single, Row",noRecords:{template:'<div class="w-100 text-center p-3">No hay histórico de precios para este producto.<\/div>'},columns:[{title:"Sucursal",width:"120px",field:"sudsidiary.name"},{title:"Precio",attributes:alignRight,headerAttributes:alignRight,width:"80px",field:"regular",format:"{0:N2}"},{title:"Oferta",attributes:alignRight,headerAttributes:alignRight,width:"80px",field:"offer",format:"{0:N2}"},{title:"Oferta Desc.",width:"250px",field:"offerDescription"},{title:"Sug. Cliente",attributes:alignRight,headerAttributes:alignRight,width:"100px",field:"clientSuggested",format:"{0:N2}"},{title:"Observaciones",width:"250px",field:"observations"},{title:"Comentarios",width:"250px",field:"commentaries"},{title:"Usuario",width:"150px",field:"userName"},{title:"Fecha",width:140,field:"logDate",format:"{0:dd/MM/yyyy HH:mm}"},{title:"Acción",width:100,field:"logAction"}],dataSource:{data:n.prices}});$("#volume-prices-history-grid").kendoGrid({sortable:!0,scrollable:{height:200},selectable:"Single, Row",noRecords:{template:'<div class="w-100 text-center p-3">No hay histórico de precios por volumen para este producto.<\/div>'},columns:[{title:"Sucursal",width:"120px",field:"subsidiary.name"},{title:"Cantidad",attributes:alignRight,headerAttributes:alignRight,width:"80px",field:"quantity"},{title:"Precio",attributes:alignRight,headerAttributes:alignRight,width:"80px",field:"price",format:"{0:N2}"},{title:"Observaciones",width:"250px",field:"observations"},{title:"Usuario",width:"150px",field:"userName"},{title:"Fecha",width:140,field:"logDate",format:"{0:dd/MM/yyyy HH:mm}"},{title:"Acción",width:100,field:"logAction"}],dataSource:{data:n.volume}});u.open().center()})}function onDeletePhoto(){$("#Photo").attr("src",urlNoImage);$("#DeletePhoto").hide();$("#NewImageURL").val("None")}const marginGrid=30,alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},dateFormat="{0:dd-MM-yyyy}",priceVolumeTemplate=`<div class="row">
        <input id="pv-id-#:idSubsidiary#" type="hidden" value="#:id#" class="id" />
        <label for="pv-quantity-#:idSubsidiary#" class="col col-sm-2">Cantidad</label>
        <div class="col col-sm-4">
            <input id="pv-quantity-#:idSubsidiary#" name="pv-quantity-#:idSubsidiary#" type="number" value="#:quantity#" min="0" class="quantity form-control" />
        </div>
        <label for="pv-price-#:idSubsidiary#" class="col col-sm-2">Precio</label>
        <div class="col col-sm-4">
            <input id="pv-price-#:idSubsidiary#" name="pv-price-#:idSubsidiary#" class="price form-control" type="number" value="#:price#" min="0" />
        </div>
    </div>
    <div class="row">
        <label for="pv-observations-#:idSubsidiary#" class="col-12 col-sm-2">Observaciones</label>
        <div class="col col-sm-10">
            <textarea name="pv-observations-#:idSubsidiary#" class="form-control observations" id="pv-observations-#:idSubsidiary#" rows="3" cols="20" data-val="true" data-val-length-max="255" data-val-length="No debe exceder los 255 caracteres.">#:observations#</textarea>
        </div>
    </div>
    <div class="row">
        <div class="col text-right mt-3 mb-3">
            <button class="per-update btn btn-light cancel-volume-price" role="button" type="button">Cancelar</button>&nbsp;
            <button class="per-update btn btn-secondary save-volume-price" role="button" type="button">Guardar</button>
        </div>
    </div>`,lotTemplate=`<div class="row">
        <input id="Id" name="Id" type="hidden" value="#:id#" />
        <input id="IdProduct" name="IdProduct" type="hidden" value="#:idProduct#" />
        <label for="InitialQuantity" class="control-label col-2">Cantidad Inicial</label>
        <div class="col-4">
            <input id="InitialQuantity" name="InitialQuantity" type="number" value="#:initialQuantity#" min="0" />
        </div>
        <label for="Quantity" class="control-label col-2">Cantidad</label>
        <div class="col-4">
            <input id="Quantity" name="Quantity" type="number" value="#:quantity#" min="0" />
        </div>
    </div>
    <div class="row">
        <label for="InitialDate" class="control-label col-2">Desde</label>
        <div class="col-4">
            <input id="InitialDate" name="InitialDate" type="date" />
        </div>
        <label for="FinalDate" class="control-label col-2">Hasta</label>
        <div class="col-4">
            <input id="FinalDate" name="FinalDate" type="date" />
        </div>
    </div>
    <div class="row">
        <label for="Accelerator" class="control-label col-2">Acelerador</label>
        <div class="col-4">
            <input id="Accelerator" name="Accelerator" type="number" value="#:accelerator#" min="0" />
        </div>
        <div class="col-4">
            <div class="custom-control custom-switch">
                <input id="AccEnabled" name="AccEnabled" type="checkbox" class="custom-control-input selected" />
                <label class="custom-control-label" for="AccEnabled"> Habilitado</label>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col text-right pr-3 pb-3">
            <button tabindex="0" class="per-update btn btn-light" id="cancel-lot" role="button" aria-disabled="false" type="button" data-role="button">Cancelar</button>&nbsp;&nbsp;
            <button tabindex="0" class="per-update btn btn-secondary" id="save-lot" role="button" aria-disabled="false" type="button" data-role="button">Guardar</button>
        </div>
    </div>`;var _intId=0,_minDate,_maxDate;$(()=>setupControls());$(window).resize(()=>setGridHeight("Listado",marginGrid));$("#filter-box").on("hidden.bs.collapse",()=>setGridHeight("Listado",marginGrid));$("#filter-box").on("shown.bs.collapse",()=>setGridHeight("Listado",marginGrid));$("#Listado").on("click",".action-edit, .new-product",onProductEdit);$("#Listado").on("click",".action-delete",onProductDelete);$("#Listado").on("click",".action-sync",onProductSync);$("#Listado").on("click",".action-prices",onGettingPriceHistory);$("#action-clean").click(()=>cleanFilters());$("#action-filter").click(()=>filterData());$("#Detail").on("click",".new-offer, .edit-offer, .delete-offer",onOfferEdit);$("#Detail").on("click",".cancel-offer, .save-offer",onOfferSave);$("#Detail").on("click",".new-volume-price, .edit-volume-price, .delete-volume-price",onEditVolumePrice);$("#Detail").on("click",".cancel-volume-price, .save-volume-price",onVolumePriceSave);$("#save-product").click(onProductSave);$("#cancel-product, #back-list").click(onProductCancel);$("#Detail").on("click","#DeletePhoto",onDeletePhoto);$("#action-excel").click(()=>ExportExcel());$("#Detail").on("click",".new-lot, .edit-lot, .delete-lot",onLotEdit);$("#Detail").on("click","#cancel-lot, #save-lot",onLotSave);