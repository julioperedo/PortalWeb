function setupControls(){$.get(urlGetRelatedCategories,{},function(n){n.message===""?$("#categories").kendoGrid({sortable:!0,columns:[{title:"Categoría",field:"category"},{title:"Relacionada",field:"related"},{title:" ",attributes:alignCenter,width:80,sortable:!1,headerAttributes:alignCenter,sticky:!0,headerTemplate:'<i class="fas fa-plus action action-link action-new" title="Nuevo"><\/i>',template:n=>`<a class="action action-link action-edit" data-id="${n.id}"><i class="fas fa-pen" title="Editar"></i></a><a class="action action-link action-delete"><i class="fas fa-trash-alt" title="Eliminar"></i></a>`}],sortable:!0,selectable:"Single, Row",noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataSource:new kendo.data.DataSource({data:n.items,schema:{model:{id:"id"}}}),dataBound:n=>n.sender.element.find("table").attr("style","")}):(console.error(n.message),showError("Se ha producido un error al traer los Categorias relacionadas"))});$.get(urlGetRelatedProducts,{},function(n){n.message===""?$("#products").kendoGrid({sortable:!0,columns:[{title:"Cod. Prod.",field:"productCode",width:150},{title:"Producto",field:"productName"},{title:"Cod. Rel.",field:"relatedCode",width:150},{title:"Relacionado",field:"relatedName"},{title:" ",attributes:alignCenter,width:80,sortable:!1,headerAttributes:alignCenter,sticky:!0,headerTemplate:'<i class="fas fa-plus action action-link action-new" title="Nuevo"><\/i>',template:()=>`<a class="action action-link action-edit"><i class="fas fa-pen" title="Editar"></i></a><a class="action action-link action-delete"><i class="fas fa-trash-alt" title="Eliminar"></i></a>`}],sortable:!0,selectable:"Single, Row",noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataSource:new kendo.data.DataSource({data:n.items,schema:{model:{id:"id"}}}),dataBound:n=>n.sender.element.find("table").attr("style","")}):(console.error(n.message),showError("Se ha producido un error al traer los Categorias relacionadas"))});$.get(urlGetBanners,{},function(n){if(n.message===""){var t=n.items;t.forEach(function(n){n.initialDate=JSON.toDate(n.initialDate);n.finalDate&&(n.finalDate=JSON.toDate(n.finalDate))});$("#banners").kendoGrid({sortable:!0,columns:[{title:"Nombre",field:"name"},{title:"Desde",field:"initialDate",format:"{0:dd-MM-yyyy}",attributes:alignCenter,headerAttributes:alignCenter,width:120},{title:"Hasta",field:"finalDate",format:"{0:dd-MM-yyyy}",attributes:alignCenter,headerAttributes:alignCenter,width:120},{field:"imageUrl",title:" ",attributes:alignCenter,width:30,template:n=>$.trim(n.imageUrl)!==""?'<i class="fas fa-image" title="Tiene Imagen"><\/i>':""},{title:"Habilitado",attributes:alignCenter,headerAttributes:alignCenter,width:100,template:n=>n.enabled?'<i class="fas fa-check"><\/i>':"",field:"enabled"},{title:" ",attributes:alignCenter,width:80,sortable:!1,headerAttributes:alignCenter,sticky:!0,headerTemplate:'<i class="fas fa-plus action action-link action-new" title="Nuevo"><\/i>',template:()=>`<a class="action action-link action-edit"><i class="fas fa-pen" title="Editar"></i></a><a class="action action-link action-delete"><i class="fas fa-trash-alt" title="Eliminar"></i></a>`}],sortable:!0,selectable:"Single, Row",noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataSource:new kendo.data.DataSource({data:n.items,schema:{model:{id:"id"}}}),dataBound:n=>n.sender.element.find("table").attr("style",""),detailInit:function(n){n.detailCell.append(`<div class="custom-tab">
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item"><a class="nav-link active show" data-toggle="tab" href="#tab-items-${n.data.id}" role="tab" aria-selected="true">Items</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-triggers-${n.data.id}" role="tab">Disparadores</a></li>
    </ul>
    <div class="tab-content">
        <div id="tab-items-${n.data.id}" class="tab-pane active show pt-3" role="tabpanel">
            <div id="items-${n.data.id}"></div>
        </div>
        <div id="tab-triggers-${n.data.id}" class="tab-pane pt-3" role="tabpanel">
            <div id="triggers-${n.data.id}"></div>
        </div>
    </div>
</div>`);$.get(urlGetBannerDetail,{Id:n.data.id},function(t){t.message===""?($(`#items-${n.data.id}`).kendoGrid({sortable:!0,selectable:"Single, Row",noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataBound:n=>n.sender.element.find("table").attr("style",""),columns:[{title:"Cod.",field:"productCode",width:150},{title:"Producto",field:"productName"},{title:"Sucursal",field:"subsidiaryName"},{title:"Precio",field:"price",format:"{0:N2}",width:100,attributes:alignRight,headerAttributes:alignRight},{title:" ",attributes:alignCenter,width:80,sortable:!1,headerAttributes:alignCenter,sticky:!0,headerTemplate:`<a class="action action-link action-new-item" data-id="${n.data.id}" title="Nuevo"><i class="fas fa-plus"></i></a>`,template:()=>`<a class="action action-link action-edit-item"><i class="fas fa-pen" title="Editar"></i></a><a class="action action-link action-delete-item"><i class="fas fa-trash-alt" title="Eliminar"></i></a>`}],dataSource:new kendo.data.DataSource({data:t.items,schema:{model:{id:"id"}}})}),$(`#triggers-${n.data.id}`).kendoGrid({sortable:!0,selectable:"Single, Row",noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataBound:n=>n.sender.element.find("table").attr("style",""),columns:[{title:"Cod.",field:"productCode",width:150},{title:"Producto",field:"productName"},{title:"Categoría",field:"category"},{title:"Todos",template:n=>$.trim(n.category)===""&&$.trim(n.productName)===""?'<i class="fas fa-check"><\/i>':"",attributes:alignCenter,headerAttributes:alignCenter,width:70},{title:" ",attributes:alignCenter,width:80,sortable:!1,headerAttributes:alignCenter,sticky:!0,headerTemplate:`<a class="action action-link action-new-trigger" data-id="${n.data.id}" title="Nuevo"><i class="fas fa-plus"></i></a>`,template:()=>`<a class="action action-link action-edit-trigger"><i class="fas fa-pen" title="Editar"></i></a><a class="action action-link action-delete-trigger"><i class="fas fa-trash-alt" title="Eliminar"></i></a>`}],dataSource:new kendo.data.DataSource({data:t.triggers,schema:{model:{id:"id"}}})})):(console.error(n.message),showError("Se ha producido un error al traer los datos del servidor"))})}})}else console.error(n.message),showError("Se ha producido un error al traer los Categorias relacionadas")});$.get(urlGetCategories,{},function(n){n.message===""?($("#category-name").kendoDropDownList({dataTextField:"name",dataValueField:"name",optionLabel:"Seleccione una Categoría...",dataSource:{data:n.items}}),$("#related-name").kendoDropDownList({dataTextField:"name",dataValueField:"name",optionLabel:"Seleccione una Categoría...",dataSource:{data:n.items}}),$("#banner-trigger-category").kendoDropDownList({dataTextField:"name",dataValueField:"name",optionLabel:"Seleccione una Categoría...",dataSource:{data:n.items}})):console.error(n.message)});$.get(urlGetProducts,{},function(n){n.message===""?($("#product-name").kendoDropDownList({dataTextField:"fullName",dataValueField:"id",optionLabel:"Seleccione un Producto...",filter:"contains",virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.id===n.value));n.success(i)}},dataSource:{data:n.items}}),$("#related-product-name").kendoDropDownList({dataTextField:"fullName",dataValueField:"id",optionLabel:"Seleccione un Producto...",filter:"contains",virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.id===n.value));n.success(i)}},dataSource:{data:n.items}}),$("#banner-item-product").kendoDropDownList({dataTextField:"fullName",dataValueField:"id",optionLabel:"Seleccione un Producto...",filter:"contains",virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.id===n.value));n.success(i)}},dataSource:{data:n.items}}),$("#banner-trigger-product").kendoDropDownList({dataTextField:"fullName",dataValueField:"id",optionLabel:"Seleccione un Producto...",filter:"contains",virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.id===n.value));n.success(i)}},dataSource:{data:n.items}})):console.error(n.message)});$("#banner-enabled").kendoSwitch({enabled:!0,messages:{checked:"",unchecked:""}});var n=$("#banner-since").kendoDatePicker({format:"d/M/yyyy",change:function(){var n=this.value();n===null&&this.value("");t.min(n?n:_minDate)}}).data("kendoDatePicker"),t=$("#banner-until").kendoDatePicker({format:"d/M/yyyy",change:function(){var t=this.value();t===null&&this.value("");n.max(t?t:_maxDate)}}).data("kendoDatePicker");_maxDate=t.max();_minDate=n.min();$.get(urlGetSubsidiaries,{},function(n){n.message===""?$("#banner-item-subsidiary").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Producto...",filter:"contains",dataSource:{data:n.items}}):console.error(n.message)});$("#detail-category").kendoWindow({scrollable:!0,visible:!1,actions:["Close"],resizable:!1,title:"Categoría Relacionada",modal:!0,width:1e3,open:onRefreshWindow});$("#detail-product").kendoWindow({scrollable:!0,visible:!1,actions:["Close"],resizable:!1,title:"Producto Relacionado",modal:!0,width:800,open:onRefreshWindow});$("#detail-banner").kendoWindow({scrollable:!0,visible:!1,actions:["Close"],resizable:!1,title:"Banner",modal:!0,width:1e3,open:onRefreshWindow});$("#detail-banner-item").kendoWindow({scrollable:!0,visible:!1,actions:["Close"],resizable:!1,title:"Banner Item",modal:!0,width:700,open:onRefreshWindow});$("#detail-banner-trigger").kendoWindow({scrollable:!0,visible:!1,actions:["Close"],resizable:!1,title:"Banner Disparador",modal:!0,width:900,open:onRefreshWindow})}function onEditCategory(n){n.preventDefault();var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),t=i.dataItem($(n.currentTarget).closest("tr")),r=$("#detail-category").getKendoWindow();($(n.currentTarget).is(".action-new")||$(n.currentTarget).is(".action-edit"))&&($(n.currentTarget).is(".action-new")&&(t={id:0,category:"",related:""}),r.center().open(),$("#category-id").val(t.id),$("#category-name").getKendoDropDownList().value(t.category),$("#related-name").getKendoDropDownList().value(t.related));$(n.currentTarget).is(".action-delete")&&showConfirm(`¿Está seguro que desea eliminar la relación de la categor&iacute;a <b>${t.category}</b> con <b>${t.related}</b>? <br />Una vez realizada la acci&oacute;n no se puede revertir.`,function(){$.post(urlDeleteCategory,{Id:t.id},n=>{n.message===""?(showMessage("Se ha eliminado la relaci&oacute;n."),t=i.dataSource.get(t.id),i.dataSource.remove(t),i.refresh()):(console.error(data.message),showError("Se ha producido un error al eliminar la relaci&oacute;n."))})})}function onSavingCategory(n){n.preventDefault();var t=$("#category-name").getKendoDropDownList().value(),i=$("#related-name").getKendoDropDownList().value(),r={id:$("#category-id").val(),category:t,related:i},u=$(n.currentTarget).closest("form"),f=u.kendoValidator({messages:{required:""}}).data("kendoValidator");f.validate()&&$.post(urlSaveCategory,{Item:r},function(n){if(n.message===""){var r=$("#categories").getKendoGrid(),u={id:n.id,category:t,related:i};r.dataSource.pushUpdate(u);$("#detail-category").getKendoWindow().close()}else console.error(n.message),showError(`Se ha producido un error`)})}function onEditProduct(n){n.preventDefault();var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),t=i.dataItem($(n.currentTarget).closest("tr")),r=$("#detail-product").getKendoWindow();($(n.currentTarget).is(".action-new")||$(n.currentTarget).is(".action-edit"))&&($(n.currentTarget).is(".action-new")&&(t={id:0,idProduct:0,idRelated:0,productCode:"",productName:"",relatedCode:"",relatedName:""}),r.center().open(),$("#product-id").val(t.id),$("#product-name").getKendoDropDownList().value(t.idProduct),$("#related-product-name").getKendoDropDownList().value(t.idRelated));$(n.currentTarget).is(".action-delete")&&showConfirm(`¿Está seguro que desea eliminar la relación del producto <b>${t.productCode}</b> con <b>${t.relatedCode}</b>? <br />Una vez realizada la acci&oacute;n no se puede revertir.`,function(){$.post(urlDeleteProduct,{Id:t.id},n=>{n.message===""?(showMessage("Se ha eliminado la relaci&oacute;n."),t=i.dataSource.get(t.id),i.dataSource.remove(t),i.refresh()):(console.error(data.message),showError("Se ha producido un error al eliminar la relaci&oacute;n."))})})}function closeWindow(n){n.preventDefault();$(n.currentTarget).closest(".k-window-content").getKendoWindow().close()}function onSavingProduct(n){n.preventDefault();var i=$("#product-name").getKendoDropDownList().dataItem(),r=$("#related-product-name").getKendoDropDownList().dataItem(),t={id:$("#product-id").val(),idProduct:i.id,idRelated:r.id},u=$(n.currentTarget).closest("form"),f=u.kendoValidator({messages:{required:""}}).data("kendoValidator");f.validate()&&$.post(urlSaveProduct,{Item:t},function(n){if(n.message===""){var f=$("#products").getKendoGrid(),e=+t.id==0,u=f.dataSource;e?t.id=n.id:(t=u.get(t.id),t.idProduct=i.id,t.idRelated=r.id);t.productCode=i.itemCode;t.productName=i.name;t.relatedCode=r.itemCode;t.relatedName=r.name;u.pushUpdate(t);$("#detail-product").getKendoWindow().close()}else console.error(n.message),showError(`Se ha producido un error`)})}function onEditBanner(n){n.preventDefault();var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),t=i.dataItem($(n.currentTarget).closest("tr")),r=$("#detail-banner").getKendoWindow();($(n.currentTarget).is(".action-new")||$(n.currentTarget).is(".action-edit"))&&($(n.currentTarget).is(".action-new")&&(t={id:0,imageUrl:"",name:"",enabled:!0,initialDate:new Date,finalDate:null}),$("#banner-id").val(t.id),$("#banner-name").val(t.name),$("#banner-enabled").getKendoSwitch().check(t.enabled),$("#banner-since").getKendoDatePicker().value(t.initialDate),$("#banner-until").getKendoDatePicker().value(t.finalDate),$("#banner-url").attr("src",$.trim(t.imageUrl)===""?urlNoImage:`${urlImages}promobanner/${t.imageUrl}`),$("#old-photo").val(t.imageUrl),setTimeout(()=>r.center().open(),100));$(n.currentTarget).is(".action-delete")&&showConfirm(`¿Está seguro que desea eliminar el banner <b>${t.name}</b>? <br />Una vez realizada la acci&oacute;n no se puede revertir.`,function(){$.post(urlDeleteBanner,{Id:t.id},n=>{n.message===""?(showMessage("Se ha eliminado el banner."),t=i.dataSource.get(t.id),i.dataSource.remove(t),i.refresh()):(console.error(data.message),showError("Se ha producido un error al eliminar el banner."))})})}function onGalleryButtonClicked(){$("#gallery").val(null);$("#gallery").click()}function onPhotoRemoveClicked(){$("#banner-url").attr("src",urlNoImage);$("#new-photo").val("")}function onGalleryChanged(){if(this.files&&this.files[0]){var n=new FileReader;n.addEventListener("load",function(n){$("#banner-url").attr("src",n.target.result);n.target.result!==""&&$.post(urlSaveImageBase64,{ImageBase64:n.target.result},function(n){n.message!==""&&showError(n.message);$("#new-photo").val(n.fileName)})});n.readAsDataURL(this.files[0])}}function onSavingBanner(n){n.preventDefault();var t={id:+$("#banner-id").val(),name:$("#banner-name").val(),enabled:$("#banner-enabled").getKendoSwitch().check(),initialDate:kendo.toString($("#banner-since").getKendoDatePicker().value(),"yyyy-MM-dd"),finalDate:kendo.toString($("#banner-until").getKendoDatePicker().value(),"yyyy-MM-dd"),imageUrl:$("#new-photo").val()||$("#old-photo").val()};$.post(urlSaveBanner,{Item:t},function(i){if(i.message===""){var r=$("#banners").getKendoGrid(),u=r.dataSource;t.id=i.id;u.pushUpdate(t);$(n.currentTarget).closest(".k-window-content").getKendoWindow().close()}else console.error(i.message),showError("Se ha producido un error al guardar el banner.")})}function onEditBannerItem(n){n.preventDefault();var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),t=i.dataItem($(n.currentTarget).closest("tr")),r=$("#detail-banner-item").getKendoWindow();($(n.currentTarget).is(".action-new-item")||$(n.currentTarget).is(".action-edit-item"))&&($(n.currentTarget).is(".action-new-item")&&(t={id:0,idPromo:+n.currentTarget.dataset.id,idProduct:0,idSubsidiary:0,price:0}),$("#banner-item-id").val(t.id),$("#banner-id").val(t.idPromo),$("#banner-item-product").getKendoDropDownList().value(t.idProduct),$("#banner-item-subsidiary").getKendoDropDownList().value(t.idSubsidiary),$("#banner-item-price").val(t.price),setTimeout(()=>r.center().open(),100));$(n.currentTarget).is(".action-delete-item")&&showConfirm(`¿Está seguro que desea eliminar el item <b>${t.productCode}</b> en <b>${t.subsidiaryName}</b>? <br />Una vez realizada la acci&oacute;n no se puede revertir.`,function(){$.post(urlDeleteBannerItem,{Id:t.id},n=>{n.message===""?(showMessage("Se ha eliminado el item."),t=i.dataSource.get(t.id),i.dataSource.remove(t),i.refresh()):(console.error(data.message),showError("Se ha producido un error al eliminar el item."))})})}function onSavingBannerItem(n){n.preventDefault();var i=$("#banner-item-product").getKendoDropDownList().dataItem(),r=$("#banner-item-subsidiary").getKendoDropDownList().dataItem(),t={id:+$("#banner-item-id").val(),idPromo:+$("#banner-id").val(),idProduct:i.id,productCode:i.itemCode,productName:i.name,idSubsidiary:r.id,subsidiaryName:r.name,price:+$("#banner-item-price").val()};$.post(urlSaveBannerItem,{Item:t},function(i){if(i.message===""){var r=$(`#items-${t.idPromo}`).getKendoGrid(),u=r.dataSource;t.id=i.id;u.pushUpdate(t);$(n.currentTarget).closest(".k-window-content").getKendoWindow().close()}else console.error(i.message),showError("Se ha producido un error al guardar el item.")})}function onEditBannerTrigger(n){n.preventDefault();var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),t=i.dataItem($(n.currentTarget).closest("tr")),r=$("#detail-banner-trigger").getKendoWindow();($(n.currentTarget).is(".action-new-trigger")||$(n.currentTarget).is(".action-edit-trigger"))&&($(n.currentTarget).is(".action-new-trigger")&&(t={id:0,idPromo:+n.currentTarget.dataset.id,idProduct:0,category:""}),$("#banner-trigger-id").val(t.id),$("#banner-id").val(t.idPromo),$("#banner-trigger-product").getKendoDropDownList().value(t.idProduct),$("#banner-trigger-category").getKendoDropDownList().value(t.category),setTimeout(()=>r.center().open(),100));$(n.currentTarget).is(".action-delete-trigger")&&showConfirm(`¿Est&aacute; seguro que desea eliminar el disparador? <br />Una vez realizada la acci&oacute;n no se puede revertir.`,function(){$.post(urlDeleteBannerTrigger,{Id:t.id},n=>{n.message===""?(showMessage("Se ha eliminado el disparador."),t=i.dataSource.get(t.id),i.dataSource.remove(t),i.refresh()):(console.error(data.message),showError("Se ha producido un error al eliminar el disparador."))})})}function onSavingBannerTrigger(n){n.preventDefault();var i=$("#banner-trigger-product").getKendoDropDownList().dataItem(),r=$("#banner-trigger-category").getKendoDropDownList(),t={id:+$("#banner-trigger-id").val(),idPromo:+$("#banner-id").val(),idProduct:i?.id,productCode:i?.itemCode,productName:i?.name,category:r.value()};$.post(urlSaveBannerTrigger,{Item:t},function(i){if(i.message===""){var r=$(`#triggers-${t.idPromo}`).getKendoGrid(),u=r.dataSource;t.id=i.id;u.pushUpdate(t);$(n.currentTarget).closest(".k-window-content").getKendoWindow().close()}else console.error(i.message),showError("Se ha producido un error al guardar el trigger.")})}var _maxDate,_minDate,products=[],_lastRecieverGridHeight=null,_docId=-1;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},gridMargin=30,numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}";$(()=>setupControls());$("#categories").on("click",".action-new, .action-edit, .action-delete",onEditCategory);$("#cancel-category, #cancel-product, #cancel-banner, #cancel-banner-item, #cancel-banner-trigger").click(closeWindow);$("#save-category").click(onSavingCategory);$("#products").on("click",".action-new, .action-edit, .action-delete",onEditProduct);$("#save-product").click(onSavingProduct);$("#banners").on("click",".action-new, .action-edit, .action-delete",onEditBanner);$("#banners").on("click",".action-new-item, .action-edit-item, .action-delete-item",onEditBannerItem);$("#banners").on("click",".action-new-trigger, .action-edit-trigger, .action-delete-trigger",onEditBannerTrigger);$("label[for='banner-enabled']").click(()=>$("#banner-enabled").getKendoSwitch().toggle());$("#photo-gallery").click(onGalleryButtonClicked);$("#photo-remove").click(onPhotoRemoveClicked);$("#gallery").change(onGalleryChanged);$("#save-banner").click(onSavingBanner);$("#save-banner-item").click(onSavingBannerItem);$("#save-banner-trigger").click(onSavingBannerTrigger);