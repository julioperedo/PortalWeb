function setupControls(){var t,i,n;$("#detail").kendoWindow({title:"Registrar Solicitud de Productos",visible:!1,scrollable:!0,modal:!0,width:750,iframe:!1,activate:function(n){var t=this;setTimeout(()=>{onRefreshWindow(n),t.center()},300)}});t=$("#fil-since").kendoDatePicker({format:"d/M/yyyy",change:function(){var n=this.value();n===null&&this.value("");i.min(n?n:_minDate)}}).data("kendoDatePicker");i=$("#fil-until").kendoDatePicker({format:"d/M/yyyy",change:function(){var n=this.value();n===null&&this.value("");t.max(n?n:_maxDate)}}).data("kendoDatePicker");_maxDate=i.max();_minDate=t.min();var r={dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Producto...",filter:"contains",dataSource:new kendo.data.DataSource({data:products,group:{field:"line"}}),virtual:{itemHeight:45,valueMapper:productMapper},template:'<span class="k-state-default">#: data.name.replace(data.itemCode + " - ", "") #<p>#: data.itemCode #<\/p><\/span>'},u={dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",dataSource:{data:clients},virtual:{itemHeight:45,valueMapper:clientMapper},template:'<span class="k-state-default">#: data.name.replace(data.code + " - ", "") #<p>#: data.code #<\/p><\/span>'},f={dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una Sucursal...",filter:"contains"},e=$("#fil-product").kendoDropDownList(r).data("kendoDropDownList"),o=$("#IdProduct").kendoDropDownList(r).data("kendoDropDownList"),s=$("#fil-client").kendoDropDownList(u).data("kendoDropDownList"),h=$("#CardCode").kendoDropDownList(u).data("kendoDropDownList"),c=$("#fil-subsidiary").kendoDropDownList(f).data("kendoDropDownList"),l=$("#IdSubsidiary").kendoDropDownList(f).data("kendoDropDownList");$("#fil-reported").kendoDropDownList();n=[{title:"Producto",width:230,field:"productName",aggregates:["count"],groupHeaderTemplate:"Producto: #= value #    ( Total: #= count# )"},{title:"Cliente",field:"cardName",width:220,attributes:{"class":"text-nowrap"},aggregates:["count"],groupHeaderTemplate:"Cliente: #= value #    ( Total: #= count# )"},{title:"Sucursal",width:140,field:"subsidiaryName",aggregates:["count"],groupHeaderTemplate:"Solicitante: #= value #    ( Total: #= count# )"},{title:"Cantidad",field:"quantity",width:80,attributes:alignRight,headerAttributes:alignRight},{title:"Fecha",field:"requestDate",attributes:alignCenter,headerAttributes:alignCenter,width:90,format:dateFormat},{title:"Solicitante",width:160,field:"userName",aggregates:["count"],groupHeaderTemplate:"Solicitante: #= value #    ( Total: #= count# )"},{title:"Reportado",field:"reported",attributes:alignCenter,headerAttributes:alignCenter,width:60,template:n=>n.reported?'<i class="fas fa-check"><\/i>':"",sortable:!1}];permission>0&&n.push({title:" ",width:40,attributes:alignCenter,headerAttributes:alignCenter,template:checkTemplate,field:"id",sortable:!1,headerTemplate:'<div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input check-all" id="chk-all" name="check-all"><label class="custom-control-label" for="chk-all"><\/label><\/div>'});n.push({title:" ",width:50,sortable:!1,attributes:alignCenter,headerAttributes:alignCenter,sticky:!0,headerTemplate:'<a class="action action-link action-new" title="Nuevo"><i class="fas fa-plus"><\/i><\/a>',template:'<a class="action action-link action-edit" title="Editar"><i class="fas fa-pen"><\/i><\/a><a class="action action-link action-delete" title="Eliminar"><i class="fas fa-trash"><\/i><\/a>'});$("#Listado").kendoGrid({columns:n,groupable:{messages:{empty:"Arrastre un encabezado de columna y suelte acá para agrupar por esa columna"},enabled:!0},sortable:!0,selectable:"Single, Row",noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataSource:getDataSource([]),dataBound:function(n){var t=n.sender;t.columns.forEach((n,i)=>t.showColumn(i));$("div.k-group-indicator").each((n,i)=>t.hideColumn($(i).data("field")));t.element.find("table").attr("style","")}});$.get(urlProducts,{},n=>{products=Enumerable.From(n).OrderBy("$.line, $.name").ToArray(),e.setDataSource(new kendo.data.DataSource({data:products})),o.setDataSource(new kendo.data.DataSource({data:products}))});$.get(urlClients,{},n=>{clients=n,s.setDataSource(n),h.setDataSource(n)});$.get(urlSubsidiaries,{},n=>{n.message===""&&(c.setDataSource(n.items),l.setDataSource(n.items))});filterData()}function getDataSource(n){n.forEach(n=>n.requestDate=JSON.toDate(n.requestDate));return new kendo.data.DataSource({data:n,sort:[{field:"id",dir:"asc"}],schema:{model:{id:"id"}}})}function clientMapper(n){var t=clients||[],i=t.findIndex(t=>t.code===n.value);n.success(i)}function productMapper(n){var t=products||[],i=t.findIndex(t=>t.id===n.value);n.success(i)}function checkTemplate(n){var t="";return n.reported===!1&&(t=`<div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input check-one" id="chk-one-${n.id}" value="${n.id}"><label class="custom-control-label" for="chk-one-${n.id}"></label></div>`),t}function onCheckOne(){$("#action-email").toggleClass("d-none",$(".check-one:checked").length===0);$("#check-all").prop("checked",$(".check-one:checked").length===$(".check-one").length)}function onCheckAll(n){$(".check-one:not(:disabled)").length>0?($(".check-one:not(:disabled)").prop("checked",n.target.checked),$("#action-email").toggleClass("d-none",!n.target.checked)):n.target.checked=!1}function filterData(){var n=getFilters();n.message===""?$.get(urlFilter,n.data,function(n){n.message===""?loadGrid(n.items):(console.error(n.message),showError(`Ha ocurrido un error al traer los datos del servidor.`))}):showInfo(n.message)}function getFilters(){var u=$("#fil-product").data("kendoDropDownList").value(),f=$("#fil-subsidiary").data("kendoDropDownList").value(),e=$("#fil-client").data("kendoDropDownList").value(),n=$("#fil-since").data("kendoDatePicker").value(),t=$("#fil-until").data("kendoDatePicker").value(),i=$("#fil-reported").data("kendoDropDownList").value(),r="";return i!=="N"&(n==null||t==null)?r+="Debe seleccionar ambas fechas para poder realizar la búsqueda":(n&&(n=kendo.toString(n,"yyyy-MM-dd")),t&&(t=kendo.toString(t,"yyyy-MM-dd"))),{message:r,data:{ProductId:u,SubsidiaryId:f,CardCode:e,Since:n,Until:t,Reported:i}}}function loadGrid(n){var t=$("#Listado").data("kendoGrid"),i=getDataSource(n);t.setDataSource(i);n&&n.length>0?($("#filter-box").collapse("hide"),$("#action-excel").removeClass("d-none")):$("#action-excel").addClass("d-none");setTimeout(()=>setGridHeight("Listado",marginGrid),200)}function loadDetail(n){$("#Id").val(n.id);$("#IdUser").val(n.idUser);$("#RequestDate").val(kendo.toString(n.requestDate,"yyyy-MM-dd"));$("#Reported").val(n.reported);$("#IdSubsidiary").data("kendoDropDownList").value(n.idSubsidiary);$("#IdProduct").data("kendoDropDownList").value(n.idProduct);$("#CardCode").data("kendoDropDownList").value(n.cardCode);$("#Quantity").val(n.quantity);$("#Description").val(n.description);$("#detail").data("kendoWindow").open()}function onNew(){var n={id:0,idUser:0,requestDate:new Date,reported:!1,idProduct:0,idSubsidiary:0,cardCode:"",quantity:1,description:""};loadDetail(n)}function onEdit(n){var t=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),i=$(n.currentTarget).closest("tr"),r=t.dataItem(i);t.select(i);loadDetail(r)}function onSave(n){var i,r,t;n.preventDefault();i=$(this).closest("form");r=i.kendoValidator({messages:{required:""}}).data("kendoValidator");r.validate()&&(t=i.serializeObject(),$.post(urlEdit,{Item:t},function(n){if(n.message===""){t=n.item;t.productName=$("#IdProduct").data("kendoDropDownList").dataItem().name;var i=$("#CardCode").data("kendoDropDownList").dataItem();t.cardName=i.name.replace(i.code+" - ","");t.subsidiaryName=$("#IdSubsidiary").data("kendoDropDownList").text();t.requestDate=new Date(t.requestDate);$("#Listado").data("kendoGrid").dataSource.pushUpdate(t);$("#detail").data("kendoWindow").close()}else console.error(n.message),showError("Se ha producido un error al guardar los datos en el servidor.")}))}function onDelete(n){var t=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),i=t.dataItem(r);showConfirm(`¿Está seguro que desea eliminar la solicitud?`,function(){$.post(urlDelete,{Id:i.id},function(n){if(n.message===""){var r=t.dataSource;r.remove(i)}else console.error(n.message),showError(`Se ha producido un error al eliminar la solicitud.`)})})}function onSendingEmail(){var n=Enumerable.From($(".check-one:checked")).Select("+$.value").ToArray(),t=n.join();showConfirm(`¿Está seguro que desea enviar las solicitudes seleccinadas a sus respectivos Gerentes de Producto?`,function(){var i=$("#Listado").data("kendoGrid");$.post(urlSendEmail,{Ids:t},function(t){t.message===""?(n.forEach(n=>i.dataSource.remove(i.dataSource.get(n))),showMessage(`Se han enviado los correos exitosamente.`)):(console.error(t.message),showError(`Se ha producido un error al intentar enviar los correos.`))})})}const marginGrid=30,alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},dateFormat="{0:dd-MM-yyyy}";var _minDate,_maxDate,subsidiaries,products=[],clients=[];$(()=>setupControls());$("#action-filter").click(filterData);$("#Listado").on("click",".action-new",onNew);$("#Listado").on("click",".action-edit",onEdit);$("#Listado").on("click",".action-delete",onDelete);$("#Listado").on("click",".check-one",onCheckOne);$("#Listado").on("click",".check-all",onCheckAll);$("#save-request").click(onSave);$("#action-email").click(onSendingEmail);