function setupControls(){$("#id-line").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una Línea ...",dataSource:{transport:{read:{url:urlLines}}},change:function(){spreadsheet.activeSheet().range(kendo.spreadsheet.SHEETREF).clear();idLine=+this.value();var t=[],n=["","",""];priceGroups.forEach(t=>n.push(t.name));t.push(n);n=["Cod. Producto","Nombre Producto","Costo"];$.get(urlProducts,{LineId:idLine},function(i){groupLines=i.groups;products=i.products;priceGroups.forEach(t=>{var r=i.groups.find(n=>n.idGroup===t.id);n.push(r?.percentage??t.percentage??0)});t.push(n);i.products.forEach(n=>t.push([n.itemCode,n.name,n.cost]));spreadsheet.activeSheet().range(0,0,i.products.length+2,priceGroups.length+4).values(t);spreadsheet.activeSheet().range(2,3,i.products.length,priceGroups.length).formula("$C3*(100+D$2)/100/0.84");spreadsheet.activeSheet().range(2,2,i.products.length,priceGroups.length+2).format("#,##0.00");spreadsheet.activeSheet().range(`R0C0:R0C${priceGroups.length+3}`).background("#0059B2").color("#FFFFFF").textAlign("right");spreadsheet.activeSheet().range(1,0,1,3).background("#0059B2").color("#FFFFFF");spreadsheet.activeSheet().range(1,3,1,priceGroups.length).background("#BFDFFF");spreadsheet.activeSheet().range(0,0,2,priceGroups.length+3).fontSize(12).bold(!0);spreadsheet.activeSheet().range(2,2,products.length-1,2).background("#BFDFFF");spreadsheet.activeSheet().range(2,4,products.length-1,priceGroups.length-1).enable(!1)});$.get(urlGroupsByLine,{LineId:idLine},function(n){var t,i;selectedClients=n.clients;t=getClientsDS(n.clients);clientsGrid.setDataSource(t);i=new kendo.data.DataSource({data:n.groups});editGroup.setDataSource(i)})}});spreadsheet=$("#spreadsheet").kendoSpreadsheet({toolbar:!1,sheetsbar:!1,defaultCellStyle:{fontSize:11},rows:800,sheets:[{columns:[{width:190},{width:270},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75}]}]}).data("kendoSpreadsheet");editClient=$("#edit-client").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}},dataSource:{transport:{read:{url:urlClients}}}}).data("kendoDropDownList");editGroup=$("#edit-group").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una Lista...",filter:"contains",dataSource:[]}).data("kendoDropDownList");wndDetail=$("#detail-client").kendoWindow({visible:!1,modal:!0,iframe:!1,scrollable:!0,title:"Agregar Cliente a Lista de Precios",resizable:!1,width:700,actions:["Close"],activate:function(){var n=this;setTimeout(()=>n.center(),300)}}).data("kendoWindow");clientsGrid=$("#selected-clients").kendoGrid({columns:[{field:"groupName",title:"Lista",hidden:!0,aggregates:["count"],groupHeaderTemplate:"Lista: #= value #    ( Total: #= count# )"},{field:"cardName",title:"Cliente"},{field:"itemCode",title:" ",attributes:alignCenter,width:60,sortable:!1,headerAttributes:alignCenter,headerTemplate:'<a class="action action-link new-client" title="Adicionar Cliente"><i class="fas fa-plus"><\/i><\/a>',template:'<a class="action action-link action-delete" title="Eliminar Cliente"><i class="fas fa-trash-alt"><\/i><\/a>'}],sortable:!0,selectable:"Single, Row",scrollable:{height:"600px"},messages:{noRecords:'<div class="w-100 text-center p-3">No hay registros para el criterio de b&uacute;squeda.<\/div>'},dataSource:getClientsDS([])}).data("kendoGrid");$.get(urlGroups,{},function(n){if(n.message===""){priceGroups=n.items;var t=["","","","Precio Portal"];priceGroups.forEach(n=>t.push(n.name));spreadsheet.activeSheet().range(0,0,2,priceGroups.length+4).values([t,["Cod. Producto","Nombre Producto","Costo",""]])}});$.get(urlClients,{},function(n){clientsList=n})}function getClientsDS(n){return new kendo.data.DataSource({group:[{field:"groupName",dir:"asc",aggregates:[{field:"groupName",aggregate:"count"}]}],aggregate:[{field:"groupName",aggregate:"count"}],schema:{model:{id:"id"}},data:n})}function onSave(n){n.preventDefault();var t=[],i=[],r=[];spreadsheet.activeSheet().range(1,3,1,priceGroups.length).forEachCell(function(n,i,r){var e=priceGroups.at(i-3),f=e.id,u=groupLines.find(n=>n.idGroup===f);u||(u={id:0,idGroup:f,idLine:idLine,percentage:0});u.percentage=r.value;t.push(u)});spreadsheet.activeSheet().range(2,2,products.length-1,2).forEachCell(function(n,t,u){var f=products.at(n-2);t===2&&f.cost!=u.value&&i.push({id:f.id,cost:u.value});t===3&&f.price!=u.value&&r.push({id:f.idPrice??0,regular:u.value,idSudsidiary:1,idProduct:f.id})});$.post(urlSave,{Groups:t,Products:i,Prices:r},function(n){n.message==""?showMessage("Se guardaron los datos correctamente."):(console.error(n.message),showError("Se ha producido un error al guardar los datos."))})}function onNewClient(n){n.preventDefault();$("#id-line").data("kendoDropDownList").value()!=""&&wndDetail.open()}function onClientSave(n){var t,i;n.preventDefault();var r={messages:{required:"",customRule1:"Este cliente ya está asignado a alguna lista"},rules:{customRule1:function(){var n=editClient.value(),i=editGroup.value(),t=selectedClients.find(t=>t.cardCode==n);return t==undefined}}},u=$(this).closest("form"),f=u.kendoValidator(r).data("kendoValidator");f.validate()&&(t=editClient.value(),i=editGroup.value(),$.post(urlSaveClient,{CardCode:t,GroupLineId:i},function(n){if(n.message==""){var r={cardCode:t,cardName:editClient.text(),idGroupLine:i,groupName:editGroup.text()};selectedClients.push(r);clientsGrid.dataSource.add(r);wndDetail.close();showMessage("Se ha asignado el Cliente a la Lista correctamente")}else console.error(n.message),showError("Se ha producido un error al asignar el Cliente a la Lista")}))}function onDeleteClient(n){n.preventDefault();var t=clientsGrid.dataItem($(n.currentTarget).closest("tr"));showConfirm(`¿Está seguro que desea eliminar el Cliente <b>${t.cardName}</b>?`,function(){$.post(urlDeleteClient,{CardCode:t.cardCode,GroupLineId:t.idGroupLine},function(n){if(n.message==""){var i=selectedClients.findIndex(n=>n.cardCode==t.cardCode);selectedClients.splice(i,1);clientsGrid.dataSource.remove(t);showMessage("Se ha eliminado la asignación del Cliente correctamente.")}else console.error(n.message),showError("Se ha producido un error al eliominar la asignación del Cliente a la Lista")})})}var spreadsheet,priceGroups=[],products=[],groupLines=[],idLine=0,clientsList=[],wndDetail,selectedClients=[],editGroup,editClient,clientsGrid;const alignCenter={style:"text-align: center;"};$(()=>setupControls());$("#action-save-prices").click(onSave);$("#selected-clients").on("click",".new-client",onNewClient);$("#selected-clients").on("click",".action-delete",onDeleteClient);$("#save-client").click(onClientSave);