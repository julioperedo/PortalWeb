function setupControls(){_filClients=$("#fil-client").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",label:"Clientes",virtual:{itemHeight:26,valueMapper:clientMapper},dataSource:{data:_clients}}).data("kendoDropDownList");_filState.append(_states.map(n=>new Option(n.name,n.id)));_filState.multipleSelect();_filSince=$("#fil-since").kendoDatePicker({label:"Desde"}).data("kendoDatePicker");_filUntil=$("#fil-until").kendoDatePicker({label:"Hasta"}).data("kendoDatePicker");_filProduct=$("#fil-product");_since=$("#since").kendoDatePicker().data("kendoDatePicker");_until=$("#until").kendoDatePicker().data("kendoDatePicker");_product=$("#product").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Producto...",filter:"contains",dataSource:{data:[]},height:400,template:n=>`<img src="${n.imageURL?.trim()!=""?urlImages+n.imageURL:urlNoImage}" /><span class="desc"><h5>${n.name}</h5><p>Marca: ${n.brand}</p><p>Categor&iacute;a: ${n.category}</p></span>`,footerTemplate:'<div class="p-2">Total #: instance.dataSource.total() # items encontrados<\/div>'}).data("kendoDropDownList");$.get(urlClients,{},n=>{_clients=n,_filClients.setDataSource(n)});_gridItems=$("#list-items").kendoGrid({noRecords:{template:'<div class="w-100 text-center p-2">No existen resultados para el criterio de búsqueda.<\/div>'},scrollable:!0,sortable:!0,selectable:!0,columns:[{field:"cardName",title:"Cliente",width:120},{field:"itemCode",title:"Cod.Producto",width:100},{field:"productName",title:"Descripción",width:180,attributes:{"class":"no-wrap-column"}},{field:"initialDate",title:"Desde",width:90,attributes:_alignCenter,headerAttributes:_alignCenter,format:"{0:dd-MM-yyyy}"},{field:"finalDate",title:"Hasta",width:90,attributes:_alignCenter,headerAttributes:_alignCenter,format:"{0:dd-MM-yyyy}"},{field:"quantity",title:"Cantidad",width:80,attributes:_alignRight2,headerAttributes:_alignRight},{field:"stateName",title:"Estado",width:100,attributes:_alignCenter,headerAttributes:_alignCenter},{field:"comments",title:" ",attributes:_alignCenter,width:35,template:n=>n.comments!=null&&n.comments.trim()!=""?`<a class="comments action-link" title="${n.comments}"><i class="fas fa-comment-alt"></i></a>`:""},{field:"id",title:" ",attributes:_alignCenter,width:70,sortable:!1,headerAttributes:_alignCenter,headerTemplate:'<i class="fas fa-plus action action-link action-new" title="Nueva Solicitud Préstamo"><\/i>',template:function(n){var t=n.state!="R"?'disabled="disabled"':"",i=n.state!="R"?"action disabled":"action action-link action-delete";return`<a class="action action-link action-edit" title="Editar Solicitud de Préstamo"><i class="fas fa-pen"></i></a><a class="${i}" ${t} title="Eliminar Solicitud de Préstamo"><i class="fas fa-trash-alt"></i></a>`}}],dataSource:getDS([])}).data("kendoGrid");$.get(urlProducts,{},function(n){_product.setDataSource(n.items)});_wnd=$("#item-detail").kendoWindow({title:"Préstamo de Equipos",visible:!1,scrollable:!0,modal:!0,width:950,iframe:!1,activate:onRefreshWindow}).data("kendoWindow")}function onFilter(n){n.preventDefault();filterData()}function filterData(){let i=_filClients.value(),n=_filSince.value(),t=_filUntil.value(),r=_filState.multipleSelect("getSelects").map(n=>`'${n}'`).join(),u=_filProduct.val();n&&(n=kendo.toString(n,"yyyy-MM-dd"));t&&(t=kendo.toString(t,"yyyy-MM-dd"));$.get(urlFilter,{CardCode:i,StartDate:n,EndDate:t,StateCodes:r,Product:u},function(n){n.message==""?loadGrid(n.items):(console.error(n.message),showError("Se ha producido un error al traer los datos del servidor."))})}function onCleanFilters(n){n.preventDefault();cleanFilters()}function cleanFilters(){_filClients.value("");_filSince.value("");_filUntil.value("");_filState.multipleSelect("setSelects",[]);_filProduct.val("")}function getDS(n){return new kendo.data.DataSource({data:n,schema:{model:{id:"id"}}})}function loadGrid(n){if(n){n.forEach(function(n){n.requestDate=JSON.toDate(n.requestDate);n.initialDate=JSON.toDate(n.initialDate);n.finalDate=JSON.toDate(n.finalDate)});var t=getDS(n);_gridItems.setDataSource(t);n&&n.length>0&&$("#filter-box").collapse("hide");setTimeout(()=>setGridHeight("list-items",_gridMargin),200)}}function clientMapper(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}function onEdit(n){var t=_gridItems.dataItem($(this).closest("tr"));$(n.currentTarget).hasClass("action-delete")&&showConfirm(`¿Está seguro que desea eliminar la Solicitud del <b>${t.itemCode}</b>?`,function(){t&&$.post(urlDelete,{Id:t.id},function(n){n.message==""?(showMessage(`La Solicitud del <b>${t.itemCode}</b> ha sido eliminada con &eacute;xito.`),_gridItems.dataSource.pushDestroy(t)):showError(`Se ha producido un error al intentar eliminar la solicitud: <br/>${n.message}`)})});($(n.currentTarget).hasClass("action-new")||$(n.currentTarget).hasClass("action-edit"))&&($(n.currentTarget).hasClass("action-new")&&(t={id:0,idProduct:0,requestDate:new Date,quantity:1,initialDate:new Date,finalDate:new Date,state:"R",stateName:"En Creación",comments:"",idUser:_userCode,userName:_userName}),$("#Id").val(t.id),$("#IdUser").val(t.idUser),$("#RequestDate").val(kendo.toString(t.requestDate,"yyyy-MM-dd HH:mm:ss")),$("#State").val(t.state),_product.value(t.idProduct),$("#quantity").val(t.quantity),_since.value(t.initialDate),_until.value(t.finalDate),$("#comments").val(t.comments),$("#creator").text(`${t.userName} ( ${t.cardName} )`),$("#create-date").text(kendo.toString(t.requestDate,"dd-MM-yyyy HH:mm:ss")),$("#state-name").text(t.stateName),$("#save-detail").toggleClass("d-none",t.id!=0),$("#cancel-request").toggleClass("d-none",t.id==0||["D","F","C"].includes(t.state)||!_permission),$("#aprove-request").toggleClass("d-none",t.id==0||t.state!="R"||!_permission),$("#delivered-request").toggleClass("d-none",t.id==0||t.state!="A"||!_permission),$("#finish-request").toggleClass("d-none",t.id==0||t.state!="D"||!_permission),_wnd.center().open())}function onCancelEdit(n){n.preventDefault();_wnd.close()}function onSave(n){var i,r,t;n.preventDefault();i=$(this).closest("form");r=i.kendoValidator().data("kendoValidator");r.validate()&&(t={id:$("#Id").val(),idUser:$("#IdUser").val(),requestDate:$("#RequestDate").val(),state:$("#State").val(),idProduct:_product.value(),productName:_product.text(),quantity:$("#quantity").val(),initialDate:_since.value(),finalDate:_until.value(),comments:$("#comments").val(),userName:$("#creator").text(),stateName:$("#state-name").text(),cardCode:_cardCode,cardName:_cardName,itemCode:_product.dataItem().itemCode},t.initialDate&&(t.initialDate=kendo.toString(t.initialDate,"yyyy-MM-dd")),t.finalDate&&(t.finalDate=kendo.toString(t.finalDate,"yyyy-MM-dd")),$.post(urlEdit,{Item:t},function(n){n.message==""?(t.id=n.id,_gridItems.dataSource.pushUpdate(t),_wnd.close()):(console.error(n.message),showError(`Se ha producido un error al guardar los datos de la solicitud en el servidor.`))}))}function onChangeState(n){n.preventDefault();var i=n.currentTarget.id,t="R";i=="cancel-request"&&(t="C");i=="aprove-request"&&(t="A");i=="delivered-request"&&(t="D");i=="finish-request"&&(t="F");changeState(t)}function changeState(n){var t=$("#Id").val();$.post(urlChangeState,{Id:t,State:n},function(i){var r,u,f;i.message==""?(r="La solicitud ha sido aprobada.",u="Aprobada",n=="D"&&(r="El producto solicitado ha sido entregado.",u="Entregado"),n=="F"&&(r="El producto solicitado ha sido devuelto y la solicitud terminada.",u="Terminado y devuelto"),n=="C"&&(r="La solicitud ha sido cancelada.",u="Cancelada"),f=_gridItems.dataSource.get(t),f.state=n,f.stateName=u,_gridItems.dataSource.pushUpdate(f),showMessage(r),_wnd.close()):(console.error(i.message),showError(`Se ha producido un error al intentar cambiar el estado de la solicitud.<br />${i.message}`))})}const _gridMargin=20,_alignCenter={"class":"k-text-center !k-justify-content-center"},_alignRight={style:"text-align: right;"},_alignRight2={"class":"table-header-cell !k-text-right"},_userName=$("#username").val(),_userCode=$("#usercode").val(),_cardName=$("#cardname").val(),_cardCode=$("#cardcode").val(),_permission=$("#permission").val()=="Y",_states=[{id:"R",name:"Solicitado"},{id:"A",name:"Aprobado"},{id:"D",name:"Entregado"},{id:"F",name:"Terminado y devuelto"},{id:"C",name:"Cancelado"}];var _gridItems,_wnd,_clients=[],_filClients,_filSince,_filUntil,_filProduct=$("#fil-product"),_filState=$("#fil-state"),_product,_quantity=$("#quantity"),_since,_until,_comments=$("#comments");$(function(){setupControls();filterData()});$("#filter").click(onFilter);$("#clean-filters").click(onCleanFilters);$("#list-items").on("click",".action-new, .action-edit, .action-delete",onEdit);$("#cancel-detail").click(onCancelEdit);$("#save-detail").click(onSave);$(".change-state").click(onChangeState);