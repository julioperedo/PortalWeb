function setupControls(){var u=$("#Listado").kendoListView({bordered:!1,template:kendo.template($("#template").html())}).getKendoListView(),n,t,i,r;$("#Detail").kendoWindow({scrollable:!0,visible:!1,actions:["Close"],resizable:!1,title:"Documento de Producto",modal:!0,width:1e3,open:onRefreshWindow});$("#DetailReceiver").kendoWindow({scrollable:!0,visible:!1,actions:["Close"],resizable:!1,title:"Personas de Contacto",modal:!0,width:1200,open:onRefreshWindow,close:()=>$("#Receivers").data("kendoGrid").setOptions({height:_lastRecieverGridHeight})});$("#Emails").kendoWindow({scrollable:!0,visible:!1,actions:["Close"],resizable:!1,title:"Enviar Documentos a Clientes",modal:!0,width:1200,open:function(n){onRefreshWindow(n);n.sender.element.find(".k-listview-content").css("max-height",n.sender.wrapper.height()-180)}});$("#email-settings").kendoWindow({scrollable:!0,visible:!1,actions:["Close"],resizable:!1,title:"Configuraciones correo",modal:!0,width:800,open:onRefreshWindow});n=$("#typeIdc").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Tipo...",filter:"contains",dataSource:{data:[]}}).data("kendoDropDownList");t=$("#idLine").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una Línea...",filter:"contains",dataSource:{data:[]}}).data("kendoDropDownList");$("#idProduct").kendoDropDownList({dataSource:{serverFiltering:!0,transport:{read:{url:urlGetProducts,data:getProductFilter}}},cascadeFrom:"idLine",dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Producto...",filter:"contains",virtual:{itemHeight:26,valueMapper:productMapper}});$("#releaseDate").kendoDatePicker({format:"dd-MM-yyyy"});$("#enabled").kendoSwitch({messages:{checked:"",unchecked:""}});$("#description").kendoEditor({tools:["bold","italic","underline","strikethrough","fontSize","foreColor","backColor","justifyLeft","justifyCenter","justifyRight","justifyFull","insertUnorderedList","insertOrderedList","indent","outdent","createLink","unlink","insertImage","tableWizard","createTable","addRowAbove","addRowBelow","addColumnLeft","addColumnRight","deleteRow","deleteColumn","viewHtml","formatting","cleanFormatting"],imageBrowser:{fileTypes:"*.png,*.gif,*.jpg,*.jpeg",path:"productdocs/",transport:{read:{url:urlImageRead},uploadUrl:urlImageUpload,imageUrl:urlImage,destroy:{url:urlImageDestroy},create:{url:urlImageCreate},type:"filebrowser-aspnetmvc"}}});$("#files").kendoUpload({"async":{saveUrl:urlSaveFile,removeUrl:urlRemoveFile,autoUpload:!1},validation:{maxFileSize:41943040},success:function(n){var i=$("#filesData"),t=JSON.parse(i.val());n.operation==="upload"?n.files.forEach(n=>t.push({id:_docId--,fileURL:n.name,statusType:1})):n.files.forEach(n=>t=t.filter(t=>t.fileURL!==n.name||t.statusType!==1));i.val(JSON.stringify(t))}});i=`<div class="file-row">
    <div class="file-name">#=fileURL#</div>
    <div class="file-options">
        <a class="action action-link download-file" title="Descargar archivo"><i class="fas fa-download"></i></a> 
        <a class="action action-link delete-file" title="Eliminar archivo" data-id="#=id#"><i class="fas fa-trash"></i></a>
    </div>
</div>`;$("#fileList").kendoListView({bordered:!1,template:i});$("#enabled-receiver").kendoSwitch({messages:{checked:"",unchecked:""}});$("#id-client-receiver").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}},dataSource:{transport:{read:{url:urlGetClients}}}});r=`<div class="client-group">
    <div>
        <span class="client-title">#= data.value #</span> <span class="selector">Todos</span>
    </div>
    <div class="clients-list">
        # for (var i = 0; i < data.items.length; i++) { #
        <div class="client-item action #if(data.items[i].selected) {# selected #}#" data-id="#=data.items[i].id#">
            #=data.items[i].name# <i></i>
        </div>
        # } #
    </div>
</div>`;$("#available-docs").kendoListView({bordered:!1,template:'<div class="list-item action #if(selected) {# selected #}#" data-id="#=id#">#=name# <i><\/i><\/div>'});$("#available-clients").kendoListView({bordered:!1,template:r});$("#show-signature").kendoSwitch({messages:{checked:"",unchecked:""}});$("#mail-header").kendoEditor({tools:["bold","italic","underline","strikethrough","fontSize","foreColor","backColor","justifyLeft","justifyCenter","justifyRight","justifyFull","insertUnorderedList","insertOrderedList","indent","outdent","createLink","unlink","insertImage","tableWizard","createTable","addRowAbove","addRowBelow","addColumnLeft","addColumnRight","deleteRow","deleteColumn","viewHtml","formatting","cleanFormatting"],imageBrowser:{fileTypes:"*.png,*.gif,*.jpg,*.jpeg",path:"productdocs/",transport:{read:{url:urlImageRead},uploadUrl:urlImageUpload,imageUrl:urlImage,destroy:{url:urlImageDestroy},create:{url:urlImageCreate},type:"filebrowser-aspnetmvc"}}});$("#mail-footer").kendoEditor({tools:["bold","italic","underline","strikethrough","fontSize","foreColor","backColor","justifyLeft","justifyCenter","justifyRight","justifyFull","insertUnorderedList","insertOrderedList","indent","outdent","createLink","unlink","insertImage","tableWizard","createTable","addRowAbove","addRowBelow","addColumnLeft","addColumnRight","deleteRow","deleteColumn","viewHtml","formatting","cleanFormatting"],imageBrowser:{fileTypes:"*.png,*.gif,*.jpg,*.jpeg",path:"productdocs/",transport:{read:{url:urlImageRead},uploadUrl:urlImageUpload,imageUrl:urlImage,destroy:{url:urlImageDestroy},create:{url:urlImageCreate},type:"filebrowser-aspnetmvc"}}});$.get(urlGetTypes,{},t=>{var i=new kendo.data.DataSource({data:t});n.setDataSource(i)});$.get(urlGetLines,{},n=>{var i=new kendo.data.DataSource({data:n});t.setDataSource(i)});$.get(urlGetAvailableProducts,{},n=>{products=n;var t=new kendo.data.DataSource({data:n,group:{field:"lineName",dir:"asc"},schema:{model:{id:"id"}}});u.setDataSource(t)});$("#Documents").kendoGrid({sortable:!0,columns:[{title:"Tipo",field:"typeName",width:250,media:"lg"},{title:"Nombre",field:"name",width:550,media:"lg"},{title:"Fecha",field:"releaseDate",width:90,format:dateFormat,attributes:alignCenter,headerAttributes:alignCenter,media:"lg"},{title:"Habilitado",field:"enabled",attributes:alignCenter,headerAttributes:alignCenter,width:100,template:n=>n.enabled?'<i class="fas fa-check"><\/i>':"",media:"lg"},{title:"Detalles",media:"(max-width: 991px)",template:n=>`<table class="no-format"><tr><td>Tipo:</td><td>${n.typeName}</td></tr><tr><td>Nombre:</td><td>${n.name}</td></tr><tr><td>Fecha:</td><td>${kendo.toString(n.releaseDate,"dd-MM-yyyy")}</td></tr><tr><td>Habilitado:</td><td>${n.enabled?"Si":"No"}</td></tr></table>`},{title:" ",attributes:alignCenter,width:120,sortable:!1,headerAttributes:alignCenter,sticky:!0,headerTemplate:'<i class="fas fa-plus action action-link action-new" title="Nuevo"><\/i>',template:n=>`<a class="download-files action ${n.listDocumentFiles&&n.listDocumentFiles.length>0?"action-link":"disabled"}" title="Descargar Archivo" ${$.trim(n.fileURL)===""?'disabled="disabled"':""}><i class="fas fa-download"></i></a><a class="action action-link send-email" title="Enviar Documento por E-Mail"><i class="fas fa-envelope"></i></a><a class="action action-link action-edit"><i class="fas fa-pen" title="Editar"></i></a><a class="action ${_deletePremission?"action-link":"disabled"} action-delete" ${_deletePremission?"":'disabled="disabled"'}><i class="fas fa-trash-alt" title="Eliminar"></i></a>`}],sortable:!0,selectable:"Single, Row",noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataSource:getDataSource([],"Documents"),dataBound:n=>n.sender.element.find("table").attr("style","")});$("#Receivers").kendoGrid({sortable:!0,columns:[{title:"Nombre",field:"cardName",width:250,media:"lg"},{title:"Nombre",field:"name",width:280,media:"lg"},{title:"Correo",field:"eMail",width:240,media:"lg"},{title:"Habilitado",field:"enabled",attributes:alignCenter,headerAttributes:alignCenter,width:100,template:n=>n.enabled?'<i class="fas fa-check"><\/i>':"",media:"lg"},{title:" ",attributes:alignCenter,width:70,sortable:!1,headerAttributes:alignCenter,sticky:!0,headerTemplate:'<i class="fas fa-plus action action-link action-new" title="Nuevo"><\/i>',template:()=>'<a class="action action-link action-edit"><i class="fas fa-pen" title="Editar"><\/i><\/a><a class="action action-link action-delete"><i class="fas fa-trash-alt" title="Eliminar"><\/i><\/a>'}],sortable:!0,selectable:"Single, Row",noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataSource:getDataSource([],"Receivers"),dataBound:n=>n.sender.element.find("table").attr("style","")});setHeights()}function getProductFilter(n){var t=0,i="";return n.filter.filters.forEach(n=>{n.field==="id"?t=n.value:i=n.value}),{LineId:t,Filter:i}}function productMapper(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.id===n.value));n.success(i)}function setHeights(){$("#Listado .k-listview-content").height($(window).height()-104)}function onProductSelected(n){$(n.currentTarget).closest(".k-listview-content").find(".product").removeClass("selected");$(n.currentTarget).addClass("selected");var t=n.currentTarget.dataset.id;$.get(urlFilter,{IdProduct:t},n=>{n.message===""?(loadGrid(n.documents,"Documents"),loadGrid(n.receivers,"Receivers")):showError(n.message)})}function fixFolderUrl(){var n=$("#k-editor-image-url")[0];n&&/%2F/.test(n.value)&&(n.value=n.value.replace(/%2F/g,"/").replace(/%20/g," ").replace("productdocs/",""))}function loadGrid(n,t){var i=$("#"+t).data("kendoGrid");i.setDataSource(getDataSource(n,t))}function getDataSource(n,t){t==="Documents"&&n.forEach(n=>n.releaseDate=JSON.toDate(n.releaseDate));return new kendo.data.DataSource({data:n,sort:[{field:"id",dir:"asc"}],schema:{model:{id:"id"}}})}function onDownloadingFiles(n){n.preventDefault();var t=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),i=$(n.currentTarget).closest("tr"),r=t.dataItem(i);t.select(i);window.location.href=urlDownloadFiles+"?"+$.param({Id:r.id})}function onEditingDocument(n){var r,u,f;n.preventDefault();var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),t,e=$("#Detail").data("kendoWindow"),o=n.currentTarget.classList.contains("action-new");o?(i.clearSelection(),t={id:0,name:"",description:"",typeIdc:0,releaseDate:new Date,idLine:0,idProduct:0,fileURL:"",enabled:!0,listDocumentFiles:[]},r=$("div.product.selected"),r.length>0&&(u=r.data(),t.idProduct=u.id,t.idLine=u.idline)):(f=$(n.currentTarget).closest("tr"),i.select(f),t=i.dataItem(f));$("#id").val(t.id);$("#name").val(t.name);$("#description").getKendoEditor().value(formatHTMLSafe(t.description));$("#typeIdc").getKendoDropDownList().value(t.typeIdc);$("#releaseDate").getKendoDatePicker().value(t.releaseDate);$("#idLine").getKendoDropDownList().value(t.idLine);$("#idProduct").getKendoDropDownList().value(t.idProduct);$("#fileList").getKendoListView().setDataSource(new kendo.data.DataSource({data:t.listDocumentFiles,schema:{model:{id:"id"}}}));$("#filesData").val(JSON.stringify(t.listDocumentFiles));$("#enabled").getKendoSwitch().check(t.enabled);$("#files").data("kendoUpload").clearAllFiles();e.center().open()}function onDeletingDocument(n){n.preventDefault();var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),t=i.dataItem($(n.currentTarget).closest("tr"));showConfirm(`¿Está seguro que desea eliminar el documento <b>${t.name}</b> del producto <b>${t.productName}</b>? <br />Una vez realizada la acci&oacute;n no se puede revertir.`,function(){$.post(urlDelete,{Id:t.id},n=>{n.message===""?(showMessage("Se ha eliminado el documento."),t=i.dataSource.get(t.id),i.dataSource.remove(t),i.refresh()):(console.error(data.message),showError("Se ha producido un error al eliminar el documento."))})})}function onSavingDocument(n){var i,r,t;n.preventDefault();i=$(n.currentTarget).closest("form");r=i.kendoValidator({messages:{required:""}}).data("kendoValidator");r.validate()&&(t=i.serializeObject(),t.enabled=$("#enabled").getKendoSwitch().check(),t.listDocumentFiles=JSON.parse($("#filesData").val()),$.post(urlEdit,{Item:t},function(n){var u,i,f,e,r,o,s;n.message===""?(showMessage("Se realizaron los cambios correctamente."),loadGrid(n.items,"Documents"),u=products.find(n=>n.id===+t.idProduct),u||(i=$("#idProduct").getKendoDropDownList().text(),r=i.indexOf(" - "),f=i.substring(0,r+1),e=i.substring(r+3),products.push({id:t.idProduct,idLine:t.idLine,itemCode:f,lineName:$("#idLine").getKendoDropDownList().text(),name:e}),o=$("#Listado").getKendoListView(),s=new kendo.data.DataSource({data:products,group:{field:"lineName",dir:"asc"}}),o.setDataSource(s)),$("#Listado .product").removeClass("selected"),$("#Listado .product[data-id='"+t.idProduct+"']").addClass("selected"),$("#Detail").data("kendoWindow").close()):(console.error(data.message),showError("Se ha producido un error al guardar el documento."))}))}function onItemClicked(n){$(n.currentTarget).toggleClass("selected");$("#send-email").prop("disabled",$("#available-docs .list-item.selected").length===0||$("#available-clients .client-item.selected").length===0)}function onItemClicked2(n){$(n.currentTarget).toggleClass("selected");$("#send-email").prop("disabled",$("#available-docs .list-item.selected").length===0||$("#available-clients .client-item.selected").length===0)}function onAllItemClicked2(n){var t=$(n.currentTarget).closest(".client-group");t.find(".client-item").toggleClass("selected",t.find(".client-item").length!==t.find(".client-item.selected").length);$("#send-email").prop("disabled",$("#available-docs .list-item.selected").length===0||$("#available-clients .client-item.selected").length===0)}function onAllItemClicked(){var n=$("#available-clients");n.find(".client-item").toggleClass("selected",n.find(".client-item").length!==n.find(".client-item.selected").length);$("#send-email").prop("disabled",$("#available-docs .list-item.selected").length===0||$("#available-clients .client-item.selected").length===0)}function onDeletingFile(n){var r=n.currentTarget.dataset,t=JSON.parse($("#filesData").val()),i,u=$("#fileList").getKendoListView(),e=u.dataSource.get(r.id),f=+r.id;i=t.find(n=>n.id===f);i===1?t=t.filter(n=>n.id!==f):i.statusType=3;u.dataSource.remove(e);$("#filesData").val(JSON.stringify(t))}function onDownloaingFile(n){window.location.href=urlDownloadFile+"?"+$.param({FileName:$(n.currentTarget).closest(".file-row").find(".file-name").text()})}function onOpeningSendingConfig(n){var t=$(n.currentTarget),i=t.closest(".k-grid").data("kendoGrid"),r=t.closest("tr"),u=i.dataItem(r),f=$("#Emails").data("kendoWindow");i.select(r);$("#send-email").prop("disabled",!0);$.get(urlConfigMail,{Id:u.id,IdProduct:u.idProduct},n=>{n.message===""?($("#available-docs").getKendoListView().setDataSource(new kendo.data.DataSource({data:n.documents})),$("#available-clients").getKendoListView().setDataSource(new kendo.data.DataSource({data:n.receivers,group:{field:"cardName",dir:"asc"}})),$("#show-signature").data("kendoSwitch").check(!0),f.open()):(console.error(data.message),showError("Se ha producido un error al traer la configuración de los Correos."))})}function onSendingEmail(){var n=[],t=[],i=!1,r=$("#email-subject").val();$("#available-docs .list-item.selected").each((t,i)=>n.push(+i.dataset.id));$("#available-clients .client-item.selected").each((n,i)=>t.push(+i.dataset.id));i=$("#show-signature").data("kendoSwitch").check();$.get(urlSendMail,{Subject:r,DocumentIds:n.join(),ClientsIds:t.join(),WithSignature:i},n=>{n.message===""?(showMessage("Correo enviado exitosamente"),$("#Emails").data("kendoWindow").close()):(console.error(n.message),showError("Se ha producido un error al traer la configuración de los Correos."))})}function onOpenReceiversConfig(){$.get(urlAllReceivers,{},function(n){n.message===""?(loadGrid(n.items,"Receivers"),$("#receiver-form").addClass("d-none"),$("#DetailReceiver").data("kendoWindow").center().open()):showError("Se ha producido un error al traer los datos del servidor, por favor intente de nuevo y si el problema persiste comun&iacute;quese con soporte t&eacute;cnico.")})}function onEditingReceiver(n){var i,t,e,r,u,f;n.preventDefault();i=$(n.currentTarget).closest(".k-grid").data("kendoGrid");e=n.currentTarget.classList.contains("action-new");e?(i.clearSelection(),t={id:0,name:"",eMail:"",cardCode:"",cardName:"",enabled:!0},r=$("div.product.selected"),r.length>0&&(u=r.data(),t.idProduct=u.id,t.idLine=u.idline)):(f=$(n.currentTarget).closest("tr"),i.select(f),t=i.dataItem(f));$("#id-receiver").val(t.id);$("#name-receiver").val(t.name);$("#email-receiver").val(t.eMail);$("#id-client-receiver").getKendoDropDownList().value(t.cardCode);$("#enabled-receiver").getKendoSwitch().check(t.enabled);_lastRecieverGridHeight=_lastRecieverGridHeight?_lastRecieverGridHeight:$(n.currentTarget).closest(".k-grid").height();console.log(_lastRecieverGridHeight);i.setOptions({height:$("#DetailReceiver").height()-250});$("#receiver-form").removeClass("d-none")}function onDeletingReceiver(n){n.preventDefault();var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),t=i.dataItem($(n.currentTarget).closest("tr"));showConfirm(`¿Está seguro que desea eliminar el subscriptor <b>${t.name}</b>?`,function(){$.post(urlDeleteReceiver,{Id:t.id},n=>{n.message===""?(showMessage("Se ha eliminado el subscriptor."),t=i.dataSource.get(t.id),i.dataSource.remove(t),i.refresh()):(console.error(data.message),showError("Se ha producido un error al eliminar el subscriptor."))})})}function onSavingReceiver(n){var r,u,t,i;n.preventDefault();r=$(n.currentTarget).closest("form");u=r.kendoValidator({messages:{required:"",email:"no es un correo electrónico válido"}}).data("kendoValidator");u.validate()&&(t=r.serializeObject(),i={id:t["id-receiver"],cardCode:t["id-client-receiver"],name:t["name-receiver"],eMail:t["email-receiver"],enabled:$("#enabled-receiver").getKendoSwitch().check()},$.post(urlEditReceiver,{Item:i},n=>{if(n.message===""){showMessage("Se realizaron los cambios correctamente.");i.cardName=$("#id-client-receiver").getKendoDropDownList().text();var t=$("#Receivers").data("kendoGrid");t.dataSource.pushUpdate(i);$("#receiver-form").addClass("d-none");t.setOptions({height:_lastRecieverGridHeight})}else console.error(n.message),showError("Se ha producido un error al guardar el subscriptor.")}))}function onOpenMailConfig(){var n=$("#email-settings").data("kendoWindow");$.get(urlGetMailConfig,{},function(t){t.message===""?($("#mail-settings-id").val(t.item.id),$("#mail-header").data("kendoEditor").value(t.item.header),$("#mail-footer").data("kendoEditor").value(t.item.footer),n.open()):(console.error(data.message),showError("Se ha producido un error al traer la configuración de los Correos."))})}function onSavingMailSettings(){var n={Id:$("#mail-settings-id").val(),Header:$("#mail-header").data("kendoEditor").value(),Footer:$("#mail-footer").data("kendoEditor").value()};$.post(urlSaveMailConfig,{Item:n},function(n){n.message===""?(showMessage("Datos guardados exitosamente."),$("#email-settings").data("kendoWindow").close()):(console.error(data.message),showError("Se ha producido un error al traer la configuración de los Correos."))})}var _maxDate,_minDate,products=[],_lastRecieverGridHeight=null,_docId=-1;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},gridMargin=30,numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}";$(window).resize(setHeights);$(()=>setupControls());$("#Listado").on("click",".product",onProductSelected);$("#Documents").on("click",".action-new",onEditingDocument);$("#Documents").on("click",".action-edit",onEditingDocument);$("#Documents").on("click",".action-delete",onDeletingDocument);$("#Documents").on("click",".send-email",onOpeningSendingConfig);$("#Documents").on("click",".download-files",onDownloadingFiles);$("#fileList").on("click",".delete-file",onDeletingFile);$("#fileList").on("click",".download-file",onDownloaingFile);$("#save-document").click(onSavingDocument);$("#Receivers").on("click",".action-new",onEditingReceiver);$("#Receivers").on("click",".action-edit",onEditingReceiver);$("#Receivers").on("click",".action-delete",onDeletingReceiver);$("#save-receiver").click(onSavingReceiver);$(document).on("click",".k-imagebrowser>.k-filemanager-listview>.k-listview-content>.k-listview-item",fixFolderUrl);$("#available-docs").on("click",".list-item",onItemClicked);$("#available-clients").on("click",".client-item",onItemClicked2);$("#available-clients").on("click",".selector",onAllItemClicked2);$("#all-receivers").click(onAllItemClicked);$("#send-email").click(onSendingEmail);$("#open-mail-config").click(onOpenMailConfig);$("#save-mail-settings").click(onSavingMailSettings);$("#open-receivers-config").click(onOpenReceiversConfig);