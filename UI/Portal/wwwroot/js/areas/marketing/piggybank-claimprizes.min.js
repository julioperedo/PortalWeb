function setupPage(){_grdItems=$("#Listado").kendoGrid({noRecords:{template:'<div class="text-center w-100">No se encontraron registros para el criterio de b&uacute;squeda.<\/div>'},columns:[{title:"Usuario",field:"user"},{title:"Premio",field:"prize"},{title:"Fecha",field:"claimDate",width:100,attributes:alignCenter,headerAttributes:alignCenter,format:dateFormat},{title:"Cantidad",field:"quantity",width:85,attributes:alignRight,headerAttributes:alignRight,format:"{0:N0}"},{title:"Monedas",field:"points",width:85,attributes:alignRight,headerAttributes:alignRight,format:"{0:N0}"},{field:"id",title:" ",attributes:alignCenter,width:70,sortable:!1,headerAttributes:alignCenter,headerTemplate:'<a title="Nuevo Canje" class="action action-link action-new"><i class="fas fa-plus"><\/i><\/a>',template:'<a title="Editar Canje" class="action action-link action-edit"><i class="fas fa-pen"><\/i><\/a><a title="Eliminar Canje" class="action action-link action-delete"><i class="fas fa-trash-alt"><\/i><\/a>'}],sortable:!0,selectable:"Single, Row",dataSource:{schema:{model:{id:"id"}},data:[]}}).data("kendoGrid");filterData(!0);var n=function(n,t){$("#points-label").text(`${n*t} monedas`);$("#points").val(n*t)};_ddlUsers=$("#idUser").kendoDropDownList({dataSource:{transport:{read:{url:urlUsers}}},optionLabel:"Seleccione un Usuario",filter:"contains",dataTextField:"name",dataValueField:"id"}).data("kendoDropDownList");_ddlPrizes=$("#idPrize").kendoDropDownList({dataSource:{transport:{read:{url:urlPrizes}}},optionLabel:"Seleccione un Premio",filter:"contains",dataTextField:"name",dataValueField:"id",height:500,template:n=>`<div class="prize-item"><div class="picture"><img src="${urlPath}${n.imageUrl}" /></div><div><span class="name">${n.name}</span><br /><span class="coins">${n.points} monedas</span></div></div>`,change:function(t){n(_txtQuantity.value(),t.sender.dataItem().points)}}).data("kendoDropDownList");_txtQuantity=$("#quantity").kendoNumericTextBox({decimals:0,format:"N0",change:function(){n(this.value(),_ddlPrizes.dataItem().points)}}).data("kendoNumericTextBox");_dpDate=$("#claimDate").kendoDatePicker().data("kendoDatePicker");_wndDetail=$("#Detail").kendoWindow({width:550,title:"Detalle de Canje",visible:!1,modal:!0,activate:onRefreshWindow}).data("kendoWindow");_swEnabled=$("#enabled").kendoSwitch({messages:{checked:"",unchecked:""},size:"small"}).data("kendoSwitch")}function cleanFilters(){$("#filter").val("")}function getFilters(){var n=$("#filter").val();return{message:"",data:{FilterData:n}}}function filterData(n){var t=getFilters();t.message==""?$.get(urlFilter,t.data,function(n){loadGrid(n.items);n.message!=""&&showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`)}):(setGridHeight("Listado",_gridMargin),n||showInfo(`Se deben ingresar los siguientes campos: <br />${t.message}`))}function loadGrid(n){if(n){n.forEach(n=>n.claimDate=JSON.toDate(n.claimDate));var t=$("#Listado").data("kendoGrid"),i=new kendo.data.DataSource({data:n,schema:{model:{id:"id"}}});t.setDataSource(i);n&&n.length>0?($("#filter-box").collapse("hide"),$("#action-excel").removeClass("d-none")):$("#action-excel").addClass("d-none");setTimeout(()=>setGridHeight("Listado",_gridMargin),100)}}function onDelete(n){n.preventDefault();var t=_grdItems.dataItem($(n.currentTarget).closest("tr"));showConfirm(`¿Está seguro que desea eliminar el Canje de <b>${t.user}</b>?`,function(){$.post(urlDelete,{Id:t.id},function(n){n.message==""?(showMessage(`Se ha eliminado el Canje de <b>${t.user}</b> correctamente.`),_grdItems.dataSource.remove(t)):(console.error(n.message),showError("Se ha producido un error al intentar eliminar el Canje"))})})}function onEdit(n){var t,i;n.preventDefault();this.classList.contains("action-new")?(_grdItems.clearSelection(),t={id:0,idPrize:0,idUser:0,claimDate:new Date,quantity:1,points:0}):(i=$(n.currentTarget).closest("tr"),_grdItems.select(i),t=_grdItems.dataItem(i));$("#id").val(t.id);_ddlPrizes.value(t.idPrize);_ddlUsers.value(t.idUser);_txtQuantity.value(t.quantity);_dpDate.value(t.claimDate);$("#points").val(t.points);$("#points-label").text(`${t.points} monedas`);_wndDetail.center().open()}function onCancel(n){n.preventDefault();_wndDetail.close()}function onSave(n){var r,u,t,i;n.preventDefault();r=$(n.currentTarget).closest("form");u=r.kendoValidator().data("kendoValidator");u.validate()&&(t=r.serializeObject(),i=_ddlUsers.dataItem(),t.claimDate=kendo.toString(_dpDate.value(),"yyyy-MM-dd"),t.user=i.name,t.prize=_ddlPrizes.text(),i.points>=t.points?saveClaim(t):showConfirm(`El usuario <b>${i.name}</b> no tiene las monedas necesarios para realizar el canje, el usuario necesita <b>${t.points}</b> monedas y solamente tiene <b>${i.points}</b> acumuladas.<br /> ¿Desea continuar con el canje?`,function(){saveClaim(t)}))}function saveClaim(n){$.post(urlEdit,{Item:n},function(t){t.message==""?(_wndDetail.close(),showMessage("Se realizaron los cambios correctamente."),n.id=t.id,n.claimDate=_dpDate.value(),_grdItems.dataSource.pushUpdate(n)):showError(t.message)})}var _wndDetail,_grdItems,_ddlUsers,_ddlPrizes,_txtQuantity,_dpDate;const alignCenter={"class":"k-text-center !k-justify-content-center"},alignRight={style:"text-align: right;"},numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}",_gridMargin=30;$(()=>setupPage());$(window).resize(()=>setGridHeight("Listado",_gridMargin));$("#filter-box").on("hidden.bs.collapse",()=>setGridHeight("Listado",_gridMargin));$("#filter-box").on("shown.bs.collapse",()=>setGridHeight("Listado",_gridMargin));$("#action-clean").click(()=>cleanFilters());$("#action-filter").click(()=>filterData(!1));$("#Listado").on("click",".action-new, .action-edit",onEdit);$("#Listado").on("click",".action-delete",onDelete);$("#Detail").on("click",".action-cancel",onCancel);$("#Detail").on("click",".action-save",onSave);