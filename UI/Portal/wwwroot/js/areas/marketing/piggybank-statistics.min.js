function setupControls(){filterData()}function loadPivot(n,t){var i;_minPrize=t;i=$(window).height()-130;n.sort((n,t)=>n.date<t.date);var r=n.map(function(n){return{Serial:n.serialNumber,UsuarioId:n.idUser,Usuario:n.userName,Usuario2:`${n.idUser} - ${n.userName}`,Ciudad:n.city,Puntos:n.points,Producto:n.itemName,CodProducto:n.itemCode,CodCliente:n.cardCode,Cliente:n.cardName,Fecha:n.date,Tienda:n.storeName,Direccion:n.address,Correo:n.eMail,Telefono:n.phone,Fecha:kendo.toString(n.date,"yyyy-MM-dd"),Ano:n.date.getFullYear(),Mes:n.date.getMonth()+"-"+n.date.toLocaleString("default",{month:"long"}),Dia:n.date.getDate(),Trimestre:"Q"+n.quarter,Usado:n.usedPoints,TotalPuntos:n.totalPoints}});_loaded?_options=$("#pivot").pivotgrid("options"):(_options.pivot.rows=["Ciudad","Usuario2"],_options.pivot.columns=["Trimestre"],_options.pivot.values=[{field:"Puntos"},{field:"Usado"},{field:"TotalPuntos"}]);$.map(_options.pivot.xfields,function(n){n.state="opened"});_options.height=i;_options.data=r;$(".datagrid-row-selected, .datagrid-row-checked").removeClass("datagrid-row-checked").removeClass("datagrid-row-selected");$("#action-excel").toggleClass("d-none",r.length<=0);$("#pivot").pivotgrid(_options);_loaded=!0;resizePivot()}function loadCharts(n){var t=$(window).width()-$("#sidebar").width()-100;loadChartCityDistribution(n);loadChartCityTimeDistribution(n,t)}function loadChartCityDistribution(n,t){var i=Enumerable.From(n).GroupBy("{ city: $.city }",null,function(n,t){return{category:n.city,value:t.source.reduce((n,t)=>n+t.points,0)}},"$.city").ToArray();i.sort((n,t)=>t.value-n.value);$("#chartPerCity").kendoChart({title:{position:"bottom",text:"Distribución de monedas por Ciudad"},legend:{visible:!1},chartArea:{width:t},seriesDefaults:{type:"pie",startAngle:120},series:[{data:i,labels:{visible:!0,background:"transparent",position:"outsideEnd",template:"#=category#: #=kendo.toString(value, 'N0')#"}}],tooltip:{visible:!0,template:"#= category #: #=kendo.toString(value, 'N0')#"}})}function loadChartCityTimeDistribution(n,t){var i=[],r=Enumerable.From(n).Select("kendo.toString($.date, 'dd-MM-yyyy')").Distinct().ToArray();i=Enumerable.From(n).GroupBy("{ city: $.city }",null,function(n,t){var i=[];return r.forEach(n=>{i.push(Enumerable.From(t).Where(t=>kendo.toString(t.date,"dd-MM-yyyy")==n).Sum("$.points"))}),{name:n.city,data:i}},"$.city").ToArray();$("#timeDistribution").kendoChart({title:{text:"Registro de monedas por día"},legend:{position:"bottom"},chartArea:{background:"",width:t},seriesDefaults:{type:"line",style:"smooth"},series:i,valueAxis:{labels:{},line:{visible:!1},axisCrossingValue:-10},categoryAxis:{categories:r,majorGridLines:{visible:!1},labels:{rotation:"auto"}},tooltip:{visible:!0,template:"#=series.name# <br /> Fecha: #=category# <br /> Cantidad: #= value #"}})}function filterData(){$.ajaxSetup({cache:!1});var n=function(n){return{id:n.id,idUser:n.idUser,date:JSON.toDate(n.date),quarter:n.quarter,cardCode:n.cardCode,cardName:n.cardName,itemCode:n.itemCode,itemName:n.itemName,points:n.points,userName:n.userName,storeName:n.storeName,city:n.city,serialNumber:n.serialNumber,address:n.address,email:n.email,phone:n.phone,usedPoints:0,totalPoints:n.points,idPrize:0,prizeName:"",quantity:0}},t=function(n){return{id:n.id,idUser:n.idUser,date:JSON.toDate(n.date),quarter:n.quarter,cardCode:"",cardName:"",itemCode:"",itemName:"",points:0,userName:n.userName,storeName:n.storeName,city:n.city,serialNumber:"",address:n.address,email:n.email,phone:n.phone,usedPoints:n.points,totalPoints:-n.points,idPrize:n.idPrize,quantity:n.quantity,prizeName:n.prizeName}};$.get(urlFilter,{},function(i){var r=i.items.map(t=>n(t));loadCharts(r);i.claimed.forEach(function(n){r.push(t(n))});loadPivot(r,i.minPrize)})}function configLayoutPivot(n){n.preventDefault();$("#pivot").pivotgrid("layout")}function resizePivot(){var n=$(window).height()-$("h3.title").closest(".row").height()-150;$("#pivot").pivotgrid("resize",{height:n})}function exportExcel(){window.location.href=urlExport}var _loaded=!1,_minPrize=0,_options={pivot:{rows:[],columns:[],values:[],xfields:[{field:"Serial",state:"opened",op:"count"},{field:"Usuario",state:"opened"},{field:"UsuarioId",state:"opened"},{field:"Tienda",state:"opened"},{field:"Ciudad",state:"opened"},{field:"Fecha",state:"opened"},{field:"Ano",title:"Año",state:"opened"},{field:"Trimestre",state:"opened"},{field:"Mes",state:"opened"},{field:"Dia",state:"opened"},{field:"CodCliente",title:"Cod. Cliente",state:"opened"},{field:"Cliente",state:"opened"},{field:"CodProducto",title:"Cod. Producto",state:"opened"},{field:"Producto",state:"opened"},{field:"Direccion",state:"opened"},{field:"Correo",state:"opened"},{field:"Telefono",state:"opened"},{field:"Puntos",title:"Monedas",op:"sum",formatter:n=>kendo.toString(+n,"#,##0"),styler:function(n,t){return+n>=_minPrize&&!t.children?{style:"background-color: #75c169"}:{}}},{field:"Usado",state:"opened",op:"sum"},{field:"TotalPuntos",title:"Total Monedas",state:"opened",op:"sum"}]},forzenColumnTitle:'<span style="font-weight:bold">Detalle<\/span>',valueFormatter:function(n){return kendo.toString(+n,"#,##0")},valuePrecision:2,valueFieldWidth:100,showFooter:!0,FooterTitle:"TOTAL",showColumnsTotals:!0,i18n:{fields:"Campos",filters:"Filtros",rows:"Filas",columns:"Columnas",values:"Valores",ok:"Aceptar",cancel:"Cancelar"},onDblClickRow:function(){$(this).pivotgrid("unselectAll")},onBeforeLoad:function(){resizePivot()}};$(()=>{setupControls()});$(window).resize(resizePivot);$("#action-config").click(configLayoutPivot);$("#action-excel").click(exportExcel);