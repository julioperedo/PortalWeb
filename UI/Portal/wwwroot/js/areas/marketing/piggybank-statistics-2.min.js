function setupControls(){_tvMonths=$("#months-list").kendoTreeView({checkboxes:{checkChildren:!0},dataSource:getHDS([],"months"),dataTextField:["year","monthDesc"],check:function(n){var t=n.sender.dataItem(n.node),i,r;t.checked?t.hasChildren?(r=_months.find(n=>n.year==t.year),r.months.forEach(function(n){_selMonth.find(i=>i==`${t.year}-${n.month}`)||_selMonth.push(`${t.year}-${n.month}`)})):(i=n.sender.dataItem(n.sender.parent(n.node)),_selMonth.push(`${i.year}-${t.month}`)):t.hasChildren?(r=_months.find(n=>n.year==t.year),r.months.forEach(n=>_.remove(_selMonth,i=>i==`${t.year}-${n.month}`))):(i=n.sender.dataItem(n.sender.parent(n.node)),_.remove(_selMonth,n=>n==`${i.year}-${t.month}`));loadCharts()}}).data("kendoTreeView");_tvProducts=$("#product-list").kendoTreeView({checkboxes:{checkChildren:!0},dataSource:getHDS([],"months"),dataTextField:["line","code"],template:n=>n.item.id?`${n.item.code} - ${n.item.name}`:n.item.line,check:function(n){var t=n.sender.dataItem(n.node),i;t.checked?t.hasChildren?(i=_products.filter(n=>n.line==t.line),i.forEach(function(n){_selProduct.find(t=>t==n.itemCode)||_selProduct.push(n.itemCode)})):_selProduct.push(t.code):t.hasChildren?(i=_products.filter(n=>n.line==t.line),i.forEach(n=>_.remove(_selProduct,t=>t==n.itemCode))):_.remove(_selProduct,n=>n==t.code);loadCharts()}}).data("kendoTreeView");filterData()}function filterData(){$.ajaxSetup({cache:!1});var n=function(n){var t=JSON.toDate(n.date),i=_products.find(t=>$.trim(t.itemCode.toLowerCase())==$.trim(n.itemCode.toLowerCase()));return i||console.log("Item malo",n.itemCode),{id:n.id,idUser:n.idUser,date:t,quarter:Math.floor((t.getMonth()+3)/3),cardCode:n.cardCode,itemCode:n.itemCode,points:n.points,userName:n.userName,storeName:n.storeName,city:n.city,month:`${t.getFullYear()}-${t.getMonth()+1}`,line:i?.line??""}};$.get(urlFilter,{},function(t){var i=Enumerable.From(t.products).GroupBy("$.line").Select("{ line: $.Key(), products: $.Select('{ id: $.id, code: $.itemCode, name: $.name }').ToArray() }").ToArray(),r;_tvProducts.setDataSource(getHDS(i,"products"));_products=t.products;_clients=t.clients;_items=t.items.map(t=>n(t));i=Enumerable.From(_items).Select("{ year: $.date.getFullYear(), month: $.date.getMonth() + 1, monthDesc: $.date.toLocaleString('es-BO', { month: 'long' }).toTitleCase() }").Distinct("$.year, $.month").OrderBy("$.year, $.month").ToArray();r=Enumerable.From(i).GroupBy("$.year").Select("{ year: $.Key(), months: $.Select('{ month: $.month, monthDesc: $.monthDesc }').ToArray() }").ToArray();_months=r;_tvMonths.setDataSource(getHDS(r,"months"))})}function getHDS(n,t){return new kendo.data.HierarchicalDataSource({data:n,schema:{model:{children:t}}})}function loadCharts(){var n=_items.filter(n=>_selMonth.includes(n.month)&&_selProduct.includes(n.itemCode)),u,t,i,f,e,o,r;if(console.log("items",n),n.length>0){u=Enumerable.From(n).GroupBy("$.city","$",(n,t)=>Object.assign({},{name:n,y:Enumerable.From(t.source).Sum("$.points")})).ToArray();Highcharts.chart("resume-by-city",{credits:!1,chart:{type:"pie"},title:{text:"Resumen de monedas por ciudad"},tooltip:{pointFormat:"Total: <b>{point.y:,f} ( {point.percentage:.2f} % )<\/b>"},plotOptions:{series:{allowPointSelect:!0,cursor:"pointer",dataLabels:[{enabled:!0,distance:20,style:{fontSize:"0.9em"}},{enabled:!0,distance:-40,format:"{point.y:,f}",style:{textOutline:"none",opacity:.7,style:{fontSize:"1em"}},filter:{operator:">",property:"percentage",value:4}}]}},series:[{name:"Monedas",colorByPoint:!0,data:u}]});var s=Enumerable.From(n).Select(n=>`${n.date.getFullYear()}<br />${n.date.toLocaleString("es-BO",{month:"long"}).toTitleCase()}`).Distinct().ToArray(),h=Enumerable.From(_products).Where(n=>_selProduct.includes(n.itemCode)).Select("$.line").Distinct().ToArray(),c=h.map(function(t){var i=[],r=Enumerable.From(n).Select(n=>`${n.date.getFullYear()}-${n.date.getMonth()+1}`).Distinct().ToArray();return r.forEach(function(r){i.push(Enumerable.From(n).Where(`$.line == '${t}' && $.month == '${r}'`).Sum("$.points"))}),{name:t,data:i}});Highcharts.chart("resume-by-month",{credits:!1,chart:{type:"column"},title:{text:"Productos escaneados"},xAxis:{categories:s,crosshair:!0,accessibility:{description:"Meses"}},yAxis:{min:0,title:{text:""}},plotOptions:{column:{pointPadding:.2,borderWidth:0}},series:c});t=Enumerable.From(n).GroupBy("$.itemCode","$",(n,t)=>Object.assign({},{name:n,y:t.source.length})).OrderByDescending("$.y").Take(10).ToArray();i=t.map(n=>Object.assign({},{name:n.name,data:[n.y]}));console.log("TOP",t,i);Highcharts.chart("top-skus",{credits:!1,chart:{type:"bar"},title:{text:"Productos mÃ¡s vendidos (TOP 10)"},xAxis:{categories:[""],crosshair:!0},yAxis:{min:0,title:{text:""}},plotOptions:{column:{pointPadding:.2,borderWidth:0}},series:i});f=Enumerable.From(n).GroupBy("$.userName","$",(n,t)=>Object.assign({},{name:n,points:Enumerable.From(t.source).Sum("$.points")})).OrderByDescending("$.points").Take(10).ToArray();e=f.map(n=>Object.assign({},{name:n.name,data:[n.points]}));Highcharts.chart("resume-top-by-user",{credits:!1,chart:{type:"bar"},title:{text:"TOP 10 Usuarios"},xAxis:{categories:[""],crosshair:!0},yAxis:{min:0,title:{text:""}},tooltip:{valueSuffix:" monedas"},plotOptions:{column:{pointPadding:.2,borderWidth:0}},series:e});o=function(n){var t=_clients.find(t=>t.cardCode==n);return t?.cardName??""};r=Enumerable.From(n).GroupBy("$.cardCode","$",(n,t)=>Object.assign({},{name:o(n),y:t.source.length})).OrderByDescending("$.y").ToArray();console.log("Resume Clients",r);Highcharts.chart("resume-top-by-client",{credits:!1,chart:{type:"pie",height:600},title:{text:"Resumen de items por Cliente"},tooltip:{pointFormat:"Total: <b>{point.y:,f} ( {point.percentage:.2f} % )<\/b>"},plotOptions:{series:{allowPointSelect:!0,cursor:"pointer",showInLegend:!0,dataLabels:[{enabled:!0,distance:-40,format:"{point.y:,f}",style:{textOutline:"none",opacity:.7,style:{fontSize:"1.5em"}},filter:{operator:">",property:"percentage",value:4}}]}},series:[{name:"Total",colorByPoint:!0,data:r}]})}}var _items,_months,_products,_clients,_tvMonths,_tvProducts,_selMonth=[],_selProduct=[];$(()=>{setupControls()});