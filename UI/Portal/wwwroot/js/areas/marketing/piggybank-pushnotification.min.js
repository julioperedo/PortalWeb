function setupControls(){var n=new Date,r=n,t=$("#filter-initial-date").kendoDatePicker({value:r,change:function(){var n=this.value();n==null&&this.value("");i.min(n?n:_minDate)}}).data("kendoDatePicker"),i=$("#filter-final-date").kendoDatePicker({value:n,change:function(){var n=this.value();n==null&&this.value("");t.max(n?n:_maxDate)}}).data("kendoDatePicker");_maxDate=i.max();_minDate=t.min();wndDetail=$("#Detail").kendoWindow({visible:!1,width:750,title:"Mensaje",modal:!0,close:function(){$("#msg-title").val("");$("#msg-body").val("")}}).data("kendoWindow");grdItems=$("#Listado").kendoGrid({noRecords:{template:'<div class="w-100 text-center p-3">No hay resultados para el criterio de búsqueda.<\/div>'},columns:[{title:"Título",minScreenWidth:150,field:"title"},{title:"Enviado",attributes:alignCenter,headerAttributes:alignCenter,width:140,field:"date",format:"{0:dd-MM-yyyy HH:mm}"},{field:"id",title:" ",attributes:alignCenter,width:50,sortable:!1,headerAttributes:alignCenter,headerTemplate:'<i class="fas fa-plus action action-link action-new" title="Nuevo Mensaje"><\/i>',template:'<i class="fas fa-pen action action-link action-edit" title="Editar Mensaje"><\/i>'}],sortable:!0,selectable:"Single, Row",dataSource:[]}).data("kendoGrid");kufiles=$("#files").kendoUpload({"async":{saveUrl:urlSaveFile,removeUrl:urlRemoveFile},multiple:!1,validation:{maxFileSize:41943040},success:function(){}}).data("kendoUpload");ddlType=$("#msg-type").kendoDropDownList({change:function(n){var t=$(n.sender.element).val();$("#divTopics").toggleClass("d-none",t!="T");$("#divUsers").toggleClass("d-none",t!="U")},dataTextField:"Text",dataValueField:"Value",value:"A",dataSource:[{Text:"Todos",Value:"A",Selected:!0},{Text:"Por Usuario",Value:"U"}]}).data("kendoDropDownList");ddlUsers=$("#msg-users").kendoMultiSelect({dataTextField:"fullName",dataValueField:"id",placeholder:"Seleccione destinatarios...",filter:"contains",dataSource:{transport:{read:{url:urlUsers}}}}).data("kendoMultiSelect")}function cleanFilters(){var n=new Date;$("#filter-initial-date").data("kendoDatePicker").value(n);$("#filter-final-date").data("kendoDatePicker").value(n);$("#filter-name").val("")}function getFilters(){var i="",r=$("#filter-name").val(),n=$("#filter-initial-date").data("kendoDatePicker").value(),t=$("#filter-final-date").data("kendoDatePicker").value();return n&&(n=n.toISOString()),t&&(t=t.toISOString()),n==""&t==""&r==""&&(i="Debe escoger algún criterio de búsqueda."),{message:i,data:{Name:r,InitialDate:n,FinalDate:t}}}function filterData(n){var t=getFilters();t.message==""?$.get(urlFilter,t.data,function(n){loadGrid(n.items);n.message!=""&&showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`)}):n||(setGridHeight("Listado",_gridMargin),showInfo(`Se deben ingresar los siguientes campos: <br />${t.message}`))}function loadGrid(n){var t,i,r;n&&(t=_gridMargin,n.forEach(n=>n.date=JSON.toDate(n.date)),i=$("#Listado").data("kendoGrid"),r=new kendo.data.DataSource({data:n}),i.setDataSource(r),n&&n.length>0&&($("#filter-box").collapse("hide"),t-=20),setTimeout(()=>{setGridHeight("Listado",t)},200))}function onSendingMessage(){var n=$("#msg-title").val(),t=$("#msg-body").val(),i=kufiles.getFiles().length>0?kufiles.getFiles()[0]:"",r=ddlType.value(),u=ddlUsers.value();$.post(urlSendMessage,{Title:n,Message:t,ImageUrl:i.name,ToType:r,Tos:u},function(i){i.sent?(cleanFilters(),grdItems.dataSource.add({id:i.id,title:n,body:t,date:new Date}),showMessage("Mensaje enviado"),wndDetail.close()):i.message!=""||showError("Se ha producido el siguiente error al enviar el mensaje: "+i.message);kufiles.clearAllFiles()})}function onEdit(n){var i,t;n.currentTarget.classList.contains("action-edit")?(i=$(n.currentTarget).closest("tr"),grdItems.select(i),t=grdItems.dataItem(i)):t={title:"",body:""};$("#msg-title").val(t.title);$("#msg-body").val(t.body);wndDetail.open()}var _minDate,_maxDate,wndDetail,grdItems,kufiles,ddlType,ddlUsers;const alignCenter={"class":"k-text-center !k-justify-content-center"},alignRight={style:"text-align: right;"},numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}",_gridMargin=30,objConfig={messages:{required:"*"}};$(()=>{setupControls(),filterData(!0)});$(window).resize(()=>setGridHeight("Listado",_gridMargin));$("#action-clean").click(()=>{cleanFilters()});$("#action-filter").click(()=>{filterData(!1)});$("#Listado").on("click",".action-new, .action-edit",onEdit);$("#send-msg").click(onSendingMessage);