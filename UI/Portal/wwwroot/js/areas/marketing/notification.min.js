function setupControls(){var r=new Date,n=new Date,t,i;n.setMonth(n.getMonth()-1);t=$("#filter-initial-date").kendoDatePicker({value:n,change:function(){var n=this.value();n===null&&this.value("");i.min(n?n:_minDate)}}).data("kendoDatePicker");i=$("#filter-final-date").kendoDatePicker({value:r,change:function(){var n=this.value();n===null&&this.value("");t.max(n?n:_maxDate)}}).data("kendoDatePicker");_maxDate=i.max();_minDate=t.min();$("#filter-state").kendoDropDownList({dataSource:[{Text:"Cualquiera",Value:"A"},{Text:"Habilitados",Value:"E"},{Text:"Deshabilitados",Value:"D"}],dataTextField:"Text",dataValueField:"Value",value:"E"});$("#Detail").kendoWindow({visible:!1,width:1500,title:"Notificación",modal:!0,close:onCloseWindow,refresh:function(n){var i,t;$("#InitialDate").kendoDatePicker();$("#FinalDate").kendoDatePicker();i=$("#Popup").prop("checked");$(".frequency, label[for='Frequency']").toggleClass("d-none",!i);$("#Value").kendoEditor({resizable:{content:!0},tools:["bold","italic","underline","strikethrough","fontSize","foreColor","backColor","justifyLeft","justifyCenter","justifyRight","justifyFull","insertUnorderedList","insertOrderedList","indent","outdent","createLink","unlink","insertImage","tableWizard","createTable","addRowAbove","addRowBelow","addColumnLeft","addColumnRight","deleteRow","deleteColumn","viewHtml","formatting","cleanFormatting"],imageBrowser:{fileTypes:"*.png,*.gif,*.jpg,*.jpeg",path:"notification",transport:{read:urlImageRead,destroy:{url:urlImageDestroy,type:"POST"},create:{url:urlImageCreate,type:"POST"},uploadUrl:urlImageUpload,imageUrl:urlImage,type:"filebrowser-aspnetmvc"}}});t=JSON.parse($("#item-data").val());$("#Lines").kendoMultiSelect({dataTextField:"name",dataValueField:"id",value:t.Lines,placeholder:"Seleccione las Líneas",filter:"contains",dataSource:{serverFiltering:!1,transport:{read:{url:urlLines}}}});$("#Clients").kendoMultiSelect({dataTextField:"name",dataValueField:"code",value:t.Clients,placeholder:"Seleccione los Clientes",filter:"contains",dataSource:{serverFiltering:!1,transport:{read:{url:urlClients}}}});onRefreshWindow(n)}});$("#Listado").kendoGrid({columns:[{title:"Nombre",field:"name"},{title:"Desde",attributes:alignCenter,headerAttributes:alignCenter,width:90,field:"initialDate",format:dateFormat},{title:"Hasta",attributes:alignCenter,headerAttributes:alignCenter,width:90,field:"finalDate",format:dateFormat},{title:"V. Emergente",attributes:alignCenter,headerAttributes:alignCenter,width:110,template:'# if(popup) {# <i class="fas fa-check"><\/i> #} #',field:"popup"},{title:"Frecuencia (Hrs)",attributes:alignRight,width:120,field:"frequency"},{title:"Habilitado",attributes:alignCenter,headerAttributes:alignCenter,width:90,template:'# if(enabled) {# <i class="fas fa-check"><\/i> #} #',field:"enabled"},{field:"id",title:" ",attributes:alignCenter,width:50,sortable:!1,headerAttributes:alignCenter,headerTemplate:'<i class="fas fa-plus action action-link action-new" title="Nueva Notificación"><\/i>',template:'<i class="fas fa-pen action action-link action-edit" title="Editar Notificación"><\/i>&nbsp;&nbsp;<i class="fas fa-trash-alt action action-link action-delete" title="Eliminar Notificación"><\/i>'}],sortable:!0,selectable:"Single, Row",noRecords:{template:"No hay resultados para el criterio de búsqueda."},dataSource:[]});notification=$("#notification").kendoNotification({position:{pinned:!0,top:60,right:30},autoHideAfter:1e4,stacking:"down",templates:[{type:"error",template:$("#errorTemplate").html()},{type:"success",template:$("#successTemplate").html()}]}).data("kendoNotification")}function cleanFilters(){var n=new Date;$("#filter-initial-date").data("kendoDatePicker").value(n.addMonths(-1));$("#filter-final-date").data("kendoDatePicker").value(n);$("#filter-name").val("");$("#filter-state").data("kendoDropDownList").value("E")}function getFilters(){var i="",r=$("#filter-name").val(),u=$("#filter-state").val(),n=$("#filter-initial-date").data("kendoDatePicker").value(),t=$("#filter-final-date").data("kendoDatePicker").value();return n&&(n=n.toISOString()),t&&(t=t.toISOString()),n===""&t===""&r===""&&(i="Debe escoger algún criterio de búsqueda."),{message:i,data:{Name:r,State:u,InitialDate:n,FinalDate:t}}}function filterData(n){var t=getFilters();t.message===""?$.get(urlFilter,t.data,function(n){loadGrid(n.items);n.message!==""&&showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`)}):n||(setGridHeight("Listado",_gridMargin),showInfo(`Se deben ingresar los siguientes campos: <br />${t.message}`))}function loadGrid(n){var t,i,r;n&&(t=_gridMargin,n.forEach(n=>{n.initialDate=JSON.toDate(n.initialDate),n.finalDate=JSON.toDate(n.finalDate)}),i=$("#Listado").data("kendoGrid"),r=new kendo.data.DataSource({data:n}),i.setDataSource(r),n&&n.length>0&&($("#filter-box").collapse("hide"),t-=20),setTimeout(()=>{setGridHeight("Listado",t)},200))}function clientMapper(n){var t=this.dataSource.data(),i=[];n.value.forEach(n=>{i.push(t.indexOf(t.find(t=>t.code===n)))});n.success(i)}var _minDate,_maxDate,notification;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}",_gridMargin=30,objConfig={messages:{required:"*"}};$(()=>{setupControls(),filterData(!0)});$(window).resize(function(){setGridHeight("Listado",_gridMargin)});$("#action-clean").click(()=>{cleanFilters()});$("#action-filter").click(()=>{filterData(!1)});$("#Listado").on("click",".action-new",function(){var n=$("#Detail").data("kendoWindow");n.refresh({url:urlEdit,data:{Id:0}});n.open()});$("#Listado").on("click",".action-edit",function(n){var i=$("#Listado").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),u,t;i.select(r);u=i.dataItem(r);t=$("#Detail").data("kendoWindow");t.refresh({url:urlEdit,data:{Id:u.id}});t.open()});$("#Listado").on("click",".action-delete",function(n){var t=$("#Listado").data("kendoGrid"),i=$(n.currentTarget).closest("tr"),r=t.dataItem(i),u=getFilters();showConfirm("¿Est&aacute; seguro que desea eliminar esta Notificaci&oacute;n?",function(){$.post(urlDelete,{Id:r.id,Filters:u.data},function(n){n.message===""?(loadGrid(n.items),showMessage("Se ha eliminado la Notificaci&oacute;n correctamente.")):showError(n.message)})})});$("#Detail").on("click","#Popup",()=>$(".frequency, label[for='Frequency']").toggleClass("d-none",!$(this).prop("checked")));$("#Detail").on("click",".save-notification",function(){var i=$(this).closest("form"),r=i.kendoValidator({messages:{required:"*"}}).data("kendoValidator"),t;if(r.validate()){var n=i.serializeObject(),u=getFilters(),f=$("#Lines").getKendoMultiSelect().value(),e=Enumerable.From(f).Select("{ IdLine: $ }").ToArray(),o=$("#Clients").getKendoMultiSelect().value(),s=Enumerable.From(o).Select("{ CardCode: $ }").ToArray();n.ListNotificationDetails=e;n.ListNotificationClients=s;t=$("#new-photo").val();t!==""&&(n.MobileValue=t);$.post(urlEdit,{Item:n,Filters:u.data},function(n){if(n.message===""){loadGrid(n.items);var t=$("#Detail").data("kendoWindow");t.close();showMessage("Se realizaron los cambios correctamente.")}else showError(n.message)})}});$("#Detail").on("click","#photo-gallery",function(){$("#gallery").val(null);$("#gallery").click()});$("#Detail").on("click","#photo-remove",function(){var n=$("#MobileValue").val(),t=urlFolderPhotos+n,i=n===""?urlNoPhoto:t;$("#photo").attr("src",i);$("#new-photo").val("")});$("#Detail").on("change","#gallery",function(){if(this.files&&this.files[0]){var n=new FileReader;n.addEventListener("load",function(n){n.target.result!==""&&$.post(urlSavePhoto,{ImageBase64:n.target.result},function(t){t.message===""?($("#photo").attr("src",n.target.result),$("#new-photo").val(t.fileName),notification.show({title:"Imagen Subida Correctamente",message:`Imagen: ${t.fileName}`},"success")):(console.error(t.message),notification.show({title:"Error",message:"Error al subir la imagen"},"error"))})});n.readAsDataURL(this.files[0])}});$(document).on("click",".k-imagebrowser>.k-filemanager-listview>.k-listview-content>.k-listview-item",function(){var n=$("#k-editor-image-url")[0];n&&/%2F/.test(n.value)&&(n.value=n.value.replace(/%2F/g,"/").replace("notification/",""))});