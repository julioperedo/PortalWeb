function setupControls(){filSince=$("#FilSince").kendoDatePicker({format:"d/M/yyyy",change:function(){var n=this.value();n===null&&this.value("");filUntil.min(n?n:_minDate)}}).data("kendoDatePicker");filUntil=$("#FilUntil").kendoDatePicker({format:"d/M/yyyy",change:function(){var n=this.value();n===null&&this.value("");filSince.max(n?n:_maxDate)}}).data("kendoDatePicker");$("#RejectionDate").kendoDateTimePicker({format:"dd-MM-yyyy HH:mm",componentType:"modern",culture:"es-BO"});_maxDate=filUntil.max();_minDate=filSince.min();filClients=$("#FilClients").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",dataSource:{transport:{read:{url:urlClients}}},virtual:{itemHeight:26,valueMapper:clientMapper}}).data("kendoDropDownList");filReported=$("#FilReported").kendoDropDownList({dataTextField:"Text",dataValueField:"Value",optionLabel:"Seleccione un Estado ...",value:"N",dataSource:[{Text:"Ambos",Value:"B"},{Text:"Enviado",Value:"Y"},{Text:"No Enviado",Value:"N",Selected:!0}]}).data("kendoDropDownList");$("#Reason").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un motivo...",filter:"contains",dataSource:{transport:{read:{url:urlReasons}}}});filEmail=$("#FilEMail");$("#detail").kendoWindow({visible:!1,title:"Registrar insidencia",scrollable:!0,modal:!0,width:600,iframe:!1,close:function(){$("#Email").val("");$("#ClientCode").text("");$("#ClientName").text("");$("#Seller").text("");$("#Reason").data("kendoDropDownList").value("");$("#RejectionDate").val("");$("#Comments").val("")},activate:function(n){var t=this;setTimeout(function(){onRefreshWindow(n);t.center()},300)}});$("#Listado").kendoGrid({columns:[{title:"Fecha",attributes:alignCenter,headerAttributes:alignCenter,width:80,field:"rejectionDate",format:dateFormat},{title:"Correo",field:"email",width:200},{title:"Cliente",width:230,field:"clientName"},{title:"Vendedor",width:150,field:"seller"},{title:"Motivo",width:120,field:"reasonDesc"},{title:"Reportado",width:70,field:"reported",attributes:alignCenter,headerAttributes:alignCenter,template:n=>n.reported?'<i class="fas fa-check"><\/i>':""},{title:" ",width:30,attributes:alignCenter,headerAttributes:alignCenter,template:checkTemplate,field:"id",sortable:!1,headerTemplate:'<div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input check-all" id="chk-all" name="check-all"><label class="custom-control-label" for="chk-all"><\/label><\/div>'},{field:"id",title:" ",attributes:alignCenter,width:40,sortable:!1,headerAttributes:alignCenter,headerTemplate:'<i class="fas fa-plus action action-link action-new" title="Nuevo"><\/i>',template:'<i class="fas fa-trash-alt action action-link action-delete" title="Eliminar Usuario"><\/i>'}],groupable:{enabled:!1},sortable:!0,selectable:"Single, Row",noRecords:{template:'<div class="text-center w-100 p-2">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataSource:getDataSource([]),excel:{fileName:"RMA.xlsx"},dataBound:function(n){var t=n.sender;t.element.find("table").attr("style","")}});filterData()}function clientMapper(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}function cleanFilters(){filSince.value("");filUntil.value("");filClients.value("");filEmail.val("");filReported.value("N")}function getDataSource(n){$.each(n,(n,t)=>t.rejectionDate=JSON.toDate(t.rejectionDate));return new kendo.data.DataSource({data:n,sort:[{field:"id",dir:"asc"}],schema:{model:{id:"id"}}})}function getFilters(){var r="",u=filEmail.val(),n=filSince.value(),t=filUntil.value(),f=filClients.value(),i=filReported.value();return(i==="B"||i==="Y")&&n===null&&t===null&&(r="- Debe seleccionar al menos una Fecha cuando escoja registros reportados.<br />"),n&&(n=n.toISOString()),t&&(t=t.toISOString()),{message:r,data:{Email:u,ClientCode:f,InitialDate:n,FinalDate:t,Reported:i}}}function filterData(){var n=getFilters();n.message===""?$.get(urlFilter,n.data,function(n){n.message===""?loadGrid(n.items):(console.log(n.message),showNotification("","Se produjo un error al traer los datos.","error"))}):showInfo(`Los siguientes campos son necesarios: <br /> ${n.message}`)}function loadGrid(n){var t=$("#Listado").data("kendoGrid"),i=getDataSource(n);t.setDataSource(i);n&&n.length>0&&$("#filter-box").collapse("hide");setGridHeight("Listado",gridMargin)}function searchEmail(n){var t,i;n.preventDefault();t=n.currentTarget.id==="search-mail"||n.keyCode===13;t&&(i=$("#Email").val(),$.get(urlVerifyEmail,{Email:i},function(n){n.message===""?($("#ClientCode").text(n.clientCode),$("#ClientName").text(n.clientName),$("#Seller").text(n.seller)):(console.log(n.message),showNotification("","Se produjo un error al traer los datos.","error"))}))}function checkTemplate(n){var t="";return n.reported===!1&&(t=`<div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input check-one" id="chk-one-${n.id}" value="${n.id}"><label class="custom-control-label" for="chk-one-${n.id}"></label></div>`),t}function onSendingEmail(){var n=Enumerable.From($(".check-one:checked")).Select("+$.value").ToArray(),t=n.join(),i=`<div class="row"><div class="col"><p class="font-weight-bold">¿Está seguro que desea enviar el correo y agregar a la lista negra a los correos selccionados?</p>
                   <label for="extra-comnnets">Comentarios Extra</label><textarea id="extra-comnnets" class="form-control"></textarea></div></div>`;showConfirm(i,function(){var i=$("#Listado").data("kendoGrid"),r=$("#extra-comnnets").val();$.post(urlReportEmails,{Ids:t,Comments:r},function(t){t.message===""?(n.forEach(n=>i.dataSource.remove(i.dataSource.get(n))),showNotification("","Correos Marcados exitosamente","success")):(console.error(t.message),showNotification("","Se produjo un error al Reportar los Correos.","error"))})})}function onNew(n){var t=$(n.currentTarget).closest(".k-grid").data("kendoGrid");t.clearSelection();$("#detail").data("kendoWindow").open()}function onCheckOne(){$("#action-email").toggleClass("d-none",$(".check-one:checked").length===0);$("#check-all").prop("checked",$(".check-one:checked").length===$(".check-one").length)}function onCheckAll(n){$(".check-one:not(:disabled)").length>0?($(".check-one:not(:disabled)").prop("checked",n.target.checked),$("#action-email").toggleClass("d-none",!n.target.checked)):n.target.checked=!1}function onSave(n){var t,i;if(n.preventDefault(),t=$(n.currentTarget).closest("form"),i=t.kendoValidator().data("kendoValidator"),i.validate()){var r=$("#Email").val(),u=$("#ClientCode").text(),f=$("#ClientName").text(),e=$("#RejectionDate").data("kendoDateTimePicker").value(),o=$("#Reason").data("kendoDropDownList"),s=o.value(),l=o.text(),h=$("#Seller").text(),c=$("#Comments").val(),a={email:r,clientCode:u,clientName:f,rejectionDate:e.toISOString(),reason:s,seller:h,comments:c,reported:!1};$.post(urlEdit,{Item:a},function(n){if(n.message===""){var t=$("#Listado").data("kendoGrid");t.dataSource.add({id:n.id,email:r,clientCode:u,clientName:f,rejectionDate:e,reason:s,seller:h,comments:c,reported:!1,reasonDesc:l});$("#detail").data("kendoWindow").close();showNotification("","Registro guardado exitosamente.","success")}else console.log(n.message),showNotification("","Hubo un error al guardar el registros.","error")})}}var _minDate,_maxDate,filSince,filUntil,filClients,filEmail,filReported;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},gridMargin=30,numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy HH:mm}";$(()=>setupControls());$(window).resize(()=>setGridHeight("Listado",gridMargin));$("#filter-box").on("hidden.bs.collapse",()=>setGridHeight("Listado",gridMargin));$("#filter-box").on("shown.bs.collapse",()=>setGridHeight("Listado",gridMargin));$("#action-filter").click(()=>filterData());$("#action-clean").click(()=>cleanFilters());$("#action-email").click(onSendingEmail);$("#Listado").on("click",".action-new",onNew);$("#Listado").on("click",".check-one",onCheckOne);$("#Listado").on("click",".check-all",onCheckAll);$("#search-mail").click(searchEmail);$("#Email").on("keypress",searchEmail);$("#save").click(onSave);