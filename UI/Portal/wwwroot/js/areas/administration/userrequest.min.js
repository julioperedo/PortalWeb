function setupControls(){$("#pendings").kendoListView({dataSource:{transport:{read:{url:urlFilter,data:{State:states.Created,Filter:""}}},schema:{model:{fields:{requestDate:{type:"date"},createDate:{type:"date"}}}}},template:kendo.template(jQuery("#tPending").html())});$("#request-type").kendoDropDownList();$("#processed-requests").kendoGrid({noRecords:{template:"No se encontraron registros para el criterio de búsqueda."},columns:[{title:"Cod.",width:"80px",field:"cardCode",width:90},{title:"Cliente",field:"clientName"},{title:"Nombre Completo",field:"fullName"},{title:"Correo",field:"eMail"},{title:"Teléfono",attributes:alignCenter,headerAttributes:alignCenter,width:90,field:"phone"},{title:"Fecha",attributes:alignCenter,headerAttributes:alignCenter,width:90,field:"requestDate",format:dateFormat},{title:" ",attributes:alignCenter,width:30,template:'# if($.trim(comments) !== "") {# <a class="comments action" title="#=Comments#"><i class="fas fa-comment-alt"><\/i><\/a> #} #',field:"comments"},{title:"Compras",attributes:alignCenter,headerAttributes:alignCenter,width:100,template:'# if(hasOrders) {# <i class="fas fa-check"><\/i> #} #',field:"hasOrders"},{title:"Correo Val.",attributes:alignCenter,headerAttributes:alignCenter,width:110,template:'# if(validEMail) {# <i class="fas fa-check"><\/i> #} #',field:"validEMail"},{title:"Lista Negra",attributes:alignCenter,headerAttributes:alignCenter,width:110,template:'# if(inBlackList) {# <i class="fas fa-check"><\/i> #} #',field:"inBlackList"},{title:"Revertir",field:"stateIdc",attributes:alignCenter,headerAttributes:alignCenter,width:80,template:'# if(validEMail && hasOrders && !inBlackList) {# <a title="Revertir la solicitud" class="action undo-request"><i class="fas fa-undo-alt"><\/i><\/a> #} #'}],sortable:!0,selectable:"Single, Row",dataSource:[],detailInit:function(n){var t=`${urlDetail}?IdRequest=${n.data.id}`;$("<div/>").appendTo(n.detailCell).kendoGrid({dataSource:{transport:{read:t},sort:[{field:"logDate",dir:"desc"}],schema:{model:{fields:{logDate:{type:"date"}}}}},sortable:!0,pageable:!1,columns:[{field:"stateName",title:"Estado"},{field:"userName",title:"Usuario"},{field:"logDate",title:"Fecha",format:"{0:dd-MM-yyyy HH:mm}",attributes:alignCenter,headerAttributes:alignCenter}]})},dataBound:function(n){var t=n.sender,i=+$("#request-type").data("kendoDropDownList").value();i===states.Accepted?t.hideColumn("stateIdc"):t.showColumn("stateIdc");i===states.Deleted?t.showColumn("comments"):t.hideColumn("comments")}});$("#processed-requests").kendoTooltip({filter:"a.comments",offset:150,content:kendo.template($("#tooltip-template").html())})}function cleanFilters(){$("#request-filter").val("");loadGrid([])}function filterData(){var n=$("#request-filter").val(),t=$("#request-type").data("kendoDropDownList").value();$.get(urlFilter,{State:t,Filter:n},function(n){loadGrid(n)})}function loadGrid(n){if(n){n.forEach(n=>n.requestDate=JSON.toDate(n.requestDate));var t=$("#processed-requests").data("kendoGrid"),i=new kendo.data.DataSource({data:n,schema:{model:{id:"id"}}});t.setDataSource(i);setGridHeight("processed-requests",_gridMargin)}}function approveUser(n,t,i){$.post(urlApproveUser,{IdRequest:n,IdUser:t},function(n){n.result?(showMessage(n.message),i.remove()):showError(n.message)})}function undoRequest(n){var r=$(n.currentTarget).closest(".k-grid").getKendoGrid(),i=$(n.currentTarget).closest("tr"),t=r.dataItem(i),u;r.select(i);u=+$("#request-type").data("kendoDropDownList").value()===states.Rejected?"el rechazo":"la eliminación";showConfirm(`¿Está seguro que desea revertir ${u} de la solicitud de <b>( ${t.cardCode} ) ${t.clientName}</b>?`,()=>{$.post(urlUndo,{IdRequest:t.cd},n=>{n.result?(i.remove(),$("#pendings").data("kendoListView").dataSource.add(t),showMessage(n.message)):showError(n.message)})})}function deleteRequest(n){var t=$(n.currentTarget).closest(".request-item"),i=$(n.currentTarget).closest(".k-listview").data("kendoListView").dataItem(t),r=`¿Est&aacute; seguro que desea eliminar la solicitud de: <b>${i.clientName}</b>?<br /><label for="delete-reason">Motivo:</label><input id="delete-reason" name="delete-reason" class="form-control" style="width: 400px;">`;showConfirm(r,()=>{var n=$("#delete-reason").val();$.post(urlDelete,{IdRequest:i.id,ReasonReject:n},n=>{n.message===""?(t.remove(),showMessage("Solictud eliminada correctamente")):showError(`Se ha producido el siguiente error al querer eliminar la solicitud: <br />${n.message}`)})})}function rejectRequest(n){var i=$(n.currentTarget).closest(".request-item"),t=$(n.currentTarget).closest(".k-listview").data("kendoListView").dataItem(i),r=`<span>¿Está seguro que desea rechazar la Solicitud de: <b>${t.clientName}</b> ?</span><br /><label for="valid-names" class="action">¿El nombre de la solicitud es v&aacute;lido?&nbsp;&nbsp;&nbsp;</label><label class="switch"><input id="valid-names" name="valid-names" type="checkbox"><span class="slider round"></span></label>`;showConfirm(r,()=>{var n=$("#valid-names").prop("checked");$.post(urlReject,{IdRequest:t.id,Code:t.cardCode,Name:t.fullName,EMail:t.eMail,NameMismatch:!n,WithoutOrders:!t.hasOrders,InvalidEMail:!t.validEMail,IsNew:t.isNew},function(n){n.result?(showMessage(n.message),i.remove()):showError(n.message)})})}function aproveRequest(n){var i=$(n.currentTarget).closest(".request-item"),t=$(n.currentTarget).closest(".k-listview").data("kendoListView").dataItem(i);t.idUser>0&&t.sameClient||t.idUser===0?approveUser(t.id,t.idUser,i):showConfirm(`¿Ese correo está asignado a otro cliente, desea continuar y reasignar a el cliente (<b>${t.cardCode}</b>) ${t.clientName}?`,()=>approveUser(t.id,t.idUser,i))}var newId=0;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}",_gridMargin=30,states={Created:21,Accepted:22,Rejected:23,Deleted:24};$(()=>setupControls());$(window).resize(()=>setGridHeight("processed-requests",_gridMargin));$("#action-clean").click(function(){cleanFilters()});$("#action-filter").click(function(){filterData()});$("#pendings").on("click",".btn-aprove",aproveRequest);$("#pendings").on("click",".btn-reject",rejectRequest);$("#pendings").on("click",".btn-delete",deleteRequest);$("#processed-requests").on("click",".undo-request",undoRequest);