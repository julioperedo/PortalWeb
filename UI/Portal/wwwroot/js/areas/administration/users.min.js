function setupControls(){var n=$("#filClients").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",virtual:{itemHeight:26,valueMapper:clientMapper},dataSource:{data:clients}}).data("kendoDropDownList");$("#filProfiles").kendoDropDownList({cascadeFrom:"filClients",cascadeFromField:"cardCode",dataTextField:"name",dataValueField:"id",enable:!1,optionLabel:"Seleccione un Perfil ...",dataSource:{transport:{read:{url:urlProfiles,data:function(){return{CardCode:$("#filClients").val()}}}},serverFiltering:!0}});$("#Listado").kendoGrid({noRecords:{template:'<div class="text-center w-100">No se encontraron registros para el criterio de búsqueda.<\/div>'},columns:[{title:"Client Name",hidden:!0,field:"clientName",groupHeaderTemplate:"Cliente: #= value #"},{title:"Profile Name",hidden:!0,field:"profileName",groupHeaderTemplate:"Perfil: #= value #"},{title:"Nombre",field:"name",media:"lg"},{title:"E-Mail",field:"eMail",media:"lg"},{title:" ",attributes:alignCenter,width:35,template:'# if($.trim(commentaries) !== "") {# <a class="comments action action-link" title="#=commentaries#"><i class="fas fa-comment-alt"><\/i><\/a> #} #',field:"commentaries",media:"lg"},{title:"Habilitado",attributes:alignCenter,headerAttributes:alignCenter,width:100,template:'# if(enabled) {# <i class="fas fa-check"><\/i> #} #',field:"enabled",media:"lg"},{title:"Datos",field:"id",template:'<div class="row"><div class="col-12"><b>Nombre:<\/b> #=name#<\/div><div class="col-12"><b>E-Mail:<\/b> #=eMail#<\/div><\/div>',media:"(max-width: 991px)"},{title:" ",width:40,template:'# if(enabled && eMail && eMail.length > 0) {# <a title="Enviar Datos de Acceso por Correo" class="action-send-email action action-link"><i class="fas fa-envelope"><\/i><\/a> #} #',field:"eMail",sortable:!1},{title:" ",width:40,template:'# if(enabled) {# <a title="Asignaciones de Empresa y Perfil extra" class="action-assignments action action-link"><i class="fas fa-id-card"><\/i><\/a> #} #',field:"cardCode",sortable:!1},{title:" ",width:40,template:n=>n.enabled?'<a class="action action-link permissions" title="Permisos Personalizados"><i class="fas fa-user-lock"><\/i><\/a>':"",sortable:!1},{field:"id",title:" ",attributes:alignCenter,width:70,sortable:!1,headerAttributes:alignCenter,headerTemplate:'<i class="fas fa-plus action action-link action-new" title="Nuevo Usuario"><\/i>',template:function(n){var t="",i="action action-link action-delete",r="Eliminar Usuario";return n.sessionCount>0&&(i="disabled",t='disabled="disabled"',r="No se puede eliminar el usuario porque ya ha sido usado"),`<a class="action action-link action-edit" title="Editar Usuario"><i class="fas fa-pen"></i></a>&nbsp;&nbsp;<a class="${i}" ${t} title="${r}"><i class="fas fa-trash-alt"></i></a>`}}],sortable:!0,selectable:"Single, Row",dataSource:[]});$("#Listado").kendoTooltip({filter:"a.comments",offset:10,content:kendo.template('<div class="template-wrapper"><p>#=target.data("title")#<\/p><\/div>')});$("#assignments").kendoWindow({width:900,visible:!1,modal:!0});$("#assigned-clients").kendoMultiSelect({filter:"contains",dataTextField:"name",dataValueField:"code",placeholder:"Seleccione los Clientes"});$("#assigned-profiles").kendoMultiSelect({filter:"contains",dataTextField:"name",dataValueField:"id",placeholder:"Seleccione los Perfiles"});$("#extra-permissions").kendoWindow({width:900,visible:!1,modal:!0,close:onPermissionsClose,activate:onRefreshWindow});$.get(urlClients,{},t=>{clients=t,n.setDataSource(t)});filterData(!0)}function cleanFilters(){var n=$("#filClients").getKendoDropDownList();n.text("");n.value("");$("#filName").val("")}function getFilters(){var n="",t=$("#filClients").getKendoDropDownList().value(),i=$("#filName").val(),r=$("#filProfiles").getKendoDropDownList().value();return t===""&&i===""&&r===""&&(n="- Por lo menos un criterio de búsqueda."),{message:n,data:{CardCode:t,ProfileCode:r,Name:i}}}function filterData(n){var t=getFilters();t.message===""?$.get(urlFilter,t.data,function(n){loadGrid(n.items);n.message!==""&&showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`)}):(setGridHeight("Listado",_gridMargin),n||showInfo(`Se deben ingresar los siguientes campos: <br />${t.message}`))}function loadGrid(n){if(n){var t=$("#Listado").data("kendoGrid"),i=new kendo.data.DataSource({data:n,group:[{field:"clientName",dir:"asc"},{field:"profileName",dir:"asc"}],sort:[{field:"name",dir:"asc"}],schema:{model:{id:"id"}}});t.setDataSource(i);n&&n.length>0?($("#filter-box").collapse("hide"),$("#action-excel").removeClass("d-none")):$("#action-excel").addClass("d-none");setGridHeight("Listado",_gridMargin)}}function clientMapper(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}function clientMapperMulti(n){var t=$("#filClients").getKendoDropDownList().dataSource.data(),i=[];n.value.forEach(n=>{i.push(t.indexOf(t.find(t=>t.code===n)))});n.success(i)}function saveUser(){var n=$("form").serializeObject(),t,i;n.Id<=0&&(t=$("#CardCode").getKendoDropDownList(),t&&(n.ClientName=" ( "+t.text().replace(" - "," ) "),n.ProfileName=$("#IdProfile").getKendoDropDownList().text()));n.Enabled=$("#Enabled").prop("checked");n.AllowLinesBlocked=$("#AllowLinesBlocked").prop("checked");i=getFilters();$.post(urlEdit,{User:n,Filters:i.data},function(n){n.message===""?(loadGrid(n.items),$("#Detail").data("kendoWindow").close(),showMessage("Se realizaron los cambios correctamente.")):showError(n.message)})}function loadAssigments(n,t,i,r){$("#assigned-userid").val(n);$.get(urlAssigments,{Id:n},function(n){if(n.message===""){i.value(n.clients);r.value(n.profiles);var u=$("#assignments").data("kendoWindow");u.title(`Asignaciones de ${t}`);u.open().center()}else showError(`Se ha producido el siguiente error al traer los datos: <br />${n.message}`)})}function onClickSeePassword(){var n=$("#Password");n.attr("type")==="password"?n.attr("type","text"):n.attr("type","password");$(this).find("i").toggleClass("fa-eye").toggleClass("fa-eye-slash")}function onRefresh(n){$("#CardCode").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",virtual:{itemHeight:26,valueMapper:clientMapper},dataSource:{data:clients},change:function(){var n=this.value();$.get(urlBlackList,{CardCode:n},function(n){$("#BlackList").val(n.isBlackListed);$("#ValidForEnabling").val(n.validForEnabling)})}});var t=+$("#IdProfile").val(),i=$("#IdProfile").kendoDropDownList({cascadeFrom:"CardCode",cascadeFromField:"cardCode",dataTextField:"name",dataValueField:"id",enable:!1,optionLabel:"Seleccione un Perfil ...",dataSource:{transport:{read:{url:urlProfiles,data:function(n){return{CardCode:$("#CardCode").val(),CardName:n.filter&&n.filter.filters.length>1?n.filter.filters[1].value:""}}}},serverFiltering:!0}}).data("kendoDropDownList");i.value(t);onRefreshWindow(n)}function onSave(){var i=$(this).closest("form"),r=i.kendoValidator().data("kendoValidator"),t,n;r.validate()&&(t=$("#ValidForEnabling").val()==="Y",n=$("#BlackList").val()==="Y",n||!t?n?showConfirm("Ese Cliente está marcado como Lista Negra, ¿Desea guardarlo de todas maneras?",()=>saveUser()):showConfirm("Ese Cliente no tiene compras, ¿Desea guardarlo de todas maneras?",()=>saveUser()):saveUser())}function onSaveAssigment(){var n=$("#assigned-clients").getKendoMultiSelect().value(),t=$("#assigned-profiles").getKendoMultiSelect().value(),i=$("#assigned-userid").val();$.post(urlAssigments,{IdUser:i,ClientIds:n,ProfileIds:t},function(n){n.message===""?(showMessage("Se realizaron los cambios correctamente."),$("#assignments").data("kendoWindow").close()):showError(n.message)})}function onSendMail(n){var t=$("#Listado").data("kendoGrid").dataItem($(n.currentTarget).closest("tr"));$.post(urlSendEmail,{Id:t.id,WithCopy:!0},function(n){n.message!==""?showError(n.message):showMessage("Se ha enviado el correo exitosamente.")})}function onDelete(n){var t=$("#Listado").data("kendoGrid").dataItem($(n.currentTarget).closest("tr"));showConfirm(`¿Está seguro que desea eliminar el Usuario <b>${t.name}</b>?`,function(){var n=getFilters();$.post(urlDelete,{Id:t.id,Filters:n.data},function(n){n.message===""?(loadGrid(n.items),showMessage(`Se ha eliminado el Usuario <b>${t.name}</b> correctamente.`)):(console.error(n.message),showError("No se ha podido eliminar el usuario."))})})}function onOpenAssigments(n){var u=$("#Listado").data("kendoGrid"),f=$(n.currentTarget).closest("tr");u.select(f);var t=u.dataItem(f),i=$("#assigned-profiles").data("kendoMultiSelect"),r=$("#assigned-clients").data("kendoMultiSelect");r.dataSource.data().length>0&&i.dataSource.data().length>0?loadAssigments(t.id,t.name,r,i):($.get(urlProfiles,{},function(n){n.forEach(n=>{n.name=`${n.isExternalCapable?"(Cliente) ":""}${n.name}`});i.setDataSource(new kendo.data.DataSource({data:n}))}),r.setDataSource(new kendo.data.DataSource({data:clients})),loadAssigments(t.id,t.name,r,i))}function onEdit(n){var t=$("#Detail").data("kendoWindow"),i=$("#Listado").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),u;i.select(r);u=i.dataItem(r);t.refresh({url:urlEdit,data:{Id:u.id}});t.center().open()}function onNew(){var n=$("#Detail").data("kendoWindow");n.refresh({url:urlEdit,data:{Id:0}});n.center().open()}function onEditPermissions(n){var t;n.preventDefault();var i=$("#extra-permissions").data("kendoWindow"),r=$("#Listado").data("kendoGrid"),u=$(n.currentTarget).closest("tr");r.select(u);t=r.dataItem(u);$.get(urlPermissions,{Id:t.id},function(n){if(n.message===""){$("#permissions-userid").val(t.id);$("#title-permissions").text(`Permisos especiales de ${t.name} ( ${t.eMail} )`);var u='<ul class="nav nav-tabs" role="tablist">',r='<div class="tab-content">';n.items.forEach((n,t)=>{var i=t===0?"active show":"",f=t===0?'aria-selected="true"':"";u+=`<li class="nav-item"><a data-toggle="tab" href="#tab${t}" role="tab" class="nav-link ${i}" ${f}>${n.module}</a></li>`;r+=`<div class="tab-pane ${i}" id="tab${t}" role="tabpanel"><section><table class="table table-sm"><thead class="thead-light"><tr><th>Nombre</th><th style="text-align: center;">Insertar</th><th style="text-align: center;">Actualizar</th><th style="text-align: center;">Eliminar</th></tr></thead><tbody>`;n.items.forEach(n=>{var t=perInsert.indexOf(n.permission)>=0?'checked="checked"':"",i=perUpdate.indexOf(n.permission)>=0?'checked="checked"':"",u=perDelete.indexOf(n.permission)>=0?'checked="checked"':"";r+=`<tr class="activity-row">
    <td>${n.name}</td>
    <td class="text-center"><label class="switch"><input type="checkbox" ${t} class="p-insert" data-id="${n.id}" data-idactivity="${n.idActivity}" data-updated="F" /><span class="slider round"></span></label></td>
    <td class="text-center"><label class="switch"><input type="checkbox" ${i} class="p-update" data-updated="F" /><span class="slider round"></span></label></td>
    <td class="text-center"><label class="switch"><input type="checkbox" ${u} class="p-delete" data-updated="F" /><span class="slider round"></span></label></td>
</tr>`});r+="<\/tbody><\/table><\/section><\/div>"});u+="<\/ul>";r+="<\/div>";$("#tabs").append(u+r);i.center().open();$('a[data-toggle="tab"]').on("shown.bs.tab",()=>i.center());$(".p-insert, .p-update, .p-delete").on("change",onChange)}else showError("Se ha producido un error al intentar traer los permisos del usuario.")})}function onChange(n){var t=n.currentTarget.dataset;t.updated=t.updated==="F"?"T":"F"}function onPermissionsClose(){$("#permissions-userid").val("0");$("#tabs").empty()}function onSavingPermissions(n){n.preventDefault();var i=$("#permissions-userid").val(),r=$(".activity-row"),t=[];r.each((n,r)=>{var f=$(r).find(".p-insert"),e=$(r).find(".p-update"),o=$(r).find(".p-delete"),u=f.data(),s=u.id,h=u.idactivity,c=f.prop("checked"),l=e.data(),a=o.data(),v=e.prop("checked"),y=o.prop("checked"),p=(c?1:0)+(v?2:0)+(y?4:0),w=u.updated==="T"||l.updated==="T"||a.updated==="T";w&&t.push({id:s,idUser:i,idActivity:h,permission:p})});t.length>0?$.post(urlSavePermissions,{Items:t},function(n){n.message===""?(showMessage(`Permisos guardados correctamente.`),$("#extra-permissions").data("kendoWindow").close()):showError(`Se ha producido un error al guardar los datos de los permisos.`)}):$("#extra-permissions").data("kendoWindow").close()}var newId=0,clients=[];const alignCenter={"class":"k-text-center !k-justify-content-center"},alignRight={style:"text-align: right;"},numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}",_gridMargin=30,perInsert=[1,3,5,7],perUpdate=[2,3,6,7],perDelete=[4,5,6,7];$(()=>setupControls());$(window).resize(()=>setGridHeight("Listado",_gridMargin));$("#filter-box").on("hidden.bs.collapse",()=>setGridHeight("Listado",_gridMargin));$("#filter-box").on("shown.bs.collapse",()=>setGridHeight("Listado",_gridMargin));$("#action-clean").click(function(){cleanFilters()});$("#action-filter").click(function(){filterData(!1)});$("#Listado").on("click",".action-new",onNew);$("#Listado").on("click",".action-edit",onEdit);$("#Listado").on("click",".action-assignments",onOpenAssigments);$("#Listado").on("click",".action-delete",onDelete);$("#Listado").on("click",".action-send-email",onSendMail);$("#Listado").on("click",".permissions",onEditPermissions);$("#action-cancel-assigment").click(()=>$("#assignments").data("kendoWindow").close());$("#action-save-assigment").click(onSaveAssigment);$("#Detail").on("click","#action-cancel",()=>$("#Detail").data("kendoWindow").close());$("#Detail").on("click","#action-save",onSave);$("body").on("click","#see-password",onClickSeePassword);$("#action-cancel-permission").click(()=>$("#extra-permissions").data("kendoWindow").close());$("#action-save-permission").click(onSavingPermissions);