function setupControls(){$("#Detail").kendoWindow({refresh:onRefreshWindow,scrollable:!0,visible:!1,width:1e3,actions:["Close"],resizable:!1,title:"Detalle de Evento",modal:!0,iframe:!1});loadData()}function loadData(){$.get(ulrLastEvents,{},function(n){n.length>0&&($(".box-container").append('<div class="col-12 pt-3"><h4>Eventos<\/h4><\/div>'),$.each(n,function(n,t){var r,u,i,f,o,s,e,h,c,l;o=$("<span>").text(t.description);t.date=JSON.toDate(t.date);e=$("<span>").addClass("date");h=t.date.getHours()===0&&t.date.getMinutes()===0?"dd-MM-yyyy":"dd-MM-yyyy HH:mm";e.text(kendo.toString(t.date,h));t.detail?(c=`${urlEvent}/${t.id}`,l=$("<a>").attr("href",c).text(t.name),f=$("<h4>").html(l)):f=$("<h4>").text(t.name);s=$("<input>").attr("type","hidden").val(t.id);u=$("<div>").addClass("box").addClass("color-"+(n+1)%5);i=$("<div>").addClass("inner-box");i.append(s);i.append(f);i.append(e);i.append("<br />");i.append(o);r=$("<div>").addClass("col-12").addClass("col-sm-6").addClass("col-md-4").addClass("col-lg-4");u.append(i);r.append(u);$(".box-container").append(r)}),$(".box-container").after(`<a href="${urlAllEvents}">Ver todos los eventos</a>`))});$.get(urlClientResume,{},n=>{if(n.message===""){var t=n.item;$("#name").text(t.name);$("#legalName").text(t.legalName);$("#nit").text(t.nit);$("#currentPoints").text(kendo.toString(t.points,"N0"));$("#currentAmount").text(kendo.toString(t.amount,"N2"));t.points>=3e5&&$(".voucher").removeClass("d-none")}else showError(`Se ha producido un error al traer los datos del servidor: <br />${n.message}`)});$.get(urlOpenOrders,{},n=>{n.message===""?n.items&&n.items.length>0&&($("#openOrdersTitle").text("Ordenes Abiertas"),$("#openOrders").kendoGrid({columns:[{title:"Sucursal",width:120,field:"subsidiary",aggregates:["count"],groupHeaderTemplate:'Sucursal: #= value #    ( Total: #= count#,  Monto Total: #= kendo.toString(aggregates.total.sum, "N2") # )'},{title:"Almacen",width:120,field:"warehouse",aggregates:["count"],groupHeaderTemplate:'Almacén: #= value #    ( Total: #= count#,  Monto Total: #= kendo.toString(aggregates.total.sum, "N2") # )'},{title:"Vendedor",width:200,field:"sellerName",aggregates:["count"],groupHeaderTemplate:'Vendedor: # if(value) {# #= value # #} #    ( Total: #= count#,  Monto Total: #= kendo.toString(aggregates.total.sum, "N2") # )'},{title:"Orden Compra Cliente",width:180,field:"clientOrder"},{title:"Orden",headerAttributes:alignCenter,columns:[{title:"Número",width:90,template:'# if(docNumber) {# <a class="sale-order action action-link">#:docNumber#<\/a> #} #',field:"docNumber"},{title:"Total($us)",attributes:alignRight,footerAttributes:alignRight,headerAttributes:alignRight,width:130,footerTemplate:'#=kendo.toString(sum, "N2")#',field:"total",format:"{0:N2}",aggregates:["sum"]},{title:"Total Abierto ($us)",attributes:alignRight,footerAttributes:alignRight,headerAttributes:alignRight,width:150,footerTemplate:'#=kendo.toString(sum, "N2")#',field:"openAmount",format:"{0:N2}",aggregates:["sum"]},{title:"Fecha",attributes:alignCenter,headerAttributes:alignCenter,width:100,field:"docDate",format:dateFormat},]},{title:"Notas",headerAttributes:alignCenter,columns:[{title:"Números",width:160,template:"#=getFactNumLinks(noteNumbers, subsidiary)#",field:"noteNumbers"},{title:"Fechas",width:85,field:"billDates",encoded:!1,attributes:alignCenter,headerAttributes:alignCenter},{title:"Facturado($us)",attributes:alignRight,footerAttributes:alignRight,headerAttributes:alignRight,width:140,footerTemplate:'#=kendo.toString(sum, "N2")#',field:"totalBilled",format:"{0:N2}",aggregates:["sum"]}]},],groupable:{messages:{empty:"Arrastre un encabezado de columna y colóquela aquí para agrupar por esa columna"},enabled:!0},pageable:{buttonCount:10},sortable:!0,selectable:"Single, Row",scrollable:{height:200},noRecords:{template:"No se encontraron registros para el criterio de búsqueda."},dataSource:getDataSource(n.items),detailTemplate:kendo.template($("#detailOrder").html()),dataBound:function(n){for(var t=n.sender,i=0;i<t.columns.length;i++)t.showColumn(i);$("div.k-group-indicator").each(function(n,i){t.hideColumn($(i).data("field"))});t.element.find("table").attr("style","")},detailInit:function(n){$.get(urlDetail,{Subsidiary:n.data.subsidiary,Id:n.data.id,Type:"Orden de Venta",State:n.data.state},function(t){$("<div>").appendTo(n.detailCell).kendoGrid({scrollable:!1,sortable:!0,pageable:!1,selectable:!0,columns:[{field:"itemCode",title:"Cod. Item DMC",width:150},{field:"itemName",title:"Descripción"},{field:"warehouse",title:"Almacén",width:120},{field:"line",title:"Línea",width:200},{field:"quantity",title:"Cantidad",width:90,attributes:alignRight,headerAttributes:alignRight},{field:"openQuantity",title:"Abierta",width:90,attributes:alignRight,headerAttributes:alignRight},{field:"price",title:"Precio",width:90,format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight},{field:"itemTotal",title:"Subtotal",width:90,format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight},],dataSource:t.items})})}})):showError(`Se ha producido un error al traer los datos del servidor: <br />${n.message}`)})}function getDataSource(n){$.each(n,function(n,t){t.docDate=JSON.toDate(t.docDate)});return new kendo.data.DataSource({data:n,aggregate:[{aggregate:"sum",field:"total"},{aggregate:"sum",field:"openAmount"},{aggregate:"sum",field:"totalBilled"},{aggregate:"count",field:"subsidiary"},{aggregate:"count",field:"warehouse"},{aggregate:"count",field:"sellerName"}],group:[{field:"subsidiary",dir:"asc",aggregates:[{field:"subsidiary",aggregate:"count"},{field:"total",aggregate:"sum"}]},{field:"warehouse",dir:"asc",aggregates:[{field:"warehouse",aggregate:"count"},{field:"total",aggregate:"sum"}]}],sort:[{field:"docDate",dir:"asc"},{field:"docNumber",dir:"asc"}],schema:{model:{id:"id"}}})}function openDocument(n){var u;n.preventDefault();var f=$("#Report").data("kendoWindow"),e=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),o=$(n.currentTarget).closest("tr"),t=e.dataItem(o)??{docNumber:""},s=t.docNumber,i="Order",r=`Orden de Venta ${t.docNumber}`,h=t.subsidiary;e.select(o);n.currentTarget.classList.contains("sale-note")&&(u=n.currentTarget.getAttribute("delivery")==="Y"&&t.subsidiary.toLowerCase()==="santa cruz",i=u?"Delivery":"Note",r=u?"Nota de Entrega":`Nota de Venta ${noteNumber}`);n.currentTarget.classList.contains("sale-bill")&&(s=n.currentTarget.getAttribute("number"),i="Bill",r=`Factura de la Nota de Venta ${noteNumber}`,h="");loadReport(s,h,i);f.title(r);f.open().center()}function getFactNumLinks(n,t){var i="";return n&&n.length>0&&n.length>0&&(i=Enumerable.From(n).Select(function(n){return t.toLowerCase()==="santa cruz"?`${n.number} (<a class="sale-note action action-link" number="${n.number}" delivery="${n.delivery}">Nota</a>,&nbsp;<a class="sale-bill action action-link" number="${n.number}">Factura</a>)&nbsp;`:`<a class="sale-note action action-link" number="${n.number}" delivery="${n.delivery}">${n.number}</a>`}).ToArray().join("<br  />")),i}function loadReport(n,t,i){var f={Subsidiary:t,DocNumber:n,User:$.trim($(".user-info > .user-name").first().text())},r="SaleOrder.trdp",u;if(i==="Note"&&(r="SaleNote.trdp"),i==="Delivery"&&(r="DeliveryNote.trdp",f.SearchType=1),i==="Bill"&&(r="Bill.trdp"),u=$("#reportViewer1").data("telerik_ReportViewer"),u)try{u.reportSource({report:r,parameters:f});u.refreshReport()}catch(e){showInfo("El servidor está ocupado, espere un momento y vuelva a intentar.")}else $("#reportViewer1").telerik_ReportViewer({serviceUrl:urlService,reportSource:{report:r,parameters:f},viewMode:telerikReportViewer.ViewModes.INTERACTIVE,scaleMode:telerikReportViewer.ScaleModes.FIT_PAGE_WIDTH})}function openEvent(n){n.preventDefault();var t=$("#Detail").data("kendoWindow");t.refresh({url:this.href});t.open()}const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}";$(document).ajaxError(function(n,t){if(t.responseText&&t.responseText.includes("Document/refresh with ID")){var i=$("#reportViewer1").data("telerik_ReportViewer");i&&i.refreshReport()}});$(document).ready(()=>setupControls());$(".box-container").on("click","a",openEvent);$("#openOrders").on("click",".sale-order, .sale-note, .sale-bill",openDocument);