function setupControls(){$("#Subsidiary").multipleSelect({onUncheckAll:()=>{$("#Storehouse").empty().multipleSelect("refresh").multipleSelect("disable")},onCheckAll:()=>{loadStoreHouses()},onClick:()=>{loadStoreHouses()}});$("#Storehouse").multipleSelect().multipleSelect("disable");$("#Category").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una Categoría",dataSource:{transport:{read:{url:urlCategories}}}});$("#SubCategory").kendoDropDownList({cascadeFrom:"Category",dataTextField:"name",dataValueField:"id",enable:!1,optionLabel:"Seleccione un Subcategoría...",dataSource:{transport:{read:{url:urlSubcategories,data:()=>({CategoryId:$("#Category").val()})}},serverFiltering:!0}});$("#Line").multipleSelect();$("#Blocked").kendoDropDownList({dataTextField:"Text",dataValueField:"Value",optionLabel:"Cualquiera",dataSource:[{Text:"Si",Value:"S"},{Text:"No",Value:"N"}]});$("#Listado").kendoGrid({dataBound:n=>{for(var t=n.sender,i=0;i<t.columns.length;i++)t.showColumn(i);$("div.k-group-indicator").each(function(n,i){t.hideColumn($(i).data("field"))})},columns:[{title:"Categoria",width:150,field:"category",aggregates:["count"],groupHeaderTemplate:"Categoría: #=value#    (Total: #=count#)"},{title:"Subcategoria",width:200,field:"subcategory",aggregates:["count"],groupHeaderTemplate:"Subcategoría: #= value #    (Total: #= count#)"},{title:"Sucursal",width:100,field:"subsidiary",aggregates:["count"],groupHeaderTemplate:"Sucursal: #= value #    (Total: #= count#)"},{title:"Almacén",width:220,field:"warehouse",aggregates:["count"],groupHeaderTemplate:"Almacén: #= value #    (Total: #= count#)"},{title:"Item",width:160,template:'<a class="item-code action action-link">#:itemCode#<\/a>',field:"itemCode",groupable:!1},{title:"Descripción",width:300,field:"itemName",groupable:!1},{title:"Línea",width:220,field:"line",aggregates:["count"],groupHeaderTemplate:"Línea: #= value #    (Total: #= count#)"},{title:"Stock",attributes:alignRight,headerAttributes:alignRight,width:90,field:"stock",groupable:!1},{title:"Reserva",attributes:alignRight,headerAttributes:alignRight,width:90,field:"reserved",groupable:!1,template:"# if(reserved > 0) {# <a class='action action-link see-reserved'>#=reserved#<\/a> #} else {# #=reserved# #} #"},{title:"Pedido",attributes:alignRight,headerAttributes:alignRight,width:90,field:"requested",groupable:!1},{title:"Disponibilidad",attributes:alignRight,headerAttributes:alignRight,width:110,field:"available",groupable:!1},{title:"Aviso",width:70,field:"warning",groupable:!1},{title:"Unitario",attributes:alignRight,headerAttributes:alignRight,width:110,field:"priceReal",format:"{0:N2}",groupable:!1},{title:"Total",attributes:alignRight,headerAttributes:alignRight,width:110,field:"totalReal",format:"{0:N2}",groupable:!1},{title:"Unitario Modificado",attributes:alignRight,headerAttributes:alignRight,width:160,field:"priceModified",format:"{0:N2}",groupable:!1},{title:"Total Modificado",attributes:alignRight,headerAttributes:alignRight,width:140,field:"totalModified",format:"{0:N2}",groupable:!1}],groupable:{enabled:!0},sortable:!0,selectable:"Single, Row",noRecords:{template:"No hay resultados para el criterio de búsqueda."},dataSource:getDatasource([])});$("#Detail").kendoWindow({visible:!1,width:800,title:"Producto",modal:!0});$("#Detail2").kendoWindow({visible:!1,width:800,title:"Detalle Reservas",modal:!0});$.get(urlGetSubsidiaries,{},n=>{if(n.message===""){var t=$("#Subsidiary");n.items.forEach(n=>{t.append(new Option(n.name,n.id,!1,!1))});t.multipleSelect("refresh")}else showError(`Ha ocurrido el siguiente error al traer las Sucursales: <br />${n.message}.`)});$.get(urlLines,{},n=>{if(n){var t=$("#Line");n.forEach(n=>{t.append(new Option(n.name,n.id,!1,!1))});t.multipleSelect("refresh")}})}function loadStoreHouses(){var n,t;$("#Storehouse").empty();n=$("#Subsidiary").multipleSelect("getSelects","text");n&&n.length>0?(t=Enumerable.From(n).Select(function(n){return"'"+n+"'"}).ToArray().join(),$.get(urlWarehouses,{Subsidiary:t},n=>{n.message!==""?(showError(n.message),$("#Storehouse").multipleSelect("disable")):n.items.length>0?($.each(n.items,function(n,t){$("#Storehouse").append(new Option(t.name,t.name,!0,!0))}),$("#Storehouse").multipleSelect("enable")):$("#Storehouse").multipleSelect("disable"),$("#Storehouse").multipleSelect("refresh")})):$("#Storehouse").multipleSelect("refresh").multipleSelect("disable")}function getDatasource(n){return new kendo.data.DataSource({data:n,group:[{field:"category",dir:"asc",aggregates:[{field:"category",aggregate:"count"},{field:"subcategory",aggregate:"count"},{field:"line",aggregate:"count"},{field:"subsidiary",aggregate:"count"},{field:"warehouse",aggregate:"count"}]},{field:"subcategory",dir:"asc",aggregates:[{field:"category",aggregate:"count"},{field:"subcategory",aggregate:"count"},{field:"line",aggregate:"count"},{field:"subsidiary",aggregate:"count"},{field:"warehouse",aggregate:"count"}]}],aggregate:[{field:"category",aggregate:"count"},{field:"subcategory",aggregate:"count"},{field:"line",aggregate:"count"},{field:"subsidiary",aggregate:"count"},{field:"warehouse",aggregate:"count"}]})}function getFilters(){var n="",t,o,s=$.trim($("#ItemCode").val()),h=$.trim($("#Description").val()),i,r,u,c=$("#Blocked").getKendoDropDownList().value(),f,e;return t=Enumerable.From($("#Subsidiary").multipleSelect("getSelects","text")).Select(n=>`'${n}'`).ToArray().join(),o=Enumerable.From($("#Storehouse").val()).Select(n=>`'${n}'`).ToArray().join(),f=$("#Category").data("kendoDropDownList"),e=$("#SubCategory").data("kendoDropDownList"),f.value()!==""&&(i=f.text()),e.value()!==""&&(r=e.text()),u=Enumerable.From($("#Line").multipleSelect("getSelects","text")).Select(n=>`'${n}'`).ToArray().join(),$.trim(t)===""&&(n+=" - Al menos una Sucursal <br />"),s===""&&h===""&&i===""&&r===""&&u===""&&(n+=" - Al menos un criterio de búsqueda que no sea de localización <br />"),{message:n,data:{Subsidiaries:t,StoreHouses:o,ItemCode:s,Description:h,Category:i,Subcategory:r,Line:u,Blocked:c,_:new Date}}}function loadGrid(n){var i=$("#Listado").data("kendoGrid"),r=getDatasource(n),t;i.setDataSource(r);t=_gridMargin;n&&n.length>0?($("#filter-box").collapse("hide"),$("#action-excel").removeClass("d-none"),t-=20):$("#action-excel").addClass("d-none");setTimeout(()=>{setGridHeight("Listado",t)},200)}function filterData(){var n=getFilters();n.message===""?$.get(urlFilter,n.data,function(n){n.message!==""?(showError(n.message),loadGrid([])):loadGrid(n.items)}):showInfo(`Debe seleccionar los siguientes campos: <br />${n.message}`)}const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},dateFormat="{0:dd-MM-yyyy HH:mm:ss}",_gridMargin=30;$(function(){setupControls();setGridHeight("Listado",_gridMargin)});$(window).resize(function(){setGridHeight("Listado",_gridMargin)});$("#action-clean").click(function(){$("#Subsidiary").multipleSelect("uncheckAll");$("#ItemCode, #Description").val("");$("#Category").data("kendoDropDownList").value("");$("#Line").multipleSelect("uncheckAll");$("#Blocked").data("kendoDropDownList").value("");loadGrid([])});$("#action-filter").click(function(){filterData()});$("#action-excel").on("click",function(n){n.preventDefault();var t=getFilters();t.message===""?window.location.href=urlExport+"?"+$.param(t.data):showInfo(`Debe seleccionar los siguientes campos: <br />${t.message}`)});$("#Listado").on("click",".item-code",function(n){var u=$("#Detail").data("kendoWindow"),i=$("#Listado").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),t;i.select(r);t=i.dataItem(r);$.get(urlDetail,{ItemCode:t.itemCode,Subsidiary:t.subsidiary},n=>{$("#item-code").text(n.code),$("#item-name").text(n.name),$("#category").text(n.category),$("#subcategory").text(n.subcategory),$("#line").text(n.line),$("#detail").text(n.detail),$("#comments").text(n.commentaries),u.center().open()})});$("#Listado").on("click",".see-reserved",function(n){var i=$("#Listado").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),t;i.select(r);t=i.dataItem(r);t.reserved>0&&$.get(urlGetReservedItems,{Subsidiary:t.subsidiary,Warehouse:t.warehouse,ItemCode:t.itemCode},function(n){var u,i,r;n.message===""?(u=t.subsidiary.toLowerCase()==="iquique"?"<th>Autorizado<\/th><th>Correlativo<\/th>":"",i=`<table class="table"><thead class="thead-light"><tr><th scope="col">Ejecutivo</th><th scope="col">Cliente</th><th scope="col">Orden</th><th scope="col">Fecha</th><th scope="col" class="text-right">Cantidad</th><th scope="col" class="text-right">Precio</th>${u}<th>&nbsp;</th></thead><tbody>`,$.each(n.items,function(n,r){var u=t.subsidiary.toLowerCase()==="iquique"?`<td class="text-center">${r.authorized==="Y"?'<i class="fas fa-check"><\/i>':""}</td><td>${r.correlative}</td>`:"";i+=`<tr><td>${r.sellerName}</td><td><strong>${r.clientCode}</strong> - ${r.clientName}</td><td>${r.docNum}</td><td>${kendo.toString(JSON.toDate(r.docDate),"dd-MM-yyyy")}</td><td class="text-right">${r.quantity}</td><td class="text-right">${r.price!==null?kendo.toString(r.price,"N2"):""}</td>${u}<td>`;r.hasFiles&&$.each(r.files,function(n,t){i+=`<a href="#" title="${t}" class="open-file" data-subsidiary="${r.subsidiary}" data-code="${r.docEntry}" data-file="${t}"><span class="glyphicon glyphicon-paperclip"></span></a>&nbsp;&nbsp;&nbsp;`});i+=`</td></tr>`}),i+="<\/tbody><\/table>",r=$("#Detail2").data("kendoWindow"),r.setOptions({title:"Detalle Reservas"}),r.content(i),r.open().center()):showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`)})});