function setupControls(){localUser=$("#local-user").val()==="Y";permissions=localUser?JSON.parse($("#permissions").val()):{};var n=new Date,r=new Date(n.getFullYear(),n.getMonth(),1),t=$("#Since").kendoDatePicker({format:"d/M/yyyy",value:r,change:function(){var n=this.value();n===null&&this.value("");i.min(n?n:_minDate)}}).data("kendoDatePicker"),i=$("#Until").kendoDatePicker({format:"d/M/yyyy",value:n,change:function(){var n=this.value();n===null&&this.value("");t.max(n?n:_maxDate)}}).data("kendoDatePicker");_maxDate=i.max();_minDate=t.min();$("#Subsidiary").multipleSelect({placeholder:"Seleccione una Sucursal",onUncheckAll:()=>{$("#Storehouse").empty().multipleSelect("refresh").multipleSelect("disable")},onCheckAll:()=>{loadStoreHouses()},onClick:()=>{loadStoreHouses()}});$("#Storehouse").multipleSelect({placeholder:"Seleccione algún Almacén"}).multipleSelect("disable");$("#Category").multipleSelect({placeholder:"Seleccione alguna Categoría",onClick:function(){loadSubcategories()},onCheckAll:function(){loadSubcategories()},onUncheckAll:function(){loadSubcategories()}});$("#SubCategory").multipleSelect({placeholder:"Seleccione alguna Subcategoría"});$("#Line").multipleSelect({placeholder:"Seleccione alguna Línea"});localUser&&($("#Client").multipleSelect({placeholder:"Seleccione algún Cliente",filter:!0,selectAll:!1}),$("#SalesMan").kendoDropDownList({dataTextField:"name",dataValueField:"shortName",optionLabel:"Seleccione un Valor ...",value:permissions.SellerCode,enable:permissions.SeeAllClients,dataSource:{transport:{read:{url:urlSellers}}}}),$("#GP").kendoDropDownList({dataTextField:"name",dataValueField:"name",optionLabel:"Seleccione un Valor ...",dataSource:{transport:{read:{url:urlPManagers}}}}),$("#PivotType").kendoDropDownList({dataTextField:"Text",dataValueField:"Value",value:permissions.SeeAllClients&permissions.SeeMargin?"C":"V",enable:permissions.SeeAllClients&permissions.SeeMargin,dataSource:[{Text:"Custom",Value:"C",Selected:!0},{Text:"Ventas",Value:"V"},{Text:"Gerentes de Producto",Value:"GP"},{Text:"Vendedores",Value:"VS"}]}));$.get(urlGetSubsidiaries,{},n=>{if(n.message===""){var t=$("#Subsidiary");n.items.forEach(n=>{t.append(new Option(n.name,n.id,!1,!1))});t.multipleSelect("refresh")}else showError(`Ha ocurrido el siguiente error al traer las Sucursales: <br />${n.message}.`)});$.get(urlLines,{},n=>{if(n){var t=$("#Line");n.forEach(n=>{t.append(new Option(n.name,n.id,!1,!1))});t.multipleSelect("refresh")}});$.get(urlCategories,{},n=>{if(n){var t=$("#Category");n.forEach(n=>{t.append(new Option(n.name,n.id,!1,!1))});t.multipleSelect("refresh")}});localUser&&$.get(urlClients,{},n=>{if(n){var t=$("#Client");n.forEach(n=>t.append(new Option(n.name,n.code,!1,!1)));t.multipleSelect("refresh")}});$.extend($.fn.pivotgrid.defaults.operators,{avg:function(n,t){var i=0,u=0,r=0;return t==="MargenPorcentage"?($.map(n,function(n){u+=parseFloat(n.Margen)||0;r+=parseFloat(n.TotalSinImpuestos)||0}),r>0&&(i=u/r*100)):n.length>0&&($.map(n,function(n){i+=parseFloat(n[t])||0}),i=i/n.length),i},countDistinct:function(n,t){return Enumerable.From(n).Select("$."+t).Distinct().Count()}})}function loadStoreHouses(){var n,t;$("#Storehouse").empty();n=$("#Subsidiary").multipleSelect("getSelects","text");n&&n.length>0?(t=Enumerable.From(n).Select(function(n){return`'${n}'`}).ToArray().join(),$.get(urlWarehouses,{Subsidiary:t},n=>{n.message!==""?(showError(n.message),$("#Storehouse").multipleSelect("disable")):n.items.length>0?($.each(n.items,function(n,t){$("#Storehouse").append(new Option(t.name,t.name,!0,!0))}),$("#Storehouse").multipleSelect("enable")):$("#Storehouse").multipleSelect("disable"),$("#Storehouse").multipleSelect("refresh")})):$("#Storehouse").multipleSelect("refresh").multipleSelect("disable")}function loadSubcategories(){var n,t;$("#SubCategory").empty();n=$("#Category").multipleSelect("getSelects","text");n&&n.length>0?(t=Enumerable.From(n).Select(function(n){return`'${n}'`}).ToArray().join(),$.get(urlSubcategories,{Categories:t},n=>{n.message!==""?(showError(n.message),$("#SubCategory").multipleSelect("disable")):n.items.length>0?($.each(n.items,function(n,t){$("#SubCategory").append(new Option(t.name,t.name,!1,!1))}),$("#SubCategory").multipleSelect("enable")):$("#SubCategory").multipleSelect("disable"),$("#SubCategory").multipleSelect("refresh")})):$("#SubCategory").multipleSelect("refresh").multipleSelect("disable")}function getFilters(){var u="",f="",e="",o="",s="",r="",h="",c="",l,i=$("#Since").data("kendoDatePicker").value(),t,n;return i&&(i=i.toISOString()),t=$("#Until").data("kendoDatePicker").value(),t&&(t=t.toISOString()),n=$("#Subsidiary").multipleSelect("getSelects","text"),n&&n.length>0&&(u=Enumerable.From(n).Select(n=>`'${n}'`).ToArray().join()),n=$("#Storehouse").multipleSelect("getSelects"),n&&n.length>0&&(f=Enumerable.From(n).Select(n=>`'${n}'`).ToArray().join()),n=$("#Category").multipleSelect("getSelects","text"),n&&n.length>0&&(e=Enumerable.From(n).Select(n=>`'${n}'`).ToArray().join()),n=$("#SubCategory").multipleSelect("getSelects","text"),n&&n.length>0&&(o=Enumerable.From(n).Select(n=>`'${n}'`).ToArray().join()),n=$("#Line").multipleSelect("getSelects","text"),n&&n.length>0&&(s=Enumerable.From(n).Select(n=>`'${n}'`).ToArray().join()),localUser?(n=$("#Client").multipleSelect("getSelects","value"),n&&n.length>0&&(r=Enumerable.From(n).Select(n=>`'${n}'`).ToArray().join()),$("#SalesMan").getKendoDropDownList().value()!==""&&(h=$("#SalesMan").getKendoDropDownList().text()),$("#GP").getKendoDropDownList().value()!==""&&(c=$("#GP").getKendoDropDownList().text())):r=`'${$("#Client").val()}'`,l=$("#ItemCode").val(),{InitialDate:i,FinalDate:t,Regionals:u,Warehouses:f,Categories:e,SubCategories:o,Lines:s,Clients:r,SalesMan:h,ProductManager:c,ItemCode:l}}function loadPivot(n){var o=$(window).height()-130,f=localUser?$("#PivotType").getKendoDropDownList().value():"CL",i=[],u=[],t=[],r,e;f==="C"?_loaded?_options=$("#pivot").pivotgrid("options"):_UserConfig!==""&&(_UserConfig=_UserConfig.replace("&#241;","ñ"),r=_UserConfig.split(";"),r[0]!=null&&$.trim(r[0])!=""&&(i=r[0].split(",")),r[1]!=null&&$.trim(r[1])!=""&&(u=r[1].split(",")),r[2]!=null&&$.trim(r[2])!=""&&(t=Enumerable.From(r[2].split(",")).Select("{ field: $ }").ToArray()),_options.pivot.rows=i,_options.pivot.columns=u,_options.pivot.values=t):f==="V"?(t=[{field:"Total",op:"sum"}],i=["Sucursal","Cliente"],u=["Mes2"],_options.pivot.rows=i,_options.pivot.columns=u,_options.pivot.values=t):f==="CL"?(t=[{field:"Total",op:"sum"}],i=["Linea"],u=["Mes2"],_options.pivot.rows=i,_options.pivot.columns=u,_options.pivot.values=t):f=="GP"?(t=[{field:"Cantidad",op:"sum"},{field:"Total",op:"sum"},{field:"MargenPorcentage",op:"avg"}],i=["GerenteProducto","Linea"],_options.pivot.rows=i,_options.pivot.columns=u,_options.pivot.values=t):(t=[{field:"Total",op:"sum"}],permissions.SeeMargin&&t.push({field:"MargenPorcentage",op:"avg"}),u=["Mes2"],i=["Vendedor","Cliente"],_options.pivot.rows=i,_options.pivot.columns=u,_options.pivot.values=t);e=$("#ColapsedRows").prop("checked");$.map(_options.pivot.xfields,function(n){n.state=e?"closed":"opened"});_options.height=o;_options.data=n;$(".datagrid-row-selected, .datagrid-row-checked").removeClass("datagrid-row-checked").removeClass("datagrid-row-selected");$("#action-excel").toggleClass("d-none",n.length<=0);$("#pivot").pivotgrid(_options);_loaded=!0}function filterData(){var n=getFilters();$("#pivot-container").empty();$.ajaxSetup({cache:!1});$.get(urlFilter,n,function(n){$("#filter-box").collapse("hide");_minSC=+$("#MinSantaCruz").val();_minIQ=+$("#MinIquique").val();_minMI=+$("#MinMiami").val();loadPivot(n)})}function exportExcel(){var n=getFilters();window.location.href=urlExport+"?"+$.param(n)}function cleanFilters(){$("#Subsidiary").multipleSelect("uncheckAll");$("#Category").multipleSelect("uncheckAll");$("#Line").multipleSelect("uncheckAll");var n=new Date;$("#Until").data("kendoDatePicker").value(n);n.setDate(1);$("#Since").data("kendoDatePicker").value(n);loadPivot([])}function configLayoutPivot(n){n.preventDefault();$("#pivot").pivotgrid("layout")}function resizePivot(){var n=$(window).height()-$(".navbar").height()-$(".toolbar").height()-50;$("#pivot").pivotgrid("resize",{height:n})}var _minDate,_maxDate;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},dateFormat="{0:dd-MM-yyyy HH:mm:ss}",_gridMargin=30;var _loaded=!1,_reconfigured=!1,localUser=!1,permissions,_minSC,_minIQ,_minMI,_options={pivot:{rows:["Fecha","Cliente","Factura"],columns:["Sucusrsal"],values:[{field:"Total"},{field:"MargenPorcentage"},{field:"Cantidad"}],xfields:[{field:"Cliente",state:$("#ColapsedRows").prop("checked")?"closed":"opened"},{field:"GerenteProducto",state:$("#ColapsedRows").prop("checked")?"closed":"opened"},{field:"Fecha",state:$("#ColapsedRows").prop("checked")?"closed":"opened"},{field:"Factura",state:$("#ColapsedRows").prop("checked")?"closed":"opened"},{field:"Item",state:$("#ColapsedRows").prop("checked")?"closed":"opened"},{field:"Sucursal",state:$("#ColapsedRows").prop("checked")?"closed":"opened"},{field:"MargenPorcentage",title:"Margen %",op:"avg",formatter:function(n){return kendo.toString(+n,"#,##0.00")+" %"},styler:function(n){return n!=0&(/SANTA CRUZ/g.test(this.field)&n<_minSC|/IQUIQUE/g.test(this.field)&n<_minIQ|/MIAMI/g.test(this.field)&n<_minMI)?{"class":"low-margin"}:{}}},{field:"Cantidad",op:"sum",formatter:function(n){return kendo.toString(+n,"#,##0")}},{field:"Total",op:"sum",formatter:function(n){return kendo.toString(+n,"#,##0.00")}}]},forzenColumnTitle:'<span style="font-weight:bold">Detalle<\/span>',valueFormatter:function(n){return kendo.toString(+n,"#,##0.00")},valuePrecision:2,valueFieldWidth:100,showFooter:!0,FooterTitle:"TOTAL",showColumnsTotals:!0,i18n:{fields:"Campos",filters:"Filtros",rows:"Filas",columns:"Columnas",values:"Valores",ok:"Aceptar",cancel:"Cancelar"},onDblClickRow:function(){$(this).pivotgrid("unselectAll")},onLoadSuccess:function(){var n=$(this).pivotgrid("options"),u=localUser?$("#PivotType").getKendoDropDownList().value():"V",t,i,r;u==="C"|n.pivot.redrawed===!0&&(localUser&&$("#PivotType").getKendoDropDownList().value("C"),t=typeof n.pivot.rows[0]=="object"?Enumerable.From(n.pivot.rows).Select("$.field").ToArray().join():n.pivot.rows.join(),i=typeof n.pivot.columns[0]=="object"?Enumerable.From(n.pivot.columns).Select("$.field").ToArray().join():n.pivot.columns.join(),r=typeof n.pivot.values[0]=="object"?Enumerable.From(n.pivot.values).Select("$.field").ToArray().join():n.pivot.values.join(),$.post(urlUpdate,{Rows:t,Columns:i,Values:r},function(n){n.message!==""&&showError(n.message)}))}};$(()=>setupControls());$(window).resize(resizePivot);$("#action-config").click(configLayoutPivot);$("#action-clean").click(cleanFilters);$("#action-filter").click(filterData);$("#action-excel").click(exportExcel);