function setupControls(){localUser&&$("#client").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",virtual:{itemHeight:26,valueMapper:clientMapper},dataSource:{transport:{read:{url:urlClients}}}});$("#Listado").kendoGrid({columns:[{title:"Cliente",hidden:!0,field:"clientName",groupHeaderTemplate:"Cliente: #=value#    ( Total: #= count#,  Total Recibos: #= kendo.toString(aggregates.totalReceipt.sum, 'N2') #, Días Mora (Promedio): #= kendo.toString(aggregates.totalDueDays.sum / ( aggregates.totalBilled.sum > 0 ? aggregates.totalBilled.sum : 1 ), 'N0') # )"},{title:"Sucursal",hidden:!0,field:"subsidiary",groupHeaderTemplate:"Sucursal: #= value #    ( Total: #= count#,  Total Recibos: #= kendo.toString(aggregates.totalReceipt.sum, 'N2') #, Días Mora (Promedio): #= kendo.toString(aggregates.totalDueDays.sum / ( aggregates.totalBilled.sum > 0 ? aggregates.totalBilled.sum : 1 ), 'N0') # )"},{title:"Fecha",attributes:alignCenter,headerAttributes:alignCenter,width:120,field:"docDate",format:"{0:dd/MM/yyyy}"},{title:"Recibo",attributes:alignCenter,headerAttributes:alignCenter,width:120,field:"docNumber",template:n=>n.adjust?n.state==="Ajustes"?`<a class='adjust action action-link'>${n.docNumber}</a>`:n.docNumber:`<a class='receipt action action-link'>${n.docNumber}</a>`},{title:"Estado Recibo",attributes:alignCenter,headerAttributes:alignCenter,width:120,field:"state"},{title:"# Notas de Venta (días mora)",attributes:alignCenter,headerAttributes:alignCenter,width:300,field:"noteNumbers",template:n=>n.notes.map(n=>`<a class="note action action-link">${n.noteNumber}</a> (${n.days})`).join(", ")},{title:"Pago a Cuenta",attributes:alignRight,headerAttributes:alignRight,width:130,field:"onAccount",format:"{0:N2}"},{title:"Total Recibo",attributes:alignRight,headerAttributes:alignRight,width:120,field:"totalReceipt",format:"{0:N2}",aggregates:["sum"]},{title:"Total Sin Aplicar",attributes:alignRight,headerAttributes:alignRight,width:140,field:"notAppliedTotal",format:"{0:N2}"},{title:"Referencia",width:200,field:"comments"},{title:"Ajuste",attributes:alignCenter,headerAttributes:alignCenter,width:80,template:'# if(adjust) {# <i class="fas fa-check"><\/i> #} #',field:"adjust"}],sortable:!0,selectable:"Single, Row",scrollable:{height:200},noRecords:{template:"No se encontraron registros para el criterio de búsqueda."},dataSource:getDataSource([])})}function clientMapper(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.Code===n.value));n.success(i)}function onSinceChange(n){var t=this.value();t===null&&this.value("");$(n.sender.element).closest(".row").find("input.final-date").data("kendoDatePicker").min(t?t:_minDate)}function onUntilChange(n){var t=this.value();t===null&&this.value("");$(n.sender.element).closest(".row").find("input.initial-date").data("kendoDatePicker").max(t?t:_maxDate)}function cleanFilters(){localUser&&$("#client").data("kendoDropDownList").value("");$(`#initial-date`).data("kendoDatePicker").value(initialDate);$(`#final-date`).data("kendoDatePicker").value(finalDate);$("#receipt").val("");$("#note").val("")}function getFilters(){var u="",f=$(`#client`).val(),n=$(`#initial-date`).data("kendoDatePicker").value(),t=$(`#final-date`).data("kendoDatePicker").value(),i=$(`#receipt`).val(),r=$(`#note`).val();return n&&(n=n.toISOString()),t&&(t=t.toISOString()),n||t||f!==""||i!==""&&i!==0||r!==""&&r!==0||(u="Debe ingresar al menos un criterio de búsqueda"),{message:u,data:{ClientCode:f,InitialDate:n,FinalDate:t,ReceiptCode:i,NoteCode:r}}}function filterData(n){var t=getFilters();t.message===""?$.get(urlFilter,t.data,function(n){loadGrid(n.items);n.message!==""&&showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`)}):(setGridHeight("Listado",_gridMargin),n||showInfo(`Se deben ingresar los siguientes campos: <br />${t.message}`))}function loadGrid(n){if(n){var t=$("#Listado").data("kendoGrid"),i=getDataSource(n);t.setDataSource(i);n&&n.length>0?($("#filter-box").collapse("hide"),$("#action-excel").removeClass("d-none")):$("#action-excel").addClass("d-none");setGridHeight("Listado",_gridMargin)}}function getDataSource(n){n.forEach(n=>{n.docDate=JSON.toDate(n.docDate),n.notes.forEach(n=>n.docDate=JSON.toDate(n.docDate))});return new kendo.data.DataSource({data:n,aggregate:[{aggregate:"sum",field:"totalReceipt"},{aggregate:"count",field:"totalDueDays"}],group:[{field:"clientName",dir:"asc",aggregates:[{field:"clientName",aggregate:"count"},{field:"totalReceipt",aggregate:"sum"},{field:"totalDueDays",aggregate:"sum"},{field:"totalBilled",aggregate:"sum"}]},{field:"subsidiary",dir:"asc",aggregates:[{field:"subsidiary",aggregate:"count"},{field:"totalReceipt",aggregate:"sum"},{field:"totalDueDays",aggregate:"sum"},{field:"totalBilled",aggregate:"sum"}]}],sort:[{field:"docDate",dir:"desc"},{field:"docNumber",dir:"desc"}]})}function loadReport(n,t,i){var f={Subsidiary:t,DocNumber:n,User:$.trim($(".user-info > .user-name").first().text())},r="SaleOrder.trdp",u;if(i==="Note"&&(r="SaleNote.trdp"),i==="Delivery"&&(r="DeliveryNote.trdp",f.SearchType=1),i==="Bill"&&(r="Bill.trdp"),u=$("#reportViewer1").data("telerik_ReportViewer"),u)try{u.reportSource({report:r,parameters:f});u.refreshReport()}catch(e){showInfo("El servidor está ocupado, espere un momento y vuelva a intentar.")}else $("#reportViewer1").telerik_ReportViewer({serviceUrl:urlService,reportSource:{report:r,parameters:f},viewMode:telerikReportViewer.ViewModes.INTERACTIVE,scaleMode:telerikReportViewer.ScaleModes.FIT_PAGE_WIDTH})}function ExportExcel(){var n=getFilters();n.message===""?window.location.href=urlExcel+"?"+$.param(n.data):showInfo(`Los siguientes campos son necesarios <br />${n.message}`)}function openSaleNote(n){var t=$("#Report").data("kendoWindow"),u=$("#Listado").data("kendoGrid"),f=$(n.currentTarget).closest("tr"),i=u.dataItem(f),e=$(this).text(),r;u.select(f);i.isDelivery==="Y"&&i.subsidiary.toLowerCase()==="santa cruz"?(r="Delivery",t.title("Nota de Entrega")):(r="Note",t.title(`Nota de Venta ${e}`));loadReport(e,i.subsidiary,r);t.center().open()}function openReceipt(n){var t=$("#Detail").data("kendoWindow"),i=$("#Listado").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),u=i.dataItem(r),f=kendo.template(receiptTemplate);i.select(r);t.title("Detalle del Recibo");t.content(f(u));t.center().open()}function openAdjustDetail(n){var i=$("#Detail").data("kendoWindow"),r=$("#Listado").data("kendoGrid"),u=$(n.currentTarget).closest("tr"),t=r.dataItem(u),f=kendo.template(adjustTemplate);r.select(u);$.get(urlGetAdjustmentItems,{Subsidiary:t.subsidiary,DocNum:t.docNumber},function(n){t.items=n.items;i.title("Detalle del Ajuste");i.content(f(t));i.center().open()})}const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},numberFormat="{0:#,##0.00}",_gridMargin=15,localUser=$("#LocalUser").val()==="Y";var _minDate,_maxDate,receiptTemplate=`<div class="row">
		<div class="col-5">Recibo : <strong>#= data.docNumber #</strong></div>
		<div class="col-5">Fecha : #= kendo.toString(data.docDate, "dd/MM/yyyy") #</div>
	</div>
	<div class="row">
		<div class="col-5">Estado Recibo : #= data.state #</div>
	</div>
	<div class="row">
		<div class="col-5">Total Recibo : <strong>#= kendo.toString(data.totalReceipt, "N2") #</strong></div>
	</div>
	<div class="row">
		<div class="col-5">Pago a Cuenta : #= kendo.toString(data.onAccount, "N2") #</div>
		<div class="col-5">Total Sin Aplicar : #= kendo.toString(data.notAppliedTotal, "N2") #</div>
	</div>
	<br />
	<table class="table table-hover">
		<thead>
			<tr><td><strong>Nota de Venta</strong></td><td class="text-center"><strong>Fecha</strong></td><td class="text-center"><strong>T&eacute;rmino</strong></td><td class="text-right"><strong>Monto Pagado</strong></td><td class="text-right"><strong>Total Nota</strong></td><td class="text-right"><strong>D&iacute;as Mora</strong></td></tr>
		</thead>
		# var decTotal = 0, decPayed = 0; #
		# for (var i = 0; i < data.notes.length; i++) { #
		# decTotal += data.notes[i].total; #
		# decPayed += data.notes[i].amountPaid; #
		<tr><td># if (data.notes[i].noteNumber > 0) { # #= data.notes[i].noteNumber # # } #</td><td class="text-center"># if (data.notes[i].noteNumber > 0) { # #= kendo.toString(data.notes[i].docDate, "dd/MM/yyyy") # # } #</td><td class="text-center"># if (data.notes[i].noteNumber > 0) { # #= data.notes[i].terms # # } #</td><td class="text-right">#= kendo.toString(data.notes[i].amountPaid, "N2") #</td><td class="text-right">#= kendo.toString(data.notes[i].total, "N2") #</td><td class="text-right">#= kendo.toString(data.notes[i].days, "N0") #</td></tr>
		# } #
		<tfoot>
			<tr><td><strong>TOTAL</strong></td><td></td><td></td><td class="text-right"><strong>#= kendo.toString(decPayed, "N2") #</strong></td><td class="text-right"><strong>#= kendo.toString(decTotal, "N2") #</strong></td><td></td></tr>
		</tfoot>
	</table>`,adjustTemplate=`<div class="row">
		<div class="col-5">No. Nota de Cr&eacute;dito : <strong>#= data.docNumber #</strong></div>
		<div class="col-5">Fecha : #= kendo.toString(data.docDate, "dd/MM/yyyy") #</div>
	</div>	
    <div class="row">
		<div class="col-5">Referencia : #= data.comments #</div>
	</div>
	<div class="row">
		<div class="col-5">Total : <strong>#= kendo.toString(data.totalReceipt, "N2") #</strong></div>
	</div>
	<br />
	<table class="table table-hover">
		<thead>
			<tr><td><strong>Descripci&oacute;n</strong></td><td><strong>C&oacute;d. Cuenta</strong></td><td><strong>Cuenta de Mayor</strong></td><td class="text-right"><strong>Total</strong></td></tr>
		</thead>
		# var decTotal = 0; #
		# for (var i = 0; i < data.items.length; i++) { #
		# decTotal += data.items[i].total; #
		<tr><td>#= data.items[i].description #</td><td>#= data.items[i].accountCode #</td><td>#= data.items[i].accountName #</td><td class="text-right">#= kendo.toString(data.items[i].total, "N2") #</td></tr>
		# } #
		<tfoot>
			<tr><td><strong>TOTAL</strong></td><td></td><td></td><td class="text-right"><strong>#= kendo.toString(decTotal, "N2") #</strong></td></tr>
		</tfoot>
	</table>`;$(function(){_maxDate=$("#final-date").data("kendoDatePicker").max();_minDate=$("#initial-date").data("kendoDatePicker").min();var n=$("#initial-date").data("kendoDatePicker").value(),t=$("#final-date").data("kendoDatePicker").value();$("input.final-date").data("kendoDatePicker").min(n);$("input.initial-date").data("kendoDatePicker").max(t);setupControls();localUser?setGridHeight("Listado",_gridMargin):filterData("O",!0)});$(window).resize(()=>setGridHeight("Listado",_gridMargin));$("#filter-box").on("hidden.bs.collapse",()=>setGridHeight("Listado",_gridMargin));$("#filter-box").on("shown.bs.collapse",()=>setGridHeight("Listado",_gridMargin));$("#action-clean").click(function(){cleanFilters()});$("#action-filter").click(function(){filterData(!1)});$("#Listado").on("click",".receipt",openReceipt);$("#Listado").on("click",".note",openSaleNote);$("#Listado").on("click",".adjust",openAdjustDetail);$("#action-excel").on("click",ExportExcel);