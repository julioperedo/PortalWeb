function initForm(){setupControls();$("#Client").val()!==""?setTimeout(function(){filterData()},200):(setGridHeight("Listado",gridMargin),setGridHeight("Resume",gridMargin))}function setupControls(){localUser=$("#LocalUser").val()==="Y";localUser&&(permission=JSON.parse($("#permissions").val()),permission.seeMargin&&$("#action-show-all").removeClass("d-none"));$("#Seller").kendoDropDownList({dataSource:{transport:{read:{url:urlGetSellers}}},ignoreCase:!0,optionLabel:"Seleccione un Vendedor...",filter:"contains",dataTextField:"name",dataValueField:"shortName",value:permission.sellerCode});$.get(urlSubsidiaries,{},function(n){var t=$("#FilSubsidiaries");$.each(n.items,function(n,i){t.append(new Option(i.name,i.name))});t.multipleSelect().multipleSelect("checkAll")});var n=[{field:"clientName",title:"Cliente",width:200,aggregates:["count"],groupHeaderTemplate:"Cliente: #= value #     ( Total: #= count #, Monto Total: #= kendo.toString(aggregates.balance.sum, 'N2') # )  "},{field:"subsidiary",title:"Sucursal",width:110,aggregates:["count"],groupHeaderTemplate:"Sucursal: #= value #     ( Total: #= count #, Monto Total: #= kendo.toString(aggregates.balance.sum, 'N2') # )  "},{field:"warehouse",title:"Almacen",width:110,aggregates:["count"],groupHeaderTemplate:"Almacén: #= value #     ( Total: #= count #, Monto Total: #= kendo.toString(aggregates.balance.sum, 'N2') # )  "},{field:"type",title:"Tipo Doc.",width:120,aggregates:["count"],groupHeaderTemplate:"Tipo Doc.: #= value #     ( Total: #= count #, Monto Total: #= kendo.toString(aggregates.balance.sum, 'N2') # )  "},{field:"docDate",title:"Fecha Doc.",width:105,format:"{0:dd/MM/yyyy}",attributes:alignCenter,headerAttributes:alignCenter,aggregates:["count"],groupHeaderTemplate:"Fecha Doc.: #= kendo.toString(value, 'dd/MM/yyyy') #     ( Total: #= count #, Monto Total: #= kendo.toString(aggregates.balance.sum, 'N2') # )  "},{field:"docNum",title:"Nro. Doc.",width:85,groupable:!1,attributes:alignCenter,headerAttributes:alignCenter},{field:"sellerName",title:"Vendedor",width:170,aggregates:["count"],groupHeaderTemplate:"Vendedor: #= value #     ( Total: #= count #, Monto Total: #= kendo.toString(aggregates.balance.sum, 'N2') # )  "},{field:"saleNote",title:"Nota Venta",width:165,attributes:alignCenter,headerAttributes:alignCenter,groupable:!1,template:notesTemplate},{field:"saleOrder",title:"Orden Venta",width:100,attributes:alignCenter,headerAttributes:alignCenter,groupable:!1,template:ordersTemplate},{field:"pickupDate",title:"Fecha Retiro",width:95,attributes:alignCenter,headerAttributes:alignCenter,format:"{0:dd/MM/yyyy}",aggregates:["count"],groupHeaderTemplate:"Fecha Retiro: #= kendo.toString(value, 'dd/MM/yyyy') #     ( Total: #= count #, Monto Total: #= kendo.toString(aggregates.balance.sum, 'N2') # )  "},{field:"clientOrder",width:120,title:"Orden Cliente",groupable:!1},{field:"terms",title:"Término",width:90,aggregates:["count"],groupHeaderTemplate:"Término: #= value #     ( Total: #= count #, Monto Total: #= kendo.toString(aggregates.balance.sum, 'N2') # )  "},{field:"dueDate",title:"Fecha Venc.",width:95,attributes:alignCenter,headerAttributes:alignCenter,format:"{0:dd/MM/yyyy}",aggregates:["count"],groupHeaderTemplate:"Fecha Venc.: #= kendo.toString(value, 'dd/MM/yyyy') #     ( Total: #= count #, Monto Total: #= kendo.toString(aggregates.balance.sum, 'N2') # )  "},{field:"total",title:"Total",width:100,attributes:alignRight,headerAttributes:alignRight,format:numberFormat,groupable:!1},{field:"balance",title:"Balance",width:140,attributes:alignRight,headerAttributes:alignRight,footerAttributes:alignRight,footerTemplate:"Total : #=kendo.toString(sum, 'N2')#",format:numberFormat,aggregates:["sum","count"]}];permission.seeMargin&&n.push({field:"percetageMargin",title:"Margen",width:70,attributes:alignRight,headerAttributes:alignRight,footerAttributes:alignRight,groupable:!1,format:"{0:#,##0.00} %"});n.push({field:"days",title:"Días",width:80,attributes:alignRight,headerAttributes:alignRight,aggregates:["count"],groupHeaderTemplate:"Días: #= value #     ( Total: #= count #, Monto Total: #= kendo.toString(aggregates.balance.sum, 'N2') # )  "});n.push({field:"state",title:"Estado",width:80,aggregates:["count"],groupHeaderTemplate:"Estado: #= value #     ( Total: #= count #, Monto Total: #= kendo.toString(aggregates.balance.sum, 'N2') # )  "});localUser&&n.push({field:"header",width:30,title:" ",template:'# if(header || footer) {# <a class="comment action"><i class="far fa-list-alt"><\/i><\/a> #} #',attributes:alignCenter});$("#Listado").kendoGrid({dataSource:{data:[],aggregate:[{field:"balance",aggregate:"sum"}]},sortable:!0,selectable:!0,groupable:{messages:{empty:"Arrastre un encabezado de columna y colóquela aquí para agrupar por esa columna"}},noRecords:{template:'<div class="w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},pageable:!1,columns:n,dataBound:function(n){for(var t=n.sender,i=0;i<t.columns.length;i++)t.showColumn(i);$("div.k-group-indicator").each(function(n,i){t.hideColumn($(i).data("field"))});showMargin?t.showColumn("percetageMargin"):t.hideColumn("percetageMargin");t.element.find("table").attr("style","")}});$("#Resume").kendoGrid({dataSource:[],sortable:!0,selectable:!0,pageable:!1,noRecords:{template:"No se encontraron registros para el criterio de búsqueda."},columns:[{field:"subsidiary",title:"Sucursal",width:150},{field:"clientName",title:"Cliente"},{field:"creditLimit",title:"Límite Crédito",width:140,attributes:alignRight,headerAttributes:alignRight,format:numberFormat},{field:"availableBalance",title:"Saldo Disponible",width:140,attributes:alignRight,headerAttributes:alignRight,format:numberFormat},{field:"balance",title:"Balance",width:140,attributes:alignRight,headerAttributes:alignRight,format:numberFormat},{field:"dueAmount",title:"En Mora",width:140,attributes:alignRight,headerAttributes:alignRight,template:'# if(dueAmount > 0) {# <a class="action action-link due-amount" title="Monto en Mora">#=kendo.toString(dueAmount, "N2")#<\/a> #} else {# 0.00 #} #'},{field:"ordersBalance",title:"Pedidos",width:140,attributes:alignRight,headerAttributes:alignRight,template:'# if(ordersBalance > 0) {# <a class="action action-link open-amount" title="Monto Abierto">#=kendo.toString(ordersBalance, "N2")#<\/a> #} else {# 0.00 #} #'},{field:"terms",title:"Términos",width:100},],dataBound:function(n){for(var t=n.sender,i=0;i<t.columns.length;i++)t.columns[i].field!=="id"&&t.showColumn(i);$("div.k-group-indicator").each(function(n,i){t.hideColumn($(i).data("field"))});t.element.find("table").attr("style","")}});$.get(urlGetBankAccounts,{},n=>{var t=$("#tab3"),i;n.message===""?(n.items.forEach(n=>{var i="",r=n.items.filter(n=>$.trim(n.name)!=="").length>0,u=n.items.filter(n=>$.trim(n.country)!=="").length>0,f=n.items.filter(n=>$.trim(n.type)!=="").length>0,e=n.items.filter(n=>$.trim(n.abaNumber)!=="").length>0,o=n.items.filter(n=>$.trim(n.swift)!=="").length>0,s=n.items.filter(n=>$.trim(n.comments)!=="").length>0;i+=`<div class="card no-shadow mt-2"><div class="card-header">${n.name}</div><div class="card-body"><div class="table-responsive"><table class="table table-condensed bank-table"><thead><tr><th>BANCO</th>`;r&&(i+=`<th>BENEFICIARIO (para transferencias ACH)</th>`);i+=`<th>MONEDA</th><th>NO. DE CUENTA</th>`;u&&(i+=`<th>PAIS</th>`);f&&(i+=`<th>TIPO DE CUENTA</th>`);e&&(i+=`<th>ABA No.</th>`);o&&(i+=`<th>SWIFT</th>`);s&&(i+=`<th></th>`);i+=`<th></th></tr></thead><tbody>`;n.items.forEach(n=>{i+=`<tr><td>${n.bank}</td>`,r&&(i+=`<td>${n.name}</td>`),i+=`<td>${n.currency}</td><td>${n.number}</td>`,u&&(i+=`<td>${n.country}</td>`),f&&(i+=`<td>${n.type}</td>`),e&&(i+=`<td>${n.abaNumber}</td>`),o&&(i+=`<td>${n.swift}</td>`),s&&(i+=`<td>${n.comments}</td>`),i+="<td>",$.trim(n.qr)!==""&&(i+=`<a class="qr-tooltip" data-image="${n.qr}"><i class="fas fa-qrcode"></i></a>`),i+=`</td></tr>`});i+=`</tbody></table></div></div></div>`;t.append(i)}),i=`<div class="template-wrapper"><img src="../../images/qr/#=target.data('image')#" /><p>#=target.data('title')#</p></div>`,$(".bank-table").kendoTooltip({autoHide:!1,filter:"a",content:kendo.template(i),width:612,height:812,position:"left"})):(console.error(n.message),t.append(`<span>Se ha producido un error al traer los datos del servidor.</span>`))});$("#OpenOrders").kendoWindow({visible:!1,modal:!0,iframe:!1,scrollable:!0,title:"Ordenes Abiertas",resizable:!1,width:1100,actions:["Close"],activate:function(n){var t=this;setTimeout(()=>{onRefreshWindow(n),t.center()},300)}});$("#openOrdersList").kendoGrid({columns:[{title:"Almacen",width:100,field:"warehouse"},{title:"# Orden",width:90,template:'<a class="sale-order action action-link"># if(docNumber) {# #:docNumber# #} #<\/a>',field:"docNumber"},{title:"Fecha",attributes:alignCenter,headerAttributes:alignCenter,width:100,field:"docDate",format:"{0:dd/MM/yyyy}"},{title:"Order Cliente",field:"clientOrder"},{title:"Vendedor",width:"120px",field:"sellerName"},{title:"Total",attributes:alignRight,headerAttributes:alignRight,width:100,field:"total",format:"{0:#,##0.00}"},{title:"Abierto",attributes:alignRight,headerAttributes:alignRight,width:100,field:"openAmount",format:"{0:#,##0.00}"},{title:"Completo",attributes:alignCenter,headerAttributes:alignCenter,width:90,template:'# if(nonCompleteItem === 0) {# <i class="fas fa-check"><\/i> #} #',field:"nonCompleteItem"},],sortable:!0,selectable:"Single, Row",dataSource:[]})}function setHeights(n){n?n.target.text==="Consolidado"?setGridHeight("Resume",gridMargin):n.target.text==="Detallado"&&setGridHeight("Listado",gridMargin):(setGridHeight("Listado",gridMargin),setGridHeight("Resume",gridMargin))}function toggleShowAll(){var t=$("#Listado").data("kendoGrid"),n=$(this).find("i");n.hasClass("fa-eye-slash")?(t.hideColumn("percetageMargin"),n.removeClass("fa-eye-slash").addClass("fa-eye")):(t.showColumn("percetageMargin"),n.removeClass("fa-eye").addClass("fa-eye-slash"));showMargin=!showMargin}function clientMapper(n){var t=$("#Client").data("kendoDropDownList").dataSource.data(),i=Enumerable.From(t).Where(t=>t.code===n.value).FirstOrDefault(),r=Enumerable.From(t).IndexOf(i);n.success(r)}function cleanFilters(){if($("#FilSubsidiaries").multipleSelect("checkAll"),$("#Seller").data("kendoDropDownList").value(""),$("#LocalUser").val()==="Y"){var n=$("#Client").data("kendoDropDownList");n.text("");n.value("")}}function getFilters(){var t=$("#Client").val(),i=Enumerable.From($("#FilSubsidiaries").multipleSelect("getSelects")).Select(function(n){return`'${n}'`}).ToArray().join(),r=$.trim($("#Seller").val()),n="";return i===""&&(n+="Debe seleccionar al menos una sucursal.<br />"),t===""&&r===""&&(n+="Debe seleccionar o un cliente o un vendedor."),{message:n,data:{CardCode:t,Subsidiary:i,SalesMan:r}}}function filterData(){var n=getFilters();n.message===""?$.get(urlFilter,n.data,function(n){n.message===""?loadResults(n.items,n.resume):showError(n.message)}):showInfo(n.message)}function loadResults(n,t){var i,r;i=$("#Listado").data("kendoGrid");$.each(n,function(n,t){t.docDate=JSON.toDate(t.docDate);t.dueDate=JSON.toDate(t.dueDate);t.pickupDate=JSON.toDate(t.pickupDate)});r=new kendo.data.DataSource({data:n,aggregate:[{field:"balance",aggregate:"sum"}],group:[{field:"clientName",dir:"asc",aggregates:[{field:"clientName",aggregate:"count"},{field:"balance",aggregate:"sum"}]}],sort:{field:"docDate",dir:"asc"}});i.setDataSource(r);n&&n.length>0?($("#filter-box").collapse("hide"),$("#action-excel").removeClass("d-none")):$("#action-excel").addClass("d-none");i=$("#Resume").data("kendoGrid");r=new kendo.data.DataSource({data:t,pageSize:100,aggregate:[{field:"balance",aggregate:"sum"}],group:[{field:"clientName",dir:"asc",aggregates:[{field:"clientName",aggregate:"count"},{field:"balance",aggregate:"sum"}]}]});i.setDataSource(r);setGridHeight("Listado",gridMargin);setGridHeight("Resume",gridMargin)}function ExportExcel(){var n=getFilters();n.message===""?window.location.href=urlExcel+"?"+$.param(n.data):showInfo(`Los siguientes campos son necesarios <br />${n.message}`)}function showReport(n,t){var r=$("#Report").data("kendoWindow"),f=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),e=$(n.currentTarget).closest("tr"),i,u;f.select(e);i=f.dataItem(e);t==="SaleOrder"?(u=n.currentTarget.dataset,loadReport(u.id,i.subsidiary,u.delivery==="Y"?"Delivery":"Order"),r.title(`Orden de Venta ${i.saleOrder}`)):t==="SaleOrder2"?(loadReport(i.docNumber,i.subsidiary,"Order"),r.title(`Orden de Venta ${i.docNumber}`)):t==="SaleNote"?(loadReport(i.saleNote,i.subsidiary,"Note"),r.title(`Nota de Venta ${i.saleNote}`)):(loadReport(i.saleNote,i.subsidiary,"Bill",i.billSerie),r.title(`Factura de la Nota de Venta ${i.saleNote}`));r.open().center()}function showComments(n){var t=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),i=$(n.currentTarget).closest("tr");t.select(i);var u=t.dataItem(i),r=$("#Detail").data("kendoWindow"),f=kendo.template($("#template").html());r.content(f(u));r.center().open()}function loadReport(n,t,i,r){var e={Subsidiary:t,DocNumber:n,User:$.trim($(".user-info > .user-name").first().text())},u="SaleOrder.trdp",f;if(i==="Note"&&(u="SaleNote.trdp"),i==="Delivery"&&(u="DeliveryNote.trdp",e.SearchType=2),i==="Bill")switch(r){case 93:u="ElectronicBill.trdp";break;case 32:u="RentReceipt.trdp";break;default:u="Bill.trdp"}if(f=$("#reportViewer1").data("telerik_ReportViewer"),f)try{f.reportSource({report:u,parameters:e});f.refreshReport()}catch(o){showInfo("El servidor está ocupado, espere un momento y vuelva a intentar.")}else $("#reportViewer1").telerik_ReportViewer({serviceUrl:urlService,reportSource:{report:u,parameters:e},viewMode:telerikReportViewer.ViewModes.INTERACTIVE,scaleMode:telerikReportViewer.ScaleModes.SPECIFIC,scale:1})}function openAmount(n){var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),t;i.select(r);t=i.dataItem(r);$.get(urlGetOpenOrders,{CardCode:t.clientCode,Subsidiary:t.subsidiary},function(n){var i=$("#openOrdersList").data("kendoGrid"),t;n.orders.forEach(n=>n.docDate=JSON.toDate(n.docDate));t=new kendo.data.DataSource({data:n.orders});i.setDataSource(t);$("#OpenOrders").data("kendoWindow").open().center()})}function ordersTemplate(n){var t="";return n.saleOrder&&n.saleOrder!==""&&n.saleOrder!=="0"&&(t=n.saleOrder.includes(",")?Enumerable.From(n.saleOrder.split(", ")).Select(t=>`<a class="sale-order action action-link" data-id="${t}" data-subsidiary="${n.subsidiary}" data-delivery="${n.isDeliveryNote}">${t}</a>`).ToArray().join(", "):`<a class="sale-order action action-link" data-id="${n.saleOrder}" data-subsidiary="${n.subsidiary}" data-delivery="${n.isDeliveryNote}">${n.saleOrder}</a>`),t}function notesTemplate(n){var t="";return n.saleNote&&n.saleNote!==0&&(t=`<a class="sale-note action action-link">${n.saleNote}</a>`,n.subsidiary.toLowerCase()==="santa cruz"&&n.type.toLowerCase()==="factura"&&(t+=` ( <a class="sale-bill action action-link">Factura</a> )`)),t}function openDueAmounts(n){var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),t,u,f,e,o,s;i.select(r);t=i.dataItem(r);u=Enumerable.From(t.dueItems).Where("$.days > 0 & $.days < 16").Select("$.balance").Sum();f=Enumerable.From(t.dueItems).Where("$.days > 15 & $.days < 31").Select("$.balance").Sum();e=Enumerable.From(t.dueItems).Where("$.days > 30 & $.days < 46").Select("$.balance").Sum();o=Enumerable.From(t.dueItems).Where("$.days > 45").Select("$.balance").Sum();s=`<table class="table table-striped"><tbody><tr><td>Mora de 1 a 15 d&iacute;as</td><td class="text-right">${kendo.toString(u,"N2")}</td></tr><tr><td>Mora de 16 a 30 d&iacute;as</td><td class="text-right">${kendo.toString(f,"N2")}</td></tr><tr><td>Mora de 31 a 45 d&iacute;as</td><td class="text-right">${kendo.toString(e,"N2")}</td></tr><tr><td>Mora de m&aacute;s de 45 d&iacute;as</td><td class="text-right">${kendo.toString(o,"N2")}</td></tr></tbody></table>`;$("<div>").kendoWindow({visible:!0,modal:!0,iframe:!1,title:"Montos en Mora",resizable:!1,width:350,actions:["Close"],content:{template:s},activate:function(){var n=this;setTimeout(()=>n.center(),300)}})}const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},gridMargin=30,numberFormat="{0:#,##0.00}";var localUser=!1,permission={seeMargin:!1,seeAllClients:!1,sellerCode:""},showMargin=!1;$(()=>initForm());$(window).resize(()=>setHeights());$(document).ajaxError((n,t,i,r)=>catchError(n,t,i,r));$("#filter-box").on("hidden.bs.collapse",()=>setHeights());$("#filter-box").on("shown.bs.collapse",()=>setHeights());$('a[data-toggle="tab"]').on("shown.bs.tab",n=>setHeights(n));$("#action-clean").click(()=>cleanFilters());$("#action-filter").click(()=>filterData());$("#action-show-all").click(()=>toggleShowAll());$("#action-excel").on("click",()=>ExportExcel());$("#Listado").on("click",".sale-note",n=>showReport(n,"SaleNote"));$("#Listado").on("click",".sale-order",n=>showReport(n,"SaleOrder"));$("#Listado").on("click",".sale-bill",n=>showReport(n,"SaleBill"));$("#Listado").on("click",".comment",n=>showComments(n));$("#Resume").on("click",".open-amount",n=>openAmount(n));$("#Resume").on("click",".due-amount",n=>openDueAmounts(n));$("#openOrdersList").on("click",".sale-order",n=>showReport(n,"SaleOrder2"));