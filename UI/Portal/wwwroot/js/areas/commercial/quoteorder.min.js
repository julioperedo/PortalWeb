function setupControls(){var n=$("#Category"),t=$("#Subsidiary"),i,r;t.multipleSelect({selectAll:!1});n.multipleSelect({selectAll:!1});$("#Line").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una Línea ...",dataSource:{transport:{read:{url:urlGetLines}}}});$("#Products").kendoListView({template:kendo.template($("#productTemplate").html()),dataSource:[]});i=new Date;$("#SinceDate").kendoDatePicker({format:"d/M/yyyy",value:i});$("#UntilDate").kendoDatePicker({format:"d/M/yyyy",value:i});$("#Quotes").kendoListView({template:kendo.template($("#quoteTemplate").html()),dataSource:[]});$("#Client").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",dataSource:{transport:{read:{url:urlClients}}},virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}},change:function(){var n=this.value();$.get(urlClient,{CardCode:n},function(n){$("#ClientName").val(n.name);$("#ClientMail").val(n.eMail)})}});r=[{name:"fontName"},{name:"fontSize"},{name:"foreColor"},{name:"bold"},{name:"italic"},{name:"formatting"},{name:"indent"},{name:"insertOrderedList"},{name:"insertUnorderedList"},{name:"justifyCenter"},{name:"justifyFull"},{name:"justifyLeft"},{name:"justifyRight"},{name:"outdent"}];$("#Header").kendoEditor({tools:r});$("#Footer").kendoEditor({tools:r});$.get(urlGetCategories,{},t=>{t.forEach(t=>{n.append(new Option(t.name,t.name))}),n.multipleSelect("refresh")});$.get(urlGetSubsidiaries,{},n=>{n.forEach(n=>{t.append(new Option(n.name,n.name))}),t.multipleSelect("refresh")});$.get(urlGetSignature,{},n=>{$("#signature").append(n)})}function setHeight(){var n=$(window).height()-$(".title").height(),t;$(".quote .content").height(n-60);$("#Products").is(":visible")&&(t=$("#product-filters").height(),$("#Products").height(n-t-130),n=n-$("#tabstrip .k-content .quote-filter").height()-90,$(".product .data").width($("#Products").width()-40));$("#Quotes").is(":visible")&&(t=$("#quote-filters").height(),$(".quote-result .data").width($("#Quotes").width()-40),$("#Quotes").height(n-t-130))}function filterQuotes(){var n=$("#SinceDate").data("kendoDatePicker").value(),t=$("#UntilDate").data("kendoDatePicker").value(),i=$("#Name").val();n&&(n=n.toISOString());t&&(t=t.toISOString());$.get(urlFilter,{Since:n,Until:t,Client:i},function(n){var i=$("#Quotes").getKendoListView(),t;n.message===""?($("#quotes-resume").text("Se han encontrado "+n.items.length+" cotizaciones."),t=new kendo.data.DataSource({data:n.items})):($("#quotes-resume").text("Se ha producido un error."),t=new kendo.data.DataSource({data:[]}),showError(n.message));i.setDataSource(t);setHeight()})}function saveQuote(n){var t=getQuote();$.post(urlEdit,{Quote:t,SendMail:n},i=>{if(t=i.item,$("#IdQuote").val(t.id),$(".quote-header .code").text(t.quoteCode),i.message==="")if(n){showMessage("Correo enviado exitosamente.");var r=$(".quote-sent");isEmpty(r)&&(r.append($("<span>").addClass("label").text("Enviado a:")),r.append($("<br>")));r.append("<span class='date'>"+kendo.toString(new Date,"dd/MM/yyyy HH:mm")+" &nbsp;&nbsp;&nbsp;<\/span><span class='card-detail'>"+t.cardCode+" - "+t.cardName+" &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<\/span><span class='client'>"+t.clientName+" ( "+t.clientMail+" ) <\/span><br />")}else showMessage("Cotización Guardada Correctamente.");else showError(i.message)})}function getQuote(){var t,i,r,u,f,e,o,s,h=$(".quote-product"),n;return t=$("#IdQuote").val(),i=$(".quote-header .code").text(),r=$("#Client").getKendoDropDownList().value(),u=$("#Client").getKendoDropDownList().text().split(" - ")[1],f=$("#ClientName").val(),e=$("#ClientMail").val(),o=$("#Header").getKendoEditor().value(),s=$("#Footer").getKendoEditor().value(),n={Id:t,CardCode:r,QuoteCode:i,CardName:u,ClientName:f,ClientMail:e,Header:o,Footer:s,Details:[]},h.length>0&&$.each(h,function(t,i){var f,e,o,s,h,r,c=$(i).find(".price"),u;f=$(i).find("#IdProduct").val();e=$(i).find(".code").text();h=$(i).find(".code").parent().attr("href");o=$.trim($(i).find(".name").text());s=$(i).find(".k-editor").getKendoEditor().value();r=$(i).find("img").attr("src");r===urlNoImage&&(r="");u={IdProduct:f,ProductCode:e,ProductName:o,ProductLink:h,ProductDescription:s,ProductImageURL:r,Prices:[]};c.length>0&&$.each(c,function(n,t){var i,r,f,e,o,s;e=$(t).find(".selected-price").prop("checked");i=$(t).find(".subsidiary").text();intIdSubsidiary=$(t).find(".selected-price").val();f=$(t).find(".observations").text();r=+$(t).find("[id^='Price-']").val();o=+$(t).find("[id^='Quantity-']").val();s={IdSubsidiary:intIdSubsidiary,Subsidiary:i,Price:r,Quantity:o,Observations:f,Selected:e};u.Prices.push(s)});n.Details.push(u)}),n}function cleanForm(){$(".quote-header .code").text("");$(".quote-sent").empty();$("#IdQuote").val(0);$("#Client").getKendoDropDownList().value("");$("#ClientName").val("");$("#ClientMail").val("");$(".quote-product").remove();$("#Header").getKendoEditor().value("");$("#Footer").getKendoEditor().value("")}function isEmpty(n){return!$.trim(n.html())}function addProduct(n){var t=!1,i=$(".quote-product");return Enumerable.From(i).Where(function(t){return $(t).find(".code").text()==n}).Count()==0&&($.get(urlProduct,{ItemCode:n},function(n){var t=+$("#detail-count").val();t+=1;$("#detail-count").val(t);$("#detail-count-label").text(t);$("#quote-detail").append(n)}),t=!0),t}var objConfig={rules:{detail:function(n){return n.is("#detail-count")?+$.trim(n.val())>0:!0}},messages:{required:"*",detail:"Debe ingresar al menos un producto.",email:"Debe ser un correo válido."}},_intMaxItems=50;$(document).ready(function(){setupControls();setHeight()});$(window).resize(()=>{setHeight()});$("#search-products").click(()=>{var n=$("#Line").val(),t=$("#Category").multipleSelect("getSelects").join(),i=$("#ProductName").val(),r=$("#Subsidiary").multipleSelect("getSelects").join();$.get(urlFilterProducts,{IdLine:n,Category:t,Name:i,Available:r},n=>{var t,i,r;n.message===""?(t=n.items.length,n.items.length>0&&n.items.splice(0,0,{id:-1,name:"Agregar Todos",itemCode:"TODOS",prices:[],stock:[]}),$("#products-resume").text(`Se han encontrado ${t} productos.`),i=$("#Products").getKendoListView(),r=new kendo.data.DataSource({data:n.items}),i.setDataSource(r),setHeight()):showError(`Se ha producido el siguiente error al intentar traer los datos: <br /> ${n.message}`)})});$("#search-quotes").click(()=>{filterQuotes()});$('a[data-toggle="tab"]').on("shown.bs.tab",()=>{setHeight()});$("#Products").on("click",".product a",function(){var r="",n=$(this).parent().find(".code").text(),i;if(n=="TODOS"){var u=[],f=$("#Products .product a"),t=+$("#detail-count").val();for(t=f.length-t<=_intMaxItems?f.length-t:_intMaxItems-t,i=0;i<t;i++)n=$(f[i]).parent().find(".code").text(),n!="TODOS"?addProduct(n)||u.push(n):t++;u.length>0&&(r+=`<br />Los productos ${u.join(", ")} ya fueron agregados a la Cotización.`);r!=""&&showInfo(r)}else+$("#detail-count").val()<_intMaxItems?addProduct(n)||showInfo(`El producto ${n} ya fue agregado a la Cotización.`):showInfo(`Sólo se pueden agregar ${_intMaxItems} productos a una cotización.`)});$("#action-new").on("click",function(){cleanForm()});$("#action-save").on("click",function(){var n=$("#form-quote").kendoValidator(objConfig).data("kendoValidator");n.validate()&&saveQuote(!1)});$("#action-sendmail").on("click",function(){var n=$("#form-quote").kendoValidator(objConfig).data("kendoValidator");n.validate()&&saveQuote(!0)});$("#action-delete").on("click",function(){if(isEmpty($(".quote-sent"))){var n=+$("#IdQuote").val();n===0?cleanForm():$.post(urlDelete,{Id:n},function(t){t.message===""?(showMessage("Se eliminó la cotización correctamente."),$("#Quotes :input[value='"+n+"']").parent().parent().remove(),cleanForm()):showError(t.message)})}else showInfo("No se puede eliminar esta cotización porque ya fue enviada al Cliente.")});$(".quote .content").on("click",".remove-product",function(){var n=+$("#detail-count").val();n-=1;$("#detail-count").val(n);$("#detail-count-label").text(n);$(this).parent().remove()});$(".quote .content").on("click",".refresh-product",function(){var n=$(this).parent(),t=n.find(".code").text();$.get(urlProduct,{ItemCode:t},function(t){n.after(t);n.remove()})});$("#Quotes").on("click",".quote-result a",function(){var n=$(this).parent().find(".IdQuote").val();$.get(urlEdit,{Id:n},function(n){var t,i,r,u;n.message===""?(t=n.item,$("#IdQuote").val(t.id),$(".code").text(t.quoteCode),i=$(".quote-sent"),i.empty(),$(".quote-header").removeClass("p-4"),t.sentMails&&t.sentMails.length>0&&($(".quote-header").addClass("p-4"),i.append($("<span>").addClass("label").text("Enviado a:")),i.append($("<br>")),t.sentMails.forEach(n=>{i.append($("<span>").addClass("date").text(`${n.date}`)),i.append($("<span>").addClass("card-detail").text(`${n.cardDeatil}`)),i.append($("<span>").addClass("client").text(`${n.clientDetail}`)),i.append($("<br>"))})),$("#Client").getKendoDropDownList().value(t.cardCode),$("#ClientName").val(t.clientName),$("#ClientMail").val(t.clientMail),$("#Header").data("kendoEditor").value(t.header),$("#detail-count-label").text(t.details.length),$("#detail-count").val(t.details.length),r=$("#quote-detail"),r.empty(),u=kendo.template($("#addedProductTemplate").html()),t.details&&t.details.length>0&&(t.details.forEach(n=>{n.imageUrl=$.trim(n.productImageURL)===""?urlNoImage:urlFolder+n.productImageURL,n.name=`Detail-${n.id}-${(new Date).getTime()}`,r.append(u(n))}),$(".description-editor").kendoEditor({tools:[{name:"foreColor"},{name:"backColor"},{name:"fontSize"},{name:"bold"},{name:"italic"},{name:"underline"},{name:"justifyLeft"},{name:"justifyCenter"},{name:"justifyRight"},{name:"justifyFull"},{name:"indent"},{name:"insertOrderedList"},{name:"insertUnorderedList"}]})),$("#Footer").data("kendoEditor").value(t.footer)):showError(`Se produjo un error al traer los datos del servidor: <br /> ${n.message}`)})});$("#Products").on("click",".selected-product",function(){this.dataset.value==="TODOS"&&$("#Products .product .selected-product").prop("checked",this.checked)});$("#Products").on("click",".add-selected",function(){var t=$("#Products .product .selected-product:checked"),n;t.length>0&&(n=[],t.each(function(t,i){if(n.length<_intMaxItems){var r=i.dataset.value;r!=="TODOS"&&(addProduct(r)||n.push(r))}}),n.length>0&&showInfo("<br />Los productos "+n.join(", ")+" ya fueron agreagados a la Cotización."))});$("#ProductName").bind("paste",function(n){var i=n.originalEvent.clipboardData.getData("text"),t=[];i.indexOf("\n")>=0||i.indexOf("\t")>=0?i.split("\t").forEach(n=>{$.trim(n)!==""&&(n.indexOf("\n")>=0?n.split("\n").forEach(n=>{$.trim(n)!==""&&t.push(`'${$.trim(n)}'`)}):t.push(`'${$.trim(n)}'`))}):t.push(`'${$.trim(i)}'`);t.length>0;$.get(urlFilterProducts2,{ItemCodes:t.join()},function(n){var t,i,r,u;n.message===""?(t=n.items,i=t.length,t.length>0&&t.splice(0,0,{id:-1,name:"Agregar Todos",itemCode:"TODOS",prices:[],stock:[]}),$("#products-resume").text(`Se han encontrado ${i} productos.`),r=$("#Products").getKendoListView(),u=new kendo.data.DataSource({data:t}),r.setDataSource(u),setHeight()):showError(`Se ha producido el siguiente error al traer los datos del servidor: <br />${n.message}`)})});