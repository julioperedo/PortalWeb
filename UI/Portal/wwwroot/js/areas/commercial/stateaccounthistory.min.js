function setupControls(){var i=$("#isClient").val(),n,t;i==="N"&&$("#clients").kendoDropDownList({dataSource:{transport:{read:{url:urlClients}}},dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un cliente",filter:"contains",virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}}});n=new Date;t=new Date(n.getFullYear(),n.getMonth()-1,n.getDate());$("#initialDate").kendoDatePicker({value:t});$("#finalDate").kendoDatePicker({value:n});$("#Listado").kendoGrid({dataSource:{data:[]},sortable:!0,selectable:!0,pageable:!1,noRecords:{template:"No hay registros para el criterio de búsqueda"},columns:[{field:"subsidiary",title:"Sucursal",width:120},{field:"type",title:"Tipo",width:150},{field:"docNum",title:"No. Doc.",template:templateDocNum,width:90},{field:"docDate",title:"Fecha",format:"{0:dd-MM-yyyy}",attributes:alignCenter,headerAttributes:alignCenter,width:90},{field:"docTotal",title:"Monto",format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight,width:100},{field:"terms",title:"Referencia"},{field:"sellerName",title:"Ejecutivo Ventas"}]});setGridHeightLocal();$("#report").removeClass("hidden");$("#report").kendoWindow({visible:!1,width:1100,title:"Nota de Venta",modal:!0});$("#detail").kendoWindow({visible:!1,width:650,title:"Recibo de Pago",modal:!0})}function loadData(n,t,i){var r="dd-MM-yyyy";$.get(urlFilter,{ClientCode:n,InitialDate:t,FinalDate:i},n=>{var s,e,u;if(n.message===""){loadGrid(n.items);var o=$("#periodBefore"),f=$("#periodSelected"),h=$("#periodNow");o.empty();s=0;n.before&&(u=$("<tr>").addClass("level-1"),u.append($("<td>").attr("colspan",2).addClass("text-right").addClass("text-nowrap").text(`antes de ${kendo.toString(JSON.toDate(t),r)}`)),o.append(u),n.before.forEach(n=>{u=$("<tr>"),u.append($("<td>").text(n.type)),u.append($("<td>").addClass("text-right").text(`${kendo.toString(n.total,"N2")}`)),o.append(u),s+=n.total}));f.empty();n.selected&&(u=$("<tr>").addClass("level-1"),u.append($("<td>").attr("colspan",2).addClass("text-right").addClass("text-nowrap").text(`${kendo.toString(JSON.toDate(t),r)} al ${kendo.toString(JSON.toDate(i),r)}`)),f.append(u),e=0,n.selected.forEach(n=>{u=$("<tr>"),u.append($("<td>").text(n.type).addClass("text-nowrap")),u.append($("<td>").addClass("text-right").text(`${kendo.toString(n.total,"N2")}`)),f.append(u),e+=n.total}),s+=e,u=$("<tr>").addClass("level-2"),u.append($("<td>").text("TOTAL PERIODO")),u.append($("<td>").addClass("text-right").text(`${kendo.toString(e,"N2")}`)),f.append(u));h.empty();u=$("<tr>").addClass("level-4");u.append($("<td>").text("BALANCE"));u.append($("<td>").addClass("text-right").text(`${kendo.toString(n.balance,"N2")}`));h.append(u);showExports(!0)}else showExports(!1),showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`)})}function cleanDetail(){loadGrid([]);showExports(!1)}function loadGrid(n){n.forEach(n=>{n.docDate=JSON.toDate(n.docDate)});var t=$("#Listado").data("kendoGrid"),i=new kendo.data.DataSource({data:n});t.setDataSource(i);n&&n.length>0?($("#filter-box").collapse("hide"),$("#action-excel").removeClass("d-none")):$("#action-excel").addClass("d-none");setGridHeight("Listado",_gridMargin)}function setGridHeightLocal(){var n=$(".navbar").height(),t=$(".toolbar").height(),i=$(window).height(),r=$("footer").height(),u=$("#Listado").height(),f=$("#Listado").find(".k-grid-content").height(),e=i-n-r-t-26-u+f;$("#Listado").find(".k-grid-content").height(e)}function showExports(n){$("#label-exports, #action-excel").toggleClass("hidden",!n)}function templateDocNum(n){var t=$("#isClient").val()==="N";return n.typeId==="NV"?`<a class="sale-note action action-link">${n.docNum}</a>`:n.typeId==="PE"?`<a class="payment action action-link">${n.docNum}</a>`:(n.typeId==="AC"||n.typeId==="D")&t?`<a class="credit-note action action-link">${n.docNum}</a>`:n.docNum}const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},_gridMargin=-20;$(function(){setupControls()});$(window).resize(function(){setGridHeightLocal()});$("#filter").click(()=>{var u=$("#isClient").val(),r=u==="N"?$("#clients").data("kendoDropDownList").value():$("#clients").val(),n=$("#initialDate").data("kendoDatePicker").value(),t=$("#finalDate").data("kendoDatePicker").value(),i="";r===""&&(i+="- Cliente <br />");n||(i+="- Fecha Inicial <br />");t||(i+="- Fecha Final <br />");n&&t&&(n>t?i+="- La Fecha Inicial debe ser menor a la Fecha Final <br />":(n=n.toISOString(),t=t.toISOString()));i===""?loadData(r,n,t):showInfo(`Se requieren los siguientes campos: <br /> ${i}`)});$("#action-excel").click(()=>{var u=$("#isClient").val(),r=u==="N"?$("#clients").data("kendoDropDownList").value():$("#clients").val(),n=$("#initialDate").data("kendoDatePicker").value(),t=$("#finalDate").data("kendoDatePicker").value(),i="";r===""&&(i+="- Cliente <br />");n||(i+="- Fecha Inicial <br />");t||(i+="- Fecha Final <br />");n&&t&&(n>t?i+="- La Fecha Inicial debe ser menor a la Fecha Final <br />":(n=n.toISOString(),t=t.toISOString()));i===""?window.location.href=urlExport+"?"+$.param({ClientCode:r,InitialDate:n,FinalDate:t}):showInfo(`Se requieren los siguientes campos: <br /> ${i}`)});$("#Listado").on("click",".sale-note",function(){var f=$("#report").data("kendoWindow"),t=$("#Listado").data("kendoGrid"),i=$(this).closest("tr"),r=t.dataItem(i);t.select(i);var e=$.trim($(".user-info > .user-name").first().text()),u={report:"SaleNote.trdp",parameters:{Subsidiary:r.subsidiary,DocNumber:r.docNum,User:e}},n=$("#reportViewer1").data("telerik_ReportViewer");if(n)try{n.reportSource(u);n.refreshReport()}catch(o){showInfo("El servidor está ocupado, espere un momento y vuelva a intentar.")}else $("#reportViewer1").telerik_ReportViewer({serviceUrl:urlService,reportSource:u,viewMode:telerikReportViewer.ViewModes.INTERACTIVE,scaleMode:telerikReportViewer.ScaleModes.FIT_PAGE_WIDTH});f.open().center()});$("#Listado").on("click",".payment",function(){var n=$("#detail").data("kendoWindow"),t=$("#Listado").data("kendoGrid"),i=$(this).closest("tr"),r=t.dataItem(i);t.select(i);$.get(urlPayment,{Subsidiary:r.subsidiary,DocNum:r.docNum},function(t){if(t.message===""){var i=kendo.template($("#template").html());t.item.docDate=JSON.toDate(t.item.docDate);t.item.notes.forEach(n=>{n.fecha=JSON.toDate(n.fecha)});n.content(i(t.item));n.center().open()}else showError(`Se ha producido el siguiente error: <br />${t.message}.`)})});$("#Listado").on("click",".credit-note",function(){var f=$("#report").data("kendoWindow"),i=$("#Listado").data("kendoGrid"),r=$(this).closest("tr"),n=i.dataItem(r);i.select(r);var e=$.trim($(".user-info > .user-name").first().text()),u={report:n.typeId==="AC"?"CreditNote.trdp":"CreditNoteItem.trdp",parameters:{Subsidiary:n.subsidiary,DocNumber:n.docNum,User:e}},t=$("#reportViewer1").data("telerik_ReportViewer");if(t)try{t.reportSource(u);t.refreshReport()}catch(o){showInfo("El servidor está ocupado, espere un momento y vuelva a intentar.")}else $("#reportViewer1").telerik_ReportViewer({serviceUrl:urlService,reportSource:u,viewMode:telerikReportViewer.ViewModes.INTERACTIVE,scaleMode:telerikReportViewer.ScaleModes.FIT_PAGE_WIDTH});f.open().center()});