function setupControls(){permission=JSON.parse($("#kbytes-data").val());var n=permission.AllClients>0?urlClients:urlSellerClients;$("#clients").kendoDropDownList({dataSource:{transport:{read:{url:n}}},dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un cliente",filter:"contains",virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}},change:function(){var n=this.value();n!==""?loadDetail(n):cleanDetail()}});$("#subsidiaries").kendoDropDownList({dataSource:{transport:{read:{url:urlSubsidiaries}}},dataTextField:"name",dataValueField:"name",optionLabel:"Seleccione una Sucursal",filter:"contains"});$("#status-used").kendoDropDownList({dataSource:{transport:{read:{url:urlStatus}}},dataTextField:"name",dataValueField:"id"});$("#report").kendoWindow({visible:!1,width:1100,title:"Nota de Venta",modal:!0});$("#addNoteWindow").kendoWindow({visible:!1,width:1200,title:"Adicionar Orden/Nota de Venta",modal:!0})}function loadDetail(n){cleanDetail();var t=$("#resumes");$.get(urlDetail,{CardCode:n},function(n){var r;if(n.message===""){var u=`<div class="panel width-panel">
                                <div class="row">
                                    <div class="col text-center details-title">
                                        <div>
                                            <span class="small-label">año</span><br />
                                            <span class="year-title">#=year#</span><br />
                                        </div>                    
                                        <a class="see-details" data-type="N" data-year="#=year#"><span class="small-label action">ver detalle</span></a>
                                    </div>
                                    <div class="col text-right details">
                                        <div>
                                            <span class="year-values">#=kendo.toString(amount, "N2")#</span><br />
                                            <span class="small-label">monto acumulado</span>
                                        </div>
                                        <div>
                                            <span class="year-values">#=kendo.toString(points, "N0")#</span><br />
                                            <span class="small-label">puntos acumulados</span>
                                        </div>
                                        <div>
                                            <span class="year-values">#=status#</span><br />
                                            <span class="small-label">status</span>
                                        </div>
                                    </div>
                                </div>
                            </div>`,f=kendo.template(u),i=$("<div>").addClass("float-left").addClass("width-panel"),e=`<div class="panel available width-panel">
                                <div class="row">
                                    <div class="col text-center">
                                        <div>                                                
                                            <span class="points-title">${kendo.toString(n.availablePoints,"N0")}</span><br />                                       
                                            <span class="small-label">puntos disponibles</span>
                                        </div>
                                    </div>                                       
                                </div>
                            </div>`;i.append(e);n.claimedPoints>0&&(r=`<div class="panel  width-panel">
                                   <div class="row">
                                       <div class="col text-center">
                                            <div>
                                                <span class="small-label">puntos usados</span>
                                                <span class="points-title">${kendo.toString(n.claimedPoints,"N0")}</span>                                                
                                            </div>
                                            <a class="see-details" data-type="UP" data-year="0"><span class="small-label action">ver detalle</span></a>
                                       </div>                                       
                                   </div>
                               </div>`,i.append(r));t.append(i);n.years.forEach(n=>{t.append(f(n))});$("#action-excel").removeClass("d-none");permission.AddNote>0&&$("#action-add").removeClass("d-none")}else showError(`Se ha producido el siguiente error al intentar traer los datos: <br /> ${n.message}.`)})}function cleanDetail(){$("#resumes").empty();loadGridNotes([]);$("#notesContainer").addClass("d-none");loadGridAwards([]);$("#awardsContainer").addClass("d-none");$("#action-excel").addClass("d-none");$("#action-add").addClass("d-none")}function loadGridNotes(n){var r,u,t,i;n.forEach(n=>{n.date=JSON.toDate(n.date)});$("#notesContainer").removeClass("d-none");$("#awardsContainer").addClass("d-none");r=$("#listNotes").data("kendoGrid");r?(u=new kendo.data.DataSource({data:n}),r.setDataSource(u)):(t=[{field:"subsidiary",title:"Sucursal"},{field:"number",title:"No. Nota",template:'# if(id) { # <a class="sale-note action action-link">#=number#<\/a> # } else { # <span>Canje Puntos<\/span>  # } #'},{field:"date",title:"Fecha",format:"{0:dd-MM-yyyy}",attributes:alignCenter,headerAttributes:alignCenter},{field:"amount",title:"Monto",format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight},{field:"status",title:"Status"},{field:"statusUsed",title:"Status Aplicado"}],permission.ExtraPoints>0?t.splice(7,0,{field:"points",title:"Puntos",format:"{0:N0}",attributes:alignRight,headerAttributes:alignRight},{field:"extraPoints",title:"Puntos Acelerador",format:"{0:N0}",attributes:alignRight,headerAttributes:alignRight},{field:"extraPointsPeriod",title:"Puntos Ace. (Periodo)",format:"{0:N0}",attributes:alignRight,headerAttributes:alignRight},{field:"acceleratorPeriod",title:"Acelerador (Periodo)",format:"{0:N0}",attributes:alignRight,headerAttributes:alignRight}):t.splice(7,0,{field:"itemPoints",title:"Puntos",format:"{0:N0}",attributes:alignRight,headerAttributes:alignRight}),i={dataSource:{data:n},sortable:!0,selectable:!0,pageable:!1,noRecords:{template:"No hay registros para el criterio de búsqueda"},columns:t},permission.SeeDetail>0&&(i.detailTemplate=kendo.template($("#detailOrder").html()),i.detailInit=function(n){var t=n.data.id;$.get(urlNoteItems,{NoteId:t},function(t){t.message===""?$("<div>").appendTo(n.detailCell).kendoGrid({scrollable:!1,sortable:!0,pageable:!1,selectable:!0,columns:[{field:"itemCode",title:"Item",width:150},{field:"itemName",title:"Descripción"},{field:"line",title:"Línea"},{field:"quantity",title:"Cantidad",width:90,attributes:alignRight,headerAttributes:alignRight},{field:"total",title:"Subtotal",width:90,format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight},{field:"acceleratedQuantity",title:"Cant. Acelerador",width:130,attributes:alignRight,headerAttributes:alignRight},{field:"acceleratedTotal",title:"Subtotal Acelerador",width:150,format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight},{field:"accelerator",title:"Acelerador",width:120,format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight},{field:"extraPoints",title:"Puntos Extra",width:130,format:"{0:N0}",attributes:alignRight,headerAttributes:alignRight}],dataSource:t.items,noRecords:{template:"No hay items con acelerador"}}):showError(`Se ha producido el siguiente error al traer los datos: ${t.message}.`)})}),$("#listNotes").kendoGrid(i))}function loadGridAwards(n){var t,i;n.forEach(n=>{n.claimDate=JSON.toDate(n.claimDate)});$("#notesContainer").addClass("d-none");$("#awardsContainer").removeClass("d-none");t=$("#listAwards").data("kendoGrid");t?(i=new kendo.data.DataSource({data:n}),t.setDataSource(i)):$("#listAwards").kendoGrid({dataSource:{data:n},sortable:!0,selectable:!0,pageable:!1,noRecords:{template:"No hay registros para el criterio de búsqueda"},columns:[{field:"claimDate",title:"Fecha",format:"{0:dd-MM-yyyy}",width:100,attributes:alignCenter,headerAttributes:alignCenter},{field:"quantity",title:"Cantidad",width:80,attributes:alignRight,headerAttributes:alignRight},{field:"award",title:"Premio"},{field:"points",title:"Puntos Usados",width:120,format:"{0:N0}",attributes:alignRight,headerAttributes:alignRight}]})}function loadReport(n,t){var u=$.trim($(".user-info > .user-name").first().text()),r={report:"SaleNote.trdp",parameters:{Subsidiary:t,DocNumber:n,User:u}},i=$("#reportViewer1").data("telerik_ReportViewer");if(i)try{i.reportSource(r);i.refreshReport()}catch(f){showInfo("El servidor está ocupado, espere un momento y vuelva a intentar.")}else $("#reportViewer1").telerik_ReportViewer({serviceUrl:urlService,reportSource:r,viewMode:telerikReportViewer.ViewModes.INTERACTIVE,scaleMode:telerikReportViewer.ScaleModes.FIT_PAGE_WIDTH})}function cleanFormAdd(){$("#note-data").val("");$("#client-name").text("");$("#seller-name").text("");$("#client-order").text("");$("#status-used").data("kendoDropDownList").value("1");$("#accelerator-extra").val("0");$("#order-number").text("");$("#order-total").text("");$("#order-date").text("");$("#order-state").text("");$("#note-number").text("");$("#note-total").text("");$("#note-date").text("");$("#note-items").data("kendoGrid").setDataSource([])}const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"};var permission;$(()=>setupControls());$(document).ajaxError(onReportError);$("#listNotes").on("click",".sale-note",function(n){var u=$("#report").data("kendoWindow"),i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),t;i.select(r);t=i.dataItem(r);loadReport(t.number,t.subsidiary);u.open().center()});$("#resumes").on("click",".see-details",function(){$("#resumes .selected").removeClass("selected");$(this).closest(".panel").addClass("selected");var n=$("#clients").data("kendoDropDownList").value(),t=this.dataset;t.type==="N"?$.get(urlNotes,{CardCode:n,Year:t.year},function(n){n.message===""?loadGridNotes(n.items):(console.error(n.message),showError("Se ha producido un error al traer los datos del servidor"))}):$.get(urlAwards,{CardCode:n},function(n){n.message===""?loadGridAwards(n.items):(console.error(n.message),showError("Se ha producido un error al traer los datos del servidor"))})});$("#action-excel").click(function(n){n.preventDefault();var t=$("#year").val(),i=$("#clients").val();i!==""&&t!==""&&(window.location.href=urlExportExcel+"?"+$.param({CardCode:i,Year:t}))});$("#action-add").click(function(){$("#addNoteWindow").data("kendoWindow").center().open()});$("#search-button").click(function(){var r=$("#search-form").kendoValidator({messages:{required:"*"}}).data("kendoValidator");if(r.validate()){var n=$("#number").val(),t=$("#subsidiaries").data("kendoDropDownList").value(),i=$("#clients").val();$.get(urlNote,{Number:n,Subsidiary:t},function(r){var u,f;r.message===""?r.valid?(u=r.item,u.noteDate=JSON.toDate(u.noteDate),u.orderDate=JSON.toDate(u.orderDate),$("#note-data").val(JSON.stringify(u)),$("#client-name").text(u.clientName),$("#seller-name").text(u.sellerName),$("#client-order").text(u.clientOrder),$("#status-used").data("kendoDropDownList").value("1"),$("#order-number").text(u.orderNumber),$("#order-total").text(kendo.toString(u.orderTotal,"N2")+" $Us"),$("#order-date").text(kendo.toString(u.orderDate,"dd-MM-yyyy")),$("#order-state").text(u.orderState),$("#note-number").text(u.noteNumber),$("#note-total").text(kendo.toString(u.noteTotal,"N2")+" $Us"),$("#note-date").text(kendo.toString(u.noteDate,"dd-MM-yyyy")),f=$("#note-items").data("kendoGrid"),f?f.setDataSource(u.items):$("#note-items").kendoGrid({dataSource:{data:u.items},sortable:!0,selectable:!0,pageable:!1,noRecords:{template:"No hay registros para el criterio de búsqueda"},columns:[{field:"code",title:"Cod. Item",width:150},{field:"name",title:"Detalle"},{field:"quantity",title:"Cantidad",width:90,attributes:alignRight,headerAttributes:alignRight},{field:"accelerator",title:"Acelerador",width:110,attributes:alignRight,headerAttributes:alignRight},{field:"availableQuantity",title:"Cant. Disponible",width:140,attributes:alignRight,headerAttributes:alignRight},{title:"Acc",width:60,attributes:alignCenter,template:function(n){return n.accelerator>0&n.availableQuantity>0?`<div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input acc-used" id="use-${n.id}"><label class="custom-control-label" for="use-${n.id}">&nbsp;</label></div>`:""}},{title:"Usar",width:60,attributes:alignCenter,template:n=>`<div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="enabled-${n.id}" checked="checked"><label class="custom-control-label" for="enabled-${n.id}">&nbsp;</label></div>`}]}),$("#addNoteWindow").data("kendoWindow").center(),i.toLowerCase()===u.clientCode.toLowerCase()?$("#save-note").removeAttr("disabled"):($("#save-note").attr("disabled","disabled"),showInfo(`La nota no pertenece al cliente ${i}`))):showInfo(`El código <b>${n}</b> no corresponde a una Nota de Venta válida para <b>${t}</b>.`):showError("Se ha producido un error al traser los datos del servidor.")})}});$("#save-note").click(function(){var n=JSON.parse($("#note-data").val()),t;n.orderDate=JSON.toDate(n.orderDate);n.noteDate=JSON.toDate(n.noteDate);t={Subsidiary:$("#subsidiaries").data("kendoDropDownList").text(),Number:n.noteNumber,CardCode:n.clientCode,NoteDate:kendo.toString(n.noteDate,"yyyy-MM-dd"),Amount:n.noteTotal,Terms:n.terms,IdStatus:$("#status-used").data("kendoDropDownList").value(),AcceleratorPeriod:$("#accelerator-extra").val(),Items:[]};n.items.forEach(n=>{var r=$("#note-items").find(`#enabled-${n.id}`),f=r&&r.prop("checked"),i={IdProduct:n.id,Quantity:n.quantity,Total:n.total,AcceleratedQuantity:0,AcceleratedTotal:0,Accelerator:0,ExtraPoints:0,IdLot:0,Enabled:f},u=$("#note-items").find(`#use-${n.id}`);u&&u.prop("checked")&&(i.Accelerator=n.accelerator,i.AcceleratedQuantity=n.availableQuantity>n.quantity?n.quantity:n.availableQuantity,i.AcceleratedTotal=n.price*i.AcceleratedQuantity,i.ExtraPoints=i.AcceleratedTotal*(n.accelerator-1),i.IdLot=n.idLot,i.RemainQuantity=n.availableQuantity-i.AcceleratedQuantity);t.Items.push(i)});$.post(urlSaveNote,{Item:t},n=>{if(n.message===""){showInfo("Se ha guardado la Nota correctamente.");var t=n.status;$("#currentAmount").text(` $US ${kendo.toString(t.amount,"N2")}`);$("#currentPoints").text(kendo.toString(t.points,"N0"));$("#currentState").text(t.status.name);$("#currentRate").text(kendo.toString(t.status.points,"N2"));loadGridNotes(n.items);cleanFormAdd();$("#addNoteWindow").data("kendoWindow").close()}else console.error(n.message),showError("Se ha producido un error al guardar la Nota.")})});