function setupControls(){loadRelatedProducts(5);loadBanner()}function loadRelatedProducts(n){$.get(urlGetRelatedProducts,{Quantity:n},function(n){if(n.message===""){if(n.items&&n.items.length>0){var t=$("#col-related");t.removeClass("d-none");n.items.forEach(function(n){var i=$.trim(n.imageURL)!==""?`${urlImages}products/${n.imageURL}`:urlNoImage,r=`<div class="product"><img src="${i}" alt="" /><div><b>${n.itemCode}</b><br />${n.name}<br /><button class="btn btn-outline-secondary add-cart" data-id="${n.id}" data-code="${n.itemCode}" data-name="${n.name}" data-prices="${JSON.stringify(n.prices).replaceAll('"',"&quot;")}"><i class="fas fa-cart-plus"></i> Agregar</button></div></div>`;t.append(r)})}}else console.error(n.message)})}function loadBanner(){$.get(urlGetBanner,{},function(n){var t,i;n.message===""?n.item&&(t=$("#col-promos"),t.removeClass("d-none"),i=JSON.stringify(n.item.items),t.append(`<a class="add-promo" data-items='${i}'><img src="${urlImages}promobanner/${n.item.imageUrl}" alt="" /></a>`)):console.error(n.message)})}function SaveCart(n){n.preventDefault();var t=getCart();$.post(urlEditShoppingCart,{Item:t},function(n){n.message===""?$(".shoppingcart").find(".shopping-cart-id").val(n.id):showError("Se ha producido el siguiente error al intentar guardar el Carrito de Compras: <br />"+n.message)})}function SendCart(n){n.preventDefault();validateShoppingCart()?showConfirm("¿Está seguro que ya terminó su selección, no desea agregar más productos?",function(){var n=getCart();$.post(urlSendShoppingCart,{Item:n},function(n){n.message===""?($(".tab-content table").remove(),$(".no-items").removeClass("d-none"),showMessage("Los Items en el Carrito de Compras fueron guardados y enviados correctamente a su Ejecutivo de Cuenta.")):showError("Se ha producido el siguiente error al intentar guardar y enviar el Carrito de Compras: <br />"+n.message)})}):showNotification("","Hay items que requieren atención.","error")}function DeleteCart(n){n.preventDefault();showConfirm("¿Está seguro que desea eliminar los datos de su carrito?",function(){var n=$("#shopping-cart-id").val();n!=="0"&&$.post(urlDeleteShoppingCart,{Id:n},function(n){n.message===""?($(".tab-content table").remove(),$(".no-items").removeClass("d-none"),showMessage("Los Items en el Carrito de Compras fueron eliminados.")):showError("Se ha producido el siguiente error al intentar eliminar el Carrito de Compras: <br />"+n.message)})})}function getCart(){var n={Id:$("#shopping-cart-id").val(),Name:$("#shoppingcart-name").val(),Address:$("#shoppingcart-address").val(),Commentaries:$("#shoppingcart-comments").val(),ClientSaleNote:$("#shoppingcart-clientsalenote").val(),SellerCode:$("#sellerCode").val(),WithDropShip:$("#shoppingcart-dropship").prop("checked"),ListSaleDetails:[]};return $.each($(".shoppingcart tbody tr"),function(t,i){var r,u,f,e;u=$(i).find(".product-id").val();r=$(i).find(".item-quantity").val();f=$(i).find(".price").text().replace(",","");e=$(i).find("[id^='subsidiaries-']").getKendoDropDownList().value();n.ListSaleDetails.push({IdProduct:u,Quantity:r,Warehouse:"",Price:f,IdSubsidiary:e})}),n}function validateShoppingCart(){var n=$("#tabshoppingcart").find("form").kendoValidator({rules:{quantity:function(n){if(n.is("[type=number]")){var i=n.closest("tr"),r=i.find("[id^='subsidiaries-']").getKendoDropDownList().value(),u=JSON.parse(i.find(".detail-data").val()),t=u.find(n=>n.id===+r);return t&&(t.stock>0||t.isDigital)}return!0}},messages:{quantity:"Sin Stock",required:"",min:"Debe ser mayor a 0"}}).data("kendoValidator");return n.reset(),n.validate()}function onSubsidiaryChange(n){var u=this.value(),s=$(this.element).attr("id"),t=$("#"+s).closest("tr"),h=JSON.parse(t.find(".detail-data").val()),f,r,e,o,i;f=u!==""?Enumerable.From(h).Where(n=>n.id===+u).FirstOrDefault():{price:0,stock:0};r=parseInt(t.find(".item-quantity").val());e=parseFloat(t.find(".subtotal").text().replace(",",""));o=parseFloat(t.closest("table").find(".total").text().replace(",",""));i=f.price;t.find(".price").text(kendo.toString(i,"#,##0.00"));t.find(".subtotal").text(kendo.toString(r*i,"#,##0.00"));t.closest("table").find(".total").text(kendo.toString(o-e+r*i,"N2"));SaveCart(n)}function onQuantityChange(n){var t=$(this).closest("tr"),u=parseInt($(this).val()),i=parseFloat(t.find(".price").text().replace(",","")),o=parseFloat(t.find(".subtotal").text().replace(",","")),s=parseFloat($(this).closest("table").find(".total").text().replace(",","")),r=t.find(":input.item-subsidiary").val(),f,e;r&&r!==""&&(f=JSON.parse(t.find(".detail-data").val()),e=Enumerable.From(f).Where(n=>n.id===+r).FirstOrDefault(),i=e.price);t.find(".price").text(kendo.toString(i,"#,##0.00"));t.find(".subtotal").text(kendo.toString(u*i,"#,##0.00"));$(this).closest("table").find(".total").text(kendo.toString(s-o+u*i,"N2"));SaveCart(n)}function addItem(n){var t=n.currentTarget.dataset,r=t.id,f=t.code,e=t.name,u=JSON.parse(t.prices),o=u[0].id,i=+u[0].price,s=$("#tabshoppingcart table tbody");$.post(urlAddItem,{IdProduct:r,Quantity:1,Price:i,OpenBox:!1,IdSubsidiary:o,Warehouse:""},function(u){var o,h;u.message===""?($(n.currentTarget).closest(".product").remove(),o=`<tr>
                       <td class="pt-4">
                           <span class="item-code">${f}</span>
                           <input type="hidden" class="product-id" value="${r}">
                           <input type="hidden" class="detail-id" value="${u.id}">
                           <input type="hidden" class="detail-data" value="${t.prices.replaceAll('"',"&quot;")}">
                       </td>
                       <td class="pt-4"><span class="item-name">${e}</span></td>
                       <td style="width: 95px;">
                           <input id="subsidiaries-${u.id}" />
                       </td>
                       <td class="text-right pt-4"><span class="price">${kendo.toString(i,"N2")}</span></td>
                       <td>
                           <input id="item-quantity-${u.id}" name="item-quantity-${u.id}" class="k-textbox item-quantity" type="number" value="1" min="1" style="width: 80px;" required>
                           <span class="k-invalid-msg" data-for="item-quantity-${u.id}"></span>
                       </td>
                       <td class="text-right pt-4"><span class="subtotal">${kendo.toString(i,"N2")}</span></td>
                       <td class="text-center pt-4"><a class="delete-item action action-link" title="Quitar Producto"><i class="fas fa-trash-alt"></i></a></td>
                   </tr>`,s.append(o),$(`#subsidiaries-${u.id}`).kendoDropDownList({change:onSubsidiaryChange,dataSource:{transport:{read:{url:urlGetSubsidiariesByProduct,data:{ProductId:r}}}},ignoreCase:!0,optionLabel:"Seleccione una Sucursal...",value:1,filter:"contains",dataTextField:"name",dataValueField:"id"}),loadRelatedProducts(1),h=parseFloat($("#tabshoppingcart").find(".total").text().replace(",","")),$("#tabshoppingcart").find(".total").text(kendo.toString(h+i,"N2"))):(console.error(u.message),showError(`Ha ocurrido un error al intentar agregar el item al carrito.<br />${u.message}`))})}function deleteItem(){var t=$(this).closest("tr"),r=parseFloat(t.find(".subtotal").text().replace(",","")),u=parseFloat($(this).closest("table").find(".total").text().replace(",","")),i=t.find(".item-code").text(),f=t.find(".detail-id").val(),n=this;showConfirm(`¿Está seguro que desea eliminar de su carrito el item <b>${i}</b>?`,function(){$.post(urlDeleteItem,{Id:f},function(t){t.message===""?($(n).closest("table").find(".total").text(kendo.toString(u-r,"N2")),$(n).closest("tbody").find("tr").length===1?($(n).closest(".shoppingcart").find(".send-cart").addClass("disabled"),$(n).closest("table").remove(),$(".no-items").removeClass("d-none")):$(n).closest("tr").remove()):(console.error(t.message),showError(`Se ha producido un error al intentar eliminar el item <b>${i}</b>`))})})}function addPromo(n){var t=JSON.parse(n.currentTarget.dataset.items),i=$("#tabshoppingcart table tbody");console.log(t);t.forEach(function(n){console.log(n);$.post(urlAddItem,{IdProduct:n.id,Quantity:1,Price:n.price,OpenBox:!1,IdSubsidiary:n.idSubsidiary,Warehouse:""},function(t){var r,u;t.message===""?(r=`<tr>
                       <td class="pt-4">
                           <span class="item-code">${n.productCode}</span>
                           <input type="hidden" class="product-id" value="${n.id}">
                           <input type="hidden" class="detail-id" value="${t.id}">
                           
                       </td>
                       <td class="pt-4"><span class="item-name">${n.productName}</span></td>
                       <td style="width: 95px;">
                           <input id="subsidiaries-${t.id}" />
                       </td>
                       <td class="text-right pt-4"><span class="price">${kendo.toString(n.price,"N2")}</span></td>
                       <td>
                           <input id="item-quantity-${t.id}" name="item-quantity-${t.id}" class="k-textbox item-quantity" type="number" value="1" min="1" style="width: 80px;" required>
                           <span class="k-invalid-msg" data-for="item-quantity-${t.id}"></span>
                       </td>
                       <td class="text-right pt-4"><span class="subtotal">${kendo.toString(n.price,"N2")}</span></td>
                       <td class="text-center pt-4"><a class="delete-item action action-link" title="Quitar Producto"><i class="fas fa-trash-alt"></i></a></td>
                   </tr>`,i.append(r),$(`#subsidiaries-${t.id}`).kendoDropDownList({change:onSubsidiaryChange,dataSource:{transport:{read:{url:urlGetSubsidiariesByProduct,data:{ProductId:n.id}}}},ignoreCase:!0,optionLabel:"Seleccione una Sucursal...",value:1,filter:"contains",dataTextField:"name",dataValueField:"id"}),u=parseFloat($("#tabshoppingcart").find(".total").text().replace(",","")),$("#tabshoppingcart").find(".total").text(kendo.toString(u+n.price,"N2"))):(console.error(t.message),showError(`Ha ocurrido un error al intentar agregar el item al carrito.<br />${t.message}`))})})}$(()=>setupControls());$(".send-cart").click(SendCart);$(".delete-cart").click(DeleteCart);$("body").on("change",".item-quantity",onQuantityChange);$("body").on("click",".delete-item",deleteItem);$("body").on("change","input",validateShoppingCart);$("body").on("click",".add-cart",addItem);$("body").on("click",".add-promo",addPromo);