function setupControls(){var t,i;userCode=$("#user-code").val();localUser=$("#local-user").val()==="Y";t=$("#FilSince").kendoDatePicker({format:"d/M/yyyy",change:function(){var n=this.value();n===null&&this.value("");i.min(n?n:_minDate)}}).data("kendoDatePicker");i=$("#FilUntil").kendoDatePicker({format:"d/M/yyyy",change:function(){var n=this.value();n===null&&this.value("");t.max(n?n:_maxDate)}}).data("kendoDatePicker");_maxDate=i.max();_minDate=t.min();filterData();var n=$("#FilState"),r=$("#FilBrand"),u=$("#FilLine");n.multipleSelect({placeholder:"Selecciona al menos un Estado..."});r.multipleSelect({placeholder:"Selecciona al menos una Marca..."});u.multipleSelect({placeholder:"Selecciona al menos una Línea..."});$.get(urlStatuses,{},function(t){var i=[];statuses=t;t.forEach(t=>{n.append(new Option(t.name,t.id)),t.id!==-1&&i.push(t.id)});n.multipleSelect("refresh");n.multipleSelect("setSelects",i)});$.get(urlBrands,{},function(n){n.forEach(n=>r.append(new Option(n.name,n.name)));r.multipleSelect("refresh")});$.get(urlLines,{},function(n){n.forEach(n=>u.append(new Option(n.name,n.name)));u.multipleSelect("refresh")});$.get(urlTechnicians,{},n=>technicians=n);$.get(urlClients,{},n=>clients=n);$.get(urlCities,{},n=>cities=n);$.get(urlCountries,{},n=>countries=n);$.get(urlLocations,{},n=>locations=n);$.get(urlCallTypes,{},n=>callTypes=n);$.get(urlOrigins,{},n=>origins=n);$.get(urlProblemTypes,{},n=>problemTypes=n);$.get(urlGetUsers,{},n=>users=n);$.get(urlGetSolutionStatuses,{},n=>solutionStatuses=n);priorities=[{id:0,name:"Baja"},{id:1,name:"Media"},{id:2,name:"Alta"}];localUser&&($("#FilClient").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",dataSource:{transport:{read:{url:urlClients}}},virtual:{itemHeight:26,valueMapper:clientMapper}}),$("#FilTechnician").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Técnico...",filter:"contains",dataSource:{transport:{read:{url:urlTechnicians}}}}),$("#FilProductManager").kendoDropDownList({dataTextField:"name",dataValueField:"name",optionLabel:"Seleccione un G. de Producto...",filter:"contains",dataSource:{transport:{read:{url:urlPManagers}}}}));$("#Listado").kendoGrid({columns:[{title:"Número",width:90,field:"code",attributes:alignRight,headerAttributes:alignRight},{title:"Estado",width:150,field:"status",aggregates:["count"],groupHeaderTemplate:"Estado: #= value #    ( Total: #= count# )"},{title:"Técnico",field:"technician",aggregates:["count"],groupHeaderTemplate:"Técnico: #= value #    ( Total: #= count# )",width:230},{title:"F. Ingreso",attributes:alignCenter,headerAttributes:alignCenter,width:100,field:"createDate",format:dateFormat},{title:"F. Cierre",attributes:alignCenter,headerAttributes:alignCenter,width:100,field:"closeDate",format:dateFormat},{title:"D. Abierto",width:90,field:"openDays",attributes:alignRight,headerAttributes:alignRight},{title:"Cliente",field:"clientName",width:220,attributes:{"class":"text-nowrap"},aggregates:["count"],groupHeaderTemplate:"Cliente: #= value #    ( Total: #= count# )"},{title:"Usuario Final",field:"finalUser",width:220,attributes:{"class":"text-nowrap"},aggregates:["count"],groupHeaderTemplate:"Usuario Final: # if(value) {# #= value # #} #    ( Total: #= count# )"},{title:"Ciudad",field:"city",width:120},{title:"Producto",width:180,field:"itemCode",aggregates:["count"],groupHeaderTemplate:"Producto: #= value #    ( Total: #= count# )"},{title:"Marca",width:120,field:"brand",aggregates:["count"],groupHeaderTemplate:"Marca: #= value #    ( Total: #= count# )"},{title:"F. Compra",attributes:alignCenter,headerAttributes:alignCenter,width:100,field:"purchaseDate",format:dateFormat},{title:"Garantía",width:90,field:"warranty",aggregates:["count"],groupHeaderTemplate:"Garantía: #= value #    ( Total: #= count# )"},{title:" ",attributes:alignCenter,width:50,sortable:!1,headerAttributes:alignCenter,sticky:!0,headerTemplate:'<i class="fas fa-plus action action-link action-new" title="Nuevo"><\/i>',template:function(n){var t='<i class="fas fa-pen action action-link action-edit" title="Editar"><\/i>';return n.portalId>0&&(t+='&nbsp;&nbsp;<i class="fas fa-trash-alt action action-link action-delete" title="Eliminar"><\/i>'),t}}],groupable:{messages:{empty:"Arrastre un encabezado de columna y colóquela aquí para agrupar por esa columna"},enabled:!0},sortable:!0,selectable:"Single, Row",noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataSource:getDataSource([]),excel:{fileName:"RMA.xlsx"},dataBound:function(n){for(var t=n.sender,i=0;i<t.columns.length;i++)t.showColumn(i);$("div.k-group-indicator").each(function(n,i){t.hideColumn($(i).data("field"))});t.element.find("table").attr("style","")}});$("#Report").kendoWindow({visible:!1,width:1100,title:"Producto",modal:!0});$("#detail").kendoWindow({visible:!1,scrollable:!0,modal:!0,width:1100,iframe:!1,close:onCloseWindow,activate:function(n){var t=this;setTimeout(()=>{onRefreshWindow(n),t.center()},300)}});$("#detailCamera").kendoWindow({visible:!1,width:346,title:"Sacar fotografía",modal:!0})}function clientMapper(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}function getDataSource(n){$.each(n,function(n,t){t.createDate=JSON.toDate(t.createDate);t.admissionDate!==null&&(t.admissionDate=JSON.toDate(t.admissionDate));t.closeDate!==null&&(t.closeDate=JSON.toDate(t.closeDate));t.purchaseDate=JSON.toDate(t.purchaseDate);t.clientPurchaseDate!==null&&(t.clientPurchaseDate=JSON.toDate(t.clientPurchaseDate));t.deliveredDate!==null&&(t.deliveredDate=JSON.toDate(t.deliveredDate))});return new kendo.data.DataSource({data:n,aggregate:[{aggregate:"count",field:"technicianName"},{aggregate:"count",field:"clientName"},{aggregate:"count",field:"finalUser"}],sort:[{field:"id",dir:"asc"}],schema:{model:{id:"code"}}})}function loadGrid(n){var t=$("#Listado").data("kendoGrid"),i=getDataSource(n);t.setDataSource(i);n&&n.length>0?($("#filter-box").collapse("hide"),$("#action-excel").removeClass("d-none")):$("#action-excel").addClass("d-none");setGridHeight("Listado",_gridMargin)}function getFilters(){var o=$("#FilId").val(),s=$("#FilTechnician").data("kendoDropDownList"),n=$(`#FilSince`).data("kendoDatePicker").value(),t=$(`#FilUntil`).data("kendoDatePicker").value(),f="",h=$("#FilState").multipleSelect("getSelects"),i=Enumerable.From(h).Select(function(n){return`'${n}'`}).ToArray().join(),r="",c=$("#FilBrand").multipleSelect("getSelects"),l=Enumerable.From(c).Select(n=>`'${n}'`).ToArray().join(),a=$("#FilLine").multipleSelect("getSelects"),v=Enumerable.From(a).Select(n=>`'${n}'`).ToArray().join(),e="",u=$.trim($("#FilSerial").val()),y=$.trim($("#FilProduct").val());return localUser?(f=s.value(),clientCode=$("#FilClient").data("kendoDropDownList").value(),e=$("#FilProductManager").data("kendoDropDownList").value()):clientCode=$("#FilClient").val(),n?n=n.toISOString():$.trim(i).indexOf("-1")>=0&&u===""&&(r+="- Fecha Inicial<br />"),t?t=t.toISOString():$.trim(i).indexOf("-1")>=0&&u===""&&(r+="- Fecha Final<br />"),{message:r,data:{Id:o,ClientCode:clientCode,InitialDate:n,FinalDate:t,Technician:f,StateCodes:i,Brands:l,Lines:v,ProductManager:e,Serial:u,Product:y}}}function filterData(){hideNotification();var n={message:""};pageLoad?(n=localUser?{data:{StateCodes:"0"},message:""}:{data:{StateCodes:"0",ClientCode:$("#FilClient").val()},message:""},pageLoad=!1):n=getFilters();n.message===""?$.get(urlFilter,n.data,function(n){n.message===""?loadGrid(n.items):(console.error(n.message),showError("Se ha producido un error al traer los datos del servidor."))}):showInfo(`Los siguientes campos son necesarios: <br /> ${n.message}`)}function cleanFilters(){hideNotification();$("#FilId").val("");$(`#FilSince`).data("kendoDatePicker").value("");$(`#FilUntil`).data("kendoDatePicker").value("");localUser&&($("#FilClient").data("kendoDropDownList").value(""),$("#FilTechnician").data("kendoDropDownList").value(""),$("#FilProductManager").data("kendoDropDownList").value(""));$("#FilState").multipleSelect("uncheckAll");$("#FilLine").multipleSelect("uncheckAll");$("#FilBrand").multipleSelect("uncheckAll");$("#FilProduct").val("");$("#FilSerial").val("");setEnableFilters(!0)}function setEnableFilters(n){var t=$("#FilSince").data("kendoDatePicker"),i=$("#FilUntil").data("kendoDatePicker"),r=$("#FilClient").data("kendoDropDownList"),u=$("#FilTechnician").data("kendoDropDownList"),f=$("#FilProductManager").data("kendoDropDownList");t.enable(n);i.enable(n);localUser&&(r.enable(n),u.enable(n),f.enable(n));n?($("#FilState").multipleSelect("enable"),$("#FilLine").multipleSelect("enable"),$("#FilBrand").multipleSelect("enable")):($("#FilState").multipleSelect("uncheckAll").multipleSelect("disable"),$("#FilLine").multipleSelect("uncheckAll").multipleSelect("disable"),$("#FilBrand").multipleSelect("uncheckAll").multipleSelect("disable"),localUser&&(r.value(""),u.value(""),f.value("")),t.value(""),i.value(""),$("#FilProduct").val(""),$("#FilSerial").val(""))}function loadReport(n,t,i){var f={Subsidiary:t,DocNumber:n,User:$.trim($(".user-info > .user-name").first().text())},r="SaleOrder.trdp",u;if(i==="Note"&&(r="SaleNote.trdp"),i==="Delivery"&&(r="DeliveryNote.trdp",f.SearchType=2),i==="Bill"&&(r="Bill.trdp"),u=$("#reportViewer1").data("telerik_ReportViewer"),u)try{u.reportSource({report:r,parameters:f});u.refreshReport()}catch(e){console.error(`Error al recargar el reporte: ${e}`);showInfo("El servidor está ocupado, espere un momento y vuelva a intentar.")}else try{$("#reportViewer1").telerik_ReportViewer({serviceUrl:urlService,reportSource:{report:r,parameters:f},viewMode:telerikReportViewer.ViewModes.INTERACTIVE,scaleMode:telerikReportViewer.ScaleModes.FIT_PAGE_WIDTH})}catch(e){console.error(`Error al cargar el reporte: ${e}`);showInfo("El servidor está ocupado, espere un momento y vuelva a intentar.")}}function getFileButton(n,t,i,r,u,f){return n?`<div class="btn-group btn-file" role="group">
                    <button type="button" class="btn btn-outline-secondary ${r!==""?"attach":""}" title="Descargar archivo" data-url="${r}" ${r!==""?"":"disabled"}>${i}</button>
                    <button type="button" class="btn btn-outline-danger delete-file" title="Eliminar archivo" data-id="${t}" data-name="${i}" data-existing="${u===0?"N":"Y"}" data-line="${u}" ${u===0||f?"":"disabled"}><i class="fas fa-times"></i></button>
                </div>`:`<a class="attach action action-link" data-url="${r}">${i}</a>`}function openDetail(n){var t,i,r;hideNotification();n?($(".custom-tab li:first-child a").tab("show"),i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),t=i.dataItem(r),i.select(r)):t={code:"0",openDays:0,finalUserPhone:"",finalUserEMail:"",country:"",callType:"",priority:1,originCode:"",problemTypeCode:"",city:"",cityCode:"",createDate:new Date,clientCode:"",clientName:"",itemCode:"",itemName:"",serialNumber:"",resolution:"",resolutionDate:"",room:"",startDate:"",state:"",statusCode:"-3",subject:"",technicianCode:"",admissionDate:"",finalUser:"",deliveryDate:"",deliveredBy:"",externalService:"",externalServiceAddress:"",externalServiceTechnician:"",externalServiceNumber:"",guideNumber:"",transport:"",stateCode:"",locationCode:"",countedPieces:0,priorCountedPieces:0,diffCountedPieces:0,purchaseDate:"",reportedBy:"",receivedBy:"",refNV:"",comments:"",warranty:"",city2:"",location:"",street:"",brand:"",countryCode:"BO",listServiceCallFiles:[]};t.fileName?typeof t.fileName=="string"&&(t.fileName=t.fileName.split("; ")):t.fileName=[];var f=kendo.template($("#template-service-call-edit").html()),e=f(t),u=$("<div>").addClass("my-window").kendoWindow({visible:!1,modal:!0,iframe:!1,title:"",resizable:!1,width:1100,actions:["Close"],close:onCloseWindow,open:onRefreshWindow}).data("kendoWindow");u.content(e);t.code==="0"&&$(`#save-button-${t.code}`).attr("disabled","disabled");$(`#create-date-${t.code}`).kendoDateTimePicker({format:"dd-MM-yyyy HH:mm",componentType:"modern",culture:"es-BO",value:t.createDate});$(`#close-date-${t.code}`).kendoDateTimePicker({format:"dd-MM-yyyy HH:mm",componentType:"modern",culture:"es-BO",value:t.closeDate});$(`#purchase-date-${t.code}`).kendoDatePicker({format:"dd-MM-yyyy",culture:"es-BO",value:t.purchaseDate});$(`#status-${t.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Estado...",dataSource:{data:statuses}});$(`#technician-${t.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Técnico...",dataSource:{data:technicians}});$(`#client-${t.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",dataSource:{data:clients},virtual:{itemHeight:26,valueMapper:clientMapper}});$(`#city-${t.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una Ciudad...",dataSource:{data:cities}});$(`#call-type-${t.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Tipo...",dataSource:{data:callTypes}});$(`#priority-${t.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una Prioridad...",dataSource:{data:priorities}});$(`#origin-${t.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Origen...",dataSource:{data:origins}});$(`#problem-type-${t.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Tipo de Problema...",dataSource:{data:problemTypes}});$(`#country-${t.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un País...",filter:"contains",dataSource:{data:countries}});$(`#state-${t.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Departamento...",cascadeFrom:`country-${t.code}`,enable:!1,dataSource:{serverFiltering:!0,transport:{read:{url:urlStates,data:n=>({Country:n.filter?n.filter.filters[0].value:"BO"})}}}});$(`#location-${t.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Locación...",filter:"contains",dataSource:{data:locations}});$(`#delivery-date-${t.code}`).kendoDateTimePicker({format:"dd-MM-yyyy HH:mm",componentType:"modern",culture:"es-BO",value:t.deliveredDate});$(`#counted-pieces-${t.code}`).kendoNumericTextBox({format:"n0",change:function(){var n=this.value(),t=$(`#prior-${this.element.attr("id")}`).getKendoNumericTextBox().value();$(`#diff-${this.element.attr("id")}`).getKendoNumericTextBox().value(n-t)}});$(`#prior-counted-pieces-${t.code}`).kendoNumericTextBox({format:"n0"});$(`#diff-counted-pieces-${t.code}`).kendoNumericTextBox({format:"n0",restrictDecimals:!0,decimals:0,min:0});$.get(urlDetail,{Id:t.code},function(n){if(n.message===""){var i=+t.statusCode!=-1;n.activities.forEach(n=>n.activityDate=JSON.toDate(n.activityDate));t.listServiceCallActivitys=n.activities;$("#activitiesList_"+t.code).kendoGrid({columns:[{title:"Cod.",field:"code",width:60,attributes:alignRight,headerAttributes:alignRight},{title:"Actividad",field:"activityType",width:130},{title:"Fecha",field:"activityDate",format:"{0:dd-MM-yyyy}",width:80,attributes:alignCenter,headerAttributes:alignCenter},{title:"Hora",field:"activityDate",format:"{0:HH:mm}",width:65,attributes:alignCenter,headerAttributes:alignCenter},{title:"Tratado por",field:"treatedBy",width:180},{title:"Cerrado",field:"closed",width:80,attributes:alignCenter,headerAttributes:alignCenter,template:'# if(closed === "Y") {# <i class="fas fa-check"><\/i> #} #'},{title:"Contenido",field:"notes",attributes:{"class":"text-truncate"}},{title:" ",attributes:alignCenter,headerAttributes:alignCenter,width:45,headerTemplate:()=>i?'<i class="fas fa-plus action action-link action-new-activity" title="Nuevo"><\/i>':"",template:function(n){var t="";return perActivities>0&&(perActivities>1&&(t=`<i class="fas fa-pen action action-link action-edit-activity" title="Editar" data-editable="${i?"Y":"N"}"></i>`),perActivities>3&&n.id!==0&&i&&(t+='&nbsp;&nbsp;<i class="fas fa-trash action action-link action-delete-activity" title="Eliminar"><\/i>')),t}}],sortable:!0,selectable:"Single, Row",scrollable:{height:200},noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataSource:{data:n.activities,filter:[{field:"statusType",operator:"neq",value:"3"}]}});n.repairs.forEach(n=>{n.createDate=JSON.toDate(n.createDate),n.updateDate=JSON.toDate(n.updateDate)});t.listServiceCallSolutions=n.repairs;$("#repairList_"+t.code).kendoGrid({columns:[{title:"Cod.",field:"code",width:60,attributes:alignRight,headerAttributes:alignRight},{title:"Solución",field:"subject"},{title:"F. Creación",field:"createDate",format:"{0:dd-MM-yyyy}",width:100,attributes:alignCenter,headerAttributes:alignCenter},{title:"Propietario",field:"owner",width:180},{title:"F. Actualización",field:"updateDate",format:"{0:dd-MM-yyyy}",width:130,attributes:alignCenter,headerAttributes:alignCenter},{title:"Estado",field:"status",width:100},{title:" ",field:"attachment",width:30,attributes:alignCenter,headerAttributes:alignCenter,template:'# if(attachment) {# <a class="attach action action-link" title="Archivos adjuntos"><i class="fas fa-paperclip"><\/i><\/a> #} #'},{title:" ",attributes:alignCenter,headerAttributes:alignCenter,width:45,headerTemplate:()=>i?'<i class="fas fa-plus action action-link action-new-repair" title="Nuevo"><\/i>':"",template:function(n){var t="";return perActivities>0&&(perActivities>1&&(t=`<i class="fas fa-pen action action-link action-edit-repair" title="Editar" data-editable="${i?"Y":"N"}"></i>`),perActivities>3&&n.id!==0&&i&&(t+='&nbsp;&nbsp;<i class="fas fa-trash action action-link action-delete-repair" title="Eliminar"><\/i>')),t}}],sortable:!0,selectable:"Single, Row",scrollable:{height:200},noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataSource:n.repairs});$("#historyList_"+t.code).kendoGrid({scrollable:!1,sortable:!0,pageable:!1,selectable:!0,columns:[{field:"order",title:"Número",width:100,attributes:alignRight,headerAttributes:alignRight},{field:"updateDate",title:"Fecha",format:"{0:dd-MM-yyyy HH:mm}",width:150,attributes:alignCenter,headerAttributes:alignCenter},{field:"status",title:"Estado",width:200},{field:"subject",title:"Descripción"}],dataSource:n.history,noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'}});n.costs.forEach(n=>n.postingDate=JSON.toDate(n.postingDate));$("#costsList_"+t.code).kendoGrid({scrollable:!0,sortable:!0,pageable:!1,selectable:!0,columns:[{field:"docTypeDesc",title:"Clase doc.",width:100},{field:"docNumber",title:"No. doc.",width:100,attributes:alignCenter,headerAttributes:alignCenter,template:n=>(n.docType===15||n.docType===17)&&n.canceled==="N"?`<a class="action action-link related-doc">${n.docNumber}</a>`:n.docNumber},{field:"postingDate",title:"Fecha",format:"{0:dd-MM-yyyy}",width:90,attributes:alignCenter,headerAttributes:alignCenter},{field:"itemCode",title:"No. artículo",width:180},{field:"itemName",title:"Desc. artículo",width:300},{field:"transfered",title:"Transferido",attributes:alignCenter,headerAttributes:alignCenter,template:n=>n.transfered==="Y"?'<i class="fas fa-check"><\/i>':"",width:100},{field:"transToTec",title:"Transf. al Técnico",width:140,attributes:alignRight,headerAttributes:alignRight},{field:"delivered",title:"Entregado",width:90,attributes:alignRight,headerAttributes:alignRight},{field:"retFromTec",title:"Dev. del Tec.",width:100,attributes:alignRight,headerAttributes:alignRight},{field:"returned",title:"Devuelto",width:100,attributes:alignRight,headerAttributes:alignRight},{field:"bill",title:"Facturado",template:n=>n.bill==="Y"?'<i class="fas fa-check"><\/i>':"",width:100,attributes:alignCenter,headerAttributes:alignCenter},{field:"qtyToBill",title:"Cat. a Facturar",width:100,attributes:alignRight,headerAttributes:alignRight},{field:"qtyToInv",title:"Cat. a Inv.",width:90,attributes:alignRight,headerAttributes:alignRight},{field:"canceled",title:"Anulado",width:100,attributes:alignCenter,headerAttributes:alignCenter,template:n=>n.canceled==="Y"?'<i class="fas fa-check"><\/i>':""}],dataSource:n.costs,noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataBound:function(n){for(var r,u,i=n.sender.dataSource.view(),t=0;t<i.length;t++)r=i[t].get("canceled"),u=n.sender.tbody.find("[data-uid='"+i[t].uid+"']"),r==="Y"&&u.addClass("canceled")}});$(`#data-${t.code}`).val(JSON.stringify(t))}else console.error(n.message),showError("Se ha producido un error al traer los datos del servidor.")});u.center().open()}function exportExcel(){hideNotification();$("#Listado").data("kendoGrid").saveAsExcel()}function getOtherServiceCallsFromSerial(n){hideNotification();var t=n.currentTarget.dataset,i=t.code,r=$(`#serial-number-${i}`).val();$.trim(r)!==""&&$.get(urlOtherRMAs,{Id:i,Serial:r},n=>{if(n.message===""){n.items.forEach(n=>{n.createDate=JSON.toDate(n.createDate),n.closeDate=JSON.toDate(n.closeDate)});var i=$("<div>").kendoWindow({visible:!1,modal:!1,iframe:!1,title:"Listado de Casos de RMA para un serial",resizable:!1,width:1200,actions:["Close"],close:onCloseWindow}).data("kendoWindow");i.content(`<div id="rma-cases-${t.id}"></div>`);$(`#rma-cases-${t.id}`).kendoGrid({columns:[{title:"Número",width:90,field:"code",attributes:alignRight,headerAttributes:alignRight,template:'<a class="see-detail action action-link" title="Ver Detalle">#=code#<\/a>'},{title:"Técnico",field:"technician",width:230},{title:"F. Ingreso",attributes:alignCenter,headerAttributes:alignCenter,width:100,field:"createDate",format:dateFormat},{title:"F. Cierre",attributes:alignCenter,headerAttributes:alignCenter,width:100,field:"closeDate",format:dateFormat},{title:"D. Abierto",width:90,field:"openDays",format:"{0:N0}",attributes:alignRight,headerAttributes:alignRight},{title:"Cliente",field:"clientName",width:220,attributes:{"class":"text-nowrap"}},{title:"Piezas Contadas",field:"countedPieces",format:"{0:N0}",width:140,attributes:alignRight,headerAttributes:alignRight},{title:"Estado",width:150,field:"status"}],sortable:!0,selectable:"Single, Row",noRecords:{template:"No se encontraron registros de otros RMAs para este producto."},dataSource:n.items});i.center().open()}else console.error(n),showError("Se ha producido un error al traer los datos del servidor")})}function openActivity(n,t,i){var r,ct,o,h,ht,yt,pt,wt;hideNotification();ct=$(n.currentTarget).closest(".detail-rma").find(".id").text();o=$(n.currentTarget).closest(".k-grid").data("kendoGrid");t?(o.clearSelection(),r={id:0,code:getTempId(),notes:"",details:"",activityType:"",assignedBy:"",assignedByCode:1,treatedBy:"",contact:"",telephone:"",cardCode:$(n.currentTarget).closest(".detail-rma").find(".card-code").val(),activityDate:new Date}):(h=$(n.currentTarget).closest("tr"),o.select(h),r=o.dataItem(h));i?(r.notes=r.notes!==null?r.notes.replaceAll("<br />","\r"):"",r.details=r.details!==null?r.details.replaceAll("<br />","\r"):""):(r.notes=r.notes!==null?r.notes.replaceAll("\r","<br />"):"",r.details=r.details!==null?r.details.replaceAll("\r","<br />"):"");var s="",e="",f=i?"":"bg-data",c,l,a,v,y,p,w,b,k,d,g="Actividad",nt="Fecha",tt="Asignado por",it="Tratado por",rt="Persona de contacto",ut="No. de Teléfono",ft="Asunto",et="Cerrado",ot="Detalle",st="Notas",u=i?"label-edit":"",lt="";if(r.attachment)if(ht=r.attachment.indexOf("/")>=0?"/":"\\",r.attachment.indexOf(";")>=0){var bt=r.attachment.split(";"),at=[],vt=1;bt.forEach(n=>{s=Enumerable.From(n.split(ht)).LastOrDefault(),at.push(getFileButton(i,r.code,s,n,vt,!1)),vt+=1});e=at.join(i?"&nbsp;&nbsp;&nbsp;":"<br />")}else s=Enumerable.From(r.attachment.split(ht)).LastOrDefault(),e=getFileButton(i,r.code,s,r.attachment,1,!1);i?(e=`<div id="files-content-${r.code}" class="files-content mb-2">${e}</div>
                      <button type="button" class="btn btn-secondary photo-gallery" title="Escoger un archivo" data-id="${r.code}">
                        <i class="fa fa-image"></i> Escoger un Archivo
                      </button>
                      <input id="gallery-${r.code}" type="file" class="d-none gallery" data-id="${r.code}"><input type="hidden" id="data-files-${r.code}" value="" />`,c=`<input id="activity-type-${r.code}" class="form-control w-100" value="${r.activityTypeCode}" required>`,l=`<input id="activity-date-${r.code}" type="datetime" required disabled="disabled">`,a=`<input id="assigned-by-${r.code}" class="w-100" value="${r.assignedByCode}" required>`,v=`<input id="treated-by-${r.code}" class="w-100" value="${r.treatedByCode}" required>`,y=`<input id="activity-contact-${r.code}" class="w-100" value="${r.contactCode}">`,p=`<input id="telephone-${r.code}" class="form-control" value="${$.trim(r.telephone)}">`,w=`<input id="subject-${r.code}" class="w-100" value="${r.subjectCode}" required>`,b=`<input id="closed-${r.code}" class="closed" type="checkbox">`,k=`<input id="details-${r.code}" class="form-control" type="text" value="${$.trim(r.details)}">`,d=`<textarea id="notes-${r.code}" class="form-control" rows="15">${$.trim(r.notes)}</textarea>`,lt=`<div class="row"><div class="col text-right"><button type="button" class="btn btn-primary save-activity" data-id="${r.code}" data-rmaId="${ct}">Guardar Actividad</button></div></div>`,g=`<label for="activity-type-${r.code}">${g}</label>`,nt=`<label for="activity-date-${r.code}">${nt}</label>`,tt=`<label for="assigned-by-${r.code}">${tt}</label>`,it=`<label for="treated-by-${r.code}">${it}</label>`,rt=`<label for="activity-contact-${r.code}">${rt}</label>`,ut=`<label for="telephone-${r.code}">${ut}</label>`,ft=`<label for="subject-${r.code}">${ft}</label>`,et=`<label for="closed-${r.code}">${et}</label>`,ot=`<label for="details-${r.code}">${ot}</label>`,st=`<label for="notes-${r.code}">${st}</label>`):(c=r.activityType,l=kendo.toString(r.activityDate,"dd-MM-yyyy HH:mm"),a=r.assignedBy,v=r.treatedBy,y=r.contact,p=r.telephone,w=r.subject||"",b=r.closed==="Y"?"Si":"No",k=r.details,d=r.notes);yt=`<form id="form-activity-${r.code}">
                      <input type="hidden" id="card-code-${r.code}" value="${r.cardCode}"><input type="hidden" id="attachment-code-${r.code}" value="${r.attachmentCode}">
                      <div class="content-data">
                         <div class="row">
                           <div class="col-2 font-weight-bold ${u}">N&uacute;mero</div><div class="col-4 ${f} font-weight-bold ${u}">${r.code}</div>
                           <div class="col-2 font-weight-bold ${u}">${g}</div><div class="col-4 ${f}">${c}</div>
                         </div>
                         <div class="row">
                           <div class="col-2 font-weight-bold ${u}">${nt}</div><div class="col-10 ${f}">${l}</div>
                         </div>
                         <div class="row">
                           <div class="col-2 font-weight-bold ${u}">${tt}</div><div class="col-4 ${f}">${a}</div>
                           <div class="col-2 font-weight-bold ${u}">${it}</div><div class="col-4 ${f}">${v}</div>
                         </div>
                         <div class="row">
                           <div class="col-2 font-weight-bold ${u}">${rt}</div><div class="col-4 ${f}">${y}</div>
                           <div class="col-2 font-weight-bold ${u}">${ut}</div><div class="col-4 ${f}">${p}</div>
                         </div>
                         <div class="row">
                           <div class="col-2 font-weight-bold ${u}">${ft}</div><div class="col-4 ${f}">${w}</div>
                           <div class="col-2 font-weight-bold ${u}">${et}</div><div class="col-4 ${f}">${b}</div>
                         </div>
                         <div class="row">
                           <div class="col-2 font-weight-bold ${u}">${ot}</div><div class="col-10 ${f}">${k}</div>
                         </div>
                         <div class="row">
                           <div class="col-2 font-weight-bold ${u}">${st}</div><div class="col-10 ${f}">${d}</div>
                         </div>
                         <div class="row">
                           <div class="col-2 font-weight-bold ${u}">Adjunto</div><div class="col-10 ${f}">${e}</div>
                         </div>${lt}
                      </div>
                   </form>`;pt=$("#detail").data("kendoWindow");pt.content(yt).open();i&&(wt=[{id:"C",name:"Llamada teléfonica"},{id:"E",name:"Nota"},{id:"M",name:"Reunión"},{id:"N",name:"Otra"},{id:"P",name:"Campaña"},{id:"T",name:"Tarea"}],$(`#activity-date-${r.code}`).kendoDateTimePicker({format:"dd-MM-yyyy HH:mm",componentType:"modern",culture:"es-BO",value:r.activityDate}),$(`#closed-${r.code}`).kendoSwitch({checked:r.closed==="Y",messages:{checked:"",unchecked:""}}),$(`#activity-type-${r.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",dataSource:wt,optionLabel:"Seleccione un Tipo ..."}),$(`#subject-${r.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",dataSource:{transport:{read:{url:urlGetSubjects}}},optionLabel:"Seleccione un Titulo ..."}),$(`#assigned-by-${r.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Técnico...",filter:"contains",dataSource:{data:users},enable:!1}),$(`#treated-by-${r.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Técnico...",filter:"contains",dataSource:{data:users}}),$(`#activity-contact-${r.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Contacto...",filter:"contains",dataSource:{transport:{read:{url:urlGetContacts,data:{CardCode:r.cardCode}}}}}))}function saveActivity(n){var vt=$(n.currentTarget).closest("form"),f,t,o,s,h,c,l,a,v,y,e,p,w,b,k,d,g,nt,tt="",it,st=[],rt,ut,ft,et,ot,ht,ct,i,r,yt=vt.kendoValidator().data("kendoValidator"),u,lt,at;yt.validate()&&(t=n.currentTarget.dataset.id,f=n.currentTarget.dataset.rmaid,r=JSON.parse($(`#data-${f}`).val()),r.listServiceCallActivitys.forEach(n=>n.activityDate=JSON.toDate(n.activityDate)),i=r.listServiceCallActivitys.find(n=>n.code===t),rt=$(`#activity-type-${t}`).data("kendoDropDownList"),ut=$(`#assigned-by-${t}`).data("kendoDropDownList"),ft=$(`#treated-by-${t}`).data("kendoDropDownList"),et=$(`#activity-contact-${t}`).data("kendoDropDownList"),ot=$(`#subject-${t}`).getKendoDropDownList(),ht=$(`#activity-date-${t}`).data("kendoDateTimePicker"),ct=$(`#closed-${t}`).data("kendoSwitch"),s=rt.value(),o=rt.text(),c=ut.text(),l=ut.value(),v=ft.value(),a=ft.text(),e=et.value(),y=e===""?"":et.text(),h=ht.value(),k=ct.check()?"Y":"N",p=$(`#telephone-${t}`).val(),w=ot.text(),b=ot.value(),d=$(`#details-${t}`).val(),g=$(`#notes-${t}`).val(),nt=$(`#card-code-${t}`).val(),it=$(`#data-files-${t}`).val(),it!==""&&(st=JSON.parse(it),u=i===null||$.trim(i.attachment)===""?[]:i.attachment.split(";"),st.forEach(n=>{if(n.action==="D"&&n.existing==="Y"){var t=u.find(t=>t.indexOf(n.name)>=0);t&&u.remove(t)}n.action==="I"&&n.existing==="N"&&u.push(urlFiles+n.name)}),tt=u.join(";")),i?($.extend(i,{activityType:o,activityTypeCode:s,activityDate:h,attachment:tt,assignedBy:c,assignedByCode:l,treatedBy:a,treatedByCode:v,contactCode:e,contact:y,telephone:p,subject:w,subjectCode:b,closed:k,details:d,notes:g,cardCode:nt}),i.statusType=i.id===0?1:2):(i={code:t,activityType:o,activityTypeCode:s,activityDate:h,attachment:tt,assignedBy:c,assignedByCode:l,treatedBy:a,treatedByCode:v,contactCode:e,contact:y,telephone:p,subject:w,subjectCode:b,closed:k,details:d,notes:g,cardCode:nt,statusType:1},r.listServiceCallActivitys.push(i)),lt=$(`#activitiesList_${f}`).getKendoGrid(),at=new kendo.data.DataSource({data:r.listServiceCallActivitys,filter:[{field:"statusType",operator:"neq",value:3}]}),lt.setDataSource(at),$(`#data-${f}`).val(JSON.stringify(r)),$("#detail").data("kendoWindow").close())}function onDeleteActivity(n){var f;hideNotification();var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),t=i.dataItem(r),u=$(n.currentTarget).closest(".detail-rma").find(".id").text();i.select(r);f=t.code.indexOf("TEMP")>=0?`¿Está seguro que desea eliminar la actividad No. <b>TEMP-${t.id}</b>?`:`Sólo eliminará la modificación que no ha subido al SAP ¿Está seguro?`;showConfirm(f,function(){var n=JSON.parse($(`#data-${u}`).val()),r=n.listServiceCallActivitys.find(n=>n.id===t.id),e,o,f;+r.id>0?(e=$.extend({},r,{id:0,statusType:0}),n.listServiceCallActivitys.push(e),r.statusType=3):+r.code<0?(o=n.listServiceCallActivitys.findIndex(n=>n.id===t.id),n.listServiceCallActivitys.splice(o,1)):(r.id=0,r.statusType=0);n.listServiceCallActivitys.forEach(n=>n.activityDate=JSON.toDate(n.activityDate));f=f=new kendo.data.DataSource({data:n.listServiceCallActivitys,filter:[{field:"statusType",operator:"neq",value:3}]});i.setDataSource(f);$(`#data-${u}`).val(JSON.stringify(n));showNotification("",`Se eliminó la actividad No. <b>${t.code}</b>.`,"success")})}function openRepair(n,t){var f,i,s,e,a,h,u,r,c,o,l;if(hideNotification(),f=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),s=$(n.currentTarget).closest(".detail-rma").find(".id").text(),t?(f.clearSelection(),i={id:0,code:getTempId(),itemCode:$(`#item-code-${s}`).val(),status:"",statusCode:-3,updateDate:new Date,description:"",attachment:"",updatedBy:"",updatedByCode:1,subject:"",symptom:"",cause:""},e="Y"):(a=n.currentTarget.dataset,h=$(n.currentTarget).closest("tr"),f.select(h),i=f.dataItem(h),e=a.editable),i.description=i.description.replaceAll("\r","<br />"),u="",r="",i.attachment)if(c=i.attachment.indexOf("/")>=0?"/":"\\",i.attachment.indexOf(";")>=0){var p=i.attachment.split(";"),v=[],y=1;p.forEach(n=>{u=Enumerable.From(n.split(c)).LastOrDefault(),v.push(getFileButton(edit,i.code,u,n,y,!1)),y+=1});r=v.join(edit?"&nbsp;&nbsp;&nbsp;":"<br />")}else u=Enumerable.From(i.attachment.split(c)).LastOrDefault(),r=getFileButton(edit,i.code,u,i.attachment,1,!1);o="";e==="Y"?(r=`<div id="files-content-${i.code}" class="files-content mb-2">${r}</div>
                      <button type="button" class="btn btn-secondary photo-gallery" title="Escoger un archivo" data-id="${i.code}">
                        <i class="fa fa-image"></i> Escoger un Archivo
                      </button>
                      <input id="gallery-${i.code}" type="file" class="d-none gallery" data-id="${i.code}"><input type="hidden" id="data-files-${i.code}" value="" />`,o=`<form>
                      <div class="content-data">
                         <div class="row"><div class="col-2 font-weight-bold">N&uacute;mero</div><div class="col-4 font-weight-bold">${i.code}</div></div>
                         <div class="row">
                           <div class="col-2 font-weight-bold"><label for="sol-itemcode-${i.code}">Art&iacute;culo</label></div><div class="col-4"><input id="sol-itemcode-${i.code}" class="form-control" value="${i.itemCode}" disabled></div>
                           <div class="col-2 font-weight-bold"><label for="sol-status-${i.code}">Estado</label></div><div class="col-4"><input id="sol-status-${i.code}" class="w-100" value="${i.statusCode}" required></div>
                         </div>
                         <div class="row">
                           <div class="col-2 font-weight-bold"><label for="sol-update-date-${i.code}">Actualizado el</label></div><div class="col-4"><input id="sol-update-date-${i.code}" disabled></div>
                           <div class="col-2 font-weight-bold"><label for="sol-updated-by-${i.code}">Actualizado por</label></div><div class="col-4"><input id="sol-updated-by-${i.code}" class="w-100" value="${i.updatedByCode}"></div>
                         </div>
                         <div class="row"><div class="col-2 font-weight-bold"><label for="sol-subject-${i.code}">Soluci&oacute;n</label></div><div class="col-10"><input id="sol-subject-${i.code}" type="text" class="form-control" value="${$.trim(i.subject)}"></div></div>
                         <div class="row"><div class="col-2 font-weight-bold"><label for="sol-symptom-${i.code}">S&iacute;ntoma</label></div><div class="col-10"><input id="sol-symptom-${i.code}" type="text" class="form-control" value="${$.trim(i.symptom)}" required></div></div>
                         <div class="row"><div class="col-2 font-weight-bold"><label for="sol-cause-${i.code}">Causa</label></div><div class="col-10"><input id="sol-cause-${i.code}" type="text" class="form-control" value="${$.trim(i.cause)}"></div></div>
                         <div class="row"><div class="col-2 font-weight-bold"><label for="sol-description-${i.code}">Descripci&oacute;n</label></div><div class="col-10"><input id="sol-description-${i.code}" type="text" class="form-control" value="${$.trim(i.description)}"></div></div>
                         <div class="row"><div class="col-2 font-weight-bold">Adjunto</div><div class="col-10">${r}</div></div>
                         <div class="row">
                            <div class="col text-right mt-2"><button class="btn btn-primary save-repair" data-code="${i.code}" data-rmaId="${s}">Guardar Reparación</button></div>
                         </div>
                      </div>
                   </form> `):o=`<div class="content-data">
                      <div class="row"><div class="col-2 font-weight-bold">N&uacute;mero</div><div class="col-4 bg-data font-weight-bold">${i.code}</div></div>
                      <div class="row">
                        <div class="col-2 font-weight-bold">Art&iacute;culo</div><div class="col-4 bg-data">${i.itemCode}</div>
                        <div class="col-2 font-weight-bold">Estado</div><div class="col-4 bg-data">${i.status}</div>
                      </div>
                      <div class="row">
                        <div class="col-2 font-weight-bold">Actualizado el</div><div class="col-4 bg-data">${kendo.toString(i.updateDate,"dd-MM-yyyy")}</div>
                        <div class="col-2 font-weight-bold">Actualizado por</div><div class="col-4 bg-data">${i.updatedBy}</div>
                      </div>
                      <div class="row"><div class="col-2 font-weight-bold">Soluci&oacute;n</div><div class="col-10 bg-data">${$.trim(i.subject)}</div></div>
                      <div class="row"><div class="col-2 font-weight-bold">S&iacute;ntoma</div><div class="col-10 bg-data">${$.trim(i.symptom)}</div></div>
                      <div class="row"><div class="col-2 font-weight-bold">Causa</div><div class="col-10 bg-data">${$.trim(i.cause)}</div></div>
                      <div class="row"><div class="col-2 font-weight-bold">Comentarios</div><div class="col-10 bg-data">${$.trim(i.description)}</div></div>
                      <div class="row"><div class="col-2 font-weight-bold">Adjunto</div><div class="col-10 bg-data">${r}</div></div>
                   </div> `;l=$("#detail").data("kendoWindow");l.content(o);e==="Y"&&($(`#sol-update-date-${i.code}`).kendoDatePicker({format:"dd-MM-yyyy",culture:"es-BO",value:i.updateDate}),$(`#sol-updated-by-${i.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Técnico...",filter:"contains",dataSource:{data:users},enable:!1}),$(`#sol-status-${i.code}`).kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Status...",filter:"contains",dataSource:{data:solutionStatuses}}));l.open()}function saveRepair(n){var c,l,o,u,s,h,p,w;if(n.preventDefault(),c=$(n.currentTarget).closest("form"),l=c.kendoValidator().data("kendoValidator"),l.validate()){var a=n.currentTarget.dataset,i=a.code,f=a.rmaid,r=JSON.parse($(`#data-${f}`).val()),t,v=null,e,y=[];r.listServiceCallSolutions&&r.listServiceCallSolutions.length>0&&r.listServiceCallSolutions.forEach(n=>{n.createDate&&(n.createDate=JSON.toDate(n.createDate)),n.updateDate&&(n.updateDate=JSON.toDate(n.updateDate))});t=r.listServiceCallSolutions.find(n=>n.code===i);o=new Date;t?t.statusType!==1&&(t.statusType=2,t.id===0&&(t.id=getTempId())):(t={id:i,code:i,statusType:1,itemCode:$(`#sol-itemcode-${i}`).val(),createDate:o,owner:"manager",ownerCode:1,attachment:""},r.listServiceCallSolutions.push(t));e=$(`#data-files-${i}`).val();e!==""&&(y=JSON.parse(e),u=t===null||$.trim(t.attachment)===""?[]:t.attachment.split(";"),y.forEach(n=>{if(n.action==="D"&&n.existing==="Y"){var t=u.find(t=>t.indexOf(n.name)>=0);t&&u.remove(t)}n.action==="I"&&n.existing==="N"&&u.push(urlFiles+n.name)}),v=u.join(";"));s=$(`#sol-status-${i}`).getKendoDropDownList();h=$(`#sol-updated-by-${i}`).getKendoDropDownList();t.updateDate=o;t.status=s.text();t.statusCode=s.value();t.updatedBy=h.text();t.updatedByCode=h.value();t.subject=$(`#sol-subject-${i}`).val();t.symptom=$(`#sol-symptom-${i}`).val();t.cause=$(`#sol-cause-${i}`).val();t.description=$(`#sol-description-${i}`).val();t.attachment=v;p=$(`#repairList_${f}`).getKendoGrid();w=new kendo.data.DataSource({data:r.listServiceCallSolutions,filter:[{field:"statusType",operator:"neq",value:3}]});p.setDataSource(w);$(`#data-${f}`).val(JSON.stringify(r));$("#detail").data("kendoWindow").close()}}function onDeleteRepair(n){var f;hideNotification();var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),t=i.dataItem(r),u=$(n.currentTarget).closest(".detail-rma").find(".id").text();i.select(r);f=t.code.indexOf("TEMP")>=0?`¿Está seguro que desea eliminar la reparación No. <b>TEMP-${t.id}</b>?`:`Sólo eliminará la modificación que no ha subido al SAP ¿Está seguro?`;showConfirm(f,function(){var n=JSON.parse($(`#data-${u}`).val()),r=n.listServiceCallSolutions.find(n=>n.id===t.id),e,o,f;+r.id>0?(e=$.extend({},r,{id:0,statusType:0}),n.listServiceCallSolutions.push(e),r.statusType=3):+r.code<0?(o=n.listServiceCallSolutions.findIndex(n=>n.id===t.id),n.listServiceCallSolutions.splice(o,1)):(r.id=0,r.statusType=0);n.listServiceCallSolutions.forEach(n=>{n.createDate=JSON.toDate(n.createDate),n.updateDate&&(n.updateDate=JSON.toDate(n.updateDate))});f=f=new kendo.data.DataSource({data:n.listServiceCallSolutions,filter:[{field:"statusType",operator:"neq",value:3}]});i.setDataSource(f);$(`#data-${u}`).val(JSON.stringify(n));showNotification("",`Se eliminó la reparación No. <b>${t.id}</b>.`,"success")})}function openRelatedDoc(n){var i,r,t,u;hideNotification();i=$(n.currentTarget).closest(".k-grid").data("kendoGrid");r=$(n.currentTarget).closest("tr");i.select(r);t=i.dataItem(r);u=$("#Report").data("kendoWindow");u.title(t.docTypeDesc);loadReport(t.docNumber,"Santa Cruz",t.docType===15?"Delivery":"");u.open().center()}function getProductCardData(n,t,i){var r,u,f;t&&(i?(f=n.currentTarget.dataset,r=f.code,u=$(`#serial-number-${r}`).val()):(u=$(n.currentTarget).val(),r=n.currentTarget.dataset.code),$.trim(u)!==""&&$.get(urlGetProductCard,{SerialNumber:u},function(n){if(n.message===""){var t;n.exists?(t=n.item,t.purchaseDate=JSON.toDate(t.purchaseDate)):showError("Este producto no tiene tarjeta de producto creada.");loadInputsProductCard(r,t)}else console.error(n),showError("Se ha producido un error al traer los datos del servidor")}))}function loadInputsProductCard(n,t){t?$(`#save-button-${n}`).removeAttr("disabled"):$(`#save-button-${n}`).attr("disabled","disabled");$(`#item-code-${n}`).val(t?.itemCode??"");$(`#item-name-${n}`).val(t?.itemName??"");$(`#brand-${n}`).val(t?.brand??"");$(`#ref-nv-${n}`).val(t?`NV-${t.refNV}`:"");$(`#purchase-date-${n}`).data("kendoDatePicker").value(t?.purchaseDate??"");$(`#warranty-${n}`).val(t?t.warranty==="Y"?"SI":"NO":"");$(`#client-${n}`).data("kendoDropDownList").value(t?.clientCode??"");$(`#final-user-${n}`).val(t?.clientName??"");$(`#prior-counted-pieces-${n}`).getKendoNumericTextBox().value(t?.lastCountedPieces??0);$(`#city-${n}`).getKendoDropDownList().value(t?.cityCode??"");$(`#reported-by-${n}`).val(t?.reportedBy??"");$(`#final-user-phone-${n}`).val(t?.phone??"");$(`#final-user-email-${n}`).val(t?.eMail??"");$(`#external-service-${n}`).val(t?.externalService??"");$(`#external-service-technician-${n}`).val(t?.externalServiceTechnician??"");$(`#external-service-address-${n}`).val(t?.address??"")}function getTempId(){return tempId-=1}function deleteServiceCall(n){var u;hideNotification();var i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),t=i.dataItem(r);i.select(r);u=t.sapCode!=null?`Sólo eliminará la modificación que no ha subido al SAP ¿Está seguro?`:`¿Está seguro que desea eliminar el RMA No. <b>${t.code}</b>?`;showConfirm(u,function(){$.post(urlDeleteServiceCall,{Code:t.portalId},function(n){var r,u;n.message===""?(r=i.dataSource,t.code.indexOf("TEMP")>=0?r.remove(t):(u=r.get(t.code),u.portalId=0),i.setDataSource(r),showNotification("",`Se eliminó la llamada de servicio No. <b>${t.code}</b>.`,"success")):(console.error(n.message),showNotification("",`Se produjo el siguiente error al intentar eliminar la llamada de servicio`,"error"))})})}function saveServiceCall(n){var l,a,f,e,o,s,h,c,r,v,y,p,w,i,t,u,b;n.preventDefault();l=$(n.currentTarget).closest("form");a=l.kendoValidator().data("kendoValidator");a.validate()&&(i=n.currentTarget.dataset.code,t=JSON.parse($(`#data-${i}`).val()),f=$(`#country-${i}`).data("kendoDropDownList"),e=$(`#state-${i}`).data("kendoDropDownList"),o=$(`#city-${i}`).data("kendoDropDownList"),s=$(`#location-${i}`).data("kendoDropDownList"),h=$(`#client-${i}`).data("kendoDropDownList"),c=$(`#status-${i}`).data("kendoDropDownList"),r=$(`#technician-${i}`).data("kendoDropDownList"),v=$(`#priority-${i}`).getKendoDropDownList(),y=$(`#call-type-${i}`).getKendoDropDownList(),w=$(`#problem-type-${i}`).getKendoDropDownList(),p=$(`#origin-${i}`).getKendoDropDownList(),t.problemTypeCode=w.value(),t.originCode=p.value(),t.priority=v.value(),t.callType=y.value(),t.city=o.text(),t.cityCode=o.value(),t.countryCode=f.value(),t.country=t.countryCode===""?"":f.text(),t.stateCode=e.value(),t.state=t.stateCode===""?"":e.text(),t.locationCode=s.value(),t.location=t.locationCode===""?"":s.text(),t.creationDate=$(`#create-date-${i}`).data("kendoDateTimePicker").value(),t.creationDate&&(t.creationDate=t.creationDate.toISOString(),t.startDate=t.creationDate),t.clientCode=h.value(),t.clientName=h.text(),t.itemCode=$(`#item-code-${i}`).val(),t.itemName=$(`#item-name-${i}`).val(),t.serialNumber=$(`#serial-number-${i}`).val(),t.brand=$(`#brand-${i}`).val(),t.resolution=$(`#resolution-${i}`).val(),t.state=$(`#state-${i}`).val(),t.street=$(`#street-${i}`).val(),t.room=$(`#room-${i}`).val(),t.city2=$(`#city2-${i}`).val(),t.statusCode=c.value(),t.status=t.statusCode===""?"":c.text(),t.subject=$(`#subject-${i}`).val(),t.technicianCode=r.value(),t.technician=r.text(),t.assignee=r.text(),t.assigneeCode=r.value(),t.finalUser=$(`#final-user-${i}`).val(),t.finalUserPhone=$(`#final-user-phone-${i}`).val(),t.finalUserEMail=$(`#final-user-email-${i}`).val(),t.deliveryDate=$(`#delivery-date-${i}`).data("kendoDateTimePicker").value(),t.deliveryDate&&(t.deliveryDate=t.deliveryDate.toISOString()),t.deliveredBy=$(`#delivered-by-${i}`).val(),t.externalService=$(`#external-service-${i}`).val(),t.externalServiceAddress=$(`#external-service-address-${i}`).val(),t.externalServiceNumber=$(`#external-service-number-${i}`).val(),t.externalServiceTechnician=$(`#external-service-technician-${i}`).val(),t.guideNumber=$(`#guide-number-${i}`).val(),t.transport=$(`#transport-${i}`).val(),t.countedPieces=$(`#counted-pieces-${i}`).data("kendoNumericTextBox").value(),t.priorCountedPieces=$(`#prior-counted-pieces-${i}`).data("kendoNumericTextBox").value(),t.diffCountedPieces=$(`#diff-counted-pieces-${i}`).data("kendoNumericTextBox").value(),t.purchaseDate=$(`#purchase-date-${i}`).data("kendoDatePicker").value(),t.purchaseDate&&(t.purchaseDate=t.purchaseDate.toISOString()),t.reportedBy=$(`#reported-by-${i}`).val(),t.receivedBy=$(`#received-by-${i}`).val(),t.refNV=$(`#ref-nv-${i}`).val(),t.comments=$(`#comments-${i}`).val(),t.warranty=$(`#warranty-${i}`).val(),u=$(`#data-files-${i}`).val(),u!==""&&(b=JSON.parse(u),t.listServiceCallFiles||(t.listServiceCallFiles=[]),b.forEach(n=>{if(n.action==="D"&&n.existing==="Y"){var i=t.listServiceCallFiles.find(t=>t.fileName===n.name);i&&(i.statusType=3)}n.action==="I"&&n.existing==="N"&&t.listServiceCallFiles.push({fileName:n.name,statusType:1})})),$.post(urlSaveServiceCall,{Item:t,Filters:u.data},function(t){t.message===""?(filterData(),$(n.currentTarget).closest(".my-window").data("kendoWindow").close()):(console.error(t.message),showError("Se ha producido un error al guardar la Llamada de Servicio."))}))}function openCamera(n){var t=n.currentTarget.dataset.id;Webcam.set({width:320,height:240,dest_width:320,dest_height:240,crop_width:320,crop_height:240});Webcam.attach("#my_camera");$("#take-photo-ok").attr("data-id",t);$("#detailCamera").data("kendoWindow").open()}function openGallery(n){var t=n.currentTarget.dataset.id;$(`#gallery-${t}`).val(null);$(`#gallery-${t}`).click()}function onGalleryFileSelected(n){var i,r,t;n.preventDefault();i=n.currentTarget.dataset.id;n.currentTarget.files&&n.currentTarget.files[0]&&(r=n.currentTarget.files[0].name,t=new FileReader,t.addEventListener("load",function(n){saveImage(n.target.result,r,i)}),t.readAsDataURL(n.currentTarget.files[0]))}function onTakePhoto(n){n.preventDefault();var t=n.currentTarget.dataset.id;Webcam.snap(function(n){var i=`Photo-${userCode}-${kendo.toString(new Date,"yyyyMMdd-HHmmss")}.jpg`;saveImage(n,i,t);Webcam.reset();$("#detailCamera").data("kendoWindow").close()})}function onCancelTekePhoto(n){n.preventDefault();Webcam.reset();$("#detailCamera").data("kendoWindow").close()}function deleteFile(n){var t=n.currentTarget.dataset,r=$(`#data-files-${t.id}`).val(),i=r===""?[]:JSON.parse(r),u=$(n.currentTarget).closest(".btn-file");showConfirm(`¿ Está seguro que desea eliminar el archivo ${t.name} ?`,()=>{var n=Enumerable.From(i).Where(n=>n.name===t.name).FirstOrDefault();n?n.action="D":i.push({name:t.name,action:"D",existing:t.existing,line:t.line});$(`#data-files-${t.id}`).val(JSON.stringify(i));u.remove()})}function saveImage(n,t,i){$.post(urlSaveFile,{FileBase64:n,FileName:t},function(n){if(n.message===""){var r=$(`#data-files-${i}`).val(),u=r===""?[]:JSON.parse(r);u.push({name:t,action:"I",existing:"N",line:0});$(`#data-files-${i}`).val(JSON.stringify(u));$(`#files-content-${i}`).append(`&nbsp;&nbsp;&nbsp;${getFileButton(!0,i,t,"",0,!0)}`)}else console.log(n.message),showNotification("","Se produjo un error al guardar el archivo.","error")})}function openFile(n){var t,i,r,u;hideNotification();t=$(n.currentTarget).attr("data-url");t||(i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),i.select(r),u=i.dataItem(r),t=u.attachment);t=t.replaceAll(";","");window.location.href=urlDownloadFile+"?"+$.param({FilePath:t})}var _minDate,_maxDate,pageLoad=!0,localUser,userCode,statuses,technicians,clients,countries,cities,locations,callTypes,priorities,problemTypes,origins,users,solutionStatuses,tempId=0;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},gridMargin=30,numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}",_gridMargin=30,perActivities=$("#permission").val();$(document).ajaxError((n,t,i,r)=>catchError(n,t,i,r));$(()=>setupControls());$(window).resize(()=>setGridHeight("Listado",_gridMargin));$("#filter-box").on("hidden.bs.collapse",()=>setGridHeight("Listado",_gridMargin));$("#filter-box").on("shown.bs.collapse",()=>setGridHeight("Listado",_gridMargin));$("#FilId").keyup(n=>setEnableFilters($(n.currentTarget).val()===""));$("#action-filter").click(()=>filterData());$("#action-clean").click(()=>cleanFilters());$("#action-excel").click(()=>exportExcel());$("#Listado").on("click",".action-new",()=>openDetail());$("#Listado").on("click",".action-edit",n=>openDetail(n));$("#Listado").on("click",".action-delete",n=>deleteServiceCall(n));$("body").on("click",".see-detail",n=>openDetail(n));$("body").on("click",".attach",n=>openFile(n));$("body").on("click",".action-new-activity",n=>openActivity(n,!0,!0));$("body").on("click",".action-edit-activity",n=>openActivity(n,!1,!0));$("body").on("click",".action-delete-activity",n=>onDeleteActivity(n));$("body").on("click",".action-new-repair",n=>openRepair(n,!0));$("body").on("click",".action-edit-repair",n=>openRepair(n,!1));$("body").on("click",".action-delete-repair",n=>onDeleteRepair(n));$("body").on("click",".save-repair",n=>saveRepair(n));$("body").on("click",".product-card",n=>getProductCardData(n,!0,!0));$("body").on("keypress",".product-card-search input",n=>getProductCardData(n,n.keyCode===13,!1));$("body").on("input",".product-card-search input",n=>loadInputsProductCard(n.currentTarget.dataset.code,null));$("body").on("click",".other-serial-number",n=>getOtherServiceCallsFromSerial(n));$("body").on("shown.bs.tab",'a[data-toggle="tab"]',n=>$(n.currentTarget).closest(".my-window").data("kendoWindow").center());$("body").on("click",".related-doc",n=>openRelatedDoc(n));$("body").on("click",".save-activity",n=>saveActivity(n));$("body").on("click",".photo-camera",n=>openCamera(n));$("body").on("click",".photo-gallery",n=>openGallery(n));$("body").on("change",".gallery",n=>onGalleryFileSelected(n));$("body").on("click",".delete-file",n=>deleteFile(n));$("#take-photo-ok").click(n=>onTakePhoto(n));$("#take-photo-cancel").click(n=>onCancelTekePhoto(n));$("body").on("click",".save-call-service",n=>saveServiceCall(n));