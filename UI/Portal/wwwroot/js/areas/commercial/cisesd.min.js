function setupControls(){var n,t,i,r,u,f,e,o;exitProductsPermission=$("#ProductExitPermission").val()==="Y";$("#detail").kendoWindow({title:"Compra de Licencia a Microsoft",visible:!1,scrollable:!0,modal:!0,width:850,iframe:!1,activate:onRefreshWindow});n=$("#fil-since").kendoDatePicker({format:"d/M/yyyy",change:function(){var n=this.value();n===null&&this.value("");t.min(n?n:_minDate)}}).data("kendoDatePicker");t=$("#fil-until").kendoDatePicker({format:"d/M/yyyy",change:function(){var t=this.value();t===null&&this.value("");n.max(t?t:_maxDate)}}).data("kendoDatePicker");_maxDate=t.max();_minDate=n.min();i=new Date;t.value(i);n.value(i.addDays(-7));r=$("#fil-client").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",dataSource:{data:clients},virtual:{itemHeight:26,valueMapper:clientMapper}}).data("kendoDropDownList");u=$("#client").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",dataSource:{data:clients},virtual:{itemHeight:45,valueMapper:clientMapper},template:'<span class="k-state-default">#: data.name.replace(data.code + " - ", "") #<p>#: data.code #<\/p><\/span>',change:function(){switch(this.value()){case"":$(".col-type, .col-gen-order").addClass("d-none");break;case"CDMC-002":$(".col-gen-order").removeClass("d-none");exitProductsPermission?($(".col-type").removeClass("d-none"),o.value("Orden de Venta")):$(".col-type").addClass("d-none");break;default:$(".col-gen-order").removeClass("d-none");$(".col-type").addClass("d-none");$.get(urlValidateClient,{CardCode:this.value()},function(n){n.message===""?(_enabledClient=n.enabled&&!n.onHoldDue&&!n.onHoldCredit,$("#generate-order").prop("checked",_enabledClient),$("#generate-order").prop("disabled",!_enabledClient),$("#purchase-license").prop("disabled",!_enabledClient),$("#orderNumber").parent().toggleClass("d-none",_enabledClient),$("label[for=orderNumber]").toggleClass("d-none",_enabledClient),_enabledClient||showInfo(`Debe crear primero la OV y hacerla aprobar debido a lo siguiente: <br />${n.enabled?"":"- El cliente no está habilitado para compras Microsoft ESD<br />"}${n.onHoldCredit?"- El cliente está On Hold por crédito<br />":""}${n.onHoldDue?"- El cliente está On Hold por pagos atrasados":""}`)):$("#purchase-license").prop("disabled",!0)})}}}).data("kendoDropDownList");$("#fil-type").kendoDropDownList();f=$("#fil-product").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Producto...",filter:"contains",dataSource:{data:products}}).data("kendoDropDownList");e=$("#product").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Producto...",filter:"contains",dataSource:{data:products},template:'<span class="k-state-default">#: data.name.replace("( " + data.id + " ) ", "") #<p>#: data.id # &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Precio: #:kendo.toString(data.price, "N2")# $US<\/p><\/span>'}).data("kendoDropDownList");$("#Listado").kendoGrid({columns:[{title:"Número",width:100,field:"code",attributes:alignCenter,headerAttributes:alignCenter},{title:"Cliente",field:"cardName",width:220,attributes:{"class":"text-nowrap"},aggregates:["count"],groupHeaderTemplate:"Cliente: #= value #    ( Total: #= count# )"},{title:"Producto",width:200,field:"productName",aggregates:["count"],groupHeaderTemplate:"Producto: #= value #    ( Total: #= count# )"},{title:"Fecha",field:"purchaseDate",attributes:alignCenter,headerAttributes:alignCenter,width:90,format:dateFormat},{title:"Precio",field:"price",width:80,attributes:alignRight,headerAttributes:alignRight},{title:"Cantidad",field:"quantity",width:80,attributes:alignRight,headerAttributes:alignRight},{title:"# Doc.",width:120,field:"docNumber",headerAttributes:alignCenter,attributes:alignCenter,template:n=>n.docNumber!==null&&n.docType==="SO"?`<a class="doc-number action action-link">${n.docNumber}</a>`:$.trim(n.docNumber)},{title:"Tipo Doc.",width:120,field:"docType",template:n=>n.docType==="SO"?"Orden de Venta":"Baja de Producto",aggregates:["count"],groupHeaderTemplate:'Tipo Doc: #= value === "SO" ? "Orden de Venta" : "Baja de Producto" # ( Total: #= count# )'},{title:"Enviado",width:90,field:"sent",headerAttributes:alignCenter,attributes:alignCenter,template:n=>n.sent?'<i class="fas fa-check"><\/i>':""},{title:"Anulado",width:90,field:"anulled",headerAttributes:alignCenter,attributes:alignCenter,template:n=>n.anulled>0?n.anulled===n.quantity?'<i title="Anulación Total" class="fas fa-check-double"><\/i>':'<i title="Anulación Parcial" class="fas fa-check"><\/i>':""},{title:" ",width:70,sortable:!1,attributes:alignCenter,headerAttributes:alignCenter,sticky:!0,headerTemplate:'<a class="action action-link action-new" title="Nuevo"><i class="fas fa-plus"><\/i><\/a>',template:function(){return'<a class="action action-link action-mail" title="Enviar por Correo"><i class="fas fa-envelope"><\/i><\/a><a class="action action-link action-edit" title="Editar"><i class="fas fa-pen"><\/i><\/a>'}}],groupable:{messages:{empty:"Arrastre un encabezado de columna y colóquela aquí para agrupar por esa columna"},enabled:!0},sortable:!0,selectable:"Single, Row",noRecords:{template:'<div class="p-3 w-100 text-center">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataSource:getDataSource([]),dataBound:function(n){var t=n.sender;t.columns.forEach((n,i)=>t.showColumn(i));$("div.k-group-indicator").each((n,i)=>t.hideColumn($(i).data("field")));t.element.find("table").attr("style","")},detailInit:function(n){$.get(urlDetail,{Id:n.data.id},function(t){t.message===""?(t.items.forEach(n=>n.returnDate=JSON.toDate(n.returnDate)),$("<div>").appendTo(n.detailCell).kendoGrid({scrollable:!1,sortable:!0,pageable:!1,selectable:!0,columns:[{title:"Número",field:"number",width:250},{title:"Secuencia",field:"sequence",width:90},{title:"Tipo",field:"type",width:80},{title:"Código",field:"code",width:250},{title:"Fecha Devolución",field:"returnDate",width:80,format:dateFormat,attributes:alignCenter,headerAttributes:alignCenter}],dataSource:t.items,noRecords:{template:"No se encontraron registros para el criterio de búsqueda."}})):showError("Se ha producido un error al traer los datos de la compra.")})}});o=$("#docType").kendoRadioGroup({items:["Orden de Venta","Baja de Mercadería"],layout:"horizontal",value:"Orden de Venta",change:n=>$(".col-gen-order").toggleClass("d-none",n.newValue==="Baja de Mercadería")}).data("kendoRadioGroup");$("#Report").kendoWindow({visible:!1,width:1100,title:"",modal:!0,activate:function(){var n=this;setTimeout(()=>n.center(),300)}});$.get(urlProducts,{},n=>{products=n,f.setDataSource(n),e.setDataSource(n)});$.get(urlClients,{},n=>{clients=n,r.setDataSource(n),u.setDataSource(n)})}function clientMapper(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}function getDataSource(n){n.forEach(n=>n.purchaseDate=JSON.toDate(n.purchaseDate));return new kendo.data.DataSource({data:n,sort:[{field:"id",dir:"asc"}],schema:{model:{id:"id"}}})}function loadGrid(n){var t=$("#Listado").data("kendoGrid"),i=getDataSource(n);t.setDataSource(i);n&&n.length>0?($("#filter-box").collapse("hide"),$("#action-excel").removeClass("d-none")):$("#action-excel").addClass("d-none");setGridHeight("Listado",_gridMargin)}function getFilters(){var i="",r=$("#fil-code").val(),u=$("#fil-client").val(),f=$("#fil-type").val(),e=$("#fil-product").val(),n=$(`#fil-since`).data("kendoDatePicker").value(),t=$(`#fil-until`).data("kendoDatePicker").value();return n?n=kendo.toString(n,"yyyy-MM-dd"):i+="- Fecha Inicial<br />",t?t=kendo.toString(t,"yyyy-MM-dd"):i+="- Fecha Final<br />",{message:i,data:{Code:r,ClientCode:u,Type:f,ProductId:e,InitialDate:n,FinalDate:t}}}function filterData(){hideNotification();var n=getFilters();n.message===""?$.get(urlFilter,n.data,function(n){n.message===""?loadGrid(n.items):(console.error(n.message),showError("Se ha producido un error al traer los datos del servidor."))}):showInfo(`Los siguientes campos son necesarios: <br /> ${n.message}`)}function cleanFilters(){$("#fil-code").val("");$("#fil-client").data("kendoDropDownList").value("");$("#fil-type").data("kendoDropDownList").value("B");$("#fil-product").data("kendoDropDownList").value("");hideNotification();var n=new Date;$("#fil-since").data("kendoDatePicker").value(n.addDays(-7));$("#fil-until").data("kendoDatePicker").value(n)}function getTokenContent(n,t){var i="",e,o,r;if(t&&(i+=`<div class="custom-tab">
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item"><a class="nav-link active show" data-toggle="tab" href="#tab-general-${n.id}" role="tab" aria-selected="true">Datos Compra</a></li>
        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-emails-${n.id}" role="tab">Correos enviados</a></li>
    </ul>
    <div class="tab-content">
    	<div id="tab-general-${n.id}" class="tab-pane active show pt-3" role="tabpanel">`),i+=`<div class="row"><div class="col"><b>C&oacute;digo:</b> ${n.code}</div><div class="col"><b>Fecha:</b> ${kendo.toString(n.purchaseDate,"dd-MM-yyyy")}</div></div>
            <div class="row"><div class="col"><b>Cliente:</b> ( ${n.cardCode} ) ${n.cardName}</div></div>
            <div class="row"><div class="col"><b>Producto:</b> ${n.productName}</div></div>
            <div class="row"><div class="col"><b>OV SAP:</b>${$.trim(n.orderNumber)}</div></div>`,n.tokens&&n.tokens.length>0||n.links&&n.links.length>0){for(i+=`<a class="" data-toggle="collapse" href="#licences-detail-${n.id}" role="button" aria-expanded="false" aria-controls="licences-detail-${n.id}">Mostrar/ocultar detalle</a>`,e=n.tokens&&n.tokens.length>0?n.tokens.length:0,o=n.links&&n.links.length>0?n.links.length:0,i+=`<div id="licences-detail-${n.id}" class="collapse show">`,r=0;r<e;r++){var f=n.tokens[r],u=o>0?n.links[r]:null,s=r%2==1?"bg-even":"";i+=`<div class="row"><div class="col"><div class="py-2 px-3 ${s}"><b>C&oacute;digo:</b> ${f.code}<br /><b>Descripci&oacute;n:</b> ${f.description}<br />`;u&&(i+=`<a href="${u.uri}" class="action action-link">V&iacute;nculo <i class="fas fa-paperclip"></i></a>&nbsp;&nbsp;&nbsp;${u.description}&nbsp;&nbsp;&nbsp;<b>Expira:</b> ${u.expirationDate?kendo.toString(u.expirationDate,"dd-MM-yyyy"):""}<br />`);i+=`<b>No. Transacci&oacute;n:</b> ${f.transactionNumber}</div></div></div>`}i+=`</div>`}return t&&(i+=`</div><div id="tab-emails-${n.id}" class="tab-pane pt-3" role="tabpanel">`,n.sentEmails&&n.sentEmails.length>0?(i+=`<div class="row"><div class="col-12"><b>Correos Enviados</b></div><div class="col-12"><table class="table"><thead class="thead-light"><tr><th scope="col">Fecha</th><th scope="col">Nombre</th><th scope="col">E-Mail</th><th scope="col">Tipo</th></tr></thead><tbody>`,n.sentEmails.forEach(n=>{i+=`<tr><td scope="row">${kendo.toString(JSON.toDate(n.logDate),"dd-MM-yyyy HH:mm")}</td><td>${n.name}</td><td>${n.eMail}</td><td>${n.type==="E"?"Alta":"Baja"}</td></tr>`}),i+=` </tbody></table></div></div>`):i+=`<div class="row"><div class="col text-center pt-4 pb-4">No se han enviado correos todav&iacute;a.</div></div>`,i+=`</div></div></div>`),i}function onEdit(n){var u=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),f=$(n.currentTarget).closest("tr"),t=u.dataItem(f),i,r;u.select(f);r=$("<div>");$.get(urlGetPurchase,{Id:t.id},n=>{n.message===""?(t.tokens=n.tokens,t.links=n.links,t.anulled=n.anulled,t.sentEmails=n.sentEmails,i=getTokenContent(t,!0)):(console.error(n.message),i=`<div class="row"><div class="col">Se ha producido un error al traer los datos de la Orden</div></div>`),r.append(i),$(r).kendoWindow({actions:["Close"],width:900,title:`Orden Microsoft ${t.code}`,visible:!0,activate:onRefreshWindow,close:onCloseDestroy}),setTimeout(()=>$(`#licences-detail-${t.id}`).collapse(),1)})}function onNew(){$("#product").data("kendoDropDownList").value("");$("#client").data("kendoDropDownList").value("");$("#purchase-license").removeAttr("disabled");$("#purchase-license").removeClass("d-none");$("#group-send").addClass("d-none");$("#quantity").val(1);$(".col-type, .col-gen-order").addClass("d-none");$("#purchase-content").empty();$("#detail").data("kendoWindow").open()}function onPurchase(n){n.preventDefault();var s=$(this).closest("form"),h=s.kendoValidator().data("kendoValidator"),t=[],r=3,u="";if(h.validate()){$("#purchase-license").attr("disabled","disabled");var i=function(n){$.get(urlGetProductToken,{ItemCode:c,ClientCode:a,PurchaseCode:u,OrderNumber:l,DocType:p},function(f){var o,s,h;f.message===""?(f.item.cardName=v,f.item.productName=e,f.item.purchaseDate=JSON.toDate(f.item.purchaseDate),console.log(f.item),t.push(f.item),u=f.item.code,n>1?i(n-1):(o=[],s=[],t.forEach(function(n){n.tokens.forEach(n=>o.push(n));n.links.forEach(n=>s.push(n))}),f.item.tokens=o,f.item.links=s,$("#Listado").data("kendoGrid").dataSource.add(f.item),$("#purchase-license").addClass("d-none"),$("#send-data").attr("data-id",f.item.id),$("#group-send").removeClass("d-none"),$("#purchase-content").append(`Se han obtenido <b>${t.length}</b> licencias exitosamente. ¿Desea enviarlas por correo?`),$("#purchase-content").append(getTokenContent(f.item,!1)),$("#recipient-email").val(f.item.eMail),$("#recipient-name").val(f.item.cardName),adjustWindow($("#detail").data("kendoWindow")),setTimeout(()=>$(`#licences-detail-${f.item.id}`).collapse("hide"),100))):(console.error(f.message),r>0?(r-=1,i(n)):(h=t.length>0?`Sólo se pudo generar ${t.length} licencias.`:`No se pudo generar ninguna licencia`,showError(`Se ha producido un error generar las Licencias, ${h} `),$("#purchase-license").removeAttr("disabled")))})},f=$("#product").data("kendoDropDownList"),c=f.value(),e=f.text(),l=+$("#orderNumber").val(),o=$("#client").data("kendoDropDownList"),a=o.value(),v=o.text(),y=+$("#quantity").val(),p=$("#docType").data("kendoRadioGroup").value()==="Orden de Venta"?"SO":"PE";showConfirm(`¿Est&aacute; seguro que desea realizar la compra de la(s) licencia(s) de <b>${e}</b>?`,()=>i(y))}}function onSendingData(n){var r,e,i,t,u,f,s,o,h;n.preventDefault();r=$(n.currentTarget).closest(".k-grid").data("kendoGrid");r?(e=$(n.currentTarget).closest("tr"),i=r.dataItem(e),t=i.id,r.select(e),s=`<form id="send-mail-${t}">
        <div id="group-send-${t}" class="input-group mb-3">
            <input type="email" id="recipient-email-${t}" class="form-control" placeholder="Correo del Destinatario" aria-label="Correo del Destinatario" aria-describedby="send-data" value="${i.eMail}" required>
            <input type="text" id="recipient-name-${t}" class="form-control" placeholder="Nombre del Destinatario" aria-label="Nombre del Destinatario" aria-describedby="send-data" value="${i.cardName}" required>
            <div class="input-group-append">
                <button class="btn btn-primary" type="button" id="send-data-${t}"><i class="fa fa-envelope"></i>&nbsp;Enviar por correo</button>
            </div>
        </div>
    </form>`,o=$("<div>").attr("id",`send-mail-window-${t}`),o.append(s),$(o).kendoWindow({actions:["Close"],width:900,title:`Enviar Orden Microsoft ${i.code} por correo`,visible:!0,modal:!0,activate:function(){this.center()},close:onCloseDestroy}),$(`#send-data-${t}`).click(function(n){n.preventDefault();var i=$(`#send-mail-${t}`).kendoValidator({messages:{required:""}}).data("kendoValidator");i.validate()&&(u=$(`#recipient-email-${t}`).val(),f=$(`#recipient-name-${t}`).val(),sendingData(t,u,f,!1))})):(t=n.currentTarget.dataset.id,h=$(n.currentTarget).closest("form").kendoValidator({messages:{required:""}}).data("kendoValidator"),h.validate()&&(u=$("#recipient-email").val(),f=$("#recipient-name").val(),sendingData(t,u,f,!0)))}function sendingData(n,t,i,r){$.get(urlSendMail,{Id:n,EMail:t,Name:i},t=>{var u,i,f;t.message===""?(u=r?`#detail`:`#send-mail-window-${n}`,$(u).data("kendoWindow").close(),showMessage("Se ha enviado el correo exitosamente."),i=$("#Listado").data("kendoGrid"),f=i.dataSource.get(n),f.sent=!0,i.refresh()):(console.error(t.message),showError("Se ha producido un error al enviar el correo."))})}function onDelete(n){var t=$("#Listado").data("kendoGrid").dataItem($(n.currentTarget).closest("tr")),i=`<div class="row"><div class="col">¿Est&aacute; seguro que desea devolver la Licencia de <b>${t.productName}</b> con c&oacute;digo <b>${t.code}</b>?</div></div>
<div class="row"><div class="col pt-2"><label mb-1>Seleccione un c&oacute;digo:</label>`;$.get(urlGetTokens,{Id:t.id},function(n){n.message===""?(n.items&&n.items.length>0&&(i+=n.items.map(n=>`<div class="form-check mt-1"><input class="k-radio" id="token-${n.id}" name="token" type="radio" value="${n.code}"><label class="k-radio-label" for="token-${n.id}">${n.code}</label></div>`)),i+=`</div></div>`,showConfirm(i,function(){var u=$("[name='token']:checked"),n,r;if(u.length>0)n=u.val(),r=t.id,$.get(urlReturnLicence,{LicenceCode:n,PurchaseId:r},t=>{if(t.message===""){var f=$("#Listado").data("kendoGrid"),u=f.dataSource.get(r);return u.anulled=!0,u.sent=!0,f.refresh(),i=`<div class="row">
                                          <div class="col-12">Se ha realizado la devolución de la licencia <b>${n}</b> de <b>${u.productName}</b> correctamente.</div>
                                          <div class="col-12">C&oacute;digo de Transacci&oacute;n: <b>${t.item.serviceTransactionId}</b></div>
                                          <div class="col-12">C&oacute;digo de Transacci&oacute;n Cliente: <b>${t.item.clientTransactionId}</b></div>
                                       </div>`,showMessage(i),!0}return console.error(t.message),showError("Se ha producido un error al anular la Orden de Microsoft."),!1});else return!1})):showError(`Se ha producido un error al traer los Tokens del producto <b>${t.productName}</b>.`)})}function adjustWindow(n){var t=$(window),i=80,r=n.wrapper.height(),u=n.wrapper.width();t.height()<=r+i||t.width()<=u+i?t.width()>=992?(t.height()<=r+i&&(r=t.height()-i),t.width()<=u+i&&(u=t.width()-i),n.element.css({maxHeight:r,maxWidth:u}),setTimeout(()=>{n.center()},100)):n.maximize():n.center()}function onMustGenerateChange(){$("#orderNumber").parent().toggleClass("d-none",this.checked);$("label[for=orderNumber]").toggleClass("d-none",this.checked);$("#purchase-license").prop("disabled",!this.checked);this.checked&&$("#orderNumber").val("")}function onVerifyOrder(n){var t=+$("#orderNumber").val(),i=+$("#quantity").val(),r=$("#product").data("kendoDropDownList").value(),u=$("#client").data("kendoDropDownList").value(),f=$(n.currentTarget).closest("form"),e=f.kendoValidator({rules:{req:n=>$.trim(n.val())!==""&&$.trim(n.val())!=="0"},messages:{req:""}}).data("kendoValidator");e.validate()&&$.get(urlValidateOrder,{CardCode:u,ItemCode:r,Quantity:i,OrderNumber:t},function(n){$("#purchase-license").prop("disabled",!n.valid);n.message!==""&&showError(n.message)})}function exportExcel(){var n=getFilters();n.message===""?window.location.href=urlExcel+"?"+$.param(n.data):showInfo(`Los siguientes campos son necesarios <br />${n.message}`)}function openReport(n){var t=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),i=$(n.currentTarget).closest("tr"),r,u;t.select(i);r=t.dataItem(i);u=$("#Report").data("kendoWindow");loadReport(r.docNumber);u.open()}function loadReport(n){var i={Subsidiary:"Santa Cruz",DocNumber:n,User:$.trim($(".user-info > .user-name").first().text())},r="SaleOrder.trdp",t=$("#reportViewer1").data("telerik_ReportViewer");if(t)try{t.reportSource({report:r,parameters:i});t.refreshReport()}catch(u){showInfo("El servidor está ocupado, espere un momento y vuelva a intentar.")}else $("#reportViewer1").telerik_ReportViewer({serviceUrl:urlService,reportSource:{report:r,parameters:i},viewMode:telerikReportViewer.ViewModes.INTERACTIVE,scaleMode:telerikReportViewer.ScaleModes.SPECIFIC,scale:1})}var _minDate,_maxDate,clients,products,exitProductsPermission,_enabledClient;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},gridMargin=30,numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}",_gridMargin=30,perActivities=$("#permission").val();$(()=>setupControls());$(window).resize(()=>setGridHeight("Listado",_gridMargin));$("#filter-box").on("hidden.bs.collapse",()=>setGridHeight("Listado",_gridMargin));$("#filter-box").on("shown.bs.collapse",()=>setGridHeight("Listado",_gridMargin));$("#action-filter").click(filterData);$("#action-clean").click(cleanFilters);$("#Listado").on("click",".action-new",onNew);$("#Listado").on("click",".action-edit",onEdit);$("#Listado").on("click",".action-mail",onSendingData);$("#Listado").on("click",".action-delete",onDelete);$("#Listado").on("click",".doc-number",openReport);$("#purchase-license").click(onPurchase);$("#send-data").click(onSendingData);$("#generate-order").on("change",onMustGenerateChange);$("#verify-order").click(onVerifyOrder);$("#action-excel").click(exportExcel);