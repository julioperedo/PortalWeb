function onSinceChange(n){var t=this.value();t===null&&this.value("");$(n.sender.element).closest(".row").find("input.final-date").data("kendoDatePicker").min(t?t:_minDate)}function onUntilChange(n){var t=this.value();t===null&&this.value("");$(n.sender.element).closest(".row").find("input.initial-date").data("kendoDatePicker").max(t?t:_maxDate)}function setupControls(){$("#category").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una Categoría...",filter:"contains",dataSource:{transport:{read:{url:urlCategories}}}});$("#subcategory").kendoDropDownList({dataSource:{serverFiltering:!0,transport:{read:{url:urlSubcategories,data:getSubcategoriesFilter}}},cascadeFrom:"category",enable:!1,optionLabel:"Seleccione una Subcategoría...",filter:"contains",dataTextField:"name",dataValueField:"id"});$("#line").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione una Línea...",filter:"contains",dataSource:{transport:{read:{url:urlLines}}}});$.get(urlSubsidiaries,{},function(n){var t=$("#subsidiary"),i=$("#warehouse");i.multipleSelect();$.each(n.items,function(n,i){t.append(new Option(i.name,i.name))});t.multipleSelect({onUncheckAll:()=>i.empty().multipleSelect("refresh").multipleSelect("disable"),onCheckAll:()=>loadWarehouses(t,i),onClick:()=>loadWarehouses(t,i)}).multipleSelect("checkAll")});$.get(urlProviders,{},function(n){var t=$("#provider");n.forEach(n=>{t.append(new Option(n.name,n.code))});t.multipleSelect({filter:!0})});$("#Listado").kendoGrid({sortable:!0,pageable:!0,selectable:!0,groupable:{messages:{empty:"Arrastre un encabezado de columna y colóquela aquí para agrupar por esa columna"}},noRecords:{template:"No se encontraron registros para el criterio de búsqueda."},detailInit:function(n){$.get(urlDetail,{Subsidiary:n.data.subsidiary,OrderNumber:n.data.docNumber},function(t){$("<div>").appendTo(n.detailCell).kendoGrid({dataSource:{data:t.items},scrollable:!1,sortable:!0,pageable:!1,selectable:!0,columns:[{field:"itemCode",title:"Cod.Producto",width:110,template:'<a href="\\#" class="item-code action action-link">#: itemCode #<\/a>'},{field:"itemName",title:"Producto",width:250},{field:"quantity",title:"Cantidad",attributes:alignRight,headerAttributes:alignRight,width:80},{field:"openQuantity",title:"Cant. Abierta",attributes:alignRight,headerAttributes:alignRight,width:90},{field:"price",title:"P. Unirario",format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight,width:110},{field:"subtotal",title:"Subtotal",format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight,width:110}]});t.message!==""&&showError(t.message)})},columns:[{field:"subsidiary",aggregates:["count"],title:"Sucursal",groupHeaderTemplate:"Sucursal: #= value #    ( Total: #= count#,  Monto Total: #= kendo.toString(aggregates.total.sum, 'N2') # )",width:150},{field:"warehouse",aggregates:["count"],title:"Almacén",groupHeaderTemplate:"Almacén: #= value #    ( Total: #= count#,  Monto Total: #= kendo.toString(aggregates.total.sum, 'N2') # )",width:150},{field:"providerName",aggregates:["count"],title:"Proveedor",groupHeaderTemplate:"Proveedor: #= value #    ( Total: #= count#,  Monto Total: #= kendo.toString(aggregates.total.sum, 'N2') # )",width:250},{field:"docNumber",title:"# Orden",width:80,template:'<a class="order action action-link">#: docNumber #<\/a>'},{field:"docDate",title:"F. Orden Compra",format:dateFormat,attributes:alignCenter,headerAttributes:alignCenter,width:130},{field:"estimatedDate",title:"F. Estimada",format:dateFormat,attributes:alignCenter,headerAttributes:alignCenter,width:100},{field:"terms",title:"Términos Pago",width:120},{field:"otherCosts",title:"Gastos Adicionales",format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight,width:140},{field:"quantity",title:"Cantidad",attributes:alignRight,headerAttributes:alignRight,width:100},{field:"openQuantity",title:"Cant. Abierta",attributes:alignRight,headerAttributes:alignRight,width:100},{field:"total",aggregates:["sum"],title:"Total",format:"{0:N2}",footerTemplate:"#=kendo.toString(sum, 'N2')#",attributes:alignRight,headerAttributes:alignRight,footerAttributes:alignRight,width:110},{field:"items",title:"Facturas",width:145,template:n=>n.items.map(n=>`<a class="bill action action-link">${n.billNumber}</a>${n.filePath&&n.fileName?`<a class="open-file action action-link" data-path="${n.filePath}" data-name="${n.fileName}" title="Factura f&iacute;sica de ${n.billNumber}"><i class="fas fa-file-invoice"></i></a>`:""}`).join(", ")},{field:"state",title:"Estado",width:80}],dataSource:{data:[],aggregate:[{field:"total",aggregate:"sum"}]},dataBound:function(n){var t=n.sender;t.columns.forEach((n,i)=>t.showColumn(i));$("div.k-group-indicator").each((n,i)=>t.hideColumn($(i).data("field")));t.element.find("table").attr("style","")}})}function getSubcategoriesFilter(n){return{CategoryId:n.filter.filters[0].value}}function loadWarehouses(n,t){var i,r;t.empty();i=n.multipleSelect("getSelects");i&&i.length>0?(r=Enumerable.From(i).Select(function(n){return`'${n}'`}).ToArray().join(),$.get(urlWarehouses,{Subsidiary:r},function(n){n.message!==""?(showError(n.message),t.multipleSelect("disable")):n.items.length>0?($.each(n.items,function(n,i){t.append(new Option(i.name,i.name))}),setTimeout(()=>t.multipleSelect("enable"),200)):t.multipleSelect("disable");t.multipleSelect("refresh").multipleSelect("uncheckAll")})):t.multipleSelect("refresh").multipleSelect("disable")}function cleanFilters(){$("#subsidiary").multipleSelect("checkAll");$("#warehouse").multipleSelect("uncheckAll");$("#order-number, #product").val("");$("#provider").multipleSelect("uncheckAll");$(`#initial-date`).data("kendoDatePicker").value("");$(`#final-date`).data("kendoDatePicker").value("");$("#ord-open").prop("checked",!0);$("#ord-close").prop("checked",!1);$("#line").data("kendoDropDownList").value("");$("#category").data("kendoDropDownList").value("");$("#subcategory").data("kendoDropDownList").value("")}function getFilters(){var i="",f=$(`#order-number`).val(),n=$(`#initial-date`).data("kendoDatePicker").value(),t=$(`#final-date`).data("kendoDatePicker").value(),e=$(`#product`).val(),r=$("#ord-open").prop("checked"),u=$("#ord-close").prop("checked"),o=r&u?"":r?"O":"C",s=Enumerable.From($(`#subsidiary`).multipleSelect("getSelects")).Select(function(n){return`'${n}'`}).ToArray().join(),h=Enumerable.From($(`#warehouse`).multipleSelect("getSelects")).Select(function(n){return`'${n}'`}).ToArray().join(),c=Enumerable.From($(`#provider`).multipleSelect("getSelects")).Select(function(n){return`'${n}'`}).ToArray().join(),l=$("#line").data("kendoDropDownList").value(),a=$("#category").data("kendoDropDownList").value(),v=$("#subcategory").data("kendoDropDownList").value();return n&&(n=n.toISOString()),t&&(t=t.toISOString()),u&!n&!t&&(i="Si desea ver las órdenes cerradas debe escoger un período de tiempo."),{message:i,data:{Subsidiaries:s,Warehouses:h,OrderNumber:f,ProviderCode:c,ProductCode:e,SinceDate:n,UntilDate:t,State:o,Line:l,Category:a,Subcategory:v}}}function filterData(){var n=getFilters();n.message===""?$.get(urlFilter,n.data,function(n){loadGrid(n.items);n.message!==""&&showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`)}):(setGridHeight("Listado",_gridMargin),showInfo(`Se deben ingresar los siguientes campos: <br />${n.message}`))}function loadGrid(n){if(n){n.forEach(n=>{n.docDate=JSON.toDate(n.docDate),n.estimatedDate=JSON.toDate(n.estimatedDate)});var t=$("#Listado").data("kendoGrid"),i=new kendo.data.DataSource({data:n,pageSize:500,aggregate:[{field:"total",aggregate:"sum"}],group:[{field:"subsidiary",dir:"asc",aggregates:[{field:"subsidiary",aggregate:"count"},{field:"total",aggregate:"sum"}]},{field:"warehouse",dir:"asc",aggregates:[{field:"warehouse",aggregate:"count"},{field:"total",aggregate:"sum"}]}]});t.setDataSource(i);n&&n.length>0?($("#filter-box").collapse("hide"),$("#action-excel").removeClass("d-none")):$("#action-excel").addClass("d-none");setGridHeight("Listado",_gridMargin)}}function loadReport(n,t,i){var f={Subsidiary:t,Id:n,User:$.trim($(".user-info > .user-name").first().text())},u="ProviderOrder.trdp",r;if(i==="Bill"&&(u="ProviderBill.trdp"),r=$("#reportViewer1").data("telerik_ReportViewer"),r)try{r.reportSource({report:u,parameters:f});r.refreshReport()}catch(e){showInfo("El servidor está ocupado, espere un momento y vuelva a intentar.")}else $("#reportViewer1").telerik_ReportViewer({serviceUrl:urlService,reportSource:{report:u,parameters:f},viewMode:telerikReportViewer.ViewModes.INTERACTIVE})}function exportExcel(){var n=getFilters();n.message===""?window.location.href=urlExcel+"?"+$.param(n.data):showInfo(`Los siguientes campos son necesarios <br />${n.message}`)}function openFile(n){var t=n.currentTarget.dataset;window.location.href=urlDownloadFile+"?"+$.param({FilePath:t.path,FileName:t.name})}var _minDate,_maxDate;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}",_gridMargin=15,localUser=$("#LocalUser").val()==="Y";$(()=>{setupControls(),setTimeout(function(){setGridHeight("Listado",_gridMargin)},800)});$(window).resize(()=>setGridHeight("Listado",_gridMargin));$("#filter-box").on("hidden.bs.collapse",()=>setGridHeight("Listado",_gridMargin));$("#filter-box").on("shown.bs.collapse",()=>setGridHeight("Listado",_gridMargin));$(".chk-state").click(function(){this.checked===!1&&$(this.id==="ord-open"?"#ord-close":"#ord-open").prop("checked",!0)});$("#action-clean").click(cleanFilters);$("#action-filter").click(filterData);$("#action-excel").click(exportExcel);$("#Listado").on("click",".order",function(n){var r=$("#Report").data("kendoWindow"),u=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),f=$(n.currentTarget).closest("tr"),t,i;u.select(f);t=$(this).text();i=u.dataItem(f);r.title(`Orden ${t} de ${i.providerName}`);loadReport(t,i.subsidiary,"Order");r.open().center()});$("#Listado").on("click",".bill",function(n){var r=$("#Report").data("kendoWindow"),u=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),f=$(n.currentTarget).closest("tr"),t,i;u.select(f);t=$(this).text();i=u.dataItem(f);r.title(`Factura ${t} de ${i.providerName}`);loadReport(t,i.subsidiary,"Bill");r.open().center()});$("#Listado").on("click",".item-code",function(){var i=$(this).text(),r=$(this).closest(".k-grid").parent().closest(".k-grid").data("kendoGrid"),u=$(this).closest(".k-grid").parent().closest("tr").prev(),n,f,t;r.select(u);n=r.dataItem(u);f=["FLETES","ENVIO","DMCSERVICIOS"];f.indexOf(i)==-1&&(t=$("<div>").kendoWindow({width:750,title:"Detalle Stock"}).data("kendoWindow"),t.refresh({url:urlGetStock,data:{Subsidiary:n.subsidiary,Warehouse:n.warehouse,ItemCode:i}}),t.open().center())});$("#Listado").on("click",".open-file",openFile);