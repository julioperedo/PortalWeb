function setupControls(){var n=$("#FilSince").kendoDatePicker({format:"d/M/yyyy",change:function(){var n=this.value();n===null&&this.value("");t.min(n?n:_minDate)}}).data("kendoDatePicker"),t=$("#FilUntil").kendoDatePicker({format:"d/M/yyyy",change:function(){var t=this.value();t===null&&this.value("");n.max(t?t:_maxDate)}}).data("kendoDatePicker");_maxDate=t.max();_minDate=n.min();$("#FilTransporter").kendoDropDownList({dataSource:{transport:{read:{url:urlTransporters}}},dataTextField:"name",filter:"contains",dataValueField:"id",optionLabel:"Seleccione un Transportista ..."});$("#FilSent").kendoDropDownList({dataTextField:"Text",dataValueField:"Value",optionLabel:"Seleccione un Estado ...",value:"N",dataSource:[{Text:"Ambos",Value:"B"},{Text:"Enviado",Value:"Y"},{Text:"No Enviado",Value:"N",Selected:!0}]});$("#FilSource").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Origen ...",filter:"contains",dataSource:{transport:{read:{url:urlSources}}}});$("#FilDestiny").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Destino ...",filter:"contains",dataSource:{transport:{read:{url:urlDestines}}}});$("#Listado").kendoGrid({columns:[{title:"Fecha",attributes:alignCenter,headerAttributes:alignCenter,width:90,field:"date",format:dateFormat},{title:"Tipo",width:100,field:"type.name"},{title:"Transporte",attributes:{style:"min-width: 120px;"},field:"transporter.name"},{title:"No. de Guía",width:110,field:"docNumber"},{title:"Origen",width:120,field:"source.name"},{title:"Destino",width:120,field:"destination.name"},{title:"Destinatario",field:"deliveryTo"},{title:"Pago Entrega",attributes:alignRight,headerAttributes:alignRight,width:120,field:"remainingAmount",format:"{0:N2}"},{title:" ",width:60,template:checkTemplate,field:"id",sortable:!1,headerTemplate:'<div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input check-all" id="chk-all" name="check-all"><label class="custom-control-label" for="chk-all"><\/label><\/div>'},{field:"id",title:" ",attributes:alignCenter,width:60,sortable:!1,headerAttributes:alignCenter,headerTemplate:'<i class="fas fa-plus action new-item" title="Nuevo Despacho"><\/i>',template:'<i class="fas fa-pen action action-edit" title="Editar Despacho"><\/i>&nbsp;&nbsp;<i class="fas fa-trash-alt action action-delete" title="Eliminar Despacho"><\/i>'}],sortable:!0,selectable:"Single, Row",noRecords:{template:'<div class="text-center w-100">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataSource:[]});$("#Detail").kendoWindow({visible:!1,modal:!0,iframe:!1,scrollable:!0,title:"Detalle despacho",resizable:!1,width:1e3,actions:["Close"],close:onCloseWindow,refresh:n=>{$("#Date").kendoDatePicker({format:"d/M/yyyy"});$("#SourceId").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Origen ...",filter:"contains",dataSource:{transport:{read:{url:urlSources}}}});$("#DestinationId").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Destino ...",filter:"contains",dataSource:{transport:{read:{url:urlDestines}}}});$("#TransporterId").kendoDropDownList({dataTextField:"name",dataValueField:"id",optionLabel:"Seleccione un Transportista ...",filter:"contains",dataSource:{transport:{read:{url:urlTransporters}}}});var t=+$("#TypeId").val(),i=$("#StringValues").val();setTransportType(t,i);onRefreshWindow(n)}})}function cleanFilters(){var n=new Date;$("#FilSince").data("kendoDatePicker").value(n);$("#FilUntil").data("kendoDatePicker").value(n);$("#FilTransporter").data("kendoDropDownList").value("");$("#FilSource").data("kendoDropDownList").value("");$("#FilDestiny").data("kendoDropDownList").value("");$("#FilName").val("")}function loadGrid(n){var i,r,t;$.each(n,function(n,t){t.date=JSON.toDate(t.date)});i=$("#Listado").data("kendoGrid");r=new kendo.data.DataSource({data:n});i.setDataSource(r);t=_gridMargin;n&&n.length>0&&($("#filter-box").collapse("hide"),t-=110);setGridHeight("Listado",t)}function getFilters(){var n=$("#FilSince").data("kendoDatePicker").value(),t=$("#FilUntil").data("kendoDatePicker").value(),i=$("#FilTransporter").data("kendoDropDownList").value(),r=$("#FilSource").data("kendoDropDownList").value(),u=$("#FilDestiny").data("kendoDropDownList").value(),f=$("#FilSent").data("kendoDropDownList").value(),e=$("#FilName").val();return n&&(n=n.toISOString()),t&&(t=t.toISOString()),{InitialDate:n,FinalDate:t,TransporterId:i,SourceId:r,DestinationId:u,Filter:e,Sent:f}}function filterData(){var n=getFilters();$.get(urlFilter,{Filters:JSON.stringify(n)},function(n){n.message===""?(loadGrid(n.items),$(".toolbar .filters").toggleClass("hidden"),$("#check-all").prop("checked",!1)):showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`)})}function setTransportType(n,t){var u,f,i,e,r;if($(".data-container").addClass("d-none"),n===149)$("#transport-type-1").prop("checked",!0),$("#DetailValue").closest(".data-container").removeClass("d-none"),$("label[for='DetailValue']").text("Ordenes:"),f=$("#DetailValue").magicSuggest({hideTrigger:!0,placeholder:"Ingrese las órdenes",maxDropHeight:0,maxSelection:null,minChars:100,minCharsRenderer:()=>"",vregex:/^\d*$/}),t&&t!==""&&(u=t.split(","),f.setValue(u)),$("#WithCopies, label[for='WithCopies']").removeClass("d-none");else{for(n===151?$("#transport-type-3").prop("checked",!0):$("#transport-type-2").prop("checked",!0),$("label[for='DetailValue']").text("Destinatarios:"),$("#contacts-content").closest(".data-container").removeClass("d-none"),i=[],t&&t!==""&&(i=JSON.parse(t)),e=5-i.length,r=0;r<e;r++)i.push({Name:"",EMail:""});renderGrid(i);$("#WithCopies, label[for='WithCopies']").addClass("d-none");$("#WithCopies").prop("checked",!1)}$("#Detail").data("kendoWindow").center()}function renderGrid(n){for(var i,r=$("#contacts-content"),t=1;t<=n.length;t++)i=n[t-1],$("#name"+t).val(i.Name),$("#email"+t).val(i.EMail)}function checkTemplate(n){var t="";return n.listTransportDetails&&n.listTransportDetails.length>0&&(t=`<div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input check-one" id="chk-one-${n.id}" value="${n.id}"><label class="custom-control-label" for="chk-one-${n.id}"></label></div>`),t}var _minDate,_maxDate;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},dateFormat="{0:dd-MM-yyyy}",_gridMargin=30;$(function(){setupControls();filterData()});$(window).resize(()=>{setGridHeight("Listado",_gridMargin)});$("#action-filter").click(()=>{filterData()});$("#action-clean").click(()=>{cleanFilters(),loadGrid([])});$("#action-email").click(()=>{var t=Enumerable.From($(".check-one:checked")).Select("+$.value").ToArray().join(),n=$("#Detail").data("kendoWindow");n.title("Enviar despacho por Correo");n.setOptions({width:1300});n.refresh({url:urlOpenPreview,data:{Ids:t}});n.open()});$("#Listado").on("click",".new-item",()=>{var n=$("#Detail").data("kendoWindow");n.refresh({url:urlEdit,data:{Id:0}});n.open()});$("#Listado").on("click",".action-edit",n=>{var i=$(n.target).closest("tr"),r=$("#Listado").data("kendoGrid"),u=r.dataItem(i),t;r.select(i);t=$("#Detail").data("kendoWindow");t.title("Detalle Despacho");t.setOptions({width:800});t.refresh({url:urlEdit,data:{Id:u.id}});t.open()});$("#Listado").on("click",".action-delete",n=>{n.preventDefault();var i=$("#Listado").data("kendoGrid"),r=$(n.target).closest("tr"),t=i.dataItem(r);i.select(r);showConfirm(`¿Está seguro que desea eliminar el Despacho con guía <b>${t.docNumber}</b>?`,()=>{$.post(urlDelete,{Id:t.id},n=>{n.message===""?(i.removeRow(r),showMessage(`La Guía <b>${t.docNumber}</b> fue eliminada correctamente`)):showError(`Se ha producido el siguiente error al intentar eliminar la Guía <b>${t.docNumber}</b>.<br /> ${n.message}`)})})});$("#Listado").on("click",".check-one",()=>{$("#action-email").toggleClass("d-none",$(".check-one:checked").length===0),$("#check-all").prop("checked",$(".check-one:checked").length===$(".check-one").length)});$("#Listado").on("click",".check-all",n=>{$(".check-one:not(:disabled)").length>0?($(".check-one:not(:disabled)").prop("checked",n.target.checked),$("#action-email").toggleClass("d-none",!n.target.checked)):n.target.checked=!1});$("#Detail").on("click","[name='transport-type']",function(){var n=+this.value;setTransportType(n,"")});$("#Detail").on("click",".action-cancel",n=>{n.preventDefault(),$("#Detail").data("kendoWindow").close()});$("#Detail").on("click",".action-save",n=>{var f,r,u,t,e,o,i,h;if(n.preventDefault(),f=$("#DetailValue").magicSuggest(),r=+$("[name='transport-type']:checked").val(),r!==149)for(u=[],t=1;t<=5;t++)e=$.trim($("#name"+t).val()),o=$.trim($("#email"+t).val()),e!==""&&o!==""&&u.push({Name:$("#name"+t).val(),EMail:$("#email"+t).val()});else u=[];var c={rules:{orders:n=>n.is("#DetailValue")&&r===149?f.isValid():!0,names:n=>n.is("#StringValues")&&r!==149?u.length>0&$(".handsontable").find(".htInvalid").length===0:!0},messages:{required:"*",names:"*",email:"No es un E-Mail válido",orders:"*"}},s=$(n.target).closest("form"),l=s.kendoValidator(c).data("kendoValidator");l.validate()&&(i=s.serializeObject(),i.Values=r===149?f.getValue():Enumerable.From(u).Select("JSON.stringify($)").ToArray(),i.TypeId=r,i.Transporter={Name:$("#TransporterId").data("kendoDropDownList").text()},i.Source={Name:$("#SourceId").data("kendoDropDownList").text()},i.Destination={Name:$("#DestinationId").data("kendoDropDownList").text()},h=getFilters(),$.post(urlEdit,{Item:i,Filters:h},function(n){n.message===""?(loadGrid(n.items),$("#Detail").data("kendoWindow").close(),showMessage("Se realizaron los cambios correctamente.")):showError(`Se ha producido el siguiente error al intentar guardar el despacho: <br /> ${n.message}`)}))});$("#Detail").on("click",".action-send",n=>{n.preventDefault();var t=Enumerable.From($(".transport-id")).Select("+$.value").ToArray().join(),i=getFilters();showConfirm(`¿Está seguro que desea enviar por correo las Guías seleccionadas?`,()=>{$.post(urlSendMail,{Ids:t,Filters:i},n=>{n.message===""?($("#Detail").data("kendoWindow").close(),loadGrid(n.items),$("#check-all").prop("checked",!1),showMessage("Se enviaron los correos correctamente.")):showError(`Se ha producido el siguiente error al intentar enviar los despachos por correo: <br />${n.message}`)})})});