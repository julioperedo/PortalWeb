function initForm(){setupControls();localUser?setGridHeight("Listado",_gridMargin):filterData()}function toggleShowAll(){var n;showMargin=!showMargin;$(this).find("i").toggleClass("fa-eye-slash fa-eye");$("#Listado").toggleClass("hide-margin show-margin");$("#Listado").find(".k-grid").each((t,i)=>{n=$(i).data("kendoGrid"),showMargin?$(window).width()>1199&&n.showColumn("margin0100"):n.hideColumn("margin0100"),$(i).find("table").attr("style","")});n=$("#Listado").data("kendoGrid");showMargin?n.showColumn("margin0100"):n.hideColumn("margin0100");n.element.find("table").attr("style","")}function setupControls(){var r=$("#initial-date").kendoDatePicker({format:"d/M/yyyy",change:function(){var n=this.value();n===null&&this.value("");u.min(n?n:_minDate)}}).data("kendoDatePicker"),u=$("#final-date").kendoDatePicker({format:"d/M/yyyy",change:function(){var n=this.value();n===null&&this.value("");r.max(n?n:_maxDate)}}).data("kendoDatePicker"),n,t,i;_maxDate=u.max();_minDate=r.min();localUser&&($("#client").kendoDropDownList({dataTextField:"name",dataValueField:"code",optionLabel:"Seleccione un Cliente...",filter:"contains",virtual:{itemHeight:26,valueMapper:function(n){var t=this.dataSource.data(),i=t.indexOf(t.find(t=>t.code===n.value));n.success(i)}},dataSource:{transport:{read:{url:urlClients}}}}),sellerCode=$("#SellerCode").val(),seeAllClients=$("#SeeAllClients").val()==="Y");$("#seller").kendoDropDownList({dataTextField:"name",dataValueField:"shortName",dataSource:{transport:{read:{url:urlSellers}}},optionLabel:"Seleccione un Vendedor...",filter:"contains",enable:seeAllClients|!localUser,value:sellerCode});$("#category").kendoDropDownList({dataTextField:"name",dataValueField:"id",dataSource:{transport:{read:{url:urlCategories}}},optionLabel:"Seleccione una Categoría...",filter:"contains"});$("#subcategory").kendoDropDownList({dataSource:{serverFiltering:!0,transport:{read:{url:urlSubcategories,data:n=>({CategoryId:n.filter.filters[0].value})}}},cascadeFrom:"category",enable:!1,optionLabel:"Seleccione una Subcategoría...",filter:"contains",dataTextField:"name",dataValueField:"id"});$("#line").kendoDropDownList({dataTextField:"name",dataValueField:"name",dataSource:{transport:{read:{url:urlLines}}},optionLabel:"Seleccione una Línea...",filter:"contains"});n=$("#subsidiary");t=$("#warehouse");t.multipleSelect({placeholder:"Seleccione al menos un almacén..."});n.multipleSelect({placeholder:"Seleccione al menos una sucursal...",onUncheckAll:()=>t.empty().multipleSelect("refresh").multipleSelect("disable"),onCheckAll:()=>loadWarehouses(n,t),onClick:()=>loadWarehouses(n,t)}).multipleSelect("checkAll");$("#items-complete").multipleSelect().multipleSelect("checkAll");$("#product-manager").kendoDropDownList({dataTextField:"name",dataValueField:"shortName",dataSource:{transport:{read:{url:urlPMs}}},optionLabel:"Seleccione un G. de Producto...",filter:"contains"});$.get(urlSubsidiaries,{},function(t){$.each(t.items,function(t,i){n.append(new Option(i.name,i.name))});n.multipleSelect("refresh")});i=[{title:"Sucursal",width:120,field:"subsidiary",aggregates:["count"],groupHeaderTemplate:n=>`Sucursal: <span class="text-nowrap">${n.value}&nbsp;( Total: ${n.count},&nbsp;Monto Total: ${kendo.toString(n.total.sum,"N2")} )</span>`,media:"lg"},{title:"Almacen",width:120,field:"warehouse",aggregates:["count"],groupHeaderTemplate:n=>`Almacén: <span class="text-nowrap">${n.value}&nbsp;( Total: ${n.count},&nbsp;Monto Total: ${kendo.toString(n.total.sum,"N2")} )</span>`,media:"lg"},{title:"Cliente",width:250,field:"clientName",aggregates:["count"],groupHeaderTemplate:n=>`Cliente: <span class="text-nowrap">${n.value}&nbsp;( Total: ${n.count},&nbsp;Monto Total: ${kendo.toString(n.total.sum,"N2")} )</span>`,media:"lg"},{title:"Vendedor",width:180,field:"sellerName",aggregates:["count"],groupHeaderTemplate:n=>`Vendedor: <span class="text-nowrap">${n.value}&nbsp;( Total: ${n.count},&nbsp;Monto Total: ${kendo.toString(n.total.sum,"N2")} )</span>`,media:"lg"},{title:"Fecha",width:100,field:"docDate",format:dateFormat,attributes:alignCenter,headerAttributes:alignCenter,media:"lg"},{title:"Estado",width:80,field:"state",media:"lg"},{title:"Tipo",width:120,field:"docType",media:"lg"},{title:"Número",width:120,field:"docNumber",media:"lg",attributes:alignCenter,headerAttributes:alignCenter,template:n=>{var t=n.series==="32"?n.docNumber:`<a class="doc-number action action-link" data-type="${n.docType}" data-number="${n.docNumber}">${n.docNumber}</a>`;return n.docType==="Nota de Venta"&&n.subsidiary.toLowerCase()==="santa cruz"&&(t+=`&nbsp;( <a class="doc-number action action-link" data-type="Factura" data-billtype="${n.series}" data-number="${n.docNumber}">Factura</a> )`),t}},{title:"O. Compra Cliente",field:"clientOrder",width:200,media:"lg"},{field:"total",aggregates:["sum"],title:"Total",width:110,format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight,footerAttributes:alignRight,footerTemplate:n=>kendo.toString(n.total.sum,"N2"),media:"lg"},{field:"openAmount",aggregates:["sum"],title:"Abierto",width:110,format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight,footerAttributes:alignRight,footerTemplate:n=>kendo.toString(n.openAmount.sum,"N2"),media:"lg"},{field:"totalBilled",aggregates:["sum"],title:"Facturado",width:110,template:n=>kendo.toString(n.total-n.openAmount,"N2"),attributes:alignRight,headerAttributes:alignRight,footerAttributes:alignRight,footerTemplate:n=>kendo.toString(n.total.sum-n.openAmount.sum,"N2"),media:"lg"},{field:"margin0100",aggregates:["sum"],title:"Margen",width:110,format:"{0:N2} %",attributes:alignRight,headerAttributes:alignRight,footerAttributes:alignRight,footerTemplate:n=>`${kendo.toString(n.taxlessTotal.sum!==0?100*(n.margin.sum/n.taxlessTotal.sum):0,"N2")} %`,media:"lg"},{field:"authorized",title:"Autorizado",width:110,attributes:alignCenter,headerAttributes:{style:"text-align: center; max-width: 90px;"},template:n=>n.authorized?'<i class="fas fa-check"><\/i>':"",media:"lg"},{field:"complete",title:"Completo",width:100,attributes:alignCenter,headerAttributes:{style:"text-align: center; max-width: 90px;"},template:n=>n.complete?'<i class="fas fa-check"><\/i>':"",media:"lg"},{field:"relatedDocs",title:"Doc. Relacionados",width:180,media:"lg",template:function(n){var i="",t,r;return n.relatedDocs.length>0&&(t=[],r=Enumerable.From(n.relatedDocs).OrderBy("$.docType").Select("$").ToArray(),r.forEach(i=>{var r=i.docType==="Nota de Venta"?"NV":i.docType==="Orden de Venta"?"OV":"NE";t.push(`${i.series==="32"?i.docNumber:`<a class="doc-number action action-link" data-type="${i.docType}" data-number="${i.docNumber}">${r}-${i.docNumber}</a>`}${n.subsidiary.toLowerCase()==="santa cruz"&&i.docType==="Nota de Venta"?`&nbsp;( <a class="doc-number action action-link" data-type="Factura" data-billtype="${i.series}" data-number="${i.docNumber}">Factura</a> )`:""}`)}),i=t.join("<br /> ")),i}},{title:" ",field:"header",width:35,template:n=>n.header!==""||n.footer!==""?'<a class="comment action action-link" title="Cabecera y/o Pie de Orden"><i class="far fa-list-alt"><\/i><\/a>':"",media:"lg"},{title:" ",firld:"files",width:35,template:n=>n.files.length>0&&localUser?'<a class="attach action action-link" title="Archivos adjuntos"><i class="fas fa-paperclip"><\/i><\/a>':"",media:"lg"},{title:" ",field:"transport",width:35,template:n=>n.transport.length>0?'<a class="action action-link transport-id" title="Datos de Transporte"><i class="fas fa-road"><\/i><\/a>':"",media:"lg"}];$(window).width()<992&&i.push({field:"id",title:"Detalle",media:"(max-width: 991px)",template:function(n){var t="";if(n.docType==="Orden de Venta"&&(t=`<div class="row d-xl-none">
                                     <div class="col"><span class="label">Cliente:</span>&nbsp;&nbsp;${n.clientName}</div>
                                   </div>
                                   <div class="row d-xl-none">
                                     <div class="col"><span class="label">Vendedor:</span>&nbsp;&nbsp;${n.sellerName}</div>
                                   </div>
                                   <div class="row d-xl-none">
                                     <div class="col"><span class="label">Sucursal:</span>&nbsp;&nbsp;${n.subsidiary}</div>
                                     <div class="col text-nowrap"><span class="label">Almac&eacute;n:</span>&nbsp;&nbsp;${n.warehouse}</div>
                                   </div>
                                   <div class="row d-xl-none">
                                     <div class="col"><span class="label">Estado:</span>&nbsp;&nbsp;${n.state}</div>
                                     <div class="col text-nowrap"><span class="label">Fecha:</span>&nbsp;&nbsp;${kendo.toString(n.docDate,"dd-MM-yyyy")}</div>
                                   </div>
                                   <div class="row">
                                     <div class="col"><span class="label">N&uacute;mero:</span>&nbsp;&nbsp;<a class="doc-number action action-link" data-type="${n.docType}" data-number="${n.docNumber}">${n.docNumber}</a></div>
                                     <div class="col"><span class="label">Tipo:</span>&nbsp;&nbsp;<span class="text-nowrap">${n.docType}</span></div>
                                     <div class="col"><span class="label">Autorizado:</span>&nbsp;&nbsp;${n.authorized?"Si":"No"}&nbsp;&nbsp;&nbsp;&nbsp;${localUser?`<span class="label">Completo:</span>&nbsp;&nbsp;${n.complete?"Si":"No"}`:""}</div>
                                   </div>
                                   <div class="row">
                                     <div class="col"><span class="label">Total($us):</span>&nbsp;&nbsp;${kendo.toString(n.total,"N2")}</div>
                                     <div class="col"><span class="label">Abierto ($us):</span>&nbsp;&nbsp;${kendo.toString(n.openAmount,"N2")}</div>
                                     <div class="col"><span class="label">Facturado ($us):</span>&nbsp;&nbsp;${kendo.toString(n.total-n.openAmount,"N2")}</div>
                                     <div class="col"><span class="label margin">Margen:</span>&nbsp;&nbsp;<span class="margin">${kendo.toString(n.margin0100,"N2")} %</span></div>
                                   </div>
                                   <div class="row">
                                     <div class="col"><span class="label">Orden Compra Cliente:</span>&nbsp;&nbsp;${n.clientOrder}</div>
                                     <div class="col">
                                        ${(n.header!==""||n.footer!=="")&&localUser?'<a class="comment btn btn-danger btn-sm" title="Cabecera y/o Pie">Cabecera y/o Pie <i class="far fa-list-alt"><\/i><\/a>&nbsp;&nbsp;&nbsp;&nbsp;':""}
                                        ${n.files.length>0&&localUser?'<a class="attach btn btn-danger btn-sm" title="Archivos adjuntos">Adjuntos <i class="fas fa-paperclip"><\/i><\/a>':""}
                                        ${n.transport.length>0?'<a class="btn btn-danger btn-sm transport-id" title="Datos de Transporte">Transporte <i class="fas fa-road"><\/i><\/a>':""}
                                     </div>
                                   </div>`),(n.docType==="Nota de Venta"||n.docType==="Nota de Entrega")&&(t=`<div class="row">
                                     <div class="col"><span class="label">N&uacute;mero:</span>&nbsp;&nbsp;${n.series==="32"?n.docNumber:`<a class="doc-number action action-link" data-type="${n.docType}" data-number="${n.docNumber}">${n.docNumber}</a>`}${n.subsidiary.toLowerCase()==="santa cruz"&&n.docType==="Nota de Venta"?`&nbsp;<a class="doc-number action action-link" data-type="Factura" data-number="${n.docNumber}" data-billtype="${n.series}">Factura</a>`:""}</div>
                                     <div class="col"><span class="label">Tipo:</span>&nbsp;&nbsp;<span class="text-nowrap">${n.docType}</span></div>
                                      <div class="col d-xl-none"><span class="label">Sucursal:</span>&nbsp;&nbsp;${n.subsidiary}</div>
                                     <div class="col d-xl-none text-nowrap"><span class="label">Almac&eacute;n:</span>&nbsp;&nbsp;${n.warehouse}</div>
                                     <div class="col"><span class="label">Total($us):</span>&nbsp;&nbsp;${kendo.toString(n.total,"N2")}</div>
                                     <div class="col"><span class="label margin">Margen:</span>&nbsp;&nbsp;<span class="margin">${kendo.toString(n.margin0100,"N2")} %</span></div>
                                   </div> `,(n.files.length&&localUser||n.transport!==null)&&(t+=`<div class="row">
                                           <div class="col">
                                              ${n.files.length>0&&localUser?'<a class="attach btn btn-danger btn-sm" title="Archivos adjuntos">Adjuntos <i class="fas fa-paperclip"><\/i><\/a>':""}
                                              ${n.transport.length>0?'<a class="btn btn-danger btn-sm transport-id" title="Datos de Transporte">Transporte <i class="fas fa-road"><\/i><\/a>':""}
                                           </div>
                                        </div>`)),n.relatedDocs.length>0){var u=Enumerable.From(n.relatedDocs).Select("$.docNumber").ToArray().join(),r=Enumerable.From(n.relatedDocs).GroupBy("{ docType: $.docType }",null,function(n,t){var i=Enumerable.From(t).Select("{ number: $.docNumber, type: $.series }").Distinct().ToArray();return{type:n.docType,items:i}},"$.docType").ToArray(),i="";r.forEach(t=>{i+=`<div class="related-doc ${t.type.toLowerCase().replaceAll(" ","-")}">${t.type}: `;var r=[];t.items.forEach(i=>r.push(`<a class="doc-number action action-link" data-type="${t.type}" data-number="${i.number}">${i.number}</a>${n.subsidiary.toLowerCase()==="santa cruz"&&t.type==="Nota de Venta"?`&nbsp;( <a class="doc-number action action-link" data-type="Factura" data-number="${i.number}" data-billtype="${i.type}">Factura</a> )`:""}`));i+=`${r.join(", ")}</div>`});t+=`<div class="row">
                                      <div class="col">${i}</div>
                                   </div>`}return t},footerTemplate:function(n){var i="",t=$("[name='search-by']:checked").val(),i="";return`<div class="row">
                                 <div class="col"><span class="label">Total($us):</span>&nbsp;&nbsp;${kendo.toString(n.total.sum,"N2")}</div>
                                 ${t==="SO"?`<div class="col"><span class="label">Abierto ($us):</span>&nbsp;&nbsp;${kendo.toString(n.openAmount.sum,"N2")}</div>`:``}
                                 ${t==="SO"?`<div class="col"><span class="label">Facturado ($us):</span>&nbsp;&nbsp;${kendo.toString(n.total.sum-n.openAmount.sum,"N2")}</div>`:``}
                                 <div class="col"><span class="label margin">Margen:</span>&nbsp;&nbsp;<span class="margin">${kendo.toString(n.taxlessTotal.sum!==0?100*(n.margin.sum/n.taxlessTotal.sum):0,"N2")} %</span></div>
                               </div>`}});$("#Listado").kendoGrid({columns:i,groupable:{messages:{empty:"Arrastre un encabezado de columna y colóquela aquí para agrupar por esa columna"},enabled:!0},sortable:!0,selectable:"Single, Row",scrollable:{height:200},noRecords:{template:'<div class="text-center w-100">No se encontraron registros para el criterio de búsqueda.<\/div>'},dataSource:getDataSource([]),dataBound:function(n){var t=n.sender,i,r;if($(window).width()>991){for(i=0;i<t.columns.length;i++)t.showColumn(i);$("div.k-group-indicator").each(function(n,i){t.hideColumn($(i).data("field"))});r=["state","clientOrder","openAmount","totalBilled","authorized","complete","header"];$("[name='search-by']:checked").val()!=="SO"?r.forEach(n=>t.hideColumn(n)):r.forEach(n=>t.showColumn(n));showMargin||t.hideColumn("margin0100")}t.element.find("table").attr("style","");n.sender.element.find(".k-group-col,.k-group-cell").css("width",$(window).width()<768?1:22)},detailInit:function(n){$.get(urlDetail,{Subsidiary:n.data.subsidiary,Id:n.data.id,State:n.data.state,Type:n.data.docType},function(t){$("<div>").appendTo(n.detailCell).kendoGrid({scrollable:!1,sortable:!0,pageable:!1,selectable:!0,columns:[{field:"itemCode",title:"Cod. Item DMC",width:160,template:n=>localUser?`<a class="item-code action action-link">${n.itemCode}</a>`:n.itemCode,media:"xl"},{field:"itemName",title:"Descripción",width:350,media:"xl"},{field:"warehouse",title:"Almacén",width:120,media:"xl"},{field:"line",title:"Línea",width:200,media:"xl"},{field:"quantity",title:"Cantidad",width:90,attributes:alignRight,headerAttributes:alignRight,media:"xl"},{field:"openQuantity",title:"Abierta",width:90,attributes:alignRight,headerAttributes:alignRight,media:"xl"},{field:"stock",title:"Stock",width:90,attributes:alignRight,headerAttributes:alignRight,media:"xl"},{field:"price",title:"Precio",width:90,format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight,media:"xl"},{field:"itemTotal",title:"Subtotal",width:90,format:"{0:N2}",attributes:alignRight,headerAttributes:alignRight,media:"xl"},{field:"margin0100",title:"Margen",width:90,format:"{0:p}",attributes:alignRight,headerAttributes:alignRight,media:"xl"},{field:"complete",title:"Completo",width:90,template:'# if(complete || line === "DMC") {# <i class="fas fa-check"><\/i> #} #',attributes:alignCenter,headerAttributes:alignCenter,media:"xl"},{media:"(max-width: 1199px)",title:"Detalle",template:function(n){return`<div class="row">
                                                  <div class="col"><span class="label">Cod. Item DMC:</span>&nbsp;&nbsp;${n.itemCode}</div>
                                                  <div class="col-12"><span class="label">Descripci&oacute;n:</span>&nbsp;&nbsp;${n.itemName}</div>
                                                  <div class="col"><span class="label">Almac&eacute;n:</span>&nbsp;&nbsp;${n.warehouse}</div>
                                                  <div class="col text-nowrap"><span class="label">L&iacute;nea:</span>&nbsp;&nbsp;${n.line}</div>
                                                  <div class="col"><span class="label">Cantidad:</span>&nbsp;&nbsp;${n.quantity}</div>
                                                  ${$("[name='search-by']:checked").val()!=="SO"?``:`<div class="col"><span class="label">Abierta:</span>&nbsp;&nbsp;${n.openQuantity}</div>`}
                                                  ${localUser&$("[name='search-by']:checked").val()==="SO"?`<div class="col"><span class="label">Stock:</span>&nbsp;&nbsp;${n.stock}</div>`:``}
                                                  <div class="col"><span class="label">Precio:</span>&nbsp;&nbsp;${kendo.toString(n.price,"N2")}</div>
                                                  <div class="col"><span class="label">Subtotal:</span>&nbsp;&nbsp;${kendo.toString(n.itemTotal,"N2")}</div>
                                                  <div class="col margin"><span class="label">Margen:</span>&nbsp;&nbsp;${kendo.toString(n.margin0100*100,"N2")} %</div>
                                                  ${localUser&$("[name='search-by']:checked").val()==="SO"?`<div class="col"><span class="label">Completo:</span>&nbsp;&nbsp;${n.complete||n.line==="DMC"?"Si":"No"}</div>`:``}
                                               </div>`}}],dataSource:t.items,dataBound:function(n){var t=n.sender;localUser||(t.hideColumn("complete"),t.hideColumn("stock"));$("[name='search-by']:checked").val()!=="SO"&&(t.hideColumn("openQuantity"),t.hideColumn("stock"),t.hideColumn("complete"));showMargin||t.hideColumn("margin0100");t.element.find("table").attr("style","")},noRecords:{template:"No se encontraron registros para el criterio de búsqueda."}})})}});$("#Detail").kendoWindow({visible:!1,modal:!0,iframe:!1,scrollable:!0,title:"",resizable:!1,width:1200,actions:["Close"],activate:function(){var n=this;setTimeout(()=>n.center(),300)}});$("#Report").kendoWindow({visible:!1,width:1100,title:"",modal:!0,activate:function(){var n=this;setTimeout(()=>n.center(),300)}})}function changeState(n){n.currentTarget.checked===!1&&$(n.currentTarget.id==="state-open"?"#state-close":"#state-open").prop("checked",!0)}function changeSearchType(n){n.target.parentElement.innerText==="Orden de Venta"?($("#state-open, #state-close").closest(".custom-switch").removeClass("d-none"),$("#items-complete").parent().removeClass("d-none"),$("label[for='items-complete']").removeClass("d-none"),$("#client-order").parent().removeClass("d-none"),$("label[for='client-order']").removeClass("d-none")):($("#state-open, #state-close").closest(".custom-switch").addClass("d-none"),$("#items-complete").parent().addClass("d-none"),$("label[for='items-complete']").addClass("d-none"),$("#client-order").parent().addClass("d-none"),$("label[for='client-order']").addClass("d-none"))}function openTransport(n){var i=$("#Listado").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),t;i.select(r);var e=i.dataItem(r).transport,u="",f=[];e.forEach(n=>{f.push(`<div class="form-horizontal">
                             <div class="row">
                                 <span class="control-label col-md-2 font-weight-bold">No. de Guía :</span><div class="col-md-4 control-item"><span>${n.docNumber}</span></div>
                                 <span class="control-label col-md-2 font-weight-bold">Fecha :</span><div class="col-md-4 control-item"><span>${kendo.toString(JSON.toDate(n.date),"dd-MM-yyyy")}</span></div>
                             </div>
                             <div class="row">
                                 <span class="control-label col-md-2 font-weight-bold">Origen :</span><div class="col-md-4 control-item"><span>${n.source}</span></div>
                                 <span class="control-label col-md-2 font-weight-bold">Destino :</span><div class="col-md-4 control-item"><span>${n.destination}</span></div>
                             </div>
                             <div class="row">
                                 <span class="control-label col-md-2 font-weight-bold">Transporte :</span><div class="col-md-4 control-item"><span>${n.transporter}</span></div>
                                 <span class="control-label col-md-2 font-weight-bold">Entregar a :</span><div class="col-md-4 control-item"><span>${n.deliveryTo}</span></div>
                             </div>
                             <div class="row">
                                 <span class="control-label col-md-2 font-weight-bold text-nowrap">Observaciones :</span><div class="col-md-10 control-item"><span>${n.observations}</span></div>
                             </div>
                             <div class="row">
                                 <span class="control-label col-md-2 font-weight-bold">Peso(Kg) :</span><div class="col-md-4 control-item"><span>${kendo.toString(n.weight,"N1")}</span></div>
                                 <span class="control-label col-md-2 font-weight-bold">Cant. Piezas :</span><div class="col-md-4 control-item"><span>${n.quantityPieces}</span></div>
                             </div>
                             <div class="row">
                                 <span class="control-label col-md-2 text-nowrap font-weight-bold">Pago Entrega (Bs) :</span><div class="col-md-4 control-item"><span>${kendo.toString(n.remainingAmount,"N2")}</span></div>
                             </div>
                         </div>`)});u=f.join("<hr />");t=$("#Detail").data("kendoWindow");t.setOptions({width:790,title:"Datos de la Guía"});t.content(u).open()}function openFilesList(n){var t=$("#Detail").data("kendoWindow"),i,r,f,u;t.setOptions({width:600,title:"Adjuntos"});i=$("#Listado").data("kendoGrid");r=$(n.currentTarget).closest("tr");i.select(r);f=i.dataItem(r);u="";f.files.forEach(n=>u+=`<a href="#" data-path="${n.path}" data-name="${n.fileName}" data-ext="${n.fileExt}" class="open-file action-link"><span>${n.fileName}.${n.fileExt}</span></a><br />`);t.content(u);t.center().open()}function openFile(n){var t=n.currentTarget.dataset;window.location.href=urlDownloadFile+"?"+$.param({FilePath:t.path,FileName:t.name,FileExt:t.ext})}function openComments(n){var i=$("#Detail").data("kendoWindow"),r,u,t,f;i.setOptions({width:600,title:"Comentarios"});r=$("#Listado").data("kendoGrid");u=$(n.currentTarget).closest("tr");r.select(u);t=r.dataItem(u);f=(t.header!==""?`<h5>Iniciales</h5><p>${t.header}</p>`:"")+(t.footer!==""?`<h5>Finales</h5><p>${t.footer}</p>`:"");i.content(f);i.center().open()}function openProductStock(n){var t=$(n.currentTarget).text(),r=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),u=$(n.currentTarget).closest("tr"),o,s,i;r.select(u);var h=r.dataItem(u),f=$(n.currentTarget).closest(".k-grid").parent().closest(".k-grid").data("kendoGrid"),e=$(n.currentTarget).closest(".k-grid").parent().closest("tr").prev();f.select(e);o=f.dataItem(e);s=["FLETES","ENVIO","DMCSERVICIOS"];s.indexOf(t)==-1&&(i=$("<div>").attr("id",setSafeName("detail-stock-"+t)).kendoWindow({width:980,title:"Detalle Stock"}).data("kendoWindow"),i.refresh({url:urlGetStock,data:{Subsidiary:o.subsidiary,Warehouse:h.warehouse,ItemCode:t}}),i.open().center())}function openProductReserved(n){var t=n.currentTarget.dataset,i=$(n.currentTarget).closest(".table").parent().find(".items-reserved"),r=$("#detail-stock-"+setSafeName(t.itemcode)).data("kendoWindow");i.empty();$.get(urlReservedItems,{Subsidiary:t.subsidiary,Warehouse:t.warehouse,ItemCode:t.itemcode},function(n){if(n.message===""){var f=t.subsidiary.toLowerCase()==="iquique"?"<th>Autorizado<\/th><th>Correlativo<\/th>":"",u=`<thead class="thead-light"><tr><th scope="col">Ejecutivo</th><th scope="col">Cliente</th><th scope="col">Orden</th><th scope="col">Fecha</th><th scope="col" class="text-right">Cantidad</th><th scope="col" class="text-right">Precio</th>${f}<th>&nbsp;</th></thead><tbody>`;$.each(n.items,function(n,i){var r=t.subsidiary.toLowerCase()==="iquique"?`<td class="text-center">${i.authorized==="Y"?'<i class="fas fa-check"><\/i>':""}</td><td>${i.correlative}</td>`:"";u+=`<tr><td>${i.sellerName}</td><td><strong>${i.clientCode}</strong> - ${i.clientName}</td><td><a class="sale-order action action-link" data-subsidiary="${i.subsidiary}" data-number="${i.docNum}">${i.docNum}</a></td><td>${kendo.toString(JSON.toDate(i.docDate),"dd-MM-yyyy")}</td><td class="text-right">${i.quantity}</td><td class="text-right">${i.price!==null?kendo.toString(i.price,"N2"):""}</td>${r}<td>`;i.hasFiles&&$.each(i.files,function(n,t){u+=`<a href="#" title="${t}" class="open-file" data-subsidiary="${i.subsidiary}" data-code="${i.docEntry}" data-file="${t}"><span class="glyphicon glyphicon-paperclip"></span></a>&nbsp;&nbsp;&nbsp;`});u+=`</td></tr>`});u+="<\/tbody>";i.append(u);setTimeout(()=>r.center(),100)}else showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`)})}function loadWarehouses(n,t){var i=n.multipleSelect("getSelects"),r;i&&i.length>0?(r=Enumerable.From(i).Select(function(n){return`'${n}'`}).ToArray().join(),$.get(urlWarehouses,{Subsidiary:r},function(n){n.message!==""?(showError(n.message),t.multipleSelect("disable")):(t.empty(),n.items.length>0?($.each(n.items,function(n,i){t.append(new Option(i.name,i.name))}),t.multipleSelect("enable")):t.multipleSelect("disable"),t.multipleSelect("refresh"));t.multipleSelect("uncheckAll")})):t.multipleSelect("disable")}function getFilters(){var u="",e=$(`#client`).val(),f=$(`#number`).val(),i=$(`#initial-date`).data("kendoDatePicker").value(),r=$(`#final-date`).data("kendoDatePicker").value(),o=$(`#seller`).val(),t=$(`#state-open`).prop("checked")&&$(`#state-close`).prop("checked")?"":$(`#state-open`).prop("checked")?"O":"C",s=$.trim($(`#product-manager`).val())!==""?$(`#product-manager`).data("kendoDropDownList").text():"",h=$(`#client-order`).val(),c=$(`#product`).val(),l=$.trim($(`#category`).val())!==""?$("#category").data("kendoDropDownList").text():"",a=$.trim($(`#subcategory`).val())!==""?$(`#subcategory`).data("kendoDropDownList").text():"",v=$(`#line`).val(),y=Enumerable.From($(`#subsidiary`).multipleSelect("getSelects")).Select("$").ToArray().join(),p=Enumerable.From($(`#warehouse`).multipleSelect("getSelects")).Select("$").ToArray().join(),w=Enumerable.From($(`#items-complete`).multipleSelect("getSelects")).Select("$").ToArray().join(),n=$("[name='search-by']:checked").val();return i?i=i.toISOString():$.trim(f)===""&&(n==="SO"&&(t===""||t==="C")||n==="SN"||n==="DN")&&(u+="- Fecha Inicial<br />"),r?r=r.toISOString():$.trim(f)===""&&(n==="SO"&&(t===""||t==="C")||n==="SN"||n==="DN")&&(u+="- Fecha Final<br />"),{message:u,data:{ClientCode:e,DocNumber:f,InitialDate:i,FinalDate:r,SellerCode:o,State:t,Complete:w,ClientOrder:h,ItemCode:c,Category:l,Subcategory:a,Line:v,Subsidiary:y,Warehouse:p,ProductManager:s,SearchType:n}}}function setSafeName(n){return n.replace("(","").replace(")","").replace("#","").replace("/","")}function setEnableFilters(n,t,i){var a=$("#initial-date").data("kendoDatePicker"),v=$("#final-date").data("kendoDatePicker"),r=$("#client").data("kendoDropDownList"),u=$("#seller").data("kendoDropDownList"),f=$("#state-open"),e=$("#state-close"),y=$("#product-manager").data("kendoDropDownList"),o=$("#items-complete"),s=$("#client-order"),h=$("#product"),p=$("#line").data("kendoDropDownList"),w=$("#category").data("kendoDropDownList"),b=$("#subcategory").data("kendoDropDownList"),c=$("#subsidiary"),l=$("#warehouse");a.enable(n);v.enable(n);localUser&&r.enable(n);y.enable(n);p.enable(n);w.enable(n);b.enable(n);n?(u.enable(seeAllClients|!localUser),f.removeAttr("disabled"),e.removeAttr("disabled"),o.multipleSelect("enable"),s.removeAttr("disabled"),h.removeAttr("disabled"),c.multipleSelect("enable"),l.multipleSelect("enable")):(u.enable(n),f.attr("disabled","disabled"),e.attr("disabled","disabled"),o.multipleSelect("disable"),s.attr("disabled","disabled"),h.attr("disabled","disabled"),c.multipleSelect("disable"),l.multipleSelect("disable"));i&&$("#number").val("");t&&(o.multipleSelect("checkAll"),c.multipleSelect("uncheckAll"),l.multipleSelect("uncheckAll"),a.value(""),v.value(""),localUser&&(r.text(""),r.value("")),seeAllClients|!localUser&&u.value(""),y.value(""),p.value(""),w.value(""),b.value(""),f.prop("checked",!0),e.prop("checked",!1),s.val(""),h.val(""))}function getDataSource(n){$.each(n,function(n,t){t.docDate=JSON.toDate(t.docDate)});return new kendo.data.DataSource({data:n,aggregate:[{aggregate:"sum",field:"total"},{aggregate:"sum",field:"openAmount"},{aggregate:"count",field:"subsidiary"},{aggregate:"count",field:"warehouse"},{aggregate:"count",field:"clientName"},{aggregate:"count",field:"sellerName"},{aggregate:"sum",field:"taxlessTotal"},{aggregate:"sum",field:"margin"}],group:[{field:"subsidiary",dir:"asc",aggregates:[{field:"subsidiary",aggregate:"count"},{field:"total",aggregate:"sum"},{field:"openAmount",aggregate:"sum"}]},{field:"warehouse",dir:"asc",aggregates:[{field:"warehouse",aggregate:"count"},{field:"total",aggregate:"sum"}]}],sort:[{field:"subsidiary",dir:"asc"},{field:"warehouse",dir:"asc"},{field:"docDate",dir:"asc"},{field:"docNumber",dir:"asc"}],schema:{model:{id:"id"}}})}function loadGrid(n){var t=$("#Listado").data("kendoGrid"),i=getDataSource(n);t.setDataSource(i);n&&n.length>0?($("#filter-box").collapse("hide"),$("#action-excel").removeClass("d-none")):$("#action-excel").addClass("d-none");setTimeout(()=>setGridHeight("Listado",_gridMargin),300)}function openReport(n){var t=n.currentTarget.dataset,i=$(n.currentTarget).closest(".k-grid").data("kendoGrid"),r=$(n.currentTarget).closest("tr"),u,f;i.select(r);u=i.dataItem(r);f=$("#Report").data("kendoWindow");loadReport(t.number,u.subsidiary,t.type,t.billtype);f.open()}function openSaleOrderReport(n){var t=n.currentTarget.dataset,i=$("#Report").getKendoWindow();i.title("Orden de Venta");loadReport(t.number,t.subsidiary,"Order");i.open().center()}function loadReport(n,t,i,r){var e={Subsidiary:t,DocNumber:n,User:$.trim($(".user-info > .user-name").first().text())},u="SaleOrder.trdp",f;if(i==="Nota de Venta"&&(u="SaleNote.trdp"),i==="Nota de Entrega"&&(u="DeliveryNote.trdp",e.SearchType=2),i==="Factura")switch(r){case"93":u="ElectronicBill.trdp";break;case"32":u="RentReceipt.trdp";break;default:u="Bill.trdp"}if(f=$("#reportViewer1").data("telerik_ReportViewer"),f)try{f.reportSource({report:u,parameters:e});f.refreshReport()}catch(o){showInfo("El servidor está ocupado, espere un momento y vuelva a intentar.")}else $("#reportViewer1").telerik_ReportViewer({serviceUrl:urlService,reportSource:{report:u,parameters:e},viewMode:telerikReportViewer.ViewModes.INTERACTIVE,scaleMode:telerikReportViewer.ScaleModes.SPECIFIC,scale:1})}function ExportExcel(){var n=getFilters(),t;n.message===""?(t=`<p class="font-weight-bold">¿Desea exportar una tabla agrupada o una tabla plana sin agrupaciones?</p>
                       <div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="export-detailed"><label class="custom-control-label" for="export-detailed">Exportar Detallado</label></div>`,showConfirm(t,function(){var i=$("#export-detailed").prop("checked"),t=n.data;t.Detailed=i;window.location.href=urlExcel+"?"+$.param(t)})):showInfo(`Los siguientes campos son necesarios <br />${n.message}`)}function filterData(){var n=getFilters();n.message===""?$.get(urlFilter,n.data,function(n){n.message===""?loadGrid(n.items):(console.error(n.message),showError("Se ha producido un error al traer los datos del servidor."))}):showInfo(`Se deben ingresar los siguientes campos: <br />${n.message}`)}function changeToTableMode(n){$(n.currentTarget).find("i").toggleClass("fa-table fa-th-list");showAsTable=!showAsTable}var _minDate,_maxDate,sellerCode="",seeAllClients=!1,showMargin=!1;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}",_gridMargin=0,seeMargin=$("#SeeMargin")==="Y",localUser=$("#LocalUser").val()==="Y",showAsTable=!1;$(document).ajaxError(catchError);$(()=>initForm());$(window).resize(()=>setGridHeight("Listado",_gridMargin));$("#action-show-all").click(toggleShowAll);$(".chk-state").click(changeState);$(".more-options").click(n=>$(n.currentTarget).toggleHtml("Más opciones","Menos opciones"));$("#number").keyup(n=>setEnableFilters($(n.target).val()==="",!0,!1));$("#action-clean").click(()=>setEnableFilters(!0,!0,!0));$("[name='search-by']").click(changeSearchType);$("#action-filter").click(filterData);$("#Listado").on("click",".transport-id",openTransport);$("#Listado").on("click",".attach",openFilesList);$("body").on("click",".open-file",openFile);$("#Listado").on("click",".comment",openComments);$("#Listado").on("click",".doc-number",openReport);$("#Listado").on("click",".item-code",openProductStock);$("body").on("click",".reserved",openProductReserved);$("#action-excel").on("click",ExportExcel);$("body").on("click",".sale-order",openSaleOrderReport);$("#action-table-mode").click(changeToTableMode);