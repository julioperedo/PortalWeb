function setupControls(){var n=new Date,r=n,t=$("#filter-initial-date").kendoDatePicker({value:r,change:function(){var n=this.value();n===null&&this.value("");i.min(n?n:_minDate)}}).data("kendoDatePicker"),i=$("#filter-final-date").kendoDatePicker({value:n,change:function(){var n=this.value();n===null&&this.value("");t.max(n?n:_maxDate)}}).data("kendoDatePicker");_maxDate=i.max();_minDate=t.min();wndDetail=$("#Detail").kendoWindow({visible:!1,width:750,title:"Mensaje",modal:!0,close:function(){$("#msg-title").val("");$("#msg-body").val("")}}).data("kendoWindow");kufiles=$("#files").kendoUpload({"async":{saveUrl:urlSaveFile,removeUrl:urlRemoveFile},multiple:!1,validation:{maxFileSize:41943040}}).data("kendoUpload");ddlType=$("#RecipientsType").kendoDropDownList({change:function(n){var t=$(n.sender.element).val();$("#divTopics").toggleClass("d-none",t!="T");$("#divUsers").toggleClass("d-none",t!="U")},dataTextField:"Text",dataValueField:"Value",value:"U",dataSource:[{Text:"Todos",Value:"A",Selected:!0},{Text:"Por Usuario",Value:"U"}]}).data("kendoDropDownList");ddlUsers=$("#messageUsers").kendoMultiSelect({dataTextField:"name",dataValueField:"id",placeholder:"Seleccione destinatarios...",filter:"contains",dataSource:{transport:{read:{url:urlUsers}}}}).data("kendoMultiSelect");grdItems=$("#Listado").kendoGrid({noRecords:{template:'<div class="w-100 text-center p-3">No hay resultados para el criterio de búsqueda.<\/div>'},columns:[{title:"Título",minScreenWidth:150,field:"title"},{title:"Enviado",attributes:alignCenter,headerAttributes:alignCenter,width:140,field:"date",format:"{0:dd-MM-yyyy HH:mm}"},{title:"Destinatarios",width:250,template:"#=getType(recipientsType)#",field:"recipientsType"},{field:"id",title:" ",attributes:alignCenter,width:50,sortable:!1,headerAttributes:alignCenter,headerTemplate:'<i class="fas fa-plus action action-new" title="Nuevo Mensaje"><\/i>',template:'<i class="fas fa-pen action action-edit" title="Editar Mensaje"><\/i>'}],sortable:!0,selectable:"Single, Row",dataSource:[]}).data("kendoGrid")}function cleanFilters(){var n=new Date;$("#filter-initial-date").data("kendoDatePicker").value(n);$("#filter-final-date").data("kendoDatePicker").value(n);$("#filter-name").val("")}function getFilters(){var i="",r=$("#filter-name").val(),n=$("#filter-initial-date").data("kendoDatePicker").value(),t=$("#filter-final-date").data("kendoDatePicker").value();return n&&(n=n.toISOString()),t&&(t=t.toISOString()),n===""&t===""&r===""&&(i="Debe escoger algún criterio de búsqueda."),{message:i,data:{Name:r,InitialDate:n,FinalDate:t}}}function filterData(n){var t=getFilters();t.message===""?$.get(urlFilter,t.data,function(n){loadGrid(n.items);n.message!==""&&showError(`Se ha producido el siguiente error al traer los datos: ${n.message}`)}):n||(setGridHeight("Listado",_gridMargin),showInfo(`Se deben ingresar los siguientes campos: <br />${t.message}`))}function loadGrid(n){var t,i,r;n&&(t=_gridMargin,n.forEach(n=>{n.date=JSON.toDate(n.date)}),i=$("#Listado").data("kendoGrid"),r=new kendo.data.DataSource({data:n}),i.setDataSource(r),n&&n.length>0&&($("#filter-box").collapse("hide"),t-=20),setTimeout(()=>{setGridHeight("Listado",t)},200))}function getType(n){return n==="U"?"A usuarios seleccionados":n==="T"?"Por Temas":"Todos"}function onEdit(n){var t,i={id:0,title:"",body:"",recipientsType:"U"};n.currentTarget.classList.contains("action-new")?($("#divUsers").removeClass("d-none"),$("#divTopics").addClass("d-none")):(t=$(n.currentTarget).closest("tr"),i=grdItems.dataItem(t),grdItems.select(t));loadDetail(i);wndDetail.open()}function loadDetail(n){$.get(urlGetRecipients,{MessageId:n.id},function(t){t.message==""?(n.recipients=t.items,$("#msg-title").val(n.title),$("#msg-body").val(n.body),ddlType.value(n.recipientsType),ddlUsers.value(t.items.map(n=>n.recipient)),$("#divTopics").toggleClass("d-none",n.recipientsType!="T"),$("#divUsers").toggleClass("d-none",n.recipientsType!="U")):(console.error(t.message),showError("Se ha producido un error al traer los datos del servidor"))})}function onAddingFile(){var t=$("<input>").addClass("k-textbox").addClass("message-file").css("width","95%").attr("type","text"),n=$("<div>").append(t);n.append(' <button type="button" class="btn btn-danger remove-file" title="Eliminar imagen"><i class="fas fa-trash-alt"><\/i><\/button>');n.insertBefore("#addFile");$(".message-file").length==5&&$("#addFile").addClass("d-none")}function onRemovingFile(){$(this).parent().remove();$("#addFile").hasClass("d-none")&&$("#addFile").removeClass("d-none")}function onSendingMessage(n){n.preventDefault();var t=$("#msg-title").val(),i=$("#msg-body").val(),r=kufiles.getFiles().length>0?kufiles.getFiles()[0]:"",u=ddlType.value(),f=ddlUsers.value();$.post(urlSend,{Title:t,Message:i,ToType:u,Tos:f,ImageUrl:r.name},function(n){n.sent?(grdItems.dataSource.add({id:n.id,title:t,body:i,date:new Date,imageUrl:r,recipientsType:u}),showMessage("Mensaje enviado"),wndDetail.close()):n.message!=""?showError("Se ha producido el siguiente error al enviar el mensaje: "+n.message):showError("No se ha podido enviar el mensaje");kufiles.clearAllFiles()})}var _minDate,_maxDate,wndDetail,grdItems,kufiles,ddlType,ddlUsers;const alignCenter={style:"text-align: center;"},alignRight={style:"text-align: right;"},numberFormat="{0:#,##0.00}",dateFormat="{0:dd-MM-yyyy}",_gridMargin=30,objConfig={messages:{required:"*"}};$(()=>{setupControls(),filterData(!0)});$(window).resize(()=>setGridHeight("Listado",_gridMargin));$("#action-clean").click(()=>cleanFilters());$("#action-filter").click(()=>filterData(!1));$("#Listado").on("click",".action-new, .action-edit",onEdit);$("#Detail").on("click","#addFile",onAddingFile);$("#Detail").on("click",".remove-file",onRemovingFile);$("#send-msg").click(onSendingMessage);